(this.webpackJsonp=this.webpackJsonp||[]).push([[27],{26:function(e,t){},27:function(e,t){},"3OF5":function(e,t,s){"use strict";s.r(t);s("TlRV"),s("m+NF"),s("bO0B"),s("33YB"),s("jmmm"),s("GSxB"),s("xDXR"),s("WrSY");var a=s("jDHv"),i=s("W8Xk"),n=s("igA5");const r=Object(a.define)("kv-cache"),o=Object(a.define)("kv-cache-in-mem");var l;class c{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),a=n.default.getInstance();return await a.setItemAsync(s,i.b(t)),t}async getItem(e){const t=this._buildKey(e),s=n.default.getInstance(),a=await s.getItemAsync(t);return Promise.resolve(a?i.a(a):void 0)}async removeItem(e){const t=this._buildKey(e),s=n.default.getInstance();return await s.removeItemAsync(t),this}}Object(a.singleton)(r)(l=class{createCache(e){return new c(`${e}`)}});var d,u=s("ndDP");class h{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new u.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(a.singleton)(o)(d=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new h(e,t)),this._registry[e]}});s("LyOm"),s("lNuO"),s("xir9"),s("4Vil"),s("0rWR"),s("Lq8m"),s("EicM"),s("nUpV"),s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN"),s("BP4/"),s("cF85"),s("7g9m"),s("oqw1");var g,m=s("8/YW"),p=s("Hw41"),f=s("xM06"),v=s("fcdz"),_=s("Ofqi"),b=s("aEKn");Object(m.e)()(g=Object(m.f)()(g=Object(a.singleton)()(g=Reflect.metadata("design:type",Function)(g=Reflect.metadata("design:paramtypes",[])(g=class{constructor(){this.corruptionSignalConsumer=void 0,this.corruptionAnalyzeConsumer=void 0,this.corruptionSignalConsumer=b.a.getInstance(),this.corruptionAnalyzeConsumer=_.a.getInstance()}onApplicationStart(){this.install()}onAuthenticated(e){this.corruptionAnalyzeConsumer.authenticate(e._session)}async install(){const e=a.ModuleContainer.resolve(p.b);(await e.getPort()).handleMessage((e=>this.handleRequest(e)))}async handleRequest(e){const{typeID:t}=e;if(t===f.k){const{type:t,data:s}=e.data;switch(t){case f.b:return this.corruptionAnalyzeConsumer.processAnalyzeCorruption(s.database);case f.C:return this.corruptionSignalConsumer.processSignalCorruption(s.corruptionInfo)}}return v.b}})||g)||g)||g)||g);s("9AEM");var I=s("VTBJ"),y=s("teaq");const S=Object(a.define)("database-transform-reporter"),C=Object(a.define)("database-transform-migrate");var E=s("Uzj0"),O=s("wH4e"),M=s("8gV8"),T=s("yi2h"),w=s("XB6V"),R=s("h0S/"),L=function(e){return e.NotStart="NotStart",e.Running="Running",e.Paused="Paused",e.Stoped="Stoped",e.Finished="Finished",e}(L||{});const D={gapTime:200,batchSize:100,version:0};class A{constructor(e,t,s){this.scope=e,this.dbName=t,this.tableConfig=s}getState(){return M.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return this.getState().then((t=>{let s=!1;return e==t.getCurrentVersion()&&(s=!t.isFinishedMigrate()),s}))}shouldUpgradeMigrate(e){return this.getState().then((t=>{const s=t.isFinishedMigrate(),a=e==t.getCurrentVersion()+1;return s&&a}))}async getMigrateVersion(e){const t=this.tableConfig.getTransformConfig(e);if(t){const e=Object.values(t.configs.version);for(let t=0;t<e.length;t++){const s=e[t],a=await this.shouldUpgradeMigrate(s.version),i=await this.shouldResumeMigrate(s.version);if(a||i)return s.version}}return-1}}class F{constructor(e,t,s,i,n,r){this.scope=e,this.dbName=t,this.tableConfig=s,this.partition=i,this.database=n,this.reporter=r,this.status=L.NotStart,this.configs=D,this.migrateDeferer=void 0,this.logger=void 0;const o=a.ModuleContainer.resolve(w.a);this.migrateDeferer=new E.c.Container,this.logger=o.createZLogger(R.ZLoggerNametags.dbDataTransform,["migrater"])}applyNewConfig(e){this.configs=Object(I.a)({},e)}getState(){return M.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return new A(this.scope,this.dbName,this.tableConfig).shouldResumeMigrate(e)}shouldUpgradeMigrate(e){return new A(this.scope,this.dbName,this.tableConfig).shouldUpgradeMigrate(e)}async upgradeMigrateVersion(e){const{version:t,migrate:s}=e,a=await this.getState();return await this.doUpVersion(a,t),s?(this.logger.zsymb(0,"IlxxSL","upversion trigger migrate",this.tableConfig.name),this.startMigrate(t)):(this.logger.zsymb(0,"eAYADK","upversion without migrate",this.tableConfig.name),this.doneMigrate())}async startMigrate(e){if(this.status!==L.NotStart)throw new Error("start migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"6yYvDN","trigger migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;const t=await this.getState();if(t.getCurrentVersion()!==e)throw new Error("migrate invalid version, please up version first:"+this.tableConfig.name);return await t.markStateAsRunning(),this.status=L.Running,this.reporter.onStart(this.tableConfig.name,e),this.doNextMigrateIterator(t),this.migrateDeferer.promise}async resumeMigrate(){if(this.status===L.Stoped)throw new Error("resume migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"K4TDhO","resume migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"SyNhs5","Resume migrate ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsRunning(),this.status=L.Running,this.reporter.onStart(this.tableConfig.name,e.getCurrentVersion()),this.doNextMigrateIterator(e),this.migrateDeferer.promise}async pauseMigrate(e="unknown"){this.logger.zsymb(0,"lyRGLG","Pause migrate ",this.tableConfig.name,e),this.status=L.Paused}async stopMigrate(e="unknown"){const t="string"==typeof e?e.slice(0,200):e;this.logger.zsymb(0,"KK3wqq","Stop migrate ",this.tableConfig.name,t);const s=await this.getState();this.status=L.Stoped,this.migrateDeferer.resolve({error:!0,message:t}),this.reporter.onError(this.tableConfig.name,s.getCurrentVersion(),e)}async doneMigrate(){if(this.migrateDeferer.value)return this.logger.zsymb(18,"sVd-iI","Migrate already settled!",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"dauHaz","Done migrate: ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsFinished()?this.migrateDeferer.resolve({error:!1,message:"Success"}):this.migrateDeferer.resolve({error:!0,message:"Persist state to fisk fail"}),this.reporter.onFinished(this.tableConfig.name,e.getCurrentVersion()),this.migrateDeferer.promise}doNextMigrateIterator(e){this.status===L.Running?setTimeout((()=>{this.doMigrate(e)}),this.configs.gapTime):this.logger.zsymb(0,"TGqb-a","stop migrate, not running")}async doMigrate(e){this.logger.zsymb(0,"3hgkfF","Do migrate ",this.tableConfig.name,e.getCheckpoint());const t=async t=>{if(e.isDoneCheckpoint())return this.logger.zsymb(6,"2aFqzW","checkpoint reach upperbound",JSON.stringify(e.getCheckpoint())),[];const s={from:e.getCheckpoint(),to:e.getUpperbound(),excludeFrom:!0},a={partition:this.partition,limit:this.configs.batchSize,direction:O.c.NEXT};return await t.getAll(s,a).catch((e=>{throw this.logger.zsymb(18,"uojtfu","read error",JSON.stringify(e)),e}))},s=t=>{const s=this.tableConfig.getIndex("primary").createKey(t);e.updateCheckPoint(s)},a=async(t,s)=>{const a={replace:!0,partition:this.partition};await t.insertMulti(s,a).catch((t=>{throw e.rollback(),this.logger.zsymb(18,"1m0RPm","write error",JSON.stringify(t)),t}))},i=this.database[this.tableConfig.name];await this.database.runTransaction([i],(async([e])=>{const i=await t(e),n=i.length;return 0==n||(s(i[n-1]),await a(e,i)),n}),O.j.READWRITE).then((async t=>{this.reporter.onProgress(this.tableConfig.name,e.getCurrentVersion(),t),await e.commitChange(),t<this.configs.batchSize?(this.logger.zsymb(0,"fngb5I","reach to last batch",this.tableConfig.name),this.doneMigrate()):this.doNextMigrateIterator(e)})).catch((e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))}))}doUpVersion(e,t){return new Promise(((s,a)=>{this.logger.zsymb(0,"TFeJgm","start upgrade version:",this.tableConfig.name);const i=this.database[this.tableConfig.name],n=Object(T.b)(this.tableConfig),r=e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))};this.database.runTransaction([i],(async([a])=>{const i=await a.getAll(void 0,{limit:1,direction:O.c.PREV,partition:this.partition}),o=(()=>{if(0==i.length)return n;const e=i[i.length-1];return this.tableConfig.getIndex("primary").createKey(e)})();return e.upVersionTo(t,n,o).then(s).catch(r)}),O.j.READWRITE).catch(r)}))}}var k;const N={gapTime:100,version:0,batchSize:100};Object(a.injectable)()(k=Object(a.singleton)(C)(k=function(e,t){return a.ModuleContainer.inject(y.b)(e,void 0,0)}(k=function(e,t){return a.ModuleContainer.inject(w.a)(e,void 0,1)}(k=Reflect.metadata("design:type",Function)(k=Reflect.metadata("design:paramtypes",[void 0===y.b?Object:y.b,void 0===w.a?Object:w.a])(k=class{constructor(e,t){this.configManager=e,this.session=void 0,this.configs=void 0,this.logger=void 0,this.session=null,this.configs=N,this.logger=t.createZLogger(R.ZLoggerNametags.dbDataTransform,["manager"])}authenticate(e){this.session=e}async getMigrateVersion(e){if(!this.session)throw new Error("Get migrate version when the session has not yet been initialized.");const t=[],s=[];Object.entries(e).forEach((e=>{const t=e[0];Object.values(e[1]).forEach((e=>s.push([t,e])))}));for(let a=0;a<s.length;a++){const[e,i]=s[a],n=await this.configManager.getDatabaseConfigs(e),r=i.getTransformConfig(n[0].type);if(!r)continue;const o=await r.getScopedId(),l=new A(o,e,i),c=await l.getMigrateVersion(n[0].type);-1!==c&&t.push(c)}return t.length?Math.min(...t):-1}async migrate(e,t,s){if(!this.session)throw new Error("Request migration when the session has not yet been initialized.");return this.configs=Object(I.a)(Object(I.a)({},this.configs),e),this.doMigrateUntilDie(Object.entries(s),(([e,s])=>this.migrateDB(t,e,s)))}async migrateDB(e,t,s){return this.logger.zsymb(0,"XEz1od","migrate db",t),this.doMigrateUntilDie(Object.values(s),(s=>this.migrateTable(e,t,s)))}async migrateTable(e,t,s){const i=await this.configManager.getDatabaseConfigs(t),n={success:!0,type:"notMigrate"};if(0==i.length)throw new Error("Migrate on a database without a configured setup");const r=s.getTransformConfig(i[0].type);if(!r)return this.logger.zsymb(0,"XypPjJ",`Transform config not found for table: ${s.name}`),n;this.logger.zsymb(0,"cJBrGz","Check migrate table: ",s.name);const o=a.ModuleContainer.resolve(S),l=await r.getScopedId(),c=new F(l,t,s,i[0].computePartitionName(this.session.userId,s.name),e[t],o);return c.applyNewConfig(this.configs),this.migrateToNextVersion(r,c)}async migrateToNextVersion(e,t){const s=Object.values(e.configs.version);for(let a=0;a<s.length;a++){const e=s[a];if(e.version>this.configs.version){this.logger.zsymb(0,"ibDXUc","Version too high",this.configs.version,e.version);break}const i=await t.shouldUpgradeMigrate(e.version),n=await t.shouldResumeMigrate(e.version);if(i){const s=await t.upgradeMigrateVersion(e);return{success:!s.error,type:"migrate",error:s.message}}if(n){const e=await t.resumeMigrate();return{success:!e.error,type:"migrate",error:e.message}}}return{success:!0,type:"notMigrate"}}async doMigrateUntilDie(e,t){const s=[];for(let a=0;a<e.length;a++){const i=await t(e[a]).catch((e=>({success:!1,type:"migrate",error:null==e?void 0:e.message})));if(!i.success)return i;s.push(i),await E.c.delay(this.configs.gapTime)}return s.find((e=>"migrate"==e.type))||s[0]}})||k)||k)||k)||k)||k);var P=s("UK4g"),j=s("DI/x"),U=s("0Grr"),B=s("ipWf"),z=s.n(B);class G extends U.a{async getDBRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");return z.a.join(e,P.a,"_production")}async getMainBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_bu",z.a.join(e,P.a,"_production_bu")}async getTempBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_temp_bu",z.a.join(e,P.a,"_production_temp_bu")}async getRejectBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_rej_bu",z.a.join(e,P.a,"_production_rej_bu")}}a.ModuleContainer.registerSingleton(U.c,G);s("fNRA"),s("6Pbj"),s("5lV7"),s("szdT");var x=s("ahRi");var V=s("ptxg"),H=s("pUq9");let W;W=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(a.injectable)()(W),Object(a.singleton)(V.a)(W);s("dhzt");var q=s("paDR"),K=s("k+R1"),$=s("Nve0");Object(q.b)(q.a.MakeCall,(function(e,t,s){if(null==s)return;const{chatID:a,callType:i}=s,n=K.default.getChatBoxControllerByConvId(a);var r,o;null!=n&&null!=i&&(i===$.d.AUDIO?null===(r=n.makeCall)||void 0===r||r.call(n,!1):null===(o=n.makeCall)||void 0===o||o.call(n,!0))})),Object(q.b)(q.a.MakeVideoCall,(function(e,t,s){var a;if(null==s)return;const{chatID:i}=s,n=K.default.getChatBoxControllerByConvId(i);null==n||null===(a=n.makeCall)||void 0===a||a.call(n,!0)})),Object(q.b)(q.a.MakeVoiceCall,(function(e,t,s){var a;if(null==s)return;const{chatID:i}=s,n=K.default.getChatBoxControllerByConvId(i);null==n||null===(a=n.makeCall)||void 0===a||a.call(n,!1)}));var Z=s("FyUm");var Q=s("WQAo");Object(q.b)(q.a.OpenChat,(function(e,t,s,i){if(null==s)return;const{chatID:n,source:r}=s;let o=null;switch(r){case Q.a.MessageOnMessaging:o=Q.d.fromMessageOnMessageing();break;case Q.a.MessageMention:{const e=null;Q.d.fromMessageMention(e);break}}a.ModuleContainer.resolve(Q.b).openConversation(n,o).catch((e=>{}))})),Object(q.b)(q.a.LoadMoreMessages,(function(e,t,s,a){const{chatID:i,windowID:n}=s;Z.default.GetManager().requestMessages(i,n,s,a)}));var Y=s("1pet"),J=s("PoHQ");var X=s("6ivO"),ee=s("XJ/a"),te=s("voUN");const se=new ee.a({context_menu:ee.b.field().schema({version:ee.b.field().number()})}),ae=new class extends X.ZFeatureConfig{constructor(){super({default:te.b,valiator:se})}selector(e){return e.ui_message||{}}getContextMenuConfig(){return this.config.context_menu}};var ie=s("Xp+J");const ne={};function re(e){return ne[e]}Object(q.b)(q.a.CreateToDoTask,(function(e,t,a,i){var n,r;const{chatId:o,data:l,windowId:c}=a;if(!l)return;const d=l.message;if(!d)return;const u=s("BZLJ");if(!u||void 0===u.default)return;const{ModalManagerV2:h}=s("h0sc"),g=u.default,{TODO_DATE_TYPE:m,TODO_STATUS:p}=u;let f,v=null!==(n=l.selectedText)&&void 0!==n?n:"";f=v||g.getTodoContentFromAMsg(d);let _=l.assignees;(!_||_.length<=0)&&(_=[]);const b=null!==(r=null!=o?o:d.toUid)&&void 0!==r?r:"",I=b.startsWith(Y.GROUPID_PREFIX);let y=b;I&&(y=b.slice(1));const S=J.p.getSessionUserId(),C={creator:S,content:f,dueDate:-1,assignees:_,extra:{toUid:y,msgId:d.msgId,isGroup:I,cliMsgId:d.cliMsgId,msgType:d.msgType,mention:d.mentions||[],ownerMsgUId:"0"==d.fromUid?S:d.fromUid,message:d.message},dateDefaultType:m.NO_DATE,description:"",watchers:"[]",status:p.WAITING_FOR_RESPONSE};g.setCreateTodoSrc(l.trackingSource),h.openModal({windowId:c,name:Y.ModalIdentitiesDefine.TODO_EDITOR,params:C})})),Object(q.b)(q.a.ShowMessageContextMenu,(function(e,t,a){const{context:i,oldData:n,data:r}=a||{};if(!1===Boolean(function(e){return null!=e&&void 0!==e.event&&null!==e.event&&void 0!==e.message&&null!==e.message&&void 0!==e.source&&null!==e.source}(i)))return;const o=function(e){if(!e)throw new Error("Window instance is invalid!");const t="?key=";let s="";const a=e.name;if(""===e.name)s="1";else{const e=a.indexOf(t);if(-1===e)s="1";else{const t=a.indexOf("&",e+1);s=-1!==t?a.substring(e+5,t):a.substring(e+5)}}return s}(i.event.view);!1===Boolean(ae.getContextMenuConfig().version)&&"function"==typeof re(o)&&re(o)(i.event,onContextMenu,message,localPath,resendFunc,showInFolder,downloadFunc,onExtension,indexOAChild,folderPath);const{showContextMenu:l}=s("DOj/");if("function"==typeof l){let e=[];const t=ie.a.get(r.UIMessageType);t&&(e=t(i,r.messageRef)),l(i,e)}}));var oe=s("uP4a"),le=s("c51z"),ce=s("gwig"),de=s("WIhS"),ue=s("/1VS"),he=s("xwfN"),ge=s("POdc"),me=s("QPNp"),pe=s("jSEC"),fe=s("4KMa");var ve=s("97kL"),_e=s("Ydol");Object(q.b)(q.a.SaveToDevice,(function(e,t,a,i){const{message:n,selfWindow:r}=a||{},{isShowedProgress:o,onDownloadStarted:l,onDownloadFail:c,onDownloadSuccess:d}=i||{};if(!n)return;if(!(ce.b.getStateNetwork()==ce.a.CONNECTED))return void me.a.ZToastModule.createError(le.a.str("STR_TOAST_CONNECTION_FAILED"));if(!Object(he.a)()){const e=s("xHgQ").downloadWebV2ByMsg;return void Object(de.a)(e)(null,r,n,Boolean(o))}const u=n.msgType==Y.MSG_UNDO?-1:Object(fe.h)(n),h=n.msgId,g={},m=me.a.DownloadObjectModule;Object(de.a)(l)({msgId:h});let p=!1,f=new oe.c(oe.a.ChatBoxView).getBuilder().withMode(oe.e.Manual).withCode(oe.d.CBVMessage);n.msgType===Y.MSG_FILE?(f.withType(oe.f.File),g.type=m.constants.DownloadType.File,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!0,taskBar:!0}}):n.msgType===Y.MSG_VIDEO?(f.withType(oe.f.Video),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Video,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!1,taskBar:!0}})):n.msgType===Y.MSG_GIF?(f.withType(oe.f.Photo),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Photo,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!1,taskBar:!0}})):n.msgType!==Y.MSG_PHOTO&&n.msgType!==Y.MSG_DOODLE&&u!=Y.MSG_SUBTYPE_PHOTO&&u!=Y.MSG_SUBTYPE_GIF||(f.withType(oe.f.Photo),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Photo,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,duplicate:!1,showProgress:{progressBar:!1,taskBar:!0}})),Object(ge.c)(n,ge.a.UserAction),f.withConvType(oe.b[Object(pe.a)(null==n?void 0:n.toUid)]),g.entry=f.build(),ue.a.downloadWithMultiSrc("runByMsg",n,Object(I.a)({},g)).then((e=>{const{savePath:t,isFolder:s}=e,a=s?"":t,i=s?t:"";Object(de.a)(d)({isOpenedOnDone:p,msgId:h,localPath:a,folderPath:i})})).catch((e=>{Object(de.a)(c)({msgId:h,error:e})}))})),Object(q.b)(q.a.ShowInFolder,(function(e,t,a,i){const{message:n}=a||{},{localPath:r,onFilePathUpdated:o}=i||{};if(n)if(n.msgType===Y.MSG_FILE){(0,s("F1UR").default)(n)}else{const e=r||(null==n?void 0:n.localPath);if(e){const t=me.a.FileUtilsModule;t.fileExists(e).then((s=>{s?t.showInFolder(e):(me.a.ZToastModule.createError(le.a.str("STR_TOAST_FILE_NOT_FOUND")),"function"==typeof o&&Object(de.a)(o)("",""),_e.default.send(ve.ChatBoxActions.FILEPATH_UPDATED,{msgId:n.msgId,localPath:"",folderPath:""}))}))}}}));var be=s("Vp9m"),Ie=s("h0sc"),ye=s("Py3H");function Se(e){let t=e;return t&&t.startsWith(Y.GROUPID_PREFIX)&&(t=t.substring(1,t.length)),t}Object(q.b)(q.a.AddFriend,(function(e,t,s){if(null==s)return;const{userID:a,chatID:i,windowID:n}=s;if(!a)return;const r=()=>{const e=Se(i||"");ye.a.setFriendRequestSource(a,Y.FRIEND_REQUEST_SRC_ECARD,{uidTo:e}),Ie.ModalManagerV2.openModal({windowId:n||void 0,name:Y.ModalIdentitiesDefine.ADD_FRIEND,params:a})};ye.a.getStatusFriendRequest(a).then((e=>{e.isRequested?be.default.show({textKey:"STR_PROFILE_FRIEND_REQ_SENT",noBackground:!0,type:be.TOAST_TYPE.INFO}):r()})).catch((()=>r()))}));var Ce=s("NDmK"),Ee=s("Xt6Q"),Oe=s("Z2tZ"),Me=s("Enw1"),Te=s("JDlE"),we=s("XS0u"),Re=s("EYv5");Object(q.b)(q.a.ManualDownloadMediaDoneHandler,(function(e,t,i,n){const{chatId:r,message:o,localPath:l,folderPath:c,isOpenedWhenCompleted:d=!0}=i;if(!r||!o)return;if(!l&&!c)return;if(Ee.l)return;const u=o.msgId;if(d||_e.default.send(ve.FetchActions.DOWNLOAD_DONE,{msgId:u,localPath:l,folderPath:c}),Me.g.isSetSound(J.p.getSessionUserId())&&Te.a.playNoti(),a.ModuleContainer.resolve(Re.a).updateFile(r,u,{localPath:l,folderPath:c},["localPath","folderPath"]),_e.default.send(ve.ChatBoxActions.FILEPATH_UPDATED,{msgId:u,localPath:l,folderPath:c}),we.default.updateMessage(u,{msgId:u,localPath:l,folderPath:c},["localPath","folderPath"],r),Ce.default.recent_photo.enableFeature&&Object(Ee.n)()){const e=s("z0WU").default,t=Date.now();Oe.a.setPhotoDownload({isLocalFile:!0,path:l,lastModified:t,name:$znode.path.basename(l||""),shortenPath:e.getShortenPath(l,40),fromSource:"DownloadedPhoto"})}if(!0===d){const e=s("Dprd").default;c?e.showInFolder(c):e.openItem(l)}})),Object(q.b)(q.a.OpenProfileModal,(function(e,t,s){if(null==s)return;const{userId:a,chatId:i,friendRequestSource:n,selectConversationSource:r,windowId:o}=s;if(null==a)return;let l=n;null==l&&(l=a.startsWith(Y.GROUPID_PREFIX)?Y.FRIEND_REQUEST_SRC_GROUP_CHAT:Y.FRIEND_REQUEST_SRC_CHAT);const c=Se(i||"");let d;c&&(l===Y.FRIEND_REQUEST_SRC_GROUP_CHAT?d={groupId:c}:l!==Y.FRIEND_REQUEST_SRC_CHAT&&l!==Y.FRIEND_REQUEST_SRC_ECARD||(d={toUid:c})),ye.a.setFriendRequestSource(a,l,d),null!=r&&J.p.setSelectConversationSource(r),Ie.ModalManagerV2.openModal({windowId:o||"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:a})}));s("uAZB");var Le=Object(a.define)("media-player-factory"),De=s("ZsEe");var Ae=class{constructor(e){this._token=void 0,null!=e&&(this.token=e),this.token}static create(e){return new this(e)}isValidated(){return Boolean(this._token)}toString(){return void 0===this.token||null===this.token?"":String(this.token)}freeze(){return Object.freeze(this),this}get token(){return this._token}set token(e){this._token=e,this.freeze()}};let Fe=function(e){return e.Audio="audio",e.Video="video",e}({});var ke=class{constructor(e){if(e)try{Object.keys(e).forEach((t=>{t&&void 0===this[t]&&(this[t]=e[t])}))}catch(t){}}freeze(){return Object.freeze(this),this}};let Ne=function(e){return e[e.None=0]="None",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused",e[e.Rewinding=3]="Rewinding",e[e.Stopped=4]="Stopped",e[e.Error=5]="Error",e}({}),Pe=function(e){return e[e.DownloadFailed=-101]="DownloadFailed",e[e.Exception=-102]="Exception",e[e.Expired=-103]="Expired",e[e.FetchFailed=-104]="FetchFailed",e[e.NotDownload=-105]="NotDownload",e}({});var je=class extends ke{constructor(e){super(e),this.state=Ne.None,this.position=0,this.rate=1}};var Ue=class{constructor(){this.builder=void 0,this.callerValidator=new WeakSet,this.playbackModel=new je,this.builder=new Proxy(this,{get:(e,t,s)=>Reflect.get(e,t,s)}),this.callerValidator.add(this.builder)}GetBuilder(){return this.builder}getState(){return this.playbackModel.state}getPosition(){return this.playbackModel.position}getRate(){return this.playbackModel.rate}isValidCaller(e){return this.callerValidator.has(e)}setState(e){this.playbackModel.state=e}setPosition(e){this.playbackModel.position=e}setRate(e){this.playbackModel.rate=e}};var Be=class{constructor(e,t,s){this.token=e,this.mediaType=t,this.builtins=void 0,this.eventListeners=void 0,this.playback=void 0,this.source="",this.eventListeners=new Map,s&&this.setSource(s)}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]);const s=this.eventListeners.get(e);return s.push(t),this.eventListeners.set(e,s),()=>this.removeEventListener(e,t)}getDuration(){return this.isPrepared()&&this.builtins.duration||0}getPlaybackPosition(){return this.isPrepared()&&this.playback.getPosition()||0}getPlaybackState(){return this.isPrepared()?this.playback.getState()||Ne.None:0}getPlaybackRate(){return this.isPrepared()&&this.playback.getRate()||0}getRemainingTime(){return this.isPrepared()?this.getDuration()-this.getCurrentTime():0}getSource(){return this.source}getToken(){return this.token}pause(){this.isPrepared()&&(this.playback.setState(Ne.Paused),this.builtins.pause())}play(){return this.isPrepared()?(this.playback.setState(Ne.Playing),this.builtins.play()):Promise.reject()}prepare(){this.playback=new Ue,this.mediaType===Fe.Audio&&(this.builtins=new Audio,this.registerEventWhenReady(),this.updateBuiltins({src:this.getSource()}))}release(){delete this.builtins,this.builtins=void 0,this.playback=void 0}removeEventListener(e,t){const s=this.eventListeners.get(e);s&&this.eventListeners.set(e,s.filter((e=>e!==t)))}seekTo(e){this.setCurrentTime(e)}setSource(e){this.source=e,this.updateBuiltins({src:e})}stop(){this.isPrepared()&&(this.playback.setState(Ne.Stopped),this.builtins.pause(),this.setCurrentTime(0))}getCurrentTime(){var e;return(null===(e=this.builtins)||void 0===e?void 0:e.currentTime)||0}isPrepared(){return null!=this.builtins&&null!=this.playback}notifyEvent(e,t,...s){const a=this.eventListeners.get(e);a&&a.forEach((e=>{"function"==typeof e&&e(t,...s)}))}onEnded(){this.playback.setState(Ne.Stopped),this.setCurrentTime(0)}registerEventWhenReady(){this.isPrepared()&&(this.builtins.addEventListener("abort",(e=>{this.notifyEvent("onabort",e)})),this.builtins.addEventListener("canplay",(e=>{this.notifyEvent("canplay",e)})),this.builtins.addEventListener("durationchange",(e=>{this.notifyEvent("durationchange",e,this.getDuration())})),this.builtins.addEventListener("error",(e=>{this.notifyEvent("onerror",e)})),this.builtins.addEventListener("loadeddata",(e=>{this.notifyEvent("loadeddata",e)})),this.builtins.addEventListener("loadedmetadata",(e=>{this.notifyEvent("loadedmetadata",e)})),this.builtins.addEventListener("timeupdate",(e=>{const t=this.getCurrentTime();this.playback.setPosition(t),this.notifyEvent("timeupdate",e,{currentTime:t,remainingTime:this.getRemainingTime()})})),this.builtins.addEventListener("ended",(e=>{this.onEnded(),this.notifyEvent("ended",e)})))}setCurrentTime(e){this.playback.setPosition(e),this.updateBuiltins({currentTime:e})}updateBuiltins(e){if(!this.builtins)return;Object.keys(e).forEach((t=>{this.builtins[t]=e[t]}))}};var ze=class{constructor(){this.IDGenerator=new De.a,this.instanceMap=new Map}createAudioPlayer(e){return this.createMediaPlayer(Fe.Audio,e)}createMediaPlayer(e,t){const s=Ae.create(this.generateTokenID()),a=new Be(s,e,t);return this.registerInstance(s,a),a}createVideoPlayer(e){return this.createMediaPlayer(Fe.Video,e)}deleteMediaPlayer(e){this.unregisterInstance(e)}generateTokenID(){return"PL_"+this.IDGenerator.next()}registerInstance(e,t){this.instanceMap.set(e.toString(),t)}unregisterInstance(e){this.instanceMap.delete(e.toString())}};a.ModuleContainer.registerSingleton(Le,ze);s("FCbV");var Ge=Object(a.define)("audio-manager"),xe=s("QZAi");var Ve=Object(a.define)("audio-resource-manager"),He=Ve;var We,qe=class{constructor(e){this.audioResourceManager=e}get AudioResourceManager(){return this.audioResourceManager}};var Ke=Object(a.injectable)()(We=function(e,t){return Object(a.inject)(He)(e,void 0,0)}(We=Reflect.metadata("design:type",Function)(We=Reflect.metadata("design:paramtypes",[Object])(We=class extends qe{constructor(e){super(e)}async loadResourceFromMessage(e,t){try{var s,a;const i=Me.g.getEnableAutoDownload(J.p.getSessionUserId()),n=await this.AudioResourceManager.loadResourceFromMessage(e,Object(I.a)(Object(I.a)({},t),{},{enableAutoDownload:i}));if(n.status===xe.a.SUCCESS){const e=n.data;return{localURL:e.localURL,URL:e.URL,status:"playable"}}return{localURL:(null===(s=n.extra)||void 0===s?void 0:s.localURL)||"",URL:(null===(a=n.extra)||void 0===a?void 0:a.URL)||"",status:"expired",error:{code:n.data.code,message:n.data.message}}}catch(i){return{localURL:"",URL:"",error:i,status:"failure"}}}async reloadResourceFromMessage(e,t){try{var s;const a=Me.g.getEnableAutoDownload(J.p.getSessionUserId()),i=await this.AudioResourceManager.reloadResourceFromMessage(e,Object(I.a)(Object(I.a)({},t),{},{enableAutoDownload:a}));if(i.status===xe.a.SUCCESS){const e=i.data;return{localURL:e.localURL,URL:e.URL,status:"playable"}}return{localURL:"",URL:(null===(s=i.extra)||void 0===s?void 0:s.URL)||"",status:"expired",error:{code:i.data.code,message:i.data.message}}}catch(a){return{localURL:"",URL:"",error:a,status:"failure"}}}})||We)||We)||We)||We;a.ModuleContainer.register(Ge,Ke);var $e=Object(a.define)("audio-resource-loader");var Ze=class{};a.ModuleContainer.register($e,Ze);var Qe=Object(a.define)("audio-resource-status"),Ye=s("q63S"),Je=s("w1k3");var Xe=class{async checkMediaStatus(e,t=[],s=!1,a=!0){try{let{status:t}=await Object(Je.a)(e);return{isExpired:"none"===t,autoDownloadPath:Object(Ye.b)(e)}}catch(i){return Promise.reject(i)}}};a.ModuleContainer.register(Qe,Xe);var et=Object(a.define)("audio-resource-downloader"),tt=s("JprO");var st=class{async downloadFromMessage(e,t){try{const{windowId:s}=t||{},a={wKey:s,type:tt.default.constants.DownloadType.Voice,options:{saveAs:!1,srcAction:tt.default.constants.srcAction.Dev,duplicate:!1,showProgress:{progressBar:!1,taskBar:!1}}};return await ue.a.getInstance().downloadWithMultiSrc("runByMsg",e,a)}catch(s){return Promise.reject(s)}}};a.ModuleContainer.register(et,st);var at=s("KweF"),it=s("JJxn");const nt=Object(a.define)("media-action-log-info-queue-tasks"),rt=Object(a.define)("media-action-log-info-producer"),ot=Object(a.define)("media-action-log-info-manager"),lt=Object(a.define)("media-action-log-info-consumer"),ct=Object(a.define)("media-action-log-info-cron-to-group-data");var dt=s("A9FD");function ut(e,t){const s={status:xe.a.SUCCESS,data:e,extra:t};return void 0===t&&delete s.extra,s}function ht(e,t,s,a){const i={status:xe.a.ERROR,data:{code:e,message:t||"",error:s},extra:a};return void 0===i.extra&&delete i.extra,i}function gt(e){return Boolean(!1)?"zfile://"+e:e}function mt(e,t,s=!1){let a="://";return s&&(a+="/"),e+a+t}var pt,ft=class{constructor(e,t){this.audioResourceLoader=e,this.audioResourceStatus=t,this.resourceCheckerResultCache=new Map}get AudioResourceLoader(){return this.audioResourceLoader}get AudioResourceStatus(){return this.audioResourceStatus}getCheckerResultCache(){return this.resourceCheckerResultCache}hasIn(e,t){return e.has(t)}},vt=et,_t=$e,bt=Qe,It=s("Iy59");var yt=Object(a.injectable)()(pt=function(e,t){return Object(a.inject)(_t)(e,void 0,0)}(pt=function(e,t){return Object(a.inject)(bt)(e,void 0,1)}(pt=function(e,t){return Object(a.inject)(vt)(e,void 0,2)}(pt=Reflect.metadata("design:type",Function)(pt=Reflect.metadata("design:paramtypes",[Object,Object,Object])(pt=class extends ft{constructor(e,t,s){super(e,t),this.audioResourceDownloader=s}async checkMediaStatusFromMessage(e,t,s,a){try{const i=Object(I.a)({},e);return ut(await this.AudioResourceStatus.checkMediaStatus(i,t,s,a))}catch(i){return ht(-1,"",i)}}async loadResourceFromMessage(e,t={enableAutoDownload:!0}){return-1!==e.message.href.indexOf(dt.i.E2EE_SESSION)?this.loadResourceFromMessageE2EE(e,t):this.loadResourceFromMessageNonE2EE(e,t)}async reloadResourceFromMessage(e,t={enableAutoDownload:!0,windowId:"1"}){const s=this.getDirectURL(e.message.href,e.msgId),{enableAutoDownload:a,windowId:i="1"}=t||{};try{const t=(await this.downloadFromMessage(e,{windowId:i})).data.savePath;return t?ut({localURL:gt(mt("file",t,!0))||"",URL:s}):ht(Pe.DownloadFailed,"",void 0,{URL:s})}catch(n){return ht(Pe.DownloadFailed,"",void 0,{URL:s})}}async downloadFromMessage(e,t){try{return ut(await this.AudioResourceDownloader.downloadFromMessage(e,t))}catch(s){const e="Auto download audio resource was error!";return Promise.reject(ht(-1,e,s))}}async loadResourceFromMessageE2EE(e,t={enableAutoDownload:!0,windowId:"1"}){try{const t=Object(at.j)(),s=e.message.href,a=await Object(at.h)(String(t),s,at.a.dev);return a&&a.data?ut({localURL:a.data,URL:this.getDirectURL(e.message.href,e.messageID)}):Promise.reject(ht(Pe.FetchFailed,"",null==a?void 0:a.error))}catch(s){const e="Load audio resource was error in E2EE flow!";return Promise.reject(ht(Pe.Exception,e,s))}}async loadResourceFromMessageNonE2EE(e,t={enableAutoDownload:!0,windowId:"1"}){const s=this.getDirectURL(e.message.href,e.msgId);try{const n=await this.checkMediaStatusFromMessage(e,[],!0),{flag:r}=Object(Je.b)(e);a.ModuleContainer.resolve(ot).run(e.toUid,e.msgId,{subType:it.e.SubTypeActionLogInfo.MediaStatusInView,entryPoint:it.e.EntryPointActionLogInfo.CONVERSATION_CHAT,isZCloud:r&It.d.clouded?1:0,conversationId:e.toUid});const o=n.data;if(o.autoDownloadPath)return ut({localURL:gt(mt("file",o.autoDownloadPath,!0)),URL:s});if(o.isExpired&&!(r&It.d.clouded))return ht(Pe.Expired,"",void 0,{URL:s});const{enableAutoDownload:l,windowId:c="1"}=t||{},d=(null==o?void 0:o.isExpired)&&!!(r&It.d.clouded),u=!(null!=o&&o.isExpired||l||(null==e?void 0:e.status)!=Y.MSG_SENT);if(!d&&u)return ut({localURL:"",URL:s},{reason:Pe.NotDownload});try{const t=await this.downloadFromMessage(e,{windowId:c});return ut({localURL:gt(mt("file",t.data.savePath,!0))||"",URL:s})}catch(i){return ht(Pe.DownloadFailed,"",void 0,{URL:s})}}catch(i){return Promise.reject(ht(Pe.Exception,"",i))}}getDirectURL(e,t){return-1!==e.indexOf(dt.i.E2EE_SESSION)?e:Ce.default.voice.voiceUrl+"/mp3?url="+encodeURIComponent(e)+"&msgid="+t}get AudioResourceDownloader(){return this.audioResourceDownloader}})||pt)||pt)||pt)||pt)||pt)||pt;a.ModuleContainer.register(Ve,yt);var St=s("J25b"),Ct=s("bUXd");a.ModuleContainer.registerSingleton(St.b,class{getHourNow(){return new Date(Ct.default.getTimeNow()).getHours()}getTimeNow(){return Ct.default.getTimeNow()}getSystemTimeNow(){return Ct.default.getSystemTimeNow()}});s("xRjI");const Et=Object(a.define)("tensor-flow-lib");var Ot=s("Pswx"),Mt=s("c7gn"),Tt=(s("1JlB"),s("CtZu")),wt=(s("PG0B"),s("+kvV")),Rt=s("csRb"),Lt=s("+gpH"),Dt=s("lzW/"),At=s("fn98"),Ft=s("XTCE"),kt=s("9q62"),Nt=s("pGgd"),Pt=s("ThxY"),jt=s("UvZ8"),Ut=s("DJOk"),Bt=s("aea1"),zt=s("2Gmx"),Gt=s("HdJO"),xt=s("eejg"),Vt=s("N7VH"),Ht=s("i+Li"),Wt=s("egdQ"),qt=s("Sm5c");Object(Mt.d)(wt.a),Object(Mt.d)(Rt.a),Object(Mt.d)(Lt.b),Object(Mt.d)(Dt.a),Object(Mt.d)(At.a),Object(Mt.d)(Ft.a),Object(Mt.d)(kt.a),Object(Mt.d)(Nt.a),Object(Mt.d)(Pt.a),Object(Mt.d)(jt.a),Object(Mt.d)(Ut.a),Object(Mt.d)(Bt.a),Object(Mt.d)(zt.b),Object(Mt.d)(Gt.b),Object(Mt.d)(xt.a),Object(Mt.d)(Vt.a),Object(Mt.d)(Ht.a),Object(Mt.d)(Wt.b),Object(Mt.d)(qt.a);a.ModuleContainer.registerSingleton(Et,class{tensor(e,t,s){return Object(Ot.U)(e,t,s)}ones(e,t){return Object(Ot.M)(e,t)}loadGraphModel(e,t,s){return Object(Tt.a)(e,t,s)}io_browserFiles(e){return Ot.J.browserFiles(e)}profile(e){return Object(Ot.N)(e)}});var Kt=s("MRjZ");class $t{constructor(){this.userId=null}init(e){this.userId=e}getUserId(){if(null===this.userId)throw new Error("Resource hasn't been initialized yet!");return this.userId}}class Zt extends $t{}const Qt=Object(a.define)("ss-sticker-2-click-resource");var Yt,Jt=s("TISA"),Xt=s("fsN4"),es=s("Mgpg");let ts=Object(a.injectable)()(Yt=Object(m.h)()(Yt=function(e,t){return Object(a.inject)(St.b)(e,void 0,0)}(Yt=Reflect.metadata("design:type",Function)(Yt=Reflect.metadata("design:paramtypes",[void 0===St.ISystemTime?Object:St.ISystemTime])(Yt=class extends Zt{constructor(e){super(),this.zSystemTime=e,this.timerId=null,this.logger=void 0,this.cachedUsage={};const t=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=t.createZLogger("e2ee-sticker-suggestion",["sticker-2-click"])}scheduleFlushTimeoutIfNeeded(){if(null!==this.timerId)return;this.timerId=setTimeout((async()=>{await this.flushData(),this.timerId=null}),3e4)}async get(e){const t=Xt.default.getInstance(),s=this.getTodayDateObj(),a={from:this.getDateBeforeNDays(e).getTime(),to:s.getTime(),excludeFrom:!0},i=await t.Core.StickerUsage.getAll(a);if(0===i.length)return null;const n={};return i.forEach((({data:e})=>{for(const[t,s]of Object.entries(e))void 0===n[t]&&(n[t]=0),n[t]+=s})),n}async set(e){const t=Xt.default.getInstance(),s=this.getTodayDateObj().getTime();await t.Core.StickerUsage.insert({dttm:s,data:e},{replace:!0})}async recordClickCount(e){const t=this.getTodayDateObj().getTime(),s=await this.getCurrentUsageOfSticker(t,e)+1;this.updateUsageOfSticker(t,e,s),this.scheduleFlushTimeoutIfNeeded()}async clearUnusedData(e){const t={to:this.getDateBeforeNDays(e).getTime()},s=Xt.default.getInstance(),a=await s.Core.StickerUsage.findAndDelete(t);this.logger.zsymb(3,"backVc",["Unused data cleared: {}","ZaLyPk"],a.length)}getDateBeforeNDays(e){const t=this.getTodayDateObj(),s=new Date(t);return s.setDate(t.getDate()-e),s}async initStickerUsageIfNeeded(e){if(void 0===this.cachedUsage[e]){const t=Xt.default.getInstance(),s=await t.Core.StickerUsage.get(e);this.cachedUsage[e]=void 0!==s?s:{dttm:e,data:{}}}}async getCurrentUsageOfSticker(e,t){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]||0}async updateUsageOfSticker(e,t,s){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]=s}getAllUsageBeingTracking(){return this.cachedUsage}removeUsageOfGivenDateFromCache(e){delete this.cachedUsage[e]}async flushData(){try{const e=this.getAllUsageBeingTracking(),t=Object.values(e),s=t.length,a=Xt.default.getInstance();if(await a.Core.StickerUsage.insertMulti(t,{replace:!0}),s>1){const e=this.getTodayDateObj().getTime(),s=[];t.forEach((({dttm:t})=>{t!==e&&s.push(t)}));for(const t of s)this.removeUsageOfGivenDateFromCache(t)}0}catch(e){0}}onDispose(){null!==this.timerId&&(clearTimeout(this.timerId),this.flushData())}getTodayDateObj(){const e=this.zSystemTime.getTimeNow(),t=new Date(e);return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t}})||Yt)||Yt)||Yt)||Yt)||Yt;a.ModuleContainer.registerSingleton(Qt,ts);const ss=Object(a.define)("ss-sticker-2-score-resource");a.ModuleContainer.registerSingleton(ss,class extends $t{async get(){return $zTFModels.ss.getSticker2Score()}async set(e){return $zTFModels.ss.setSticker2Score(e)}});class as extends $t{formatData(e){return{modelName:void 0!==e.modelName?e.modelName:"mf_sticker_v3",numItems:Math.max(void 0!==e.numItems?e.numItems:6306,0),numLatentFactor:Math.max(void 0!==e.numLatentFactor?e.numLatentFactor:32,0),minItemReconstruction:Math.max(void 0!==e.minItemReconstruction?e.minItemReconstruction:5,0),minItemTraining:Math.max(void 0!==e.minItemTraining?e.minItemTraining:10,0),numReconstructionRound:Math.max(void 0!==e.numReconstructionRound?e.numReconstructionRound:3,0),numReconstructionRoundWhenTraining:Math.max(void 0!==e.numReconstructionRoundWhenTraining?e.numReconstructionRoundWhenTraining:3,0),numTrainingRound:Math.max(void 0!==e.numTrainingRound?e.numTrainingRound:3,0),batchSize:Math.max(void 0!==e.batchSize?e.batchSize:256,0),reconDataRatio:Math.max(void 0!==e.reconDataRatio?e.reconDataRatio:.5,0),numNegativePerEachPositive:Math.max(void 0!==e.numNegativePerEachPositive?e.numNegativePerEachPositive:50,0),stickerUsageMaxValue:Math.max(void 0!==e.stickerUsageMaxValue?e.stickerUsageMaxValue:100,0),splitDatasetWhenTraining:void 0!==e.splitDatasetWhenTraining&&e.splitDatasetWhenTraining}}}const is=Object(a.define)("ss-config-resource");a.ModuleContainer.registerSingleton(is,class extends as{async get(){return $zTFModels.ss.getSSConfig()}async set(e){return $zTFModels.ss.setSSConfig(e)}});const ns=Object(a.define)("ss-item-2-sticker-resource");a.ModuleContainer.registerSingleton(ns,class extends $t{async get(){return $zTFModels.ss.getItem2Sticker()}async set(e){return $zTFModels.ss.setItem2Sticker(e)}});var rs=s("xE0C");a.ModuleContainer.registerSingleton(rs.b,class extends $t{async get(){return $zTFModels.ss.getKwd2Sticker()}async set(e){return $zTFModels.ss.setKwd2Sticker(e)}});const os="tf_ss";class ls extends $t{}const cs=Object(a.define)("ss-model-resource");a.ModuleContainer.registerSingleton(cs,class extends ls{constructor(...e){super(...e),this.url=null}async get(){const e=this.getURL();return{loadURL:e,saveURL:e}}set(e){throw new Error("Method not implemented.")}getURL(){if(null===this.url){const e=[os,this.getUserId()].join("_");this.url=`indexeddb://${e}`}return this.url}async saveData(e){const t=a.ModuleContainer.resolve(Et),s=e.map((({name:e,data:t})=>new File([t],e,{type:e.endsWith(".json")?"application/json":"application/octet-stream"})));let i=null;try{i=await t.loadGraphModel(t.io_browserFiles(s));const e=this.getURL();await i.save(e)}catch(r){throw r}finally{var n;null===(n=i)||void 0===n||n.dispose()}}});class ds{constructor(){this.model=a.ModuleContainer.resolve(cs),this.config=a.ModuleContainer.resolve(is),this.item2Sticker=a.ModuleContainer.resolve(ns),this.kwd2Stickers=a.ModuleContainer.resolve(rs.b),this.sticker2Click=a.ModuleContainer.resolve(Qt),this.sticker2Score=a.ModuleContainer.resolve(ss)}}const us=Object(a.define)("ss-resource-manager");a.ModuleContainer.registerSingleton(us,class extends ds{init(e){this.model.init(e),this.config.init(e),this.item2Sticker.init(e),this.kwd2Stickers.init(e),this.sticker2Click.init(e),this.sticker2Score.init(e),$zTFModels.ss.initSSResource(e)}});var hs=s("AH6j");let gs;(gs||(gs={})).isUnavailableIDBModelResourceDataError=function(e){if(!(e instanceof Error))return!1;const{message:t}=e;return t.includes("Cannot find model with path")};let ms=function(e){return e.UnavailableModelResourceData="unavailable-model-resource-data",e.DoneReconstruct="done-reconstruct",e}({});class ps extends hs.a{constructor(e){super(ms.UnavailableModelResourceData),this.url=e}}class fs extends hs.a{constructor(e){super(ms.DoneReconstruct),this.data=e}}function vs(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}var _s=s("X61T");class bs{constructor(e,t){this.kwd2Stickers=e,this.sticker2Item=t,this.sameKWMap=function(e,t){const s={},{index:a,map:i}=e;for(const n of Object.values(i)){const e=new Set;for(const s of n){const i=a[s];if(Object(_s.a)(i)){const{content:a}=i,{sticker_id:n}=a;void 0!==t[n]&&e.add(s)}}e.forEach((t=>{void 0===s[t]?s[t]=e:s[t]=Is(s[t],e),void 0!==s[t]&&s[t].delete(t)}))}return s}(this.kwd2Stickers,this.sticker2Item)}sampleNegativeIndices(e,t,s){const a=new Set,i={};for(const[l,c]of Object.entries(e)){const e=t[l];void 0!==e&&(a.add(e),i[e]=c)}const n=Object.values(t),r=new Set;n.forEach((e=>{a.has(e)||r.add(e)}));let o=new Set;for(const l of Object.keys(i)){const e=this.sameKWMap[+l]||new Set;if(0===e.size){o=Is(o,Ss(r,s))}else{const t=new Set;for(const s of Object.keys(i))e.has(+s)||t.add(+s);if(t.size>=s){o=Is(o,Ss(t,s))}else{o=Is(o,t);const e=s-t.size;o=Is(o,Ss(r,e))}if(o.size===r.size)break}}return o}}function Is(e,t){const s=new Set(e.values());return t.forEach((t=>{e.has(t)||s.add(t)})),s}const ys=1e3;function Ss(e,t){if(0===e.size)return new Set;const s=Array.from(e.values());if(t>=e.size)return new Set(vs(s));if(t>=ys)return new Set(vs(s).slice(0,t));let a=0;const i=new Set,n=new Cs(s);for(;a<t;){const e=n.getRandomItem();i.add(e),a+=1}return i}class Cs{constructor(e){this.items=void 0,this.items=[...e]}getRandomItem(){if(0===this.items.length)return;const e=Math.floor(Math.random()*this.items.length),t=this.items[this.items.length-1];return this.items[e]=t,this.items.pop()}}const Es=[1,32];let Os=function(e){return e[e.DEFAULT=0]="DEFAULT",e[e.NON_DEFAULT=1]="NON_DEFAULT",e}({});class Ms{constructor(e,t,s){this.type=e,this.shape=t,this.values=s}}class Ts extends Ms{constructor(e){super(Os.DEFAULT,e,new Float32Array)}createTensor(e){return e.ones(this.shape)}}class ws extends Ms{constructor(e,t){super(Os.DEFAULT,e,t)}createTensor(e){return e.tensor(this.values,this.shape,"float32")}}class Rs{constructor(){this.shape=Es}static getInstance(){return null===this.instance&&(this.instance=new Rs),this.instance}setShape(e){this.shape=[1,e]}createDefaultUserEmbedding(){return new Ts(this.shape)}createNonDefaultUserEmbedding(e){return new ws(this.shape,e)}}Rs.instance=null;class Ls extends hs.b{constructor(...e){super(...e),this.tfLib=a.ModuleContainer.resolve(Et),this.resourceManager=a.ModuleContainer.resolve(us),this.negativeSampler=null,this.userEmbeddingFactory=Rs.getInstance()}async reconstruct(e){const t=await this.getNegativeSampler(),s=await this.getSSConfig(),a=await this.getStickerToItem(),i=t.sampleNegativeIndices(e,a,s.numNegativePerEachPositive),n={};for(const[I,y]of Object.entries(e)){const e=a[I];void 0!==e&&(n[e]=Math.min(y,s.stickerUsageMaxValue))}i.forEach((e=>{n[e]=0}));const r=function(e,t){let s=[];for(const[r,o]of Object.entries(e))s.push([+r,o]);s=vs(s);const a=[];let i=0,n=Math.max(t,1);for(;i<s.length;){const e=s.slice(i,Math.min(i+n,s.length));a.push(e),i+=n}return a}(n,s.batchSize);this.userEmbeddingFactory.setShape(s.numLatentFactor);const o=this.userEmbeddingFactory.createDefaultUserEmbedding();let l=0,c=0,d=0,u=this.userEmbeddingFactory.createDefaultUserEmbedding();for(;d<s.numReconstructionRound;){for(const e of r){const t=await this.runOneStepReconstruct(e,o);u=t.userEmbedding,l+=t.loss,c+=1}d+=1}const h=Object.values(a).length,g=await this.predict(u,h);0===c&&(c=1);const m=Object.entries(g).sort(((e,t)=>t[1]-e[1])).map((([e])=>e)),p=Object.keys(a),f=new Set(m.slice(0,Math.min(m.length,50))),v=[];p.forEach((e=>{f.has(e)&&v.push(e)}));const _=0===p.length?0:1*v.length/p.length,b={loss:l/c,precision50:0===f.size?0:1*v.length/f.size,recall50:_,scores:g,reconsCount:Object.keys(e).length};return this.dispatchEvent(new fs(b)),b}async getTFModelInstance(){let e="";try{e=await this.getModelLoadURL();return await this.tfLib.loadGraphModel(e)}catch(t){throw gs.isUnavailableIDBModelResourceDataError(t)&&this.dispatchEvent(new ps(e)),t}}async predict(e,t){const s=new Int32Array(t).fill(0),a=new Int32Array(t).fill(0);let i=0;for(;i<t;)s[i]=i,a[i]=0,i+=1;let n=null,r=null,o=null,l=null,c=null,d=null;try{n=this.tfLib.tensor(s,void 0,"int32"),r=this.tfLib.tensor(s,void 0,"int32"),o=e.createTensor(this.tfLib),l=await this.getTFModelInstance(),c=l.predict({stickers:n,clicks:r,user_embedding:o}),d=await c[1].data()}catch(b){throw b}finally{var u,h,g,m,p;null===(u=n)||void 0===u||u.dispose(),null===(h=r)||void 0===h||h.dispose(),null===(g=o)||void 0===g||g.dispose(),null===(m=l)||void 0===m||m.dispose(),null===(p=c)||void 0===p||p.forEach((e=>e.dispose()))}const f=Math.min(d.length,t),v=await this.getItem2Sticker(),_={};for(i=0;i<f;){const e=v[i];void 0!==e&&(_[e]=d[i]),i+=1}return _}async runOneStepReconstruct(e,t){const s=e.length,a=new Int32Array(s).fill(0),i=new Int32Array(s).fill(0);let n=0;for(;n<s;){const t=e[n];[a[n],i[n]]=t,n+=1}let r=null,o=null,l=null,c=null;try{r=this.tfLib.tensor(a,void 0,"int32"),o=this.tfLib.tensor(i,void 0,"int32"),l=t.createTensor(this.tfLib),c=await this.getTFModelInstance();const e=c.predict({stickers:r,clicks:o,user_embedding:l}),s=await Promise.all(e.map((e=>e.data()))),n=s[0][0],d=s[1],u=s[2];return{loss:n,scores:d,userEmbedding:this.userEmbeddingFactory.createNonDefaultUserEmbedding(u)}}catch(m){throw m}finally{var d,u,h,g;null===(d=r)||void 0===d||d.dispose(),null===(u=o)||void 0===u||u.dispose(),null===(h=l)||void 0===h||h.dispose(),null===(g=c)||void 0===g||g.dispose()}}async getModelLoadURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.loadURL}async getModelSaveURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.saveURL}async getItem2Sticker(){const e=await this.resourceManager.item2Sticker.get();if(null===e)throw new Error("No 'item2Sticker' data is available!");return e}async getStickerToItem(){const e=await this.getItem2Sticker(),t={};for(const[s,a]of Object.entries(e))t[a]=+s;return t}async getKwd2Sticker(){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Sticker' data is available!");return e}async getSSConfig(){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ss-config' data is available!");return e}async getNegativeSampler(){if(null===this.negativeSampler){const e=await this.getKwd2Sticker(),t=await this.getStickerToItem();this.negativeSampler=new bs(e,t)}return this.negativeSampler}}const Ds=Object(a.define)("tf-model/sticker-suggestion");a.ModuleContainer.registerSingleton(Ds,class extends Ls{});var As=s("6Sr9"),Fs=s("7rAU");let ks;var Ns;let Ps;var js;(Ns=ks||(ks={})).getMetadataExpireDurationInMsFromRawExpireTime=function(e){return 1e3*e},Ns.getReconstructExpireDurationInMsFromRawReconstructInterval=function(e){return 24*e*60*60*1e3},(js=Ps||(Ps={})).parseKwd2StickersResponse=function(e){const{index:t,map:s}=e;if(void 0===t)throw new Error("Missing 'index' field in kwd2Sticker response");if(void 0===s)throw new Error("Missing 'map' field in kwd2Sticker response");return{index:t,map:s}},js.parseSupportedItemsData=function(e){const t={};for(let s=0;s<e.length;s+=1){const[a,i]=e[s];t[s]=i}return t};var Us=s("ggcH"),Bs=s("zmG6"),zs=s("fc/q"),Gs=s("T+bx");function xs(e){const t=new Gs.a(Gs.b);let s=!1;function a(){s=!1,i()}function i(){const i=t.dequeue();null!==i&&function(t){s=!0;const{args:i,deferrer:n}=t;e(...i).then(n.resolve).catch(n.reject).finally(a)}(i)}return(...e)=>new Promise(((a,n)=>{var r;r={args:e,deferrer:{resolve:a,reject:n}},t.append(r),1===t.size&&(s||i())}))}var Vs=s("rdC+"),Hs=s("bJrp");hs.a;var Ws=s("a3bM");const qs=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(Fs.j);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Fs.j),s=null)}catch(a){}return s},Ks=e=>{n.default.getInstance().setItemForCurrentUser(Fs.j,JSON.stringify(e))},$s=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(Fs.m);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Fs.m),s=null)}catch(a){}return s},Zs=e=>{n.default.getInstance().setItemForCurrentUser(Fs.m,JSON.stringify(e))},Qs=()=>{const e=n.default.getInstance().getItemForCurrentUser(Fs.o);if(null===e)return null;let t=null;try{t=JSON.parse(e)}catch(s){}return t},Ys=e=>{n.default.getInstance().setItemForCurrentUser(Fs.o,JSON.stringify(e))};var Js=s("bBj6"),Xs=s("/bDn");class ea{static getInstance(){return null===this.instance&&(this.instance=new ea),this.instance}constructor(){this.data=null,this.loadDataContainer=null,this.logger=void 0;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["kwd-2-last-clicked-sticker"])}async loadData(){if(null!==this.loadDataContainer)return this.loadDataContainer.promise;this.loadDataContainer=new E.c.Container;try{const t=n.default.getInstance(),s=await t.getItemForCurrentUserAsync(Fs.b);let a={};if(null!==s)try{a=JSON.parse(s)}catch(e){this.logger.zsymb(18,"WUTYmT",`Failed to parse kwd2LastClickedSticker data: ${e}`)}this.data=a,this.loadDataContainer.resolve()}catch(e){this.logger.zsymb(18,"BCs3GQ",`Failed to load kwd2LastClickedSticker data: ${e}`),this.loadDataContainer.reject(e),this.loadDataContainer=null}}async getLastClickedSticker(e){return null===this.data&&await this.loadData(),this.data[e]||null}async setLastClickedSticker(e,t){null===this.data&&await this.loadData();const s=this.data[e];if(void 0===s||s.sticker_id!==t.sticker_id){this.data[e]=t;const s=n.default.getInstance(),a=JSON.stringify(this.data);await s.setItemForCurrentUserAsync(Fs.b,a)}}}ea.instance=null;class ta extends hs.b{constructor(){super(),this.resourceManager=a.ModuleContainer.resolve(us),this.cachedResourceStatus=null,this.tfModel=a.ModuleContainer.resolve(Ds),this.kwd2Sticker=null,this.sticker2Score=null,this.ssResourceConfig=null,this.metadata=null,this.kwd2LastClickedStickerResource=ea.getInstance(),this.metadataExpireHandler=null,this.reconstructionExpireHandler=null,this.updateResourceIfNeededContainer=null,this.didStartup=!1,this.qos=null,this.logger=void 0,this.removeListeners=()=>{},this.didScheduleStickerUsageCleanup=!1,this.partialKwd2Sticker={map:{},index:{}},this.disposeKwd2StickersCacheTimer=null;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["module"]),this.runReconstructionIfNeeded=xs(this.runReconstructionIfNeeded.bind(this)),this.registerListeners();a.ModuleContainer.resolve(m.a).addEventListener(m.b.Exit,(()=>{this.removeListeners()}))}registerListeners(){const e=[];e.push(this.tfModel.addEventListener(ms.UnavailableModelResourceData,(()=>{this.reset()}))),e.push(this.tfModel.addEventListener(ms.DoneReconstruct,(async e=>{const t=Hs.a.getInstance();await t.onDoneReconstruct(e.data)})));const t=a.ModuleContainer.resolve(Us.TDBCorruptionDetector);e.push(t.addEventListener(Bs.a.DB_CORRUPTION_DETECTED,(e=>{const{corruptionInfo:t}=e,{databaseCorruptInfo:s}=t,{database:a}=s;a===Vs.a.baseConfig.name&&this.reset()}))),this.removeListeners=()=>{e.forEach((e=>e()))}}async recordSuggestion(e,t){try{const s=this.getKeywordVariantsToProcess(e),a=await Promise.allSettled(s.map((e=>{this.kwd2LastClickedStickerResource.setLastClickedSticker(e,t)})));for(const e of a)if("rejected"===e.status)throw e.reason}catch(s){0,this.logQosError(Fs.i.RECORD_SUGGESTION_FAILED,s)}}async recordUsage(e){try{await this.resourceManager.sticker2Click.recordClickCount(e)}catch(t){0,this.logQosError(Fs.i.RECORD_USAGE_FAILED,t)}}init(e){try{this.resourceManager.init(e);const t=()=>{const e=this.getSSMetadata();if(null===e)throw new Error("Unavailable model version");return e.sort_sticker_model.version},s=Hs.a.getInstance();s.registerGetModelVersionFn(t),s.ready()}catch(t){this.logger.zsymb(18,"jw8Gzi",`[init] Failed: ${t}`),this.logQosError(Fs.i.INIT_FAILED,t)}}getKeywordVariantsToProcess(e){const t=Js.a.prepare(e);return[t,Js.a.stripVnmeseDiacritics(t)]}scheduleStickerUsageCleanUp(){if(this.didScheduleStickerUsageCleanup)return;this.didScheduleStickerUsageCleanup=!0;const e=new Xs.a(Qs,Ys,E.j.timeInMs("1D"));e.onExpired((()=>{try{this.resourceManager.sticker2Click.clearUnusedData(Fs.d)}catch(e){this.logger.zsymb(21,"COCowl",["Sticker usage clean up error: {}","qjDGfh"],Object(Kt.c)(e))}})),e.start()}reset(){try{this.setSSMetadata(null),this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(18,"CV3YPU",`[reset] Failed: ${e}`),this.logQosError(Fs.i.RESET_FAILED,e)}}get enableFeature(){return!!Ws.a.nestedKey("metadata.sort_sticker_model.enable_feature")}getPriorityLastClick(){return!!Ws.a.key("priority_last_click").number}async predict(e){try{0;let t=null;this.getPriorityLastClick()&&(t=await this.kwd2LastClickedStickerResource.getLastClickedSticker(e));const s=await this.getSticker2Score(),a=null!==t;let i=[];const n=this.getKeywordVariantsToProcess(e);for(const e of n)if(i=await this.getStickerArtifactsMatchingKwd(e,(e=>{const{content:s}=e;if(a){return!(s.sticker_id===t.sticker_id)}return!0})),0!==i.length)break;if(0===i.length)return[];i=i.sort((({sticker_id:e},{sticker_id:t})=>s[t]-s[e]));return[...a?[t]:[],...i]}catch(t){throw this.logger.zsymb(21,"iKl4YL",["[predict] Keyword: '{}' - Failed: {}","DtqPjk"],e,t),this.logQosError(Fs.i.PREDICT_FAILED,t),Hs.a.getInstance().onFailedToSuggest(t),t}}simulateErrorIfNeeded(){if(Jt.a.enable()){if(Jt.a.get("simulate_fail_suggest"))throw new Error("Oops! Something went wrong")}}async getStickerArtifactsMatchingKwd(e,t){let s=[],a={},i=!1;if(void 0!==this.partialKwd2Sticker.map[e])a=this.partialKwd2Sticker.index;else{const{map:t,index:s}=await this.getKwd2Stickers();this.partialKwd2Sticker.map[e]=t[e]||[],a=s,i=!0}s=this.partialKwd2Sticker.map[e];const n=[];for(const r of s){const e=a[r];void 0!==e&&(Object(_s.a)(e)&&t(e)&&n.push(e.content),i&&(this.partialKwd2Sticker.index[r]=e))}return n}initExpireDuration(e,t){let s=!1,a=!1;{const t=ks.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler&&(this.metadataExpireHandler=new Xs.a(qs,Ks,t),this.metadataExpireHandler.onExpired((()=>{try{0,this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded()}catch(e){this.logger.zsymb(21,"vANQjs",["Metadata expire error: {}","DgBaMB"],Object(Kt.c)(e))}})),s=!0)}{let e=ks.getReconstructExpireDurationInMsFromRawReconstructInterval(t);0,null===this.reconstructionExpireHandler&&(this.reconstructionExpireHandler=new Xs.a($s,Zs,e),this.reconstructionExpireHandler.onExpired((()=>{try{0,this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(21,"AiJbDf",["Reconstruct expire error: {}","lGQt2x"],Object(Kt.c)(e))}})),a=!0)}s&&this.metadataExpireHandler.start(),a&&this.reconstructionExpireHandler.start()}updateMetadataExpireDuration(e){const t=ks.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler?this.logger.zsymb(18,"0gIpxR","[ExpireHandler][metadata] Not init yet"):this.metadataExpireHandler.updateExpiredDuration(t)}updateReconstructExpireDuration(e){let t=ks.getReconstructExpireDurationInMsFromRawReconstructInterval(e);null===this.reconstructionExpireHandler?this.logger.zsymb(18,"mvtGLz","[ExpireHandler][reconstruct] Not init yet"):this.reconstructionExpireHandler.updateExpiredDuration(t)}isEqualMetadata(e,t){return e.expired_time===t.expired_time&&(e.sort_sticker_model.enable_feature===t.sort_sticker_model.enable_feature&&(e.sort_sticker_model.version===t.sort_sticker_model.version&&(e.sort_sticker_model.reconstruct_range===t.sort_sticker_model.reconstruct_range&&(e.sort_sticker_model.reconstruct_interval===t.sort_sticker_model.reconstruct_interval&&(e.sort_sticker_model.url===t.sort_sticker_model.url&&(e.mapkwdsticker.url===t.mapkwdsticker.url&&e.mapkwdsticker.version===t.mapkwdsticker.version))))))}updateMetadataIfNeeded(){if(!this.enableFeature)return void 0;const e=this.getSSMetadata();let t=!1,s=null;if(null===e){s=this.fetchSSMetadata(),t=!0;const{expired_time:e,sort_sticker_model:a}=s;this.initExpireDuration(e,a.reconstruct_interval)}else if(s=this.fetchSSMetadata(),t=!this.isEqualMetadata(e,s),t){const{expired_time:e}=s;this.updateMetadataExpireDuration(e);const{reconstruct_interval:t}=s.sort_sticker_model;this.updateReconstructExpireDuration(t)}else 0;t&&this.updateResourceIfNeeded(e,s)}shouldReconstructAgainstResourceChangeStatus(e){return e===Fs.g.BOTH_CHANGED||e===Fs.g.TF_MODEL_CHANGED_ONLY}async runReconstructionIfNeeded(e=!1){if(!this.enableFeature)return void this.logger.zsymb(6,"74PyF7","[runReconstructionIfNeeded] Feature is disabled");let t=Fs.g.NOT_CHANGED;if(null!==this.updateResourceIfNeededContainer)t=await this.updateResourceIfNeededContainer.promise;else{switch(this.getResourceStatus()){case Fs.h.EMPTY:return void this.logger.zsymb(18,"lbmdc1","Failed to reconstruct due to empty resource");case Fs.h.ERROR:return void this.logger.zsymb(18,"AJhYuO","Failed to reconstruct due to invalid resource")}}if(e||this.shouldReconstructAgainstResourceChangeStatus(t)){const e=this.getSSMetadata();if(null===e)throw new Error("Metadata is still unavailable after updating resource");let t=await this.getSticker2Click(e.sort_sticker_model.reconstruct_range);0;try{0;const{scores:e}=await this.tfModel.reconstruct(t);0,this.resourceManager.sticker2Score.set(e)}catch(s){throw this.logger.zsymb(21,"RCLtlx",["[runReconstructionIfNeeded] Run reconstruction failed: {}","V1dZSa"],s),this.logQosError(Fs.i.RUN_RECONSTRUCT_FAILED,s),s}}else 0}async startup(){if(!this.didStartup)if(this.didStartup=!0,this.enableFeature){0;try{const e=this.getSSMetadata();if(null===e)this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded();else{const{expired_time:t,sort_sticker_model:s}=e;0,this.initExpireDuration(t,s.reconstruct_interval)}this.scheduleStickerUsageCleanUp()}catch(e){0,this.logQosError(Fs.i.STARTUP_FAILED,e)}}else this.logger.zsymb(6,"6UxN1J","[startup] Feature is disabled!")}async updateResourceIfNeeded(e,t){if(null!==this.updateResourceIfNeededContainer)return this.updateResourceIfNeededContainer.promise;this.updateResourceIfNeededContainer=new E.c.Container;let s=Fs.g.NOT_CHANGED;try{const a=null===e,i=[];if(a||this.isVersionOutDated(e.sort_sticker_model.version,t.sort_sticker_model.version)){s=Fs.g.TF_MODEL_CHANGED_ONLY;const{url:e,checksum_folder:a,checksum_zip:n}=t.sort_sticker_model,r=(async()=>{try{await this.updateModelResourceData({url:e,checksumFolder:a,checksumZip:n}),this.ssResourceConfig=null}catch(t){throw this.logQosError(Fs.i.UPDATE_MODEL_RESOURCE_DATA_FAILED,t),t}})();i.push(r)}if(a||this.isVersionOutDated(e.mapkwdsticker.version,t.mapkwdsticker.version)){s=s==Fs.g.NOT_CHANGED?Fs.g.KWD_2_STICKERS_CHANGED_ONLY:Fs.g.BOTH_CHANGED;const{url:e,checksum:a}=t.mapkwdsticker,n=(async()=>{try{await this.updateKwd2StickerResourceData({url:e,checksum:a}),this.kwd2Sticker=null,this.partialKwd2Sticker={map:{},index:{}}}catch(t){throw this.logQosError(Fs.i.UPDATE_KWD2STICKER_DATA_FAILED,t),t}})();i.push(n)}return await Promise.all(i),this.setSSMetadata(t),this.logger.zsymb(0,"7qi9ek","[updateResourceIfNeeded] Save new metadata"),this.setResourceStatus(Fs.h.READY),this.updateResourceIfNeededContainer.resolve(s),s}catch(a){throw this.setResourceStatus(Fs.h.ERROR),this.updateResourceIfNeededContainer.reject(a),this.logQosError(Fs.i.UPDATE_RESOURCE_FAILED_IN_GENERAL,a),a}finally{this.updateResourceIfNeededContainer=null}}fetchSSMetadata(){return Ws.a.key("metadata").object}isVersionOutDated(e,t){return e<t}getResourceStatus(){if(null!==this.cachedResourceStatus)return this.cachedResourceStatus;let e=Fs.h.EMPTY;const t=n.default.getInstance().getItemForCurrentUser(Fs.n);if(null!==t){const s=+t;Number.isNaN(s)||(e=s)}return this.cachedResourceStatus=e,e}setResourceStatus(e){if(this.cachedResourceStatus!==e){this.cachedResourceStatus=e;n.default.getInstance().setItemForCurrentUser(Fs.n,`${e}`)}}getSSMetadata(){if(null===this.metadata){const t=n.default.getInstance().getItemForCurrentUser(Fs.k);if(null===t)return null;try{this.metadata=JSON.parse(t)}catch(e){throw this.logQosError(Fs.i.PARSE_SS_METADATA_FAILED,e),new Error("Failed to parse ssMetadata data")}}return this.metadata}setSSMetadata(e){this.metadata=e;const t=n.default.getInstance();if(null===e)t.removeItemForCurrentUser(Fs.k);else{const s=JSON.stringify(e);t.setItemForCurrentUser(Fs.k,s)}}async getSticker2Click(e){const t=await this.resourceManager.sticker2Click.get(e);return null===t?{}:t}async getKwd2Stickers(){if(null===this.kwd2Sticker){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Stickers' data is available!");this.kwd2Sticker=e}return null!==this.disposeKwd2StickersCacheTimer&&clearTimeout(this.disposeKwd2StickersCacheTimer),this.disposeKwd2StickersCacheTimer=setTimeout((()=>{this.kwd2Sticker=null}),Fs.c),this.kwd2Sticker}async getSSResourceConfig(){if(null===this.ssResourceConfig){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ssConfig' data is available!");this.ssResourceConfig=e}return this.ssResourceConfig}async getSticker2Score(){if(null===this.sticker2Score){const e=await this.resourceManager.sticker2Score.get();if(null===e)throw new Error("No 'sticker2Score' data is available!");this.sticker2Score=e}return this.sticker2Score}logQosError(e,t){null===this.qos&&(this.qos=a.ModuleContainer.resolve(zs.b));let s="Unknown error";"string"==typeof t?s=t:t instanceof Error&&(s=t.message),this.qos.log({commandId:Fs.l,subCommandId:0,duration:0,success:!1,errorCode:e,params:[s]})}}var sa,aa=s("lL1k"),ia=s("9Pyw"),na=s("RrMd"),ra=s("xOOu"),oa=s.n(ra),la=s("rP9a");let ca=Object(As.a)()(sa=class extends ta{onApplicationReady(){this.startup()}async updateModelResourceData(e){try{const{url:t,checksumZip:s}=e,a=new ia.a(t,na.b.MANUAL,(()=>{}),{checksum:s}),i=await a.downloadBlob(),n=await i.arrayBuffer(),r=await oa.a.loadAsync(n),o=[];{const e=(async()=>{const e=new RegExp(`${Fs.f}/.*`),t=r.file(e);if(0===t.length)throw new Error("No model data folder is available!");let s=[];const a=new RegExp(`^${Fs.f}/`);for(const i of t){if(i.dir)throw new Error("Invalid nested folder in model data folder!");{const e=await i.async("blob"),t={name:i.name.replace(a,""),data:e};s.push(t)}}s=s.sort(((e,t)=>{const{name:s}=e,{name:a}=t;if(s.endsWith(".json"))return-1;if(a.endsWith(".json"))return 1;const i=s.replace(".bin",""),n=a.replace(".bin","");return i.localeCompare(n)})),await this.resourceManager.model.saveData(s)})();o.push(e)}{const e=(async()=>{const e=r.file(Fs.e);if(null===e)throw new Error("No 'ssConfig' file is found!");const t=await e.async("string");try{const e=JSON.parse(t);await this.resourceManager.config.set(e)}catch(s){throw new Error("Invalid 'ssConfig' data")}})();o.push(e)}{const e=(async()=>{const e=r.file(Fs.a);if(null===e)throw new Error("No 'item2Index' file is found!");let t={};const s=await e.async("string");try{const e=JSON.parse(s);t=Ps.parseSupportedItemsData(e)}catch(a){throw new Error("Invalid 'ssConfig' data")}await this.resourceManager.item2Sticker.set(t)})();o.push(e)}await Promise.all(o)}catch(t){throw this.logger.zsymb(21,"m8uti2",["Failed to update model resource data: {} - Error: {}","2Bf_bB"],JSON.stringify(e),Object(Kt.c)(t)),new Error(`Failed to update model resource data: ${t}`)}}async updateKwd2StickerResourceData(e){try{const{url:t,checksum:s}=e,a=new ia.a(t,na.b.MANUAL,(()=>{}),{checksum:s}),i=await a.downloadBlob(),n=await i.arrayBuffer(),r=la.a.inflate(n,{to:"string"}),o=JSON.parse(r),l=Ps.parseKwd2StickersResponse(o);await this.resourceManager.kwd2Stickers.set(l)}catch(t){throw new Error(`Failed to update kwd2Sticker resource data: ${t}`)}}})||sa;a.ModuleContainer.registerSingleton(aa.a,ca);var da=s("3t1t"),ua=s("JRkD"),ha=s("4b23"),ga=s("vNya");const ma=Object(ha.a)("1234567890abcdef",12);class pa{constructor(e){this.ONLOAD_TIMEOUT=1e4,this.instance=null,this.id=void 0,this.__createId__=void 0,this.__createName__=void 0,this.windowId="",this.popupTitle="",this.popupPath="",this.frame="",this.specs="",this.createWindow=async e=>{const{parentWindow:t,popupPath:s,frame:a,specs:i}=e;this.windowId=e.windowId,this.popupTitle=e.popupTitle,this.popupPath=s,this.frame=a||"",this.specs=i||"";const n=t.open(s,a,i);if(n){var r,o;null!==(r=n.document)&&void 0!==r&&r.body&&(n.document.body.style.backgroundColor="#1f1f1f"),this.instance=n,zconsole.zsymb(12,"zKu1Nh","[MVR]: onWindowDOMContentLoaded event",null==n?void 0:n.document.readyState),e.onWindowCreated&&e.onWindowCreated(this.selfContext);const t=t=>{var s;zconsole.zsymb(12,"zJdJIT","[MVR]: onWindowDOMContentLoaded event",t.document.readyState),e.onWindowDOMContentLoaded&&e.onWindowDOMContentLoaded(t),"complete"===(null===(s=t.document)||void 0===s?void 0:s.readyState)?(zconsole.zsymb(0,"IzvV4J","[MVR]: Load is already fired. skip listener"),e.onWindowLoad&&e.onWindowLoad(t)):(zconsole.zsymb(0,"i1iKH0","[MVR]: listen mvr load event"),this.onLoad(e.onWindowLoad))};return["interactive"].includes((null===(o=n.document)||void 0===o?void 0:o.readyState)||"")?(zconsole.zsymb(0,"aQX0vp","[MVR]: DOMContentLoaded is already fired. skip listener"),t(n)):(zconsole.zsymb(0,"qVkxjS","[MVR]: listen mvr DOMContentLoaded event"),this.onDOMContentLoaded(t)),zconsole.zsymb(12,"8P3gxm","[MVR]: onWindowDOMContentLoaded event",n.document.readyState),da.d.SUCCESS(n)}return da.d.FAILURE({code:da.b.CREATE_WINDOW_FAILED,message:"Cannot create new window"})},this.onBeforeUnload=()=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(ua.a)(!!this.windowId&&"string"==typeof this.windowId,`windowId must be a valid string. Received ${this.windowId}`);const e=()=>{var t;null===(t=this.instance)||void 0===t||t.removeEventListener("beforeunload",e),a.ModuleContainer.resolve(ga.a).close(this.windowId)};this.instance.addEventListener("beforeunload",e)},this.onDOMContentLoaded=e=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);let t=null;const s=this.instance,a=()=>{s.removeEventListener("DOMContentLoaded",a),e&&"function"==typeof e&&e(s),this.onBeforeUnload(),t&&s.clearTimeout(t)};t=s.setTimeout((()=>{s.removeEventListener("DOMContentLoaded",a),e&&"function"==typeof e&&e(s)}),this.ONLOAD_TIMEOUT),s.addEventListener("DOMContentLoaded",a)},this.onLoad=e=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);const t=this.instance;let s=null;const a=()=>{t.removeEventListener("load",a),e&&"function"==typeof e&&e(t),s&&t.clearTimeout(s)};s=t.setTimeout((()=>{t.removeEventListener("load",a),e&&"function"==typeof e&&e(t)}),this.ONLOAD_TIMEOUT),t.addEventListener("load",a)},this.__createName__=e,this.__createId__=ma(),this.id=`zalo_popup_${ma(7)}`}cleanup(){var e;null===(e=this.instance)||void 0===e||e.removeEventListener("beforeunload",this.onBeforeUnload)}getCurrentWindowSizes(){try{var e,t,s,a,i,n;return Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(ua.a)(!(null===(e=this.instance)||void 0===e||!e.outerWidth)&&"number"==typeof(null===(t=this.instance)||void 0===t?void 0:t.outerWidth),`outerWidth must be a valid number. Received ${null===(s=this.instance)||void 0===s?void 0:s.outerWidth}`),Object(ua.a)(!(null===(a=this.instance)||void 0===a||!a.outerHeight)&&"number"==typeof(null===(i=this.instance)||void 0===i?void 0:i.outerHeight),`outerHeight must be a valid number. Received ${null===(n=this.instance)||void 0===n?void 0:n.outerHeight}`),{w:this.instance.outerWidth,h:this.instance.outerHeight}}catch(r){return zconsole.zsymb(18,"GERMJ-","[MVR]: getCurrentWindowSizes error",r),null}}}var fa;let va=Object(a.injectable)()(fa=Reflect.metadata("design:type",Function)(fa=Reflect.metadata("design:paramtypes",[])(fa=class extends pa{constructor(){super("__electron.browserwindow__"),this.create=async e=>{Object(ua.a)(!!e.parentWindow,"parentWindow must be a valid window object"),Object(ua.a)("string"==typeof e.windowId,"windowId must be a string. Received "+typeof e.windowId),Object(ua.a)("string"==typeof e.popupPath&&!!e.popupPath,`popupPath must be a valid string. Received ${e.popupPath}`),Object(ua.a)("string"==typeof e.popupTitle,"popupTitle must be a string. Received "+typeof e.popupTitle);const t=await this.createWindow(e);if("ERROR"===t.type)throw t;return da.d.SUCCESS(this)},this.focus=async()=>{if(!this.instance)throw da.d.FAILURE({code:da.b.FOCUS_NULL_WINDOW,message:"WINDOW NOT FOUND",stack:null});try{await $zwindow.focus(this.windowId)}catch(e){throw da.d.FAILURE({code:da.b.FOCUS_WINDOW_FAILED,message:`Failed to focus ${this.windowId}`,stack:e})}},this.close=async()=>{this.instance=null;try{await $zwindow.closeWindow(this.windowId)}catch(e){}finally{this.cleanup()}},this.getInfoScreenOfMouse=e=>{var t;const s=$zelectron.getInfoScreenOfMouseSync(),a=null===(t=K.default.getPopupWindowInstance(s))||void 0===t?void 0:t.windowInstance,i=a?null==a?void 0:a.screen:window.screen;return{x:i.availLeft||i.left||0,y:i.availTop||i.top||0,w:i.width,h:i.height,availW:i.availWidth,availH:i.availHeight}}}get selfContext(){return this}get closed(){throw new Error("Method not implemented.")}get focused(){throw new Error("Method not implemented.")}get visible(){throw new Error("Method not implemented.")}cleanup(){this.instance&&(super.cleanup(),this.instance=null)}})||fa)||fa)||fa;a.ModuleContainer.register(da.c,va);const _a=Object(a.define)("pulloffline-reporter");var ba,Ia=s("Yi2m");const ya="rp_ofl_p";Object(a.singleton)(_a)(ba=Reflect.metadata("design:type",Function)(ba=Reflect.metadata("design:paramtypes",[])(ba=class{constructor(){this.logger=void 0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("offline-monitor",["reporter"])}reportLastSession(){const e=n.default.getInstance().getObject(ya);e&&(this.logger.zsymb(0,"tYOpeT","detect last session"),this.report(e))}report(e){this.logger.zsymb(0,"-2zUQF","report: ",JSON.stringify(e)),Ia.default.logActionInfoV2(Ia.FeaturesInfo.PullOffline,1,e,[],!0);n.default.getInstance().removeItem(ya)}saveDraft(e){n.default.getInstance().setObject(ya,e),this.logger.zsymb(0,"tht7gO","draft saved: ",JSON.stringify(e))}log(e){this.logger.zsymb(0,"4Re9XD","log: ",JSON.stringify(e))}})||ba)||ba);var Sa,Ca=s("BkRI"),Ea=s.n(Ca),Oa=s("AtyM"),Ma=s("eBe7"),Ta=s("yrNp"),wa=function(e){return e.AfterApi="afterApi",e.AfterSavedDB="afterSavedDB",e}(wa||{});Object(a.singleton)(Ta.a)(Sa=class extends hs.b{constructor(...e){super(...e),this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null,this.started=!1}onStart(){this.started||(this.resetMonitor(),this.started=!0,this.timeUsage.startTrackingTime=Oa.a.now(),this.dispatchEvent(new Ma.d))}onDoneApi(){this.takeSnapshot(wa.AfterApi)}onSavedDB(){this.takeSnapshot(wa.AfterSavedDB)}onSettled(e,t){this.started&&(this.started=!1,this.info=null!=e?{error:e}:{result:t},this.dispatchEvent(new Ma.b(e,t)))}onSkip(){this.resetMonitor(),this.dispatchEvent(new Ma.c)}getCollectedMetrics(){let e={error:new Error("Incompleted metric")};return null===this.info||(e="error"in this.info?{error:this.info.error}:{result:this.info.result}),Ea()(Object(I.a)({timeUsage:Object(I.a)({},this.timeUsage)},e))}takeSnapshot(e){this.timeUsage[e]=Oa.a.now()-this.timeUsage.startTrackingTime}resetMonitor(){this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null}});var Ra=s("oq0C");const La=()=>void 0!==Ce.default.socket.offline_monitor.enable&&Ce.default.socket.offline_monitor.enable,Da=()=>void 0!==Ce.default.socket.offline_monitor.latency_time?Ce.default.socket.offline_monitor.latency_time:3e4,Aa=()=>void 0!==Ce.default.socket.offline_monitor.exclude_monitors_queues?Ce.default.socket.offline_monitor.exclude_monitors_queues:["516","517","518","519"];var Fa=s("rkiK");let ka;!function(e){function t(e,t,s){const a={lowestFPS:60,dropTime:e[s].ts-e[t].ts};for(let i=t;i<=s;i++)e[i].fps<a.lowestFPS&&(a.lowestFPS=e[i].fps);return a}e.getDroppeds=function(e,s){let a=0,i=0,n=s[0].fps<=e;const r=[];return s.forEach(((o,l)=>{n?(o.fps>e&&(i=l,n=!1,r.push(t(s,a,i))),l==s.length-1&&o.fps<=e&&(i=l,n=!1,r.push(t(s,a,i)))):o.fps>e?(a=l,n=!1):l==s.length-1?(i=l,n=!1,r.push(t(s,a,i))):n=!0})),r}}(ka||(ka={}));var Na,Pa=s("m0Bc");const ja={dropCount:0,min:60,dropTime:0};var Ua=function(e){return e.BeforePull="beforePull",e.InPull="inPull",e.InSaveDB="inSaveDB",e.AfterSaveDB="afterSaveDB",e}(Ua||{});let Ba=Object(a.singleton)(Ra.a)(Na=Reflect.metadata("design:type",Function)(Na=Reflect.metadata("design:paramtypes",[void 0===_a?Object:_a])(Na=class extends hs.b{constructor(e){super(),this.reporter=e,this.cpuUsage=void 0,this.fpsUsage=void 0,this.timeUsage=void 0,this.lastActionId=void 0,this.countData={},this.countConv={},this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.callStartPullCount=0,this.actionIdSnapshot={},this.monitorQueues=new Set,this.timeStartChat={},this.isFirstSnapshot=!0,this.fpsRecorder={},this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(I.a)({},ja),inPull:Object(I.a)({},ja),inSaveDB:Object(I.a)({},ja),afterSaveDB:Object(I.a)({},ja)},this.lastActionId={}}startMonitor(){return La(),this.reporter.reportLastSession(),La()?(this.getCPU(),this.trackFPS(Ua.BeforePull),Promise.resolve()):Promise.resolve()}async stopMonitor(){this.timeStartChat.group&&!this.timeUsage.waitSendGr&&(this.timeUsage.waitSendGr=Oa.a.now()-this.timeStartChat.group),this.timeStartChat.oneone&&!this.timeUsage.waitSendOO&&(this.timeUsage.waitSendOO=Oa.a.now()-this.timeStartChat.oneone),await this.takeSnapshot(Ua.AfterSaveDB),this.reporter.report({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}getCollectedMetrics(){const e=Object.entries(this.countConv).reduce(((e,[t,s])=>Object(I.a)(Object(I.a)({},e),{},{[t]:s.size})),{});return{isFirstSnapshot:this.isFirstSnapshot,cpuUsage:Object(I.a)({},this.cpuUsage),fpsUsage:Object(I.a)({},this.fpsUsage),timeUsage:Object(I.a)({},this.timeUsage),countData:Object(I.a)({},this.countData),countConv:e}}resetMonitor(){this.monitorQueues.clear(),this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(I.a)({},ja),inPull:Object(I.a)({},ja),inSaveDB:Object(I.a)({},ja),afterSaveDB:Object(I.a)({},ja)},this.lastActionId={},this.actionIdSnapshot={},this.countData={},this.countConv={},this.timeStartChat={}}addMonitorQueues(e){const t=Aa();e.forEach((e=>{t.some((t=>e.startsWith(t)))||this.monitorQueues.add(e)})),this.monitorQueues}async onStartPoll(e){if(this.callStartPullCount++,!La())return;if(this.callStartPullCount%2==1&&this.resetMonitor(),this.addMonitorQueues(e),this.started,this.callStartPullCount,this.started)return;this.started=!0,this.timeUsage.startTrackTime=Oa.a.now();const t=this.callStartPullCount<=2?Pa.e.Startup:Pa.e.Resume;this.dispatchEvent(new Pa.d(t)),await this.takeSnapshot(Ua.BeforePull),this.trackFPS(Ua.InPull)}async onEndPoll(e,t){La()&&this.monitorQueues.has(e)&&(La(),this.lastActionId[e]=t,this.donePullCount++,this.monitorQueues.size==this.donePullCount&&(await this.takeSnapshot(Ua.InPull),this.trackFPS(Ua.InSaveDB)))}onPollData(e,t){if(La()&&!this.isDoneMonitor&&this.monitorQueues.has(e))switch(this.countData[e]||(this.countData[e]=0),this.countConv[e]||(this.countConv[e]=new Set),e){case"510_0":case"513_0":case"515_0":case"510_1":case"513_1":case"515_1":this.countData[e]+=t.data.msgs.length,this.countData[e]+=t.data.pageMsgs.length;for(const a of t.data.msgs)try{this.countConv[e].add(a.idTo)}catch(s){}for(const a of t.data.pageMsgs)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"511_0":case"514_0":case"511_1":case"514_1":this.countData[e]+=t.data.groupMsgs.length;for(const a of t.data.groupMsgs)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"610_0":case"611_0":case"610_1":case"611_1":this.countData[e]+=t.data.reacts.length,this.countData[e]+=t.data.reactGroups.length;for(const a of t.data.reacts)try{this.countConv[e].add(a.idTo)}catch(s){}for(const a of t.data.reactGroups)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"603_0":case"603_1":this.countData[e]+=t.data.controls.length}}onSavedData(e){if(!this.isDoneMonitor&&La()){this.actionIdSnapshot;for(const t in e)this.monitorQueues.has(t)&&this.lastActionId[t]&&this.actionIdSnapshot[t]!==e[t]&&(this.checkDoneDoOffline(t,e[t]),this.actionIdSnapshot[t]=e[t])}}onOpenConversation(e){"string"==typeof e&&0===this.timeUsage.openConv&&(this.timeUsage.openConv=Oa.a.now()-this.timeUsage.startTrackTime)}onStartChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeStartChat.group?this.timeStartChat.group=Oa.a.now():this.timeStartChat.oneone||(this.timeStartChat.oneone=Oa.a.now()))}onEncryptChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeUsage.waitSendGr?this.timeUsage.waitSendGr=Oa.a.now()-this.timeStartChat.group:this.timeUsage.waitSendOO||(this.timeUsage.waitSendOO=Oa.a.now()-this.timeStartChat.oneone))}async checkDoneDoOffline(e,t){if(this.lastActionId[e],this.doneOfflineCount==this.monitorQueues.size)return;const s=this.lastActionId[e];s&&Number(t)==Number(s)&&(this.doneOfflineCount++,this.doneOfflineCount==this.monitorQueues.size&&(this.isDoneMonitor=!0,await this.takeSnapshot(Ua.InSaveDB),this.trackFPS(Ua.AfterSaveDB),this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),this.isFirstSnapshot=!1,this.dispatchEvent(new Pa.a),setTimeout((()=>{this.stopMonitor(),this.dispatchEvent(new Pa.b)}),Da())))}async takeSnapshot(e){const t=await this.getCPU(),s=this.getFPS(e);this.cpuUsage[e]=t,this.fpsUsage[e]=s,this.timeUsage[e]=Oa.a.now()-this.timeUsage.startTrackTime,this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}async getCPU(){return 0}trackFPS(e){this.fpsRecorder[e]=Fa.default.Fps.registerSectionRecorder(e),this.fpsRecorder[e].start()}getFPS(e){var t;const s=null===(t=this.fpsRecorder[e])||void 0===t?void 0:t.end();if(delete this.fpsRecorder[e],!s||0==s.fpsHistory.length)return ja;const a=ka.getDroppeds(50,s.fpsHistory);if(0==a.length)return ja;const i=a.reduce(((e,t)=>e+=t.dropTime),0),n=Math.min(...a.map((e=>e.lowestFPS)));return{dropCount:a.length,dropTime:i,min:n}}})||Na)||Na)||Na;var za;Object(a.injectable)()(za=Object(a.singleton)(Ra.a)(za=function(e,t){return Object(a.inject)(_a)(e,void 0,0)}(za=Reflect.metadata("design:type",Function)(za=Reflect.metadata("design:paramtypes",[void 0===_a?Object:_a])(za=class extends Ba{constructor(e){super(e)}async getCPU(){const e=(await $zperf.getCpuInfos()).reduce(((e,t)=>e+=t.cpu.percentCPUUsage||0),0);return Math.round(e)}})||za)||za)||za)||za);var Ga=s("zgbJ"),xa=s("BuY5"),Va=s("QOJ3"),Ha=s("JUJ1"),Wa=s("//ub");let qa=function(e){return e.HandleOfflineData="HANDLE_OFFLINE_DATA",e.Sample="SAMPLE",e}({}),Ka=function(e){return e[e.FRESH_START=1]="FRESH_START",e[e.RESUME=2]="RESUME",e[e.UNKNOWN=-1]="UNKNOWN",e}({});var $a;let Za=Object(Wa.b)()($a=Reflect.metadata("design:type",Function)($a=Reflect.metadata("design:paramtypes",[])($a=class e extends Ha.a{static getInstance(){return Va.a.resolve(e)}constructor(){super({collections:Object.values(qa)})}collect(e){if("end"===e.action)this.report()}start(e){E.c.Macrotask.push((()=>{var t,s;null===(t=this.collection(e))||void 0===t||null===(s=t.metric())||void 0===s||s.start()}))}end(e,t){E.c.Macrotask.push((()=>{var s,a;null===(s=this.collection(e))||void 0===s||null===(a=s.metric())||void 0===a||a.end(t)}))}once(e,t){E.c.Macrotask.push((()=>{var s,a;null===(s=this.collection(e))||void 0===s||null===(a=s.metric())||void 0===a||a.once(t)}))}record(e,t){E.c.Macrotask.push((()=>{var s;null===(s=this.collection(e))||void 0===s||s.metric().record(t)}))}cancel(e){const t=this.collection(e);if(!t)return;const s=t.defaultId;t.removeMetric(s)}submitActionLog(e){Ia.default.logActionInfoV2(e.id,e.subType,e.data)}report(){const e=Object.values(qa);for(const s of e){var t;const e=null===(t=this.collection(s))||void 0===t?void 0:t.metric();if(!e||!e.isReadyToGetReport)continue;const a=e.report();if(!a)continue;let i;switch(s){case qa.HandleOfflineData:{const{convListSort:e,workload:t,result:s,error:n,timeUsage:r,offlineInfo:o}=a.metadata;if(0===o.tsOffline)i={id:-1,subType:-1,data:{}};else{i={id:Ia.FeaturesInfo.Offline2Online,subType:1,data:{conv_list_sort:{count:e.count},pull:{count_msg_data:t.msgPull,count_conv_data:t.convPull,count_msg_success:s.msgPull,time:r.pull},offline_info:{offline_time:o.tsOffline,online_time:o.tsOnline,online_type:o.onlineType}}};!!t.msgPreProcess&&(i.data.pre=Object(I.a)({count_msg_data:t.msgPreProcess,time:r.preProcess},n&&n.preProcess?{error:n.preProcess}:{}))}break}case qa.Sample:default:i={id:-1,subType:-1,data:{}}}-1!==i.id&&this.submitActionLog(i)}}})||$a)||$a)||$a;var Qa=s("FlN1");const Ya=Object(a.define)("offline-detector"),Ja=Object(a.define)("event-bus"),Xa="last-online-detector",ei=Object(a.define)(Xa),ti=Object(a.define)(`${Xa}-socket-polling`),si=Object(a.define)(`${Xa}-local-storage`);var ai=s("rXIX"),ii=s("rQsU");class ni{constructor(){this.result={numOfOrderChanges:0},this.unregisterListeners=()=>{},this.prevConvListOrderSnapshot=null}static getInstance(){return null===this.instance&&(this.instance=new ni),this.instance}startTracking(){this.registerListeners()}stopTracking(){this.unregisterListeners()}getTrackingResult(){return Ea()(this.result)}reset(){this.result={numOfOrderChanges:0},this.prevConvListOrderSnapshot=null}registerListeners(){const e=[],t=a.ModuleContainer.resolve(ii.b);e.push(t.addEventListener(ai.c.SignalRenderList,(e=>{this.recordSnapshotChange(e.listVisible)}))),this.unregisterListeners=()=>{e.forEach((e=>e()))}}recordSnapshotChange(e){const t=this.isConvListOrderChanged(e);t&&(this.result.numOfOrderChanges+=1),t&&this.result.numOfOrderChanges}isConvListOrderChanged(e){let t=!1;if(Array.isArray(e)&&null!==this.prevConvListOrderSnapshot){const s=this.prevConvListOrderSnapshot,a=e;for(let e=a.length-1;e>=0;e-=1)if(s[e]!==a[e]){t=!0;break}}return this.prevConvListOrderSnapshot=e,t}}ni.instance=null;var ri=s("3NFW"),oi=s("s40A"),li=s("IfQO"),ci=s("JhTw");class di{static getInstance(){return null===this.instance&&(this.instance=new di),this.instance}constructor(){this.logger=void 0;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger(R.ZLoggerNametags.offline2Online,["offline-data"])}init(){li.a.getInstance().init(),this.registerAllListeners()}registerAllListeners(){const e=li.a.getInstance();e.addEventListener(ci.c.Start,(()=>{xa.a.reset(),this.setConvListAnimationMode(Qa.b.ADVANCED),this.resetConvListOrderTracker(),this.startTrackingConvListOrder(),this.cancelO2OMetric(),this.startO2OMetric(),this.signalKeepLoadingScreenIfNeed()})),e.addEventListener(ci.c.End,(async e=>{await Object(oi.c)(2e3),this.stopTrackingConvListOrder();const t=this.getTrackingConvListOrderResult();this.resetConvListOrderTracker();const{result:s}=e,a=await this.getOfflineInfo();this.endO2OMetric(s,t,{tsOffline:a.tsOffline,tsOnline:a.tsOnline,onlineType:s.offlineInfo.onlineType});const i=ri.a.getInstance();await i.stop()})),e.addEventListener(ci.c.PreProcessingSettle,(e=>{this.recordPreProcessingResultForO2OMetric(e.error,e.result),this.signalDismissLoadingScreen()})),e.addEventListener(ci.c.OfflineProcessingUIDone,(()=>{this.setConvListAnimationMode(Qa.b.NORMAL),xa.a.reset()}))}setConvListAnimationMode(e){Qa.a.getInstance().setAnimationMode(e)}cancelO2OMetric(){Za.getInstance().cancel(qa.HandleOfflineData)}startO2OMetric(){Za.getInstance().start(qa.HandleOfflineData)}startTrackingConvListOrder(){ni.getInstance().startTracking()}endO2OMetric(e,t,s){Za.getInstance().end(qa.HandleOfflineData,{convListSort:{count:t.numOfOrderChanges},fps:e.fps,cpu:e.cpu,workload:{msgPull:e.workload.msgPull,convPull:e.workload.convPull,msgPreProcess:e.workload.msgPreProcess},timeUsage:{pull:e.timeUsage.pull,preProcess:e.timeUsage.preProcess},result:{msgPull:e.result.msgPull},offlineInfo:{tsOffline:s.tsOffline,tsOnline:s.tsOnline,onlineType:(()=>{switch(s.onlineType){case ci.a.FRESH_START:return Ka.FRESH_START;case ci.a.RESUME:return Ka.RESUME;default:return Ka.UNKNOWN}})()}})}stopTrackingConvListOrder(){ni.getInstance().stopTracking()}getTrackingConvListOrderResult(){return ni.getInstance().getTrackingResult()}resetConvListOrderTracker(){ni.getInstance().reset()}async getOfflineInfo(){const e={tsOffline:-1,tsOnline:-1};try{const t=a.ModuleContainer.resolve(ei),[s,i]=await Promise.all([t.getStartTsOnlineCurrSession(),t.getLastTsOnlinePrevSession()]);e.tsOffline=i,e.tsOnline=s}catch(t){this.logger.zsymb(21,"WqSnw0",["Failed to get offline info: {}","RfGoaV"],Object(Kt.c)(t))}return e}recordPreProcessingResultForO2OMetric(e,t){const s=Za.getInstance();if(null!==e)s.record(qa.HandleOfflineData,{error:{preProcess:Object(Kt.c)(e)}});else{if(!t)return void this.logger.zsymb(0,"r7kidU","[recordPreProcessingResultForO2OMetric] Empty result");if(!["allmsgs","clearUnreads","clearUnreadsReact"].every((e=>e in t)))return void this.logger.zsymb(18,"sBxOFC","[recordPreProcessingResultForO2OMetric] Invalid result");let e=0,a=0,i=0,n=0;t.allmsgs.forEach((t=>{const{isGroup:s,cmd:r}=t;s?122===r?a+=1:n+=1:122===r?e+=1:i+=1})),s.record(qa.HandleOfflineData,{workload:{msgPreProcess:{"1_1":e,group:a,e2ee1_1:i,e2eeGroup:n,clearUnreads:t.clearUnreads.length,clearUnreadsReact:t.clearUnreadsReact.length}}})}}signalKeepLoadingScreenIfNeed(){a.ModuleContainer.resolve(Ga.c).startKeepLoadingIfNeeded()}async signalDismissLoadingScreen(){a.ModuleContainer.resolve(Ga.c).dismissLoadingScreen()}}di.instance=null,di.getInstance().init();s("tPRg");var ui=s("z0WU"),hi=(s("FcQj"),s("sxU/")),gi=s("eSGF");let mi;function pi(){return mi||(mi=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),mi}const fi={[ve.FetchActions.DELETE_MESSAGE]:(e,t)=>{var s;vi(e.toUid||e.userId||(null===(s=e.conversation)||void 0===s?void 0:s.userId),e.msgId)},[ve.FetchActions.DELETE_EVERYONE]:(e,t)=>{vi(e.toUid,e.msgId)},[ve.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>vi(e.toUid||e.userId,e.msgId)))},[ve.FetchActions.UNDO]:(e,t)=>{vi(e.toUid||e.userId,e.msgId)},[ve.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)vi(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[ve.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{vi(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[ve.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==Ce.default.sendToMeId&&vi(s,e.msgId)}};function vi(e,t){if(!e)return;if(!t)return;let s=Object(gi.a)(t);hi.a.instance.emit("media-removed",{convId:e,msgIds:s})}_e.default.subscribe((function(e,t){let s=fi[e];if(s)try{s(t,e)}catch(a){pi().zsymb(18,"Apb99B","Failed to run side effect for event:"+e),pi().zsymb(18,"pKoELT",[a])}}));var _i=s("2ua2");s.p;_i.default.init(),ui.default.checkSupport(),ui.default.showWarningMsg();var bi,Ii=s("UiPd"),yi=s("Kvb3"),Si=s("lTs8"),Ci=s("DvVh"),Ei=s("Y4eg"),Oi=s("+2cI");Object(a.singleton)(yi.a)(bi=Object(m.f)()(bi=Reflect.metadata("design:type",Function)(bi=Reflect.metadata("design:paramtypes",[])(bi=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!1}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}get dispatch(){return this._dispatch}async preFormatPayload(e){var t;let s=Object(I.a)({},e);if(s.conversation){var a,i;if(null===(a=s.conversation.userId)||void 0===a||null===(i=a.startsWith)||void 0===i?void 0:i.call(a,Y.GROUPID_PREFIX)){const e=s.conversation.userId,t=await me.a.GroupManager.get(e);if(t&&(s.conversation.topMember=t.topMembers,s.conversation.displayName=t.displayName),s.conversation.topMember)for(const a of s.conversation.topMember){const e=Ii.default.getMiniInfo(a.id);e&&(a.dName=e.dName,a.avatar=e.avatar)}}else{const e=Ii.default.getMiniInfo(s.conversation.userId);e&&(s.conversation.displayName=e.dName,s.conversation.avatar=e.avatar)}}return(null===(t=s.images)||void 0===t?void 0:t.length)>1&&s.message&&(s.images=[s.message]),s}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,Ii.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(I.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){var t;let s=await this.preFormatPayload(e);s=this._addSession(s),this.connectSignalToFriendWorker();const a=this.getDispatch();a&&a({type:ve.ChatBoxActions.SHOW_FULL_IMAGE,payload:s}),Ei.a.initLog(),Oi.a.startSession(),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,null!==(t=s)&&void 0!==t&&t.isVideo?Ci.d.openVideo:Ci.d.openPhoto)}async openImageCaptionEditor(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:ve.ChatBoxActions.SHOW_MEDIA_CAPTION_EDITOR,payload:t})}})||bi)||bi)||bi);var Mi,Ti=s("MLNQ"),wi=s("Gd06");Object(a.singleton)(wi.a)(Mi=class extends Ti.a{initialize(e){this.createModuleInstances(e)}onCloseChildWindow(e){this.getModules(e).forEach((t=>{t&&t.onCloseChildWindow&&"function"==typeof t.onCloseChildWindow&&t.onCloseChildWindow(e)})),this.releaseModules(e)}onOpenChildWindow(e){this.initialize(e);this.getModules(e).forEach((t=>{t&&t.onOpenChildWindow&&"function"==typeof t.onOpenChildWindow&&t.onOpenChildWindow(e)}))}});s("B3nq");var Ri,Li=s("EAii"),Di=s("Fdeg"),Ai=s("rCQs"),Fi=s("PD1X"),ki=s("KkZn"),Ni=s("IpzU"),Pi=s("vXRA");const ji=$znode.path,Ui=$znode.fs;Object(Ai.b)(Li.a)(Ri=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Ri=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Ri=Reflect.metadata("design:type",Function)(Ri=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a])(Ri=class{constructor(e,t){this._app=t,this._isExpired=!0,this._localCacheName="res.zcache",this._localCacheFolders={[Di.a.zaloLocal]:"",[Di.a.zaloDB]:"",[Di.a.zaloProramExe]:"",[Di.a.zaRF]:"",[Di.a.zaloTemp]:"",[Di.a.zTemp]:""},this._localCacheData={[Di.a.zaloLocal]:new u.default({maxSize:1e4}),[Di.a.zaloDB]:new u.default({maxSize:1e3}),[Di.a.zaloProramExe]:new u.default({maxSize:5e3}),[Di.a.zaRF]:new u.default({maxSize:1e3}),[Di.a.zaloTemp]:new u.default({maxSize:1e3}),[Di.a.zTemp]:new u.default({maxSize:1e3})},this.logger=void 0,this.init=()=>{"render"===__ZaBUNDLENAME__&&this.getCachePaths()},this.getLocalCacheData=async e=>{const t=".rescache",s=[],a=await Object(Ni.getzTempDir)(),i=await Object(Ni.getZaloTempDir)();Di.c.forEach((n=>{try{let r;r="zTemp"===n?ji.join(a,t):"ZaloTemp"===n?ji.join(i,t):ji.join(e,"ZaloDownloads"===n?"":n,t),null!=Ui&&Ui.existsSync(r)&&s.push(this.readCacheFile(r,n))}catch(r){}}));const n=await Promise.all(s),r={};return n.forEach((e=>{r[e.type]={count:(null==e?void 0:e.count)||0,size:(null==e?void 0:e.totalSize)||0}})),r},this.readCacheFile=async(e,t)=>{try{{let s=await $zFileManager.getFileArrayBuffer(e);const a=new Blob([s]),i=await a.text();return Object(I.a)(Object(I.a)({},Object(ki.g)(i)),{},{type:t})||null}}catch(s){throw Error(s)}},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this._app.addEventListener(m.b.Authenticated,this.init),this._app.addEventListener(m.b.Exit,this._removeListeners))},this._removeListeners=()=>{"render"===__ZaBUNDLENAME__&&(this._app.removeEventListener(m.b.Authenticated,this.init),this._app.removeEventListener(m.b.Exit,this._removeListeners))},this.logger=e.createZLogger("resmgmt",["cache-maanger"]),this.logger.zsymb(5,"g8jd7R",["ResCacheManager is created","E-Zup0"]),this._listenEvents()}async getCacheType(e){if((e=(null==ji?void 0:ji.join(e,ji.sep))||e).startsWith(this._localCacheFolders[Di.a.zaloLocal]))return Di.a.zaloLocal;if(e.startsWith(this._localCacheFolders[Di.a.zaloDB]))return Di.a.zaloDB;if(e.startsWith(this._localCacheFolders[Di.a.zaloProramExe]))return Di.a.zaloProramExe;if(e.startsWith(this._localCacheFolders[Di.a.zTemp]))return Di.a.zTemp;if(e.startsWith(this._localCacheFolders[Di.a.zaloTemp]))return Di.a.zaloTemp;if(await this._getVerifiedZaRFPath(),e.includes(this._localCacheFolders[Di.a.zaRF]))return Di.a.zaRF;throw new Error("Invalid cache type "+e)}async hasScan(e){const t=await this.getCacheType(e);return this._localCacheData[t].has(e)}async getScan(e){e=e.endsWith("/")?e.slice(0,-1):e;const t=await this.getCacheType(e);if(this._localCacheData[t].has(e))return this._localCacheData[t].get(e);let s=()=>{},a=()=>{};const i=new Promise(((e,t)=>{s=e,a=t}));return this._localCacheData[t].set(e,{promise:i,resolve:s,reject:a}),{promise:i,resolve:s,reject:a}}async revokeCache(){this._isExpired=!0}async signCache(){this._isExpired=!1,this._clearAllCacheData()}async hasCacheFile(e){let t=ji.dirname(e);t=t.endsWith("/")?t.slice(0,-1):t;const s=await this.getCacheType(t);if(this._isExpired)return this._localCacheData[s].delete(e),!1;this._localCacheFolders[s]||await this.getCachePaths();return this._localCacheData[s].has(t)}async getCacheFile(e){let t=0,s=ji.dirname(e);s=s.endsWith("/")?s.slice(0,-1):s;const a=ji.basename(e);if(!this.hasCacheFile(e)){this.logger.zsymb(15,"bkYTKC",["Cache not found for {}. Request calculator for {}","x1AdrH"],e,s);try{const e=new Fi.a(s),a=await e.run();t=a.result||0,this.logger.zsymb(15,"fFThIP",["Calculate {} responded with {}","cim16G"],s,a)}catch(r){}}const i=await this.getCacheType(s),n=this._localCacheData[i].get(s);return t=(await n.promise).data[a][1],this.logger.zsymb(15,"9H3uOc",["Folder size: {} === {} bytes","BCHAqN"],e,t),t}verifyCache(){this._isExpired=!1}isValid(){return!this._isExpired}deleteCacheObject(e){this._localCacheData[e].clear()}_clearAllCacheData(){this._localCacheData[Di.a.zaloLocal].clear(),this._localCacheData[Di.a.zaloDB].clear(),this._localCacheData[Di.a.zaloProramExe].clear(),this._localCacheData[Di.a.zaRF].clear()}_removeTrailingPathSeparator(e){return e.replace(/[\\/]+$/,"")}async getCachePaths(){this._localCacheFolders[Di.a.zaloLocal]=this._removeTrailingPathSeparator(await Object(Ni.getZaloPCDir)()),this._localCacheFolders[Di.a.zaloDB]=this._removeTrailingPathSeparator(await Object(Ni.getZaloDir)()),this._localCacheFolders[Di.a.zaloProramExe]=this._removeTrailingPathSeparator(await Object(Ni.getexeDir)()),this._localCacheFolders[Di.a.zaRF]=this._removeTrailingPathSeparator(await Object(Pi.a)()),this._localCacheFolders[Di.a.zTemp]=this._removeTrailingPathSeparator(await Object(Ni.getzTempDir)()),this._localCacheFolders[Di.a.zaloTemp]=this._removeTrailingPathSeparator(await Object(Ni.getZaloTempDir)());for(const e in this._localCacheFolders){const t=this._localCacheFolders[e];t&&(this._localCacheFolders[t]=e)}await this._getVerifiedZaRFPath()}async _getVerifiedZaRFPath(){const e=await Object(Pi.a)(),t=ji.dirname(e);return this._localCacheFolders[Di.a.zaRF]=t,this._localCacheFolders[t]=Di.a.zaRF,t}})||Ri)||Ri)||Ri)||Ri);var Bi=s("7Xnh"),zi=s("Ff2n");let Gi=function(e){return e.DiskStatus="DiskStatus",e.ZaloUsage="ZaloUsage",e.DeleteConv="DeleteConv",e.Cache="Cache",e.TimeGoToSM="TimeGoToSM",e.TimeFinishedScan="TimeFinishedScan",e.MigrateDB="MigrateDB",e.ChangeStorageZone="ChangeStorageZone",e}({}),xi=function(e){return e[e.Routine=0]="Routine",e[e.UserManual=1]="UserManual",e[e.Partial=2]="Partial",e[e.Forced=3]="Forced",e}({}),Vi=function(e){return e.CacheValid="cache_valid",e.StartNewScanWithoutCache="start_new_scan_without_cache",e.StartNewScanWithCache="start_new_scan_with_cache",e.ContinueQuickScan="continue_quick_scan",e.ContinueDBScan="continue_db_scan",e}({});const Hi={[Gi.DiskStatus]:5,[Gi.ZaloUsage]:7,[Gi.DeleteConv]:8,[Gi.Cache]:9,[Gi.TimeGoToSM]:10,[Gi.TimeFinishedScan]:11,[Gi.ChangeStorageZone]:12};function Wi(e){let t=e/864e5;return t=Math.round(t),t=Math.min(Math.max(t,0),15),15===t&&(t=-1),t}function qi(e){let t=e/864e5;return t=Math.round(t),t=Math.max(t,0),t}var Ki=s("KmCD"),$i=s("u8fi"),Zi=s("MGH9"),Qi=s("v4vb"),Yi=s("Fzrl"),Ji=s("6QZ1"),Xi=(s("tx+P"),s("Dy6U")),en=s("e4Kp");const tn=["type"];var sn;const an="resource_management_last_time_send_log_auto",nn="resource_management_last_time_send_log_disk_status_auto",rn="resource_management_last_time_send_log_migrate_db_auto";var on=function(e){return e[e.YES=1]="YES",e[e.NO=0]="NO",e}(on||{});let ln=Object(m.d)()(sn=Reflect.metadata("design:type",Function)(sn=Reflect.metadata("design:paramtypes",[])(sn=class{constructor(){this.userCacheDir="",this.LogHistory={[Gi.DiskStatus]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Gi.ZaloUsage]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Gi.Cache]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Gi.MigrateDB]:{ts:-Ce.default.full_disk_check.migrate_db_report_interval,pending:!1}},this.autoReportTimer=null,this.autoDiskStatusReportTimer=null,this.autoMigrateDBReportTimer=null,this.secureLocalStorage=void 0,this.timeGoToSM=0,this.startAutoReport=()=>{if(this.autoReportTimer)return;const e=this.secureLocalStorage.getItem(an);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.report_interval&&this.report(),this.autoReportTimer=setInterval(this.report,Ce.default.full_disk_check.report_interval)},this.report=async()=>{this.zaloUsageReport(),this.cacheReport({scan_event:xi.Routine}),this.secureLocalStorage.setItem(an,`${this.getTimeNow()}`)},this.getScanType=()=>xi,this.getTimeNow=()=>Ct.default.getSystemTimeNow()||Date.now(),this.canReport=()=>Ce.default.full_disk_check.enable_disk_cache&&Ce.default.full_disk_check.enable_report,this.canMigrateDBReport=()=>Ce.default.full_disk_check.enable_report_migrate_db,this.diskStatusReport=async e=>{if(!this.canReport())return;const{DiskStatus:t}=this.LogHistory,s=e?xi.UserManual:xi.Routine;if(s===xi.Routine&&!this._canActionLogDiskStatus(t.ts)||t.pending)return;this.LogHistory.DiskStatus.pending=!0;const a=e||Ki.a.analyzeMainDisk();let i="";if(i="Mac",a){const{total:e,free:t}=a,n=we.default.getFullDiskChatPopupNoti()||{},r=(null==n?void 0:n.ts)||0;let o=0;r&&(o=qi(this.getTimeNow()-r)),this.logAction999({type:"DiskStatus",scan_event:s,free:t,total:e,ts:this.getTimeNow(),current_disk:i,time_in_this_zone:o})}this.LogHistory.DiskStatus.pending=!1},this.zaloUsageReport=async e=>{var t,s;if(!this.canReport())return;const{ZaloUsage:i}=this.LogHistory;let n=null!==(t=null==e?void 0:e.scan_event)&&void 0!==t?t:xi.Routine;if(n===xi.Routine&&!this._canActionLog(i.ts)||i.pending)return;this.LogHistory.ZaloUsage.pending=!0;const r=a.ModuleContainer.resolve($i.b),o=Ki.a.analyzeMainDisk(),l=JSON.parse(Xi.a.getOverviewPageData()),c=a.ModuleContainer.resolve(Zi.a);let d,u=!1;null!=l&&l.time?(d=l,u=!0):d=await r.getZaloUsageForLog();let h=0,g=0,m=0;const p={count:0,size:0};if(!this.userCacheDir){const e=J.p.getSessionUserId();this.userCacheDir=await Object(Ni.getUserZaloDownloadsDir)(e)}let f=d.otherDataSize,v=d.total;if(u){const{zaloLocalSize:e,appDataSize:t,zaRFSize:s,zTempSize:a,zaloTempSize:i,zaloDBSearchSize:n,convDataSize:r,otherAccountsSize:o}=d;let l=e+t+a+i+n;f=l-r-o,en.a.resource_management.enable_calculate_zrf&&(l+=s,f-=s),v=l}const _=d.appDataSize,b=c.getCompletedScanDBTime();let y={media_message:d.convDataSize,zalo_received_files:d.zarf||d.zaRFSize,other_accounts:d.otherAccountsSize,other_data:f,db_size:_,zalo_temp:d.zaloTempSize||0,ztemp:d.zTempSize||0};if(b){const e=Wi(this.getTimeNow()-b);c.getConvData().forEach((e=>{const t=e.convId,s=Ki.a.getCache(t);p.count+=1,s&&(p.size+=s.filesSize+s.imagesSize+s.videosSize,h+=s.filesSize,m+=s.imagesSize,g+=s.videosSize)})),y=Object(I.a)(Object(I.a)({},y),{},{total_known_by_db:p,photo_on_db:m,file_on_db:h,video_on_db:g,db_scan_cache_age:e})}const S={used:v,free:null!==(s=null==o?void 0:o.free)&&void 0!==s?s:-1};let C="";C="Mac",S&&this.logAction999(Object(I.a)(Object(I.a)({type:"ZaloUsage",scan_event:n,used:S.used,ts:this.getTimeNow(),free:S.free},y),{},{current_disk:C})),this.LogHistory.ZaloUsage.pending=!1},this.cacheReport=async e=>{var t,s;if(!this.canReport())return;const{Cache:i}=this.LogHistory;let n=null!==(t=null==e?void 0:e.scan_event)&&void 0!==t?t:xi.Routine;if(n===xi.Routine&&!this._canActionLog(i.ts)||i.pending)return;this.LogHistory.Cache.pending=!0;const r=a.ModuleContainer.resolve(Li.a);if(!this.userCacheDir){const e=J.p.getSessionUserId();this.userCacheDir=await Object(Ni.getUserZaloDownloadsDir)(e)}const o=await r.getLocalCacheData(this.userCacheDir),l=a.ModuleContainer.resolve(Zi.a),c={count:0,size:0},d=Ki.a.analyzeMainDisk();let u=0,h=0,g=0;const m=l.getCompletedScanDBTime();let p="";p="Mac";let f={type:"Cache",scan_event:n,cache:{cache:o.Cache,file_thumb:o.fileThumb,file:o.file,video:o.video,picture:o.picture,file_noise:o.fileNoise,rich_thumb:o.richThumb,total_on_disk:o.ZaloDownloads,voice:o.voice,zinstant:o.zinstant},ts:this.getTimeNow(),free:null!==(s=null==d?void 0:d.free)&&void 0!==s?s:-1,current_disk:p};if(m){const e=Wi(this.getTimeNow()-m);l.getConvData().forEach((e=>{const t=e.convId,s=Ki.a.getCache(t);c.count+=1,s&&(c.size+=s.filesSize+s.imagesSize+s.videosSize,u+=s.filesSize,h+=s.videosSize,g+=s.imagesSize)})),n===xi.Partial&&(n=xi.UserManual),f=Object(I.a)(Object(I.a)({},f),{},{total_known_by_db:c,file_on_db:u,video_on_db:h,photo_on_db:g,db_scan_cache_age:e})}f&&this.logAction999(f),this.LogHistory.Cache.pending=!1},this.migrateDBReport=async()=>{if(!this.canMigrateDBReport())return;const{MigrateDB:e}=this.LogHistory;if(xi.Routine===xi.Routine&&!this._canActionLogMigrateDB(e.ts)||e.pending)return;this.LogHistory.MigrateDB.pending=!0;const t=(await Object(Yi.a)()).length,s=a.ModuleContainer.resolve(Ji.a),i=s.getTotalMigratedAccount(),n=s.isCurrentAccountMigrated(),r={all_migrated:await $zFeatures.migrateDB.isMigrateFullDone(),number_of_acc_on_device:t,number_of_acc_upgraded:i,is_this_acc_upgraded:n,imei:Ia.default.getDeviceID(),ts:this.getTimeNow()};Ia.default.logActionInfoV2(Ia.FeaturesInfo.MigrateDrive,9999,r),this.LogHistory.MigrateDB.pending=!1},this.timeGoToSMReport=e=>{if(!this.canReport())return;const t=this.timeGoToSM;this.logAction999({type:"TimeGoToSM",ts:this.getTimeNow(),status:e,times_opened_SM_tool_in_this_session:t}),this.timeGoToSM++},this.timeFinishedScanReport=e=>{const t=this.secureLocalStorage.checkExistForCurrentUser(Qi.d);let s=on.NO,a=on.NO;t&&(e.timeToQuickScanComplete>0&&(s=on.YES),e.timeToDBScanComplete>0&&(a=on.YES)),this.logAction999({type:"TimeFinishedScan",ts:this.getTimeNow(),scan_event:e.scanEvent,time_to_complete_db_scan:e.timeToDBScanComplete,time_to_complete_quick_scan:e.timeToQuickScanComplete,opening_tool_when_db_scan_complete:a,opening_tool_when_quick_scan_complete:s})},this.changeStorageZone=e=>{var t;const s=Ki.a.analyzeMainDisk(),a=qi(this.getTimeNow()-e.tsInPreviousStorageZone);this.logAction999({type:"ChangeStorageZone",free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_storage_zone:e.currentStorageZone,previous_storage_zone:e.previousStorageZone,time_in_previous_zone:a})},this.dispose=()=>{clearInterval(this.autoReportTimer),clearInterval(this.autoDiskStatusReportTimer),clearInterval(this.autoMigrateDBReportTimer)},this.logAction999=e=>{const{type:t}=e;Object(zi.a)(e,tn);let s;switch(t){case"DiskStatus":s=Hi.DiskStatus,this.LogHistory.DiskStatus.ts=performance.now();break;case"ZaloUsage":s=Hi.ZaloUsage,this.LogHistory.ZaloUsage.ts=performance.now();break;case"DeleteConv":s=Hi.DeleteConv;break;case"Cache":s=Hi.Cache,this.LogHistory.Cache.ts=performance.now();break;case"TimeGoToSM":s=Hi.TimeGoToSM;break;case"TimeFinishedScan":s=Hi.TimeFinishedScan;break;case"ChangeStorageZone":s=Hi.ChangeStorageZone}const a=Object(I.a)(Object(I.a)({},e),{},{device_id:Ia.default.getDeviceID()});return Ia.default.logActionInfoV2(Ia.FeaturesInfo.ResourceManagementV2,s,a),Promise.resolve()},this._canActionLog=e=>performance.now()-e>Ce.default.full_disk_check.report_interval,this._canActionLogDiskStatus=e=>performance.now()-e>Ce.default.full_disk_check.disk_status_report_interval,this._canActionLogMigrateDB=e=>performance.now()-e>Ce.default.full_disk_check.migrate_db_report_interval,this.secureLocalStorage=n.default.getInstance(),this.startDiskStatusAutoReport(),this.startAutoReport(),this.startMigrateDBAutoReport()}onApplicationReady(){this.startDiskStatusReport(),this.startDiskStatusAutoReport(),this.startMigrateDBReport()}startDiskStatusAutoReport(){const e=this.secureLocalStorage.getItem(nn);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.disk_status_report_interval&&this.startDiskStatusReport(),this.autoDiskStatusReportTimer=setInterval(this.diskStatusReport,Ce.default.full_disk_check.disk_status_report_interval)}startMigrateDBAutoReport(){const e=this.secureLocalStorage.getItem(rn);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.migrate_db_report_interval&&this.startMigrateDBReport(),this.autoMigrateDBReportTimer=setInterval(this.migrateDBReport,Ce.default.full_disk_check.migrate_db_report_interval)}startDiskStatusReport(){this.diskStatusReport(),this.secureLocalStorage.setItem(nn,`${this.getTimeNow()}`)}startMigrateDBReport(){this.migrateDBReport(),this.secureLocalStorage.setItem(rn,`${this.getTimeNow()}`)}})||sn)||sn)||sn;a.ModuleContainer.registerSingleton(Bi.a,ln);const cn=Object(a.define)("resmgmt-conv-filter-manager"),dn=Object(a.define)("resmgmt-convdata-manager");var un=s("EFQ6"),hn=s("Gm1y");Event;class gn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class mn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class pn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class fn extends Event{constructor(e){super(e)}}Event;Event;class vn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class _n extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class bn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class In extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class yn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}let Sn=function(e){return e.Update_Convdata_List="Update_Convdata_List",e.ResCalc_UI_Status_Change="ResCalc_UI_Status_Change",e.ResCalc_ZaRF_Status="ResCalc_ZaRF_Status",e.ResCalc_AppData_Status="ResCalc_AppData_Status",e.ResCalc_ZaloLocal_Status="ResCalc_ZaloLocal_Status",e.ResCalc_ConvData_Status="ResCalc_ConvData_Status",e.ResCalc_OtherAccounts_Status="ResCalc_OtherAccounts_Status",e.ResCalc_zTemp_Status="ResCalc_zTemp_Status",e.ResCalc_ZaloTemp_Status="ResCalc_ZaloTemp_Status",e.ResConv_FilterSort_Status_Change="ResConv_FilterSort_Status_Change",e.ResDisk_Status="ResDisk_Status",e.ResNoti_Dimiss="ResNoti_Dimiss",e.ResNoti_Open_Setttings="ResNoti_Open_Setttings",e.ResStats_Tree_Change="ResStats_Tree_Change",e.ResDisk_CurrentLevel="ResDisk_CurrentLevel",e.ResDisk_Full_Disk_Status="ResDisk_Full_Disk_Status",e.ResCalc_Manual_Fast_Calculate="ResCalc_Manual_Fast_Calculate",e.ResCalc_Manual_Detail_Calculate="ResCalc_Manual_Detail_Calculate",e.ResCalc_Delete_Convs="ResCalc_Delete_Convs",e.ResCalc_Delete_Convs_Status="ResCalc_Delete_Convs_Status",e.ResCalc_Update_Detail_Page_Cache="ResCalc_Update_Detail_Page_Cache",e.ResCalc_Calculate="ResCalc_Calculate",e}({});var Cn=s("7NAg"),En=s("yzMR"),On=s("j1HC"),Mn=s("kcIR"),Tn=s("zbf3");const wn=["action","temp","qos","update"],Rn="res_mnt_delete_size_convs_session";var Ln;let Dn,An;function Fn(){}function kn(...e){0}Dn=$znode.fastGlob,An=$znode.path;let Nn=Object(a.injectable)()(Ln=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Ln=Reflect.metadata("design:type",Function)(Ln=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Ln=class extends hs.b{constructor(e){super(),this.resultCallback=void 0,this._resultCallback=void 0,this.onDataChange=void 0,this._onDataChange=void 0,this.stoppedDBScan=void 0,this.stoppedQuickScan=void 0,this.taskDBScanIds=void 0,this.taskQuickScanIds=void 0,this.data=void 0,this.dataRecalculate=void 0,this.dataCount=void 0,this.dataRecalculateCount=void 0,this.didDelete=void 0,this._totalConvs=0,this._totalOverviewConvs=0,this._taskCalcTs=0,this.Logger=void 0,this._hasNewAutoDownload=0,this.dataHiddenConversations=void 0,this.dataOverview=void 0,this.dataOverviewRecalculate=void 0,this.isFastScanRecalculate=void 0,this.isDetailScanRecalculate=void 0,this._finalConv=null,this._isFinalOverviewTask=!1,this.deleteConvIds=[],this.completedScanDBTime=0,this.hasNewAutoDownload=()=>{this.updateCurrentAutoDownload(this.getCurrentAutoDownload()+1)},this.getCurrentAutoDownload=()=>this._hasNewAutoDownload,this.updateCurrentAutoDownload=e=>{this._hasNewAutoDownload=e},this.getTimeNow=()=>Ct.default.getSystemTimeNow()||Date.now(),this.getCompletedScanDBTime=()=>this.completedScanDBTime,this.setConvToHidden=(e,t,s)=>{const i=()=>{this.data=this._filterInvalidConv(this.data),this.data=this._filterDuplicateConv(this.data),this.dataHiddenConversations=this._filterInvalidConv(this.dataHiddenConversations),this.dataHiddenConversations=this._filterDuplicateConv(this.dataHiddenConversations),Xi.a.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations});a.ModuleContainer.resolve($i.b).updateConvs(this.data)},n=()=>{const e=Xi.a.getDetailPageData();return e?JSON.parse(e):{convs:[],dataHiddenConversations:[]}},r=(e,t,s)=>{const a=t.find((t=>t.convId===e));return a&&(t=t.filter((t=>t.convId!==e)),s.push(a)),{source:t,target:s}};if(t){let t=r(e,this.data,this.dataHiddenConversations);const s=n();s.convs.length&&(t=r(e,s.convs,this.dataHiddenConversations),this.data=t.source),i()}else{let t=r(e,this.dataHiddenConversations,this.data);const a=n();a.dataHiddenConversations.length&&(t=r(e,a.dataHiddenConversations,this.data),this.dataHiddenConversations=t.source),s&&(this.data=this.data.filter((t=>t.convId!==e))),i()}},this.startCalculating=async(e=!1)=>{kn(),this._resetProgress();try{let t=this._hasNewAutoDownload>0||e?await this.getConvs():await this._getOutdatedConvs();t=t.filter((e=>e.userId!==Y.CONV_FILTER.STRANGER));const s=this.getCurrentAutoDownload();if(0===t.length&&!e&&(s<=0||0==this._totalOverviewConvs))return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Sn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Sn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1;if(this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.CALCULATING,type:"convDataStatus",progress:1}),0===t.length)return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Sn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Sn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1;this.dataCount=0,this.dataRecalculateCount=0,this._totalConvs=t.length,this._finalConv=t[this._totalConvs-1];for(let e=0;e<this._totalConvs;e++){if(this.stoppedDBScan)return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"}),!0;await this.createTask(t[e],this.isDetailScanRecalculate)}return this.completedScanDBTime=this.getTimeNow(),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataStatus",progress:100}),this.Logger.zsymb(2,"KXmss5",`[RES-MNT] DB scan finish - has manual calculate ${this.isDetailScanRecalculate}`),this._broadcastEvent(Sn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:this.dataHiddenConversations}),this.updateCurrentAutoDownload(this.getCurrentAutoDownload()-s),this._taskCalcTs=Date.now(),!0}catch(t){return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Sn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Sn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1}},this._broadcastEvent=(e,t)=>{switch(e){case Sn.ResCalc_ConvData_Status:this.dispatchEvent(new gn(Sn.ResCalc_ConvData_Status,t));break;case Sn.ResCalc_Manual_Fast_Calculate:this.dispatchEvent(new vn(Sn.ResCalc_Manual_Fast_Calculate,t));break;case Sn.ResCalc_Manual_Detail_Calculate:this.dispatchEvent(new vn(Sn.ResCalc_Manual_Detail_Calculate,t));break;case Sn.ResCalc_Delete_Convs:this.dispatchEvent(new _n(Sn.ResCalc_Delete_Convs,t));break;case Sn.ResCalc_Delete_Convs_Status:this.dispatchEvent(new bn(Sn.ResCalc_Delete_Convs_Status,t));break;case Sn.ResCalc_Update_Detail_Page_Cache:this.dispatchEvent(new In(Sn.ResCalc_Update_Detail_Page_Cache,t));break;case Sn.ResCalc_Calculate:this.dispatchEvent(new yn(Sn.ResCalc_Calculate,t))}},this.resultCallback=Fn,this._resultCallback=Fn,this.onDataChange=Fn,this._onDataChange=Fn,this.stoppedDBScan=!0,this.stoppedQuickScan=!0,this.taskDBScanIds=[],this.taskQuickScanIds=[],this.data=[],this.dataRecalculate=[],this.dataOverview=[],this.dataOverviewRecalculate=[],this.dataHiddenConversations=[],this.didDelete=new Map,this.isFastScanRecalculate=!1,this.isDetailScanRecalculate=!1,this.dataCount=0,this.dataRecalculateCount=0,this.Logger=e.createZLogger("resmgmt",["conv-datasource"])}status(){return this.stoppedDBScan?Cn.l.IDLE:Cn.l.CALCULATING}getConvData(){return this.data}setForceConvData(e){this.data=e}getConvHiddenData(){return this.dataHiddenConversations}setForceConvHiddenData(e){this.dataHiddenConversations=e}async start(e,t,s){this.stoppedDBScan=!1,this.onDataChange=s,this.isDetailScanRecalculate=t,this.resultCallback=e=>{if(kn(),this.stoppedDBScan)return void this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"});this.isDetailScanRecalculate?(this.dataRecalculate.length>0&&(this.dataRecalculate=this.dataRecalculate.filter((t=>t.convId!==e.convId))),this.dataRecalculate.push(e),this.deleteConvIds.length>0&&(this.dataRecalculate=this.dataRecalculate.filter((e=>!this.deleteConvIds.includes(e.convId)))),++this.dataRecalculateCount):(this.data.length>0&&(this.data=this.data.filter((t=>t.convId!==e.convId))),this.data.push(e),++this.dataCount);let t=this._getPercentage(this.isDetailScanRecalculate?this.dataRecalculateCount:this.dataCount);0===t&&(t=1),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.CALCULATING,type:"convDataStatus",progress:t}),this.isDetailScanRecalculate&&this._finalConv&&(e.userId==this._finalConv.userId||e.convId==this._finalConv.convId)&&(this.Logger.zsymb(2,"paDaqH",`[RES-MNT] DB scan finish the last conversation - has manual calculate ${this.isDetailScanRecalculate}`),this._broadcastEvent(Sn.ResCalc_Manual_Detail_Calculate,!1),this.data=[...this.dataRecalculate]),this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),this.onDataChange(this.data)},this.isDetailScanRecalculate?(this.dataRecalculate=[],this._finalConv=null):(this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),this.onDataChange(this.data)),this.Logger.zsymb(2,"Jv93ca",`[RES-MNT] DB scan start - has manual calculate ${this.isDetailScanRecalculate}`);return await this.startCalculating(e)}async fastStart(e,t,s){this.stoppedQuickScan=!1,this._onDataChange=s,this.isFastScanRecalculate=t;this._resultCallback=e=>{if(this.stoppedQuickScan)return void this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"});const t=((e,t)=>{const s=new Set(t.map((e=>e.path)));return(e=e.filter((e=>!s.has(null==e?void 0:e.path)))).push(...t),e})(this.isFastScanRecalculate?this.dataOverviewRecalculate:this.dataOverview,e);this.isFastScanRecalculate?this.dataOverviewRecalculate=t:this.dataOverview=t;const s=t.length,a=this._getPercentage(s,this._totalOverviewConvs);this.isFastScanRecalculate&&100===a&&(this.dataOverview=[...this.dataOverviewRecalculate])},this.isFastScanRecalculate?this.dataOverviewRecalculate=[]:this._onDataChange(this.dataOverview),this.Logger.zsymb(2,"IiDbga",`[RES-MNT] Quick scan start - has manual calculate ${this.isFastScanRecalculate}`);return await this.fastStartCalculating()}async fastStartCalculating(){if(this._resetOverviewProgress(),this.stoppedQuickScan)return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"}),!0;try{const e=J.p.getSessionUserId(),t=await Object(Ni.getUserZaloDownloadsDir)(e),s={stats:!0,onlyFiles:!0,dot:!1},a=await Dn(Object(On.a)(An.join(t,"picture","**")),s),i=await Dn(Object(On.a)(An.join(t,"video","**")),s),n=await Dn(Object(On.a)(An.join(t,"file","**")),s),r=await Dn(Object(On.a)(An.join(t,"fileNoise","**")),s),o=await Tn.b.execRaw("getLocalSize",[Object(On.a)(An.join(t,"picture")),s],{priority:Tn.a.HIGH}),l=await Tn.b.execRaw("getLocalSize",[Object(On.a)(An.join(t,"video")),s],{priority:Tn.a.HIGH}),c=await Tn.b.execRaw("getLocalSize",[Object(On.a)(An.join(t,"file")),s],{priority:Tn.a.HIGH}),d=await Tn.b.execRaw("getLocalSize",[Object(On.a)(An.join(t,"fileNoise")),s],{priority:Tn.a.HIGH});let u=[...a,...i,...n,...r],h=0;if(en.a.resource_management.enable_calculate_voice){const e=await Dn(Object(On.a)(An.join(t,"voice","**")),s);h=await Tn.b.execRaw("getLocalSize",[Object(On.a)(An.join(t,"voice")),s],{priority:Tn.a.HIGH}),u=[...u,...e]}if(0===u.length)return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataOverviewStatus"}),this._onDataChange([]),this._totalOverviewConvs=0,!1;this._totalOverviewConvs=u.length,this._isFinalOverviewTask=!1,this.Logger.zsymb(2,"wyubFj",`[RES-MNT] Quick scan start scan current account ${Date.now()}`),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.CALCULATING,type:"convDataOverviewStatus"});const g={filesSize:d+c,videosSize:l,imagesSize:o,voicesSize:h};this.isFastScanRecalculate&&this._broadcastEvent(Sn.ResCalc_Manual_Fast_Calculate,!1),this._onDataChange([{amount:g}]);const m=[];for(let p=0;p<u.length;p++){if(this.stoppedQuickScan)return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"}),!0;p===u.length-1&&(this._isFinalOverviewTask=!0);const e=(e,t)=>{let s=0;return new RegExp(`/\\b${t}\\b/`).test(e.path)&&(s=e.stats.size),s},t=e(u[p],"file")+e(u[p],"fileNoise"),s=e(u[p],"video"),a=e(u[p],"picture"),i={filesSize:t,videosSize:s,imagesSize:a,voicesSize:e(u[p],"voice")};m.push({amount:i,path:u[p].path})}return this._resultCallback(m),this.Logger.zsymb(2,"v5zu0k",`[RES-MNT] Quick scan finish scan current account ${Date.now()}`),this.Logger.zsymb(2,"mNQMsW",`[RES-MNT] Quick scan finish - has manual calculate ${this.isFastScanRecalculate}`),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataOverviewStatus"}),!0}catch(e){return this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataOverviewStatus"}),this._onDataChange([]),this._totalOverviewConvs=0,!1}}createScanFastTask(e){return new Promise(((t,s)=>{try{let s=s=>{let a={amount:s,path:e.path};return this._resultCallback(a),t(a)},a=Ki.a.fastCalculateConvData(e,s);this.taskQuickScanIds.push(a)}catch(a){return t(null)}}))}cancelDBScan(){kn(),this.resultCallback=Fn,this.stoppedDBScan=!0,Ki.a.cancel(this.taskDBScanIds),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"})}cancelQuickScan(){this._resultCallback=Fn,this.stoppedQuickScan=!0,Ki.a.cancel(this.taskQuickScanIds),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"})}async onDelete(e,t){this._broadcastEvent(Sn.ResCalc_Delete_Convs_Status,Cn.c.IS_DELETING);try{this.deleteConvIds=[...this.deleteConvIds,...e],await Ki.a.cleanConvResource(e,t)}catch(s){}finally{this.deleteConvIds=[],this._broadcastEvent(Sn.ResCalc_Delete_Convs_Status,Cn.c.DONE_OR_ERROR)}}onUpdateDataBeforeDelete(e,t){let s=0;const i=JSON.parse(Xi.a.getDetailPageData());i&&i.convs.length>0&&(this.data=i.convs),i&&i.dataHiddenConversations.length>0&&(this.dataHiddenConversations=i.dataHiddenConversations);const n=this.dataHiddenConversations.filter((t=>e.includes(t.convId)));n.length>0&&(this.data=[...this.data,...n].filter(((e,t,s)=>t===s.findIndex((t=>JSON.stringify(t)===JSON.stringify(e))))));for(let a=0;a<this.data.length;a++){const n=this.data[a];let d=n.amount.filesSize,u=n.amount.imagesSize,h=n.amount.videosSize;if(this.dataOverview=this.dataOverview.filter((e=>null==e?void 0:e.path)),e.includes(n.convId)){let e=Mn.a.get(n.convId);var r,o,l,c;if(!e)e=null==i||null===(r=i.convs.find((e=>e.convId==n.convId)))||void 0===r?void 0:r.amount;if(un.a.isThreadHidden(n.convId)&&(this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.convId!==n.convId))),t.file)s+=d,d=0,null!==(o=e)&&void 0!==o&&o.filePaths&&e.filePaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>!e.filePaths.includes(null==t?void 0:t.path))));if(t.photo)s+=u,u=0,null!==(l=e)&&void 0!==l&&l.imagePaths&&e.imagePaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>e.imagePaths.some((e=>!(null!=t&&t.path.includes(e)))))));if(t.video)s+=h,h=0,null!==(c=e)&&void 0!==c&&c.videoPaths&&e.videoPaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>!e.videoPaths.includes(null==t?void 0:t.path))));this.data[a]=Object(I.a)(Object(I.a)({},n),{},{amount:{filesSize:d,imagesSize:u,videosSize:h}}),0===d&&0===u&&0===h&&this.didDelete.set(n.convId,!0)}}if(s){this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),Xi.a.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations}),this._broadcastEvent(Sn.ResCalc_Delete_Convs,s),sessionStorage.setItem(Rn,`${s}`);a.ModuleContainer.resolve($i.b).updateConvs(this.data)}}_filterDuplicateConv(e){const t=new Set;return e.filter((e=>!t.has(e.convId)&&(t.add(e.convId),!0)))}_filterInvalidConv(e){return e.filter((e=>"number"==typeof e.amount.videosSize&&"number"==typeof e.amount.imagesSize&&"number"==typeof e.amount.filesSize&&!(e.amount.videosSize+e.amount.imagesSize+e.amount.filesSize<=0)))}removeConvToList(e){let t=[];const s=JSON.parse(Xi.a.getDetailPageData());t=s&&s.convs.length>0?[...s.convs]:[...this.data];if(-1!==t.findIndex((t=>t.convId===e)))t=t.filter((t=>t.convId!==e));else{-1!==this.dataHiddenConversations.findIndex((t=>t.convId===e))&&(this.dataHiddenConversations=this.dataHiddenConversations.filter((t=>t.convId!==e)))}this.data=[...t],this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),Xi.a.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations});a.ModuleContainer.resolve($i.b).updateConvs(this.data)}setResCalculateStatus(e){this._broadcastEvent(Sn.ResCalc_Calculate,e)}_resetProgress(){this._totalConvs=0}_resetOverviewProgress(){this._totalOverviewConvs=0}_getPercentage(e,t=this._totalConvs){return 0===t?0:Math.round(e/t*100)}async getCache(){let e=[],t=await this.getConvs();for(let s=0;s<t.length;s++){let a=t[s];if(a&&a.convId&&!this.didDelete.get(a.convId)){let t=Ki.a.getCache(a.convId);t&&e.push(Object(I.a)(Object(I.a)({},a),{},{amount:t}))}}return e}async _getOutdatedConvs(){let e=await this.getConvs();this.Logger.zsymb(3,"X9hrzi",["total convs: {}","FlGvgr"],e.length);const t=a.ModuleContainer.resolve(Q.b);return this._taskCalcTs>0&&(e=e.filter((e=>{const s=t.getLastOpenConv(e.convId);return s&&s>=this._taskCalcTs&&!this.didDelete.get(e.convId)}))),this.Logger.zsymb(3,"GBD_3T",["outdated convs: {}","nBRw7H"],e.length),e}_caclculateHiddenConvSize(e,t){return new Promise(((s,a)=>{try{const{convId:a}=e;let i=t=>{let a=Object(I.a)(Object(I.a)({},e),{},{amount:t});return s(a)},n=Ki.a.calculateConvDataForResMnt(a,i,t);this.taskDBScanIds.push(n)}catch(i){return s(null)}}))}createTask(e,t){return kn(e.convId),new Promise(((s,a)=>{try{const{convId:a}=e;let i=t=>{let a=Object(I.a)(Object(I.a)({},e),{},{amount:t});return this.resultCallback(a),s(a)},n=Ki.a.calculateConvDataForResMnt(a,i,t);this.taskDBScanIds.push(n)}catch(i){return s(null)}}))}validateCalculateResult(e){return!(!e||e.videosSize+e.imagesSize+e.filesSize<1)}async getConvs(){try{const e=await me.a.ConvInfoDataManager.getAllConv(),t=a.ModuleContainer.resolve(En.PreviewDataManager);let s=[];if(!e||!e.length)return s;for(let a=0;a<e.length;a++){const i=async e=>{var s;let a="",i="";const n=e.userId,r=parseInt((null===(s=await t.getPreviewById(n))||void 0===s?void 0:s.messageTime)||"0");try{if(n.startsWith(Y.GROUPID_PREFIX)){const e=await hn.default.getFullInfoGroupById(n);e.displayName&&(a=e.displayName),e.avatar&&(i=e.avatar)}else{const e=await Ii.default.getProfileFriendById(n);e.displayName&&(a=e.displayName),e.avatar&&(i=e.avatar)}return{convId:n,displayName:a,userId:e.userId,avatar:i,lastMsgTime:r}}catch(o){return null}};let n=e[a];if(!n||!n.userId)continue;if(un.a.isThreadHidden(n.userId)){const e=await i(n);if(!e)continue;let t=Object(I.a)(Object(I.a)({},n),e);t=await this._caclculateHiddenConvSize(t,this.isDetailScanRecalculate),this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.convId!==t.convId)),t&&this.dataHiddenConversations.push(t),this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.amount.filesSize+e.amount.imagesSize+e.amount.videosSize>0));continue}const r=await i(n);r&&s.push(Object(I.a)(Object(I.a)({},n),r))}return s}catch(e){return[]}}})||Ln)||Ln)||Ln)||Ln;var Pn;let jn=Object(a.injectable)()(Pn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Pn=Reflect.metadata("design:type",Function)(Pn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Pn=class extends hs.b{constructor(e){super(),this._logger=void 0,this._filterBy=void 0,this._sortBy=void 0,this._searchBy=void 0,this._toggleHiddenBy=void 0,this._logger=e.createZLogger("resmgmt",["ResConvFilterManager"]),this._filterBy=Cn.i.ALL,this._sortBy=Cn.j.DECREASE_CAPACITY,this._searchBy="",this._toggleHiddenBy=!1}getCurrentFilter(){return this._filterBy}getCurrentSort(){return this._sortBy}getCurrentSearch(){return this._searchBy}getCurrentToggleHiddenConvs(){return this._toggleHiddenBy}filter(e){this._filterBy=e,this._logger.zsymb(2,"nR_wwV","filterBy",e),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"filterBy",value:e}))}resetDefault(){this._sortBy=Cn.j.DECREASE_CAPACITY,this._searchBy="",this._toggleHiddenBy=!1,this._logger.zsymb(2,"yJqpg5","resetDefault"),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"sortBy",value:Cn.j.DECREASE_CAPACITY,ignoreRender:!0})),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"searchBy",value:"",ignoreRender:!0})),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"toggleHiddenBy",value:!1,ignoreRender:!0}))}sort(e){this._sortBy=e,this._logger.zsymb(2,"60dVYs","sortBy",e),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"sortBy",value:e}))}search(e){this._searchBy=e,this._logger.zsymb(2,"RUZqzF","searchBy",e),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"searchBy",value:e}))}toggleHidden(e){this._toggleHiddenBy=e,this._logger.zsymb(2,"FQmkjF","toggleHiddenBy",e),this.dispatchEvent(new mn(Sn.ResConv_FilterSort_Status_Change,{type:"toggleHiddenBy",value:e}))}})||Pn)||Pn)||Pn)||Pn;class Un extends hs.b{constructor(e,t){super(),this._calculationTracker={recalcRequests:1,lastTs:0},this.logger=void 0,this._recordCalcHistory=e=>{this._calculationTracker=e?Object(I.a)(Object(I.a)({},this._calculationTracker),e):{recalcRequests:0,lastTs:Date.now()}},this.logger=t.createZLogger("resmgmt",[e])}checkForceCalculate(e=!1){return e||this._calculationTracker.recalcRequests>0}}var Bn,zn=s("7aVi");let Gn=Object(a.injectable)()(Bn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Bn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Bn=function(e,t){return a.ModuleContainer.inject(Zi.a)(e,void 0,2)}(Bn=Reflect.metadata("design:type",Function)(Bn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===Zi.a?Object:Zi.a])(Bn=class extends Un{constructor(e,t,s){super("ResConvDataManager",e),this.application=t,this.convDataSource=s,this.cancelDBScan=()=>{this.convDataSource.cancelDBScan(),this._recordCalcHistory({recalcRequests:1,lastTs:0})},this.cancelQuickScan=()=>{this.convDataSource.cancelQuickScan()},this.calculateConvDataSize=e=>e.reduce(((e,t)=>{const s=t.amount||null;let a=0;for(let i in s)a+=s[i]||0;return e+a}),0),this._listenEvents=()=>{this.convDataSource.addEventListener(Sn.ResCalc_ConvData_Status,this._handleCalculationStatus),this.convDataSource.addEventListener(Sn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this.convDataSource.addEventListener(Sn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this.convDataSource.addEventListener(Sn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this.convDataSource.addEventListener(Sn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this.convDataSource.addEventListener(Sn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this.convDataSource.addEventListener(Sn.ResCalc_Calculate,this._handleResCalculateStatus),this.application.addEventListener(m.b.Exit,this.onApplicationExit)},this.onApplicationExit=()=>{this.cancelDBScan(),this.cancelQuickScan(),this._cleanupListeners()},this._cleanupListeners=()=>{this.convDataSource.removeEventListener(Sn.ResCalc_ConvData_Status,this._handleCalculationStatus),this.convDataSource.removeEventListener(Sn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this.convDataSource.addEventListener(Sn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this.convDataSource.removeEventListener(Sn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this.convDataSource.removeEventListener(Sn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this.convDataSource.removeEventListener(Sn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this.convDataSource.removeEventListener(Sn.ResCalc_Calculate,this._handleResCalculateStatus),this.application.removeEventListener(m.b.Exit,this.onApplicationExit)},this._handleCalculationStatus=e=>{this.dispatchEvent(new gn(Sn.ResCalc_UI_Status_Change,e.payload))},this._handleManualFastCalculateStatus=e=>{this.dispatchEvent(new vn(Sn.ResCalc_Manual_Fast_Calculate,e.payload))},this._handleManualDetailCalculateStatus=e=>{this.dispatchEvent(new vn(Sn.ResCalc_Manual_Detail_Calculate,e.payload))},this._handleCalculateResourceWhenDeleteConvs=e=>{this.dispatchEvent(new _n(Sn.ResCalc_Delete_Convs,e.payload))},this._handleCalculateDeleteConvsStatus=e=>{this.dispatchEvent(new bn(Sn.ResCalc_Delete_Convs_Status,e.payload))},this._handleCalculateUpdateDetailPageCache=e=>{this.dispatchEvent(new In(Sn.ResCalc_Update_Detail_Page_Cache,e.payload))},this._handleResCalculateStatus=e=>{this.dispatchEvent(new yn(Sn.ResCalc_Calculate,e.payload)),a.ModuleContainer.resolve(zn.a).dispatchEvent(new yn(Sn.ResCalc_Calculate,e.payload))},this._listenEvents()}start(e=!1,t,s){return this.checkForceCalculate(e)||t?(this.logger.zsymb(5,"VyNC7S",["calculating: force:{} {}","_2PRBz"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((a,i)=>{this.convDataSource.start(e,t,s).then((e=>{a(e),this._recordCalcHistory()})).catch((e=>{i(e)}))}))):(s&&s(this.convDataSource.getConvData()),Promise.resolve(!0))}fastStart(e=!1,t,s){return this.checkForceCalculate(e)||t?(this.logger.zsymb(5,"6yxYI5",["calculating: force:{} {}","_2PRBz"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((a,i)=>{this.convDataSource.fastStart(e,t,s).then((e=>{a(e),this._recordCalcHistory()})).catch((e=>{i(e)}))}))):(s&&s(this.convDataSource.getConvData()),Promise.resolve(!0))}isOA(e){return Ii.default.isOA(e)}isMyCloud(e){return e===Ce.default.sendToMeId}isGroup(e){return String(e).startsWith(Y.GROUPID_PREFIX)}isHiddenConv(e){return un.a.isThreadHidden(e)}isOtherInOtherGroup(e){return this.isMyCloud(e)||this.isOA(e)}getConvs(){return this.convDataSource.getConvData().filter((e=>this.validateCalculateResult(e.amount)))}setForceConvData(e){this.convDataSource.setForceConvData(e)}getConvHiddenData(){return this.convDataSource.getConvHiddenData()}setForceConvHiddenData(e){this.convDataSource.setForceConvHiddenData(e)}setResCalculateStatus(e){this.convDataSource.setResCalculateStatus(e)}async onDelete(e,t){return this.convDataSource.onDelete(e,t)}onUpdateDataBeforeDelete(e,t){return this.convDataSource.onUpdateDataBeforeDelete(e,t)}status(){return this.convDataSource.status()}validateCalculateResult(e){return this.convDataSource.validateCalculateResult(e)}calculateConvDataSizeByIds(e,t){return this.convDataSource.getConvData().filter((t=>e.includes(t.convId))).reduce(((e,s)=>e+(null!=t&&t.video&&s.amount.videosSize?s.amount.videosSize:null!=t&&t.file&&s.amount.filesSize?s.amount.filesSize:null!=t&&t.photo&&s.amount.imagesSize?s.amount.imagesSize:0)),0)}setConvToHidden(e,t,s){this.convDataSource.setConvToHidden(e,t,s)}removeConvToList(e){this.convDataSource.removeConvToList(e)}})||Bn)||Bn)||Bn)||Bn)||Bn)||Bn;a.ModuleContainer.registerSingleton(Zi.a,Nn),a.ModuleContainer.registerSingleton(dn,Gn),a.ModuleContainer.registerSingleton(cn,jn);const xn=Object(a.define)("resmgmt-zarf-datasource");var Vn;let Hn=Object(a.injectable)()(Vn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Vn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Vn=function(e,t){return a.ModuleContainer.inject(xn)(e,void 0,2)}(Vn=Reflect.metadata("design:type",Function)(Vn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===xn?Object:xn])(Vn=class extends Un{constructor(e,t,s){super("ResZaRFDataManager",e),this.application=t,this.zarfDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.removeEventListener(Sn.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.zarfDataSource.addEventListener(Sn.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}start(e,t){return this.checkForceCalculate(e)?(this.logger.zsymb(5,"aQW-Ig",["calculating: force:{} {}","_2PRBz"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((e,s)=>{this.zarfDataSource.start(t).then((t=>{e(t),this._recordCalcHistory()})).catch((e=>{s(e)}))}))):(t&&t(this.zarfDataSource.getSize()),Promise.resolve(!0))}cancel(){this.zarfDataSource.cancel(),this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.IDLE,type:"convDataStatus",progress:1})}abort(){this.zarfDataSource.abort()}reset(){this._broadcastEvent(Sn.ResCalc_ConvData_Status,{status:Cn.l.CALCULATING,type:"zaRFStatus"})}_broadcastEvent(e,t){if(e===Sn.ResCalc_ZaRF_Status)this.dispatchEvent(new gn(Sn.ResCalc_UI_Status_Change,t))}})||Vn)||Vn)||Vn)||Vn)||Vn)||Vn;var Wn;function qn(){}let Kn=Object(a.injectable)()(Wn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(Wn=Reflect.metadata("design:type",Function)(Wn=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Wn=class extends hs.b{constructor(e){super(),this.application=e,this.resultCallback=void 0,this.onDataChange=void 0,this._Tasks=[],this._size=0,this._broadcastEvent=(e,t)=>{if(e===Sn.ResCalc_ZaRF_Status)this.dispatchEvent(new gn(Sn.ResCalc_ZaRF_Status,t))},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this.resultCallback=qn,this.onDataChange=qn,this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}async start(e){var t;return this.onDataChange=t=>{this._size=t,e&&e(t)},this.resultCallback=e=>{this._size=e,this.onDataChange(e),this._broadcastEvent(Sn.ResCalc_ZaRF_Status,{status:Cn.l.IDLE,type:"zaRFStatus"})},this._broadcastEvent(Sn.ResCalc_ZaRF_Status,{status:Cn.l.CALCULATING,type:"zaRFStatus"}),null===(t=this._Tasks)||void 0===t||t.push(Ki.a.getZaloReceivedFilesAmt(this.resultCallback,this.onDataChange)),!0}cancel(){this._cleanupEvents(),this.resultCallback=qn,this.onDataChange=qn,this._Tasks.length&&(Ki.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._broadcastEvent(Sn.ResCalc_ZaRF_Status,{status:Cn.l.IDLE,type:"zaRFStatus"})}abort(){this._cleanupEvents(),this.resultCallback=qn,this.onDataChange=qn,this._Tasks.length&&(Ki.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._broadcastEvent(Sn.ResCalc_ZaRF_Status,{status:null,type:"zaRFStatus"})}getSize(){return this._size}})||Wn)||Wn)||Wn)||Wn;const $n=Object(a.define)("resmgmt-zarf-datamanager");a.ModuleContainer.registerSingleton(xn,Kn),a.ModuleContainer.registerSingleton($n,Hn);const Zn=Object(a.define)("resmgmt-unlisted-datasource");var Qn;let Yn=Object(a.injectable)()(Qn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Qn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Qn=function(e,t){return a.ModuleContainer.inject(Zn)(e,void 0,2)}(Qn=Reflect.metadata("design:type",Function)(Qn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===Zn?Object:Zn])(Qn=class extends Un{constructor(e,t,s){super("ResUnlistedDataManager",e),this.application=t,this.resUnlistedDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.removeEventListener(Sn.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Sn.ResCalc_AppData_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Sn.ResCalc_OtherAccounts_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.addEventListener(Sn.ResCalc_OtherAccounts_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Sn.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Sn.ResCalc_AppData_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}onDeleteConvs(e){return this.resUnlistedDataSource.onDeleteConvs(e)}async calculateZaloAppData(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppData(e,t,s),!0}async calculateZaloDBSearch(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloDBSearch(e,t,s),!0}async calculateZaloAppDataLog(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppDataLog(e,t,s),!0}async calculateZaloLocal(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloLocal(e,t,s,a),0}async calculateOtherAccounts(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateOtherAccounts(e,t,s,a),!0}async calculatezTemp(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculatezTemp(e,t,s),!0}async calculateZaloTemp(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloTemp(e,t,s),!0}cancel(){this.resUnlistedDataSource.cancel(),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:Cn.l.IDLE,type:"zaloLocalStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:Cn.l.IDLE,type:"appDataStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:Cn.l.IDLE,type:"otherAccountsStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:Cn.l.IDLE,type:"zTempStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:Cn.l.IDLE,type:"zaloTempStatus"})}abort(){this.resUnlistedDataSource.abort(),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:null,type:"zaloLocalStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:null,type:"appDataStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:null,type:"otherAccountsStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:null,type:"zTempStatus"}),this._broadcastEvent(Sn.ResCalc_UI_Status_Change,{status:null,type:"zaloTempStatus"})}_broadcastEvent(e,t){switch(e){case Sn.ResCalc_ZaloLocal_Status:case Sn.ResCalc_OtherAccounts_Status:case Sn.ResCalc_AppData_Status:this.dispatchEvent(new gn(Sn.ResCalc_UI_Status_Change,t))}}})||Qn)||Qn)||Qn)||Qn)||Qn)||Qn;var Jn;let Xn,er;function tr(){}Xn=$znode.fastGlob,er=$znode.path;let sr=Object(a.injectable)()(Jn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(Jn=Reflect.metadata("design:type",Function)(Jn=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Jn=class extends hs.b{constructor(e){super(),this.application=e,this._Tasks=[],this._size=0,this._groupStatus=Cn.l.IDLE,this._ZaloAppData={calculated:!1,size:0,resCb:tr,changeCb:tr},this._ZaloLocal={calculated:!1,size:0,resCb:tr,changeCb:tr},this._ZaloOtherAccounts={calculated:!1,size:0,resCb:tr,changeCb:tr},this._zTemp={calculated:!1,size:0,resCb:tr,changeCb:tr},this._ZaloTemp={calculated:!1,size:0,resCb:tr,changeCb:tr},this._ZaloDBSearch={calculated:!1,size:0,resCb:tr,changeCb:tr},this._otherAccountPaths=[],this._broadcastEvent=(e,t)=>{switch(e){case Sn.ResCalc_AppData_Status:case Sn.ResCalc_OtherAccounts_Status:case Sn.ResCalc_ZaloLocal_Status:this.dispatchEvent(new gn(e,t))}},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}cancel(){this._cleanupEvents(),this._Tasks.length&&(Ki.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._ZaloAppData.changeCb=tr,this._ZaloAppData.resCb=tr,this._ZaloLocal.changeCb=tr,this._ZaloLocal.resCb=tr,this._ZaloOtherAccounts.changeCb=tr,this._ZaloOtherAccounts.resCb=tr,this._ZaloTemp.changeCb=tr,this._ZaloTemp.resCb=tr,this._zTemp.changeCb=tr,this._zTemp.resCb=tr,this._broadcastEvent(Sn.ResCalc_ZaRF_Status,{status:Cn.l.IDLE,type:"zaRFStatus"})}abort(){this._cleanupEvents(),this._Tasks.length&&(Ki.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._ZaloAppData.changeCb=tr,this._ZaloAppData.resCb=tr,this._ZaloLocal.changeCb=tr,this._ZaloLocal.resCb=tr,this._ZaloOtherAccounts.changeCb=tr,this._ZaloOtherAccounts.resCb=tr,this._ZaloTemp.changeCb=tr,this._ZaloTemp.resCb=tr,this._zTemp.changeCb=tr,this._zTemp.resCb=tr}getSize(){return this._ZaloAppData.size+this._ZaloLocal.size}getZaloAppDataSize(){return this._ZaloAppData.size}getZaloLocalSize(){return this._ZaloLocal.size}getZaloOtherAccountsSize(){return this._ZaloOtherAccounts.size}onDeleteConvs(e){return this._ZaloLocal.size-=e,this._ZaloLocal.changeCb&&this._ZaloLocal.changeCb(this._ZaloLocal.size),Promise.resolve()}async calculateOtherAccounts(e,t,s,a){if(this._ZaloOtherAccounts.calculated&&s&&!e)return s(this._ZaloOtherAccounts.size);const i=await Object(Ni.getZaloPCDir)(),n=(await Xn(Object(On.a)(er.join(i,"**")),{deep:1,onlyDirectories:!0})).map((e=>er.basename(e))),r=J.p.getSessionUserId();wn.push(r);const o=n.filter((e=>!wn.includes(e)));if(this._otherAccountPaths.length){if(!this._otherAccountPaths.filter((e=>!o.includes(e))).length&&!t&&s)return s(this._ZaloOtherAccounts.size)}else this._otherAccountPaths=[...o];if(this._ZaloOtherAccounts.calculated&&!e)return void(s?s(this._ZaloOtherAccounts.size):a&&a(this._ZaloOtherAccounts.size));t&&(this._ZaloOtherAccounts.size=0);const l=e=>{this._ZaloOtherAccounts.size=e,s&&s(e)},c=e=>{this._ZaloOtherAccounts.size=e,this._ZaloOtherAccounts.calculated=!0,s&&s(this._ZaloOtherAccounts.size),this._broadcastEvent(Sn.ResCalc_OtherAccounts_Status,{status:Cn.l.IDLE,type:"otherAccountsStatus"})};if(this._ZaloOtherAccounts.resCb=c,this._ZaloOtherAccounts.changeCb=l,this._broadcastEvent(Sn.ResCalc_OtherAccounts_Status,{status:Cn.l.CALCULATING,type:"otherAccountsStatus"}),o&&0!==o.length){if(o.length>0){var d;null===(d=this._Tasks)||void 0===d||d.push(Ki.a.getOtherAccountUsage(o,c,l))}}else this._ZaloOtherAccounts.size=0,s&&s(0),this._broadcastEvent(Sn.ResCalc_OtherAccounts_Status,{status:Cn.l.IDLE,type:"otherAccountsStatus"}),this._ZaloOtherAccounts.calculated=!0}async calculatezTemp(e,t,s){var a;if(this._zTemp.calculated&&!e)return void(t?t(this._zTemp.size):s&&s(this._zTemp.size));const i=e=>{this._zTemp.size=e,t&&t(e)},n=e=>{this._zTemp.size=e,this._zTemp.calculated=!0,t&&t(e),this._broadcastEvent(Sn.ResCalc_zTemp_Status,{status:Cn.l.IDLE,type:"zTempStatus"})};this._zTemp.resCb=n,this._zTemp.changeCb=i,this._broadcastEvent(Sn.ResCalc_zTemp_Status,{status:Cn.l.CALCULATING,type:"zTempStatus"}),null===(a=this._Tasks)||void 0===a||a.push(Ki.a.getzTempAmount(n,i))}async calculateZaloTemp(e,t,s){var a;if(this._ZaloTemp.calculated&&!e)return void(t?t(this._ZaloTemp.size):s&&s(this._ZaloTemp.size));const i=e=>{this._ZaloTemp.size=e,t&&t(e)},n=e=>{this._ZaloTemp.size=e,this._ZaloTemp.calculated=!0,t&&t(e),this._broadcastEvent(Sn.ResCalc_ZaloTemp_Status,{status:Cn.l.IDLE,type:"zaloTempStatus"})};this._ZaloTemp.resCb=n,this._ZaloTemp.changeCb=i,this._broadcastEvent(Sn.ResCalc_ZaloTemp_Status,{status:Cn.l.CALCULATING,type:"zaloTempStatus"}),null===(a=this._Tasks)||void 0===a||a.push(Ki.a.getZaloTempAmount(n,i))}calculateZaloAppData(e,t,s){var a;if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const i=e=>{this._ZaloAppData.size=e,t&&t(e)},n=e=>{this._ZaloAppData.size=e,this._ZaloAppData.calculated=!0,t&&t(e),this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.IDLE,type:"appDataStatus"})};this._ZaloAppData.resCb=n,this._ZaloAppData.changeCb=i,this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.CALCULATING,type:"appDataStatus"}),null===(a=this._Tasks)||void 0===a||a.push(Ki.a.getZaloDBAmount(n,i,!1))}calculateZaloDBSearch(e,t,s){var a;if(this._ZaloDBSearch.calculated&&!e)return void(t?t(this._ZaloDBSearch.size):s&&s(this._ZaloDBSearch.size));const i=e=>{this._ZaloDBSearch.size=e,t&&t(e)},n=e=>{this._ZaloDBSearch.size=e,this._ZaloDBSearch.calculated=!0,t&&t(e),this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.IDLE,type:"zaloDBSearchStatus"})};this._ZaloDBSearch.resCb=n,this._ZaloDBSearch.changeCb=i,this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.CALCULATING,type:"zaloDBSearchStatus"}),null===(a=this._Tasks)||void 0===a||a.push(Ki.a.getZaloDBSearchAmount(n,i,!1))}calculateZaloAppDataLog(e,t,s){if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const a=e=>{this._ZaloAppData.size=e,this._ZaloAppData.calculated=!0,t&&t(e),this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.IDLE,type:"appDataStatus"})};this._ZaloAppData.resCb=a,this._ZaloAppData.changeCb=e=>{this._ZaloAppData.size=e,t&&t(e)},this._broadcastEvent(Sn.ResCalc_AppData_Status,{status:Cn.l.CALCULATING,type:"appDataStatus"});let i=Object(Ni.getDbPath)();(async()=>{const e=await Tn.b.execRaw("getDirSizeNoCaching",[i]);a(e)})()}calculateZaloLocal(e,t,s,a){return new Promise(((i,n)=>{var r;if(this._ZaloLocal.calculated&&!e&&!t)return s?s(this._ZaloLocal.size):a&&a(this._ZaloLocal.size),i(this._ZaloLocal.size);const o=e=>{this._ZaloLocal.size=e,s&&s(e)},l=e=>{this._ZaloLocal.size=e,this._ZaloLocal.calculated=!0,s&&s(e),this._broadcastEvent(Sn.ResCalc_ZaloLocal_Status,{status:Cn.l.IDLE,type:"zaloLocalStatus"})};this._ZaloLocal.resCb=l,this._ZaloLocal.changeCb=o,this._broadcastEvent(Sn.ResCalc_ZaloLocal_Status,{status:Cn.l.CALCULATING,type:"zaloLocalStatus"}),null===(r=this._Tasks)||void 0===r||r.push(Ki.a.getZaloDataAmount(l,o,!1))}))}})||Jn)||Jn)||Jn)||Jn;const ar=Object(a.define)("resmgmt-unlisted-datamanager");a.ModuleContainer.registerSingleton(Zn,sr),a.ModuleContainer.registerSingleton(ar,Yn);var ir,nr=s("q1tI"),rr=s.n(nr),or=s("B8k8"),lr=s("lCMA"),cr=s("v/qp"),dr=s("DOOx"),ur=s("kibv"),hr=s("3xbP"),gr=s("7TIh"),mr=s("Ic+i"),pr=s("Iawr");const{RICH_SPACE:fr,ALMOST_FULL_1:vr,ALMOST_FULL_2:_r,FULL:br}=Cn.e,Ir=1073741824,yr=[vr,br],Sr=[_r,br],Cr=[_r,br];Object(a.injectable)()(ir=Object(m.j)()(ir=Object(Ai.b)(zn.a)(ir=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(ir=Reflect.metadata("design:type",Function)(ir=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(ir=class extends hs.b{constructor(e){super(),this.application=e,this._displayingNotiModal=void 0,this._displayingNotiBanner=void 0,this._displayingNotiPopup=void 0,this.didLog_2230101=void 0,this._Logger=void 0,this._total=0,this.openSetttings=e=>{const t=this._getLastNoti();if(e===Cn.g.POPUP_MODAL||e===Cn.g.FULL_DISK_BANNER){let s=Ct.default.getTimeNow();e===Cn.g.FULL_DISK_BANNER&&null!=t&&t.ts&&(s=t.ts),we.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},t),{},{dismiss:!0,ts:s}))}this._closeNotiType("modal");const s={data:{tab:gr.h.RES_MANAGEMENT}};Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.SETTINGS,params:s,forceCloseAll:!0})},this.dismissNoti=e=>{if(!e)return this._closeNotiType("all");this._closeNotiType(e===Cn.g.POPUP_MODAL?"modal":"banner",!0)},this._osEventHandler=e=>{if(e)switch(e.type){case dr.b.OUT_OF_MEM:{this._broadcastEvent(Sn.ResDisk_Status,{level:br});const e=this._getLastNoti(),t=this._getLastBannerNoti(),s=this._getLastPopupNoti();this._handleDiskStatusModal(br,e),this._handleDiskStatusBanner(br,t),this._handleDiskStatusPopup(br,s),this._handleActionLogChangeStorageZone(br,t);break}case dr.b.OPEN_SUCCESS:{const e=this._getLastNoti(),t=this._getLastBannerNoti();this._handleDiskStatusModal(fr,e),this._handleDiskStatusBanner(fr,t);break}}},this._handleDiskStatus=e=>{if(!Ce.default.full_disk_check.enable)return;const{total:t,free:s}=e,a=this._getFullStatus(t,s);a===br&&this._broadcastEvent(Sn.ResDisk_Full_Disk_Status,{level:a}),a===fr||Ce.default.full_disk_check.enable&&Ce.default.full_disk_check.showWarning||this.didLog_2230101||(this.Logger.zsymb(3,"CsJ3GM",["Noti modal: noti={} | enable={} | showWarning={}","W8qb48"],a,Ce.default.full_disk_check.enable,Ce.default.full_disk_check.showWarning),this.didLog_2230101=!0,Ia.default.logAction(2230101)),this._broadcastEvent(Sn.ResDisk_CurrentLevel,{level:a});const i=this._getLastNoti(),n=this._getLastBannerNoti(),r=this._getLastPopupNoti();this._handleDiskStatusModal(a,i),this._handleDiskStatusBanner(a,n),this._handleDiskStatusPopup(a,r),this._handleActionLogChangeStorageZone(a,n),ur.a.start()},this._handleDiskStatusModal=(e,t)=>{var s,a,i,n;if(!Ce.default.full_disk_check.enable||e===vr&&0==(null===(s=Ce.default.full_disk_check)||void 0===s||null===(a=s.level_control)||void 0===a?void 0:a.af1)||e===br&&!1===(null===(i=Ce.default.full_disk_check)||void 0===i||null===(n=i.level_control)||void 0===n?void 0:n.full_modal))return;this._displayingNotiModal&&(!yr.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"nHTumy",["Noti modal closed lastNoti={} prep for currentNoti={}","52XmUo"],t,e),this._closeNotiType("modal"));const r=Ct.default.getTimeNow(),o=this._getLastNoti();if(!yr.includes(e))return void(Cn.d[e]<Cn.d[t.level]&&(o.level=e===fr?vr:e,o.ts=r,we.default.setFullDiskNoti(o)));const l=Ct.default.getTimeNow()-t.ts;if(this.Logger.zsymb(3,"VfFTeT",["fdn elapsed: {} | lastNoti={} | newNoti={}","T2NVoi"],l,t.level,e),!1===this._displayingNotiModal&&e===br)return t.dismiss&&l<=Ce.default.full_disk_check.modal_noti_gap&&t.level===br?void this.Logger.zsymb(3,"neN-su",["Noti modal full dismissed and less than 7d seconds","IUIbuW"]):(this.Logger.zsymb(3,"z8Myzz",["Noti modal full (always show)","wFt4Ot"]),void this._triggerDiskStatus(e,"modal",!1));if(t&&t.level===e){if(this._displayingNotiModal||!this._displayingNotiModal&&t.dismiss&&Math.abs(r-t.ts)<Ce.default.full_disk_check.modal_noti_gap)return void(this._displayingNotiModal?this.Logger.zsymb(3,"tobf2v",["Noti modal dismissed as type unchanged. already ON","M29ew_"]):this.Logger.zsymb(3,"-F__xB",["Noti modal dismissed as type unchanged. applying 7d-rule={}","XlyP5J"],!0));this.Logger.zsymb(3,"9iIaUa",["Noti modal passed. 7d-rule reset. dismiss reset","PoRDS7"])}else if(t&&t.level&&e&&Cn.d[e]<Cn.d[t.level]){if(o.dismiss&&Math.abs(r-t.ts)<Ce.default.full_disk_check.type_change_noti_gap)return this.Logger.zsymb(3,"pkrYuN",["Noti modal dismissed: downgrading emergency => 1d-rule={}","p_5-pp"],!0),o.level=e===fr?vr:e,o.ts=r,void we.default.setFullDiskNoti(o);this.Logger.zsymb(3,"IjWaK2",["Noti modal: downgrading emergency => 1d-rule expired","bKDd8D"])}this._triggerDiskStatus(e,"modal",!0)},this._handleDiskStatusBanner=(e,t)=>{if(!Ce.default.full_disk_check.enable||e===br&&!1===en.a.block_usage.full_enable_banner||e===_r&&!1===en.a.block_usage.af2_enable_banner)return;this._displayingNotiBanner&&(!Sr.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"xFe0Ew",["Noti banner closed lastNoti={} prep for currentNoti={}","ftHSKN"],t,e),this._closeNotiType("banner"));const s=Ct.default.getTimeNow(),a=this._getLastBannerNoti();if(e===_r){const e=n.default.getInstance(),t=e.getItemForCurrentUser(mr.f),s=e.getItemForCurrentUser(mr.h),a=e.getItemForCurrentUser(mr.g);if(t){const s=J.p.getSessionUserId();Me.g.setEnableAutoDownload(s,t),e.removeItemForCurrentUser(mr.f)}if(s&&(Me.g.setSettingNotifyCall(s),e.removeItemForCurrentUser(mr.h)),a){const t="string"==typeof a&&["0","1"].includes(a)?+a:0,s=J.p.getSessionUserId();pr.a.setEnabled(s,t),e.removeItemForCurrentUser(mr.g)}}if(!Sr.includes(e))return void(Cn.d[e]<Cn.d[t.level]&&(a.level=e,a.ts=s,we.default.setFullDiskChatBannerNoti(a)));if(!1===this._displayingNotiBanner&&e==br)return this.Logger.zsymb(3,"bC89gt",["Noti banner full (always)","8XL7q8"]),void this._triggerDiskStatus(e,"banner");if(t&&t.level===e){if(this._displayingNotiBanner||!this._displayingNotiBanner&&t.dismiss&&Math.abs(s-t.ts)<Ce.default.full_disk_check.af2_banner_time_reshow_when_closed_ms)return void(this._displayingNotiBanner?this.Logger.zsymb(3,"E8HDwC",["Noti banner dismissed as level unchanged. already ON","CFitK3"]):this.Logger.zsymb(3,"9rMODz",["Noti banner dismissed as level unchanged. applying 1d-rule={}","3ZfIhY"],!0));this.Logger.zsymb(3,"kz-yU4",["Noti banner passed. 1d-rule reset. dismiss reset","LDd1W2"])}if(t&&t.level&&e&&t.dismiss&&Cn.d[e]<Cn.d[t.level]){if(a.dismiss&&Math.abs(s-t.ts)<Ce.default.full_disk_check.af2_banner_time_reshow_when_closed_ms)return this.Logger.zsymb(3,"a55owK",["Noti banner dismissed as downgrading emergency. applying 1d-rule={}","4zpBcv"],!0),a.ts=s,a.level=e,void we.default.setFullDiskChatBannerNoti(a);if(this._displayingNotiBanner)return void this.Logger.zsymb(3,"vno-Qc",["Noti banner: downgrading emergency. 1d-rule expired but already ON","4OKnvX"]);this.Logger.zsymb(3,"O5LWu3",["Noti banner: downgrading emergency. 1d-rule expired. showing soon","_uOQan"])}const i=n.default.getInstance(),r=i.getItemForCurrentUser(mr.d);e===_r&&0===en.a.block_usage.af2_banner_time_reshow_when_closed_ms&&r||(r&&i.removeItemForCurrentUser(mr.d),this._triggerDiskStatus(e,"banner",!0))},this._handleDiskStatusPopup=(e,t)=>{var s,a;const i=()=>{const e=K.default.getAllCurrentOpens();if(e.length>0){const t=e.filter((e=>e!=hr.c));t.length>0&&t.forEach((e=>{Ie.ModalManagerV2.closeModal({windowId:e,name:Y.ModalIdentitiesDefine.BLANK_BACKGROUND_FULL_DISK})}))}};if(!Ce.default.full_disk_check.enable)return void i();if(this._displayingNotiPopup&&(!Cr.includes(e)||t&&t.level!==e)){this.Logger.zsymb(3,"2pdL6Y",["Noti popup closed lastNoti={} prep for currentNoti={}","Q74sHI"],t,e),this._closeNotiType("popup");const s=mr.a[t.level];Ie.ModalManagerV2.closeModal({windowId:hr.c,name:s})}if(e===br&&!1===(null===(s=en.a.block_usage)||void 0===s?void 0:s.full_enable_popup_and_block_app)||e===_r&&!1===en.a.block_usage.af2_enable_popup)return void i();const r=Ct.default.getTimeNow(),o=this._getLastPopupNoti();if(o.level!==e&&o.level==br&&i(),!Cr.includes(e)){if(o.level!==e&&[_r,br].includes(o.level)){const e=mr.a[o.level];Ie.ModalManagerV2.closeModal({windowId:hr.c,name:e})}Cn.d[e]<Cn.d[t.level]&&(o.level=e,o.ts=r,we.default.setFullDiskChatPopupNoti(o));const s=n.default.getInstance(),a=s.getItemForCurrentUser(mr.f),i=s.getItemForCurrentUser(mr.h),l=s.getItemForCurrentUser(mr.g);if(a){const e=J.p.getSessionUserId();Me.g.setEnableAutoDownload(e,a),s.removeItemForCurrentUser(mr.f)}if(i&&(Me.g.setSettingNotifyCall(i),s.removeItemForCurrentUser(mr.h)),l){const e="string"==typeof l&&["0","1"].includes(l)?+l:0,t=J.p.getSessionUserId();pr.a.setEnabled(t,e),s.removeItemForCurrentUser(mr.g)}return}if(e===br&&e!==t.level){const t={ts:r,level:e,dismiss:!1};n.default.getInstance().setItemForCurrentUser(mr.b,JSON.stringify(t))}if(!1===this._displayingNotiPopup&&e==br)return this.Logger.zsymb(3,"Wru_Ty",["Noti popup full (always)","6zKxQ0"]),void this._triggerDiskStatus(e,"popup");const l=n.default.getInstance(),c=l.getItemForCurrentUser(mr.e);if(t&&t.level===e&&"0"==c){var d;if(this._displayingNotiPopup||!this._displayingNotiPopup&&t.dismiss&&t.tsForceClose&&Math.abs(r-t.tsForceClose)<(null===(d=en.a.block_usage)||void 0===d?void 0:d.af2_popup_time_reshow_when_closed_ms))return void(this._displayingNotiPopup?this.Logger.zsymb(3,"iDItpi",["Noti popup dismissed as level unchanged. already ON","yHkTFQ"]):this.Logger.zsymb(3,"nmQlza",["Noti popup dismissed as level unchanged. applying 7d-rule={}","hCKzHW"],!0));this.Logger.zsymb(3,"SG88Ka",["Noti popup passed. 7d-rule reset. dismiss reset","4vpBJ-"])}if(e&&e===_r&&o.level!==e&&o.level===br&&null!=o&&o.ts&&Math.abs(r-o.ts)<en.a.block_usage.popup_type_change_noti_gap){this.Logger.zsymb(3,"hkpfg0",["Noti popup upgrading. applying 1d-rule={}","WqDLZw"],!0);const t=mr.a[o.level];return Ie.ModalManagerV2.closeModal({windowId:hr.c,name:t}),o.ts=r,o.level=e,o.dismiss=!0,we.default.setFullDiskChatPopupNoti(o),void(this._displayingNotiPopup=!1)}if(e&&e!==br){const t=n.default.getInstance().getItemForCurrentUser(mr.b),s=t?JSON.parse(t):null;if(s&&(null==s?void 0:s.level)===br&&Cn.d[e]<Cn.d[null==s?void 0:s.level]&&Math.abs(r-s.ts)<en.a.block_usage.popup_type_change_noti_gap){this.Logger.zsymb(3,"gUuC2H",["Noti popup downgrading. applying 1d-rule={}","fr4t9F"],!0);const t=mr.a[s.level];return Ie.ModalManagerV2.closeModal({windowId:hr.c,name:t}),o.ts=r,o.level=e,o.dismiss=!0,we.default.setFullDiskChatPopupNoti(o),void(this._displayingNotiPopup=!1)}}if(t&&t.level&&e&&t.dismiss&&Cn.d[e]<Cn.d[t.level]){if(o.level===_r&&o.dismiss&&o.tsForceClose&&Math.abs(r-t.tsForceClose)<en.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==c)return this.Logger.zsymb(3,"sdVEpN",["Noti popup dismissed as downgrading emergency. applying 7d-rule={}","TZ1d1h"],!0),o.ts=r,o.level=e,void we.default.setFullDiskChatPopupNoti(o);if(this._displayingNotiPopup)return void this.Logger.zsymb(3,"x-zJvd",["Noti popup: downgrading emergency. 7d-rule expired but already ON","CYF957"]);this.Logger.zsymb(3,"-XxHcJ",["Noti popup: downgrading emergency. 7d-rule expired. showing soon","2OlojB"])}e===_r&&0===en.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==c||e===_r&&en.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==c&&t.tsForceClose&&Math.abs(r-t.tsForceClose)<(null===(a=en.a.block_usage)||void 0===a?void 0:a.af2_popup_time_reshow_when_closed_ms)||("1"==c&&l.removeItemForCurrentUser(mr.e),this._triggerDiskStatus(e,"popup",!0))},this._handleActionLogChangeStorageZone=(e,t)=>{if(null!=t&&t.level&&e!==t.level){a.ModuleContainer.resolve(Bi.a).changeStorageZone({currentStorageZone:e,previousStorageZone:t.level,tsInPreviousStorageZone:t.ts})}},this._dismissModal=()=>{this._closeNotiType("modal",!0)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._displayingNotiModal=!1,this._displayingNotiBanner=!1,this._displayingNotiPopup=!1,this.didLog_2230101=!1,this.Logger.zsymb(5,"jXufpt",["DiskStatusManager init","7jXAiM"]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("disk-status",["status-manager"])),this._Logger}onStart(e){J.p.listenEvent(J.d,this._handleDiskStatus),Object(Ki.f)(),J.p.listenEvent(J.o,this._osEventHandler),this._listenEvents(),a.ModuleContainer.resolve(Bi.a).startDiskStatusAutoReport(),a.ModuleContainer.resolve(Bi.a).startAutoReport()}dismissPopupNoti(e,t){if(!e)return this._closeNotiType("all");this._closeNotiType("popup",!0,t)}_getFullStatus(e,t){let s=fr;if(e<Ce.default.full_disk_check.threadhold*Ir){const a=en.a.getOverrideCapacityStatus(),i=t/e;s=this._pickNormalizedStatus(i,a.dismiss_high,a.dismiss_low,a.dismiss_low_two)}else{const e=en.a.getOverrideCapacityStatus(),a=t/Ir,i=a>1?Math.round(10*a)/10*Ir:t;s=this._pickNormalizedStatus(i,e.dismiss_high*Ir,e.dismiss_low*Ir,(e.dismiss_low_two||1)*Ir)}return s}_showNotiType(e,t,s){if("modal"===e){this._displayingNotiModal&&this._closeNotiType("modal"),this._displayingNotiModal=!0;const a=this._getLastNoti();we.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},a),{},{dismiss:!(s||!a.dismiss)&&a.dismiss,level:t,ts:Ct.default.getTimeNow()}));const i=()=>{t===vr?Ia.default.logAction(2230707):t===br&&Ia.default.logAction(2230712),this.openSetttings(Cn.g.POPUP_MODAL)},n=()=>{t===vr?Ia.default.logAction(2230704):t===br&&Ia.default.logAction(2230711),this._dismissModal()};let r;switch(t){case fr:return void or.b.closeByKey("full-disk-noti-modal");case vr:Ia.default.logAction(2230102),r="STR_RESMGMT_MODAL_ALMOST_FULL";break;case _r:return void or.b.closeByKey("full-disk-noti-modal");case br:Ia.default.logAction(2230710),r="STR_RESMGMT_MODAL_FULL"}this.Logger.zsymb(5,"jLVidl",["Noti {} triggered","ik22uT"],e,{level:Cn.e[t],type:e},new Error);const o={type:Y.MINI_NOTIFICATION_TYPE.SUCCESS,duration:-1,key:"full-disk-noti-modal",html:rr.a.createElement("div",{className:"flx flx-col"},rr.a.createElement("div",{className:"flx flx-1 disk-waring-content"},rr.a.createElement("div",{className:"fa fa-warning-24 disk-waring-icon"}),rr.a.createElement("span",null,rr.a.createElement(lr.a,{textKey:r})," "),rr.a.createElement("span",null)),rr.a.createElement("div",{className:"flx flx-1 flx-e"},rr.a.createElement(cr.a,{type:"neutral",onClick:n,size:"medium",style:{marginRight:"8px"}},rr.a.createElement(lr.a,{textKey:"STR_FILE_INTRO_POP_BTN_SKIP"})),rr.a.createElement(cr.a,{type:"primary",onClick:i,size:"medium"},rr.a.createElement(lr.a,{textKey:"STR_MANAGE"}))))};or.b.show(o)}else if("banner"!==e||t!==_r&&t!==br){if("popup"===e&&(t===_r||t===br)){this.Logger.zsymb(5,"ijJYUg",["Noti {} triggered","ik22uT"],e,{level:Cn.e[t],type:e},new Error),this._displayingNotiPopup=!0;const a=this._getLastPopupNoti();if(a.level!==t&&[_r,br].includes(a.level)){a.level===_r&&(a.tsForceClose=Ct.default.getTimeNow());const e=mr.a[a.level];Ie.ModalManagerV2.closeModal({windowId:hr.c,name:e})}if(a.level!==t&&a.level===br){const e=n.default.getInstance(),t=e.getItemForCurrentUser(mr.f),s=e.getItemForCurrentUser(mr.h),a=e.getItemForCurrentUser(mr.g);if(t){const s=J.p.getSessionUserId();Me.g.setEnableAutoDownload(s,t),e.removeItemForCurrentUser(mr.f)}if(s&&(Me.g.setSettingNotifyCall(s),e.removeItemForCurrentUser(mr.h)),a){const t="string"==typeof a&&["0","1"].includes(a)?+a:0,s=J.p.getSessionUserId();pr.a.setEnabled(s,t),e.removeItemForCurrentUser(mr.g)}}switch(a.dismiss=!(s||!a.dismiss)&&a.dismiss,a.level=t,a.ts=Ct.default.getTimeNow(),we.default.setFullDiskChatPopupNoti(a),t){case _r:Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.BLOCK_USAGE_ALMOST_FULL_DISK_MODAL,params:{isBlockUsageAlmostFullDiskModal:!0}});break;case br:{const e=J.p.getSessionUserId(),t=Me.g.getEnableAutoDownload(e),s=Me.g.getSettingNotifyCall(),a=pr.a.isEnabled(),i=n.default.getInstance();Boolean(i.getItemForCurrentUser(mr.f))||i.setItemForCurrentUser(mr.f,t),Boolean(i.getItemForCurrentUser(mr.h))||i.setItemForCurrentUser(mr.h,s),Boolean(i.getItemForCurrentUser(mr.g))||i.setItemForCurrentUser(mr.g,a?"1":"0"),Me.g.setEnableAutoDownload(e,!1),Me.g.setSettingNotifyCall(!1),pr.a.setEnabled(e,0);const r=()=>{const e=K.default.getAllCurrentOpens();if(e.length>0){const t=e.filter((e=>e!=hr.c));t.length>0&&t.forEach((e=>{Ie.ModalManagerV2.openModal({windowId:e,name:Y.ModalIdentitiesDefine.BLANK_BACKGROUND_FULL_DISK,params:{blankBackgroundFullDisk:!0}})}))}Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.BLOCK_USAGE_FULL_DISK_MODAL,params:{isBlockUsageFullDiskModal:!0}})},o=sessionStorage.getItem(mr.c);if(o&&Boolean(+o)){let e=setTimeout((()=>{const t=sessionStorage.getItem(mr.c);t&&Boolean(+t)?this._displayingNotiPopup=!1:(this._displayingNotiPopup=!0,r()),clearTimeout(e),e=null}),en.a.block_usage.full_time_without_input_to_block_app_ms)}else r();break}}}}else{this.Logger.zsymb(5,"dC2AJQ",["Noti {} triggered","ik22uT"],e,{level:Cn.e[t],type:e},new Error),this._broadcastEvent(Sn.ResDisk_Status,{level:t}),this._displayingNotiBanner=!0;const a=this._getLastBannerNoti();a.dismiss=!(s||!a.dismiss)&&a.dismiss,a.level=t,a.ts=Ct.default.getTimeNow(),we.default.setFullDiskChatBannerNoti(a)}if([_r,br].includes(t)){const e=this._getLastBannerNoti();null!=e&&e.dismiss&&this._showNotiType("banner",t,!0)}}_pickNormalizedStatus(e,t,s,a){return e>t?fr:e>=s?vr:e>=a?_r:br}_getLastNoti(){return we.default.getFullDiskNoti()||{}}_closeNotiType(e="all",t=!1,s=!1){if(this.Logger.zsymb(5,"AZswjp",["Noti {} closed","45BmGy"],e),"all"!==e&&"modal"!==e||!this._displayingNotiModal)if("banner"!==e&&"all"!==e||!this._displayingNotiBanner){if(("popup"===e||"all"===e)&&this._displayingNotiPopup){const e=this._getLastPopupNoti();if(this._displayingNotiPopup){const a=Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:Ct.default.getTimeNow()});s&&e.level===_r&&(a.tsForceClose=Ct.default.getTimeNow()),we.default.setFullDiskChatPopupNoti(a)}this._displayingNotiPopup=!1}}else{const e=this._getLastBannerNoti();this._displayingNotiBanner&&we.default.setFullDiskChatBannerNoti(Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:Ct.default.getTimeNow()})),this._displayingNotiBanner=!1,this._broadcastEvent(Sn.ResNoti_Dimiss)}else{const e=this._getLastNoti(),s=Ct.default.getTimeNow();this.Logger.zsymb(5,"7-2Hw1",["fdn close modal at: {}","ninPzK"],new Date(s).toString()),this._displayingNotiModal&&we.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:s})),or.b.closeByKey("full-disk-noti-modal"),this._displayingNotiModal=!1}ur.a.pause()}_getLastBannerNoti(){return we.default.getFullDiskChatBannerNoti()||{}}_getLastPopupNoti(){return we.default.getFullDiskChatPopupNoti()||{}}_triggerDiskStatus(e=br,t="none",s=!1){if("none"!==t)if("banner"===t)this._showNotiType("banner",e,s);else if("modal"===t)switch(e){case fr:this._closeNotiType("modal"),this._closeNotiType("banner");break;case br:Ia.default.logActionInfo(Ia.FeaturesInfo.ResourceManagement,2,[this._total,0]),this._showNotiType("modal",e,s),this._showNotiType("banner",e,s);break;case vr:this._showNotiType("modal",e,s)}else if("popup"===t)switch(e){case br:case _r:this._showNotiType("popup",e,s)}}_broadcastEvent(e,t){switch(e){case Sn.ResDisk_Status:this.dispatchEvent(new pn(e,t));break;case Sn.ResNoti_Dimiss:this.dispatchEvent(new fn(e));break;case Sn.ResDisk_CurrentLevel:case Sn.ResDisk_Full_Disk_Status:this.dispatchEvent(new pn(e,t))}}})||ir)||ir)||ir)||ir)||ir);var Er,Or=s("ZEj3"),Mr=s("MGLS");Object(m.f)()(Er=Object(Ai.b)(Mr.b)(Er=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Er=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Er=Reflect.metadata("design:type",Function)(Er=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a])(Er=class extends Or.a{constructor(e,t){super(Mr.a,"noti"),this.loggerFactory=e,this.application=t,this.logger=void 0,this.dismissReddot=()=>{const e=n.default.getInstance();this.shouldShowReddot()&&setTimeout((()=>{this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot"),e.setItemForCurrentUser(Qi.c,JSON.stringify({dismiss:!0}))}),500)},this.shouldShowReddot=()=>{var e;const t=null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon;if(!(t&&t!==Cn.e.RICH_SPACE))return!1;const s=n.default.getInstance().getItemForCurrentUser(Qi.c);if(!s)return!0;try{const e=JSON.parse(s);return!e||!e.dismiss}catch(a){return!0}},this.getWarningStatus=()=>{var e;return null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon},this.checkShowReddot=()=>{this.Logger.zsymb(5,"JQrRsy",["init","1H8eN4"]);this.shouldShowReddot()?this.updateItem((e=>{e.dismissReddot=!1}),"dismissReddot"):this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot")},this._cleanupEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.removeEventListener(m.b.Exit,this._cleanupEvents),me.a.DiskStatusManager.removeEventListener(Sn.ResDisk_Status,this._onDiskStatusChanged),me.a.DiskStatusManager.removeEventListener(Sn.ResNoti_Dimiss,this._onNotiDismiss))},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.addEventListener(m.b.Exit,this._cleanupEvents),me.a.DiskStatusManager.addEventListener(Sn.ResDisk_Status,this._onDiskStatusChanged),me.a.DiskStatusManager.addEventListener(Sn.ResNoti_Dimiss,this._onNotiDismiss),me.a.DiskStatusManager.addEventListener(Sn.ResDisk_CurrentLevel,this._onCurrentLevelChanged))},this._onCurrentLevelChanged=e=>{var t;(null==e||null===(t=e.payload)||void 0===t?void 0:t.level)!==Cn.e.RICH_SPACE?this.updateItem((t=>{var s;t.showOverviewWarningIcon=null==e||null===(s=e.payload)||void 0===s?void 0:s.level}),"showOverviewWarningIcon"):this.updateItem((e=>{e.showOverviewWarningIcon=Cn.e.RICH_SPACE}),"showOverviewWarningIcon"),this.checkShowReddot()},this._onNotiDismiss=()=>{this.updateItem((e=>{e.showFullDiskBanner={show:!1}}),"showFullDiskBanner")},this._onDiskStatusChanged=e=>{this.updateItem((t=>{const s=e.payload,a=(null==s?void 0:s.level)===Cn.e.ALMOST_FULL_2||(null==s?void 0:s.level)===Cn.e.FULL;t.showFullDiskBanner={show:a,level:null==s?void 0:s.level}}),"showFullDiskBanner")},this.logger=this.loggerFactory.createZLogger("resmgmt",[Mr.a]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this.logger||(this.logger=this.loggerFactory.createZLogger("resmgmt",[Mr.a])),this.logger}onAuthenticated(e){this._listenEvents(),this.checkShowReddot()}dismissNoti(e){this.logger.zsymb(5,"8cMYrL",["Noti {} closed","45BmGy"],e),me.a.DiskStatusManager.dismissNoti(e),ur.a.pause()}dismissPopupNoti(e,t=!1){me.a.DiskStatusManager.dismissPopupNoti(e,t),ur.a.pause()}openSettings(e){me.a.DiskStatusManager.openSetttings(e)}})||Er)||Er)||Er)||Er)||Er);var Tr=s("FB77"),wr=s("B5Cg");function Rr(e,t){try{e()}catch(s){"function"==typeof t&&t(s)}}var Lr,Dr=s("d+hT"),Ar=s("OfK0"),Fr=s("+28p");const kr=$znode.os,Nr="migrate-drive-status-key",Pr=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.resMntScanResource,["res-controller"]);Object(a.injectable)()(Lr=Object(m.d)()(Lr=Object(Ai.b)($i.b)(Lr=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Lr=function(e,t){return a.ModuleContainer.inject(dn)(e,void 0,1)}(Lr=function(e,t){return a.ModuleContainer.inject($n)(e,void 0,2)}(Lr=function(e,t){return a.ModuleContainer.inject(ar)(e,void 0,3)}(Lr=function(e,t){return a.ModuleContainer.inject(cn)(e,void 0,4)}(Lr=Reflect.metadata("design:type",Function)(Lr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===dn?Object:dn,void 0===$n?Object:$n,void 0===ar?Object:ar,void 0===cn?Object:cn])(Lr=class extends Or.a{constructor(e,t,s,a,i){super($i.a,"view"),this.loggerFactory=e,this._resConvDataManager=t,this._resZaRFDataManager=s,this._resUnlistedDataManager=a,this._resConvFilterManager=i,this.logger=void 0,this._listeningEvents=!1,this._isMounted=!1,this._aborted=!1,this._abortQuickScan=!1,this._abortDBScan=!1,this._intervalOn=!1,this._calculating=!1,this._fastCalculating=!1,this._manualCalculating=!1,this._calculatingLog=!1,this._fastCalculatingLog=!1,this._isSetAutoRunOverviewCalculate=!1,this._timeToQuickScanComplete=0,this._timeToDBScanComplete=0,this._timeoutAutoScan=void 0,this._calcHistory=[],this._fastCalcHistory=[],this._calculateInterval=Qi.a,this._rescanFastCalculate=Qi.b,this._rescanCalculate=Qi.b,this._onCalcDone=[],this.updateZaRFSize=e=>{this.updateItem((t=>{t.zaRFSize=e}),"zaRFSize")},this.getZaloUsage=()=>{const e=JSON.parse(Xi.a.getOverviewPageData()),t=(null==e?void 0:e.zaloLocalSize)+(null==e?void 0:e.appDataSize)+(null==e?void 0:e.zaRFSize)+(null==e?void 0:e.zTempSize)+(null==e?void 0:e.zaloTempSize);return{total:t,zarf:null==e?void 0:e.zaRFSize,appDataSize:null==e?void 0:e.appDataSize,otherDataSize:t-(null==e?void 0:e.convDataSize)-(null==e?void 0:e.zaRFSize)-(null==e?void 0:e.otherAccountsSize)}},this.getZaloUsageForLog=()=>new Promise(((e,t)=>{this._resUnlistedDataManager.calculateZaloAppDataLog(!0,(t=>{var s,a,i,n,r,o;const l=t,c=(null===(s=this.data.get("zaloLocalSize"))||void 0===s?void 0:s.zaloLocalSize)||0,d=(null===(a=this.data.get("zaRFSize"))||void 0===a?void 0:a.zaRFSize)||0,u=(null===(i=this.data.get("otherAccountsSize"))||void 0===i?void 0:i.otherAccountsSize)||0,h=c+l+d+((null===(n=this.data.get("zTempSize"))||void 0===n?void 0:n.zTempSize)||0)+((null===(r=this.data.get("zaloTempSize"))||void 0===r?void 0:r.zaloTempSize)||0),g=(null===(o=this.data.get("convDataSize"))||void 0===o?void 0:o.convDataSize)||0;return e({total:h,zarf:d,appDataSize:l,otherDataSize:h-g-d-u,otherAccountsSize:u,convDataSize:g})}),void 0)})),this.deferredPromise=e=>{const t={};t.promise=new Promise(((s,a)=>{t.resolve=()=>{s(e())},t.reject=a}));const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1],a=setTimeout((()=>{this._calculating||this.calculate(Cn.a.ROUTINE)}),2e4);return!s||s.status!==Cn.b.COMPLETED&&(null==s?void 0:s.status)!==Cn.b.ABORTED?this._onCalcDone.push(t.resolve):(t.resolve(),clearTimeout(a)),t.promise},this.getConvData=()=>this.deferredPromise((()=>{var e;return(null===(e=this.data.get("convData"))||void 0===e?void 0:e.convData)||0})),this.updateConvs=e=>{e=this._filterDuplicateConv(e);const t=(e=this._filterInvalidConv(e)).filter((e=>this._resConvDataManager.validateCalculateResult(null==e?void 0:e.amount)));this.updateItem((e=>{e.convs=t}),"convs"),t.length>0?(this._searchRelative(this._resConvFilterManager.getCurrentSearch()),this.updateItem((e=>{e.isConvDetailScanNull=!1}),"isConvDetailScanNull")):this.updateItem((e=>{e.isConvDetailScanNull=!0}),"isConvDetailScanNull")},this.updateConvsDataSize=e=>{let t=0;if("number"==typeof e)t=e;else if(e.length>0){var s;const a=this._resConvDataManager.calculateConvDataSize(e),i=(null===(s=this.data.get("isDeleteConvsStatus"))||void 0===s?void 0:s.isDeleteConvsStatus)||Cn.c.NOT_YET;[Cn.c.NOT_YET,Cn.c.DONE_OR_ERROR].includes(i)&&(t=a)}this.updateItem((e=>{e.convDataSize=t}),"convDataSize")},this._updateZaloLocalSize=e=>{var t;const s=(null===(t=this.data.get("isDeleteConvsStatus"))||void 0===t?void 0:t.isDeleteConvsStatus)||Cn.c.NOT_YET;[Cn.c.NOT_YET,Cn.c.DONE_OR_ERROR].includes(s)&&this.updateItem((t=>{t.zaloLocalSize=e}),"zaloLocalSize");const a=Xi.a.getOverviewPageData();let i={};i=a?Object(I.a)(Object(I.a)({},JSON.parse(a)),{},{zaloLocalSize:e}):{zaloLocalSize:e},Xi.a.setOverviewPageData(i)},this._updateAppDataSize=e=>{this.updateItem((t=>{t.appDataSize=e}),"appDataSize")},this._updateZaloDBSearchSize=e=>{this.updateItem((t=>{t.zaloDBSearchSize=e}),"zaloDBSearchSize")},this._updateOtherAccountSize=e=>{this.updateItem((t=>{t.otherAccountsSize=e}),"otherAccountsSize");const t=Xi.a.getOverviewPageData();let s={};s=t?Object(I.a)(Object(I.a)({},JSON.parse(t)),{},{otherAccountsSize:e}):{otherAccountsSize:e},Xi.a.setOverviewPageData(s)},this._updatezTempSize=e=>{this.updateItem((t=>{t.zTempSize=e}),"zTempSize")},this._updateZaloTempSize=e=>{this.updateItem((t=>{t.zaloTempSize=e}),"zaloTempSize")},this._handleSortFilterEventChange=e=>{switch(e.type){case Sn.ResConv_FilterSort_Status_Change:{var t;const s=e.payload;this.updateItem((e=>{e[s.type]=s.value}),s.type,s.ignoreRender||!1);if(!((null===(t=this.data.get("isConvDetailScanNull"))||void 0===t?void 0:t.isConvDetailScanNull)||!1))switch(s.type){case"filterBy":this._filterRelative(s.value);break;case"sortBy":this._sortRelative(s.value,null);break;case"searchBy":this._searchRelative(s.value);break;case"toggleHiddenBy":this._toggleHiddenConv(s.value)}break}}},this._handleCalculationStatus=e=>{const t=e.payload;this.updateItem((e=>{var s;e[t.type]={status:t.status,progress:t.progress,hasCache:!0===(null===(s=e[t.type])||void 0===s?void 0:s.hasCache)||t.status===Cn.l.IDLE}}),t.type)},this._handleManualFastCalculateStatus=e=>{this.updateItem((t=>{t.isManualFastCalculateStatus=e.payload}),"isManualFastCalculateStatus")},this._handleManualDetailCalculateStatus=e=>{this.updateItem((t=>{t.isManualDetailCalculateStatus=e.payload}),"isManualDetailCalculateStatus")},this._handleCalculateResourceWhenDeleteConvs=e=>{var t,s;const a=JSON.parse(Xi.a.getOverviewPageData()),i=e.payload;let n=((null===(t=this.data.get("zaloLocalSize"))||void 0===t?void 0:t.zaloLocalSize)||0)-i;n<0&&(n=0),a.zaloLocalSize=n,this._updateZaloLocalSize(n);let r=((null===(s=this.data.get("convDataSize"))||void 0===s?void 0:s.convDataSize)||0)-i;r<0&&(r=0),a.convDataSize=r,a.time=Ct.default.getSystemTimeNow()||Date.now(),Xi.a.setOverviewPageData(a),this.updateItem((e=>{e.convDataSize=r}),"convDataSize")},this._handleCalculateDeleteConvsStatus=e=>{this.updateItem((t=>{t.isDeleteConvsStatus=e.payload}),"isDeleteConvsStatus")},this._handleCalculateUpdateDetailPageCache=e=>{var t;let s=(null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||[];s.length>0&&(s=this._filterDuplicateConv(s),s=this._filterInvalidConv(s));const a=e.payload.dataHiddenConversations,i=Ct.default.getSystemTimeNow()||Date.now();Xi.a.setDetailPageData({time:i,convs:s,dataHiddenConversations:a})},this.logger=this.loggerFactory.createZLogger("resmgmt",["Controller"]),this.init()}onApplicationReady(){a.ModuleContainer.resolve(Fr.RRCController).addEventListener(Fr.RRCEvents.Success,(()=>{Xi.a.setInfoForceScanByDeletingRedundantRes(`${Cn.f.DELETED}`)}))}setSelectedConvs(e){this.updateItem((t=>{t.selectedConvs=e}),"selectedConvs")}hasCache(){return this._calcHistory.length>0&&this._calcHistory[this._calcHistory.length-1].status!==Cn.b.CALCULATING}startCalcInterval(){this._intervalOn=!0}resetCalcInterval(){this._intervalOn=!1}setCalculateInterval(e){this._calculateInterval=e,this.updateItem((t=>{t.calculateInterval=e}),"calculateInterval")}getLastCalcTs(){return this._calcHistory.length>0?this._calcHistory[this._calcHistory.length-1].end:0}getCalcHistory(){return this._calcHistory.length>0?this._calcHistory:null}getCalculateInterval(){return this._calculateInterval}_setAllLocalToReady(){this.updateItem((e=>{e.zaloLocalStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"zaloLocalStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"convDataOverviewStatus"),this.updateItem((e=>{e.zaRFStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"zaRFStatus"),this.updateItem((e=>{e.appDataStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"appDataStatus"),this.updateItem((e=>{e.otherAccountsStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"otherAccountsStatus"),this.updateItem((e=>{e.zTempStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"zTempStatus"),this.updateItem((e=>{e.zaloTempStatus={status:Cn.l.CALCULATING,hasCache:!0}}),"zaloTempStatus")}_setAllLocalToIdle(){this.updateItem((e=>{e.zaloLocalStatus={status:Cn.l.IDLE,hasCache:!0}}),"zaloLocalStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:Cn.l.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this.updateItem((e=>{e.zaRFStatus={status:Cn.l.IDLE,hasCache:!0}}),"zaRFStatus"),this.updateItem((e=>{e.appDataStatus={status:Cn.l.IDLE,hasCache:!0}}),"appDataStatus"),this.updateItem((e=>{e.otherAccountsStatus={status:Cn.l.IDLE,hasCache:!0}}),"otherAccountsStatus"),this.updateItem((e=>{e.zTempStatus={status:Cn.l.IDLE,hasCache:!0}}),"zTempStatus"),this.updateItem((e=>{e.zaloTempStatus={status:Cn.l.IDLE,hasCache:!0}}),"zaloTempStatus")}async fastCalculate(e,t=!1){const s=a.ModuleContainer.resolve(Bi.a),i=Ki.a.analyzeMainDisk(),n=s.getTimeNow();if(this._fastCalculating)return;if(this._timeToQuickScanComplete=0,e===Cn.a.RESMGMT_TAB_MOUNTED){i&&s.diskStatusReport({scan_event:s.getScanType().UserManual,ts:s.getTimeNow(),total:i.total,free:i.free});const e=JSON.parse(Xi.a.getOverviewPageData()),a=Ct.default.getSystemTimeNow()||Date.now();let n=Vi.StartNewScanWithoutCache;if(t?e?null!=e&&e.time&&a-(null==e?void 0:e.time)>en.a.resource_management.cache_valid_time&&(n=Vi.StartNewScanWithCache):n=Vi.StartNewScanWithoutCache:n=null!=e&&e.time&&a-(null==e?void 0:e.time)<=en.a.resource_management.cache_valid_time?Vi.CacheValid:Vi.StartNewScanWithCache,n===Vi.CacheValid){var r,o;const e=(null===(r=this.data.get("isManualDetailCalculateStatus"))||void 0===r?void 0:r.isManualDetailCalculateStatus)||!1,t=(null===(o=this.data.get("isManualFastCalculateStatus"))||void 0===o?void 0:o.isManualFastCalculateStatus)||!1;this._fastCalculating||t?n=Vi.ContinueQuickScan:(this._calculating||e)&&(n=Vi.ContinueDBScan)}s.timeGoToSMReport(n)}const l=JSON.parse(Xi.a.getOverviewPageData()),c=JSON.parse(Xi.a.getDetailPageData()),d=JSON.parse(Xi.a.getInfoForceScanByDeletingRedundantRes()),u=Ar.d.NULL,h=Ct.default.getSystemTimeNow()||Date.now(),g=()=>{if(!t&&null!=l&&l.time)return this._updateZaloLocalSize(l.zaloLocalSize),this.updateConvsDataSize(l.convDataSize),this.updateZaRFSize(l.zaRFSize),this._updateAppDataSize(l.appDataSize),this._updateZaloDBSearchSize(l.zaloDBSearchSize),this._updateOtherAccountSize(l.otherAccountsSize),this._updatezTempSize(l.zTempSize),this._updateZaloTempSize(l.zaloTempSize),this._updateDetailDataWhenAutoRecalculate(),this._setAllLocalToReady(),void this.manualCalculate()};if(d==Cn.f.DELETED)return Xi.a.setInfoForceScanByDeletingRedundantRes(`${Cn.f.SCAN}`),void(null!=l&&l.time?g():this.manualCalculate());if(u===Ar.d.SUCCEED&&!sessionStorage.getItem(Nr))return sessionStorage.setItem(Nr,"1"),void g();if(!t&&null!=l&&l.time&&h-(null==l?void 0:l.time)>en.a.resource_management.cache_valid_time)g();else if(!t&&null!=c&&c.time&&h-(null==c?void 0:c.time)>en.a.resource_management.cache_valid_time&&(this._updateDetailDataWhenAutoRecalculate(),this.updateItem((e=>{e.isManualDetailCalculateStatus=!0}),"isManualDetailCalculateStatus"),this._abortDBScan=!1,this.calculate(e,!0)),this._isMounted=!0,this._listeningEvents||this._listenEvents(),!t&&null!=l&&l.time&&h-(null==l?void 0:l.time)<=en.a.resource_management.cache_valid_time){if(Pr.zsymb(0,"fzIytq","[RES-MNT] Quick scan - get cache to display"),this._updateZaloLocalSize(l.zaloLocalSize),this.updateConvsDataSize(l.convDataSize),this.updateZaRFSize(l.zaRFSize),this._updateAppDataSize(l.appDataSize),this._updateZaloDBSearchSize(l.zaloDBSearchSize),this._updateOtherAccountSize(l.otherAccountsSize),this._updatezTempSize(l.zTempSize),this._updateZaloTempSize(l.zaloTempSize),this._abortDBScan=!1,this.calculate(e),this.updateItem((e=>{e.lastCalcOverview=l.time}),"lastCalcOverview"),this._setAllLocalToIdle(),!this._isSetAutoRunOverviewCalculate){const e=(null==l?void 0:l.time)+en.a.resource_management.cache_valid_time-h;this._isSetAutoRunOverviewCalculate=!0,this._timeoutAutoScan=setTimeout((()=>{this._isSetAutoRunOverviewCalculate=!1,Pr.zsymb(0,"pJZ5m3","[RES-MNT] Start Manual Scan from Quick Scan interval"),this.manualCalculate()}),e)}}else{this._fastCalculating=!0;try{await this._startAllFastCalculate(t,e)}catch(p){this.logger.zsymb(21,"vnO4mE",["Error estimating resources","k97pri"],p)}if(this._fastCalculating=!1,this._onCalcDone.forEach((e=>Rr(e))),this._onCalcDone.splice(0,this._onCalcDone.length),!this._fastCalculating&&!this._fastCalculatingLog&&en.a.resource_management.enable_partial_stat&&!this._abortQuickScan){var m;this._fastCalculatingLog=!0;const e=a.ModuleContainer.resolve(Bi.a),t=e.getScanType().Partial,s=Ki.a.analyzeMainDisk();this._timeToQuickScanComplete=e.getTimeNow()-n,e.timeFinishedScanReport({scanEvent:t,timeToDBScanComplete:this._timeToDBScanComplete,timeToQuickScanComplete:this._timeToQuickScanComplete}),await this.scanZtempZaloTemp();const i=this.getZaloUsage();e.zaloUsageReport({scan_event:t,ts:e.getTimeNow(),used:i.total,free:null!==(m=null==s?void 0:s.free)&&void 0!==m?m:-1}),e.cacheReport({scan_event:t}),this._fastCalculatingLog=!1}}}_filterDuplicateConv(e){const t=new Set;return e.filter((e=>!t.has(e.userId)&&(t.add(e.userId),!0)))}async calculate(e,t=!1,s=!1){if(this._abortDBScan)return;this._isMounted=!0,this._listeningEvents||this._listenEvents();const i=JSON.parse(Xi.a.getDetailPageData()),n=Ct.default.getSystemTimeNow()||Date.now();if(this._timeToDBScanComplete=0,this._calculating)return;if(!t&&null!=i&&i.time&&n-(null==i?void 0:i.time)<=en.a.resource_management.cache_valid_time){Pr.zsymb(0,"nA17iN","[RES-MNT] DB scan - get cache to displayy"),i.convs=i.convs.filter((e=>null!==e));const e=this._filterDuplicateConv(i.convs);i.dataHiddenConversations=i.dataHiddenConversations.filter((e=>null!==e));const t=this._filterDuplicateConv(i.dataHiddenConversations);return this._resConvDataManager.setForceConvData(e),this._resConvDataManager.setForceConvHiddenData(t),this.updateConvs(e),void this.updateItem((e=>{e.convDataStatus={status:Cn.l.IDLE,hasCache:!0}}),"convDataStatus")}this._calculating=!0;const r=a.ModuleContainer.resolve(Bi.a),o=Ki.a.analyzeMainDisk(),l=r.getTimeNow();try{await this._startAllCalculators(e,t)}catch(d){this.logger.zsymb(21,"cLwi-t",["Error estimating resources","k97pri"],d)}if(this._calculating=!1,this._onCalcDone.forEach((e=>Rr(e))),this._onCalcDone.splice(0,this._onCalcDone.length),!(e!==Cn.a.RESMGMT_TAB_MOUNTED&&e!==Cn.a.ROUTINE&&e!==Cn.a.MANUAL||this._calculatingLog||this._calculating||this._abortDBScan)){var c;this._calculatingLog=!0;const t=a.ModuleContainer.resolve(Bi.a),s=e===Cn.a.RESMGMT_TAB_MOUNTED||e===Cn.a.MANUAL?t.getScanType().UserManual:t.getScanType().Routine;this._timeToDBScanComplete=t.getTimeNow()-l,t.timeFinishedScanReport({scanEvent:s,timeToDBScanComplete:this._timeToDBScanComplete,timeToQuickScanComplete:this._timeToQuickScanComplete});const i=this.getZaloUsage();t.zaloUsageReport({scan_event:s,ts:t.getTimeNow(),used:i.total,free:null!==(c=null==o?void 0:o.free)&&void 0!==c?c:-1}),t.cacheReport({scan_event:s}),this._calculatingLog=!1}}async manualCalculate(){this._isMounted=!0,this._listeningEvents||this._listenEvents(),this._manualCalculating=!0,this._abortQuickScan=!1,this._abortDBScan=!1,this._cancelAllOverviewCalculations(),this._resZaRFDataManager.reset(),Pr.zsymb(0,"KGfI4w","[RES-MNT] Start Manual Scan"),this.updateItem((e=>{e.isDoneCalculate=!1}),"isDoneCalculate"),this.updateItem((e=>{e.isManualFastCalculateStatus=!0}),"isManualFastCalculateStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:Cn.l.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this._calculating||(this.updateItem((e=>{e.isManualDetailCalculateStatus=!0}),"isManualDetailCalculateStatus"),this.updateItem((e=>{e.convDataStatus={status:Cn.l.CALCULATING,progress:1,hasCache:!0}}),"convDataStatus")),Pr.zsymb(0,"oKBZR9","[RES-MNT] Start quick scan in manual scan"),await this.fastCalculate(Cn.a.MANUAL,!0),Pr.zsymb(0,"PM5u-b","[RES-MNT] Manual scan - done... Bye Bye QC"),this._manualCalculating=!1}async scanZtempZaloTemp(){try{await Ki.a.scanZtempZaloTemp()}catch(e){this.logger.zsymb(21,"Pf3xxX",["Error estimating resources","k97pri"],e)}}init(){this.updateItem((e=>{e.view=Tr.a.OVERVIEW,e.theme=wr.e.LIGHT}),"view",!0),this.updateItem((e=>{e.sortBy=Cn.j.DECREASE_CAPACITY}),"sortBy",!0),this.updateItem((e=>{e.filterBy=Cn.i.ALL}),"filterBy",!0),this.updateItem((e=>{e.currentDisk="C:"}),"currentDisk",!0),this.updateItem((e=>{e.calculateInterval=this._calculateInterval}),"calculateInterval",!0),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs",!0),this.updateItem((e=>{e.searchBy=""}),"searchBy",!0),this.updateItem((e=>{e.toggleHiddenBy=!1}),"toggleHiddenBy",!0),this.updateItem((e=>{e.isCheckHiddenConversation=!1}),"isCheckHiddenConversation",!0),this.updateItem((e=>{e.isDeleteConvsStatus=Cn.c.NOT_YET}),"isDeleteConvsStatus",!0),this._listenEvents()}resetStates(){this.updateItem((e=>{e.view=Tr.a.OVERVIEW}),"view",!0),this._timeoutAutoScan&&clearTimeout(this._timeoutAutoScan)}resetFirstTimeToggleHiddenConvsState(){this.changeDataFirstTimeToggleHiddenConvs(!1)}resetAll(){this.resetCalcInterval();const e=a.ModuleContainer.resolve(cn);this.updateItem((e=>{e.isCheckHiddenConversation=!1}),"isCheckHiddenConversation"),e.resetDefault(),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs")}updateView(e){this.updateItem((t=>{t.view=e}),"view")}abort(){this._isMounted=!1,this._fastCalculating=!1,this._abortQuickScan=!0,this._abortDBScan=!0,this._calculating=!1,this._calcHistory=[],this._fastCalcHistory=[],this._cancelAllCalculations(),this.updateItem((e=>{e.isManualDetailCalculateStatus=!1}),"isManualDetailCalculateStatus"),this._cleanupListeners()}resetSort(){this._resConvFilterManager.sort(Cn.j.DECREASE_CAPACITY)}sort(e){switch(e){case Cn.j.DECREASE_CAPACITY:Ia.default.logAction(2230601);break;case Cn.j.INCREASE_LAST_UPDATE:Ia.default.logAction(2230605);break;case Cn.j.DECREASE_LAST_UPDATE:Ia.default.logAction(2230607)}this._resConvFilterManager.getCurrentSort()!==e&&this._resConvFilterManager.sort(e)}filter(e){switch(e){case Cn.i.ALL:Ia.default.logAction(2230801);break;case Cn.i.FILTER_GROUP_CONVS:Ia.default.logAction(2230802);break;case Cn.i.FILTER_SINGLE_CHAT_CONVS:Ia.default.logAction(2230803);break;case Cn.i.FILTER_OTHER_CONVS:Ia.default.logAction(2230804)}this._resConvFilterManager.getCurrentFilter()!==e&&this._resConvFilterManager.filter(e)}search(e){this._resConvFilterManager.getCurrentSearch()!==e&&this._resConvFilterManager.search(e)}toggleHidden(e){this._resConvFilterManager.toggleHidden(e)}changeDataToggleHidden(e){this.updateItem((t=>{t.isCheckHiddenConversation=e}),"isCheckHiddenConversation",!1)}changeDataFirstTimeToggleHiddenConvs(e){this.updateItem((t=>{t.isFirstTimeToggleHiddenConvs=e}),"isFirstTimeToggleHiddenConvs",!1)}isCurrentSort(e){var t;return(null===(t=this.data.get("sortBy"))||void 0===t?void 0:t.sortBy)===e}isCurrentFiler(e){var t;return(null===(t=this.data.get("filterBy"))||void 0===t?void 0:t.filterBy)===e}changeTheme(e){return Promise.resolve()}openZaRF(){Object(Ki.e)()}async onDelete(e,t={photo:!0,video:!0,file:!0},s){var i;switch(this._resConvFilterManager.getCurrentFilter()){case Cn.i.FILTER_GROUP_CONVS:Ia.default.logAction(2230805);break;case Cn.i.FILTER_GROUP_CONVS:Ia.default.logAction(2230806);break;case Cn.i.FILTER_SINGLE_CHAT_CONVS:Ia.default.logAction(2230807);break;case Cn.i.FILTER_OTHER_CONVS:Ia.default.logAction(2230808)}let n=null!=s?s:0;if(!s){const s=sessionStorage.getItem(Rn);s?(n=+s,sessionStorage.removeItem(Rn)):n=this._resConvDataManager.calculateConvDataSizeByIds(e,t)}const r=Ki.a.analyzeMainDisk(),o=a.ModuleContainer.resolve(Bi.a);let l="";l="Mac",await o.logAction999({type:"DeleteConv",deleted_count:e.length,deleted_size:n,target:Object(I.a)({},t),free:null!==(i=null==r?void 0:r.free)&&void 0!==i?i:-1,current_disk:l}),await this._resConvDataManager.onDelete(e,t)}async onUpdateDataBeforeDelete(e,t){await this._resConvDataManager.onUpdateDataBeforeDelete(e,t)}abortTasks(){this._aborted=!0,this.logger.zsymb(0,"i1PYFF","abort calc tasks"),me.a.ResCacheManager.revokeCache()}_startAllFastCalculate(e,t){this._resConvDataManager.setResCalculateStatus(Cn.k.START_CALCULATE);const s=this._fastCalcHistory.length&&this._fastCalcHistory[this._fastCalcHistory.length-1];return Object(Ki.d)()?s&&s.status===Cn.b.CALCULATING?(this.logger.zsymb(3,"MV_oW6",["recalculateResource is called too frequently. now:{} last:{}","WaXfcS"],Date.now(),this.getLastCalcTs()),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve(!0)):!e&&s&&this._hasLastFastScanRequestExpired()?(this.updateItem((e=>{e.convDataOverviewStatus={status:Cn.l.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve(!0)):this._systemUsageInfo().then((e=>e.cpu>=Ce.default.full_disk_check.high_cpu||Ce.default.full_disk_check.high_mem?(this.logger.zsymb(3,"YvBnYq",["CPU or MEM usage is too high. No calculation will be postponed","7GEwxw"]),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve()):(this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve()))).then((async()=>{let a=!0;this._aborted=!1,Pr.zsymb(0,"Jj9Eju","[RES-MNT] Quick scan - start...");const i={start:Date.now(),end:-1,status:Cn.b.CALCULATING};this._fastCalcHistory.push(i),this.updateItem((e=>{var t;e.convDataOverviewStatus={status:Cn.l.CALCULATING,progress:1,hasCache:!0===(null===(t=e.convDataOverviewStatus)||void 0===t?void 0:t.hasCache)}}),"convDataOverviewStatus");const n=[this._resUnlistedDataManager.calculatezTemp(a,this._updatezTempSize),this._resUnlistedDataManager.calculateZaloTemp(a,this._updateZaloTempSize)];return(en.a.resource_management.enable_calculate_zrf||en.a.resource_management.enable_calculate_zrf_without_display)&&n.push(this._resZaRFDataManager.start(a,this.updateZaRFSize)),en.a.resource_management.enable_calculate_zalo_data&&n.push(this._resUnlistedDataManager.calculateZaloAppData(a,this._updateAppDataSize)),await this._resUnlistedDataManager.calculateOtherAccounts(a,e,this._updateOtherAccountSize),await this._resUnlistedDataManager.calculateZaloLocal(a,e,this._updateZaloLocalSize),this._resConvDataManager.fastStart(a,e,this.updateConvsDataSize).then((()=>(this._calculating||(Pr.zsymb(0,"ndeoim","[RES-MNT] Start db scan in manual scan"),this.calculate(t,e)),Promise.all(n).then((()=>{if(this._aborted?(me.a.ResCacheManager.revokeCache(),i.status=Cn.b.ABORTED):(i.status=Cn.b.COMPLETED,me.a.ResCacheManager.signCache()),i.end=Date.now(),i.status===Cn.b.COMPLETED){setTimeout((()=>{this.persistDataToCache()}),500),Pr.zsymb(0,"8h6Ubl","[RES-MNT] Quick scan - done... Bye Bye QC");JSON.parse(Xi.a.getInfoForceScanByDeletingRedundantRes())&&Xi.a.removeInfoForceScanByDeletingRedundantRes(),this.updateItem((e=>{e.isDoneCalculate=!0}),"isDoneCalculate"),this.updateItem((e=>{e.lastCalc=i.end}),"lastCalc"),s&&!e||this.updateItem((e=>{e.lastCalcOverview=i.end}),"lastCalcOverview")}})))))})):(this.logger.zsymb(3,"TqnBXA",["Full disk check is disabled. No calculation will be performed","A2Mp5k"]),Promise.resolve(!0))}persistDataToCache(){var e,t,s,a,i,n,r,o;const l=(null===(e=this.data.get("convDataSize"))||void 0===e?void 0:e.convDataSize)||0,c=(null===(t=this.data.get("zaRFSize"))||void 0===t?void 0:t.zaRFSize)||0,d=(null===(s=this.data.get("zaloLocalSize"))||void 0===s?void 0:s.zaloLocalSize)||0,u=(null===(a=this.data.get("zTempSize"))||void 0===a?void 0:a.zTempSize)||0,h=(null===(i=this.data.get("zaloTempSize"))||void 0===i?void 0:i.zaloTempSize)||0,g=(null===(n=this.data.get("appDataSize"))||void 0===n?void 0:n.appDataSize)||0,m=(null===(r=this.data.get("otherAccountsSize"))||void 0===r?void 0:r.otherAccountsSize)||0,p=(null===(o=this.data.get("zaloDBSearchSize"))||void 0===o?void 0:o.zaloDBSearchSize)||0,f={time:Ct.default.getSystemTimeNow()||Date.now(),convDataSize:l,zaRFSize:c,zaloLocalSize:d,zTempSize:u,zaloTempSize:h,appDataSize:g,otherAccountsSize:m,zaloDBSearchSize:p};Xi.a.setOverviewPageData(f),this._isSetAutoRunOverviewCalculate||(this._isSetAutoRunOverviewCalculate=!0,this._timeoutAutoScan=setTimeout((()=>{this._isSetAutoRunOverviewCalculate=!1,this.manualCalculate()}),en.a.resource_management.cache_valid_time))}setConvToHidden(e,t,s=!1){this._resConvDataManager.setConvToHidden(e,t,s)}removeConvToList(e){this._resConvDataManager.removeConvToList(e)}_updateDetailDataWhenAutoRecalculate(){var e;const t=JSON.parse(Xi.a.getDetailPageData());if(!t||null==t||!t.convs)return;t.convs=t.convs.filter((e=>null!==e));const s=this._filterDuplicateConv(t.convs);t.dataHiddenConversations=t.dataHiddenConversations.filter((e=>null!==e));const a=this._filterDuplicateConv(t.dataHiddenConversations);this._resConvDataManager.setForceConvData(s),this._resConvDataManager.setForceConvHiddenData(a),this.updateConvs(s);const i=(null===(e=this.data.get("convDataStatus"))||void 0===e?void 0:e.convDataStatus)||{progress:1},n=null==i?void 0:i.progress;this.updateItem((e=>{e.convDataStatus={status:Cn.l.CALCULATING,progress:n,hasCache:!0}}),"convDataStatus")}_startAllCalculators(e,t){this._resConvDataManager.setResCalculateStatus(Cn.k.START_CALCULATE);const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1];return Object(Ki.d)()?s&&s.status===Cn.b.CALCULATING?(this.logger.zsymb(3,"24jSha",["recalculateResource is called too frequently. now:{} last:{}","WaXfcS"],Date.now(),this.getLastCalcTs()),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve(!0)):!t&&s&&this._hasLastScanRequestExpired()?(this.updateItem((e=>{e.convDataStatus={status:Cn.l.IDLE,hasCache:!0}}),"convDataStatus"),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve(!0)):this._systemUsageInfo().then((e=>e.cpu>=Ce.default.full_disk_check.high_cpu||Ce.default.full_disk_check.high_mem?(this.logger.zsymb(3,"iMRLbi",["CPU or MEM usage is too high. No calculation will be postponed","7GEwxw"]),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve()):(this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve()))).then((()=>{this._aborted=!1,Pr.zsymb(0,"xaNDMD","[RES-MNT] DB scan - start...");const e={start:Date.now(),end:-1,status:Cn.b.CALCULATING};return this._calcHistory.push(e),this._resConvDataManager.start(!0,t,this.updateConvs).finally((()=>{this._aborted?(me.a.ResCacheManager.revokeCache(),e.status=Cn.b.ABORTED):(e.status=Cn.b.COMPLETED,me.a.ResCacheManager.signCache()),e.end=Date.now(),e.status===Cn.b.COMPLETED&&(Pr.zsymb(0,"CYazOT","[RES-MNT]  scan - done... Bye Bye QC"),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),this.updateItem((t=>{t.lastCalc=e.end}),"lastCalc"))}))})):(this.logger.zsymb(3,"QlXZzP",["Full disk check is disabled. No calculation will be performed","A2Mp5k"]),this._resConvDataManager.setResCalculateStatus(Cn.k.FINISH_CALCULATE),Promise.resolve(!0))}async _sortRelative(e,t){let s=[];if(t)s=t;else{var a,i;s=((null===(a=this.data.get("convs"))||void 0===a?void 0:a.convs)||this._resConvDataManager.getConvs()).filter((e=>!un.a.isThreadHidden(e.userId)));const e=this._resConvDataManager.getConvHiddenData()||[],t=null===(i=this.data.get("toggleHiddenBy"))||void 0===i?void 0:i.toggleHiddenBy;e.length>0&&t&&(s=[...s,...e])}switch(e){case Cn.j.DECREASE_CAPACITY:s=s.slice().sort(((e,t)=>t.amount.videosSize+t.amount.imagesSize+t.amount.filesSize-e.amount.videosSize-e.amount.imagesSize-e.amount.filesSize));break;case Cn.j.INCREASE_LAST_UPDATE:case Cn.j.DECREASE_LAST_UPDATE:s=s.slice().sort(((t,s)=>{const a=s.lastMsgTime-t.lastMsgTime;return e===Cn.j.DECREASE_LAST_UPDATE?a:-a}))}s=this._filterDuplicateConv(s),s=this._filterInvalidConv(s),this.updateItem((e=>{e.convs=s}),"convs")}_filterInvalidConv(e){return e.filter((e=>"number"==typeof e.amount.videosSize&&"number"==typeof e.amount.imagesSize&&"number"==typeof e.amount.filesSize&&!(e.amount.videosSize+e.amount.imagesSize+e.amount.filesSize<=0)))}_filterRelative(e){var t;let s=(this._resConvDataManager.getConvs()||[]).filter((e=>!un.a.isThreadHidden(e.userId)));const a=this._resConvDataManager.getConvHiddenData()||[],i=null===(t=this.data.get("toggleHiddenBy"))||void 0===t?void 0:t.toggleHiddenBy;switch(a.length>0&&i&&(s=[...s,...a]),e){case Cn.i.ALL:s=this._resConvDataManager.getConvs();break;case Cn.i.FILTER_SINGLE_CHAT_CONVS:s=s.filter((e=>!this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)||this._resConvDataManager.isMyCloud(e.userId)));break;case Cn.i.FILTER_GROUP_CONVS:s=s.filter((e=>this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)));break;case Cn.i.FILTER_OTHER_CONVS:s=s.filter((e=>this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)))}this._sortRelative(this._resConvFilterManager.getCurrentSort(),s)}async _searchRelative(e){var t,s;const a=JSON.parse(Xi.a.getDetailPageData());let i=((null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||this._resConvDataManager.getConvs()).filter((e=>!un.a.isThreadHidden(e.userId)));0===i.length&&(null==a?void 0:a.convs.length)>0&&(i=a.convs);const n=this._resConvDataManager.getConvHiddenData()||[],r=null===(s=this.data.get("toggleHiddenBy"))||void 0===s?void 0:s.toggleHiddenBy;if(e){n.length>0&&r&&(i=[...i,...n]);const t=i.reduce(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{[t.convId]:t})),{});i=(await Dr.a.search(e,t)).all}else i&&0!==i.length||(i=this._resConvDataManager.getConvs()),n.length>0&&r&&(i=[...i,...n]);this._sortRelative(this._resConvFilterManager.getCurrentSort(),i)}async _toggleHiddenConv(e){var t,s;let a=((null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||this._resConvDataManager.getConvs()||[]).filter((e=>!un.a.isThreadHidden(e.userId)));if(e){const e=this._resConvDataManager.getConvHiddenData();a=[...a,...e]}else a=a.filter((e=>!this._resConvDataManager.isHiddenConv(e.userId)));const i=null===(s=this.data.get("searchBy"))||void 0===s?void 0:s.searchBy;if(i){const e=a.reduce(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{[t.convId]:t})),{});a=(await Dr.a.search(i,e)).all}this._sortRelative(this._resConvFilterManager.getCurrentSort(),a)}_cancelAllCalculations(){this._resConvDataManager.cancelQuickScan(),this._resConvDataManager.cancelDBScan(),this._resZaRFDataManager.abort(),this._resUnlistedDataManager.abort()}_cancelAllOverviewCalculations(){this._resZaRFDataManager.cancel(),this._resUnlistedDataManager.cancel()}_listenEvents(){this._listeningEvents=!0,this._resConvDataManager.addEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.addEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.addEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.addEventListener(Sn.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange),this._resConvDataManager.addEventListener(Sn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this._resConvDataManager.addEventListener(Sn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this._resConvDataManager.addEventListener(Sn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this._resConvDataManager.addEventListener(Sn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this._resConvDataManager.addEventListener(Sn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache)}_cleanupListeners(){this._listeningEvents=!1,this._resConvDataManager.removeEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.removeEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.removeEventListener(Sn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.removeEventListener(Sn.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange),this._resConvDataManager.removeEventListener(Sn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this._resConvDataManager.removeEventListener(Sn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this._resConvDataManager.removeEventListener(Sn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this._resConvDataManager.removeEventListener(Sn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this._resConvDataManager.removeEventListener(Sn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache)}_canRequestCalculateRes(e){if([Cn.a.ACTIVE_EVENT].includes(e))return!1;if(!this._intervalOn)return this._intervalOn=!0,this._intervalOn;const t=Date.now(),s=t-this.getLastCalcTs()>=this._calculateInterval;return s&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"hT8SDR",["Checking expire: ","WmwM0i"],s,t-this.getLastCalcTs(),this._calculateInterval,this._calcHistory),s}_hasLastFastScanRequestExpired(){const e=Date.now(),t=e-this.getLastCalcTs()>=this._rescanFastCalculate;return t&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"RuiclW",["Checking expire: ","WmwM0i"],t,e-this.getLastCalcTs(),this._rescanFastCalculate,this._calcHistory),t}_hasLastScanRequestExpired(){const e=Date.now(),t=e-this.getLastCalcTs()>=this._rescanCalculate;return t&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"4XE8RN",["Checking expire - scan request expired: ","VpTX-6"],t,e-this.getLastCalcTs(),this._rescanCalculate,this._calcHistory),t}_getCPU(){var e=kr.cpus(),t=0,s=0,a=0,i=0,n=0;for(var r in e)e.hasOwnProperty(r)&&(t+=e[r].times.user,s+=e[r].times.nice,a+=e[r].times.sys,n+=e[r].times.irq,i+=e[r].times.idle);return{idle:i,total:t+s+a+i+n}}getCPUUsage(e,t=!1){const s=this._getCPU(),a=s.idle,i=s.total;setTimeout((()=>{const s=this._getCPU(),n=s.idle,r=s.total,o=(n-a)/(r-i);e(!0===t?o:1-o)}),1e3)}async _systemUsageInfo(){return new Promise(((e,t)=>{const s=kr.totalmem(),a=kr.freemem(),i=s-a;this.getCPUUsage((t=>{e({cpu:t,memory:i/s})}))}))}})||Lr)||Lr)||Lr)||Lr)||Lr)||Lr)||Lr)||Lr)||Lr);s("KszJ"),s("Hbak");var jr=s("SZ0g");a.ModuleContainer.registerValue(jr.a,new class{constructor(){this._emitter=void 0,this._emitter=hi.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});var Ur,Br=s("hLuk");Object(m.j)()(Ur=class{onStart(){Br.default.init()}});var zr=s("MPLC"),Gr=s("xdZB"),xr=s("4wTQ");const Vr=Object(a.define)("message-controller");var Hr,Wr=s("hWjG"),qr=s("mE25"),Kr=s("mlG1"),$r=s("P6UB");let Zr=Object(a.singleton)()(Hr=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Hr=Reflect.metadata("design:type",Function)(Hr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Hr=class extends Wr.a{constructor(e){super("Core","Message","",e)}countMessages(e,t={from:["0","0"],to:[qr.b,qr.a]}){return this._dbCollection.count({from:[e,...t.from],to:[e,...t.to]},{index:"userId_sendDttm_msgId",partition:e})}async getLastMessage(e){var t;let s=null;const a={from:[e,"",""],to:[e,qr.b,qr.a],excludeFrom:!0,excludeTo:!0},i={index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:1,predicate:t=>{!s&&t&&(s=t);const a=Kr.d.reduceDeleteMsgs(e,[t],!0);return $r.default.isValidPreviewMessage(t)&&0!==a.length},partition:e},n=await this._dbCollection.getAll(a,i);return null!==(t=null==n?void 0:n[0])&&void 0!==t?t:s}async getPrevMessageIds(e,t,s){const a={from:[e,"",""],to:[e,(await this.get(t)).sendDttm,t],excludeFrom:!0,excludeTo:!0},i={index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:s,predicate:e=>!isNaN(Number(e.msgId)),partition:e};return(await this._dbCollection.getAll(a,i)).map((e=>e.msgId))}})||Hr)||Hr)||Hr)||Hr;const Qr=(e,t)=>{if(e)throw t};var Yr=s("S8fy"),Jr=s("fBUP"),Xr=s("kCOK"),eo=s("1izJ");let to=function(e){return e[e.FETCH_ERROR=0]="FETCH_ERROR",e[e.FETCH_CONV_HAS_MSG_OFFLINE_ERROR=1]="FETCH_CONV_HAS_MSG_OFFLINE_ERROR",e[e.INVALID_RESPONSE=2]="INVALID_RESPONSE",e[e.INSERT_MULTI_ERROR=3]="INSERT_MULTI_ERROR",e}({});class so extends eo.a{constructor(e,t,s,a){super("FetchMessageCloudError",to.FETCH_ERROR,`ConvId: ${e}. RequestMsgId: ${t}. OriginError: ${JSON.stringify(s)}`,a)}}class ao extends eo.a{constructor(e,t){super("InvalidResponse",to.INVALID_RESPONSE,e,t)}}class io extends eo.a{constructor(e,t){super("FetchConvHasMessageOfflineError",to.FETCH_CONV_HAS_MSG_OFFLINE_ERROR,e,t)}}eo.a;var no,ro=s("mea/");let oo=Object(Yr.h)()(no=class{async fetchMessagesCloud(e,t,s,a,i){const n=ro.a.newReq(),[r,o]=await E.c.catchPromise(Jr.default.getCM(e,Number(t),0,s,n,i,a));Qr(r,new so(e,t,r));const[l,c]=await E.c.catchPromise(Object(Xr.a)(o));Qr(l,new ao(`ConvId: ${e}. RequestMsgId: ${t}. Cannot handle response: ${JSON.stringify(l)}`));const[d,u]=E.c.catchFn((()=>JSON.parse(c)));return Qr(d,new ao(`ConvId: ${e}. RequestMsgId: ${t}. Cannot parse json object`)),u}async fetchListConvHasMessageOffline(e,t,s){const[a,i]=await E.c.catchPromise(Jr.default.getConvHasMessageOffline(e,t,s));Qr(a,new io(JSON.stringify(a)));const[n,r]=await E.c.catchPromise(Object(Xr.a)(i));return Qr(n,new ao(`Cannot handle response: ${JSON.stringify(n)}`)),r}})||no;var lo,co=s("/Bne");class uo{constructor(e,t){this.convId=e,this.messageCloudRaw=t,this.userId=void 0,this.idTo=void 0,this.uidFrom=void 0,this.uin=void 0,this.cliMsgId=void 0,this.msgId=void 0,this.content=void 0,this.dName=void 0,this.msgType=void 0,this.status=void 0,this.ts=void 0,this.isFromCloud=void 0,this.msgKey=void 0,this.isGroup=void 0,this.mentions=void 0,this.quote=void 0,this.st=void 0,this.at=void 0,this.ttl=void 0,this.src=void 0,this.cmd=void 0,this.footer=void 0,this.footerv2=void 0,this.previewThumb=void 0,this.property=void 0,this.propertyExt=void 0,this.specialMsgType=void 0,this.topOut=void 0,this.topOutImprTimeOut=void 0,this.topOutTimeOut=void 0,this.userId=t.userId,this.idTo=t.idTo,this.uidFrom=t.uidFrom,this.uin=t.uin,this.cliMsgId=t.cliMsgId,this.msgId=t.msgId,this.content=t.content,this.dName=t.dName,this.msgType=t.msgType,this.status=t.status,this.ts=t.ts,this.mentions=t.mentions,this.quote=t.quote,this.st=t.st,this.at=t.at,this.ttl=t.ttl,this.cmd=t.cmd,this.footer=t.footer,this.footerv2=t.footerv2,this.previewThumb=t.previewThumb,this.property=t.property,this.propertyExt=t.propertyExt,this.specialMsgType=t.specialMsgType,this.topOut=t.topOut,this.topOutImprTimeOut=t.topOutImprTimeOut,this.topOutTimeOut=t.topOutTimeOut,this.isFromCloud=!0,this.msgKey=e,this.isGroup=t.isGroup}toEntity(){return co.a.transformMessageFromServer(this.messageCloudRaw,this.convId)}setSrc(e){this.src=e}}let ho=Object(Yr.h)()(lo=Reflect.metadata("design:type",Function)(lo=Reflect.metadata("design:paramtypes",[])(lo=class{constructor(){this.apiAdapter=void 0,this.apiAdapter=a.ModuleContainer.resolveToken(oo)}async fetchMessagesCloud(e,t,s,a){var i;const[n,r]=await E.c.catchPromise(this.apiAdapter.fetchMessagesCloud(e,t,s,a));Qr(n,n);const o=(null!==(i=r.groupMsgs)&&void 0!==i?i:[]).map((t=>new uo(e,t)));return Object(I.a)(Object(I.a)({},r),{},{groupMsgs:o})}async fetchConvHasMessageOffline(e,t,s){return await this.apiAdapter.fetchListConvHasMessageOffline(e,t,s)}})||lo)||lo)||lo;var go;Object(a.singleton)(Vr)(go=Reflect.metadata("design:type",Function)(go=Reflect.metadata("design:paramtypes",[])(go=class{constructor(){this.messageRespository=void 0,this.messageService=void 0,this.messageRespository=a.ModuleContainer.resolveToken(Zr),this.messageService=a.ModuleContainer.resolveToken(ho)}async fetchMessagesCloud(e,t,s,a){return await this.messageService.fetchMessagesCloud(e,t,s,a)}async getLastMessage(e){return await this.messageRespository.getLastMessage(e)}async getPrevMessageIds(e,t,s){return this.messageRespository.getPrevMessageIds(e,t,s)}async countMessages(e,t){return await this.messageRespository.countMessages(e,t)}async getGroupHasMessageOffline(e,t,s){const a=await this.messageService.fetchConvHasMessageOffline(e,t,s);return{listConvIds:a.grids.map((e=>Y.GROUPID_PREFIX+e)),evict:!!a.evict}}reloadMessage(e){var t;null===(t=zr.b.messageCache)||void 0===t||t.deleteConversation(e);Gr.a.getExistConvIds().includes(e)&&xr.a.getLastMessagesForConversation(e,{})}})||go)||go);var mo=s("ZCU6");const po=Object(a.define)("cloud-segment-controller");var fo=s("npvr"),vo=s("t3h5");let _o=function(e){return e[e.UPDATE_FAILED=0]="UPDATE_FAILED",e}({});class bo extends eo.a{constructor(e,t){super("UpdateSegmentError",_o.UPDATE_FAILED,e,t)}}var Io;let yo=Object(a.singleton)()(Io=class{async get(e){return vo.a.getSegmentByConvId(e)}async update(e,t){const[s]=await E.c.catchPromise(fo.b.updateSegmentDB(e,t));return Qr(s,new bo(JSON.stringify(s))),vo.a.setSegmentCacheByConvId(e,t),t}})||Io;var So;Object(a.injectable)()(So=Object(a.singleton)(po)(So=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(So=Reflect.metadata("design:type",Function)(So=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(So=class{constructor(e){this.logger=void 0,this.repository=void 0,this.repository=a.ModuleContainer.resolveToken(yo),this.logger=e.createZLogger(R.ZLoggerNametags.messageCloudSegment,[R.ZLoggerNametags.controller])}async get(e){return this.repository.get(e)}async update(e){return await this.repository.update(e.conversationId,e)}async updateSegment(e,t){const s=mo.a.addOrUpdateSegmentCache(e.conversationId,t.messages,e,{requestMsgId:t.requestMsgId,lastMsgId:t.lastMsgId,checkLoadTop:t.checkLoadTop,hasMore:t.hasMore,minMsgIdFromServer:t.minMsgIdFromServer,maxMsgIdFromServer:t.requestMsgId===Y.MessageConstants.MAX_MSG_ID?t.maxMsgIdFromServer:t.requestMsgId}).segmentObj;return await this.repository.update(e.conversationId,s)}})||So)||So)||So)||So);var Co,Eo=s("bV4z"),Oo=s("2kyb"),Mo=s("5NxC"),To=s("1gE3"),wo=s("Jw4R"),Ro=s("nWXR");Object(a.injectable)()(Co=Object(a.singleton)(To.b)(Co=function(e,t){return Object(a.inject)(m.a)(e,void 0,0)}(Co=Reflect.metadata("design:type",Function)(Co=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Co=class{get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(To.a,["clip-board-link-suggest"])),this._logger}constructor(e){this._lastFocusedWindowId=hr.c,this._linkSuggestData=null,this._currUrl="",this._showLinkSuggestTimes=0,this._showLinkSuggestTimeoutId=null,this._timeClipboardChanged=0,this._listeners=new Map,this._logger=void 0,this._appReadyTime=void 0,this.onFocusingWindowChange=this.onFocusingWindowChange.bind(this),this.onConvOnMainWindowChange=this.onConvOnMainWindowChange.bind(this),this.onNewLinkPreviewData=this.onNewLinkPreviewData.bind(this),e.addEventListenerOnce(m.b.ServicesReady,(()=>{this._appReadyTime=performance.now()})),Mo.a.subscribe(ve.LinkPreviewActions.NEW_LINK_PREVIEW,this.onNewLinkPreviewData)}onHaveUrlLinkFromClipboard(e){performance.now()-this.getTimeClipboardChanged()<=wo.a.getTimeToGetClipboard()&&this._appReadyTime&&this.getTimeClipboardChanged()>this._appReadyTime&&Eo.isClipboardLinkSuggestEnabled()&&e&&e!==this.getCurrLinkUrl()&&me.a.ParserConfig.get("enable_parse_link_client")&&this.pushLinkToCache(e)}isEnabledOnCurrentPlatform(){const e=Eo.getEnableOnPlatform().split(""),t=e[0],s=e[1];return Object(Ee.m)()&&"1"==t||Object(Ee.d)()&&"1"==s}setTimeClipboardChanged(e){this._checkIfEnabled()&&(this._timeClipboardChanged=e)}getTimeClipboardChanged(){return this._timeClipboardChanged}resetData(){var e;if(!this._checkIfEnabled())return;const t=null===(e=a.ModuleContainer.resolve(Oo.a))||void 0===e?void 0:e.getConvIdByWindowId(this._lastFocusedWindowId);this._hideShowLinkSuggest(this._lastFocusedWindowId,t),this._lastFocusedWindowId=hr.c,this._linkSuggestData=null,this._resetShowLinkTimes(),this.stopTimeout()}startTimeout(e=Eo.getTimeShowClipboardLinkSuggest()){this._checkIfEnabled()&&(this._showLinkSuggestTimeoutId||(this._showLinkSuggestTimeoutId=window.setTimeout((()=>{this.resetData()}),e)))}stopTimeout(){this._checkIfEnabled()&&this._showLinkSuggestTimeoutId&&(clearTimeout(this._showLinkSuggestTimeoutId),this._showLinkSuggestTimeoutId=null)}getCurrLinkUrl(){return this._checkIfEnabled()?this._currUrl:""}getLinkSuggestData(){return this._checkIfEnabled()?this._linkSuggestData:null}hasLinkSuggestData(){return!!this._checkIfEnabled()&&!!this._linkSuggestData}pushLinkToCache(e){this._checkIfEnabled()&&(e&&e!==this._currUrl&&this._resetShowLinkTimes(),this._setCurrLinkUrl(e),Ro.c.create(e).do("parse",[Ro.a.CLIPBOARD]).do("download-thumb").exec().toPromise().then((t=>{null!=t&&t.href&&(t.href=e||t.href,Eo.isClipboardLinkSuggestEnabled()&&this._setLinkSuggestData(t))})).catch((e=>{this.Logger.zsymb(21,"Jb_Yc_",["[pushLinkToCache] parse-link-control-error: {}","JtzG3-"],e)})))}addListenerAtWindow(e,t){this._checkIfEnabled()&&this._listeners.set(e,t)}removeListenerAtWindow(e){this._checkIfEnabled()&&this._listeners.delete(e)}onFocusingWindowChange(e){var t,s;if(!this._checkIfEnabled())return;const i=this._lastFocusedWindowId;if(!e||i===e)return;const n=null===(t=a.ModuleContainer.resolve(Oo.a))||void 0===t?void 0:t.getConvIdByWindowId(i);this._hideShowLinkSuggest(i,n),this._lastFocusedWindowId=e;const r=null===(s=a.ModuleContainer.resolve(Oo.a))||void 0===s?void 0:s.getConvIdByWindowId(e);this._countShowLinkSuggest(e,r),this._showLinkSuggest(e,r)}onConvOnMainWindowChange(e=hr.c,t){this._checkIfEnabled()&&(this._countShowLinkSuggest(e,t),this._showLinkSuggest(e,t))}onNewLinkPreviewData(e){const{newLinkPreviewData:t}=e;this._linkSuggestData&&t&&this._linkSuggestData.data.href===t.link&&this.resetData()}_shouldResetData(){return this._showLinkSuggestTimes>=Eo.getLimitShowClipboardLinkSuggest()}_processCountShowLink(){if(this._shouldResetData())return this.resetData();this._increaseShowLinkTimes()}_increaseShowLinkTimes(e=1){this._showLinkSuggestTimes+=e}_resetShowLinkTimes(e=0){this._checkIfEnabled()&&(this._showLinkSuggestTimes=e)}_setCurrLinkUrl(e){this._currUrl=e}_setLinkSuggestData(e){var t;this._linkSuggestData={id:Object(ha.b)(12),data:Object(I.a)({},e),typeSuggest:Y.MSG_LINK_CLIENT};const s=null===(t=a.ModuleContainer.resolve(Oo.a))||void 0===t?void 0:t.getConvIdByWindowId(this._lastFocusedWindowId);this._countShowLinkSuggest(this._lastFocusedWindowId,s),this._showLinkSuggest(this._lastFocusedWindowId,s)}_checkIfEnabled(){return Eo.isClipboardLinkSuggestEnabled()&&this.isEnabledOnCurrentPlatform()}_checkIfValid(e,t){return!(!this._linkSuggestData||!e||""===t)}_showLinkSuggest(e,t){if(!this._checkIfValid(e,t))return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:ve.LinkSuggestManagerActions.NEW_LINK_SUGGEST,payload:{newLinkSuggestData:this._linkSuggestData}})}_hideShowLinkSuggest(e,t){if(!e||""===t)return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:ve.LinkSuggestManagerActions.HIDE_LINK_SUGGEST,payload:{newLinkSuggestData:null}})}_countShowLinkSuggest(e,t){this._checkIfValid(e,t)&&this._processCountShowLink()}})||Co)||Co)||Co)||Co);var Lo,Do=s("vQ8b"),Ao=s("ZBGy"),Fo=s("smi1"),ko=s("gEkt");let No=Object(a.injectable)()(Lo=function(e,t){return a.ModuleContainer.inject(En.UnreadDataManager)(e,void 0,0)}(Lo=function(e,t){return a.ModuleContainer.inject(En.PreviewDataManager)(e,void 0,1)}(Lo=Reflect.metadata("design:type",Function)(Lo=Reflect.metadata("design:paramtypes",[void 0===En.UnreadDataManager?Object:En.UnreadDataManager,void 0===En.PreviewDataManager?Object:En.PreviewDataManager])(Lo=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t=!0,s){e!=Y.CONV_FILTER.STRANGER&&(ui.default.logCoreError(`[user call del conv] ${e}`),Fo.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object(Ao.f)({type:ve.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{ui.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===ko.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(I.a)({},t),a=s.userId;if(s&&!ui.default.isFakeId(a)){const e=this.previewManager.getPreviewByIDSync(a),t=Ii.default.getProfileFriendByIdSync(a)||{},i=this.unreadDataManager.getUnreadByConvIdSync(a);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==i?void 0:i.unreadMark,s.smsUnreadCount=null==i?void 0:i.smsUnreadCount}this.menuRef[ko.b].updateTargetInfo(s),this.menuRef[ko.b].showAction(Object(I.a)({},e))}})||Lo)||Lo)||Lo)||Lo)||Lo;var Po=s("hI9i"),jo=s("iZzu"),Uo=s("6Vk1"),Bo=s("RojW"),zo=s("l+Gc"),Go=s("VTLO"),xo=s("LJTV"),Vo=s("M7kw"),Ho=s("Ws4b"),Wo=s("6uTC"),qo=s("Ja3U"),Ko=s("SdS7"),$o=s("TeAh"),Zo=s("FEfs"),Qo=s("u1t/");const Yo="[@CONVERSATION_OPERATION]",Jo="[@CONVERSATION_RESOURCES]",Xo="[@CONVERSATION_DELETION_CACHE]",el="999999999999999999999",tl="9999999999999999",sl="c_d_c_k__";var al;const il={typeFilter:jo.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!Zo.a.isEnableArchivedChat(),typeFilterSrc:jo.FilterSrcType.ALL},nl="z_sendtome_bubbledot";Object(Ai.b)(jo.ConvListController)(al=function(e,t){return a.ModuleContainer.inject(En.ConvInfoDataManager)(e,void 0,0)}(al=function(e,t){return a.ModuleContainer.inject(Uo.b)(e,void 0,1)}(al=function(e,t){return a.ModuleContainer.inject(En.UnreadDataManager)(e,void 0,2)}(al=function(e,t){return a.ModuleContainer.inject(En.MuteDataManager)(e,void 0,3)}(al=function(e,t){return a.ModuleContainer.inject(En.PinDataManager)(e,void 0,4)}(al=function(e,t){return a.ModuleContainer.inject(En.ArchivedChatManager)(e,void 0,5)}(al=function(e,t){return a.ModuleContainer.inject(En.ConversationUIUpdater)(e,void 0,6)}(al=Reflect.metadata("design:type",Function)(al=Reflect.metadata("design:paramtypes",[void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager,void 0===Uo.b?Object:Uo.b,void 0===En.UnreadDataManager?Object:En.UnreadDataManager,void 0===En.MuteDataManager?Object:En.MuteDataManager,void 0===En.PinDataManager?Object:En.PinDataManager,void 0===En.ArchivedChatManager?Object:En.ArchivedChatManager,void 0===En.ConversationUIUpdater?Object:En.ConversationUIUpdater])(al=class extends hs.b{constructor(e,t,s,a,i,n,r){super(),this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=a,this.pinDataManager=i,this.archivedChatManager=n,this.conversationUIUpdater=r,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,a=this.listFiltered.includes(t);this.logger.zsymb(0,"6jwttx","handleMuteChange",t,a,this.typeFilter,s),a&&(this.typeFilter===jo.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===jo.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=(e,t=!0,s)=>{e!=Y.CONV_FILTER.STRANGER&&(this.logger.zsymb(18,"L4Z5ah",`[user call del conv] ${e}`),Fo.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object(Ao.f)({type:ve.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{this.logger.zsymb(18,"PUYa0t","Delete conversation fail - "+JSON.stringify(e))})))},this.name=jo.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=jo.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=jo.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.conversation,[R.ZLoggerNametags.convList])),this._logger}get previewManager(){return this._pm||(this._pm=a.ModuleContainer.resolve(En.PreviewDataManager)),this._pm}get sidebarController(){return this._sbc||(this._sbc=a.ModuleContainer.resolve(jo.SidebarController)),this._sbc}get currUser(){return Object(Ho.c)()}onTypeFilterChange(e,t){if(e===jo.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;Ia.default.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==jo.FilterType.ARCHIVED&&e!==jo.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));const s=this.typeFilter,i=e,n=a.ModuleContainer.resolve(Qo.TUnreadSubChatTabStateManager),r=n.convetFilterTypeToSubChatTabType(s),o=n.convetFilterTypeToSubChatTabType(i);n.isValidSubChatTabType(o)&&n.handleChangeSubtab(r,o),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===jo.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),un.a.isThreadHidden(s))return void(this.listHiddens.includes(s)||this.listHiddens.push(s));let a=s,i=!1,n=!1,r=!1;if(await Bo.ConvList.isOATypeAsync(s)){if(!(await Bo.ConvList.checkIfOAShouldShowInConvList(s))&&!this.listVisible.includes(s))return}else if(Bo.ConvList.isStrangerV2(s)&&(i=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,"Kxf_Me",`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isUnboxStrangerAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),i=this.listVisible.includes(s);t||(i&&(r=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),a=Y.CONV_FILTER.STRANGER),t&&!i&&(n=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,l]=Bo.ConvList.insertToProperPosition(this.listVisible,a,this.getAlterId());this.listVisible=o,e.msgId!==Y.FAKE_DRAFT_MSG_ID||e.draft||(this.listVisible=this.listVisible.filter((e=>e!==s)),r=!0);const c=zo.a.getLabelObjByConversaionId(s),d=c&&c.id&&this.labelFilters.includes(""+c.id),u=i&&this.labelFilters.includes(ko.g),h=d||u,g=l||n||r,m="server"===e.src;if(this.typeFilter===jo.FilterType.ALL)this.addTabAllFiltered(s,h,g,m);else if(this.typeFilter===jo.FilterType.UNREAD)this.addTabUnreadFiltered(s,h,i,m);else if(this.typeFilter===jo.FilterType.STRANGER){const e=d||!this.labelFilters.length,t=i&&e;this.addTabStrangerFiltered(s,t,m)}else if(this.isEnableArchivedChat){const e=this.typeFilter===jo.FilterType.ARCHIVED;this.typeFilterSrc===jo.FilterSrcType.UNREAD?(Zo.a.isArchivedChat(s)&&e||!Zo.a.isArchivedChat(s)&&!e)&&!un.a.isThreadHidden(s)&&this.addTabUnreadFiltered(s,h,i,m):this.listFiltered=this.genListArchivedChat(this.listVisible,e,this.labelFilters),this.signalRenderList("all",m)}this.smartDispatchEvent(ai.c.PreviewChanged,(()=>new ai.a(ai.c.PreviewChanged,e.convId,{changedItem:e})))}addTabAllFiltered(e,t,s,a=!1){if(t){const[t,s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList("all",a))}else s&&this.signalRenderList("all",a)}addTabUnreadFiltered(e,t,s,a=!1){if(this.listFiltered.includes(e)||!$r.default.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e,a);else{if(this.labelFilters.length)return;this.isUnboxStrangerAccount()||!s?this.addConvToUnreadFilterV2(e,a):this.addConvToUnreadFilterV2(Y.CONV_FILTER.STRANGER,a)}}addTabStrangerFiltered(e,t,s=!1){if(!t)return;const[a,i]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=a,this.signalRenderList("all",s))}addConvToUnreadFilterV2(e,t=!1){const[s,a]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());a&&(this.listFiltered=this.safeSortConvList(s,!1),this.signalRenderList("all",t))}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const a=e[s].priority,i=e[s].id;a?(this.onPreviewChange({convId:i},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(i)||!this.convDataManager.isRespondedByMeSync(i)&&Bo.ConvList.isStrangerV2(i))&&(this.listVisible=this.listVisible.filter((e=>e!==i))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==jo.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,"htVK9D","onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!me.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isUnboxStrangerAccount()||!Bo.ConvList.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=Bo.ConvList.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===jo.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=zo.a.getItem(t);Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:Go.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),Ia.default.logAction(14521)}selectConversation(e){if(xo.b.startPerf(xo.a),e.userId===Y.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,"VL9Dx-","No handler for mediabox. This feat disable!!!");if(e.userId===Y.CONV_FILTER.STRANGER)return void(2==Number(we.default.getConvUXVersion())?this.applyTypeFilter(jo.FilterType.STRANGER):this.labelDataManager.onSelectLabel(ko.g));const t=this.sidebarController.getState(hr.c).selectedId;e.userId===t&&e.userId!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Ao.f)({type:ve.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,nl)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,nl,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)),Vo.b.getCurrentStepKey()!==Vo.a.UPLOAD_IMAGES||this.showedOnboarding||(Vo.b.show(),this.showedOnboarding=!0),Ia.default.logAction(13901)),e.userId===Y.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Ao.f)({type:ve.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(I.a)({},e)}):a.ModuleContainer.resolve(Q.b).openConversation(e.userId,Q.d.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!we.default.checkBroadcastTime())return void Wo.default.createError(le.a.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=zo.a.getItem(this.labelFilters[0])||!0),null!==(e=Ce.default.broadcast_resend_config)&&void 0!==e&&e.enable?Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),Ia.default.logAction(1453102)}markAsRead(e,t=null){e&&(e.preventDefault(),e.stopPropagation()),Ia.default.logAction(164),we.default.isShowMarkAsReadAgain()?qo.ConfirmManagerV2.openConfirm({windowId:hr.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:le.a.str("STR_MARK_READ_CONFIRM_TEXT"),okText:le.a.str("STR_CONFIRM"),okType:"primary",cancelText:le.a.str("STR_LOGOUT_NO"),onOk:e=>{we.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=Ko.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=Ko.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[ko.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,"i2x_Nb","getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==jo.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}isPreviewLoaded(){return this.loaded}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(Uo.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(Uo.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(Uo.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=a.ModuleContainer.resolve(En.PreviewDataManager);e.addEventListener(ai.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(ai.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(ai.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(ai.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(ai.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(ai.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(ai.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.muteDataManager.addEventListener(ai.b.MuteChanged,this.handleMuteChange),Ii.default.subscribeEventFriend(Y.EventFriend.ADD_FRIEND,(({userId:e})=>{let t=0;this.listStrangers.includes(e)&&(t++,this.listStrangers=this.listStrangers.filter((t=>t!==e)),e==this.newestStrangerId&&(t++,this.updateNewestStrangerId(this.listStrangers))),this.onPreviewChange({convId:e},[]);const s=Ii.default.isFriend(e);this.logger.zsymb(0,"VmZgN9",`on add friend ${e} ${t} ${s}`)})),Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(({userId:e})=>{let t=0;!this.listStrangers.includes(e)&&this.listVisible.some((t=>t===e))&&(t++,this.listStrangers.push(e)),this.logger.zsymb(0,"87qh9p",`on remove friend ${e} ${t}`)})),Ii.default.subscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),Ii.default.subscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),this.conversationUIUpdater.addEventListener(En.ConversationUIUpdaterEvent.FLUSH_QUEUE_LIST,(()=>{this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100))))})),this.conversationUIUpdater.addEventListener(En.ConversationUIUpdaterEvent.SIGNAL_RENDER_LIST,(()=>{this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100))))}))}),0)}addToListFiltered(e,t=!1){e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=Bo.ConvList.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t=!1){if(this.typeFilter===e&&!t)return;this.logger.zsymb(0,"036u0r","applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case jo.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(ko.g)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case jo.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==jo.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=Bo.ConvList.filterByLabel(e,this.labelFilters),this.labelFilters.includes(ko.g)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=Bo.ConvList.filterByUnread(this.listFiltered),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0)}else this.listFiltered=Bo.ConvList.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case jo.FilterType.STRANGER:this.listFiltered=Bo.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=Bo.ConvList.filterByResponsed(this.listFiltered,!1));break;case jo.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case jo.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}const a=this.getList({key:"all",version:0,extraData:{}});this.dispatchEvent(new ai.h(a.slice(0,50))),this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters===e)return;switch(this.logger.zsymb(0,"R9dhTs","applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case jo.FilterType.ALL:if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==ko.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case jo.FilterType.UNREAD:if(this.listFiltered=Bo.ConvList.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==ko.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=Bo.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=Bo.ConvList.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case jo.FilterType.STRANGER:this.listFiltered=Bo.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=Bo.ConvList.filterByResponsed(this.listFiltered,!1));break;case jo.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case jo.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}const t=this.getList({key:"all",version:1,extraData:{}});this.dispatchEvent(new ai.i(t.slice(0,50))),this.signalRenderState(),this.signalRenderList()}showStrangerNROnly(){return!this.isUnboxStrangerAccount()}isUnboxStrangerAccount(){const e=$o.c.isUnboxStranger();return this.logger.zsymb(0,"Gj-Kv-","isUnboxStrangerAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=Bo.ConvList.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t=!0){const s=e.indexOf(Y.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const a=(e=Bo.ConvList.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[a]=Y.CONV_FILTER.STRANGER}else e=Bo.ConvList.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||un.a.isThreadHidden(s))return!1;const a=zo.a.getLabelObjByConversaionId(s);return!(!a||!t.some((e=>e==a.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||un.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(Y.GROUPID_PREFIX))||!!hn.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==jo.FilterType.UNREAD){this.logger.zsymb(0,"KIyZnX","addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,"zv2J_C",`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((a=>{const i=this.unreadDataManager.getUnreadByConvIdSync(a);if(i&&(i.smsUnreadCount>0||i.unreadMark)){if(this.logger.zsymb(0,"yfKQpn",`markConvsAsRead #2, ${a}, ${i.smsUnreadCount}`),e&&!e.hasOwnProperty(a)||a===Y.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const n=zo.a.getLabelObjByConversaionId(a)||{},r=this.convDataManager.getConvByIdSync(a)||{userId:a};(s||this.labelFilters.some((e=>e==n.id))||Bo.ConvList.isInStrangerBoxV2(a)&&this.typeFilter===jo.FilterType.STRANGER)&&t.push(r)}})),this.logger.zsymb(0,"FQsj7U",`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(_e.default.send(ve.SideBarActions.MARK_AS_READ,{conversations:t}),Ia.default.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,"WUK-wm",`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=we.default.getConvUXVersion();this.isEnableArchivedChat=!!Zo.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?jo.FilterType.FOCUSED:jo.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const a=Ce.default.sendToMeId;this.listRawAll.has(a)||(t.push(a),this.listRawAll.add(a)),this.logger.zsymb(0,"8UdX7m",`onload Preview 2: ${t.length}`),Bo.ConvList.groupConversation(t).then((e=>{if(this.logger.zsymb(0,"nd08mE",`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),Ce.default.stagingAccount)for(const a in e)this.logger.zsymb(0,"oixJVq",`${a}: ${e[a]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,"2c0_G0",`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===jo.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,"d5JrRW",`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new ai.a(ai.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,"XVcUnb",`onMigratedPreview #1: ${this.listVisible}`);const e=we.default.getConvUXVersion();this.isEnableArchivedChat=!!Zo.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?jo.FilterType.FOCUSED:jo.FilterType.ALL;const t=Ce.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,"K-cIWs","onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=Me.g.getFlagForCurrentUser(null,"z_sendtome"),t=Ce.default.sendToMeId,s=!(Ce.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,"9n5hPw","initMyCloud",e,Ce.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?Ia.default.logAction(1390703):(Me.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),Ia.default.logAction(1390702))}else if(s){const e=me.a.PinDataManager.getTotalPinnedConversation()>=Ce.default.limit_pin_messages,s=Ce.default.auto_pin_send2me&&!Me.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,Y.CONV_OT_STATE.none,{}),s&&(me.a.PinDataManager.pin([t]),Me.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),Me.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isUnboxStrangerAccount())return e.concat(t);{const s=Bo.ConvList.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=Bo.ConvList.getNewestConvFromIds(s);e.includes(Y.CONV_FILTER.STRANGER)||e.push(Y.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,"XHiZOY","onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=Bo.ConvList.sortConvId(this.listFiltered,!1,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=zo.a.getLabelObjByConversaionId(t),a=s?s.id:null;this.labelFilters.includes(""+a)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,"LuwZyX","moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isUnboxStrangerAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[Y.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isUnboxStrangerAccount())return;const t=Bo.ConvList.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=Bo.ConvList.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==Y.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=Bo.ConvList.insertToProperPosition(this.listVisible,Y.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}async rebuildList(){this.logger.zsymb(0,"kXxJJK",`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=await Bo.ConvList.groupConversation(e);if(this.logger.zsymb(0,"oICQZG",`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),Ce.default.stagingAccount)for(const i in t)this.logger.zsymb(0,"CuWTDE",`${i}:, ${t[i]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),a=this.safeSortConvList(s,!1);this.listVisible=a,this.logger.zsymb(0,"yOMW4-",`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==jo.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,Ce.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,"5L7l7B",`handleUserPackageChange: ${Ii.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e="all",t=!1){this.logger.zsymb(12,"EnKl7u","signalRenderList shouldBatching",t),t?this.conversationUIUpdater.signalRenderList(this.name,e):(Object(Po.i)(this.name,e),this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100)))))}signalRenderState(){Object(Po.h)(this.name,hr.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===jo.FilterType.UNREAD?(Ia.default.logAction(1453103),t||Ia.default.logAction(1453107)):this.typeFilter===jo.FilterType.ALL?(Ia.default.logAction(1453104),t&&Ia.default.logAction(1453108)):this.typeFilter===jo.FilterType.FOCUSED?Ia.default.logAction(1453501):this.typeFilter===jo.FilterType.ARCHIVED&&Ia.default.logAction(1453502),t)Ia.default.logAction(1453105);else{Ia.default.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){Ia.default.logAction(1453109);break}}}this.typeFilter==jo.FilterType.ARCHIVED&&Zo.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===hr.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,typeFilterSrc:this.typeFilterSrc}:il}getList(e){return e.key===hr.c||this.typeFilter==jo.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===ko.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===Y.CONV_FILTER.STRANGER||t.userId===Y.CONV_FILTER.MEDIA)return;const s=Object(I.a)({},t),a=s.userId;if(s&&!ui.default.isFakeId(a)){const e=this.previewManager.getPreviewByIDSync(a),t=Ii.default.getProfileFriendByIdSync(a)||{},i=this.unreadDataManager.getUnreadByConvIdSync(a);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==i?void 0:i.unreadMark,s.smsUnreadCount=null==i?void 0:i.smsUnreadCount}this.menuRef[ko.b].updateTargetInfo(s),this.menuRef[ko.b].showAction(Object(I.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===jo.FilterSrcType.UNREAD?Bo.ConvList.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===jo.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;Ia.default.logAction(e)}}genListArchivedChat(e,t,s,a=!0,i=!0){let n=[];n=Bo.ConvList.filterByLabel(this.getListFilterSrc(e),s),s.length&&i&&this.typeFilterSrc!==jo.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(n,s);let r=this.getListFilterSrc(this.listStrangers).filter((e=>(Zo.a.isArchivedChat(e)&&t||!Zo.a.isArchivedChat(e)&&!t)&&!un.a.isThreadHidden(e)));return s.includes(ko.g)&&1==s.length?this.isUnboxStrangerAccount()||(r=Bo.ConvList.filterByResponsed(r,!1)):s.includes(ko.g)||(r=Bo.ConvList.filterByLabel(r,s)),n=n.filter((e=>!(this.typeFilter===jo.FilterType.ARCHIVED||!r.length||e!=Y.CONV_FILTER.STRANGER)||(Zo.a.isArchivedChat(e)&&t||!Zo.a.isArchivedChat(e)&&!t)&&e!==Y.CONV_FILTER.STRANGER&&!Bo.ConvList.isStrangerV2(e)&&!un.a.isThreadHidden(e))),a&&(this.typeFilter===jo.FilterType.ARCHIVED?n=n.concat(r):this.isUnboxStrangerAccount()||s.length?(this.isUnboxStrangerAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(n=n.concat(r)):n=this.addStrangersToVisible(n,r)),n=n.filter(((e,t)=>n.indexOf(e)==t)),this.safeSortConvList(n,!1)}isChatVisible(e){return this.listVisible.includes(e)}updateListArchivedChat(){this.typeFilter==jo.FilterType.FOCUSED?this.onTypeFilterChange(jo.FilterType.FOCUSED,!0):this.typeFilter==jo.FilterType.ARCHIVED&&this.onTypeFilterChange(jo.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!Ce.default.enable_archived_chat)return;const t=we.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==jo.FilterType.ARCHIVED&&this.typeFilter!==jo.FilterType.FOCUSED?e&&this.onTypeFilterChange(jo.FilterType.FOCUSED,!0):this.onTypeFilterChange(jo.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc(jo.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}})||al)||al)||al)||al)||al)||al)||al)||al)||al);var rl,ol=s("BR4E"),ll=s("R5gT"),cl=s("Xzw3"),dl=s("uEOi"),ul=s("4prX"),hl=s("kTC5"),gl=s("ES/k"),ml=s("uAQs"),pl=s("WBqA"),fl=s("qa8q"),vl=s("vAzq");const _l={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},bl=new ui.LocalId;var Il=function(e){return e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY",e}(Il||{});const yl=e=>ui.default.md5(e);Object(m.d)()(rl=Object(Ai.b)(jo.SearchController)(rl=function(e,t){return a.ModuleContainer.inject(ii.b)(e,void 0,0)}(rl=function(e,t){return a.ModuleContainer.inject(En.ConvInfoDataManager)(e,void 0,1)}(rl=function(e,t){return a.ModuleContainer.inject(En.PreviewDataManager)(e,void 0,2)}(rl=Reflect.metadata("design:type",Function)(rl=Reflect.metadata("design:paramtypes",[void 0===ii.b?Object:ii.b,void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager,void 0===En.PreviewDataManager?Object:En.PreviewDataManager])(rl=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.isSearchingMsg=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._timeDebounceSearch=null,this.dataLoaded=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let a=0;a<t.length;a++)if(t[a].userId==e){t.splice(a,1),this.updateState(Object(I.a)(Object(I.a)({},s),{},{searchResult:Object(I.a)(Object(I.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let a=0;a<t.length;a++)if(t[a].userId==e){t.splice(a,1),this.updateState(Object(I.a)(Object(I.a)({},s),{},{searchResult:Object(I.a)(Object(I.a)({},s.searchResult),{},{friends:t})}));break}}},this._recordedCPUUsageTs=void 0,this.name=jo.SEARCH_CONTROLLER,this.key="windowId",this.state=_l,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this.isSearchingMsg=!1,this.dataLoaded=null,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=ui.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMoreMessagesV2=this.loadMoreMessagesV2.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=a.ModuleContainer.resolve(jo.SidebarController)),this._sbc}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case ve.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case ve.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case ve.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}));break;case ve.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case ve.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==Q.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){J.p.getDebugSearch().showLogSearchFlow}updateState(e,t=!0){this.state=e,t&&Object(Po.h)(this.name,hr.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return gl.a.formatTextSearch(e)!==gl.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case hl.c.SEARCH_RESULT:this.searchResultList=t;break;case hl.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(I.a)({},_l))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==Y.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&Ia.default.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,Ia.default.logAction(1232002)}),3e3)),e.which==Y.K_ESC){if(!0===this.isShowRecentSearch){{const e=we.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===Cn.e.FULL&&(null==e||!e.dissmis))return}this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()}""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0)}else if(e.which==Y.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():un.a.isThreadHidden(t)||_e.default.send(ve.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:hr.c})}),0)}}else if(e.which==Y.K_UP||e.which==Y.K_DOWN){this.searchResultList&&Ia.default.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==Y.K_UP?t.moveUp():t.moveDown())}}onAbortSearch(){ll.a.getInstance().abortSearch()}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=ui.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=Oa.a.now(),this.countSelectTopRes=0),s){const e=gl.a.formatTextSearch(this.lastTextSearch),t=gl.a.formatTextSearch(s);ui.default.log("searching: true"),Ce.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,Ia.default.logAction(12318)),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchText:s})),this.countQuery=bl.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else{this._resetCacheResultSearch();ll.a.getInstance().abortSearch(),this.clearSearch(!1)}}onFocusInput(){pl.a.onNewSession(hr.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusSearchBox:!0})),Ia.default.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),Ia.default.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){J.p.resetGlobalSearchMode(),this.state.conversation&&Ia.default.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),Ia.default.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),dl.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&dl.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&dl.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t=!1,s=!1){if(!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(Po.h)(this.name,hr.c)}onCloseSearch(){var e,t;Ia.default.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&Ia.default.logAction(1232202),this.qosLogSearch()}focusSearchBox(e=!1){this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}isSearchMode(){return!!(this.state.searchText||this.state.isFocusOnRecentSearch||this.state.isFocusSearchBox)}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadCachedMessages(e,t,s){var a,i;if(!this.dataLoaded)return void(s&&s(null,-1));let n="";if(!this.state.searchText)return;n=this.state.searchText;const r=()=>!(!this.state.searchText||!this.isKeywordStale(n)),o=!(!e||!e.timeFrom&&!e.timeTo&&"string"!=typeof e.sender),l=[],c=t?this.dataLoaded.indexCurrent:0,d=Math.min(c+20,this.dataLoaded.allSearchedMsgs.length);if(t||delete this.dataLoaded.oldestIndex,e&&e.timeFrom&&this.dataLoaded.oldestIndex&&d>=this.dataLoaded.oldestIndex)return void(s&&s(null,-1,!1));if(d<=c)return void(s&&s(null,-1,!1));this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!0}));let u=this.dataLoaded.allSearchedMsgs.slice(c,d);this.dataLoaded.indexCurrent=d;const h=a=>{let i=[];if(this.loadingMore=!1,this.isSearchingMsg=!1,r())s&&s(null,-1);else if(a&&a.listConv&&a.arr){const c=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let e=0;e<a.listConv.length;++e){const t=a.listConv[e],s=c.get(t);s&&!un.a.isThreadHidden(t)&&(a.arr[e].conversation=s)}if(a.arr.forEach((t=>{if(o){if(!t.message)return;if(e&&"string"==typeof e.sender&&e.sender!==t.message.fromUid)return;if(e&&e.timeFrom&&e.timeFrom>t.message.sendDttm)return void(this.dataLoaded.oldestIndex=this.dataLoaded.indexCurrent);if(e&&e.timeTo&&e.timeTo<t.message.sendDttm)return}Object.keys(t.conversation).length>1&&i.push(t)})),Array.prototype.push.apply(l,i),!r()&&this.isFirstLoadSuccess){if(t&&this.state.searchResult.messages){var n;const e=null===(n=this.state.searchResult.messages[this.state.searchResult.messages.length-1])||void 0===n?void 0:n.message;e&&e.sendDttm<a.maxTime?(i=this.state.searchResult.messages.concat(i),i=i.sort(((e,t)=>t.message.sendDttm-e.message.sendDttm))):i=this.state.searchResult.messages.concat(i)}this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{isMoreMsg:d<this.dataLoaded.allSearchedMsgs.length,messages:i}),searching:!1}));const r=!(o&&e.timeFrom&&d>=this.dataLoaded.allSearchedMsgs.length);s&&s(l,this.pageLoad,r)}}};ol.a.logTrace(`load more msg with key ${yl(n)} - msgID length: ${u.length} - ${d}/${null===(a=this.dataLoaded)||void 0===a||null===(i=a.allSearchedMsgs)||void 0===i?void 0:i.length}`),this.isSearchingMsg=!0;ll.a.getInstance().getMessages(u,r).then((e=>{h(e)})).catch((e=>{s&&s(null,-1)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}))}))}loadMessagesV2(e,t=!1,s){return this.loadCachedMessages(e,t,s)}loadMoreMessagesWithMsgIdsLoaded(e,t=!1,s){return this.loadCachedMessages(e,t,s)}isCanLoadMoreWithMsgIdsLoaded(){return!!(this.dataLoaded&&ui.default.valueValid(this.dataLoaded.indexCurrent)&&ui.default.valueValid(this.dataLoaded.allSearchedMsgs))&&!(this.dataLoaded.allSearchedMsgs.length<=this.dataLoaded.indexCurrent)}loadMoreMessagesWithRange(e,t,s,a){var i,n,r;let o=this.state.searchText;if(!o)return;let l=null===(i=this.searchResultList)||void 0===i?void 0:i.getRange(!t);if(!this.oldestTime||l.timeTo<this.oldestTime)return;const c=!(!a||!a.timeFrom&&!a.timeTo&&"string"!=typeof a.sender),d=()=>!(!this.state.searchText||!this.isKeywordStale(o));this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:t?null===(n=this.state.searchResult)||void 0===n?void 0:n.messages:null,isMoreMsg:!!t&&(null===(r=this.state.searchResult)||void 0===r?void 0:r.isMoreMsg)}),searching:!0}));const u=e=>{this.isSearchingMsg=!1;let i=[],n=[];if(d())return this.pageLoad++,void(s&&s(null,-1));if(!e||!e.listConv||!e.arr)return void(s&&s(null,-1));const r=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let t=0;t<e.listConv.length;++t){const s=e.listConv[t],a=r.get(s);a&&!un.a.isThreadHidden(s)&&(e.arr[t].conversation=a)}e.arr.forEach((e=>{c&&a&&"string"==typeof a.sender&&a.sender!==e.message.fromUid||Object.keys(e.conversation).length>1&&n.push(e)})),Array.prototype.push.apply(i,n),t&&(n=this.state.searchResult.messages.concat(n)),this.dataLoaded?(e.dataLoaded.allSearchedMsgs&&(this.dataLoaded.allSearchedMsgs=this.dataLoaded.allSearchedMsgs.concat(e.dataLoaded.allSearchedMsgs)),e.dataLoaded.indexCurrent&&(this.dataLoaded.indexCurrent+=e.dataLoaded.indexCurrent)):this.dataLoaded=e.dataLoaded;const o=!(c&&a.timeFrom&&n.length<this.dataLoaded.allSearchedMsgs.length);this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:n,isMoreMsg:!(!n.length&&!this.dataLoaded.allSearchedMsgs.length)&&n.length<this.dataLoaded.allSearchedMsgs.length}),searching:!1})),s&&s(i,this.pageLoad,o)};let h={totalItemReq:4};ol.a.logTrace(`load more msg with range: ${l.timeFrom} - ${l.timeTo}`),this.isSearchingMsg=!0;ll.a.getInstance().searchGlobalMessagesV3(o,d,void 0,null,Ce.default.limit_result_msg_search+1,l,h).then((e=>u(e))).catch((e=>{this.loadingMore=!1,s&&s(null,-1),ui.default.logCoreError("searchGlobalMsg v2 "+e)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}))}))}loadMoreMessagesV2(e,t=!1,s,a){if(this.isFirstLoadSuccess&&!this.isSearchingMsg)return Ce.default.enable_optimize_search&&!ml.a.isSearchOnSqlite3()?this.loadCachedMessages(a,t,s):t&&this.isCanLoadMoreWithMsgIdsLoaded()?this.loadMoreMessagesWithMsgIdsLoaded(a,t,s):(t||(this.dataLoaded=null),this.loadMoreMessagesWithRange(e,t,s,a));s&&s(null,-1)}loadMoreMessages(){let e=this.state.searchResult;if(ml.a.isSearchOnSqlite3()&&e&&e.rawSearchResult&&e.messageList&&e.rawSearchResult.length>e.lastOffset&&!this.loadingMore){this.loadingMore=!0;const t=this.state.conversation.userId;ll.a.getInstance().getMessageOfConversation(e.rawSearchResult,this.state.conversation.userId,20,e.lastOffset).then((s=>{let a=s.list;if(this.state.conversation&&t==this.state.conversation.userId){let t=ui.default.ZSafeFunction((()=>Math.max(0,e.rawSearchResult.length-e.lastOffset-20)+e.messageList.length+a.length),s.len);a.length>0?this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messageList:this.state.searchResult.messageList.concat(a.map((e=>({message:e,conversation:this.state.conversation})))),realLen:t,lastOffset:this.state.searchResult.lastOffset+20})})):this.state&&this.state.searchResult&&(this.state.searchResult.realLen!==t?this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{realLen:t,lastOffset:e.lastOffset+20})})):this.state.searchResult.lastOffset+=20)}this.loadingMore=!1}))}}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;if(e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles){this.loadingMoreFiles=!0;const s=e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20),i=new Map;s.forEach((e=>{const t=e.convId;i.has(t)||i.set(t,[]),i.set(t,i.get(t).concat(e.msgId))}));const n=a.ModuleContainer.resolve(Re.a),r=[];i.forEach(((e,t)=>{r.push(n.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(r).then((a=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const i=s.map((e=>{const t=a.find((t=>t.convID===e.convId));if(t)return t.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let n=ui.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+i.length),e.realFileLen),r=this.state.searchResult.files.concat(i);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{files:r,realFileLen:n,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,ui.default.logCoreError("_loadMoreFiles ",e)}))}}qosLogSearch(){this.countTimeUseGlobalSearch&&(ul.default.increaseSuccess(97111,0,Oa.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(ul.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t=!1,s=!1,a=!1){var i;const n=Ce.default.search_message.global.enable_ux_enhance?gl.a.formatTextSearch(this.state.searchText):this.state.searchText;let r=!!this.state.conversation;xr.a.jumpToMessage(e.message,null===(i=e.conversation)||void 0===i?void 0:i.userId,Ao.f).then((t=>{const{groupMsgs:s=[]}=t;let a=null;ui.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return a=Object(I.a)({},s[t]),void(a.searchKeyWord=n)}),null),this.state.searchText&&dl.a.addCacheKeyword(this.state.searchText),_e.default.send(ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),a&&Object(Ao.f)({type:ve.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:a})})).catch((t=>{ui.default.logCoreError(t),Wo.default.createWarning(le.a.str("STR_MESSAGE_NOT_FOUND")),a||_e.default.send(ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),r?(s&&this.focusSearchBox(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===Ce.default.recent_search.is_enable)return[];let e=dl.a.getLocalRecentSearchList();if(!e)return[];let t=hn.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!un.a.isThreadHidden(e.userId)){if(e.userId.startsWith(Y.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(Y.GROUPID_PREFIX)||(e.userId=Y.GROUPID_PREFIX+e.userId);for(let a of s)if(a.userId&&e.userId==a.userId){t=!0;break}return!!t||(dl.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),Ce.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=dl.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e=!0){if(this._resetCacheResultSearch(),this.onAbortSearch(),this.dataLoaded=null,this.searchInput.value="",this.lastTextSearch="",e){if(cl.b.setMode(cl.a.NORMAL),this.updateState(Object(I.a)({},_l)),this.sidebarController.getState(hr.c).currentTab==jo.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),Ce.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,Ce.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),Ce.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===Ce.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s=!0){if(!bl.valid(t))return;if(this.sidebarController.getState(hr.c).currentTab===jo.SidebarTab.FILE_TAB)_e.default.send(ve.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),i=gl.a.formatTextSearch(e);var a;if(this.logSearch(`[Search flow] start search-------: ${t}, ${yl(i)}`),!i)null===(a=this.searchResultList)||void 0===a||a.forceStopSearch(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}debounceSearchMsgAndFile(e,t){this._timeDebounceSearch&&clearTimeout(this._timeDebounceSearch),this._timeDebounceSearch=setTimeout((()=>{e()}),t)}getTimeDebounceSearchMsgAndFile(){return ll.a.getInstance().isEnableSearchSqlite?Ce.default.debounce_search_msg:Ce.default.debounce_search_msg_optimize}_searchGlobal(e,t=!0){var s,i,n,r,o,l;Fa.default.createCPUUsageRecorder(Fa.CPUMetricName.search_global).start().then((e=>this._trackCPUUsageOnSearching(e))),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let c=2,d=0,u={},h=this.convDataManager.getAllConvSync(),g=this.previewDataManager.getAllPreviewsForSearch(),m=ui.default.simpleStripVietnamese(e,!1);const p=(s,a)=>{s!==Il.STEP_DIRECTORY&&s!==Il.STEP_FILES&&c--;let i,n=1==c&&s===Il.STEP_CONTACT&&0==d;if(i=!!(c>1||n),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:a,searching:i})),s===Il.STEP_CONTACT&&t&&(Ce.default.enable_optimize_search?this.debounceSearchMsgAndFile((()=>{f()?ol.a.logTrace(`abort debound search msg: ${yl(e)}`):(ol.a.logTrace(`do search msg & file: ${yl(e)}`),_(a&&!a.all.length),Ce.default.tabbedGlobalSearchResult&&cl.b.setMode(cl.a.SEARCHING),Ce.default.enableFileGlobalSearch&&v())}),this.getTimeDebounceSearchMsgAndFile()):(_(a&&!a.all.length),Ce.default.tabbedGlobalSearchResult&&cl.b.setMode(cl.a.SEARCHING),Ce.default.enableFileGlobalSearch&&v())),0==c&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}this.isKeywordStale(e)||this._trackPerformanceSearch(s,a,Date.now()-this.lastTextSearchTs)},f=()=>!!this.isKeywordStale(e),v=()=>{if(Ce.default.adminConfig&&Ce.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Il.STEP_FILES,this.state.searchResult)}),100);const t=(t,s=!0)=>{var i,n;if(this.isKeywordStale(e))return;(null!=t&&t.length||!s)&&fl.a.fileUIVisible(Oa.a.now(),(null==t?void 0:t.length)||0);let r=new Set;const o=[];var l,c,u,h,g,m;if((t.forEach((e=>{const t=e.msgId;t&&!r.has(t)&&(r.add(t),o.push({msgId:t,convId:e.convId}))})),(null===(i=this.state.searchResult)||void 0===i||null===(n=i.rawFileResult)||void 0===n?void 0:n.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(l=this.state.searchResult)||void 0===l||null===(c=l.rawFileResult[0])||void 0===c?void 0:c.msgId)==(null===(u=o[0])||void 0===u?void 0:u.msgId)&&(null===(h=this.state.searchResult)||void 0===h||null===(g=h.rawFileResult[19])||void 0===g?void 0:g.msgId)==(null===(m=o[19])||void 0===m?void 0:m.msgId)))return void this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const f=o.slice(0,20),v=new Map;f.forEach((e=>{const t=e.convId;v.has(t)||v.set(t,[]),v.set(t,v.get(t).concat(e.msgId))}));const _=a.ModuleContainer.resolve(Re.a),b=[];v.forEach(((e,t)=>{b.push(_.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(b).then((t=>{if(this.isKeywordStale(e))return;const s=f.map((e=>{const s=t.find((t=>t.convID===e.convId));if(s)return s.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let a=[],i=0,n=0;for(const e of s)e?(a.push(e),i++):n++;a.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;ui.default.log("search files: cur = "+r.searchKey+" this query = "+yl(e),a.length),r=r?Object(I.a)({},r):{},r.files=a,r.realFileLen=o.length-n,r.rawFileResult=o,r.lastFileOffset=f.length,r.searchKey=e,d+=i,p(Il.STEP_FILES,r)})).catch((t=>{ui.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&p(Il.STEP_FILES,this.state.searchResult)}))};fl.a.startQueryFile(Oa.a.now());ll.a.getInstance().search(e,null,{msgType:Y.MSG_FILE},t,{enableReject:!0}).then((e=>{t(e,!1)})).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},_=(t=!1)=>{if(Ce.default.adminConfig&&Ce.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Il.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${yl(e)}`);const s=(t,s=!1)=>{var a;if(s&&(this.isSearchingMsg=!1),this.logSearch(`[Search flow] search msg res first load: ${yl(e)}, ${null===(a=t.arr)||void 0===a?void 0:a.length}`),this.pageLoad=0,this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null})}),!1)),!this.isKeywordStale(e)&&t){let a=[],r=0;t&&t.listConv&&t.arr&&h.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!un.a.isThreadHidden(e.userId))for(let i=s;i<t.listConv.length;++i)t.listConv[i]==e.userId&&(t.arr[i].conversation=e,r+=1,a.push(t.arr[i]))}));let o=this.state.searchResult,l=a;var i;if(o.messages&&(l=o.messages.slice(),Array.prototype.push.apply(l,a)),l.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(I.a)({},o):{},o.messages=l,o.searchKey=e,o.isMoreMsg=t.isMoreMsg,this.dataLoaded=t.dataLoaded,d+=r,s)this.isFirstLoadSuccess=!0,this.searchResultList&&n&&this.searchResultList.updateFirstLoadPos(n.timeFrom),ui.default.logCoreError("[Global search] check First data",yl(e),null===(i=this.state.searchResult.messages)||void 0===i?void 0:i.length);else if(!a.length)return;p(Il.STEP_MESSAGES,o)}};let a=null;var i;this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch(),ml.a.isSearchOnSqlite3()&&(a=null===(i=this.searchResultList)||void 0===i?void 0:i.getRange(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{filter:{timeFrom:a.timeFrom,timeTo:a.timeTo}}),!1)));const n=Object(I.a)({},a);this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1;let r={};t||(r.totalItemReq=4);const o=ll.a.getInstance();fl.a.startQueryMsg(Oa.a.now(),o.isEnableSearchSqlite),this.isSearchingMsg=!0,o.searchGlobalMessagesV3(e,(()=>!(!ml.a.isSearchOnSqlite3()||this.state.filter.timeFrom==n.timeFrom&&this.state.filter.timeTo==n.timeTo)||f()),void 0,s,Ce.default.limit_result_msg_search+1,a,r).then((e=>s(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),ui.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],p(Il.STEP_MESSAGES,e)}})).finally((()=>{this.isSearchingMsg=!1}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!u[e]&&(null!=t&&t.userId||(t.userId=e),null!=t&&t.infoSearch&&delete t.infoSearch,null!=t&&t.isDirectory&&delete t.isDirectory,u[e]=t)}};g.length&&e(g),e(Ii.default.getFriendsSync()),e(hn.default.getGroupsListSync())}const b=Oa.a.now();fl.a.setKeyword(e),fl.a.resetTracking(),Dr.a.search(e,this.cacheResSearch?this.cacheResSearch:u,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:un.a.isKeyPIN(e)}).then((t=>{var s;fl.a.trackingContact(Oa.a.now()-b,null==t||null===(s=t.all)||void 0===s?void 0:s.length);let a=this.state.searchResult;if(!this.isKeywordStale(e)){{var i;let s=[];if(un.a.isKeyPIN(e)){Ia.default.logAction(1970601);const e=un.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let a of h)if(a&&a.userId==t){s.push(Object(I.a)(Object(I.a)({},a),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(Y.GROUPID_PREFIX)?hn.default.getGroupByIdSync(t):Ii.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),s.push(Object(I.a)(Object(I.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=u),null!==(i=t.phone)&&void 0!==i&&i.length&&(t.phone=t.phone.filter((e=>e.userId))),a=a?Object(I.a)({},a):{},a.recentChat=t.recentChat,a.groups=t.groups,a.friends=t.friends,a.oa=t.oa,a.directory=t.directory,a.searchKey=e,a.phone=t.phone,a.hiddenChat=s,a.all=t.all,a.orderAll=t.orderAll,d+=(a.groups?a.groups.length:0)+(a.friends?a.friends.length:0)+(a.oa?a.oa.length:0),d+=(a.recentChat?a.recentChat.length:0)+a.hiddenChat.length}p(Il.STEP_CONTACT,a)}})).catch((e=>{ui.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(i=s.messages)||void 0===i?void 0:i.length)&&0==(null===(n=this.state.searchResult)||void 0===n||null===(r=n.all)||void 0===r?void 0:r.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(l=o.files)||void 0===l?void 0:l.length)&&Ia.default.logAction(1232201),m===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,Ia.default.logAction(1232010))}filterByConversation(e,t){if(!e)return this.searchInput.value="",void this.updateState(Object(I.a)(Object(I.a)({},_l),{},{conversation:t,searching:!1,highlightId:""}));let s=(s,a=!1)=>{if(this.isKeywordStale(e))return void ui.default.logCoreError("search: abort filtermode 1",yl(this.state.searchText),yl(e));if(a&&(!s||0==s.length))return;ll.a.getInstance().getMessageOfConversation(s,t.userId,20).then((i=>{if(this.isKeywordStale(e))return void ui.default.logCoreError("search: abort filtermode 2",yl(this.state.searchText),yl(e));let n=i.list;if(a&&(!n||0===n.length))return;let r=n.length<20&&s.length>20;n.length>0?(this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{conversation:t,searchResult:{messageList:n.map((e=>({message:e,conversation:t}))),realLen:i.len,rawSearchResult:s,lastOffset:20,progress:a},searching:!1,highlightId:n[0].msgId})),a||(this.focusSearchBox(),r&&this.loadMoreMessages()),!a&&this.searchResultList&&this.searchResultList.scrollToTop&&this.searchResultList.scrollToTop()):(this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),this.focusSearchBox(),!a&&r&&this.loadMoreMessages())}))};ll.a.getInstance().search(e,null,{convId:t.userId+""},(e=>{s(e,!0)})).then((e=>{s(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){ui.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=ui.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}_trackPerformanceSearch(e,t,s){var a,i,n,r,o;const l={[Il.STEP_MESSAGES]:"msg",[Il.STEP_FILES]:"file",[Il.STEP_CONTACT]:"contact"}[e];let c={[Il.STEP_MESSAGES]:null==t||null===(a=t.messages)||void 0===a?void 0:a.length,[Il.STEP_FILES]:null==t||null===(i=t.files)||void 0===i?void 0:i.length,[Il.STEP_CONTACT]:((null==t||null===(n=t.groups)||void 0===n?void 0:n.length)||0)+((null==t||null===(r=t.friends)||void 0===r?void 0:r.length)||0)+((null==t||null===(o=t.oa)||void 0===o?void 0:o.length)||0)}[e]||0;if(l&&c){Object(vl.b)().logInfo(vl.a.GlobalSearch,{duration:s,search_type:l,result_size:c})}}_trackCPUUsageOnSearching(e){if(!e||this._recordedCPUUsageTs&&this._recordedCPUUsageTs>=e.endAt)return;this._recordedCPUUsageTs=e.endAt;Object(vl.b)().logInfo(vl.a.CPU_GlobalSearch,{cpu:e.cpu,duration:e.endAt-e.startAt,process:e.processes.map((e=>({cpu:e.cpu,name:e.name,type:e.type})))})}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}onApplicationReady(){this.loadOldestTime()}loadOldestTime(){this.loadOldestTimeWithRetry(Ce.default.sqlite_mac.max_load_oldest_time_retry).then((e=>{this.oldestTime=e})).catch((e=>{ol.a.logError("loadOldestTime fail after retrying",e),this.oldestTime=0}))}async loadOldestTimeWithRetry(e){return new Promise(((t,s)=>{ll.a.getInstance().getOldestTime().then((e=>{e&&e.length&&!isNaN(e[0].ts)?t(Math.max(+e[0].ts,1e12)):t(0)})).catch((a=>{ol.a.logError("loadOldestTime fail",`remaining times: ${e}`,a),e>0?setTimeout((()=>{this.loadOldestTimeWithRetry(e-1).then(t).catch(s)}),0):s(a)}))}))}getOldestTime(){return this.oldestTime}getTotalQueriedMsgIds(){var e,t;return null===(e=this.dataLoaded)||void 0===e||null===(t=e.allSearchedMsgs)||void 0===t?void 0:t.length}})||rl)||rl)||rl)||rl)||rl)||rl);var Sl,Cl=s("dThN"),El=s("jnrz"),Ol=s("Anfm"),Ml=s("BZLJ"),Tl=s("L+5E"),wl=s("BKm0"),Rl=s("iKSP"),Ll=s("uglG"),Dl=s("oMqy");const Al={windowId:hr.c,theme:wr.e.LIGHT,currentTab:jo.SidebarTab.MESSAGE_TAB,previousTab:jo.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},Fl="z_sendtome_bubbledot",kl="SIDEBAR CONTROLLER";function Nl(...e){ui.default.logCoreInfo(`[${kl}] - `,e)}Object(m.j)()(Sl=Object(Ai.b)(jo.SidebarController)(Sl=function(e,t){return a.ModuleContainer.inject(jo.ConvListController)(e,void 0,0)}(Sl=function(e,t){return a.ModuleContainer.inject(hl.b)(e,void 0,1)}(Sl=Reflect.metadata("design:type",Function)(Sl=Reflect.metadata("design:paramtypes",[void 0===jo.ConvListController?Object:jo.ConvListController,void 0===hl.b?Object:hl.b])(Sl=class{constructor(e,t){this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const a=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&Y.FILE_UP_SRC.TextEditor,i=this.getState();if(i.currentTab==jo.SidebarTab.TODO_TAB||i.currentTab==jo.SidebarTab.CATALOG_TAB||a||e.isChild)return;const n=this.searchController.getSearchState();i.currentTab!==jo.SidebarTab.MESSAGE_TAB||n&&n.searchText?(i.currentTab=jo.SidebarTab.MESSAGE_TAB,Object(Po.h)(this.name,hr.c),Object(Ao.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW}),n&&n.searchText&&Ia.default.logAction(1232007),this.searchController.clearSearch(!0)):i.currentTab==jo.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=(e,t=hr.c)=>{const s=this._getStateByWindowId(t);let a=s.currentTab;s.currentTab!==e&&(s.currentTab=e,Object(Po.h)(this.name,t)),this._onChangeTab(s.currentTab,a)},this.togglePerfTab=e=>{const t=this._getStateByWindowId(hr.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(Po.h)(this.name,hr.c))},this.changeTheme=async e=>{},this.selectMessageTab=()=>{this.changeTab(jo.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab(jo.SidebarTab.TODO_TAB),Ia.default.logAction(171),Ml.default.setViewPopupTodoSrc(Ml.POPUP_TODO_SRC.TAB_ICON)},this.selectContactFromSearch=async(e,t=!1)=>{if(!e)return Nl("Select friend null!"),Promise.resolve(!1);const s=await a.ModuleContainer.resolve(Q.b).openConversation(e.userId,Q.d.fromSearchList(e));return!0===t?(this.searchController.onCloseSearch(),this.searchController.resetState()):this.searchController.updateStateOf("highlightId",e.userId),s?(e&&e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,Fl)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,Fl,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)),Ia.default.logAction(1390101)),Promise.resolve(!0)):(Nl("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{},this.name=jo.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object(Ho.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){a.ModuleContainer.resolve(Q.b)}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case ve.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case ve.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=jo.SidebarTab.FILE_TAB,Object(Po.h)(this.name,hr.c);break;case ve.SideBarActions.SELECT_TAB_MSG:this.changeTab(jo.SidebarTab.MESSAGE_TAB);break;case ve.FetchActions.DELETE_CONVERSATION:case ve.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab!=jo.SidebarTab.FILE_TAB&&this.getState().currentTab!=jo.SidebarTab.ZCLOUD_TAB||this.changeTab(jo.SidebarTab.MESSAGE_TAB);break;case ve.TodoActions.OPEN_TODO_LIST:{const e=Ko.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab(jo.SidebarTab.TODO_TAB);break}case ve.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case ve.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab(jo.SidebarTab.CONTACT_TAB);break;case ve.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===jo.SidebarTab.CONTACT_TAB){const e=Ko.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab(jo.SidebarTab.CONTACT_TAB);break;case wl.c.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case wl.c.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case wl.c.IMPORT_DB_PROGRESS:case wl.c.IMPORT_PROGRESS:case wl.c.EXPORT_PROGRESS:case wl.c.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case ve.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==jo.SidebarTab.FILE_TAB&&e.currentTab!==jo.SidebarTab.CATALOG_TAB&&e.currentTab!==jo.SidebarTab.ZCLOUD_TAB||this.changeTab(jo.SidebarTab.MESSAGE_TAB);break}}})),me.a.ConvInfoDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),me.a.UnreadDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{El.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e=hr.c){return this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===Rl.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t=hr.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(Po.h)(this.name,t))}updateSelectedIdWithoutPrevious(e,t=hr.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=null,s.selectedId=e,Object(Po.h)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t=!1){if(!e)return void ui.default.logCoreError("friend null");if(Ao.f&&(Object(Ao.f)({type:ve.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object(Ao.f)({type:ve.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),a=!1;if(s)a=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(I.a)({},t[e.userId]))};s||t(hn.default.getGroupsListSync()),s||t(Ii.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||Y.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object(Ao.f)({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const i=this.data.get(hr.c);let n=null==i?void 0:i.currentTab;!0===t?(n=a?jo.SidebarTab.MESSAGE_TAB:jo.SidebarTab.CONTACT_TAB,n===jo.SidebarTab.CONTACT_TAB&&(ui.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&un.a.isThreadHidden(e.userId)||setTimeout((()=>{_e.default.send(ve.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:hr.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(I.a)(Object(I.a)({},i),{},{currentTab:n,selectedId:e.userId})),e&&e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,Fl)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,Fl,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){Ia.default.logAction(1020203),Ia.default.logAction(12316),Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.FIND_FRIEND})}async showGroupCompose(){Ia.default.logAction(1020202),Ol.c.markStart(Ol.a.CREATE_GROUP,Ol.b.Group.CREATE_GR_HEADER_ICON);const e=Dl.q.isAllowCreateCommunity();if(e)try{await a.ModuleContainer.resolve(Dl.e).checkCreateCondition(Dl.n.NORMAL)}catch{return Object(Ll.b)({windowId:hr.c})}const t=J.p.getSessionUserId(),s=(e=!0,t=!1)=>{Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e,showCreateOptions:t},forceCloseAll:!1})};!Me.g.getTimeEntryPointE2eGroup(t,Ol.b.Group.CREATE_GR_HEADER_ICON)&&Ce.default.e2ee.enable_group&&Ce.default.e2ee.group.can_enable_right_in_creation_step?Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:dt.e.CREATE_GROUP,entrySrc:Ol.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:s,callbackCancel:s},forceCloseAll:!1}):s(!1,e)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t=hr.c,s=!0){this.data.set(t,e),s&&Object(Po.h)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(I.a)({},Al),this.data.set(e,t)),t}_onChangeTab(e,t){switch(function(){switch(e){case jo.SidebarTab.MESSAGE_TAB:Ia.default.logAction(12801);break;case jo.SidebarTab.CONTACT_TAB:Ia.default.logAction(12802),3===Ce.default.noti_center_config.entry_position&&Ia.default.logAction(1281205);break;case jo.SidebarTab.MENTION_TAB:Ia.default.logAction(12805);break;case jo.SidebarTab.STAR_TAB:Ia.default.logAction(12806);break;case jo.SidebarTab.FILE_TAB:Ia.default.logAction(133);break;case jo.SidebarTab.TODO_TAB:3===Ce.default.noti_center_config.entry_position&&Ia.default.logAction(1281206)}}(),J.p.resetGlobalSearchMode(),this.searchController.getSearchInputRef()&&this.searchController.clearSearch(!0),e){case jo.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object(Ao.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW});break}case jo.SidebarTab.STAR_TAB:case jo.SidebarTab.TODO_TAB:t===jo.SidebarTab.ZCLOUD_TAB&&Object(Ao.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW})}}_showMyProfile(){Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let a=t[s].indexOf("=");if(a>=0){let i=t[s].slice(0,a),n=t[s].slice(a+1,t[s].length);i&&i.length>0&&n&&n.length>0&&(e[i]=decodeURIComponent(n))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(ui.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||Sl)||Sl)||Sl)||Sl)||Sl);var Pl;const jl={id:ko.f,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var Ul=function(e){return e.ALL="all",e.SELECTED="selected",e}(Ul||{});Object(Ai.b)(jo.LabelDataManager)(Pl=Reflect.metadata("design:type",Function)(Pl=Reflect.metadata("design:paramtypes",[])(Pl=class extends hs.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=jo.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:a,emoij:i,offset:n,text:r}=e,o=""+e.id,l=this.data.get(o);if(!o||l&&s===l.conversations&&a==(null==l?void 0:l.createTime)&&i==l.emoij&&n==l.offset&&r===l.text&&t==l.color||(this.data.set(o,e),Object(Po.h)(this.name,o),Object(Po.i)(this.name,"all")),l&&l.conversations&&l.conversations.length!==s.length){let e=[];s.length>l.conversations.length?(e=s.filter((e=>!l.conversations.includes(e))),this.dispatchEvent(new Uo.c(Uo.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=l.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new Uo.c(Uo.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(ui.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void ui.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new Uo.c(Uo.d.RemoveLabel,{labelId:e,convs:s})),Object(Po.f)(this.name,e)}_updateAllLabels(e){return!ui.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(Po.i)(this.name,Ul.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(Po.i)(this.name,Ul.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(Po.i)(this.name,Ul.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(Po.i)(this.name,Ul.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==ko.f?jl:e==ko.g?{id:ko.g}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(Po.i)(this.name,Ul.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new Uo.c(Uo.d.SelectedLabelChange,this.selectedLabel))}init(){zo.a.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===Ul.ALL?this.allLabels:t===Ul.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||Pl)||Pl);a.ModuleContainer.register(Do.b,No);let Bl=function(e){return e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED",e}({});var zl=s("tQbm"),Gl=s("qzuk"),xl=s("NMlV"),Vl=s("4HQc"),Hl=s("GpwQ");const Wl={message:{action:"recommened.link",childnumber:0,description:"Zalo cho my tnh gi file cc nhanh, chp mn hnh tin li, tr chuyn nhm khng gii hn.",href:`https://${Ce.default.CONFIG_DOMAIN}/may-tinh?utm_source=chatview&utm_campaign=reinstallpc&utm_medium=web`,params:`{"mediaTitle":"Zalo cho my tnh  Windows, Mac, Ubuntu","artist":"","src":"${Ce.default.CONFIG_DOMAIN}","stream_icon":"","streamUrl":"","type":0}`,thumb:"https://stc-chat.zdn.vn/images/banner/zalo-thumb-link.png",title:"Zalo cho my tnh  Windows, Mac, Ubuntu",type:"",copyLinkActionCode:null,confirmActionCode:null},msgType:6};var ql,Kl=s("OU7N"),$l=s("UYGI"),Zl=s("X4fA"),Ql=s("V8Oy"),Yl=s("7WX+");let Jl;ui.default.isWeb()||(Jl=s("Dprd").default);const Xl={conversationId:null,mode:Bl.FULL,windowId:hr.c};Object(Ai.b)(zl.b)(ql=function(e,t){return a.ModuleContainer.inject(jo.SidebarController)(e,void 0,0)}(ql=Reflect.metadata("design:type",Function)(ql=Reflect.metadata("design:paramtypes",[void 0===jo.SidebarController?Object:jo.SidebarController])(ql=class extends hs.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(Kl.d.isCalling())return void Wo.default.createWarning(le.a.str("STR_SIGNOUT_WITH_CALL"));let e=J.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+$l.b.isUploading();if(!s&&Jl&&Jl.isDownloading()&&(s=2),s>0){const e=1===s?le.a.str("STR_TITLE_BAR_SEND"):le.a.str("STR_TITLE_BAR_RECEIVE");t=le.a.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+le.a.str("STR_TITLE_BAR_EXIT_ZALO_P2")}Zl.a.getLogoutToken(),qo.ConfirmManagerV2.openConfirm({windowId:hr.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:le.a.str(t),okText:le.a.str("STR_LOGOUT_YES"),cancelText:le.a.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:Me.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{Ia.default.logAction(12808),_e.default.send(ve.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=Ce.default.supportPage;return e?a.ModuleContainer.resolve(Q.b).openConversation(e,Q.d.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{ye.a.setFriendRequestSource(e,Y.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),J.p.setSelectConversationSource(178012),Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:hr.c,name:Y.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(I.a)({},e)};Ie.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId(hr.c),a=K.default.getChatBoxControllerByConvId(t||s.conversationId);null==a||a._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId(hr.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!Ce.default.isOffSendToMe&&this.chatboxController&&we.default.getConversation(Ce.default.sendToMeId).then((s=>{if(e===Y.MSG_GIF&&t.url){var a;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(a=this.chatboxController)||void 0===a||a._sendMessage(s,Y.MSG_GIF,e,null,null,null,null,null)}Object(Ao.e)({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(Ce.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var a,i;if(we.default.deleteMessageById(t.msgId,t.conversationId),null===(a=this.chatboxController)||void 0===a||a._cleanUpLocalTTLItem(t),J.p.isDelSendingMsg(t.clientId))return;const n=t.convertToUIMessageObject();return null===(i=this.chatboxController)||void 0===i||i._handleMessageFailure(e,t,n,s,!0),e},this.broadCastMessage=(e,t,s,a)=>{if(e&&t)for(let o=0;o<e.length;o++){const l=e[o];if(l){let e=l.userId,o=e.startsWith(Y.GROUPID_PREFIX);if(t.msgType===Y.MSG_STICKER){var i;const c=xl.a.next();t&&t.sendSrc&&Ol.c.track(c,t.sendSrc);const d=ui.default.getMsgIdSendingFromCliMsgId(c),u=new Vl.c(J.p.getSessionUserId(),e,d,c,Y.MSG_STICKER,o),h=Hl.a.instance().isOnE2ee(l.userId);if(u.updateMessageContentProp(Vl.a.STICKER,t.message),h){var n;const e={id:u.content.sticker.id,catId:u.content.sticker.cateId,type:u.content.sticker.type};var r;if(null!==(n=t.message)&&void 0!==n&&n.fssInfo)e.extInfo=null===(r=t.message)||void 0===r?void 0:r.fssInfo;u.updateMessageContentProp(Vl.a.STICKER,e),u.e2eeStatus=Y.MSG_E2EE}Cl.default.sendMsgObject(u,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var i;const t=xl.a.next(),a=ui.default.getMsgIdSendingFromCliMsgId(t);let n=new Vl.c(J.p.getSessionUserId(),e,a,t,Y.MSG_TEXT,o);n.updateMessageContentProp(Vl.a.TEXT,s),h&&(n.e2eeStatus=Y.MSG_E2EE),Cl.default.sendMsgObject(n,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{h&&(e=ui.default.parseE2eeResp(e),this.chatboxController._sentMessage(n,e))})).catch((e=>{this.handleSendMessageError(e,n,l)})),null===(i=this.chatboxController)||void 0===i||i._showLocalMessage(n,l)}h&&(t=ui.default.parseE2eeResp(t),this.chatboxController._sentMessage(u,t)),a&&a(t)})).catch((e=>{ui.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,u,l),a&&a(e)})),null===(i=this.chatboxController)||void 0===i||i._showLocalMessage(u,l)}else if(t.msgType===Y.MSG_TEXT&&s){const t=xl.a.next(),i=ui.default.getMsgIdSendingFromCliMsgId(t);let n=new Vl.c(J.p.getSessionUserId(),e,i,t,Y.MSG_TEXT,o);n.updateMessageContentProp(Vl.a.TEXT,s);Hl.a.instance().isOnE2ee(l.userId)&&(n.e2eeStatus=Y.MSG_E2EE),Cl.default.sendMsgObject(n,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{a&&a(e)})).catch((e=>{this.handleSendMessageError(e,n,l),a&&a(e)}))}}}},this.handleEvent=(e,t)=>{if(e===ve.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId(hr.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId(hr.c,(e=>Object(I.a)(Object(I.a)({},e),{},{conversationId:t.userId}))),Object(Po.h)(this.name,hr.c),void this.dispatchEvent(new Gl.a(t.userId,hr.c))}},this.name=zl.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return K.default.getChatBoxControllerByConvId(e||hr.b)}onInviteFriend(){const e=[Wl];Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:le.a.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{_e.default.send(ve.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${Ce.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:we.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=J.p.getSessionUserId();Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId(hr.c).conversationId}doLogout(e){let t=J.p.getSessionUserId();e&&e.del_history?Me.g.setClearData(t,1):Me.g.setClearData(t,0),Ql.a.logout(),Yl.a.logout(),Zl.a.logout().catch((e=>{e.error_code&&18032===e.error_code&&Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.CHANGE_PW})}))}init(){_e.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(I.a)({},Xl),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||ql)||ql)||ql);var ec,tc=s("OI//");let sc=a.ModuleContainer.injectable()(ec=class{async get(e){return hn.default.getGroupById(e)}async getMulti(e){const t=await hn.default.getGroupsByIds(e);return Object.values(t)}async getAll(){return await hn.default.getGroupsList()}})||ec;var ac;let ic=a.ModuleContainer.injectable()(ac=function(e,t){return a.ModuleContainer.inject(tc.c)(e,void 0,0)}(ac=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,1)}(ac=Reflect.metadata("design:type",Function)(ac=Reflect.metadata("design:paramtypes",[void 0===tc.c?Object:tc.c,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(ac=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new tc.a(e))))).catch((e=>(this.logger.zsymb(18,"RdbYbQ",(()=>["getAll error. return [].",{reason:e}])),[])))}getMulti(e){return this.groupRepository.getMulti(e).then((e=>e.map((e=>new tc.a(e)))))}get(e){return this.groupRepository.get(e).then((e=>e?new tc.a(e):void 0)).catch((e=>{this.logger.zsymb(18,"gwR10g",(()=>["get error. return undefined.",{reason:e}]))}))}})||ac)||ac)||ac)||ac)||ac;a.ModuleContainer.registerSingleton(tc.c,sc),a.ModuleContainer.registerSingleton(tc.b,ic);var nc,rc=s("MqnV"),oc=s("+wBa");let lc=Object(a.injectable)()(nc=function(e,t){return Object(a.inject)(En.ConversationRepository)(e,void 0,0)}(nc=function(e,t){return Object(a.inject)(Vr)(e,void 0,1)}(nc=function(e,t){return Object(a.inject)(En.MuteDataManager)(e,void 0,2)}(nc=Reflect.metadata("design:type",Function)(nc=Reflect.metadata("design:paramtypes",[void 0===En.ConversationRepository?Object:En.ConversationRepository,"undefined"==typeof IMessageController?Object:IMessageController,void 0===En.MuteDataManager?Object:En.MuteDataManager])(nc=class{constructor(e,t,s){this.conversationRepository=e,this.messageLocalController=t,this.muteManager=s}getAllConvIds(){return this.conversationRepository.getAllConvIds()}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new En.Conversation(t,this,this.messageLocalController)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||nc)||nc)||nc)||nc)||nc)||nc;var cc;let dc=a.ModuleContainer.injectable()(cc=function(e,t){return a.ModuleContainer.inject(En.ConvInfoDataManager)(e,void 0,0)}(cc=Reflect.metadata("design:type",Function)(cc=Reflect.metadata("design:paramtypes",[void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager])(cc=class{constructor(e){this.convManager=e}getAllConvIds(){return this.convManager.getAllConvIds()}get(e){return this.convManager.getConvById(e)}})||cc)||cc)||cc)||cc;var uc=s("SVh1");var hc=new class{constructor(){}showMyProfile(){Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:J.p.getSessionUserId()})}},gc=s("idnp"),mc=s("mT88");var pc=Object(a.define)("conversation-life-cycle-broadcast-channel");let fc=function(e){return e.WillClose="WillClose",e.DidClose="DidClose",e.WillOpen="WillOpen",e.DidOpen="DidOpen",e.WillDelete="WillDelete",e.DidDelete="DidDelete",e}({});class vc extends hs.a{constructor(e,t){super(e),this.type=e,this.conversationID=t}}class _c extends vc{constructor(e,t){super(fc.WillClose,e),this.conversationID=e,this.windowID=t}}class bc extends vc{constructor(e,t){super(fc.DidClose,e),this.conversationID=e,this.windowID=t}}class Ic extends vc{constructor(e,t){super(fc.WillDelete,e),this.conversationID=e,this.windowID=t}}class yc extends vc{constructor(e,t){super(fc.DidDelete,e),this.conversationID=e,this.windowID=t}}class Sc extends vc{constructor(e,t){super(fc.WillOpen,e),this.conversationID=e,this.windowID=t}}class Cc extends vc{constructor(e,t){super(fc.DidOpen,e),this.conversationID=e,this.windowID=t}}const Ec=[],Oc=[],Mc=[],Tc=[],wc=[],Rc=[],Lc={[fc.WillClose]:{targets:Ec,callback:"onConversationWillClose"},[fc.DidClose]:{targets:Oc,callback:"onConversationDidClose"},[fc.WillDelete]:{targets:Mc,callback:"onConversationWillDelete"},[fc.DidDelete]:{targets:Tc,callback:"onConversationDidDelete"},[fc.WillOpen]:{targets:wc,callback:"onConversationWillOpen"},[fc.DidOpen]:{targets:Rc,callback:"onConversationDidOpen"}};function Dc(e,t){return e.push(t),function(e){const t=new Set,s=[];for(let a=0;a<e.length;a++){const i=e[a];t.has(i)||(t.add(i),s.push(i))}return s}(e)}function Ac(){return function(e){Dc(Oc,e)}}function Fc(){return function(e){Dc(wc,e)}}let kc;var Nc={GetModule:function(){return kc||(kc=a.ModuleContainer.resolve(pc)),kc}},Pc=s("s9sK"),jc=s("44Ud"),Uc=s("E/Lo");Vl.c;var Bc,zc=s("SWHF"),Gc=s("7gRy"),xc=s("q9t1");function Vc(e,t,s){if(Ii.default.isOA(t)){let i=0;switch(e){case Q.a.ConvItem:i=8001;break;case Q.a.Support:i=1500;break;case Q.a.Notify:i=1402;break;case Q.a.SearchList:i=a.ModuleContainer.resolve(jo.SearchController).isShowRecentSearch?1252:1251;break;case Q.a.MessageOnMessaging:i=ui.default.isGroup(s)?1058:s&&Ii.default.isOA(s)?1108:1008;break;case Q.a.UriHelper:i=100}Ia.default.logActionInfoV2(Ia.FeaturesInfo.OpenOfficalAccount,1,{src_open:i,oa_id:t},[t])}}const Hc="[Conversation controller]";function Wc(...e){ui.default.logCoreInfo(`${Hc} - `,e)}let qc=Object(a.singleton)()(Bc=Object(a.injectable)()(Bc=function(e){mc.d.GetChildWindowModuleManager().registerModule(Pc.a,e,{isSingleton:!0})}(Bc=function(e,t){return Object(a.inject)(En.PreviewDataManager)(e,void 0,0)}(Bc=function(e,t){return Object(a.inject)(zc.b)(e,void 0,1)}(Bc=function(e,t){return Object(a.inject)(Dl.e)(e,void 0,2)}(Bc=function(e,t){return Object(a.inject)(Dl.o)(e,void 0,3)}(Bc=function(e,t){return Object(a.inject)(jo.SidebarController)(e,void 0,4)}(Bc=function(e,t){return Object(a.inject)(En.ConvInfoDataManager)(e,void 0,5)}(Bc=Reflect.metadata("design:type",Function)(Bc=Reflect.metadata("design:paramtypes",[void 0===En.PreviewDataManager?Object:En.PreviewDataManager,void 0===zc.b?Object:zc.b,void 0===Dl.e?Object:Dl.e,void 0===Dl.o?Object:Dl.o,void 0===jo.SidebarController?Object:jo.SidebarController,void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager])(Bc=class{constructor(e,t,s,a,i,n){this.previewManager=e,this.adminSettingController=t,this.communityController=s,this.groupLoadInfoController=a,this.sidebar=i,this.convDataManager=n,this.ipc=void 0,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,a=e===ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||un.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!a&&un.a.isThreadHidden(s.userId))return Object(Ho.b)({type:e,payload:t},!0),void Wc("req jum to msg rejected because hidden chat");Fa.default.Fps.record(Fa.MetricName.fps_jump_to_msg),Wc("req jum to msg open on main"),Object(Ho.b)({type:e,payload:t},!0);const i=gc.b.fromJumpMessage();this.openConversationForJump(s.userId,i)},this.tryToFocusChild=(e,t)=>!!K.default.isOpenChildWindowByConvId(e)&&(Wc("Open conv forward because already open in child => call focus"),K.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId,{removed:!0})},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(ai.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(ai.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(ai.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===Rl.c.CHAT_VIEW&&s===e}openConversationForJump(e,t=gc.a){return new Promise((async s=>{if(Wc(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(Wc(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||K.default.focusOnMainWindow()}return s(!1)}let a=hr.c;if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,a);const i=this.sidebar.getSelectedId(a);i&&i!==e&&this.conversationWillClose(i,a);let n=!1;if(t.window===uc.b.Child)return n=this.tryToFocusChild(e,t),s(n);if(t.window===uc.b.PreferChild){if(n=this.tryToFocusChild(e,t),n)return s(!0)}else t.window===uc.b.MainAndChild&&(n=this.tryToFocusChild(e,t));n||K.default.focusOnMainWindow(),_e.default.send(ve.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object(Ho.b)({type:ve.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),i&&i!==e&&this.conversationDidClose(i,a),this.conversationDidOpen(e,a),Vc(t.callPoint,e)}))}openConversationInChildWindow(e,t,s){return this.conversationWillOpen(e,e),K.default.openConvInNewWindow(e,t,s),this.conversationDidOpen(e,e),Vc(uc.a.ConvItem,e),Promise.resolve(!0)}onCloseChildWindow(e){this.conversationDidClose(e,e)}onOpenChildWindow(e){}openConversation(e,t=gc.a){return new Promise((async(s,i)=>{if(Wc(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(Wc(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||t.silently||K.default.focusOnMainWindow()}return s(!1)}let n=hr.c;const r=this.sidebar.getSelectedId(n);let o=r;const l=K.default.getOnTopWindowId();l&&!K.default.isMainWindow(l)&&(o=K.default.getConvIdFromWindowId(l));const c=J.p.getSessionUserId();if(e==c)return hc.showMyProfile(),s(!1);Fa.default.Fps.record(Fa.MetricName.fps_switch_conv);if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,n),r&&r!==e&&this.conversationWillClose(r,n);let d=!1;if(t.window===uc.b.Child)return d=this.tryToFocusChild(e,t),s(d);if(t.window===uc.b.PreferChild){if(d=this.tryToFocusChild(e,t),d)return s(!0)}else t.window===uc.b.MainAndChild&&(d=this.tryToFocusChild(e,t));let u=t.credentConv;if(u||(u=await we.default.getLikeConversation(e).catch((e=>{Wc(`Failure to load conv from store ${e}`)})),Wc(`Try to use storage conv: ${!!u}`)),u||(u=t.defaultConv,Wc(`Try to use default conv: ${!!u}`)),!u)return Wc(`Open conv not exists: ${e}`),s(!1);d||t.silently||K.default.focusOnMainWindow(),_e.default.send(ve.ConversationListActions.SELECT_CONV_MINOR,u);const h=un.a.isThreadHidden(e);h&&un.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(u=Object(I.a)({},u),u.byPassPIN=1):delete u.byPassPIN,this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:u}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,{userId:u.userId,needScroll:t.callPoint!==uc.a.ConvItem,callPoint:t.callPoint});(!h||t.byPassPIN||un.a.getListChatBoxViewCurrent().includes(u.userId))&&this.sidebar.updateSelectedId(e),s(!0),r&&r!==e&&this.conversationDidClose(r,n),this.conversationDidOpen(e,n),a.ModuleContainer.resolve(xc.b).promoteMigrateByOpenConv(e),Vc(t.callPoint,e,o)}))}closeConversation(e,t={}){return new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);const{windowId:a=hr.c,removed:i}=t;if(this.conversationWillClose(e,a),a===hr.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:e}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,e),i?this.sidebar.updateSelectedIdWithoutPrevious(null):this.sidebar.updateSelectedId(null)}this.conversationDidClose(e,a),s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t=hr.c){return new Promise((async s=>{if(this.conversationWillDelete(e,t),await Fo.default.deleteConversation(e,!0,t),t===hr.c){const a={userId:null};this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:a}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,a),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e,t)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}isOpeningConversation(e){const t=this.sidebar.getSelectedId();return!(!t||t!=e)||K.default.isOpenChildWindowByConvId(e)}conversationWillClose(e,t){Nc.GetModule().conversationWillClose(e,t)}conversationDidClose(e,t){Nc.GetModule().conversationDidClose(e,t)}conversationShouldOpen(e){return Wc(`Should open conv ${e}`),Wc(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationWillOpen(e,t){jc.b.start(jc.a.ART,{convId:e}),Wc(`Conversation ${e} will be opened on windowID:${t}`),Nc.GetModule().conversationWillOpen(e,t)}conversationDidOpen(e,t){Fa.default.start(Fa.MetricName.open_conversation,e),Fa.default.start(Fa.MetricName.open_conversation_no_preload,e),Wc(`Did open conv ${e}`);const s=a.ModuleContainer.resolve(En.ConvInfoDataManager).getConvByIdSync(e);!a.ModuleContainer.resolve(En.ConvInfoDataManager).getLeaveType(s)&&this.adminSettingController.onLoadSetting(e),this.communityController.onConversationDidOpen(e),this.groupLoadInfoController.onOpenConversation(e),a.ModuleContainer.resolve(Ra.a).onOpenConversation(e),a.ModuleContainer.resolve(Gc.a).onOpenConversation(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0),Nc.GetModule().conversationDidOpen(e,t)}conversationWillDelete(e,t){return Wc(`Will delete conv ${e}`),Nc.GetModule().conversationWillDelete(e,t),Promise.resolve()}conversationDidDelete(e,t){Wc(`Did delete conv ${e}`),this.lastOpenConv.delete(e),Nc.GetModule().conversationDidDelete(e,t)}})||Bc)||Bc)||Bc)||Bc)||Bc)||Bc)||Bc)||Bc)||Bc)||Bc)||Bc;var Kc,$c=s("UYQr");let Zc=Object(a.injectable)()(Kc=class{constructor(){this._activeConversationInfo=new Map}activateConversation(e,t){const s=this._getKey(e),a=this._activeConversationInfo.get(s);a?-1===a.windowIds.indexOf(t)&&(a.windowIds.push(t),this._activeConversationInfo.set(s,a)):this._activeConversationInfo.set(s,{convId:e,windowIds:[t]})}deactivateConversation(e,t){const s=this._getKey(e),a=this._activeConversationInfo.get(s);if(a){const e=a.windowIds.indexOf(t);-1!==e&&a.windowIds.splice(e,1),0===a.windowIds.length?this._activeConversationInfo.delete(s):this._activeConversationInfo.set(s,a)}}getActiveConversationInfo(e){const t=this._activeConversationInfo.get(this._getKey(e));return t?{convId:t.convId,windowIds:[...t.windowIds]}:{convId:"",windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfo.size>0&&(e=Array.from(this._activeConversationInfo.keys())),e}_getKey(e){return e}})||Kc;var Qc=s("2rzQ"),Yc=s("+tVb"),Jc=s("UkBb"),Xc=s("Qtro"),ed=s("oiWN"),td=s("zo6P");let sd=function(e){return e.ABORTED="ABORTED",e.LAST_MSG_PROCESSED="LAST_MSG_PROCESSED",e}({});const ad=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.offline2Online,["last-message-processed-tracker"]);class id extends hs.b{constructor(...e){super(...e),this.lastMsgId=null,this.lastProcessedMsgId=null}abort(){this.dispatchEvent(new hs.a(sd.ABORTED)),this.removeAllEventListener()}onLastMessage(e){e?(this.lastMsgId=e,this.checkAndDispatchEventIfNeeded()):this.dispatchEventLastMessageProcessed()}onProcessedMessage(e){this.lastMsgId&&this.lastMsgId<e||(!this.lastProcessedMsgId||this.lastProcessedMsgId<e)&&(this.lastProcessedMsgId=e,this.checkAndDispatchEventIfNeeded())}checkAndDispatchEventIfNeeded(){const e=Number(this.lastMsgId),t=Number(this.lastProcessedMsgId),s=e&&t&&e===t;ad.zsymb(0,"-fV_16","checkAndDispatchEventIfNeeded",{lastMsgId:e,lastProcessedMsgId:t,shouldDispatchEvent:s}),s&&this.dispatchEventLastMessageProcessed()}dispatchEventLastMessageProcessed(){this.dispatchEvent(new hs.a(sd.LAST_MSG_PROCESSED)),this.removeAllEventListener()}}var nd,rd=function(e){return e[e.BATCHING=0]="BATCHING",e[e.IMMEDIATELY=1]="IMMEDIATELY",e}(rd||{});let od=Object(a.injectable)()(nd=Object(Yr.g)()(nd=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(nd=Reflect.metadata("design:type",Function)(nd=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(nd=class extends hs.b{constructor(e){super(),this.logger=void 0,this.config=void 0,this.mode=void 0,this.intervalBatching=void 0,this.lastProcessedMessageTracker=void 0,this.queueSignalRenderItems=void 0,this.queueSignalRenderLists=void 0,this.signalRenderItem=(...e)=>{switch(this.mode){case rd.BATCHING:this.pushQueueSignalRenderItems(...e);break;case rd.IMMEDIATELY:default:Object(Po.h)(...e),this.dispatchEvent(new hs.a(td.b.SIGNAL_RENDER_ITEM))}},this.signalRenderList=(...e)=>{switch(this.mode){case rd.BATCHING:this.pushQueueSignalRenderLists(...e);break;case rd.IMMEDIATELY:default:Object(Po.i)(...e),this.dispatchEvent(new hs.a(td.b.SIGNAL_RENDER_LIST))}},this.onStartPreprocessing=()=>{this.config.nestedKey("conv_ui_batching_updater.enable")&&this.startBatching()},this.onDonePullOfflineData=e=>{var t;this.mode===rd.BATCHING&&(this.logger.zsymb(3,"6RhqSw",["receive done pull offline event","I-f7u1"]),null!=e&&e.maxMsgId?this.logger.zsymb(3,"Llf4tb",["receive last max msg {}","AHR8cv"],null==e?void 0:e.maxMsgId):this.logger.zsymb(3,"vmyF8w",["don't have any offline data","KOO52z"]),null===(t=this.lastProcessedMessageTracker)||void 0===t||t.onLastMessage(null==e?void 0:e.maxMsgId))},this.logger=e.createZLogger(R.ZLoggerNametags.offline2Online,["conversation-ui-updater"]),this.config=ed.b,this.mode=rd.IMMEDIATELY,this.intervalBatching=null,this.lastProcessedMessageTracker=null,this.queueSignalRenderItems=[],this.queueSignalRenderLists=[],this.registerListener()}registerListener(){Yc.a.getInstance().addEventListener("start-preprocess",this.onStartPreprocessing),Jc.default.addEventListener(Jc.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{const{nextChatHandler:t,prevChatHandler:s}=e;null==s||s.unsubcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOfflineData),null==t||t.subcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOfflineData)})),this.config.addEventListener("update",(()=>{0===this.config.nestedKey("conv_ui_batching_updater.enable")&&(this.logger.zsymb(3,"5tiYNO",["receive disable config, let stop batching immediately","s3YLGZ"]),this.stopBatchingImmediately())}))}pushQueueSignalRenderItems(...e){this.queueSignalRenderItems.push(e)}pushQueueSignalRenderLists(...e){this.queueSignalRenderLists.push(e)}flushQueueSignalRender(){if(ed.b.nestedKey("debug.enable_ui_batching_log")&&oi.b.logUIBatching([...this.queueSignalRenderItems],[...this.queueSignalRenderLists]),this.queueSignalRenderItems.length>0){this.logger.zsymb(0,"aWtU9l","flush queue items, queue size",this.queueSignalRenderItems.length);const e=Date.now().toString();Object(Po.j)(e);for(const t of this.queueSignalRenderItems)Object(Po.g)(e,...t);Object(Po.c)(e),this.queueSignalRenderItems=[],this.dispatchEvent(new hs.a(td.b.FLUSH_QUEUE_ITEM))}if(this.queueSignalRenderLists.length>0){this.logger.zsymb(0,"CzjChN","flush queue list, queue size",this.queueSignalRenderLists.length);const e=[];for(const[t,s,a]of this.queueSignalRenderLists){const i=[t,s,Boolean(a)].join("::");e.includes(i)||(e.push(i),Object(Po.i)(t,s,a))}this.queueSignalRenderLists=[],this.dispatchEvent(new hs.a(td.b.FLUSH_QUEUE_LIST))}}startBatching(){this.logger.zsymb(0,"YeTiTy","start batching"),this.mode=rd.BATCHING,this.startIntervalFlushQueue(),this.setupStopBatching()}setupStopBatching(){var e;this.logger.zsymb(0,"dp7MVH","setup stop batching"),null===(e=this.lastProcessedMessageTracker)||void 0===e||e.abort();const t=a.ModuleContainer.resolve(jo.ConvListController),s=this.lastProcessedMessageTracker=new id,i=t.addEventListener(ai.c.PreviewChanged,(e=>{var t;const a=null===(t=e.payload)||void 0===t?void 0:t.changedItem;null!=a&&a.msgId&&s.onProcessedMessage(null==a?void 0:a.msgId)}));s.addEventListenerOnce(sd.ABORTED,(()=>{this.logger.zsymb(3,"1N49LQ",["aborted listener","yielYK"]),i()})),s.addEventListenerOnce(sd.LAST_MSG_PROCESSED,(()=>{this.logger.zsymb(3,"aCUucM",["last message processed, let stop batching","OtFVPa"]),this.stopBatchingWithDelay(),i()}))}stopBatchingWithDelay(){const e=this.config.nestedKey("conv_ui_batching_updater.delay_after_stop_batching");this.logger.zsymb(3,"n9lCkj",["will stop batching after {}ms","c2zWaj"],e),setTimeout((()=>{this.stopBatchingImmediately()}),e)}stopBatchingImmediately(){this.flushQueueSignalRender(),this.stopIntervalFlushQueue(),this.mode=rd.IMMEDIATELY,this.logger.zsymb(0,"SgMhZJ","stop batching")}startIntervalFlushQueue(){var e;null===this.intervalBatching&&this.logger.zsymb(0,"XNGSCZ","start interval flush queue"),null!==(e=this.intervalBatching)&&void 0!==e||(this.intervalBatching=setInterval((()=>{this.flushQueueSignalRender()}),this.config.nestedKey("conv_ui_batching_updater.interval_batching_update")))}stopIntervalFlushQueue(){this.intervalBatching&&clearInterval(this.intervalBatching),this.intervalBatching=null,this.logger.zsymb(0,"ouz-1F","stop interval flush queue")}})||nd)||nd)||nd)||nd)||nd;a.ModuleContainer.registerSingleton(td.a,od);var ld,cd=s("TeMN"),dd=s("Bzy+"),ud=(s("EHdh"),s("Ln14")),hd=s("bdot"),gd=s("cfFl"),md=s.n(gd);const pd={userId:Y.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},fd=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(Ai.b)(ud.c)(ld=function(e,t){return a.ModuleContainer.inject(cd.b)(e,void 0,0)}(ld=Reflect.metadata("design:type",Function)(ld=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB])(ld=class extends hs.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=ud.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=dd.a.getInstance(),this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=a.ModuleContainer.resolve(En.PreviewDataManager)),this._pm}get unreadManager(){return me.a.UnreadDataManager}init(){if(this.didInit)return Promise.resolve();const e=Fa.default.start(Fa.MetricName.load_conversation_list),t=()=>{e.end(),me.a.ConvListController.removeEventListener(ai.c.LoadPreviewDone,t)};return me.a.ConvListController.addEventListener(ai.c.LoadPreviewDone,t),this.didInit=!0,this.loadData()}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{ui.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);ui.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(ai.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(Y.CONV_FILTER.STRANGER,pd,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=md.a.series(e),a=md.a.series(t);return Promise.all([s,a]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===ud.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await Bo.ConvList.filterOutdatedConv(e);ui.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),a=[];Object(Po.j)(s);for(let i=0;i<t.length;i++){if(!t[i].userId)continue;const e=Object(I.a)({},t[i]),n=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(Y.GROUPID_PREFIX)),n){if(!n.verified){const t=this.mergeConv(e,n);t.verified=!0,this.setCacheData(e.userId,t),Object(Po.g)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(Po.g)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&ui.default.msgTypeValid(e.infoCheckSearch.lastType)?Dr.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&a.push(e.userId))}return a.length>0&&Dr.a.cacheCheckLastChatInDb(a),Object(Po.c)(s),t}onReceiveNewMessages(e,t,s={outside:void 0,isGroup:!1}){return new Promise(((a,i)=>{var n,r;if(!t||t.length<0)return i("Empty msgs");const o=t[t.length-1],l=t[0],c=this.data.get(e),d=Bo.ConvList.getLastValidMsg(t);let u,h;d&&(u={lastMessageTime:Number(d.sendDttm),lastType:d.msgType},Dr.a.pushCacheLastChat(e,u.lastMessageTime)),o.msgType===Y.MSG_INFO&&(null==c||null===(n=c.infoCheckSearch)||void 0===n?void 0:n.lastMessageTime)>Number(o.sendDttm)&&(h=null==c?void 0:c.lastSmsLocalId);const g={userId:e,firstSmsLocalId:l.msgId,isGroup:s.isGroup||e.startsWith(Y.GROUPID_PREFIX),numMsg:t.length,respondedByMe:$r.default.includeMyMessage(t),pinned:0,label:null,topOut:o.topOut,verified:!1,lastSmsLocalId:h||o.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:u};if(this.preloadCached&&this.preloadCached.onNewMsg(e,o),c){const t=this.mergeConv(Object(I.a)({},c),g);this.setCacheData(e,t),this.shouldSignalUpdate(c,t)&&Object(Po.h)(this.name,e),c.verified&&this.updateInDB(t),a(t)}else{const s=zo.a.getLabelObjByConversaionId(e);if(g.label=s?s.id:null,this.setCacheData(e,g,!0),this.doneLoadDB){g.verified=!0,this.updateInDB(g);return $r.default.includeJoinEvent(t)&&(ui.default.logCoreInfo(`[${this.name}] - Detect join msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e)),a(g)}this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return i("Internal logic handle wrong");let n=Object(I.a)({},s);n.verified=!0,t?s.verified||(n=this.mergeConv(n,t),this.setCacheData(e,n),this.shouldSignalUpdate(n,s)&&Object(Po.h)(this.name,e),this.updateInDB(n)):this.updateInDB(n),a(n)}))}c&&c.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(ui.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let a=!1;if(t.find((({msgId:e})=>s.firstSmsLocalId===e))){const t=await(await hd.b.getFirstMessage(e)).firstMsg;if(!t)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,a=!0}if(t.find((({msgId:e})=>s.lastSmsLocalId===e))){const t=await hd.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,a=!0}return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${a}`),a&&(this.setCacheData(e,Object(I.a)({},s)),this.updateInDB(s)),{conversation:s,updated:a}}{const t=await(await hd.b.getFirstMessage(e)).firstMsg,s=await hd.b.getLastMessage(e),a=s&&s[0];if(!t||!a)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!a}`),me.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const i=await this.DBConvInfo.getById(e);let n=ui.default.msgTypeValid(a)?{lastMessageTime:a.sendDttm,lastType:a.msgType}:void 0;if(ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!i}`),i){let s=!1;i.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(i.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),i.lastSmsLocalId!==a.msgId&&(i.lastSmsLocalId=null==a?void 0:a.msgId,s=!0);const n=Object(I.a)(Object(I.a)({},i),{},{verified:!0});return this.setCacheData(e,n,!0),s&&this.updateInDB(n),{conversation:n,updated:!0}}{const s={userId:e,isGroup:e.startsWith(Y.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:a.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==a.fromUid,infoCheckSearch:n};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}getLeaveType(e){const t=null==e?void 0:e.localType;return t===Y.LOCAL_CONVERSATION_TYPE.KICK_GROUP?"kick":t===Y.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP?"disband":void 0}mergeConv(e,t){const s=e=>null!=e&&("string"==typeof e?!e.includes("undefined")&&!e.includes("null"):"number"==typeof e&&!isNaN(e));let a=!1;return s(e.lastSmsLocalId)?s(t.lastSmsLocalId)&&(a=t.lastSmsLocalId>e.lastSmsLocalId):a=!0,a&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),ui.default.isKickOrDisbandGroup(e)&&(e.localType=void 0),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(ui.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(I.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(ai.b.EmptyConv,e),Object(Po.h)(this.name,e),me.a.PinDataManager.isPinned(e)&&me.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e,t){ui.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const s=this.data.get(e);return s&&(s.leaveType=t),this.doDeleteConversation(e).then((a=>{let i;this.broadcastEvent(ai.b.DeleteConv,e,s),"kick"===t?i=Y.LOCAL_CONVERSATION_TYPE.KICK_GROUP:"disband"===t&&(i=Y.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP),i&&s&&this.createEmptyConvForUser(e,0,Y.CONV_OT_STATE.none,Object(I.a)(Object(I.a)({},s),{},{localType:i}))}))}doDeleteConversation(e){const t=this.data.get(e);return ui.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(Po.f)(this.name,e)),me.a.PinDataManager.isPinned(e)&&me.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const a=await this.doUpdatePin(e,t);s(a)}))}))}doUpdatePin(e,t){if(t&&Bo.ConvList.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(ai.b.ChangePinConv,e,t),s))).catch((t=>(ui.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e,t){return t?(this.broadcastEvent(ai.b.LeaveGroup,e),Promise.resolve()):(ui.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(ai.b.LeaveGroup,e)})))}async onChangeConvLabel(e,t){return new Promise((s=>{const a=this.data.get(e);if(a&&a.label===t)return s(a);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const a=await this.doUpdateConvLabel(e,t);s(a)}))}))}doUpdateConvLabel(e,t){if(!e)return ui.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const a=new Map;return a.set("label",t),this.updateFields(e,a).then((a=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),a)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;ui.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let a=0;a<e.length;a++){const s=e[a].id,i=e[a].conversations;if(i)for(let e=0;e<i.length;e++){const a=i[e];delete t[a],this.onChangeConvLabel(a,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){ui.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const a=this.data.get(e);let i=a||{},n=!1;if(!a||!a.verified){const t=await this.DBConvInfo.getById(e);if(!a&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}a&&t?(i=this.mergeConv(a,t),n=!0):(i=a||t,i.verified=!0,n=!0)}return i.firstSmsLocalId&&i.firstSmsLocalId!==t||(n=!0,i.firstSmsLocalId=s),i.lastSmsLocalId&&i.lastSmsLocalId!==t||(n=!0,i.lastSmsLocalId=s),n&&(this.setCacheData(e,i),this.updateInDB(i)),i}async addOrUpdateConv(e,t,s,a,i,n){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const r=this.data.get(e);ui.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!r} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=a,e.respondedByMe=e.respondedByMe||i,e.numMsg=(e.numMsg||0)+n,e);if(r&&r.verified){const t=o(r);return this.setCacheData(e,Object(I.a)({},t)),this.updateInDB(t),t}{const r=await this.DBConvInfo.getById(e);if(ui.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!r}`),r){const t=o(r);return this.setCacheData(e,Object(I.a)(Object(I.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const r={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(Y.GROUPID_PREFIX),respondedByMe:i,numMsg:n||2,label:null,pinned:0,verified:!0,cloudMore:a,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),r}}}async addIfNotExistsConv(e,t,s,a,i,n){const r=this.data.get(e);if(ui.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!r} ${a}`),r)return!1;const o=await this.DBConvInfo.getById(e);if(ui.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const r={userId:e,firstSmsLocalId:s,lastSmsLocalId:a,isGroup:t||e.startsWith(Y.GROUPID_PREFIX),respondedByMe:i,numMsg:n||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),!0}}createEmptyConvForUser(e,t,s=Y.CONV_OT_STATE.none,a){return new Promise(((i,n)=>{this.getConvById(e).then((i=>{let n;if(ui.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!i}`),i){const a=new Map;return n=i,s!==Y.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s,a.set("outside",s)),t&&!me.a.PinDataManager.isPinned(n.userId)&&me.a.PinDataManager.pin([n.userId]),this.updateFields(e,a),n}return n=Object(I.a)({userId:e,lastMessageTime:t?0:Ct.default.getTimeNow(),isGroup:e.startsWith(Y.GROUPID_PREFIX)},a),s!==Y.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s),t&&me.a.PinDataManager.pin([n.userId]),n.verified=!0,this.setCacheData(e,n,!0),this.updateInDB(n),n})).then((e=>{i(e)})).catch((e=>{ui.default.logCoreError(e),n(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const a=new Map;return a.set("lastSmsLocalId",t),this.updateFields(e,a)}updateInfoCheckSearch(e,t,s){const a=this.data.get(e);if(a&&a.infoCheckSearch&&a.infoCheckSearch.lastMessageTime===t)return Promise.resolve(a);const i=new Map;return i.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,i)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const a=!!this.doneLoadDB;s={userId:e,verified:a},a||ui.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}ui.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),ui.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&ui.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIds(){return this.getAllConv().then((e=>e.map((({userId:e})=>e))))}getAllConvIdsSync(){return Array.from(this.data.keys())}onDoneSyncMobile(){ui.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s=!1){this.data.set(t.userId,t),s&&Object(Po.h)(this.name,e)}updateFields(e,t){return new Promise(((s,a)=>{const i=this.data.get(e),n=i=>{ui.default.logCoreInfo(`[${this.name}] - updateFields #2`);const n=Object(I.a)({},i);t.forEach(((e,t)=>{n[t]=e})),this.setCacheData(e,n,!0),this.updateInDB(n).then((()=>{s(n)})).catch(a)};i?n(i):this.DBConvInfo.getById(e).then((e=>{e&&n(e)}))}))}forkDeleteCacheAndDB(e){if(ui.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!me.a.PinDataManager.isPinned(e)){const t=this.data.get(e);ui.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(Po.f)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(ai.b.DeleteConv,e,t)}))}}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}shouldSignalUpdate(e,t){return me.a.PinDataManager.isPinned(e.userId)!==me.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{fd.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(Y.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(I.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{ui.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{ui.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||ld)||ld)||ld);var vd,_d=s("NSWB"),bd=s("1Abx"),Id=s("XEtq"),yd=s("ZRfj"),Sd=s("oH3T"),Cd=s("13iL"),Ed=s("WK05"),Od=s("bSQ5"),Md=s("dwTj"),Td=s("RVT8"),wd=s("hkvp"),Rd=s("6tnf"),Ld=s("sg3c"),Dd=s("ofhN"),Ad=s("D8f9"),Fd=s("bgEr"),kd=s("PGx3");const Nd="9999999999999999",Pd="zum_m",jd="1.0.0",Ud="paucfoa_ts_key",Bd=!1,zd="total",Gd=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),xd={CALL_INIT:!1},Vd=1,Hd=2;Object(Ai.b)(Td.b)(vd=function(e,t){return a.ModuleContainer.inject(wd.b)(e,void 0,0)}(vd=function(e,t){return a.ModuleContainer.inject(En.ConversationUIUpdater)(e,void 0,1)}(vd=Reflect.metadata("design:type",Function)(vd=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB,void 0===En.ConversationUIUpdater?Object:En.ConversationUIUpdater])(vd=class extends hs.b{constructor(e,t){super(),this.DBConvUnread=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=xd,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(gd.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=Td.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue(),this.resetToUnreadReddotOAIfNeeded_=this.resetToUnreadReddotOAIfNeeded_.bind(this),this.handleConvUnreadCountConfigChange_=this.handleConvUnreadCountConfigChange_.bind(this)}init(){this.didInit||(this.logger.zsymb(3,"HU8GGj",["call init unread","-uAaOk"]),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,"DcV0MR",["done all state, ready to load db...","CQ9xj9"]),this.loadData())}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.conversation,[R.ZLoggerNametags.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=n.default.getInstance().getItemForCurrentUser(Pd);if(e===jd)this.isLoadDBStarted=!0,this.logger.zsymb(3,"faWmav",["start load unread {}","mW-2vF"],e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(Hd,e.map(this.toUnreadItem)),this.doDoneLoadDBTask()}));else{me.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async resetToUnreadReddotOAIfNeeded_(){try{let e=Fd.b().enable_for_oa,t=await n.default.getInstance().getItemForCurrentUserAsync(Ud),s=!1,a=!1;if(null==t)this.logger.zsymb(0,"JV2xjp","Force reset to unread reddot OA at first time."),s=!0;else{const[s,i]=t.split("_").map(Number);if(e===s)return;const n=!e&&1==s,r=Boolean(e)&&0==s;a=n||r,this.logger.zsymb(3,"As9h9A",["shouldResetToUnreadReddotByRule by mainRule: {} - subRule: {}","IkD-FH"],n,r)}if(s||a){if(this.data.size>0){this.logger.zsymb(0,"tw_fEP","perf reset to default unread reddot OA.");const e=e=>{const t=e.smsUnreadCount||0;let s=e.smsUnreadNotCount||0;const a=t-s;return a>0?(this.logger.zsymb(3,"X-WLNe",["resetToDefaultUnreadReddotItemIfNeeded - OAConvId: {} - count: {} - smsUnreadNotCount: {}","YijVPn"],e.convId,a,s),s=s||1,{shouldReset:!0,data:Object(I.a)(Object(I.a)({},e),{},{smsUnreadCount:s,smsUnreadNotCount:s,strangerUnreadCount:s})}):{shouldReset:!1,data:e}},t=Array.from(this.data.values()),s=new Map;t.forEach((e=>s.set(e.convId,Object(I.a)({},e))));const a=t.map((e=>e.convId));this.logger.zsymb(3,"sBWIXQ",["before verify oa convs: {}","On1fx7"],Date.now());const i=(await Bo.ConvList.verifyOATypeAsync(a)).reduce(((t,a)=>{if(a.isOA&&s.has(a.cid)){const i=s.get(a.cid),{shouldReset:n,data:r}=e(i);n&&t.push(r)}return t}),[]);if(this.logger.zsymb(3,"EEFc1B",["Reset to default unread reddot OA - count: {} - ts: {}","8c86GV"],i.length,Date.now()),i.length){const e=Date.now().toString();Object(Po.j)(e),i.forEach((t=>{this.data.set(t.convId,t),Object(Po.g)(e,this.name,t.convId),this.updateInDB(t)})),Object(Po.c)(e),this.unreadChanged("reset")}}}const i=`${e}_${Date.now()}`;this.logger.zsymb(3,"sajxbt",["apply new unread count for OA config - newAppliedConfigAndTS: {}","1IDz5k"],i),n.default.getInstance().setItemForCurrentUserAsync(Ud,i)}catch(e){this.logger.zsymb(21,"mWowBQ",["reset to unread reddot OA if needed error: {}","Kyk6S-"],null==e?void 0:e.message)}}handleConvUnreadCountConfigChange_(e){const{prevConfig:t,nextConfig:s}=e;t.enable_for_oa!==s.enable_for_oa&&this.doneLoadDB&&this.resetToUnreadReddotOAIfNeeded_()}shouldForceShowReddotForOAMessages_(e,t=!1){const s=Fd.b().enable_for_oa;return Boolean(!s&&(t||e&&Bo.ConvList.isOAType({userId:e})))}async migrateV2(){const e=n.default.getInstance(),t=e.getItemForCurrentUser(Pd)===jd;if(this.logger.zsymb(3,"cc2hpa",["call migrate unread {}","rJB922"],t),t)return;const s=me.a.ConvInfoDataManager.getAllConvSync(),a=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,i=e.mentionUnreadCount||0,n=e.unreadMark||null;if(!(e&&e.userId&&(t||s||i||n)))return;const r={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:i,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:n};a.push(r)})),this.onLoadUnreadFromDBV2(Vd,a),this.doDoneLoadDBTask(),this.logger.zsymb(3,"v4t8RO",["done migrate unread {}","049WBT"],a.length),e.setItemForCurrentUser(Pd,jd)}async doDoneLoadDBTask(){await this.resetToUnreadReddotOAIfNeeded_();const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(ai.b.DoneLoadDB,"total",e),this.logger.zsymb(3,"w5vyy1",["done load unread {}","yb7tsj"],e.length),Object(kd.e)(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){me.a.MuteDataManager.addEventListener(ai.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),me.a.ConvInfoDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),me.a.ArchivedChatManager.addEventListener(ai.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),_e.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===ve.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===ve.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}})),Fd.a(this.handleConvUnreadCountConfigChange_)}getItem(e,t){if(e.key===zd)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||un.a.isThreadHidden(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"xCK2VF","onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||we.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"YTNI3w","onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||we.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const a=this.data.get(e);t===s||!a||a.smsUnreadCount<1||we.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const a=this.data.get(e);if(a)this.logger.zsymb(0,"q8yjB3","receive msg",e,a.lastProcessMsgId,s),(!a.lastProcessMsgId||a.lastProcessMsgId<t)&&this.handleNewMessages(e,s,t).then((()=>{this.signalRenderItem(this.name,e)}));else{const t=this.pendingMessage.get(e),a=t?s.concat(t):s;this.pendingMessage.set(e,a),a.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),a=$r.default.getLastMessageInList(s);if(!a)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,a.msgId).then((()=>{this.signalRenderItem(this.name,e)}))}}}))}}async onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const i=this.data.get(e);if(this.doneLoadDB){if(!i||!i.lastProcessMsgId||i.lastProcessMsgId<t){const a=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,"g6_d_I",`onReceiveNewMessages: ${null==i?void 0:i.lastProcessMsgId} ${e} ${t} ${a}`),await this.handleNewMessages(e,s,t),this.signalRenderItem(this.name,e)}}else{const t=this.pendingMessage.get(e),a=t?s.concat(t):s;this.pendingMessage.set(e,a)}a.ModuleContainer.resolve(Qo.TUnreadSubChatTabStateManager).handleReceiveLatestMessage({convId:e,msgId:t})}onDoneOffLineMessages(){this.logger.zsymb(0,"ICVlsU","ph7 done offline"),El.b.onDoneEntry(El.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;Object(kd.a)([e]);const t=this.data.get(e);this.logger.zsymb(0,"Trfn40",`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(Po.f)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(I.a)(Object(I.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),this.signalRenderItem(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const a=e[s],i=this.data.get(a.userId)||Gd(a.userId);this.logger.zsymb(0,"lYLKOX","onClearUnreadConversations",!!a,null==i?void 0:i.smsUnreadCount),a&&(t.push(a.userId),i.smsUnreadCount>0&&we.default.getLastMessageFrom(a.userId,a.lastSmsLocalId,Nd,i.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let a=0;a<e.length;a++){let s=e[a];ui.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:a.userId,lastSmsLocalId:a.lastSmsLocalId,smsUnreadCount:i.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(a.userId,i.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,"KXD-Qo",["clear unread conv failure {}","wIweia"],e)})),Ed.a.clearUnreadIfExist({userId:a.userId,lastSeenReactId:i.lastSeenReactId}))}Object(kd.a)(t,e.length>0)}onReadConversation(e,t){var s;if(Ce.default.mark_unread.enable&&!Object(kd.c)(e))return this.logger.zsymb(0,"V_UIhc",`[read-message] dont clear ${e}`,Ce.default.mark_unread.enable,Object(kd.c)(e)),!1;Object(kd.b)(e)&&(e.startsWith(Y.GROUPID_PREFIX)?Ia.default.logAction(2160024):Ia.default.logAction(2160023),Ia.default.logAction(2160022));const a=this.data.get(e)||Gd(e),i=a.smsUnreadCount;if(!t&&!i){this.logger.zsymb(0,"yHDgED",`[read-message] dont clear ${e} unread `,i,t);const s=Ed.a.sendClearUnread(e,a.lastSeenReactId);return Object(kd.a)([e],!1),s!=a.lastSeenReactId&&(a.lastSeenReactId=s,this.data.set(e,Object(I.a)({},a)),this.signalRenderItem(this.name,e),this.updateInDB(a)),!1}const n=this.acquireConvManager().getConvByIdSync(e);if(!n)return this.logger.zsymb(0,"JsPgOp",`[read-message] convinfo not exists ${e}`),!1;const r=[],o={},l=n.lastSmsLocalId?n.lastSmsLocalId.toString().split("_")[0]:"";let c=!1;const d=null===(s=zr.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},i);for(let g=d.length-1;g>-1;g--){let e=d[g];if(ui.default.validMessageFromOther(e)&&!r.includes(e.msgId)&&(r.push(e.msgId),o[e.msgId]=e,e.msgId==l&&(c=!0),r.length==i))break}const u={userId:e,lastSmsLocalId:n.lastSmsLocalId,smsUnreadCount:i};var h;!l||c||o[l]?this.clearUnreadConversation(u,o):(this.logger.zsymb(0,"eCOd0f",`[read-message] append lastMsgIdInConv ${l} ${Object.keys(o).length}`),null===(h=zr.b.messageCache)||void 0===h||h.getMessageByMsgIdAsync(l,e).then((e=>{o[l]=Object(I.a)({},e),this.clearUnreadConversation(u,o)})).catch((e=>{this.clearUnreadConversation(u,o)})));return Object(kd.a)([e],!1),a.lastSeenReactId=Ed.a.sendClearUnread(e,a.lastSeenReactId),this.resetUnreadToZero(e,a.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(void 0===e?void 0:this.toUnreadItem(e)))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t.map(this.toUnreadItem)))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Sd.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return this.logger.zsymb(3,"gFtbqG",["resetUnreadToZero {} {} skipped","LQ38Fm"],e,t),!1;if(this.logger.zsymb(3,"FvR1IS",["resetUnreadToZero {} {} {}","i-umcy"],e,t,s.smsUnreadCount),!Bo.Validator.assertString(t,this.logger))return!1;const a={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&yd.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(a).then((t=>(this.broadcastEvent(ai.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,"jMNFjy",["resetUnreadToZero failure {} {}","u43UrQ"],e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:a}=e,i=$r.default.isMyMessage(t),n=bd.b.isRead({userId:s,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object(Ld.f)(t)}),r=!t.msgId||!a||t.msgId<=a;return!n&&r&&!i}_updateTTLUnreadCount(e,t,s){const a=this.data.get(e)||null;if(this.logger.zsymb(0,"XFoDgU","_updateTTLUnreadCount",e,null==a?void 0:a.smsUnreadCount),a&&a.smsUnreadCount===t&&a.smsUnreadNotCount===s)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,i.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(i)}updateUnreadTTLConversation(e,t,s){const a=this.getUnreadByConvIdSync(e);if(a){let i=a.smsUnreadCount,n=a.smsUnreadNotCount;t.filter((t=>t.ttlType===Ad.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:a.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),a=ui.default.getDataReminder(t),r=$r.default.isMyMessage(t);a&&r&&(t.idTo===Ce.default.sendToMeId||r)?(n-=1,i-=1):i-=1})),this._updateTTLUnreadCount(e,Math.max(i,0),Math.max(n,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,"PD7QHf","updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let a=this.safeGetUnreadCached(e);a.smsUnreadCount=t,this.forkUpdateCacheAndDB(a)}updateMentionCount(e,t){this.logger.zsymb(0,"knlpeb","updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),Rd.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),a=null==s?void 0:s.smsUnreadCount,i=null==s?void 0:s.lastProcessMsgId;return!!a&&!!(i&&t&&+t>=+i)}onRollMessage(){}async forkUpdateCacheAndDB(e,t=!0){this.data.set(e.convId,e),this.signalRenderItem(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(I.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==Y.CONV_FILTER.STRANGER&&e!==zd))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const i=this.getEmptyTotal(),n=(null===(t=this.data.get(Y.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let r=0;const o=a.ModuleContainer.resolve(Qo.TUnreadSubChatTabStateManager),l=o.getAllSeenMilestones(),c={[Qo.SubChatTabType.FOCUSED]:!1,[Qo.SubChatTabType.ARCHIVED]:!1},d=new Map,u=new Map,h=new Map;me.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;h.set(t,t)}));const g=new Map,m=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t)continue;if(!(Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark)))continue;const s=o.getSubtabTypeOfConv(e),a=we.default.isMuted(e),i=t.lastProcessMsgId;!a&&o.isValidSubChatTabType(s)&&i>l[s]&&(c[s]=!0);if(un.a.isThreadHidden(e))continue;Zo.a.isArchivedChat(e)||(g.set(e,t),m.push(e))}Bd;const p=await Bo.ConvList.verifyOATypeAsync(m),f=async({cid:e,isOA:t,oaInfo:s})=>{const n=g.get(e),o=n.convId,l=this.acquireConvManager().getConvByIdSync(o),c=we.default.isMuted(o);if(t&&!(await Bo.ConvList.checkIfOAShouldShowInConvList(o))){const e=a.ModuleContainer.resolve(ii.b);if(!e||!e.isChatVisible(o))return void this.logger.zsymb(0,"UjBZ2z","calc total unread count, skip OA no topOut conv: ",o,t,null==l?void 0:l.topOut)}const h=n.smsUnreadCount||0,m=n.smsUnreadNotCount||0;if(i.smsUnreadCount+=h,l&&!c&&!this.shouldForceShowReddotForOAMessages_(o,t)&&l.userId!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(h-m,0);i.smsUnreadNomute+=e;const t=l.label?""+l.label:"",s="0"==t||!!t;if(s&&(d.has(t)?d.set(t,d.get(t)+e):d.set(t,e)),n.unreadMark){const e=i.unreadMark||0;i.unreadMark=e+1,s&&(u.has(t)?u.set(t,u.get(t)+1):u.set(t,1))}e>0&&this.isInStrangerBox(o)&&(r+=e)}};for(const{cid:e,isOA:t,oaInfo:s}of p)await f({cid:e,isOA:t,oaInfo:s});if(this.total.smsUnreadCount!==i.smsUnreadCount||this.total.smsUnreadNomute!==i.smsUnreadNomute||this.total.unreadMark!==i.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,a=we.default.isMuted(e);this.total=i,this.dispatchEvent(new ai.a(ai.b.ChangeUnreadCount,zd,{unreadNoMute:i.smsUnreadNomute,totalUnread:i.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:a?0:t})),this.data.set(zd,i),this.signalRenderItem(this.name,zd)}if(o.handleShowReddotsAtSubChatTab(c),n!==r){const e=this.safeGetUnreadCached("");e.smsUnreadCount=r,e.convId=Y.CONV_FILTER.STRANGER,this.data.set(Y.CONV_FILTER.STRANGER,e),this.signalRenderItem(this.name,Y.CONV_FILTER.STRANGER)}for(let e of Array.from(d.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=d.get(e),t.unreadMark=u.get(e),this.data.set(e,t),h.delete(e),this.signalRenderItem(this.name,e)}for(let e of Array.from(h.keys()))this.data.delete(e)&&this.signalRenderItem(this.name,e)}catch(i){this.logger.zsymb(21,"ihkfKM",[" unread err - contact phucnh7 please!!! {}","_Ukq19"],i)}}acquireConvManager(){return me.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,"ewrMi6","onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(Po.j)(s);a.ModuleContainer.resolve(En.PreviewDataManager);for(let a=0;a<t.length;a++){const i=t[a];if("object"==typeof i.lastProcessMsgId||"string"==typeof i.lastProcessMsgId&&i.lastProcessMsgId.includes("object")?(i.lastProcessMsgId="0",this.logger.zsymb(18,"TCVgnM","Corrected lastProcessMsgId!"),ul.default.increaseFailed(151101,0,0,0,Date.now())):bd.b.isRead({userId:i.convId,msgId:+i.lastProcessMsgId,e2eeStatus:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(i.smsUnreadCount||i.smsUnreadNotCount)&&(this.logger.zsymb(0,"PcffZG","clear offline",i.convId,i.smsUnreadCount),i.smsUnreadCount=0,i.strangerUnreadCount=0,i.smsUnreadNotCount=0),this.pendingClearUnread.has(i.convId)){const e=this.pendingClearUnread.get(i.convId);e&&e>=+i.lastProcessMsgId&&(this.logger.zsymb(0,"ulZy_q","clear pending",this.pendingClearUnread.size,i.convId),i.smsUnreadCount=0,i.strangerUnreadCount=0,i.smsUnreadNotCount=0)}"null"===i.lastProcessMsgId&&(i.lastProcessMsgId=""),this.data.set(i.convId,i),Object(Po.g)(s,this.name,i.convId),e===Vd&&this.updateInDB(i),i.unreadMark&&this.total.unreadMark++}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(Po.c)(s)}processPendingMessages(){this.logger.zsymb(0,"HqsjBF","start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,a=this.data.get(t);e.forEach((e=>{var t;(!a||a.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,"ddDAlR","check processPendingMessages #2",t,null==a?void 0:a.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const i=Array.from(s.values()),n=$r.default.getLastMessageInList(i);this.handleNewMessages(t,i,null==n?void 0:n.msgId)})),this.pendingMessage.clear()}async handleNewMessages(e,t,s){var a,i;if(!t||!t.length)return;if(!Bo.Validator.assertString(s,this.logger))return;let n=!1;const r={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},o=Date.now(),l=new Set,{isOA:c}=null!==(a=null===(i=await Bo.ConvList.verifyOATypeAsync([e]))||void 0===i?void 0:i[0])&&void 0!==a?a:{isOA:!1};if(t.forEach((t=>{const a=$r.default.isMyMessage(t);if(t.status!==Y.MSG_READ&&!a){const s=t.ts||t.serverTime||t.sendDttm;bd.b.isRead({userId:e,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object(Ld.f)(t)})&&(Ce.default.stagingAccount&&this.logger.zsymb(0,"qbV84B",`mark msg status as read ${e} ${t.msgId}`),t.status=Y.MSG_READ)}let i=Id.a.get(t.msgId,t.status);i!=t.status&&Ce.default.stagingAccount&&this.logger.zsymb(0,"JKGkUE",`change msg status ${t.status} => ${i}`),t.status=i;let d=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(d=!0)}}let u=ui.default.getDataReminder(t);if(t.status!==Y.MSG_READ&&!a||!0===d){if(t.paramsExt&&ui.default.valueValid(t.paramsExt.countUnread)){const s=this.shouldForceShowReddotForOAMessages_(e,c);(0==t.paramsExt.countUnread||1==t.paramsExt.countUnread&&s)&&(r.smsUnreadNotCount+=1)}this.isCallTimeMessage(t)||(r.smsUnreadCount+=1,r.strangerUnreadCount+=1),_d.b.isMessageMentionMe(t)&&r.mentionUnreadCount++}else u&&a&&(t.idTo===Ce.default.sendToMeId||a)?(r.smsUnreadCount+=1,r.smsUnreadNotCount+=1,this.logger.zsymb(0,"76U9us",`new unread #2: ${o} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):Od.a(t)?t.isCallMessage||(r.smsUnreadCount=0,r.strangerUnreadCount=0,r.mentionUnreadCount=0,n=!0):(l.add(t.msgId),this.logger.zsymb(0,"lONiLE","_addMessages: skipped clear unread for",t.idTo));r.smsUnreadCount>0&&El.b.markGotUnread(e,t.msgId),El.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),l.has(s))for(let u=t.length-1;u>=0;u--){const s=t[u];if(ui.default.validMessageFromServer(s)&&!l.has(s.msgId)){if(this.logger.zsymb(0,"SIrKgS","update last process id",e,r.lastProcessMsgId,s.msgId),r.lastProcessMsgId=s.msgId,!Bo.Validator.assertString(s.msgId,this.logger))return;break}var d;0==u&&(r.lastProcessMsgId=(null===(d=this.data.get(e))||void 0===d?void 0:d.lastProcessMsgId)||"0")}return Object(kd.a)([e]),this.updateUnread(e,n,r)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,"YCQVLO","handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=Md.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,"w2KvVn","detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let a=this.data.get(e);if(a){const e=a.lastSeenReactId||"0";t?a=s:(a.smsUnreadNotCount+=s.smsUnreadNotCount,a.smsUnreadCount+=s.smsUnreadCount,a.strangerUnreadCount+=s.strangerUnreadCount,a.mentionUnreadCount+=s.mentionUnreadCount,a.lastProcessMsgId=s.lastProcessMsgId),a.lastSeenReactId=e}else{if(a=s,!a)return void this.logger.zsymb(18,"ffEZkr",`updateUnread undefined item ${e}`);a.lastSeenReactId=Dd.b.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},a)),this.updateInDB(a),0!=s.mentionUnreadCount&&Rd.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=me.a.ConvInfoDataManager.getConvByIdSync(e);return yd.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===Y.CallMessageAction.CallTime)return!0;if(e.content.action===Y.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t={}){if(e&&e.smsUnreadCount)try{let s=!0,a=Object.keys(t);a&&0!=a.length||(s=!1,this.logger.zsymb(0,"EZOnuL",`[read-message] actually, no need send seen in that case 2: ${a.length}`)),!s&&Ce.default.chat_aggressive_send_seen&&(s=!0),s?(a&&0!==a.length?this.sendClearUnreadToServer(t,e.userId):we.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,Nd,e.smsUnreadCount,!0).then((t=>{let s=[],a={};if(t&&t.length)for(let e=0;e<t.length;e++){let i=t[e];ui.default.validMessageFromOther(i)&&(s.push(i.msgId),a[i.msgId]=i)}0===s.length?this.logger.zsymb(3,"E-n4nh",["- [read-message] get ids.length == 0 {}","naMExw"],e.userId):this.sendClearUnreadToServer(a,e.userId)})).catch((e=>{this.logger.zsymb(21,"Z72BaV",[" [read-message] get msgs err {}","TK3XCE"],e)})),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.clearUnreadMessages,{convId:e.userId})):this.logger.zsymb(3,"fE0ksx",["[read-message] no send {}","RX_rA2"],e.userId)}catch(s){this.logger.zsymb(21,"MCxvfI",["[read-message] err {}","K1mm_1"],s)}else this.logger.zsymb(0,"OxaAZz",`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e={},t){const s=Object.keys(e),a=yd.a.isGroup(t),i=ro.a.newReq();try{await Cl.default.sendSeen(e,t,a,i),Ce.default.stagingAccount&&this.logger.zsymb(0,"3FH7nX",`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(n){if(this.logger.zsymb(21,"WSUBdP",["[read-message] err {}","K1mm_1"],n),!(s&&s.length>0))throw this.logger.zsymb(21,"JGIGVf",["[read-message] send seen fail!!! convId:{} msgId len = 0","2m-YJo"],t),n;if(this.logger.zsymb(21,"TWljUN",["[read-message] send seen fail!! convId:{} msgId:{}","hwdIUr"],t,s[s.length-1]),n&&(114===n.error_code||-69===n.error_code))throw this.logger.zsymb(21,"713ebw",["[read-message] send seen fail!!! no need retry {}","x1z0vX"],n.error_code),n;throw Ce.default.retrySendSeen?(this.logger.zsymb(21,"egjUnt",["[read-message] send seen fail!!! retry","akmiH3"]),Cd.b.retryAction(Cd.a.SEND_SEEN_V2,[e,t,a,i],{startedTime:Date.now(),duration:Ce.default.retrySendSeen.timeout})):this.logger.zsymb(21,"QYDHkz",["[read-message] send seen fail!!! not retry","5Y-Q3p"]),n}}broadcastEvent(e,t,s){this.dispatchEvent(new ai.a(e,t,s))}signalRenderItem(e,t,s){this.conversationUIUpdater.signalRenderItem(e,t,s)}updateInDB(e){if(null==e.lastSeenReactId&&(e.lastSeenReactId=Dd.b.getLastSeen(e.convId)||"0",this.logger.zsymb(18,"YMW5aK",`update invalid lastSeen ${e.convId}`)),!Bo.Validator.assertString(e.lastProcessMsgId,this.logger))return;const t=this.toUnreadConvItemEntity(e);this.DBConvUnread.addOrUpdate(t)}deleteInDB(e){this.DBConvUnread.remove(e)}toUnreadItem(e){return Object(I.a)(Object(I.a)({},e),{},{unreadMark:e.unreadMark})}toUnreadConvItemEntity(e){return Object(I.a)({},e)}})||vd)||vd)||vd)||vd);var Wd=s("8Nax"),qd=s("GSHL"),Kd=s("w5bt");let $d;var Zd;(Zd=$d||($d={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},Zd.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};var Qd,Yd=s("yWVE");const Jd="zpm_m",Xd="1.0.0";Object(Ai.b)(Kd.b)(Qd=function(e,t){return a.ModuleContainer.inject(qd.b)(e,void 0,0)}(Qd=function(e,t){return a.ModuleContainer.inject(td.a)(e,void 0,1)}(Qd=Reflect.metadata("design:type",Function)(Qd=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB,void 0===td.a?Object:td.a])(Qd=class extends hs.b{constructor(e,t){super(),this.DBConvPreview=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.expiredConvs=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this.fetchAllHolder=void 0,this._Logger=void 0,this.name=Kd.a,this.key="convId",this.didInit=!1,this.data=new Map,this.expiredConvs=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1,this.fetchAllHolder=null}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t,s=!1){this.Logger.zsymb(12,"F56iMX","signalRenderItem allowAutoBatching",s);const a=s?this.conversationUIUpdater.signalRenderItem:Po.h,i=s?this.conversationUIUpdater.signalRenderList:Po.i;a(e,t),this.broadcastEvent(ai.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())}),i(e,"all")}loadData(){return new Promise(((e,t)=>{n.default.getInstance().getItemForCurrentUser(Jd)!==Xd||this.migrating?e():(this.Logger.zsymb(3,"ntfu4O",["start load preview","V1akiK"]),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,"XLDnAs",["load previews from db failure #1! {}","bHhj6w"],t),e()}))})).catch((t=>{this.Logger.zsymb(21,"Fq3Xci",["load preview from db failure #2! {}","T9mTo4"],t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await hd.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,"cb5HCW",["revalidate failure #1 {} {} {}","3pnDXj"],e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,"hXFNl3",["revalidate success {} {} {}","dGNZMs"],e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,"LRyeJT",["revalidate failure #2 {} {} {}","CZNTyg"],e,t,s),!1)))}migrate(e,t=!1){return new Promise((s=>{const a=n.default.getInstance().getItemForCurrentUser(Jd);if(a===Xd&&!t)return;if(this.Logger.zsymb(3,"c3BNE0",["start migrate {} {}","Y7cTRT"],a,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let i=0,r=0;const o=()=>{if(i++,i===e.length)return this.doneMigratePreivew(r),s(r)},l=()=>{r++,o()},c=()=>{for(let t=0;t<e.length;t++)hd.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(l).catch(o):(this.Logger.zsymb(3,"Q8unzO",["migrate not exists msg {}","etonzT"],e[t]),o())})).catch((s=>{o(),this.Logger.zsymb(21,"_Y5m8U",["migrate failure for conv {} {}","-pYcVA"],e[t],s)}))};let d=e.filter((e=>e!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==Y.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(Y.GROUPID_PREFIX)));if(d.length>0)return Ii.default.getProfileFriendByIds(d,Y.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{c()})).catch((()=>{c()}));c()}))}doneMigratePreivew(e){this.Logger.zsymb(3,"7nVuUS",["done migrate preview {}","-L3kCY"],e);n.default.getInstance().setItemForCurrentUser(Jd,Xd),this.broadcastEvent(ai.b.DoneMigratePreview,"")}upgradeItemsVersion(e=[]){this.Logger.zsymb(3,"a3EAmV",["upgradeItemsVersion","kjRn6O"]);const t=(new Date).getTime().toString();Object(Po.j)(t),0!==e.length?e.forEach((e=>{Object(Po.g)(t,this.name,e)})):this.data.forEach((e=>{Object(Po.g)(t,this.name,e.convId)})),Object(Po.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(Y.CONV_FILTER.STRANGER,Object(I.a)({},t)),this.conversationUIUpdater.signalRenderItem(this.name,Y.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,"crSCZI",["try to get item not exist in cache {}","XkWqJN"],e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,"sikl_3",["onGetItemFailure {}","mJ71GX"],e)}onGetListFailure(e,t){this.Logger.zsymb(11,"r8WCuW",["onGetListFailure {} {}","xBhGQr"],e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,"87eGUc",["onLoadPreviewsFromDB {}","FoQt47"],null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let a=0;const i=()=>{a++,a===e.length&&(this.doneLoadPreview(a),t())};for(let n=0;n<e.length;n++){const t=$d.entityToModel(e[n]);t&&!Wd.a.instance.filterExpiredPreview(t)&&(t.messageType=Y.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{i()})).catch((e=>{i(),this.Logger.zsymb(21,"ZyyHrS",["onload preview failure for item {} {}","drjg1-"],null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,"JMIJUH",["doneLoadPreview {}","9g6IYa"],e),this.doneLoadDB=!0,this.broadcastEvent(ai.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(Po.i)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,a)=>{if(!t)return s(!1);const i=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(i).then((a=>{if(a){const a="server"===e;return this.signalRenderItem(this.name,t.toUid,a),s(!0)}return s(!1)})).catch(a),this.smartDispatchEvent(ai.b.ReceiveNewMsg,(()=>new ai.f(e,t)))}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const a=this.groupMessageByConvId(t),i=[];for(const e in a){if(!Object.prototype.hasOwnProperty.call(a,e))continue;const t=a[e];for(let e=t.length-1;e>=0;e--){if($r.default.isValidPreviewMessage(t[e])){i.push(t[e]);break}this.Logger.zsymb(3,"WVaFCC",["receive msg but not preview {}","Is6LOq"],t[e].msgId)}}return i.length?Promise.all(i.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,"HMkcsd",["add messages to preview got error {}","x8xr1z"],e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,"PYdaTu",["onUndoMessage {}","ftVUn5"],t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=Y.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,a=this.data.get(s);if(this.Logger.zsymb(3,"Z70nOJ",["onUpdateE2EEMessage {} {} {}","hbc_9j"],s,null==a?void 0:a.msgId,t.msgId),a&&(a.msgId!==t.msgId||!_d.b.isSameMsg(a,t)))return;const i=this.convertDBMessageToPreviewItem(e,t),n=ui.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;i.message=i.message||$r.default.getPlainText({msgType:n}),i.verified=!0,i.messageType=n,this.data.set(t.toUid,i),this.updateInDB(i),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,"PrHQr8",["onDeleteMessage {}","N1WPYF"],t.msgId);const a=this.convertDBMessageToPreviewItem("db.message",t);t.msgType===Y.MSG_DEL_EVERYONE&&(a.messageType=Y.MSG_DEL_EVERYONE,a.message=""),this.deleteMessageInManager(a).then((s=>{s?(this.Logger.zsymb(3,"_HuWnv",["onDeleteMessage success {}","d3IKZE"],t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onRollMessage(){const e=new Map;this.data.forEach((t=>{Object(Yd.c)(t)?this.expiredConvs.set(t.convId,t):e.set(t.convId,t)})),this.data=e,Object(Po.i)(this.name,"all")}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const a in s)if(Object.prototype.hasOwnProperty.call(s,a)){const t=s[a];let i=this.convertDBMessageToPreviewItem(e,t[0]),n=0;for(let s=1;s<t.length;s++){const a=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(i,a)&&(n=s,i=a)}this.onDeleteMessage(e,t[n])}}onDeleteConversation(e,t){e&&(this.Logger.zsymb(3,"Yv7Sru",["onDeleteConversation {}","6JV56F"],e),"kick"!==t&&"disband"!==t?(this.data.delete(e)&&Object(Po.f)(this.name,e),this.deleteInDB(e)):this.onLeaveConversation(e,t))}async onLeaveConversation(e,t){try{const s=this.data.get(e);if(!s)return void this.Logger.zsymb(21,"2YvXY0",["onLeaveConversation leavePreview not exist {}","a_VzxX"],e);s.message="",s.messageType="disband"===t?Y.MSG_DISBAND_GROUP:Y.MSG_KICK_GROUP,this.data.set(e,s),this.signalRenderItem(this.name,e),this.updateInDB(s)}catch(s){this.Logger.zsymb(21,"2Pzbwn",["onLeaveConversation error {}","WSYjVk"],e)}}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);return!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?(!s&&t&&(this.data.set(e,{convId:e,msgId:Y.FAKE_DRAFT_MSG_ID,draft:t,messageTime:-1}),this.signalRenderItem(this.name,e)),void this.Logger.zsymb(3,"3FXFxs",["onChangeDraft - reject {}","FV5ua6"],!!s)):(this.Logger.zsymb(3,"nsjX-y",["onChangeDraft - call update {}","ZICWbt"],!!s),s.msgId!==Y.FAKE_DRAFT_MSG_ID||t?void((s.draft||t)&&(s=Object(I.a)(Object(I.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),this.broadcastEvent(ai.b.DraftChanged))):(this.data.set(e,{convId:e,msgId:Y.FAKE_DRAFT_MSG_ID,draft:void 0,messageTime:-1}),this.signalRenderItem(this.name,e),void this.data.delete(e)))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,"qROdPI",["get item not exist with id {}","PhcruW"],e);const a=$d.entityToModel(s);t(a||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(e){return new Promise(((t,s)=>{if(this.doneLoadDB&&!e)return t(this.getAllPreviewsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((e=>{const s=e.map((e=>$d.entityToModel(e)));t(s)})).catch(s)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}getAllPreviewsForSearch(){return this.getAllPreviewsSync()}setPreview(e,t,s,a,i,n=1,r={}){const o=this.data.get(e);this.Logger.zsymb(3,"kyp3CZ",["call set preview {} {}","MHrUPu"],e,!!o);const l={convId:e,msgId:r.msgId||"unset",src:"ui",dName:r.dName||"",message:t,messageType:"",isGroup:e.startsWith(Y.GROUPID_PREFIX),messageTime:s,fromUid:a,toUid:i,urgencyLevel:r.urgencyLevel,properties:null,verified:!0,status:n,computedMessage:t,computedIcon:r.icon};this.data.set(e,l),this.signalRenderItem(this.name,e),this.updateInDB(l)}setPreviewContentIfMatched(e,t,s){const a=this.data.get(e);if(void 0===a||a.msgId!==t)return;const i=Object(I.a)(Object(I.a)({},a),{},{message:s});this.data.set(e,i),this.signalRenderItem(this.name,e),this.updateInDB(i)}async rejectLatestPreview(e){void 0!==this.data.get(e)&&(this.data.delete(e),await this.DBConvPreview.remove(e),await this.revalidate(e))}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let a=!1;if(Object(Yd.c)(e))return this.expiredConvs.set(t,e),!1;if(this.expiredConvs.has(t)&&this.expiredConvs.delete(t),s){const i=!(s.messageType||s.message||!e.messageType||!e.message);i&&(s.verified=!0,this.Logger.zsymb(3,"OH8iVm",["force update new preview item {}","TUYzo2"],t)),(i||this.isSecondItemNewer(s,e))&&(this.data.set(t,e),a=!0,s.verified?(e.verified=!0,this.updateInDB(e)):a=await this.compareCacheWithDBAndUpdate(t,e))}else this.data.set(t,e),a=!0,"db.preview"!==e.src&&(a=await this.compareCacheWithDBAndUpdate(t,e));return a}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!_d.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const a=async()=>{const a=await hd.b.getPreviewMessage(t),i=this.deleteQueue.find((e=>{var t;return e.msgId===(null===(t=a.previewMsg)||void 0===t?void 0:t.msgId)}));if(i)return e.messageType===Y.MSG_DEL_EVERYONE&&(i.messageType=Y.MSG_DEL_EVERYONE,i.message=""),this.data.set(t,i),await this.deleteMessageInManager(i);this.deleteQueue=[];const n=this.data.get(t);if(n&&this.isSecondItemNewer(s,n))return!1;if(a.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",a.previewMsg);return s.verified=!0,e.messageType===Y.MSG_DEL_EVERYONE&&(s.messageType=Y.MSG_DEL_EVERYONE,s.message=""),this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(Po.f)(this.name,t),!1};if(s.verified)return await a();{const s=await this.DBConvPreview.getById(t),i=s&&$d.entityToModel(s);return i&&this.isSecondItemNewer(e,i)?(this.data.set(t,i),!0):await a()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const a=t.fromUid||t.uidFrom,i=t.toUid||t.idTo,n=i&&i.startsWith(Y.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:n,messageTime:s,fromUid:a,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||_d.b.isSameMsg(e,t)?t.messageType===Y.MSG_UNDO&&e.messageType!==Y.MSG_UNDO||Bo.ConvList.comparePreviewStt(t.status,e.status)>0:e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,a)=>{this.DBConvPreview.getById(e).then((a=>{this.Logger.zsymb(3,"ZUnDwI",["compareCacheWithDBAndUpdate {} {}","xGUKmn"],e,!!a);const i=$d.entityToModel(a),n=this.data.get(e);if(JSON.stringify(n)!==JSON.stringify(t))return s(!1);!i&&n||i&&n&&this.isSecondItemNewer(i,n)?(n.verified=!0,this.updateInDB(n)):i&&this.data.set(e,i),s(!0)})).catch(a)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,"wnf1bE",["update in db {}","xJ_pL_"],e.msgId);try{const t=$d.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,"aQpIBx",["update in db got err{}","lunTH8"],t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,"f8frg_",`[${this.name}] - deleteInDB got error ${e}`)}))}})||Qd)||Qd)||Qd)||Qd);var eu=s("rKwX"),tu=s("SWKE");const su="z_ml";class au{constructor(){this.cache=void 0,this.cache={}}localKey(e){return su+"_"+e}muteConversation(e,t){const s=n.default.getInstance(),a=su+"_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(a),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=n.default.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(a){ui.default.logCoreError(a)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=Y.GROUPID_PREFIX+t.id,e.push(t),e)),t);tu.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=n.default.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var iu;Object(Ai.b)(En.MuteDataManager)(iu=Reflect.metadata("design:type",Function)(iu=Reflect.metadata("design:paramtypes",[])(iu=class extends hs.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=En.MUTE_MANAGER_NAME,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new au),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,a)=>{this._clearTimeout(e);let i=-1;switch(t){case 1:i=3600;break;case 2:i=14400;break;case 3:i=Math.round(this._getNowTo8Am()/1e3)}ui.default.logCoreInfo(`[${this.name}] - onMute ${e} ${i}`),eu.a.lock(e,i,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(a)}))}onUnMute(e,t=!0,s=!1){return new Promise(((a,i)=>{this._clearTimeout(e),ui.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),eu.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),a(!!t)})).catch(i)}))}onFetchMute(e){ui.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){ui.default.logCoreError(t)}}doLock(e,t=!0){if(this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){ui.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(ui.default.log("setTimer: lock1",e.id),ui.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),ui.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(ui.default.log("setTimer: unlock",s),ui.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(Po.h)(this.name,e),this.broadcastEvent(ai.b.MuteChanged,e,t)}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}})||iu)||iu);var nu,ru=s("qvRd");const ou="zpinc",lu="ver_pin",cu=0,du=1,uu=2;Object(Ai.b)(ru.b)(nu=Reflect.metadata("design:type",Function)(nu=Reflect.metadata("design:paramtypes",[])(nu=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=ru.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}async _loadData(){const e=n.default.getInstance().getItemForCurrentUser(ou);if(e&&e.length)try{const s=JSON.parse(e),a=Object.keys(s).map((async e=>{await this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:Number(s[e].priority)||Ct.default.getTimeNow()})}));await Promise.all(a);try{this.Logger.zsymb(0,"AhaO4V","pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,"yutr_I","stringify fail")}this.doneLoadDB=!0;const i=this.getAllPinnedConversations();i.length&&this._broadcastEvent(ai.b.ChangePinConv,i)}catch(s){0}}_addListener(){Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,"a0iTlS","remove friend - unpin",e.userId),this.updateListPin([e.userId],uu)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new ai.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,"hQU6op","client pin",e),new Promise((async(t,s)=>{const a=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(a){if(this.data.size+e.length>Ce.default.limit_pin_messages)return s(null);let a=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||a.push(e[t]);if(a.length>0)try{const s=await this._syncServer(a,du);return this.updateListPin(e,du),t(s)}catch(i){return s(i)}}return s(null)}))}pinLocal(e){this.updateListPin(e,du)}unpin(e,t=!1){return this.Logger.zsymb(0,"d02YuO","client unpin",e,"force sync",t),new Promise((async(s,a)=>{if(!e||!e.length)return a(null);if(await this._checkAndSyncDataBeforeAction()){let n=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&n.push(e[s]);if(n.length>0)try{await this._syncServer(n,uu),this.updateListPin(e,uu),s(1)}catch(i){a(i)}}return a(null)}))}unpinLocal(e){this.Logger.zsymb(0,"KVus97","unpin local",e),this.updateListPin(e,uu)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===du)).length}async _verifyPin(e){try{const{isOk:t,index:s}=await this.checkPromises([()=>Promise.resolve(Ii.default.isFriend(e)),()=>Promise.resolve(hn.default.getGroupByIdSync(e)),()=>Promise.resolve(e===Ce.default.sendToMeId),()=>new Promise((t=>{Ii.default.getProfileFriendByIds([e],Y.SRC_GET_PROFILE.FETCH_MINI_INFO,{isReqOAInfo:!0}).then((s=>{var a;return t((null==s||null===(a=s[e])||void 0===a?void 0:a.type)>=1)})).catch((()=>t(!1)))}))]);return this.Logger.zsymb(3,"OrTAAJ",["verify pinned conversation","ZDkuFo"],e,t,s),t}catch(t){return this.Logger.zsymb(21,"8QSawQ",["Error checking if conversation is OA","jePTnL"],e,t),!1}}async checkPromises(e){for(let s=0;s<e.length;s++)try{if(await e[s]())return{isOk:!0,index:s}}catch(t){continue}return{isOk:!1,index:-1}}async updateListPin(e,t){if(this.Logger.zsymb(0,"TMCYhB","updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case du:{let t=Ct.default.getTimeNow();const a=e.map((async e=>{if(await this._verifyPin(e)&&!this.data.has(e)){++t,this.requestingIds.get(e)&&this.requestingIds.set(e,cu);return{convId:e,pin:this._newPinItem(e,t)}}return null}));(await Promise.all(a)).forEach((e=>{e&&(this.data.set(e.convId,e.pin),s.push(e.pin),Object(Po.h)(this.name,e.convId))}));break}case uu:for(let t=0;t<e.length;t++)if(this.data.has(e[t])){this.requestingIds.get(e[t])&&this.requestingIds.set(e[t],cu),this.data.delete(e[t]);const a=this._newPinItem(e[t],0);s.push(a),Object(Po.h)(this.name,e[t])}break;default:return}s.length&&this._broadcastEvent(ai.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,"0NFu3M","hasn't pinned conversation from server");n.default.getInstance().setItemForCurrentUser(lu,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,"RRQfK5",["Handle request error fail with error: {}, retry after time= {}","4jHabc"],e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,"lM-itH","_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{Jr.default.getPinnedConversations().then(Xr.a).then((t=>{if(t&&t.conversations){const e=n.default.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(lu,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,a)=>{if(!Ce.default.enable_sync_pinned)return;if(!ce.b.getStateNetwork())return void a(t===du?le.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):le.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let i=[];for(let n=0;n<e.length;++n)e[n].startsWith("g")||e[n].startsWith("u")||(e[n]="u"+e[n]),i.includes(e[n])||this.requestingIds.has(e[n])&&this.requestingIds.get(e[n])!==cu||(i.push(e[n]),this.requestingIds.set(e[n],t));i.length&&Jr.default.updatePinnedConversationsV2(i,t).then(Xr.a).then((()=>{i.forEach((e=>{this.requestingIds.set(e,cu)})),s(!0)})).catch((e=>{i.forEach((e=>{this.requestingIds.set(e,cu)})),this.Logger.zsymb(20,"6llW4P","Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=le.a.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&ce.b.getStateNetwork()==ce.a.DISCONNECT&&(s=t===du?le.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):le.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));a(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,a)=>{e!==t[a]&&(s=!0)})),s}async _onFetchPin(e){this.Logger.zsymb(0,"f86B1y","onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=Ct.default.getTimeNow(),this.reFetchCount=0;let t=Ct.default.getTimeNow();this._setFetchInterval();const s=[],a=[];for(let n=0;n<e.length;n++)try{await this._verifyPin(e[n])?a.push(e[n]):this.unpin([e[n]],!0)}catch(i){this.Logger.zsymb(18,"WKqdBn","Error verifying pin for conversation",e[n],i)}if(this._isRemoteDataChanged(a)){for(const e of Array.from(this.data.values()))a.find((t=>t===e.id))||(this.data.delete(e.id),Object(Po.h)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<a.length;e++){const i=this._newPinItem(a[e],t),n=this.isPinned(a[e]);this.data.set(a[e],i),n||Object(Po.h)(this.name,a[e]),t--,s.push(i)}this.Logger.zsymb(0,"byibJ0","[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(ai.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),du)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,"3ja-A1","onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,"0W3wqs","onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=n.default.getInstance();this.data.size?e.setItemForCurrentUser(ou,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(ou)}})||nu)||nu);var hu,gu=s("MnJw");Object(Ai.b)(gu.b)(hu=Reflect.metadata("design:type",Function)(hu=Reflect.metadata("design:paramtypes",[])(hu=class extends hs.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new ai.a(ai.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new ai.a(ai.b.OnOffArchivedChat,"",{status:e}))}})||hu)||hu);var mu=s("413w"),pu=s("KGrx"),fu=s("YZUF"),vu=s("k1WO"),_u=s("DS8e");class bu extends Error{constructor(e){super(e.message||e.code),this._code=void 0,this._code=_u.a[e.code]}get code(){return this._code}}var Iu=s("8Isn"),yu=s("iRKH"),Su=s("hNYB"),Cu=s("jnJr"),Eu=s("2+pv"),Ou=s("QDKs");function Mu(e){if(!e)return!1;if(!["string","number"].includes(typeof e))return!1;if("string"==typeof e){const t=Number(e);if(isNaN(t)||(t+"").length!==e.length)return!1}return!0}function Tu(e){return(e+"").startsWith(Y.GROUPID_PREFIX)}function wu(e,t){return new Promise((async(s,a)=>{try{const a=null==t?void 0:t.limit;let o=await Ru(e);var i,n,r;if(o)e.cliMsgId=null===(i=o.msg)||void 0===i?void 0:i.cliMsgId,e.fromUid=null===(n=o.msg)||void 0===n?void 0:n.fromUid,e.toUid=null===(r=o.msg)||void 0===r?void 0:r.toUid;let l=await function(e,t){return new Promise((async(s,a)=>{try{if(!e.convId||!e.cliMsgId)return s(void 0);const a={msgId:e.msgId+"",cliMsgId:e.cliMsgId+"",fromUid:e.fromUid+"",toUid:e.convId+""},i=Xt.default.getInstance(),n={index:"cliMsgIdIndex",limit:t,direction:O.c.PREV,predicate:e=>Object(Iu.a)(e,a),partition:e.convId},r={from:e.cliMsgId+"",to:e.cliMsgId+"",excludeFrom:!1,excludeTo:!1},o=await i.Core.Message.getAll(r,n);let l=o[0];const c=o.map((e=>e.msgId)),d=[];o.length>1&&a.fromUid&&(l=o.reduce(((e,t)=>{var s,i;return t.fromUid!==a.fromUid?e:(e||(e=t),t.isLocalMsgId||null!==(s=t.msgId)&&void 0!==s&&s.includes("_")?(e.msgId!==t.msgId&&d.push(t.msgId),e):e.isLocalMsgId||null!==(i=e.msgId)&&void 0!==i&&i.includes("_")?(d.push(e.msgId),e=t):(Number.isInteger(parseInt(e.msgId))&&Number.isInteger(parseInt(t.msgId))&&(parseInt(e.msgId)>parseInt(t.msgId)||parseInt(e.msgId)==parseInt(t.msgId)&&e.msgId>t.msgId)&&(d.push(e.msgId),e=t),e))}))),s({msg:l,msgIds:c,duplicatedMsgIds:d})}catch(i){Ru(e).then(s).catch(a)}}))}(e,a);if(o)return s({msg:o.msg,msgIds:(null==l?void 0:l.msgIds)||[],duplicatedMsgIds:(null==l?void 0:l.duplicatedMsgIds)||[]});if(null!=l&&l.msg)return s(l);s(void 0)}catch(o){a(o)}}))}function Ru(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);if(!e.msgId)return t(void 0);const s=Xt.default.getInstance(),a=await s.Core.Message.get(e.msgId,{partition:e.convId});if(a)return t({msg:a,msgIds:[a.msgId],duplicatedMsgIds:[]});t(void 0)}catch(a){s(a)}}))}function Lu(e){if(!e)return;const{msgId:t,cliMsgId:s,fromUid:a,toUid:i}=Object(yu.c)(e);if(Mu(s)&&Mu(a)&&t)return{ownerId:a+"",cliMsgId:s+"",globalMsgId:mu.a.normalize(t),destId:i}}async function Du(e){try{const t=Xt.default.getInstance(),s={from:[e,"",""],to:[e,tl,el],excludeFrom:!1,excludeTo:!1},a={index:"userId_sendDttm_msgId",limit:1,direction:O.c.PREV,partition:e,predicate:e=>!!(e.cliMsgId&&e.fromUid&&e.msgId)},i=await t.Core.Message.getAll(s,a);return null==i?void 0:i[0]}catch(t){return}}const Au=Object(Uc.d)()?Ou.a:{info:void 0,warn:void 0,error:void 0,zlog:Ou.a.zlog};var Fu;let ku=Object(a.injectable)()(Fu=function(e,t){return Object(a.inject)(En.ConvInfoDataManager)(e,void 0,0)}(Fu=function(e,t){return Object(a.inject)(En.PreviewDataManager)(e,void 0,1)}(Fu=Reflect.metadata("design:type",Function)(Fu=Reflect.metadata("design:paramtypes",[void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager,void 0===En.PreviewDataManager?Object:En.PreviewDataManager])(Fu=class extends hs.b{constructor(e,t){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.database=void 0,this.taskManager=void 0,this.joinGroupTime={},this.receivedActions={},this.database=Xt.default.getInstance(),this.taskManager=(new pu.TaskManager).setup("conversation-operation");const s=()=>{vu.a.key("enable_restore_task").boolean&&(vu.a.remove(s),this.restoreBackupTasks())};vu.a.add(s)}deleteConversation(e,t){return new Promise((async(s,a)=>{try{var i,n,r,o,l;if(null===(i=Au.info)||void 0===i||i.call(Au,Yo,`${e} Delete conversation start`,t),Au.zlog.zsymb(0,"kS9h7g",`${e} ${Yo} Delete conversation start`),fu.b.start(fu.a.ART_delete_conversation_v2),!e)throw new bu({code:"INVALID_CONVERSATION_DATA",message:`${e} Delete conversation info is invalid`});const a=await this.convInfoDataManager.getConvById(e),u=await this.previewDataManager.getPreviewById(e),h=(null==t?void 0:t.deleteTime)||Ct.default.getTimeNow();let g=(null==t||null===(n=t.messageInfo)||void 0===n?void 0:n.msgId)||(null==u?void 0:u.msgId),m=(null==t||null===(r=t.messageInfo)||void 0===r?void 0:r.cliMsgId)||(null==u?void 0:u.cliMsgId);if(void 0===g){const t=await Du(e);g=null==t?void 0:t.msgId,m=null==t?void 0:t.cliMsgId}const p={convId:e,msgId:g,cliMsgId:m,toUid:e,fromUid:null==t||null===(o=t.messageInfo)||void 0===o?void 0:o.fromUid,initialDeleteTime:h,deleteTime:h,isGroup:Tu(e),isLeaveGroup:null==t?void 0:t.isLeaveGroup,isLeaveGroupInSilentMode:null==t?void 0:t.isLeaveGroupInSilentMode,leaveType:null==t?void 0:t.leaveType,isForceDelete:null==t?void 0:t.isForceDelete,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,isExistConvInfo:!!a,isExistPreviewInfo:!!u,delConversationId:e},f=`${p.convId}_${p.msgId}_${p.cliMsgId}`;if("client"!==(null==t?void 0:t.source)||null!=t&&t.isDisableSync){if("server"===(null==t?void 0:t.source)&&this.receivedActions[f]){var c;return delete this.receivedActions[f],null===(c=Au.warn)||void 0===c||c.call(Au,Yo,`${p.convId} Delete conversation is duplicate action ${f}`),fu.b.cancel(fu.a.ART_delete_conversation_v2),s(p)}}else this.receivedActions[f]=!0;if(!this.isNewDeleteEvent(e,p.initialDeleteTime))throw new bu({code:"CANCEL_DELETE_CONVERSATION",message:`${e} Delete conversation info is old event`});var d;if(!p.isForceDelete&&(ui.default.isKickOrDisbandGroup(a)||(null==u?void 0:u.messageType)===Y.MSG_KICK_GROUP||(null==u?void 0:u.messageType)===Y.MSG_DISBAND_GROUP))return null===(d=Au.warn)||void 0===d||d.call(Au,Yo,`${e} Delete conversation info is kick or disband group`),fu.b.cancel(fu.a.ART_delete_conversation_v2),s(p);this.fireEventsBeforeDeleteConversation(p);if(vu.a.key("sync_delete_conversation").boolean&&!(null!=t&&t.isDisableSync)){const t=await this.createSyncDeleteConversationData(e,{msgId:p.msgId,cliMsgId:p.cliMsgId,fromUid:p.fromUid});this.syncDeleteConversation(e,t)}await this.deleteConversationInfo(p),this.deleteMessagesWithConversationInfo(p),this.fireEventsAfterDeleteConversation(p),null===(l=Au.info)||void 0===l||l.call(Au,Yo,`${e} Delete conversation success`,p),Au.zlog.zsymb(0,"9W0u2Y",`${e} ${Yo} Delete conversation success`),fu.b.end(fu.a.ART_delete_conversation_v2),s(p)}catch(h){var u;const t=h;null===(u=Au.error)||void 0===u||u.call(Au,Yo,`${e} Delete conversation error`,t.code||-1,t),Au.zlog.zsymb(18,"LHWnto",`${Yo} ${e} Delete conversation error ${t.message}`),fu.b.end(fu.a.ART_delete_conversation_v2,{isFailed:!0,errorCode:t.code||-1}),a(t)}}))}deleteMessage(e,t){return new Promise((async(s,a)=>{const{convId:i,msgId:n,cliMsgId:r,fromUid:o,toUid:l,uidSenderDel:c}=e;try{var d,u;const a=(null==t?void 0:t.type)||"only-me";null===(d=Au.info)||void 0===d||d.call(Au,Yo,`${n} Delete message start`,e,t),Au.zlog.zsymb(0,"yt5-E5",`${Yo} ${n} Delete message start`),fu.b.start(fu.a.ART_delete_message_v2);const h={convId:i,msgId:n,cliMsgId:r,fromUid:o,toUid:l,uidSenderDel:c,type:a,isDisableSync:(null==t?void 0:t.isDisableSync)||!0,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,conversation:{userId:i}};if(!function(e){return!(!e.convId||!e.cliMsgId)}(h))throw new bu({code:"INVALID_MESSAGE_DATA",message:`${n} Delete message info is invalid`});const g=await this.deleteMessageWithMessageInfo(h)||{};null===(u=Au.info)||void 0===u||u.call(Au,Yo,`${n} Delete message success`,h),Au.zlog.zsymb(0,"n4-2vu",`${Yo} ${n} Delete message success`),fu.b.end(fu.a.ART_delete_message_v2),s(Object(I.a)(Object(I.a)({},h),g))}catch(g){var h;const e=g;null===(h=Au.error)||void 0===h||h.call(Au,Yo,`${n} Delete message error`,e.code||-1,e),Au.zlog.zsymb(18,"9T7WW5",`${Yo} ${n} Delete message error ${e.message}`),fu.b.end(fu.a.ART_delete_message_v2,{isFailed:!0,errorCode:e.code||-1}),a(e)}}))}setJoinGroupTime(e,t){e&&t&&(!this.joinGroupTime[e]||this.joinGroupTime[e]<t)&&(this.joinGroupTime[e]=t)}restoreBackupTasks(){const e=this.createDeleteConversationTask();e.onRestore((t=>{if(t)for(let e in t)this.deleteMessagesWithConversationInfo(t[e],!1);e.close(!0,"Restore delete conversations")}));const t=this.createDeleteMessageTask();t.onRestore((e=>{if(e)for(let t in e)this.deleteMessageWithMessageInfo(e[t],!1);t.close(!0,"Restore delete messages")}))}isNewDeleteEvent(e,t){return!this.joinGroupTime[e]||!t||this.joinGroupTime[e]<t}syncDeleteConversation(e,t){return new Promise((async(s,a)=>{try{var i,n;if(null===(i=Au.info)||void 0===i||i.call(Au,Yo,`${e} Sync delete conversation start`,t),Au.zlog.zsymb(0,"KKqiu7",`${Yo} ${e} Sync delete conversation start`),fu.b.start(fu.a.ART_delete_conversation_sync_v2),!t)throw new bu({code:"INVALID_CONVERSATION_DATA",message:`${e} Sync delete conversation data is invalid`});await Cl.default.syncDeleteConversation(e,Tu(e),t,xl.a.next()+""),null===(n=Au.info)||void 0===n||n.call(Au,Yo,`${e} Sync delete conversation success`),Au.zlog.zsymb(0,"5hiJ3j",`${Yo} ${e} Sync delete conversation success`),fu.b.end(fu.a.ART_delete_conversation_sync_v2),s()}catch(o){var r;const t=new bu({code:"SYNC_CONVERSATION_ERROR",message:`${e} Sync delete conversation failed`});null===(r=Au.error)||void 0===r||r.call(Au,Yo,`${e} Sync delete conversation failed`),Au.zlog.zsymb(18,"1eAv-c",`${Yo} ${e} Sync delete conversation failed`),fu.b.end(fu.a.ART_delete_conversation_sync_v2,{isFailed:!0,errorCode:t.code||-1}),a(t)}}))}deleteConversationInfo(e){return new Promise((async(t,s)=>{try{if(!e.convId)throw new bu({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`});if(vu.a.key("leave_conversation_ui").boolean&&!Dl.q.isCommunity(e.convId)||delete e.leaveType,"disband"===e.leaveType){const t=hn.default.getGroupByIdSync(e.convId);(null==t?void 0:t.creatorId)&&t.creatorId===Ii.default.getUidMe()&&delete e.leaveType}const s=e.isLeaveGroup||e.convId===Ce.default.sendToMeId;this.previewDataManager.onDeleteConversation(e.convId,e.leaveType),s?await this.convInfoDataManager.onDeleteConversation(e.convId,e.leaveType):await this.convInfoDataManager.onEmptyConversation(e.convId),e.isForceDelete&&hn.default.removeGroupById(e.convId),t()}catch(a){s(new bu({code:"CONVERSATION_INFO_ERROR",message:`${e.convId} Delete conversation info failed`}))}}))}deleteMessagesWithConversationInfo(e,t=!0){return new Promise((async(s,a)=>{const i=this.createDeleteConversationTask(),n=i=>{var n;null===(n=Au.error)||void 0===n||n.call(Au,Yo,`${e.convId} Run delete messages error`,i.code||-1,i),Au.zlog.zsymb(18,"T68pr-",`${Yo} ${e.convId} Run delete messages error ${i.message}`),fu.b.end(fu.a.ART_delete_messages_in_batch_v2,{isFailed:!0,errorCode:i.code||-1}),t?a(i):s()};i.execute((()=>{fu.b.start(fu.a.ART_delete_messages_in_batch_v2),this.runDeleteMessages(e,(()=>{fu.b.end(fu.a.ART_delete_messages_in_batch_v2),s(),i.close()}),(e=>{n(e),i.close()}))}),e),i.onError((e=>n(e)))}))}async runDeleteMessages(e,t,s){try{if(e.convId&&!this.isNewDeleteEvent(e.convId,e.initialDeleteTime))return void s(new bu({code:"CANCEL_DELETE_CONVERSATION",message:`${e.convId} Delete batch messages is canceled`}));const a=await this.getDeleteInfoByThread(e);if(!a)throw e.isExistConvInfo&&e.isExistPreviewInfo?new bu({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`}):new bu({code:"NOT_FOUND_CONVERSATION",message:`${e.convId} Conversation not found`});const i=Object(I.a)({},e);i.msgId!=a.maxMsgId&&(i.msgId=a.maxMsgId),i.deleteTime&&a.maxSendDttm&&i.deleteTime!=a.maxSendDttm&&(i.deleteTime=a.maxSendDttm),i.cliMsgId!=a.maxCliMsgId&&(i.cliMsgId=a.maxCliMsgId),this.database.Core.runFakeTransaction([this.database.Core.Message],(async([n])=>new Promise((async()=>{try{var r,o,l;if(null===(r=Au.info)||void 0===r||r.call(Au,Yo,`${e.convId} Delete batch messages start`),null!==(o=a.duplicatedMsgIds)&&void 0!==o&&o.length)null===(l=Au.info)||void 0===l||l.call(Au,Yo,`${e.convId} Delete duplicated messages for first message in batch`,a.duplicatedMsgIds),await n.deleteMulti(a.duplicatedMsgIds,{partition:e.convId});const u=await this.deleteBatchMessages(i,n);var c,d;if(u.isContinue)return null===(c=Au.info)||void 0===c||c.call(Au,Yo,`${e.convId} Delete batch messages success`,i),i.msgId=u.nextRoundMsgId,i.cliMsgId=u.nextRoundCliMsgId,i.fromUid=u.nextRoundFromUid,i.rangeMessage=u.oldRoundRangeMessage,this.runDeleteMessages(i,t,s);null===(d=Au.info)||void 0===d||d.call(Au,Yo,`${e.convId} Delete batch messages success`),t()}catch(u){const e=u;s(e.code?e:new bu({code:"DB_ERROR",message:`${i.convId} Delete batch messages failed`}))}}))))}catch(a){s(a)}}deleteBatchMessages(e,t){return new Promise((async(s,a)=>{try{var i;if(!e.convId)return a(new bu({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete batch messages data is invalid`}));const r={isContinue:!1,nextRoundMsgId:void 0};if(!e.msgId)return s(r);const o=this.getBatchMessagesLimit();if(o<1)return s(r);const l={from:[e.convId+"","",""],to:[e.convId+"",e.deleteTime+"",e.msgId+""],excludeFrom:!1,excludeTo:!1},c={index:"userId_sendDttm_msgId",limit:o+1,direction:O.c.PREV,partition:e.convId,useLGKeyRange:!0},d=await t.getAll(l,c),u=d.map((e=>e.msgId));if(0===d.length)return s(r);if(d.length>o){r.isContinue=!0;const e=d.pop();u.pop(),r.nextRoundMsgId=null==e?void 0:e.msgId,r.nextRoundCliMsgId=null==e?void 0:e.cliMsgId,r.nextRoundFromUid=null==e?void 0:e.fromUid}null===(i=Au.info)||void 0===i||i.call(Au,Yo,`${e.convId} Delete batch messages list`,d);const h={fromId:d[0].msgId,toId:d[d.length-1].msgId};if(e.rangeMessage){if(e.rangeMessage.fromId===d[0].msgId&&e.rangeMessage.toId===d[d.length-1].msgId)return a(new bu({code:"LOOP_ERROR",message:`${e.convId} Loop delete batch messages`}));r.oldRoundRangeMessage=h}else r.oldRoundRangeMessage=h;this.fireEventsBeforeDeleteBatchMessages(e,d),await t.deleteMulti(u,{partition:e.convId}),this.fireEventsAfterDeleteBatchMessages(e,d),void 0===e.countDeleted&&(e.countDeleted=0),e.countDeleted++;const g=this.getBatchThrottleTime();var n;if(r.isContinue&&g>0)null===(n=Au.info)||void 0===n||n.call(Au,Yo,`${e.convId} Delete batch messages sleep`,g),await Object(Uc.i)(g);s(r)}catch(o){var r;null===(r=Au.error)||void 0===r||r.call(Au,Yo,`${e.convId} Delete batch messages failed`,o),a(o)}}))}syncDeleteMessage(e,t){const{convId:s}=e;return s?new Promise((async(a,i)=>{try{var n,r;null===(n=Au.info)||void 0===n||n.call(Au,Yo,`${t.msgId} Sync delete message start`),Au.zlog.zsymb(0,"1nzekM",`${Yo} ${t.msgId} Sync delete message start`),fu.b.start(fu.a.ART_delete_message_sync_v2),await Cl.default.syncDeleteMessage(s,Tu(s),[Lu(t)],xl.a.next(),"only-me"===e.type?1:0,void 0,Object(Ld.f)(t)===Y.MSG_E2EE),null===(r=Au.info)||void 0===r||r.call(Au,Yo,`${t.msgId} Sync delete message success`),Au.zlog.zsymb(0,"ur5--v",`${Yo} ${t.msgId} Sync delete message success`),fu.b.end(fu.a.ART_delete_message_sync_v2),a()}catch(o){const e=new bu({code:"SYNC_MESSAGE_ERROR",message:`${t.msgId} Sync delete message failed`});fu.b.end(fu.a.ART_delete_message_sync_v2,{isFailed:!0,errorCode:e.code||-1}),i(e)}})):Promise.resolve()}deleteMessageWithMessageInfo(e,t=!0){return new Promise((async(s,a)=>{try{const i=await wu({convId:e.convId,msgId:e.msgId,cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid}),n=null==i?void 0:i.msg,r=(null==i?void 0:i.msgIds)||[],o=(null==i?void 0:i.duplicatedMsgIds)||[];if(!n)throw new bu({code:"NOT_FOUND_MESSAGE",message:`${e.msgId} Message not found`});vu.a.key("sync_delete_message").boolean&&!(null!=e&&e.isDisableSync)&&this.syncDeleteMessage(e,n),this.fireEventsBeforeDeleteMessage(e,[n]);const l=this.createDeleteMessageTask(),c=e=>{t?a(e):s(void 0)};l.execute((async()=>{var t;o.length&&(null===(t=Au.info)||void 0===t||t.call(Au,Yo,`${e.msgId} Delete duplicated messages`,o),await this.database.Core.Message.deleteMulti(o,{partition:e.convId}));let a=Object(I.a)({},n);switch(e.uidSenderDel&&(a.uidSenderDel=e.uidSenderDel),e.type){case"only-me":await this.database.Core.Message.delete(n.msgId,{partition:e.convId});break;case"recall":a=$r.default.convertToRecalled(a),a.msgType=Y.MSG_UNDO,a.originMsgType="chat.undo",Object(Ld.f)(a)!==Y.MSG_E2EE_PENDING&&Object(Ld.f)(a)!==Y.MSG_E2EE_FAILED||(a.e2eeStatus=Y.MSG_E2EE_UNDO),await this.database.Core.Message.insert(a,{replace:!0});break;case"everyone":a=$r.default.convertToDelEveryone(a),a.msgType=Y.MSG_DEL_EVERYONE,await this.database.Core.Message.insert(a,{replace:!0})}await this.deleteMessageInfo(e,a,r),this.fireEventsAfterDeleteMessage(e,[n]),s(a);const i=this.getMessageThrottleTime();var c;i>0&&(null===(c=Au.info)||void 0===c||c.call(Au,Yo,`${e.msgId} Delete message sleep`,i),await Object(Uc.i)(i));l.close()}),e),l.onError((e=>c(e)))}catch(i){t&&a(i)}}))}deleteMessageInfo(e,t,s){return new Promise((async(a,i)=>{try{switch(e.type){case"only-me":await this.previewDataManager.onDeleteMessage("server",t),e.convId&&await this.convInfoDataManager.onDeleteMessages(e.convId,s.map((e=>({msgId:e}))));break;case"recall":await this.previewDataManager.onUndoMessage("server",t);break;case"everyone":await this.previewDataManager.onDeleteMessage("server",t)}a()}catch(n){i(new bu({code:"MESSAGE_INFO_ERROR",message:`${t.msgId} Delete message info failed`}))}}))}createSyncDeleteConversationData(e,t){return new Promise((async(s,a)=>{try{const a=e=>"0"==e?Ii.default.getUidMe():e;if(Mu(t.fromUid)&&Mu(t.cliMsgId)&&t.msgId)return s({ownerId:a(t.fromUid+""),cliMsgId:t.cliMsgId+"",globalMsgId:mu.a.normalize(t.msgId)});const i=await Du(e);if(i&&i.fromUid&&i.cliMsgId&&i.msgId)return s({ownerId:a(i.fromUid+""),cliMsgId:i.cliMsgId+"",globalMsgId:mu.a.normalize(i.msgId)});s(void 0)}catch(i){a(i)}}))}createDeleteConversationTask(){return this.taskManager.createTask("runDeleteMessages",{priority:"normal",backup:{key:"runDeleteMessages"},retry:vu.a.key("retry_time").number,waitForRetry:vu.a.key("wait_for_retry").number})}createDeleteMessageTask(){return this.taskManager.createTask("deleteMessage",{priority:"high",backup:{key:"deleteMessage"},retry:vu.a.key("retry_time").number,waitForRetry:vu.a.key("wait_for_retry").number})}getDeleteInfoByThread(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);const s=await wu({convId:e.convId,msgId:e.msgId,cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid}),a=null==s?void 0:s.msg,i=null==s?void 0:s.duplicatedMsgIds;if(a)return t({maxMsgId:a.msgId,maxSendDttm:parseInt(a.sendDttm),maxCliMsgId:a.cliMsgId,duplicatedMsgIds:i});if(e.msgId&&e.deleteTime)return t({maxMsgId:e.msgId,maxSendDttm:e.deleteTime,maxCliMsgId:e.cliMsgId});t(void 0)}catch(a){s(a)}}))}getBatchMessagesLimit(){return Ee.l?vu.a.key("batch_messages_limit_for_web").number:vu.a.key("batch_messages_limit").number}getBatchThrottleTime(){return Ee.l?vu.a.key("batch_messages_throttle_for_web").number:vu.a.key("batch_messages_throttle").number}getMessageThrottleTime(){return Ee.l?vu.a.key("message_throttle_for_web").number:vu.a.key("message_throttle").number}fireEventsBeforeDeleteConversation(e){try{this.dispatchEvent(new _u.b(_u.c.BeforeDeleteConversation,{data:e}))}catch(t){}}fireEventsAfterDeleteConversation(e){try{this.dispatchEvent(new _u.b(_u.c.AfterDeleteConversation,{data:e}))}catch(t){}}fireEventsBeforeDeleteBatchMessages(e,t){try{this.dispatchEvent(new _u.b(_u.c.BeforeDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteBatchMessages(e,t){try{this.dispatchEvent(new _u.b(_u.c.AfterDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsBeforeDeleteMessage(e,t){try{this.dispatchEvent(new _u.b(_u.c.BeforeDeleteMessage,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteMessage(e,t){try{this.dispatchEvent(new _u.b(_u.c.AfterDeleteMessage,{data:e,messages:t}))}catch(s){}}})||Fu)||Fu)||Fu)||Fu)||Fu;var Nu;a.ModuleContainer.registerSingleton(En.ConversationOperation,ku);let Pu=Object(a.injectable)()(Nu=Reflect.metadata("design:type",Function)(Nu=Reflect.metadata("design:paramtypes",[])(Nu=class{constructor(){this.isInitial=!1,this.isReady=!1,this.storage=void 0,this.timeoutSaveCache=null,this.data={},this.setTemp={},this.removeTempArr=[],this.storage=n.default.getInstance()}async init(e){if(vu.a.key("enable").boolean&&vu.a.key("cache_conversation_deletion").boolean)try{if(this.isInitial)return void(null==e||e());this.isInitial=!0;const t=await this.storage.getItemForCurrentUserAsync(sl);t&&(this.data=JSON.parse(t)),this.data=Object(I.a)(Object(I.a)({},this.data),this.setTemp),this.setTemp={};for(const e of this.removeTempArr)delete this.data[e];this.removeTempArr=[],this.runTimeoutSaveCache(),this.isReady=!0,null==e||e()}catch(s){var t;this.isInitial=!1,null===(t=Au.error)||void 0===t||t.call(Au,Xo,"Init conversation deletion cache fail"),Au.zlog.zsymb(18,"3zHN5p",`${Xo} Init conversation deletion cache fail`)}}getDeletedConversations(){return vu.a.key("cache_conversation_deletion").boolean&&this.isReady?Object.values(this.data):[]}setDeletedConversation(e,t){vu.a.key("cache_conversation_deletion").boolean&&e&&t&&(this.isReady?(this.data[e]=t,this.runTimeoutSaveCache()):this.setTemp[e]=t)}removeDeletedConversation(e){vu.a.key("cache_conversation_deletion").boolean&&e&&(this.isReady?(delete this.data[e],this.runTimeoutSaveCache()):this.removeTempArr.push(e))}runTimeoutSaveCache(){this.timeoutSaveCache||(this.timeoutSaveCache=setTimeout((()=>{this.timeoutSaveCache=null;try{this.storage.setItemForCurrentUserAsync(sl,JSON.stringify(this.data))}catch(t){var e;null===(e=Au.error)||void 0===e||e.call(Au,Xo,"Save conversation deletion cache fail"),Au.zlog.zsymb(18,"YkfRQb",`${Xo} Save conversation deletion cache fail`)}}),0))}})||Nu)||Nu)||Nu;a.ModuleContainer.registerSingleton(En.ConversationDeletionCache,Pu);var ju,Uu=s("ezRR"),Bu=s("3AlX"),zu=s("RoG4"),Gu=s("yXlY"),xu=s("jDFw"),Vu=s("9Cxg"),Hu=s("2gQH"),Wu=s("JsDs"),qu=s("UQla"),Ku=s("vDlm"),$u=s("V0Mo");let Zu;Ee.l||(Zu=s("Dprd").default);let Qu=Object(Uu.c)()(ju=Object(a.injectable)()(ju=function(e,t){return Object(a.inject)(En.ConvInfoDataManager)(e,void 0,0)}(ju=function(e,t){return Object(a.inject)(En.PreviewDataManager)(e,void 0,1)}(ju=function(e,t){return Object(a.inject)(En.ConversationOperation)(e,void 0,2)}(ju=function(e,t){return Object(a.inject)(En.ConversationDeletionCache)(e,void 0,3)}(ju=Reflect.metadata("design:type",Function)(ju=Reflect.metadata("design:paramtypes",[void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager,void 0===En.PreviewDataManager?Object:En.PreviewDataManager,void 0===En.ConversationOperation?Object:En.ConversationOperation,void 0===En.ConversationDeletionCache?Object:En.ConversationDeletionCache])(ju=class extends Uu.b{constructor(e,t,s,a){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.conversationOperation=s,this.conversationDeletionCache=a,this.database=void 0,this.deleteMediaManager=void 0,this.database=Xt.default.getInstance(),this.deleteMediaManager=new Gu.a}start(){this.addEventListeners()}running(){const e=()=>{vu.a.key("enable").boolean&&this.conversationDeletionCache.init((()=>{this.conversationDeletionCache.getDeletedConversations().forEach((e=>{Kr.d.setDeleteConversation(e)}))}))};e();const t=()=>{e(),vu.a.remove(t)};vu.a.add(t)}getConversationResources(e){return new Promise((async(t,s)=>{try{var i;if(!vu.a.isStaging)return t(void 0);const s={},n=await this.convInfoDataManager.getConvById(e),r=await this.previewDataManager.getPreviewById(e);s.convInfo=n,s.previewInfo=r;const o=a.ModuleContainer.resolve(En.PinDataManager).isPinned(e);s.isPinned=o;const l={from:[e,"",""],to:[e,(null==r?void 0:r.messageTime)||"",(null==r?void 0:r.msgId)||""],excludeFrom:!1,excludeTo:!1},c={index:"userId_sendDttm_msgId",direction:O.c.PREV,partition:e,useLGKeyRange:!0},d=await this.database.Core.Message.getAll(l,c);s.msgNum=d.length,s.messageTypes={},s.media={};let u=0,h=0,g=0,m=0,p=0,f=0,v=0,_=0;for(let e=0;e<d.length;e++){d[e].staredDttm&&u++;const t=parseInt(d[e].msgId);if(!isNaN(t)){await this.database.Core.Mention.get(t)&&h++}d[e].msgType===Y.MSG_FILE&&g++,d[e].msgType!==Y.MSG_PHOTO&&d[e].msgType!==Y.MSG_PHOTO_2&&d[e].msgType!==Y.MSG_DOODLE||m++,d[e].msgType===Y.MSG_GIF&&p++,d[e].msgType===Y.MSG_VIDEO&&f++,d[e].msgType===Y.MSG_CONTACT&&"object"==typeof d[e].message&&"recommened.link"===d[e].message.action&&v++,d[e].msgType===Y.MSG_VOICE&&_++}s.starMsgNum=u,s.mentionMsgNum=h,s.messageTypes.fileMsgNum=g,s.messageTypes.imageMsgNum=m,s.messageTypes.gifMsgNum=p,s.messageTypes.videoMsgNum=f,s.messageTypes.linkMsgNum=v,s.messageTypes.audioMsgNum=_;const b=ll.a.getInstance(),I=await b.getMessageOfConversation([],e);if(s.searchMsgNum=I.len||0,Ce.default.change_media_db.should_use_new_media_db_flow){const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},a={index:"convId_sendDttm_cliMsgId",direction:O.c.PREV,partition:e},i=await this.database.Media.File.getAllKey(t,a),n=await this.database.Media.Image.getAllKey(t,a),r=await this.database.Media.Link.getAllKey(t,a);s.media.fileMsgNum=i.length,s.media.imageAndVideoMsgNum=n.length,s.media.linkMsgNum=r.length}else{const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},a={index:"userId_sendDttm_msgId",direction:O.c.PREV,partition:e},i=await this.database.Core.File.getAllKey(t,a),n=await this.database.Core.Image.getAllKey(t,a),r=await this.database.Core.Link.getAllKey(t,a);s.media.fileMsgNum=i.length,s.media.imageAndVideoMsgNum=n.length,s.media.linkMsgNum=r.length}null===(i=Au.info)||void 0===i||i.call(Au,Jo,`${e} Conversation resources`,s),t(s)}catch(r){var n;null===(n=Au.error)||void 0===n||n.call(Au,Jo,`${e} Error when getting conversation resources`,r),s(r)}}))}addEventListeners(){this.conversationOperation.addEventListener(_u.c.BeforeDeleteConversation,(e=>{var t,s,a,i;const n=null===(t=e.payload)||void 0===t?void 0:t.data;if(!n)return;const r=null===(s=e.payload)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.convId;r&&xu.a.clearCache(r);const o={msgId:n.msgId,conversationId:n.convId,isLeaveGroup:n.isLeaveGroup,deleteAllPrior:!0,sendDttm:n.deleteTime,clientMsgId:n.cliMsgId,fromUid:n.fromUid};Kr.d.setDeleteConversation(o),null===(i=zr.b.messageCache)||void 0===i||i.deleteMessageBefore(o)})),this.conversationOperation.addEventListener(_u.c.AfterDeleteConversation,(e=>{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.data;if(s&&(s.convId&&(a.ModuleContainer.resolve(En.PinDataManager).isPinned(s.convId)&&a.ModuleContainer.resolve(En.PinDataManager).unpin([s.convId]),Ee.l||a.ModuleContainer.resolve($i.b).removeConvToList(s.convId)),this.deleteConversationInMediaStore(s),s.isLeaveGroup)){mo.b.getInstance().removeCloudSegmentByConvId(s.convId)}})),this.conversationOperation.addEventListener(_u.c.BeforeDeleteBatchMessages,(e=>{})),this.conversationOperation.addEventListener(_u.c.AfterDeleteBatchMessages,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;a&&a.convId&&i&&this.cleanResourcesOfMessages(a.convId,i,a.isDeleteResource)})),this.conversationOperation.addEventListener(_u.c.BeforeDeleteMessage,(e=>{var t,s,a;const i=null===(t=e.payload)||void 0===t?void 0:t.data,n=null===(s=e.payload)||void 0===s?void 0:s.messages;if(!i||!i.convId||!n)return;const r=$u.b.getZQuoteBannerDataById(i.convId);var o;r&&null!==(a=r.quote)&&void 0!==a&&a.msgId&&r.quote.msgId===i.msgId&&(null===(o=r._clear)||void 0===o||o.call(r));const l={msgId:i.msgId,conversationId:i.convId,isLeaveGroup:i.isLeaveGroup,deleteAllPrior:!0,sendDttm:i.deleteTime,clientMsgId:i.cliMsgId,fromUid:i.fromUid,toUid:i.toUid};switch(xu.a.clearCache(i.convId),i.type){case"only-me":Kr.d.setDeleteMessage(l);break;case"everyone":Kr.d.setDeleteEveryoneCache(l);break;case"recall":Kr.d.setRecallMessage(l)}})),this.conversationOperation.addEventListener(_u.c.AfterDeleteMessage,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;a&&a.convId&&i&&(this.cleanResourcesOfMessages(a.convId,i,a.isDeleteResource),this.deleteMessageInMediaStore(a.convId,i[0]),this.cleanReplyMessages(a,i[0]),a.convId&&a.msgId)}))}cleanResourcesOfMessages(e,t,s){var a;if(!t.length)return;const i=`${e} Clean resources of messages ${t.length}`;null===(a=Au.info)||void 0===a||a.call(Au,Jo,i),Au.zlog.zsymb(0,"s5NA-L",i);const n={ids:[],pendingIds:[]},r=[],o=[];t.forEach((e=>{var t;s&&this.deleteMediaManager.deleteLocalRes(e),!Ee.l&&tt.default.abortByMsg(Object(I.a)({},e)),null===(t=we.default.cbMessageToMsgThread)||void 0===t||t.call(we.default,"delete",e);let a=e.msgType;if(a=Object(Ku.a)(a,e),qu.c.includes(a)){const t=Object(Ku.b)(e);r.push(t)}if(e&&e.status===Y.MSG_LOCAL&&e.cliMsgId){const t={code:Bu.a.DeleteConversationHasSendingMsg,message:"Delete conversation has sending message"};Bu.b.cancel(+e.cliMsgId,t)||e.msgType!==Y.MSG_FILE||(J.p.setHasCancelledSending(e.cliMsgId),$l.b.cancelUpload(e.cliMsgId))}if(e.msgType===Y.MSG_FILE&&e.message&&e.message.href){var i,l;const t=null===(i=Zu)||void 0===i?void 0:i.getDownloadKey(e);null===(l=Zu)||void 0===l||l.cancelDownload(t)}if(e.staredDttm){const t=we.default.getTsStarMsgSchemaChanged();e.staredDttm&&e.staredDttm>=t?n.ids.push(e.msgId):n.pendingIds.push(e.msgId)}e&&e.msgType==Y.MSG_ZINSTANT&&zu.b.removeFileFromMessage(e,we.default.getUserId()),o.push(e.msgId)}));ll.a.getInstance().deleteMessages(t),r.length>0&&this.database.Res.Meta.deleteMulti(r),Hu.a.increaseNumberOfMessages(-t.length);const l=this.database.Core.Mention;o.length>0&&l.deleteMulti(o),Dd.b.deleteReactions(t.map((e=>e.msgId)));const c=this.database.Core.StarMessage;n.pendingIds.forEach((async(e,t)=>{try{await c.get(e)||(n.pendingIds[t]=parseInt(e))}catch(s){}})),c.deleteMulti([...n.ids,...n.pendingIds],{partition:e})}deleteConversationInMediaStore(e){var t;if(!e.convId){var s;const e=new bu({code:"RESOURCE_ERROR",message:"Delete conversation media store failed: conversationId is not provided"});return void(null===(s=Au.error)||void 0===s||s.call(Au,Jo,e))}const i=this.canDeleteMediaStore(e.convId),n=`${e.convId} Delete conversation media store ${Ce.default.change_media_db.should_use_new_media_db_flow} ${i}`;if(null===(t=Au.info)||void 0===t||t.call(Au,Jo,n),Au.zlog.zsymb(0,"XsdhIi",n),i)if(Ce.default.change_media_db.should_use_new_media_db_flow){a.ModuleContainer.resolve(Re.a).emptyMediaStores(e.convId,["image","file","link"])}else Wu.a.runCleanUpMedia({conversationId:e.convId,msgId:e.msgId,sendDttm:e.deleteTime,clientMsgId:e.cliMsgId,ignoreDeleteRes:!0},"del-conv")}deleteMessageInMediaStore(e,t){var s;const i=this.canDeleteMediaStore(e),n=`${t.msgId} Delete message media store ${Ce.default.change_media_db.should_use_new_media_db_flow} ${i}`;if(null===(s=Au.info)||void 0===s||s.call(Au,Jo,n),Au.zlog.zsymb(0,"72TzM3",n),i)if(Ce.default.change_media_db.should_use_new_media_db_flow){var r;if(!t.toUid)return;let e="unknown";Object(Vu.isPhotoOrVideoMessage)(t)?e="image":Object(Vu.isFileMessage)(t)?e="file":Object(Vu.isLinkMessage)(t)&&(e="link"),null===(r=a.ModuleContainer.resolve(Re.a))||void 0===r||r.deleteMediasById(e,t.toUid,{newId:t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:void 0,oldId:t.msgId})}else{const e=[this.database.Core.File,this.database.Core.Image,this.database.Core.Link,this.database.Core.Notifications];for(let s=0;s<e.length;s++)e[s].delete(t.msgId)}}async cleanReplyMessages(e,t){try{const s=we.default.getUserId(),a={index:"userId_sendDttm_msgId",limit:500,direction:O.c.NEXT,predicate:e=>function(e,t,s){if(!(e&&t&&t.quote&&s))return!1;if(t.quote.cliMsgType===Y.MSG_DEL_EVERYONE)return!1;if(t.quote.cliMsgType===Y.MSG_UNDO)return!1;const a="0"==s.fromUid?e:s.fromUid;return!(!t.quote.globalMsgId||!t.quote.cliMsgId||t.quote.globalMsgId.toString()!=s.msgId||t.quote.cliMsgId!=s.cliMsgId||a!=t.quote.ownerId)}(s,e,t),partition:e.convId,useLGKeyRange:!0},i={from:[e.convId+"",t.sendDttm+"",t.msgId+""],to:[e.convId+"",tl,el],excludeFrom:!1,excludeTo:!1},n=await this.database.Core.Message.getAll(i,a);if(!n.length)return;const r=[];for(let t=0;t<n.length;t++){const s=n[t];s.quote&&("everyone"===e.type?(s.quote.cliMsgType=Y.MSG_DEL_EVERYONE,s.quote.msg="[Tin nhn  b xa]"):"recall"===e.type&&(s.quote.cliMsgType=Y.MSG_UNDO,s.quote.msg="[Tin nhn  c thu hi]"),r.push(s))}r.length&&await this.database.Core.Message.insertMulti(r,{replace:!0})}catch(s){}}canDeleteMediaStore(e){return!Tu(e)||!Ce.default.media_settings.media_cloud}})||ju)||ju)||ju)||ju)||ju)||ju)||ju)||ju;a.ModuleContainer.registerSingleton(En.ConversationResources,Qu),a.ModuleContainer.registerSingleton(rc.b,dc),a.ModuleContainer.registerSingleton(Pc.b,qc),a.ModuleContainer.registerSingleton(rc.a,lc),a.ModuleContainer.registerSingleton(oc.a,class{constructor(){this.name=void 0,this.key=void 0,this.dependencies={},this.name="conv-notification-controller",this.key=this.name,this.dependencies=new Proxy({},{get:async(e,t)=>e[t]?await e[t]():Promise.resolve(void 0),set:(e,t,s)=>(e[t]=s,!0)}),this._registerResolvers({friendsManager:()=>Promise.resolve().then(s.bind(null,"UiPd")).then((e=>e.default)),convListUtils:()=>Promise.resolve().then(s.bind(null,"RojW")).then((e=>e.ConvList)),convListController:()=>Promise.resolve(a.ModuleContainer.resolve(ii.b))})}async checkIfConvCanNotify(e,t){try{return await this._checkIfConvCanNotify(e,t)}catch(s){return!1}}registerResolvers(e){return this._registerResolvers(e)}async _checkIfConvCanNotify(e,t){if(Object($c.a)(e))return!0;let s=await this._getModule("friendsManager",t);if(await s.isOA(e)){let s=await this._getModule("convListUtils",t);if(!(await s.checkIfOAShouldShowInConvList(e))){return!!(await this._getModule("convListController",t)).isChatVisible(e)}return!0}return!0}async _getModule(e,t){return t&&t[e]?await t[e]():await this.dependencies[e]}_registerResolvers(e){for(const[t,s]of Object.entries(e))this.dependencies[t]=s}}),a.ModuleContainer.registerSingleton(Qc.a,Zc);var Yu=s("/S2x"),Ju=s("vBob"),Xu=s("qlGb");var eh=s("7gmC");class th{constructor(e,t,s,a){this.actionSrc=void 0,this.msgType=void 0,this.convType=void 0,this.dlt=void 0,this.actionSrc=e,this.msgType=t,this.convType=s,this.dlt=a}toString(){const e=[this.actionSrc,this.msgType,this.convType,this.dlt].filter((e=>void 0!==e));return e.length<=0?"":1==e.length?e.join(""):e.length>=2?e.join("."):""}}class sh{constructor(){this.name=void 0,this.code=void 0}}class ah extends sh{constructor(){super(),this.name="SYNC_DOWNLOAD_DATA_INVALID",this.code=1}}class ih extends sh{constructor(){super(),this.name="MESSAGE_INVALID",this.code=2}}class nh extends sh{constructor(){super(),this.name="TOPIC_INVALID",this.code=3}}class rh extends sh{constructor(){super(),this.name="DLT_DATA_INVALID",this.code=4}}class oh extends sh{constructor(){super(),this.name="ACTION_HASH_DUPLICATE",this.code=6}}class lh extends sh{constructor(){super(),this.name="MESSAGE_KEY_INVALID",this.code=7}}class ch extends sh{constructor(){super(),this.name="DOWNLOAD_ERROR",this.code=8}}class dh{constructor(e){this.topic=e}}class uh{constructor(e){this.topic=e}}var hh,gh=s("ePll"),mh=s("nkyP");const ph=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["producer produce"]);let fh=Object(a.injectable)()(hh=function(e,t){return Object(a.inject)(mh.i)(e,void 0,0)}(hh=function(e,t){return Object(a.inject)(mh.p)(e,void 0,1)}(hh=function(e,t){return Object(a.inject)(mh.j)(e,void 0,2)}(hh=function(e,t){return Object(a.inject)(mh.k)(e,void 0,3)}(hh=function(e,t){return Object(a.inject)(mh.m)(e,void 0,4)}(hh=function(e,t){return Object(a.inject)(mh.g)(e,void 0,5)}(hh=function(e,t){return Object(a.inject)(mh.n)(e,void 0,6)}(hh=function(e,t){return Object(a.inject)(mh.r)(e,void 0,7)}(hh=function(e,t){return Object(a.inject)(mh.c)(e,void 0,8)}(hh=function(e,t){return Object(a.inject)(mh.a)(e,void 0,9)}(hh=function(e,t){return Object(a.inject)(mh.s)(e,void 0,10)}(hh=Reflect.metadata("design:type",Function)(hh=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,void 0===eh.IMediator?Object:eh.IMediator,Object,Object,Object,Object,Object])(hh=class{constructor(e,t,s,a,i,n,r,o,l,c,d){this.duplicateBucket=e,this.syncQueueRepository=t,this.messageRepository=s,this.messageValidator=a,this.syncActionsRepository=i,this.syncActionMediator=n,this.syncDownloadDataValidator=r,this.topicMapper=o,this.compositeKeyMapper=l,this.actionHashMapper=c,this.topicValidator=d}async produceByAction(e){try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(e))throw new ah;const t=this.actionHashMapper.map(e);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(t))throw new oh;this.duplicateBucket.add(t.toString());const s=await this.messageRepository.getMessageByCliMsgId(e.clientMsgId,e.convId);if(!this.messageValidator.validateMessage(s))throw new ih;const a=this.compositeKeyMapper.mapByAction(e),i=this.compositeKeyMapper.mapByMessage(s);if(!this.messageValidator.validateMessageByCompositeKey(i,a))throw new lh;const n=this.topicMapper.map(e,s);if(!this.topicValidator.validateTopic(n))throw new nh;this.syncQueueRepository.addByTopic(n.toString(),{action:e,message:s,lastClientMsgId:e.clientMsgId}),requestAnimationFrame((async()=>{await this.syncActionMediator.publish(new uh(n))}))}catch(t){t instanceof oh||requestAnimationFrame((async()=>{var t;this.duplicateBucket.delete(null===(t=this.actionHashMapper.map(e))||void 0===t?void 0:t.toString())}))}}async produceByParams(e,t,s){let a=await this.syncActionsRepository.getActionsByActionSrc(e,t,s);if((a.data.length<=0||a.data.length>0&&!1===a.hasMore)&&await this.syncActionMediator.publish(new dh(new th(e))),!(a.data.length<=0||null==a)&&a.data)for(let[n,r]of a.data.entries())try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(r))throw new ah;const e=this.actionHashMapper.map(r);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(e))throw new oh;this.duplicateBucket.add(e.toString());const t=await this.messageRepository.getMessageByCliMsgId(r.clientMsgId,r.convId);let{code:s,msgType:i}=gh.a.validateMessage(t);if(s&&i==(null==t?void 0:t.msgType))continue;if(!this.messageValidator.validateMessage(t))throw new ih;const o=this.topicMapper.map(r,t);if(!this.topicValidator.validateTopic(o))throw new nh;this.syncQueueRepository.addByTopic(o.toString(),{action:r,message:t,lastClientMsgId:a.lastClientMsgId,reproduce:0==n&&!1!==a.hasMore}),await this.syncActionMediator.publish(new uh(o))}catch(i){ph.zsymb(23,"1g8blz",["produce error {}","ytT_ZY"],i),i instanceof oh||requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(r))||void 0===e?void 0:e.toString())}))}}})||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh)||hh;var vh;let _h=Object(a.injectable)()(vh=function(e,t){return Object(a.inject)(mh.i)(e,void 0,0)}(vh=Reflect.metadata("design:type",Function)(vh=Reflect.metadata("design:paramtypes",[Object])(vh=class{constructor(e){this.duplicateBucket=e}validateSyncDownloadData(e){return!!e&&(!(!e.clientMsgId||Number.isNaN(e.clientMsgId))&&(!(!e.actionSource||Number.isNaN(e.actionSource))&&!(!e.convId||!e.fromId)))}validateDuplicateSyncDownloadData(e){return!!this.duplicateBucket.has(e.toString())}})||vh)||vh)||vh)||vh;var bh,Ih=s("Y58e");let yh=Object(a.injectable)()(bh=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(bh=Reflect.metadata("design:type",Function)(bh=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(bh=class{constructor(e){this.config=void 0,this.config=e}validateTopic(e){if(!e.actionSrc)return!1;return!!this.config.get("syncDownload.topics").includes(e.toString())}})||bh)||bh)||bh)||bh;const Sh=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue add"]);class Ch{constructor(){this.maps=new Map}unshiftByTopic(e,t){var s;Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.unshift(t):this.maps.set(e,[t])}addByTopic(e,t){var s;Sh.zsymb(23,"CLMacP",["queue add topic {}, {}","iCU4Ev"],e,t),Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.push(t):this.maps.set(e,[t])}popByTopic(e){var t;return null===(t=this.maps.get(e))||void 0===t?void 0:t.pop()}lengthByTopic(e){var t;return(null===(t=this.maps.get(e))||void 0===t?void 0:t.length)||0}infosByTopic(e){return[...this.maps.get(e)]}}var Eh=s("jkDV");class Oh{constructor(e){this.topic=e}}class Mh{constructor(e,t,s){this.topic=e,this.syncData=t,this.reproduce=s}}const Th=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("downloadSyncActions",["downloadSyncActions"]);class wh{constructor(e,t){this.topic=e,this.DltSyncData=t}}const Rh=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue consume"]);class Lh{constructor(e,t,s,a,i,n,r,o){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=a,this.syncQueueRepository=i,this.mediator=n,this.syncActionMediator=r,this.topic=o}async consume(){Th.zsymb(23,"KjdzYo",["DownloadSyncActionConsumerService consume entry","RJJ8F_"]);const e=this.syncQueueRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message,a=null==e?void 0:e.reproduce;try{const e=this.DTOMapper.map(t,s);this.cachedDTORepository.setDTO(`${t.clientMsgId}.${this.topic.toString()}`,e),Rh.zsymb(23,"a-LriE",["actionSrc {}, cliMsgId {}, globalMsgId {}, start download","WAxom5"],t.actionSource,t.clientMsgId,t.globalMsgId);const a=await e.run();if(null!=a&&a.downloadError||null==a||!a.savePath)throw Rh.zsymb(23,"cWaeLU",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","ghiJQr"],t.actionSource,t.clientMsgId,t.globalMsgId,null==a?void 0:a.downloadError,null==a?void 0:a.savePath),new ch;Rh.zsymb(23,"ORwhpL",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done download","LFpC7-"],t.actionSource,t.clientMsgId,t.globalMsgId,a.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new Eh.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(a.isCached)}))}catch(i){t&&s&&(Rh.zsymb(23,"L5ysO3",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, fail download go to retry","mMqkUw"],t.actionSource,t.clientMsgId,t.globalMsgId),await this.syncActionMediator.publish(new wh(new th(this.topic.actionSrc,this.topic.msgType,this.topic.convType,"dlt"),{action:t,message:s,retry:0})))}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new Oh(this.topic)),await this.mediator.publish(new Mh(this.topic,t,a))}))}}class Dh{constructor(e){this.topic=e}}const Ah=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue retry consume"]);class Fh{constructor(e,t,s,a,i,n,r,o,l){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=a,this.syncQueueDLTRepository=i,this.mediator=n,this.syncActionMediator=r,this.DltValidator=o,this.topic=l}async consume(){Th.zsymb(23,"aMS0NI",["DownloadSyncActionDltConsumer consume entry","LnQxNi"]);const e=this.syncQueueDLTRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message;try{if(!this.DltValidator.validateDlt(e))throw new rh;const a=this.DTOMapper.map(t,s);this.cachedDTORepository.setDTO(`${e.action.clientMsgId}_${this.topic.toString()}`,a),Ah.zsymb(23,"J1cVfY",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, start retry download","zbVWTl"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry);const i=await a.run();if(null!=i&&i.downloadError||null==i||!i.savePath)throw Ah.zsymb(23,"ci8udd",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","ghiJQr"],t.actionSource,t.clientMsgId,t.globalMsgId,null==i?void 0:i.downloadError,null==i?void 0:i.savePath),new ch;Ah.zsymb(23,"pRoi67",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done retry download","xwvQhE"],t.actionSource,t.clientMsgId,t.globalMsgId,i.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new Eh.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(i.isCached)}))}catch(i){if(t&&s)if(i instanceof rh);else if(this.DltValidator.isRetriesExceeded(e)){var a;await this.mediator.publish(new Eh.b(t.actionSource,t.fromId,t.convId,t.clientMsgId,null==i||null===(a=i.downloadError)||void 0===a?void 0:a.name))}else await this.mediator.publish(new wh(this.topic,{action:t,message:s,retry:e.retry+1})),Ah.zsymb(23,"IdfPzb",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, fail download increase retry","I-EMhJ"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry)}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new Oh(this.topic)),await this.mediator.publish(new Dh(this.topic))}))}}var kh;let Nh=Object(a.injectable)()(kh=function(e,t){return Object(a.inject)(mh.i)(e,void 0,0)}(kh=function(e,t){return Object(a.inject)(mh.b)(e,void 0,1)}(kh=function(e,t){return Object(a.inject)(mh.a)(e,void 0,2)}(kh=function(e,t){return Object(a.inject)(mh.e)(e,void 0,3)}(kh=function(e,t){return Object(a.inject)(mh.p)(e,void 0,4)}(kh=function(e,t){return Object(a.inject)(mh.o)(e,void 0,5)}(kh=function(e,t){return Object(a.inject)(mh.g)(e,void 0,6)}(kh=function(e,t){return Object(a.inject)(mh.l)(e,void 0,7)}(kh=function(e,t){return Object(a.inject)(mh.f)(e,void 0,8)}(kh=Reflect.metadata("design:type",Function)(kh=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,void 0===eh.IMediator?Object:eh.IMediator,void 0===eh.IMediator?Object:eh.IMediator,Object])(kh=class{constructor(e,t,s,a,i,n,r,o,l){this.duplicateBucket=e,this.cachedDTORepository=t,this.actionHashMapper=s,this.DTOMapper=a,this.syncQueueRepository=i,this.syncQueueDltRepository=n,this.mediator=r,this.syncActionMediator=o,this.dltValidator=l,this.services=new Map,this.dltTopics=new Map}createByTopic(e){let t=this.services.get(e),s=this.services.get(this.dltTopics.get(e)||"");if(t&&s)return[t,s];let a=e.split(".");return t=new Lh(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueRepository,this.mediator,this.syncActionMediator,new th(Number(a[0]),a[1],a[2])),s=new Fh(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueDltRepository,this.mediator,this.syncActionMediator,this.dltValidator,new th(Number(a[0]),a[1],a[2],"dlt")),this.services.set(t.topic.toString(),t),this.services.set(s.topic.toString(),s),[t,s]}deleteByTopic(e){this.services.delete(e)}getByTopic(e){return this.services.get(e)}getAll(){return Array.from(this.services.values())}})||kh)||kh)||kh)||kh)||kh)||kh)||kh)||kh)||kh)||kh)||kh)||kh;const Ph={[Y.MSG_PHOTO]:"photo",[Y.MSG_PHOTO_2]:"photo",[Y.MSG_GIF]:"photo",[Y.MSG_FILE]:"file",[Y.MSG_VOICE]:"voice",[Y.MSG_VIDEO]:"video",[Y.MSG_CONTACT]:"link"};var jh;let Uh=Object(a.injectable)()(jh=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(jh=Reflect.metadata("design:type",Function)(jh=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(jh=class{constructor(e){this.config=void 0,this.config=e}map(e,t){let s=Ph[t.msgType]||"";const a=this.config.get("syncDownload.topics");return a.includes(`${e.actionSource}`)?new th(e.actionSource):a.includes(`${e.actionSource}.${s}`)?new th(e.actionSource,s):void 0}})||jh)||jh)||jh)||jh;var Bh;let zh=Object(a.injectable)()(Bh=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(Bh=Reflect.metadata("design:type",Function)(Bh=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(Bh=class{constructor(e){this.config=void 0,this.config=e}validateDlt(e){return!!e}isRetriesExceeded(e){const t=this.config.get("syncDownload.dlt_max_retry");return!!(Number.isNaN(e.retry)||e.retry>=t)}})||Bh)||Bh)||Bh)||Bh;class Gh{constructor(e,t){this.actionSrc=void 0,this.clientMsgId=void 0,this.actionSrc=e,this.clientMsgId=t}toString(){return`${this.actionSrc}.${this.clientMsgId}`}}class xh{constructor(e,t,s){this.cliMsgId=e,this.fromUid=t,this.toUid=s}toString(){return`${this.cliMsgId}.${this.fromUid}.${this.toUid}`}}a.ModuleContainer.register(mh.j,class{constructor(){this.DB=void 0,this.DB=Xt.default.getInstance()}async getMessageByCliMsgId(e,t){return await this.DB.Core.Message.get(`${e}`,{index:"cliMsgIdIndex",partition:t})}}),a.ModuleContainer.register(mh.m,class{constructor(){}async getActions(){return[]}getActionsByActionSrc(e){return Object(ge.f)("SyncActionsRepository",e)}}),a.ModuleContainer.registerSingleton(mh.o,Ch),a.ModuleContainer.registerSingleton(mh.p,Ch),a.ModuleContainer.registerSingleton(mh.b,class{constructor(){this.cache=new Map}getDTO(e){return this.cache.get(e)}setDTO(e,t){this.cache.set(e,t)}deleteDTO(e){this.cache.delete(e)}}),a.ModuleContainer.registerSingleton(mh.i,class{constructor(){this.bucket=new Set}add(e){e&&this.bucket.add(e)}has(e){return this.bucket.has(e)}delete(e){this.bucket.delete(e)}}),a.ModuleContainer.register(mh.n,_h),a.ModuleContainer.register(mh.k,class{validateMessageByCompositeKey(e,t){return e.toString()==t.toString()}validateMessage(e){return!!e&&(!(!e.msgType||e.msgType==Y.MSG_UNDO)&&(!(!e.status||e.status>Y.MSG_AFTER_READ)&&!!(e.msgId&&e.cliMsgId&&e.fromUid&&e.toUid)))}}),a.ModuleContainer.register(mh.s,yh),a.ModuleContainer.register(mh.f,zh),a.ModuleContainer.register(mh.e,class{map(e,t){var s,a;const i=Object(Xu.getDataFromMessage)(t),n=Object(Xu.getTypeByMsg)(t),r=Object(Xu.getUserId)();let o;ge.a.FromServer==e.actionSource&&(o=Ju.a.srcAction.SyncAuto),ge.a.MsgFlow!=e.actionSource&&ge.a.FromTransfer!=e.actionSource||(o=Ju.a.srcAction.Auto);const l={type:n,data:Object(I.a)(Object(I.a)({},i),{},{userId:r,localPath:void 0}),options:{srcAction:o,showProgress:{progressBar:!1,taskBar:!1},caching:!0,duplicate:!1}};return t.msgType!=Y.MSG_PHOTO&&t.msgType!=Y.MSG_GIF||(l.options.saveDir=Object(Ni.getZaloDownloadsPictureDirSync)(i.conversationId,r)),t.msgType==Y.MSG_FILE&&(l.data.fileName=l.data.checksum),t.msgType==Y.MSG_VOICE&&(l.data.fileName=null===(s=l.data.fileName)||void 0===s?void 0:s.replace(".aac","")),t.msgType==Y.MSG_CONTACT&&"object"==typeof t.message&&"recommened.link"===(null==t||null===(a=t.message)||void 0===a?void 0:a.action)&&(l.options.saveDir=Object(Ni.getZaloDownloadsRichThumbDirSync)(r,i.conversationId)),new Yu.default(l)}}),a.ModuleContainer.register(mh.r,Uh),a.ModuleContainer.register(mh.a,class{map(e){if(e)return new Gh(e.actionSource,e.clientMsgId)}}),a.ModuleContainer.register(mh.c,class{mapByMessage(e){var t,s;let a=null!==(t=e.toUid)&&void 0!==t&&t.startsWith(Y.GROUPID_PREFIX)?null===(s=e.toUid)||void 0===s?void 0:s.slice(Y.GROUPID_PREFIX.length):null==e?void 0:e.toUid;return new xh(e.cliMsgId,e.fromUid,a)}mapByAction(e){var t,s;let a=null!==(t=e.convId)&&void 0!==t&&t.startsWith(Y.GROUPID_PREFIX)?null===(s=e.convId)||void 0===s?void 0:s.slice(Y.GROUPID_PREFIX.length):null==e?void 0:e.convId,i=Ii.default.getUidMe()==e.fromId?"0":e.fromId;return new xh(e.clientMsgId,i,a)}}),a.ModuleContainer.registerSingleton(mh.q,class{constructor(){this.maps=new Map}pauseByTopic(e){this.maps.get(e).enable=!1}resumeByTopic(e){this.maps.get(e).enable=!0}loadConfig(e,t){this.maps.set(e,Object(I.a)(Object(I.a)({enable:!0},this.maps.get(e)),{},{capacity:t,tokens:t}))}addByTopic(e){const t=this.maps.get(e);(null==t?void 0:t.tokens)<(null==t?void 0:t.capacity)&&(t.tokens+=1)}takeByTopic(e){const t=this.maps.get(e);return!!t.enable&&((null==t?void 0:t.tokens)>0&&(t.tokens-=1,!0))}}),a.ModuleContainer.registerSingleton(mh.h,fh),a.ModuleContainer.registerSingleton(mh.d,Nh),a.ModuleContainer.registerSingleton(mh.g,eh.Mediator);const Vh=a.ModuleContainer.resolve(Ih.a),Hh=a.ModuleContainer.resolve(mh.q),Wh=Vh.get("syncDownload.topics");for(let ZQ of Wh)Hh.loadConfig(ZQ,2),Hh.loadConfig(`${ZQ}.dlt`,2);const qh=a.ModuleContainer.resolve(Ih.a).get("syncDownload.topics"),Kh=a.ModuleContainer.resolve(mh.d);for(let ZQ of qh)Kh.createByTopic(ZQ);var $h;Object(eh.NotificationHandler)(Oh,1)($h=Reflect.metadata("design:type",Function)($h=Reflect.metadata("design:paramtypes",[])($h=class{constructor(){this.tokenBucket=void 0,this.tokenBucket=a.ModuleContainer.resolve(mh.q)}async handle(e){this.tokenBucket.addByTopic(e.topic.toString())}})||$h)||$h);var Zh;const Qh=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue"]);Object(eh.NotificationHandler)(dh,1)(Zh=Reflect.metadata("design:type",Function)(Zh=Reflect.metadata("design:paramtypes",[])(Zh=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(mh.d),this.tokenBucket=a.ModuleContainer.resolve(mh.q)}async handle(e){Th.zsymb(23,"O-f8XL",["AllActionsConsumedEvent entry","ihxKNq"]);const t=e.topic;Qh.zsymb(23,"f_Xqg3",["queue {}, done download","zAS0j7"],e.topic.toString());let s=this.consumerServiceFactory.getAll();s=s.filter((e=>e.topic.actionSrc==t.actionSrc)).filter((e=>e.topic.dlt));for(let a of s)a&&(this.tokenBucket.resumeByTopic(a.topic.toString()),this.tokenBucket.takeByTopic(a.topic.toString())&&a.consume())}})||Zh)||Zh);var Yh;Object(eh.NotificationHandler)(Mh,1)(Yh=Reflect.metadata("design:type",Function)(Yh=Reflect.metadata("design:paramtypes",[])(Yh=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncQueue=void 0,this.producer=void 0,this.syncActionMediator=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(mh.d),this.producer=a.ModuleContainer.resolve(mh.h),this.tokenBucket=a.ModuleContainer.resolve(mh.q),this.syncQueue=a.ModuleContainer.resolve(mh.p),this.syncActionMediator=a.ModuleContainer.resolve(mh.g)}async handle(e){Th.zsymb(23,"4rTCP7",["PullDownloadCommand entry","4wSVzZ"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());var s;if(this.syncQueue.lengthByTopic(e.topic.toString())<=0)e.reproduce?this.producer.produceByParams(e.topic.actionSrc,void 0,null===(s=e.syncData)||void 0===s?void 0:s.lastClientMsgId):await this.syncActionMediator.publish(new dh(new th(e.topic.actionSrc)));else for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||Yh)||Yh);var Jh;Object(eh.NotificationHandler)(uh,1)(Jh=Reflect.metadata("design:type",Function)(Jh=Reflect.metadata("design:paramtypes",[])(Jh=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(mh.d),this.tokenBucket=a.ModuleContainer.resolve(mh.q)}async handle(e){Th.zsymb(23,"eN7PDd",["PushDownloadCommand entry","u0vVOH"]);const t=`${e.topic}.dlt`;this.tokenBucket.pauseByTopic(t);const s=this.consumerServiceFactory.getByTopic(e.topic.toString());s&&this.tokenBucket.takeByTopic(e.topic.toString())&&s.consume()}})||Jh)||Jh);var Xh;Object(eh.NotificationHandler)(wh,1)(Xh=Reflect.metadata("design:type",Function)(Xh=Reflect.metadata("design:paramtypes",[])(Xh=class{constructor(){this.syncQueueDLTRepository=void 0,this.syncQueueDLTRepository=a.ModuleContainer.resolve(mh.o)}async handle(e){Th.zsymb(23,"9LI0q2",["DeadLetterUnshiftCommandHandler entry","EVB5wY"]),this.syncQueueDLTRepository.unshiftByTopic(e.topic.toString(),e.DltSyncData)}})||Xh)||Xh);var eg;const tg=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue retry"]);Object(eh.NotificationHandler)(Dh,1)(eg=Reflect.metadata("design:type",Function)(eg=Reflect.metadata("design:paramtypes",[])(eg=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncDltQueue=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(mh.d),this.tokenBucket=a.ModuleContainer.resolve(mh.q),this.syncDltQueue=a.ModuleContainer.resolve(mh.o)}async handle(e){Th.zsymb(23,"ju5hMg",["PullDownloadCommandDlt entry","IbcGaw"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());if(this.syncDltQueue.lengthByTopic(e.topic.toString())<=0)return tg.zsymb(23,"1sTDWp",["retry queue {}, done download","vYtEw7"],e.topic.toString()),void this.tokenBucket.pauseByTopic(e.topic.toString());for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||eg)||eg);var sg,ag=s("Xvw2"),ig=s("5uwv"),ng=s("lCn6"),rg=s("kg13"),og=s("dJFb");const lg=2,cg={userId:"",friendRequestType:lg,friendRequestSource:85};var dg=function(e){return e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req",e}(dg||{});Object(Ai.b)(ag.b)(sg=Reflect.metadata("design:type",Function)(sg=Reflect.metadata("design:paramtypes",[])(sg=class extends hs.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(we.default.changeFriendsToStranger(e),ui.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(Po.i)(this.name,dg.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(Po.i)(this.name,dg.REQUEST))}},this._ebFrReqFetch=e=>{ui.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let a of e)t[a.userId]||s.unshift(a);this.requestList=s,Object(Po.i)(this.name,dg.REQUEST)},this._ebFrReqRemove=e=>{ui.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(Po.i)(this.name,dg.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=ag.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case ve.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case ve.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case ve.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){rg.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&rg.a.removeSuggest(t.userId)}og.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&J.p.addNewFriendItem(e[s].userId);me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,og.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(I.a)(Object(I.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:lg}),recommItemType:e.friendRequestType})));rg.a.addRequest(t),this.broadcastEvent(ig.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return rg.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(ig.b.RemoveSuggest,e)}))}onPromoteFriends(){me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(Po.i)(this.name,dg.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let a of e.ids)-1===t.indexOf(a)&&s.push(a);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(Po.i)(this.name,dg.UNREADREQ))}acceptFriendRequest(e,t=hr.c){return new Promise(((s,a)=>{const i=this.data.get(e);if(!i)return ye.a.acceptAddFriend(e).then((a=>{Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(a);let n;if(i.friendRequestType===Y.FRIEND_REQUEST_TYPE_SUGGEST){if(i.requested)return n=104097,Ia.default.logAction(n),s(!1);const r=le.a.trans("STR_MSG_DEFAULT_REQ_ADD_FR",Ii.default.getMiniProfileMe().zaloName);ye.a.requestAddFriend(e,r,i.friendRequestSource).then((()=>{Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),we.default.changeFriendsToStranger(e),rg.a.removeSuggest(e);const a=Object(I.a)(Object(I.a)({},i),{},{requested:!0});this.broadcastEvent(ig.b.SentFriendReq,e),this.data.set(e,a),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),a(e)})),n=104096}else ye.a.acceptAddFriend(e).then((()=>{this.data.delete(e),Object(Po.f)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(ig.b.AcceptRequest,e),ng.a.getUser(e).then((t=>{_e.default.send(ve.FetchActions.FRIENDS_FETCHED,{[e]:Object(I.a)(Object(I.a)({},ui.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),we.default.getAcceptNewFriend(i),Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),a(e)})),n=104095;n&&Ia.default.logAction(n)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{Wo.default.createSuccess(le.a.str("STR_TOAST_REJECT_REQUEST")),we.default.changeFriendsToStranger(e),rg.a.removeSuggest(e),this.broadcastEvent(ig.b.RejectRequest,e)},a=e=>{ui.default.logCoreError(e),e&&e.error_message&&Wo.default.createError(e.error_message)};t&&t.friendRequestSource?Cl.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(a):ye.a.rejectRequestAddFriend(e).then(s).catch(a),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),Ia.default.logAction(104094)}undoRequestFriend(e){e&&ye.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&Wo.default.createError(e.error_message)}))}clearUnreadFriendRequest(){me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(Po.i)(this.name,dg.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=rg.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=rg.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){we.default.getFriends(null,!0).then((e=>{if(e){const t=we.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return cg}getList(e){return e.key===dg.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(ui.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=le.a.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+Ce.default.limitFriends])),Wo.default.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let a=e[s];a&&a.dataInfo.recommType===lg&&(t[s]=a,t[s].friendRequestType=a.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new ig.a(e,t,s)),this.dispatchEvent(new ig.a(ig.b.FriendCenterChange,t,Object(I.a)(Object(I.a)({},s),{},{act:e})))}})||sg)||sg);const ug=Object(a.define)("cloud-segment-repository"),hg=Object(a.define)("cloud-segment-manager"),gg=Object(a.define)("cloud-message-manager");class mg{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var pg;let fg=a.ModuleContainer.injectable()(pg=Reflect.metadata("design:type",Function)(pg=Reflect.metadata("design:paramtypes",[])(pg=class{constructor(){}get(e){return vo.a.getSegmentByConvId(e)}})||pg)||pg)||pg;var vg,_g=s("D8Ji");let bg=a.ModuleContainer.injectable()(vg=function(e,t){return a.ModuleContainer.inject(ug)(e,void 0,0)}(vg=Reflect.metadata("design:type",Function)(vg=Reflect.metadata("design:paramtypes",[void 0===ug?Object:ug])(vg=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new mg(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=_g.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),vo.a.setSegmentCacheByConvId(e,s),await fo.b.updateSegmentDB(e,s)}})||vg)||vg)||vg)||vg;class Ig extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var yg;let Sg=a.ModuleContainer.injectable()(yg=function(e,t){return a.ModuleContainer.inject(Ih.a)(e,void 0,0)}(yg=Reflect.metadata("design:type",Function)(yg=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(yg=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const a=`${s}_${e.requestMsgId}`;let i=this.settings.limit.minMsgDttm,n=this.settings.limit.maxMsgFirstSegment;const r={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:i,maxTotalSyncMsg:n};return await Jr.default.crawlMissingMessage(a,r,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(Xr.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new Ig(e.error_code,s,e.error_message)}throw e}))}})||yg)||yg)||yg)||yg;var Cg,Eg=s("yEZN"),Og=s("EO3V"),Mg=s("enz2");const Tg={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let wg=a.ModuleContainer.injectable()(Cg=function(e,t){return a.ModuleContainer.injectToken(Sg)(e,void 0,0)}(Cg=function(e,t){return a.ModuleContainer.inject(hg)(e,void 0,1)}(Cg=function(e,t){return a.ModuleContainer.inject(Eg.c)(e,void 0,2)}(Cg=function(e,t){return a.ModuleContainer.inject(Eg.b)(e,void 0,3)}(Cg=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)}(Cg=Reflect.metadata("design:type",Function)(Cg=Reflect.metadata("design:paramtypes",[void 0===Sg?Object:Sg,void 0===hg?Object:hg,void 0===Eg.c?Object:Eg.c,void 0===Eg.b?Object:Eg.b,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Cg=class{constructor(e,t,s,a,i){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=a,this.logger=void 0,this.logger=i.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const a=await this.segmentManager.get(e),i=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return a&&a.lastDeletedMsgID&&(t=t?Math.max(a.lastDeletedMsgID,t):a.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),n="0"!==t,r=n?s.count+1:s.count;if(n&&t<=i)return Tg;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:i,limit:r}).then((e=>e.map((e=>e.entity)))),l=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&l.add(t.toString())}catch(t){}}));const c=Array.from(l.values()),d=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:c,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===d.groupMsgs.length&&"0"===d.maxMsgId)return Tg;let u=Og.a.checkDupMessageFromCloud(e,d.groupMsgs);i&&i>"0"&&(u=u.filter((e=>e.msgId>i)));const h=[...o,...u];if(0===h.length)return Tg;const g=Number.parseInt(d.lastMsgId,10);let m=Number.parseInt(t);const p=Og.a.findMinMaxGroupMsg(h,m,g,null==a?void 0:a.lastDeletedMsgID),{groupMsgsToView:f,groupMsgsAddDb:v,groupMsgsSearch:_}=Mg.a.findMsgsAddDb(t,u,[],o,Object(I.a)({apiType:2,conversationId:e},p));v.forEach((e=>{e.src=Y.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(e,v),await Mg.a.updateSearchV3(_,e);const b=!!d.isFilteredByPhase,y=d.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let S="0";Number.isInteger(Number.parseInt(d.tsJoinGroup))?S=d.tsJoinGroup:this.logger.zsymb(18,"ghpMWp",(()=>["api res invalid ts join group",{tsJoinGroup:d.tsJoinGroup}]));const C=!!d.isFilteredByTimeJoin,E={totalMsgCount:f.length,fetchedMsgCount:v.length,serverMsgCount:u.length,newMsgCount:v.length,phaseDone:b,isFilteredByTimeJoin:C,done:!(b||!C&&d.hasMore),minMsgId:i,maxMsgId:y.toString(),tsJoinGroup:S};return this.logger.zsymb(3,"GG-NSX",["[auto-dl-msg] crawl result","M9XtZ7"],E),E}})||Cg)||Cg)||Cg)||Cg)||Cg)||Cg)||Cg)||Cg;a.ModuleContainer.registerSingleton(ug,fg),a.ModuleContainer.registerSingleton(hg,bg),a.ModuleContainer.registerSingleton(gg,wg);var Rg,Lg=s("rfrl"),Dg=s("KP/S"),Ag=s("wiGx"),Fg=s("ttnr");const kg={screen:Ag.a.Hidden,error:Dg.c.NO_ERROR,progress:0,totalProgress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(Ai.b)(Ag.b)(Rg=Reflect.metadata("design:type",Function)(Rg=Reflect.metadata("design:paramtypes",[])(Rg=class{constructor(){this.progressRecording=void 0,this.downloadBackupTime=void 0,this.state=Object(I.a)({},kg),this.name="sync-message-ui",this.key="window_id",this.progressRecording=new Map,this.initialRecordProgress(),this.downloadBackupTime=null}initialRecordProgress(){this.progressRecording.set(Ag.a.DownloadingBackup,0),this.progressRecording.set(Ag.a.DecryptingBackup,0),this.progressRecording.set(Ag.a.SyncInProgress,0)}recordProgress(e){const t=this.state.screen,s=e=>e>100?100:e;switch(t){case Ag.a.DownloadingBackup:this.progressRecording.set(t,s(e));break;case Ag.a.DecryptingBackup:this.progressRecording.set(Ag.a.DownloadingBackup,100),this.progressRecording.set(t,s(e));break;case Ag.a.SyncInProgress:this.progressRecording.set(Ag.a.DownloadingBackup,100),this.progressRecording.set(Ag.a.DecryptingBackup,100),this.progressRecording.set(t,s(e))}}calculateTotalProgressTransfer(){const e=this.state.screen,t=this.progressRecording.get(Ag.a.DownloadingBackup)||0,s=this.progressRecording.get(Ag.a.DecryptingBackup)||0,a=this.progressRecording.get(Ag.a.SyncInProgress)||0,i=(e,t)=>{let s=0;switch(t){case Ag.a.DownloadingBackup:s=Fg.a.getPercentDownload();break;case Ag.a.DecryptingBackup:s=Fg.a.getPercentDecrypt();break;case Ag.a.SyncInProgress:s=Fg.a.getPercentRestore()}return Math.round(e*s/100)};switch(e){case Ag.a.DownloadingBackup:return i(t,e);case Ag.a.DecryptingBackup:return i(t,Ag.a.DownloadingBackup)+i(s,e);case Ag.a.SyncInProgress:return i(t,Ag.a.DownloadingBackup)+i(s,Ag.a.DecryptingBackup)+i(a,e);default:return 0}}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=Ag.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=Ag.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=Ag.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=Ag.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=Ag.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=Ag.a.WaitForBackup}))}showMobileIdleInBackup(){this.setState((e=>{e.screen=Ag.a.MobileIdleInBackup}))}showDownloadingBackup(){this.setDownloadBackupTime(performance.now()),this.setState((e=>{e.screen=Ag.a.DownloadingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showDecryptingBackup(){this.setState((e=>{e.screen=Ag.a.DecryptingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showInProgress(){this.setState((e=>{e.screen=Ag.a.SyncInProgress,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=Ag.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=Ag.a.WaitForNetwork}))}setProgress(e){this.recordProgress(e),this.setState((t=>{t.progress=e,t.totalProgress=this.calculateTotalProgressTransfer()}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=Dg.c.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}setDownloadBackupTime(e){this.downloadBackupTime=e}getDownloadBackupTime(){return this.downloadBackupTime}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(Lg.a)(this.state,e);this.state!==t&&(this.state=t,Object(Po.h)(this.name,"current"))}})||Rg)||Rg);class Ng{constructor(e,t,s){this._issuedAt=void 0,this._ttl=void 0,this._publicKey=void 0,this._privateKey=void 0,this._publicKey=e,this._privateKey=t,this._ttl=s,this._issuedAt=Date.now()}get valid(){return Date.now()-this._issuedAt<this._ttl}get publicKey(){return this._publicKey}get privateKey(){return this._privateKey}}const Pg=Object(a.define)("sync-message-key-generator");var jg;const Ug=$znode.crypto;let Bg=a.ModuleContainer.injectable()(jg=class{generate(){return this.generateKey()}decryptKey(e,t,s){return Ug.privateDecrypt(s.privateKey,Ug.constants.RSA_PKCS1_PADDING,e,{input:"base64",output:t})}generateKey(){const e=Ug.generateKeyPairSync("rsa",{modulusLength:2048,publicKeyEncoding:{type:"spki",format:"der"},privateKeyEncoding:{type:"pkcs1",format:"pem"}},{publicKey:"base64",privateKey:""}),t=Ce.default.cross_setting.timeoutKey*Y.ONE_HOUR_MS;return new Ng(e.publicKey,e.privateKey,t)}})||jg;a.ModuleContainer.registerSingleton(Pg,Bg);const zg=Object(a.define)("ui-helper");a.ModuleContainer.register(zg,class{async showUserConfirm(e={}){return new Promise((t=>{let s=e.message;"string"==typeof s&&(s=le.a.trans(s)),J.p.dispatch({type:ve.PopupActions.TOGGLE_CONFIRM,payload:{headerText:le.a.trans(e.header||"STR_ZALO_CONFIRM"),callback:(e,s)=>{const a=!!s&&s.dontAskAgain;t([e,a])},buttons:{confirm:e.confirm&&le.a.trans(e.confirm),cancel:e.cancel&&le.a.trans(e.cancel),type:e.primaryButtonType||"primary"},message:s,usePrimaryForConfirm:!1,width:e.width||450,options:e.remember?[{title:e.remember,key:"dontAskAgain"}]:[]}})}))}async showUserConfirmV2(e={}){return new Promise((t=>{qo.ConfirmManagerV2.openConfirm({windowId:e.windowId||hr.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{title:le.a.str(e.header||"STR_CONFIRM"),message:le.a.str(e.message||""),okText:le.a.str(e.confirm||"STR_OK"),cancelText:le.a.str(e.cancel||"STR_CANCEL"),okType:e.primaryButtonType,width:e.width,onOk:()=>{t(!0)},onCancel:()=>{t(!1)}}})}))}closeUserCOnfrimV2(e){qo.ConfirmManagerV2.isVisible({windowId:(null==e?void 0:e.windowId)||hr.c,name:Y.MODAL_CONFIRM.confirmIdentities})&&qo.ConfirmManagerV2.closeConfirm({windowId:(null==e?void 0:e.windowId)||hr.c,name:Y.MODAL_CONFIRM.confirmIdentities})}});var Gg=s("cPHW");const xg=Object(a.define)("sync-message-service");var Vg=s("BOd8"),Hg=s("lgMn"),Wg=s("qKtC"),qg=s("FQFD"),Kg=s("+Mel");let $g=function(e){return e[e.RESTORE_CONVERSATIONS=0]="RESTORE_CONVERSATIONS",e[e.RESTORE_MESSAGES=1]="RESTORE_MESSAGES",e[e.UPDATE_MESSAGES_CACHE=2]="UPDATE_MESSAGES_CACHE",e}({});const Zg=Object(a.define)("sync-message-storage");class Qg{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("SyncStorage already initialized");this.key="sync_cross_state"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}class Yg{constructor(e){this.adapter=e,this._state=void 0}get step(){if(!this._state)throw new Error("SyncStateStore not initialized");return this._state.step}get isStarted(){return!!this._state&&this._state.started}get isSyncing(){return!!this._state&&this._state.isSyncing}set isSyncing(e){if(!this._state)throw new Error("SyncStateStore not initialized");this._state=Object(I.a)(Object(I.a)({},this._state),{},{isSyncing:e}),this.save()}get checkpoint(){if(!this._state)throw new Error("SyncStateStore not initialized");if(!this._state.checkpoint)throw new Error("Reset checkpoint before using");return this._state.checkpoint}set checkpoint(e){if(!this._state)throw new Error("SyncStateStore not initialized");if(!e)throw new Error("checkpoint should not be null");this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:e}),this.save()}load(){this._state=this.adapter.read("sync-state",1)}resetCheckpoint(e,t,s){if(!this._state)throw new Error("SyncStateStore not initialized");if(0===e)this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:{format:0,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:Number.MAX_SAFE_INTEGER}});else{if(1!==e)throw new Error("checkpoint.format must be 0 or 1");this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:{format:1,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:{},priorities:[],syncingConversation:null}})}}nextStep(){if(!this._state)throw new Error("SyncStateStore not initialized");const e=this._state.step+1;if(e>$g.UPDATE_MESSAGES_CACHE)throw new Error("already at the last step");this._state=Object(I.a)(Object(I.a)({},this._state),{},{step:e}),this.save()}reset(){this._state={step:$g.RESTORE_CONVERSATIONS,started:!0,isSyncing:!1},this.save()}clear(){this._state=null,this.adapter.remove("sync-state")}save(){this._state?this.adapter.write("sync-state",1,this._state):this.adapter.remove("sync-state")}}class Jg{constructor(e){this.adapter=e,this._backup=void 0}load(){this._backup=this.adapter.read("backup",1)}get(){if(void 0===this._backup)throw new Error("BackupStore not initialized");return this._backup}save(e){return this._backup=e,this.adapter.write("backup",1,this._backup),e}clear(){this._backup=null,this.adapter.remove("backup")}}class Xg{constructor(e){this.adapter=e,this._value=void 0}load(){this._value=this.adapter.read("src",1)}get(){if(void 0===this._value)throw new Error("SyncSourceStore not initialized");return this._value}save(e){this._value=e,this.adapter.write("src",1,this._value)}clear(){this._value=null,this.adapter.remove("src")}}class em{constructor(e){this.adapter=e,this._value=void 0,this._arrivalTimestamp=void 0,this._arrivalTimestamp=0}load(){this._value=this.adapter.read("tempKeySource",1)}setArrivalTimestamp(e){this._arrivalTimestamp=e}getArrivalTimestamp(){return this._arrivalTimestamp}get(){return void 0===this._value?Dg.m.SERVER:this._value}save(e){this._value=e,this.adapter.write("tempKeySource",1,this._value)}clear(){this._value=null,this.adapter.remove("tempKeySource")}}a.ModuleContainer.registerSingleton(Zg,class{constructor(){this._adapter=void 0,this._syncStateStore=void 0,this._syncSourceStore=void 0,this._backupStore=void 0,this._tempKeySourceStore=void 0,this._adapter=new Qg,this._syncStateStore=new Yg(this._adapter),this._syncSourceStore=new Xg(this._adapter),this._backupStore=new Jg(this._adapter),this._tempKeySourceStore=new em(this._adapter)}load(e){this.migrate(),this._adapter.load(),this._syncSourceStore.load(),this._syncStateStore.load(),this._backupStore.load(),this._tempKeySourceStore.load()}clear(e){e||(this._syncSourceStore.clear(),this._syncStateStore.clear()),this._backupStore.clear()}get syncState(){return this._syncStateStore}get backup(){return this._backupStore}get syncSource(){return this._syncSourceStore}get tempKeySource(){return this._tempKeySourceStore}migrate(){}});var tm,sm=s("6D/Z"),am=s("U+wf");const im=Object(a.define)("sync-message-metrics");let nm=Object(a.injectable)()(tm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(tm=Reflect.metadata("design:type",Function)(tm=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(tm=class{constructor(e){this.startTime=-1,this.lastMilestone=-1,this.lastSyncSource=Dg.j.MANUAL,this.logger=void 0,this.logger=e.createZLogger("msg-sync",["metrics"])}get storage(){return a.ModuleContainer.resolve(Zg)}get uiState(){return a.ModuleContainer.resolve(sm.b)}get setting(){return a.ModuleContainer.resolve(qg.a)}get entriesTransferManager(){return a.ModuleContainer.resolve(Wg.b)}get messageReadinessChecker(){return a.ModuleContainer.resolve(am.a)}setLastSyncSource(e){this.lastSyncSource=e}getLastSyncSource(){return this.lastSyncSource}onStartTransferAfterLogin(){this.actionLog(Dg.l.NORMAL),this.entriesTransferManager.missingMessageEventList.includes(Dg.j.E2EE_MISSING_MESSAGE)&&this.onTransferAfterLoginWithChangeDeviceEvent(),this.entriesTransferManager.missingMessageEventList.includes(Dg.j.OVERFLOW)&&this.onTransferAfterLoginWithOverflowQueueEvent(),this.setLastSyncSource(Dg.j.TRANSFER_WHEN_LOGIN)}onTransferAfterLoginWithChangeDeviceEvent(){this.actionLog(Dg.l.WITH_E2EE_MISSING_MESSAGE)}onTransferAfterLoginWithOverflowQueueEvent(){this.actionLog(Dg.l.WITH_OVERFLOW_QUEUE)}onCheckSyncSuggestion(e){switch(e){case Dg.j.FIRST_TIME_LOGIN:break;case Dg.j.OVERFLOW:this.actionLog(2090208)}}onShowSyncSuggestion(){switch(this.storage.syncSource.get()){case Dg.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case Dg.j.OVERFLOW:case Dg.j.E2EE_MISSING_MESSAGE:this.actionLog(2090201)}}onShowErrorModal(){this.uiState.getCurrentError()===Dg.c.USER_DONT_CONFIRM&&this.actionLog(2090801)}onSyncFailed(e){const t=this.lastSyncSource,s=this.storage.backup.get(),a=this.getSyncDuration(),i=JSON.stringify({format:(null==s?void 0:s.format)||void 0,src:t,import:this.storage.syncState.checkpoint.importedMessages,transfer:(null==s?void 0:s.numberOfMessagesCount)||void 0});ul.default.increaseFailed(Dg.f.GENERAL,0,a,e,Date.now(),[i]),this.logger.zsymb(0,"SUsNzn",`onSyncFailed ${e} ${i}`),e===Dg.c.USER_DONT_CONFIRM&&this.actionLog(2090903),t===Dg.j.TRANSFER_WHEN_LOGIN&&this.actionLog(Dg.l.FAILED)}onCloseBanner(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible(),s=this.uiState.getCurrentScreen();if(!t){if(this.actionLog(2090301),s===sm.a.SyncGuide)this.actionLog(2090701);e!==Dg.c.NO_ERROR&&(t||this.actionLog(2090402),e===Dg.c.USER_DONT_CONFIRM&&this.actionLog(2090901))}}onClosePopup(){const e=this.uiState.getCurrentError();this.uiState.getCurrentScreen()===sm.a.SyncGuide&&this.actionLog(2090601),e===Dg.c.USER_DONT_CONFIRM&&this.actionLog(2090803),e!==Dg.c.NO_ERROR&&this.actionLog(2091406)}onCloseSyncSuggestion(){switch(this.storage.syncSource.get()){case Dg.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case Dg.j.OVERFLOW:case Dg.j.E2EE_MISSING_MESSAGE:this.actionLog(2090203)}}clickResend(){this.actionLog(2090602)}clickCacnelInCloseSyncSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case Dg.j.FIRST_TIME_LOGIN:break;case Dg.j.OVERFLOW:this.actionLog(2090206)}}clickConfirmSync(){switch(this.storage.syncSource.get()){case Dg.j.MANUAL:this.setting.value().dontSuggest?this.actionLog(2091001):this.actionLog(2091002);break;case Dg.j.SETTING:this.setting.value().dontSuggest?this.actionLog(2090502):this.actionLog(2090501);break;case Dg.j.FIRST_TIME_LOGIN:this.actionLog(2090102);break;case Dg.j.OVERFLOW:case Dg.j.E2EE_MISSING_MESSAGE:this.actionLog(2090202)}}clickRejectSuggestion(){this.actionLog(2090103)}clickContinueInRejectSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case Dg.j.FIRST_TIME_LOGIN:break;case Dg.j.OVERFLOW:this.setting.value().dontSuggest?this.actionLog(2090205):this.actionLog(2090204)}}clickCancelInRejectSuggestionConfirmModal(){}clickCancelSync(){switch(this.uiState.getCurrentScreen()){case sm.a.SyncGuide:this.actionLog(2090304);break;case sm.a.WaitForBackup:this.actionLog(2090305)}}clickCancelInCancelSyncConfirmModal(){this.actionLog(2090302)}clickConfirmCancelSyncConfirmModal(){const e=this.uiState.getCurrentScreen(),t=this.storage.syncSource.get();e===sm.a.SyncGuide&&this.actionLog(2090311),t===Dg.j.TRANSFER_WHEN_LOGIN&&this.onUserTerminateTransferAfterLogin(),this.actionLog(2090303)}onUserTerminateTransferAfterLogin(){this.actionLog(Dg.l.USER_TERMINATE_TRANSFER_WHEN_LOGIN)}terminateTransferWhenLogin(){this.actionLog(Dg.l.AUTO_TERMINATE_TRANSFER_WHEN_LOGIN)}waitingForNoMissingMessageEventsTimeout(){this.actionLog(Dg.l.WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT)}clickRetrySync(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible();e!==Dg.c.NO_ERROR&&(this.actionLog(2090401),t&&this.actionLog(2091407),e===Dg.c.USER_DONT_CONFIRM&&(t?this.actionLog(2090802):this.actionLog(2090902)))}clickViewGuide(){this.actionLog(2090702)}resetSyncStartTime(){this.startTime=Oa.a.now(),this.lastMilestone=Oa.a.now()}onSyncSuccess(e,t,s,a={},i){const n=this.lastSyncSource;this.actionLog(2091101);const r=this.getSyncDuration(),o=JSON.stringify({format:e,src:n,import:t,transfer:s,trackInfo:a,timeBetweenSyncs:i});ul.default.increaseSuccess(Dg.f.GENERAL,0,r,[o]),n===Dg.j.TRANSFER_WHEN_LOGIN&&this.actionLog(Dg.l.SUCCESS),this.logger.zsymb(0,"-czB-D",`ph7 onSyncSuccess ${o}, ${r}`)}onReqBackupSuccess(e){const t=this.getMilestoneDuration(!0);ul.default.increaseSuccess(Dg.f.REQ_BACKUP,0,t,[JSON.stringify({format:e})])}onReqBackupFailure(e,t){ul.default.increaseFailed(Dg.f.REQ_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDownloadBackupSuccess(){const e=this.getMilestoneDuration(!0);ul.default.increaseSuccess(Dg.f.DOWNLOAD_BACKUP,0,e)}onDownloadBackupFailure(e,t){ul.default.increaseFailed(Dg.f.DOWNLOAD_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDecryptBackupSuccess(){const e=this.getMilestoneDuration(!0);ul.default.increaseSuccess(Dg.f.DECRYPT_BACKUP,0,e)}onDecryptBackupFailure(e){const t=this.getMilestoneDuration();ul.default.increaseFailed(Dg.f.DECRYPT_BACKUP,0,t,e,Date.now())}onRestoreDataSuccess(){const e=this.getMilestoneDuration(!0);ul.default.increaseSuccess(Dg.f.RESTORE_TASK,0,e),this.logger.zsymb(0,"0w88yO","ph7 restore success",e)}onRestoreDataFailure(e){const t=this.getMilestoneDuration();ul.default.increaseFailed(Dg.f.RESTORE_TASK,Dg.g.SELF_DEFINE,t,e,Date.now())}clickConfirmCancelSyncConfirmModalFromCounterModal(){this.uiState.getCurrentScreen()===sm.a.SyncGuide&&this.actionLog(2090311),this.actionLog(2090303)}onErrorTimeoutWaitingMobileConfirm(){this.actionLog(2090312)}clickCloseSynGuidePopup(){this.actionLog(2090601)}onShowSyncGuidePopup(){this.actionLog(2090604)}onConfirmSyncFromMobile(){this.actionLog(2090605)}onRejectSyncFromMobile(){this.actionLog(2090606)}onErrorPopupWaitingMobileConfirm(e){if(this.uiState.getPopupVisible())switch(this.actionLog(2091401),e){case Dg.c.NO_NETWORK:this.actionLog(2091402);break;case Dg.c.USER_DONT_CONFIRM:this.actionLog(2091403);break;case Dg.c.BUSY_RESTORING:this.actionLog(2091404);break;case Dg.c.CLIENT_NOT_SUPPORT:this.actionLog(2091405)}}onShowSyncSuggestionWithoutResume(){this.actionLog(2090209)}onMobileIdle(){this.actionLog(Dg.e)}logMissingMessageEventsTimeSinceGetLoginInfo(){const e=e=>e>0?(e-t)/1e3:-1,t=this.messageReadinessChecker.getGetLoginInfoTimestamp(),s=this.messageReadinessChecker.getDoneCheckOverflowTimestamp(),a=this.messageReadinessChecker.getE2eeSessionChangedTimestamp(),i=this.storage.tempKeySource.getArrivalTimestamp(),n=this.messageReadinessChecker.getApplicationReadyTimestamp();let r=e(s),o=e(a),l=e(i),c=e(n);t<=0&&(r=o=l=c=-1);this.actionLogInfoV2(Ia.FeaturesInfo.MessageReadinessStatus,2,{temp_key:l,queue_evict:r,change_device_e2ee:o,application_ready:c})}actionLogInfoV2(e,t,s,a,i){Ia.default.logActionInfoV2(e,t,s,a,i)}actionLog(e){Ia.default.logAction(e)}getSyncDuration(){return this.startTime>0?Oa.a.now()-this.startTime:0}getMilestoneDuration(e=!1){const t=this.lastMilestone>0?Oa.a.now()-this.lastMilestone:0;return e&&(this.lastMilestone=Oa.a.now()),t}})||tm)||tm)||tm)||tm;a.ModuleContainer.registerSingleton(im,nm);var rm=s("G15u"),om=s("4ZNH"),lm=s("Fbac");function cm(e){const t={retryCount:-1,canRetry:0!==e.maxRetry};return Object(rm.a)({context:t,initial:"running",states:{running:{entry:lm.a.assign({retryCount:e=>e.retryCount+1}),invoke:{src:t=>e.action(t.retryCount),onError:[{cond:(t,s)=>!(!t.canRetry||"function"==typeof e.canRetryError&&!e.canRetryError(s.data)),target:"retry"},{actions:(e,t)=>{e.error=t.data},target:"failure"}],onDone:{target:"final"}}},retry:{invoke:{src:()=>t=>{const s=e.autoRetry||0;if(s>0){const e=setTimeout((()=>{t({type:"RETRY"})}),s);return()=>clearTimeout(e)}return()=>{}}},on:{RETRY:{actions:lm.a.assign({canRetry:t=>-1===e.maxRetry||t.retryCount<e.maxRetry}),target:"running"},ABORT:{target:"final"}}},failure:{type:"final",data:e=>({success:!1,error:e.error})},final:{type:"final",data:{success:!0}}}})}function dm(e,t,s,a){return Object(rm.a)({strict:!0,context:{},initial:"running",states:{running:{initial:"prepare",states:{prepare:{entry:()=>{e.zsymb(3,"kThYhc",["prepare","tbehxd"])},invoke:{src:async()=>t.prepareNewSync(),onDone:"request_backup",onError:{actions:()=>{ul.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(Dg.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{me.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"qCjuTj",["send_request","pqZQzS"]),s.clearError(),s.showSyncGuide()},invoke:{id:"request_backup_api",src:cm({action:async e=>t.request(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===Y.NetWorkError.NO_NETWORK?(a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(a.onReqBackupFailure(Dg.g.EXTERNAL,e.error_code),!1):(a.onReqBackupFailure(Dg.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;211===(null===(i=t.data.error)||void 0===i?void 0:i.error_code)?(s.showError(Dg.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(Dg.c.CLIENT_NOT_SUPPORT)):s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>{s.showError(Dg.c.BACKUP_TIMEOUT),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERROR:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(Dg.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(Dg.c.CLIENT_NOT_SUPPORT),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},USER_CONFIRM:{actions:()=>{e.zsymb(3,"wRRWor",["user_confirm","xFKlSP"]),s.hidePopup(),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(Dg.c.USER_REJECT_BACKUP),s.hidePopup(),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Dg.c.BACKUP_FAILED),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_user_confirm:{entry:()=>{e.zsymb(3,"fr1D-N",["wait_for_user_confirm","HK4epy"]),s.clearError(),s.showSyncGuide(),a.onShowSyncGuidePopup()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"0LFZIA",["user_confirm","xFKlSP"]),s.hidePopup(),a.onConfirmSyncFromMobile(),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(Dg.c.USER_REJECT_BACKUP),s.hidePopup(),a.onRejectSyncFromMobile(),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.CONFIRM_TIMEOUT),a.onErrorTimeoutWaitingMobileConfirm(),a.onErrorPopupWaitingMobileConfirm(Dg.c.USER_DONT_CONFIRM),s.showError(Dg.c.USER_DONT_CONFIRM),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BUSY_RESTORING),s.showError(Dg.c.BUSY_RESTORING),a.onErrorPopupWaitingMobileConfirm(Dg.c.BUSY_RESTORING),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BACKUP_FAILED),s.showError(Dg.c.BACKUP_FAILED),Fg.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"mrzP2-",["wait_for_backup","kdbLqU"]),me.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BACKUP_TIMEOUT),s.showError(Dg.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Dg.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.INVALID_BACKUP),s.showError(Dg.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.INVALID_BACKUP),s.showError(Dg.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"WFOoDc",["download_backup","7G-uWb"]),me.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:cm({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===Y.NetWorkError.NO_NETWORK)return a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return a.onDownloadBackupFailure(Dg.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.b.ENOSPC),!1;const i=e.code||e.error_code,n=i?Dg.g.EXTERNAL:Dg.g.SELF_DEFINE;return a.onDownloadBackupFailure(n,i||Dg.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{a.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.b.DOWNLOAD_BACKUP_ERR);const n=(null===(i=t.data.error)||void 0===i?void 0:i.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(Dg.c.LOW_STORAGE):s.showError(Dg.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Dg.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"t-qjnD",["decrypt_backup","bY0n0X"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{a.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,i)=>{const n=i.data;e.zsymb(18,"0AWHZL",(()=>["decrypt_backup error",{error:n}])),a.onDecryptBackupFailure(n.error_code),s.showError(Dg.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"vaSu4a",["failure","U_BsTx"]),me.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{RETRY_SYNC:{target:"prepare"},START_SYNC:{target:"prepare"},USER_CONFIRM:{actions:()=>{e.zsymb(0,"4sWeU6","user_confirm"),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"rvTEyh","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:()=>{e.zsymb(3,"oDK8J9",["wait_for_network","_Xlg4H"]),s.showWaitForNetwork(),a.onErrorPopupWaitingMobileConfirm(Dg.c.NO_NETWORK),me.a.SyncMessageController.onNetworkError()},on:{START_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"},RETRY_SYNC:{target:"running.hist"}}}}})}var um,hm=s("VBs7");function gm(e,t,s,a,i){return Object(rm.a)({context:{canRetry:!1},initial:"running",states:{running:{entry:()=>{e.zsymb(3,"pVDLqm",["restoring","Cdi_7H"]),s.setProgress(0)},invoke:{id:"restore_backup",src:cm({action:async e=>t.restore(e),maxRetry:5,autoRetry:2e3,canRetryError:e=>"WorkerInterrupted"===e.name}),onDone:[{cond:(e,t)=>t.data.success,target:"cleanup"},{actions:e=>{s.showError(Dg.c.SYNC_FAILED)},target:"failure"}],onError:{actions:e=>{s.showError(Dg.c.SYNC_FAILED)},target:"failure"}}},cleanup:{entry:()=>{e.zsymb(3,"nJD9aM",["cleanup","c0LuuP"])},invoke:{src:async()=>{t.clean()},onDone:"success",onError:"success"}},wait_for_network:{entry:()=>{e.zsymb(3,"zFx4b_",["wait_for_network","_Xlg4H"]),s.showWaitForNetwork()},on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},ONLINE:{target:"running"}}},failure:{entry:[()=>{me.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},RETRY_SYNC:[{target:"running",cond:e=>e.canRetry},{actions:()=>{e.zsymb(3,"B96lq5",["restart sync","XbzF7U"]),me.a.SyncMessageController.restartSync()}}]}},success:{entry:[async()=>{await Object(Fg.c)(s),e.zsymb(3,"uvDhJS",["success","W5_UgK"]),s.showSuccessMessage(),me.a.SyncMessageController.onSyncSuccess(),me.a.SyncMessageController.setAutoCloseSuccessTimeout()},"signalDone"],on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},AUTO_CLOSE:{target:"done",actions:()=>s.hideAllUI()}}},done:{type:"final"}}},{actions:{signalDone:()=>{a.emit({topic:hm.a.Done})}}})}function mm(e,t,s,a){return Object(rm.a)({strict:!0,initial:"running",states:{running:{initial:"holding_temp_key",states:{holding_temp_key:{entry:()=>{me.a.SyncMessageController.setNoMissingMessageEventsTimeout(),t.getEnableLogEventsArrivalTimeConfig()&&setTimeout((()=>{a.logMissingMessageEventsTimeSinceGetLoginInfo()}),t.getEventsArrivalTimeSubmitLogTimeout()),t.getSuccessBannerWhenDropTransferWhenLoginConfig()&&s.showWaitForBackup(),e.zsymb(0,"BwJ6IB","holding temp key")},always:[{cond:"shouldTransferGuard",target:"prepare"},{cond:"shouldTerminateGuard",target:"#terminate_transfer_when_login"}],on:{HAVE_MISSING_MESSAGE_EVENTS:{target:"prepare"},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:()=>a.waitingForNoMissingMessageEventsTimeout(),target:"prepare"},HAVE_NO_MISSING_MESSAGE_EVENT:{cond:"shouldTerminateConfigGuard",target:"#terminate_transfer_when_login"}}},prepare:{entry:()=>me.a.SyncMessageController.startTransferAfterHoldingTempKey(),invoke:{src:async()=>t.prepareNewSync(),onDone:[{cond:(e,t)=>""!==e.tempKey,target:"request_backup"},{cond:(e,t)=>""===e.tempKey,actions:()=>s.showError(Dg.c.PREPARE_NEW_SYNC_FAILED),target:"failure"}],onError:{actions:()=>{ul.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(Dg.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{me.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"Dmadz4",["send_request","pqZQzS"]),s.clearError()},invoke:{id:"request_backup_api",src:(e,s)=>cm({action:async s=>t.request(s,void 0,e.tempKey),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===Y.NetWorkError.NO_NETWORK?(a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(a.onReqBackupFailure(Dg.g.EXTERNAL,e.error_code),!1):(a.onReqBackupFailure(Dg.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,actions:Object(om.b)((e=>({tempKey:""}))),target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;211===(null===(i=t.data.error)||void 0===i?void 0:i.error_code)?(s.showError(Dg.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(Dg.c.CLIENT_NOT_SUPPORT)):s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>s.showError(Dg.c.BACKUP_TIMEOUT),target:"failure"},ERROR:{actions:()=>s.showError(Dg.c.REQUEST_BACKUP_FAILED),target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(Dg.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(Dg.c.CLIENT_NOT_SUPPORT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>s.showError(Dg.c.BACKUP_FAILED),target:"failure"}}},wait_for_user_confirm:{entry:()=>{me.a.SyncMessageController.setMobileTransferConfirmTimeout()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"NJq7ZB",["user_confirm (transfer after login)","C5wV1A"]),me.a.SyncMessageController.clearMobileTransferConfirmTimeout()},target:"wait_for_backup"},MOBILE_CONFIRM_TIMEOUT:{actions:()=>{Fg.a.isEnableSyncIdleMobileState()&&s.showMobileIdleInBackup()}},ERR_TIMEOUT:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BUSY_RESTORING),s.showError(Dg.c.BUSY_RESTORING),a.onErrorPopupWaitingMobileConfirm(Dg.c.BUSY_RESTORING)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BACKUP_FAILED),s.showError(Dg.c.REQUEST_BACKUP_FAILED)},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"ZJ680Z",["wait_for_backup","kdbLqU"]),me.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.BACKUP_TIMEOUT),s.showError(Dg.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(Dg.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.INVALID_BACKUP),s.showError(Dg.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{a.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.INVALID_BACKUP),s.showError(Dg.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"6JMIdh",["download_backup","7G-uWb"]),me.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:cm({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===Y.NetWorkError.NO_NETWORK)return a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return a.onDownloadBackupFailure(Dg.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.b.ENOSPC),!1;const i=e.code||e.error_code,n=i?Dg.g.EXTERNAL:Dg.g.SELF_DEFINE;return a.onDownloadBackupFailure(n,i||Dg.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{a.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;a.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.b.DOWNLOAD_BACKUP_ERR);const n=(null===(i=t.data.error)||void 0===i?void 0:i.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(Dg.c.LOW_STORAGE):s.showError(Dg.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(Dg.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"gF5C1I",["decrypt_backup","bY0n0X"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{a.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,i)=>{const n=i.data;e.zsymb(18,"nmWcIT",(()=>["decrypt_backup error",{error:n}])),a.onDecryptBackupFailure(n.error_code),s.showError(Dg.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"sD-kx0",["failure","U_BsTx"]),me.a.SyncMessageController.onSyncFailed()},"signalDone",Object(om.b)((e=>({tempKey:""})))],on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"IiI57K",["user_confirm (transfer after login)","C5wV1A"]),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"6yFDHQ","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},terminate_transfer_when_login:{id:"terminate_transfer_when_login",type:"final",entry:()=>me.a.SyncMessageController.terminateTransferWhenLogin(),data:()=>({terminate_transfer_when_login:!0})},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:[()=>{e.zsymb(3,"Ynf34w",["wait_for_network","_Xlg4H"]),s.showWaitForNetwork(),a.onErrorPopupWaitingMobileConfirm(Dg.c.NO_NETWORK)},Object(om.b)((e=>({tempKey:""})))],on:{START_AUTO_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"}}}}},{guards:{shouldTransferGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!0;const e=t.isAtLeastOneMissingMessageEventArrived(),s=t.shouldTransferWhenLogin();return e||s},shouldTerminateGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!1;const s=t.isNoMissingMessageEventsArrived();return e.zsymb(0,"bwsb83",`shouldTerminate: ${s}`),s},shouldTerminateConfigGuard:()=>t.getEnabledDropTransferWhenLoginFlowConfig()}})}let pm=Object(a.injectable)()(um=Object(a.singleton)()(um=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(um=function(e,t){return Object(a.inject)(xg)(e,void 0,1)}(um=function(e,t){return Object(a.inject)(Zg)(e,void 0,2)}(um=function(e,t){return Object(a.inject)(sm.b)(e,void 0,3)}(um=function(e,t){return Object(a.inject)(im)(e,void 0,4)}(um=function(e,t){return Object(a.inject)(Hg.b)(e,void 0,5)}(um=Reflect.metadata("design:type",Function)(um=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===xg?Object:xg,void 0===Zg?Object:Zg,void 0===sm.b?Object:sm.b,void 0===im?Object:im,void 0===Hg.b?Object:Hg.b])(um=class extends Vg.a{constructor(e,t,s,a,i,n){super(),this.loggerFactory=e,this.service=t,this.storage=s,this.ui=a,this.metrics=i,this.zmq=n}createMachine(){return e=this.loggerFactory.createZLogger("msg-sync",["state"]),t=this.metrics,s=this.service,a=this.storage,i=this.ui,n=this.zmq,Object(rm.a)({strict:!0,id:"message-sync",context:{},initial:"idle",states:{idle:{entry:()=>e.zsymb(3,"O7Ql4C",["idle","2ncPzg"]),on:{SUGGEST_NEW_SYNC:"suggest_new_sync",SUGGEST_RESUME:"suggest_resume",START_AUTO_SYNC:"run.auto_backup",START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"}}},suggest_new_sync:{entry:(s,n)=>{e.zsymb(0,"J7H-pO",(()=>["suggest_new_sync",{src:Object(Dg.t)(n.src)}])),a.syncSource.save(n.src),t.onShowSyncSuggestion(),i.showSuggestNewSync(n.shouldShowSyncGuide)},on:{START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"},START_AUTO_SYNC:"run.auto_backup",CLOSE_SUGGEST:{actions:()=>i.hideAllUI(),target:"idle"}}},suggest_resume:{entry:()=>{e.zsymb(3,"HnLhUW",["suggest_resume","vKXkcR"]),i.showSuggestResume()},on:{START_SYNC:"run",START_AUTO_SYNC:"run.auto_backup",RESUME_SYNC:"#restore_backup",CLOSE_SUGGEST:{actions:()=>i.hideAllUI(),target:"idle"}}},run:{initial:"request_backup",states:{request_backup:{entry:()=>e.zsymb(3,"dCP4PH",["request_backup","8Nj83c"]),invoke:{id:"request_backup",src:dm(e,s,i,t),onDone:"restore_backup"},on:{SUCCESS:{actions:Object(om.i)("request_backup")},USER_REJECT:{actions:Object(om.i)("request_backup")},USER_CONFIRM:{actions:Object(om.i)("request_backup")},RETRY_SYNC:{actions:Object(om.i)("request_backup")},ERR_INVALID_BACKUP:{actions:Object(om.i)("request_backup")},ERR_BACKUP_FAIL:{actions:Object(om.i)("request_backup")},ERR_BUSY_RESTORING:{actions:Object(om.i)("request_backup")},ERR_TIMEOUT:{actions:Object(om.i)("request_backup")},START_SYNC:{actions:[Object(om.i)("request_backup"),()=>{t.clickConfirmSync()}]}}},auto_backup:{entry:()=>{e.zsymb(3,"_F4UPa",["auto_backup","E5TeIT"]),t.onStartTransferAfterLogin(),a.syncSource.save(Dg.j.TRANSFER_WHEN_LOGIN)},invoke:{id:"auto_backup",src:mm(e,s,i,t),data:(e,t)=>({tempKey:t.tempKey}),onDone:[{cond:(e,t)=>{var s;return null===(s=t.data)||void 0===s?void 0:s.terminate_transfer_when_login},target:"terminate_transfer_when_login"},{cond:(e,t)=>{var s;return!(null!==(s=t.data)&&void 0!==s&&s.terminate_transfer_when_login)},target:"restore_backup"}]},on:{SUCCESS:{actions:Object(om.i)("auto_backup")},RETRY_SYNC:{target:"#message-sync.run",actions:()=>{const e=Dg.j.MANUAL;a.syncSource.save(e),t.setLastSyncSource(e)}},USER_CONFIRM:{actions:Object(om.i)("auto_backup")},ERR_INVALID_BACKUP:{actions:Object(om.i)("auto_backup")},ERR_BACKUP_FAIL:{actions:Object(om.i)("auto_backup")},ERR_BUSY_RESTORING:{actions:Object(om.i)("auto_backup")},MOBILE_CONFIRM_TIMEOUT:{actions:Object(om.i)("auto_backup")},ERR_TIMEOUT:{actions:Object(om.i)("auto_backup")},START_AUTO_SYNC:{actions:Object(om.i)("auto_backup")},TERMINATE_TRANSFER_WHEN_LOGIN:{actions:Object(om.i)("auto_backup")},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:Object(om.i)("auto_backup")},HAVE_MISSING_MESSAGE_EVENTS:{actions:Object(om.i)("auto_backup")},HAVE_NO_MISSING_MESSAGE_EVENT:{actions:Object(om.i)("run.auto_backup")}}},restore_backup:{id:"restore_backup",entry:()=>{i.showInProgress(),i.setProgress(0)},invoke:{id:"restore_backup_machine",src:gm(e,s,i,n),onDone:"done"},on:{RESTART_SYNC:{actions:()=>{t.clickConfirmSync()},target:"request_backup"},START_SYNC:{actions:Object(om.i)("restore_backup_machine")},RETRY_SYNC:{actions:Object(om.i)("restore_backup_machine")},AUTO_CLOSE:{actions:Object(om.i)("restore_backup_machine")}}},terminate_transfer_when_login:{entry:[async()=>{e.zsymb(2,"oc4ugb","Successfully terminate transfer when login"),me.a.SyncMessageController.onTerminateTransferWhenLoginSuccess(),s.getSuccessBannerWhenDropTransferWhenLoginConfig()&&(i.showSuccessMessage(),me.a.SyncMessageController.setAutoCloseSuccessTimeout())}],always:[{cond:"shouldFinishTerminateFlow",target:"done"}],on:{AUTO_CLOSE:{target:"done",actions:()=>i.hideAllUI()}}},done:{type:"final"}},onDone:"idle"}},on:{CANCEL:{target:"idle",actions:()=>{i.hideAllUI(),me.a.SyncMessageController.onSyncCanceled()}},RESET:{target:"idle",actions:()=>i.hideAllUI()}}},{guards:{shouldFinishTerminateFlow:()=>!s.getSuccessBannerWhenDropTransferWhenLoginConfig()}});var e,t,s,a,i,n}canSuggestNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!t)return!1;if(t.matches("idle"))return!0;let s;return t.children.request_backup&&(s=t.children.request_backup.getSnapshot()),t.children.auto_backup&&(s=t.children.auto_backup.getSnapshot()),t.children.restore_backup_machine&&(s=t.children.restore_backup_machine.getSnapshot()),!s||(s.matches("success")||s.matches("failure")||s.matches("running.failure"))}canStartNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!!t&&(!!(t.matches("idle")||t.matches("suggest_new_sync")||t.matches("suggest_resume"))||this.canSuggestNewSync())}isMachineIdle(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!t||t.matches("idle")}})||um)||um)||um)||um)||um)||um)||um)||um)||um)||um;var fm,vm=s("LLK0"),_m=s("fg6f"),bm=s("RxLg"),Im=s("HaJU"),ym=s("svq+"),Sm=s("rrDN"),Cm=s("lANr");Object(m.j)()(fm=Object(m.f)()(fm=Object(m.h)()(fm=Object(a.singleton)(Gg.a)(fm=Object(a.injectable)()(fm=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(fm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(fm=function(e,t){return Object(a.inject)(qg.a)(e,void 0,2)}(fm=function(e,t){return Object(a.inject)(xg)(e,void 0,3)}(fm=function(e,t){return Object(a.inject)(sm.b)(e,void 0,4)}(fm=function(e,t){return Object(a.inject)(Zg)(e,void 0,5)}(fm=function(e,t){return Object(a.inject)(zg)(e,void 0,6)}(fm=function(e,t){return Object(a.inject)(im)(e,void 0,7)}(fm=function(e,t){return Object(a.inject)(Wg.b)(e,void 0,8)}(fm=function(e,t){return Object(a.inject)(St.b)(e,void 0,9)}(fm=function(e,t){return Object(a.inject)(am.a)(e,void 0,10)}(fm=Reflect.metadata("design:type",Function)(fm=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===qg.a?Object:qg.a,void 0===xg?Object:xg,void 0===sm.b?Object:sm.b,void 0===Zg?Object:Zg,void 0===zg?Object:zg,void 0===im?Object:im,void 0===Wg.b?Object:Wg.b,void 0===St.ISystemTime?Object:St.ISystemTime,Object])(fm=class extends hs.b{constructor(e,t,s,i,n,r,o,l,c,d,u){super(),this.initialized=!1,this.currentUserId="",this.currentUserUIN="",this.isSyncRunning=!1,this.requestedSuggestSync=null,this.requestBackupTimeout=null,this.mobileTransferConfirmTimeout=null,this.waitingForMissingMessageEventsTimeout=null,this.autoCloseSuccessTimeout=null,this.logger=void 0,this.config=void 0,this.setting=void 0,this.service=void 0,this.storage=void 0,this.machine=void 0,this.systemTime=void 0,this.ui=void 0,this.helper=void 0,this.entriesTransferManager=void 0,this.messageReadinessChecker=void 0,this.metricts=void 0,this.suggestSync=async(e,t=!0,s=!1)=>{this.initialized?(this.machine.send({type:"SUGGEST_NEW_SYNC",src:e,shouldShowSyncGuide:t}),s||this.metricts.onShowSyncSuggestionWithoutResume()):this.logger.zsymb(18,"l-o2Pj","suggest sync but not ready")},this.suggestResume=async()=>{this.initialized?this.machine.send("SUGGEST_RESUME"):this.logger.zsymb(18,"aEoLCw","suggest resume but not ready")},this.sync=async e=>{this.isSyncRunning=!0,"number"==typeof e?this.storage.syncSource.save(e):e=this.storage.syncSource.get()||Dg.j.MANUAL,this.metricts.setLastSyncSource(e),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"R91UWA","start new sync"),e===Dg.j.FIRST_TIME_LOGIN&&(this.setting.setMaxSeq(0),this.setting.setMinSeq(0)),this.machine.send("START_SYNC"),this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Kg.d)},this.resume=async()=>{this.isSyncRunning=!0,this.logger.zsymb(0,"Ft2Ea-","resume last sync");const e=this.storage.backup.get();this.storage.syncSource.save(Dg.j.RESUME),this.metricts.setLastSyncSource(Dg.j.RESUME),this.metricts.resetSyncStartTime();const t=e&&this.storage.syncState.isSyncing,s=this.entriesTransferManager.getSyncSource();if(t&&!s){const t=await this.service.getBackupFolderPath(e);t!==e.outputPath&&(e.outputPath=t,this.storage.backup.save(e),this.logger.zsymb(0,"XO0DkH","backup output changed over the last session")),this.machine.send("RESUME_SYNC")}else this.machine.send("START_SYNC");this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Kg.b)},this.startTransferAfterHoldingTempKey=()=>{this.isSyncRunning=!0,this.dispatchEvent(new Kg.d),this.clearNoMissingMessageEventsTimeout(),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"E3SVtY","start transfer after holding temp key")},this.cancel=async e=>{if(this.metricts.onCloseBanner(),this.metricts.clickCancelSync(),this.setting.value().dontConfirmCancel)return this.metricts.onUserTerminateTransferAfterLogin(),this.logger.zsymb(0,"_FvqfN","cancel sync"),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),void(await this.service.clean());let t,s,a;this.logger.zsymb(0,"zzRZFN","prompt cancel sync"),e?(t="STR_CONFIRM_SKIP_SYNC_DB_MSG_TITLE",s="STR_CONFIRM_SKIP_SYNC_DB_MSG_TEXT",a="STR_CONFIRM_SKIP_SYNC_DB_MSG_CONFIRM"):(t="STR_SETTING_MSG_SYNC_POPUP_HEADER",s="STR_SETTING_MSG_SYNC_POPUP_BODY",a="STR_SETTING_MSG_SYNC_POPUP_OK");const[i,n]=await this.helper.showUserConfirm({header:t,message:s,confirm:a,cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTASK",primaryButtonType:"secondary-danger"});i?(this.metricts.clickConfirmCancelSyncConfirmModal(),this.logger.zsymb(0,"Qx2TvV",(()=>["user confirm cancel sync",{dontAskAgain:n}])),n&&this.setting.setDontConfirmCancel(n),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean()):this.metricts.clickCancelInCancelSyncConfirmModal()},this.confirmCancelSyncInSuggestingPopup=async()=>{this.metricts.clickCloseSynGuidePopup();await this.helper.showUserConfirmV2({header:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_TITLE",message:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_DES",confirm:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_OKE",cancel:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_CANCEL",primaryButtonType:"secondary-danger",width:410})&&(this.metricts.clickConfirmCancelSyncConfirmModalFromCounterModal(),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean())},this.cleanupInMobileBusyBackup=async()=>{this.machine.send("CANCEL"),await this.service.clean()},this.closeCancelSyncInSuggestingPopup=async()=>{this.helper.closeUserCOnfrimV2()},this.reset=()=>{this.machine.send("RESET"),this.metricts.onCloseBanner(),this.ui.clearError(),this.clearAutoCloseSuccessTimeout(),this.clearRequestBackupTimeout(),this.service.clean()},this.pause=async()=>{throw new Error("Method not implemented.")},this.retry=async()=>{this.metricts.clickRetrySync(),this.logger.zsymb(0,"ttJhlw","retry sync"),this.machine.send("RETRY_SYNC"),this.dispatchEvent(new Kg.c)},this.showSuggestPopup=()=>{this.ui.showPopup()},this.closeSuggestPopup=()=>{this.metricts.onClosePopup(),this.ui.hidePopup()},this.rejectSuggest=async()=>{this.metricts.onCloseBanner(),this.logger.zsymb(0,"GRGNwc","prompt user reject suggest sync");const[e,t]=await this.helper.showUserConfirm({header:"STR_SETTING_MSG_SYNC_POPUP_HEADER_START",message:"STR_SETTING_MSG_SYNC_POPUP_BODY_START",confirm:"STR_SETTING_MSG_SYNC_POPUP_OK_START",cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL_START",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTSHOW",primaryButtonType:"primary"});e?(this.logger.zsymb(0,"A5-wot","user confirm reject suggest sync"),t&&(this.logger.zsymb(0,"ISQ-Bk","user check dont suggest again"),this.setting.setDontSuggest(!0)),this.metricts.clickContinueInRejectSuggestionConfirmModal(),this.machine.send("CLOSE_SUGGEST"),this.storage.syncSource.clear(),this.setting.setLastCloseSuggest(this.systemTime.getTimeNow())):(this.metricts.clickCacnelInCloseSyncSuggestionConfirmModal(),this.ui.hidePopup(),this.logger.zsymb(0,"mIlo9I","user cancel"))},this.hideProgress=async()=>{this.setting.value().hideProgress||this.setting.toggleHideProgress(),this.helper.showUserConfirm({width:353,header:"STR_SETTING_MSG_SYNC_NOTICE_HEADER",confirm:"STR_SETTING_MSG_SYNC_NOTICE_OK",primaryButtonType:"neutral",message:rr.a.createElement("span",null,rr.a.createElement(lr.a,{textKey:"STR_HIDE_DB_TOAST",tagName:"div"}),rr.a.createElement("i",{className:"fa fa-tab-setting internal-icon"}),rr.a.createElement(lr.a,{textKey:"STR_SETTING_MSG_SYNC_NOTICE_BODY_BOLD",style:{fontWeight:500}}))})},this.setRequestBackupTimeout=e=>{this.ui.resetStartSyncTime(),this.clearRequestBackupTimeout(),this.requestBackupTimeout=setTimeout((()=>{this.logger.zsymb(0,"0rFfDv","request backup timeout"),this.machine.send("ERR_TIMEOUT")}),this.service.getRequestBackupTimeout(e))},this.setMobileTransferConfirmTimeout=()=>{this.ui.resetStartSyncTime(),this.clearMobileTransferConfirmTimeout();const e=this.service.getMobileTransferConfirmTimeout();e>0?this.mobileTransferConfirmTimeout=setTimeout((()=>{this.logger.zsymb(0,"akgoX9","mobile auto confirm timeout"),this.machine.send("MOBILE_CONFIRM_TIMEOUT")}),e):this.machine.send("MOBILE_CONFIRM_TIMEOUT")},this.setNoMissingMessageEventsTimeout=()=>{this.clearNoMissingMessageEventsTimeout();const e=this.service.getNoMissingMessageEventsTimeout();e>0?this.waitingForMissingMessageEventsTimeout=setTimeout((()=>{this.logger.zsymb(0,"xArSFA","waiting for no missing events timeout"),this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")}),e):this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")},this.clearRequestBackupTimeout=()=>{this.requestBackupTimeout&&(clearTimeout(this.requestBackupTimeout),this.requestBackupTimeout=null)},this.clearMobileTransferConfirmTimeout=()=>{this.mobileTransferConfirmTimeout&&(clearTimeout(this.mobileTransferConfirmTimeout),this.mobileTransferConfirmTimeout=null)},this.clearNoMissingMessageEventsTimeout=()=>{this.waitingForMissingMessageEventsTimeout&&(clearTimeout(this.waitingForMissingMessageEventsTimeout),this.waitingForMissingMessageEventsTimeout=null)},this.setAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout=setTimeout((()=>{this.logger.zsymb(0,"8lLE1R","auto close success timeout"),this.machine.send("AUTO_CLOSE")}),this.service.getCloseSuccessTimeout())},this.clearAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout&&(clearTimeout(this.autoCloseSuccessTimeout),this.autoCloseSuccessTimeout=null)},this.resendRequest=async()=>this.service.request(0,1),this.handleCtrlEvents=e=>{const t=this.service.session;if(!t)return this.logger.zsymb(18,"NEvUID","received control event but no session"),void this.metricts.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.NO_SESSION);for(const i of e){if(Kg.a.isUserConfirm(t,i))return void this.machine.send({type:"USER_CONFIRM"});if(Kg.a.isUserReject(t,i))return void this.machine.send({type:"USER_REJECT"});if(Fg.a.isEnableSyncIdleMobileState()&&Kg.a.isMobileIdle(t,i))return this.metricts.onMobileIdle(),void this.ui.showMobileIdleInBackup();if(Fg.a.isEnableSyncIdleMobileState()&&Kg.a.isMobileActive(t,i))return void this.ui.showWaitForBackup();if(Kg.a.isBackupSuccess(t,i)){var s;let e;try{e=JSON.parse(i.data.db_info)}catch(a){return this.logger.zsymb(18,"LDO4mx",(()=>["parse db info fail",{error:a.message}])),this.metricts.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}let t=0,n=0;try{e.backup_db&&(t=e.backup_db.msg_thread,n=e.backup_db.msg_total),e.origin_db&&(t=e.origin_db.msg_thread,n=e.origin_db.msg_total)}catch(a){return this.logger.zsymb(18,"BjlwO0",(()=>["parse db info fail",{error:a.message}])),this.metricts.onReqBackupFailure(Dg.g.SELF_DEFINE,Dg.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}const r=null!==(s=e.db_format)&&void 0!==s?s:0;this.metricts.onReqBackupSuccess(r);const o=this.storage.syncSource.get();this.metricts.setLastSyncSource(o),this.storage.backup.save({rawUid:i.data.uid,userId:this.currentUserId,uin:this.currentUserUIN,fromSeqId:i.data.from_seq_id,isFull:!!i.data.is_full_transfer,name:i.data.file_name,url:i.data.url,checksum:i.data.checksum_code||i.data.checksum||"",publicKey:i.data.public_key,encryptedKey:i.data.encrypted_key,privateKey:"",format:r,inputPath:"",outputPath:"",numberOfConversationsCount:t,numberOfMessagesCount:n,conversations:[]});const l=this.setting.value();return this.storage.syncState.resetCheckpoint(r,l.minSeq,l.maxSeq),this.logger.zsymb(0,"Hcttd9",(()=>["received backup",{format:r,msgCount:n,threadCount:t}])),void this.machine.send("SUCCESS")}if(Kg.a.isBackupFail(t,i))return void this.machine.send("ERR_BACKUP_FAIL");if(Kg.a.isMobileRestoring(t,i))return void this.machine.send("ERR_BUSY_RESTORING");ul.default.increaseFailed(Dg.f.REQ_BACKUP,0,0,Dg.h.UNKNOWN_EVENT,Date.now()),this.logger.zsymb(18,"_H4f0Q",(()=>["unknown control event",{event:i}]))}},this.handleTransferAfterLoginCtrlEvents=e=>{if(!this.shouldProcessTransferAfterLogin())return;const t=this.validateTransferWhenLoginEvents(e);t&&this.processTransferWhenLogin(t)},this.shouldProcessTransferAfterLogin=()=>{const e=!a.ModuleContainer.resolve(xc.b).didBlockApp;return this.logger.zsymb(0,"5Y6VnH",`should process transfer after login: ${e}`),e},this.validateTransferWhenLoginEvents=e=>{try{const t=e.filter((e=>Kg.a.isTransferAfterLoginControlEvent(e)));if(0===t.length)return null;t.sort(((e,t)=>e.ts-t.ts)),this.logger.zsymb(0,"9i2E64",(()=>["sorted and filtered transfer events",t]));const s=t[t.length-1];if(this.systemTime.getTimeNow()-s.ts<=Dg.k)return s;this.logger.zsymb(0,"laQ6mx","No valid temp key in this control batch")}catch(t){this.logger.zsymb(0,"rBYYMj","failed to validate transfer when login events",t)}return null},this.processTransferWhenLogin=e=>{this.logger.zsymb(0,"bx6HA3","tempKey for transfer when login arrived",e),this.logTempKeyArrivalTimestamp(),_m.k.GetManager().setIsTransferAfterLogin(!0),_m.k.GetManager().hideTransferMessagesModal();let t=e.data.temp_key;switch(this.storage.tempKeySource.get()){case Dg.m.ARBITRARY:t="arbitrary temp key";break;case Dg.m.EMPTY:t=""}this.machine.send({type:"START_AUTO_SYNC",tempKey:t})},this.registerEventListenerForTransferWhenLogin=()=>{this.messageReadinessChecker.addEventListener(Cm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents),_e.default.subscribe(this.handleOverFlowQueue)},this.handleNoMissingMessageEvents=()=>{this.logger.zsymb(0,"YIMy-d","No missing message events, send event HAVE_NO_MISSING_MESSAGE_EVENT"),this.machine.send("HAVE_NO_MISSING_MESSAGE_EVENT"),this.messageReadinessChecker.removeEventListener(Cm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents)},this.handleOverFlowQueue=(e,t)=>{if(e===ve.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG){if(!t.queueId)return;this.machine.send("HAVE_MISSING_MESSAGE_EVENTS"),_e.default.unsubscribe(this.handleOverFlowQueue)}},this.logTempKeyArrivalTimestamp=()=>{try{var e;this.storage.tempKeySource.setArrivalTimestamp(null!==(e=Ct.default.getSystemTimeNow())&&void 0!==e?e:0)}catch(t){}},this.machine=a.ModuleContainer.resolveToken(pm),this.logger=t.createZLogger(R.ZLoggerNametags.msgSync,[R.ZLoggerNametags.controller,"daivd"]),this.config=e,this.service=i,this.setting=s,this.storage=r,this.ui=n,this.helper=o,this.metricts=l,this.systemTime=d,this.entriesTransferManager=c,this.messageReadinessChecker=u}isEnable(){const e=this.config.get("cross_setting.offFeature"),t=this.config.get("cross_setting.enable");return!e&&t}isEnableBySrc(e){if(this.metricts.onCheckSyncSuggestion(e),!this.isEnable())return!1;switch(e){case Dg.j.FIRST_TIME_LOGIN:return this.config.get("cross_setting.enableFirstTimeUse");case Dg.j.MANUAL:return this.config.get("cross_setting.enableManual");case Dg.j.OVERFLOW:return this.config.get("cross_setting.enableOverQueue");case Dg.j.E2EE_MISSING_MESSAGE:return this.config.get("notify_missing_e2ee_message.enable")}return!0}isEnableResume(){return!!this.isEnable()&&this.config.get("cross_setting.enableResume")}canSync(e){return this.isEnableBySrc(e)?this.machine.canStartNewSync()?Dg.a.OK:Dg.a.INVALID_STATE:Dg.a.DISABLED}isThisSessionSyncing(){return this.isSyncRunning}onStart(){if(this.isEnable()){this.logger.zsymb(0,"llW7f1","initialize");try{this.machine.create(),this.machine.start()}catch(e){return void this.logger.zsymb(18,"gfWMXU",(()=>["start error",{error:e}]))}this.initialized=!0,""!==this.currentUserId&&this.checkSuggestWhenReady(),this.registerEventListenerForTransferWhenLogin(),a.ModuleContainer.resolve(Sm.AFMC_TModule).get(Sm.AFMC_TController).addEventListener(ym.a.SHOW_SYNC_MESSAGE_SUGGESTION,(e=>{const t=e.queueId;if(!t)return;if(this.setting.value().dontSuggest)return void this.logger.zsymb(3,"SxPDLj",["queue is full, but user has already disable sync suggestion","l6muYU"]);if(!this.isEnableBySrc(Dg.j.OVERFLOW))return void this.logger.zsymb(0,"RR7ZUq","sync when overflow is not enable");const s=this.config.get("cross_setting.timeBetweenSync")||0,a=this.setting.value().lastSync;if(s>0&&a>0){const e=a+60*s*1e3;if(e>Date.now())return void this.logger.zsymb(0,"Koc7EF",`queue is full, but user has already sync in time. next sync: ${new Date(e).toLocaleString()}`)}const i=this.config.get("msg_sync.overflow_queue");if(i){if(i.some((e=>t==e)))return void this.delayedSuggestSync(Dg.j.OVERFLOW,!1)}else this.logger.zsymb(0,"1IsTC_","queue evict is not set")})),this.entriesTransferManager.addEventListener(bm.a.NotifyE2eeConvChangeDevice,(e=>{if(e.type===bm.a.NotifyE2eeConvChangeDevice){if(this.machine.send({type:"HAVE_MISSING_MESSAGE_EVENTS"}),this.setting.value().dontSuggest)return void this.logger.zsymb(3,"KwvRFu",["Change device and has e2ee convs, but user has already disable sync suggestion","-9QuC1"]);if(!this.isEnableBySrc(Dg.j.E2EE_MISSING_MESSAGE))return void this.logger.zsymb(0,"wjjP7j","Sync when change device and has e2ee convs is not enable");const e=this.config.get("cross_setting.timeBetweenSync")||0,t=this.setting.value().lastSync;if(e>0&&t>0){const s=t+60*e*1e3;if(s>Date.now())return void this.logger.zsymb(0,"P6ZwoV",`Change device and has e2ee convs, but user has already sync in time. next sync: ${new Date(s).toLocaleString()}`)}this.entriesTransferManager.getSyncSource()===Dg.j.E2EE_MISSING_MESSAGE&&(this.logger.zsymb(0,"KergMZ","Suggest sync by [NotifyE2eeConvChangeDevice] event"),this.delayedSuggestSync(Dg.j.E2EE_MISSING_MESSAGE,!1))}}))}else this.logger.zsymb(0,"nfFkAG","feature is not enable")}onAuthenticated(e){this.storage.load(e.getSession().userId),this.setting.load(e.getSession().userId),this.currentUserId=e.getSession().userId,this.currentUserUIN=e.getSession().UIN||"",setTimeout((()=>{if(!this.isThisSessionSyncing()){ll.a.getInstance().resumeIdx()}}),5e3),this.initialized&&setTimeout(this.checkSuggestWhenReady.bind(this),1e3)}onDispose(){this.service.abortRestore(),this.machine.status===vm.b.Running&&this.machine.stop()}delayedSuggestSync(e,t=!0,s=!1){setTimeout((()=>this.suggestSync(e,t,s)),Im.a.transfer_when_login.time_wait_for_temp_key)}delayedSuggestResume(e){setTimeout((()=>this.suggestResume()),e)}terminateTransferWhenLogin(){this.service.clean(),this.clearNoMissingMessageEventsTimeout(),this.logger.zsymb(0,"GQDCcG","cleaning for terminate transfer when login")}prepareSearchAfterSync(){const e=ll.a.getInstance();e.resumeIdx(),setTimeout((()=>{e.isEnableSearchSqlite&&a.ModuleContainer.resolve(hl.b).loadOldestTime()}),500)}onTerminateTransferWhenLoginSuccess(){this.isSyncRunning=!1,this.metricts.terminateTransferWhenLogin()}onSyncSuccess(){this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Kg.g)}onSyncFailed(){const e=this.ui.getCurrentError();e&&this.metricts.onSyncFailed(e),this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Kg.f)}onSyncCanceled(){this.isSyncRunning=!1,this.dispatchEvent(new Kg.f),this.prepareSearchAfterSync()}onNetworkError(){this.dispatchEvent(new Kg.f)}async restartSync(){this.metricts.resetSyncStartTime(),this.machine.send("RESTART_SYNC")}get tempKeySource(){return this.storage.tempKeySource.get()}set tempKeySource(e){this.storage.tempKeySource.save(e)}makeMobileActive(){this.ui.showWaitForBackup()}makeMobileIdle(){this.ui.showMobileIdleInBackup()}currentSyncSource(){return this.storage.syncSource.get()}getCurrentSyncScreenState(){return this.ui.getCurrentScreen()}async checkSuggestWhenReady(){this.logger.zsymb(0,"e79NnO","checking for sync suggestion"),this.setting.value().dontSuggest?this.logger.zsymb(0,"Q-Gl6I","user don't want to suggest sync"):await this.checkForSuggestFirstLogin().catch((e=>(this.logger.zsymb(18,"eZ6HvX",(()=>["checkForSuggestFirstLogin failed",e])),!1)))||await this.checkLastStateForSuggestResumeOrNewSync().catch((e=>(this.logger.zsymb(18,"Ev3usp",(()=>["checkLastStateForSuggestResumeOrNewSync failed",e])),!1)))||await this.checkPendingRequestSync().catch((e=>(this.logger.zsymb(18,"y0xVXW",(()=>["checkPendingRequestSync failed",e])),!1)))||await this.checkStateForSuggestSyncFromOtherEntries().catch((e=>(this.logger.zsymb(18,"WDcbHu",(()=>["checkStateForSuggestSyncFromOtherEntries failed",e])),!1)))||this.logger.zsymb(3,"5x_cWh",["no sync suggestion","wbe_Jz"])}async checkForSuggestFirstLogin(){const e=n.default.getInstance();let t=e.getItem("z_needSyncMsg");if(t&&JSON.parse(t)){if(e.removeItem("z_needSyncMsg"),this.isEnableBySrc(Dg.j.FIRST_TIME_LOGIN)&&!_m.k.GetManager().isEnabledFeature())return this.delayedSuggestSync(Dg.j.FIRST_TIME_LOGIN),!0;this.logger.zsymb(0,"oo7Rzc","first login sync is disabled")}return!1}showSharedWorker(){$zsharedWorker.show()}async checkPendingRequestSync(){if(!this.initialized)return this.logger.zsymb(18,"Hjah8v","check pending request sync but not ready"),!1;if(this.requestedSuggestSync){const e=this.requestedSuggestSync;if(this.requestedSuggestSync=null,this.isEnableBySrc(e))return this.delayedSuggestSync(e),!0;this.logger.zsymb(0,"zi1S2k",`${e} sync is disabled`)}return!1}async checkLastStateForSuggestResumeOrNewSync(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(Im.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"nfSC07","resume sync is disabled"),this.storage.clear()),!0;const e=this.storage.syncSource.get();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?this.delayedSuggestSync(e,!1,!0):(this.logger.zsymb(0,"S6X2LM",`${e} sync is disabled`),this.storage.clear()),!0)}async checkStateForSuggestSyncFromOtherEntries(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(Im.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"mt3Gkr","resume sync is disabled"),this.storage.clear()),!0;const e=this.entriesTransferManager.getSyncSource();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?(this.logger.zsymb(0,"I0D2tJ","Suggest sync with cached entry transfer before"),this.delayedSuggestSync(e,!1)):(this.logger.zsymb(0,"675bdp",`${e} sync is disabled`),this.storage.clear()),!0)}})||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm)||fm);var Em=s("3jnX"),Om=s("nhJq");class Mm{constructor(e,t,s){this.hostName=void 0,this.key=void 0,this.keyDecryptor=void 0,this.folderBackupName=void 0,this.hostName=e,this.key=t,this.keyDecryptor=s,this.folderBackupName=this.createFolderBackupName()}get publicKey(){return this.key.publicKey}get sessionFolderBackupName(){return this.folderBackupName}createFolderBackupName(){return`blob_${Object(Fg.b)()}`}isSame(e){return this.hostName===e.hostName&&this.key===e.key}decryptKey(e,t){return this.keyDecryptor(e,t,this.key)}static create(e,t){return new Mm(e,t.generate(),t.decryptKey.bind(t))}}class Tm extends Em.b{constructor(e){super({type:"DECRYPT_BACKUP",params:e})}}class wm extends Em.b{constructor(e,t){super({type:"RESTORE_MESSAGES",params:e,checkpoint:t}),this.handleEventBusMessage=(e,t)=>{if("SELECT_CONVERSATION"===e){const e=t.userId;this.params.meta.viewingConversation!==e&&this.changeParams({meta:Object(I.a)(Object(I.a)({},this.params.meta),{},{viewingConversation:e})})}}}run(){return this.startListenEventBus(),this.addEventListenerOnce(Em.c.Finalized,(()=>{this.stopListenEventBus()})),super.run()}startListenEventBus(){this.stopListenEventBus(),_e.default.subscribe(this.handleEventBusMessage)}stopListenEventBus(){_e.default.unsubscribe(this.handleEventBusMessage)}}class Rm extends Em.b{constructor(e){super({type:"RESTORE_CONVERSATIONS",params:e})}}var Lm,Dm=s("qUG6"),Am=s("1erv");const Fm=$znode.path;Object(a.injectable)()(Lm=Object(a.singleton)(xg)(Lm=Object(As.f)()(Lm=Object(As.e)()(Lm=function(e,t){return Object(a.inject)(Zg)(e,void 0,0)}(Lm=function(e,t){return Object(a.inject)(qg.a)(e,void 0,1)}(Lm=function(e,t){return Object(a.inject)(sm.b)(e,void 0,2)}(Lm=function(e,t){return Object(a.inject)(Pg)(e,void 0,3)}(Lm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,4)}(Lm=function(e,t){return Object(a.inject)(im)(e,void 0,5)}(Lm=function(e,t){return Object(a.inject)(am.a)(e,void 0,6)}(Lm=Reflect.metadata("design:type",Function)(Lm=Reflect.metadata("design:paramtypes",[void 0===Zg?Object:Zg,void 0===qg.a?Object:qg.a,void 0===sm.b?Object:sm.b,void 0===Pg?Object:Pg,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===im?Object:im,Object])(Lm=class{constructor(e,t,s,a,i,n,r){this.session=void 0,this.hostName=void 0,this.keyGenerator=void 0,this.storage=void 0,this.setting=void 0,this.ui=void 0,this.logger=void 0,this._currentTask=null,this.metricts=void 0,this.messageReadinessChecker=void 0,this.logger=i.createZLogger(R.ZLoggerNametags.msgSync,[R.ZLoggerNametags.service]),this.storage=e,this.setting=t,this.ui=s,this.keyGenerator=a,this.hostName=$znode.os.hostname(),this.session=null,this.metricts=n,this.messageReadinessChecker=r}get currentSession(){return this.session||(this.session=this.newSession()),this.session}get queueIndexSearch(){return!1}onSessionExpired(){this.logger.zsymb(0,"TcqobM","onSessionExpired"),this.session&&this.cancelTransferMobile(),this.cleanUrgent(!0)}onDispose(){this.logger.zsymb(0,"1zjaDQ","onDispose"),Me.g.isRememberMe()||this.cleanUrgent()}isNoMissingMessageEventsArrived(){return this.messageReadinessChecker.isNoMissingMessageEventsArrived()}isAtLeastOneMissingMessageEventArrived(){return this.messageReadinessChecker.isAtLeastOneMissingMessageEventArrived()}shouldTransferWhenLogin(){let e=n.default.getInstance().getItem("z_needSyncMsg");const t=this.storage.syncState.isStarted,s="number"==typeof this.storage.syncSource.get(),a=this.messageReadinessChecker.isMessageReady(),i=e&&JSON.parse(e)||t||s||!a;return this.logger.zsymb(0,"jBE-lQ",`shouldTransfer: ${i}, isMessageReady: ${a}, needSync: ${e}, isStarted: ${t}, syncSrc : ${this.storage.syncSource.get()}`),i}async prepareNewSync(){var e;await this.abortRestore(),null!==(e=Ce.default.cross_setting)&&void 0!==e&&e.enable_break_folder_db_as_session||await this.cleanupTempFiles(),this.session=null,this.storage.syncState.reset();const t=this.setting.value();this.storage.syncState.resetCheckpoint(0,t.minSeq,t.maxSeq)}request(e=0,t=0,s=""){this.messageReadinessChecker.isDBCorruptedThatNeedToTransferFull()&&(this.setting.resetMinMaxSeq(),this.logger.zsymb(9,"kjV_Ms",["DB corrupt detected, transfer full message","FMSU06"]));const a=this.currentSession.publicKey,i=this.setting.value(),n=i.maxSeq,r=i.minSeq,o=ro.a.newReq();return this.logger.zsymb(0,"Y81_hf",(()=>["sent request backup",{id:o,max:n,min:r,retry:e,resend:t,key:a}])),Jr.default.pullMobileMsg(a,n,o,t,r,s).then(Xr.a).catch((s=>{throw this.logger.zsymb(0,"qBEL9O",(()=>["failed to send request backup",{id:o,max:n,min:r,retry:e,resend:t,error:s}])),e>0&&(this.session=null),s}))}async clean(){this.logger.zsymb(0,"NWc65y","abort current task"),await this.abortRestore(),this.logger.zsymb(0,"kgTCwN","clean storage"),await this.cleanupTempFiles(),this.storage.clear(),this.logger.zsymb(0,"NFC34S","clean session"),this.session=null,this.logger.zsymb(0,"JCdM6H","cleanup done")}async download(e=0){this.logger.zsymb(0,"k1cxil",(()=>["downloading backup",{retry:e}]));const t=this.storage.backup.get();if(!t)return this.metricts.onDownloadBackupFailure(Dg.g.SELF_DEFINE,Dg.b.BACKUP_NOT_FOUND),Promise.reject("No backup found");await tt.default.run({type:tt.default.constants.DownloadType.File,data:{fileName:t.name,url:t.url,checksum:t.checksum},options:{saveDir:await this.getBackupDirFolderPath(),caching:!0,duplicate:!1,srcAction:tt.default.constants.srcAction.Dev,showProgress:{taskBar:!1,progressBar:!0,progressChannel:"UPDATE_CHANNEL_CROSS_DB",progressChannelId:t.checksum},onProgress:(e=>{e>0&&this.ui.setProgress(e)}).bind(this),noiseDownload:!1,timeOut:1e4,cookies:!0,preventTransform:!0}}),this.ui.setProgress(100);const s=Fm.join(await this.getBackupDirFolderPath(),t.name);t.inputPath=s,this.storage.backup.save(t)}async decrypt(){const e=this.storage.backup.get();if(!e)return Promise.reject("no backup found");if(0===e.numberOfMessagesCount)return;const t=e.format?"hex":"base64",s=e.encryptedKey,i=this.currentSession.decryptKey(s,t),n=await this.getBackupFolderPath(e);e.outputPath=n,e.sessionOutputFolder=this.currentSession.sessionFolderBackupName,e.privateKey=i,this.storage.backup.save(e);const r=new Tm({inputPath:e.inputPath,outputPath:e.outputPath,privateKey:e.privateKey,format:1===e.format?1:0,numberOfConversationsCount:e.numberOfConversationsCount});(async()=>{let e=0,t=setInterval((()=>{e+=5,this.ui.getCurrentScreen()===sm.a.DecryptingBackup?this.ui.setProgress(e):clearInterval(t),100===e&&clearInterval(t)}),2e3)})(),this._currentTask=r,await a.ModuleContainer.resolve(xc.b).waitMigrateRelease(),a.ModuleContainer.resolveToken(pm).isMachineIdle()?this.logger.zsymb(0,"DRn-5K","Skip decrypt, transfer flow is aborded!"):await r.run()}async restore(e){ll.a.getInstance().pauseIdx(),this.logger.zsymb(0,"I-v1fv",(()=>["restoring backup",{retry:e}]));const t=this.storage.backup.get();if(!t||0===t.numberOfMessagesCount)return void this.ui.setNumOfSyncedConv(0);const s=this.storage.syncState.step;s<=$g.RESTORE_CONVERSATIONS&&(this.storage.syncState.isSyncing=!0,await this._restoreConversations().catch((e=>{throw this.logger.zsymb(18,"mA3TAZ",(()=>["restore conversations failed",{error:e}])),this.metricts.onRestoreDataFailure(Dg.i.RESTORE_CONV_ERR),e})),this.storage.syncState.nextStep());let a={trackInfo:{}};if(s<=$g.RESTORE_MESSAGES&&(a=await this.restoreMessages().catch((e=>{throw this.logger.zsymb(18,"xSVXD_",(()=>["restore messages failed",{error:e}])),this.metricts.onRestoreDataFailure(Dg.i.RESTORE_MSGS_ERR),e})),this.storage.syncState.nextStep()),s<=$g.UPDATE_MESSAGES_CACHE){const e=this.setting.value().lastSync,s=e?(Date.now()-e)/864e5:-1;return this.setting.setLastSync(Date.now()),this.metricts.onRestoreDataSuccess(),void this.metricts.onSyncSuccess(t.format,this.storage.syncState.checkpoint.importedMessages,t.numberOfMessagesCount,a.trackInfo,Number(s.toFixed(2)))}throw new Error("unknown step")}async getBackupDirRootFolderPath(){const e=await Object(Ni.getuserDataDir)();return Fm.join(e,"blob")}async getBackupDirSessionFolderPath(e){const t=e||this.currentSession.sessionFolderBackupName;return Fm.join(await this.getBackupDirRootFolderPath(),t)}async getBackupDirFolderPath(e){return Ce.default.cross_setting.enable_break_folder_db_as_session?await this.getBackupDirSessionFolderPath(e):await this.getBackupDirRootFolderPath()}async getBackupFolderPath(e){return Fm.join(await this.getBackupDirFolderPath(e.sessionOutputFolder),e.name+"_tmp")}async restoreMessages(){this.logger.zsymb(0,"MtgfW8","restore messages");const e=this.storage.backup.get(),t=a.ModuleContainer.resolve(jo.SidebarController),s=new wm({backupPath:e.outputPath,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,format:e.format,conversations:e.conversations,shouldUseNewMediaDBFlowConfig:Object(Am.a)(),meta:{queueIndexSearch:this.queueIndexSearch,viewingConversation:t.getSelectedId(),cachedRanges:{},numberOfMessages:e.numberOfMessagesCount,numberOfConversations:e.numberOfConversationsCount}},this.storage.syncState.checkpoint);if(s.addEventListener(Em.c.Progress,(e=>{e.progress>0&&this.ui.setProgress(e.progress);const t=e.checkpoint;t&&(this.storage.syncState.checkpoint=t)})),s.addEventListenerOnce(Em.c.Completed,(()=>{if(0==e.format)this.ui.setNumOfSyncedConv(e.numberOfConversationsCount);else{const t=e.numberOfConversationsCount,s=this.storage.syncState.checkpoint.updatedConversation;this.ui.setNumOfSyncedConv(s),this.logger.zsymb(0,"R6wWxR","completed sync",s,t)}this.setting.setMinSeq(this.storage.syncState.checkpoint.minSeq),this.setting.setMaxSeq(this.storage.syncState.checkpoint.maxSeq)})),this._currentTask=s,await a.ModuleContainer.resolve(xc.b).waitMigrateRelease(),!a.ModuleContainer.resolveToken(pm).isMachineIdle())return s.run();this.logger.zsymb(0,"ENjpB1","Skip restore message, transfer flow is aborded!")}async _restoreConversations(){this.logger.zsymb(0,"cuDfAA","restore conversations");let e=this.storage.backup.get();const t=new Rm({backupPath:e.outputPath,format:e.format,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,shouldUseNewMediaDBFlowConfig:Object(Am.a)(),meta:{queueIndexSearch:this.queueIndexSearch}});if(this._currentTask=t,await a.ModuleContainer.resolve(xc.b).waitMigrateRelease(),a.ModuleContainer.resolveToken(pm).isMachineIdle())return void this.logger.zsymb(0,"gHiy2E","Skip restore conversation, transfer flow is aborded!");const s=await t.run(),i=(await this._validateConversations(s)).filter((e=>!e.shouldIgnore)),n=i.filter((e=>!e.isExist)),r=i.filter((e=>!!e.lastMessage));if(n.length>0&&await this._createNewImportConversations(n).catch((e=>{this.logger.zsymb(18,"PF44xA",(()=>["create new import conversations failed. but continue",{error:e}]))})),r.length>0){const e=r.map((e=>e.lastMessage));this._updatePreviewOfConversations(e)}e=this.storage.backup.save(Object(I.a)(Object(I.a)({},e),{},{conversations:i.map((e=>({plainId:e.plainId,noiseId:e.noiseId,isGroup:e.isGroup,hasPreviewMsg:!!e.lastMessage,shouldIgnore:e.shouldIgnore})))}));const o=this.storage.syncState.checkpoint;if(1===o.format){const e=Object(I.a)({},o);let t=i.filter((e=>!!e.lastMessage)).sort(((e,t)=>t.lastMessage.localDttm-e.lastMessage.localDttm)).map((e=>e.plainId));t=t.concat(i.filter((e=>!e.lastMessage)).map((e=>e.plainId))),e.priorities=t,e.currentSeq={},this.storage.syncState.checkpoint=e}}_updatePreviewOfConversations(e){new Dm.a(e).run()}async _createNewImportConversations(e){const t=a.ModuleContainer.resolve(En.ConvInfoDataManager);await Promise.all(e.map((e=>{var s,a;t.addIfNotExistsConv(e.noiseId,e.isGroup,null===(s=e.lastMessage)||void 0===s?void 0:s.msgId,null===(a=e.lastMessage)||void 0===a?void 0:a.msgId,$r.default.isMyMessage(e.lastMessage),1)})))}async _validateConversations(e){const t=[],s=[];for(const o of e)o.isGroup?s.push(o.noisedId):t.push(o.noisedId);const[a,i]=await Promise.all([Ii.default.getProfileFriendByIds(t).catch((e=>(this.logger.zsymb(18,"ZJAgak",(()=>["validate friend error",{error:e}])),{}))),hn.default.getGroupsByIds(s).catch((e=>(this.logger.zsymb(18,"3YrkBo",(()=>["validate group error",{error:e}])),{})))]),n=e.map((e=>({plainId:e.plainId,noiseId:e.noisedId,isExist:!!me.a.ConvInfoDataManager.getConvByIdSync(e.noisedId),isGroup:e.isGroup,hasPreview:!!e.lastMessage,lastMessage:e.lastMessage,shouldIgnore:!a[e.noisedId]&&!i[e.noisedId]}))),r=n.filter((e=>!e.shouldIgnore)).length;return this.logger.zsymb(0,"1Z44bu",(()=>["validate conversations done",{total:e.length,valid:r}])),n}async cleanUrgent(e){this.abortRestore(),this.logger.zsymb(0,"aIj6PQ","abort restore"),this.storage.clear(e),this.logger.zsymb(0,"w6BZUp","clean storage"),this.session=null,this.logger.zsymb(0,"t3S9S4","clean session"),$zdb.abortSyncMsg({reason:"session-expired",path:await this.getBackupDirRootFolderPath()})}cancelTransferMobile(){const e=this.currentSession.publicKey,t=ro.a.newReq();this.logger.zsymb(0,"dzP-lJ",(()=>["cancel request backup",{id:t,key:e}])),Jr.default.cancelTransferMessage(t,e).then(Xr.a).then((e=>{this.logger.zsymb(0,"KmEqou",(()=>["success to cancel request backup",{id:t,res:e}]))})).catch((s=>{throw this.logger.zsymb(0,"cBUM_B",(()=>["failed to cancel request backup",{id:t,key:e,error:s}])),s}))}async abortRestore(){this._currentTask&&await this._currentTask.abort(),this._currentTask=null}getRequestBackupTimeout(e){if(e)return 1e3*Ce.default.cross_setting.waitDbTimeout;const t=1e3*Ce.default.cross_setting.cfTimeout;return Math.max(0,t-(Date.now()-this.ui.getStartSyncTime()))}getMobileTransferConfirmTimeout(){let e=Im.a.transfer_when_login.mobile_transfer_confirm_timeout;const t=Ce.default.transfer_when_login.mobile_transfer_confirm_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getNoMissingMessageEventsTimeout(){let e=Im.a.transfer_when_login.no_missing_message_events_timeout;const t=Ce.default.transfer_when_login.no_missing_message_events_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getEnabledDropTransferWhenLoginFlowConfig(){let e=Im.a.transfer_when_login.enable_drop_flow;const t=Ce.default.transfer_when_login.enable_drop_flow;return"boolean"==typeof t&&(e=t),e}getSuccessBannerWhenDropTransferWhenLoginConfig(){let e=Im.a.transfer_when_login.success_banner_when_drop;const t=Ce.default.transfer_when_login.success_banner_when_drop;return"boolean"==typeof t&&(e=t),e}getEnableLogEventsArrivalTimeConfig(){let e=Im.a.transfer_when_login.enable_log_events_arrival_time;const t=Ce.default.transfer_when_login.enable_log_events_arrival_time;return"boolean"==typeof t&&(e=t),e}getEventsArrivalTimeSubmitLogTimeout(){return Im.a.transfer_when_login.timeout_submit_events_arrival_time_log}getCloseSuccessTimeout(){return 1e3*Ce.default.cross_setting.closeSuccessTimeout||1e4}async cleanupTempFiles(){this.logger.zsymb(0,"s7N-jB","remove temp files"),await Om.b(await this.getBackupDirRootFolderPath()).catch((e=>{this.logger.zsymb(18,"lAZkoP",(()=>["remove temp failed",{err:e}]))}))}newSession(){return Mm.create(this.hostName,this.keyGenerator)}getHardcodeError(e){return 0}})||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm);var km,Nm;const Pm=new Map;Object(m.j)()(km=Object(a.injectable)()(km=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(km=Reflect.metadata("design:type",Function)(km=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(km=class extends Em.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("sync-message",["noise-id-handler"])}async execute({params:e}){const t=e.uids.length+e.gids.length;return 0===t?[]:t>1e4?Promise.all([this.getNoiseIdFromServer(e.uids,[]),this.getNoiseIdFromServer([],e.gids)]).then((([e,t])=>[...e,...t])):this.getNoiseIdFromServer(e.uids,e.gids)}async getNoiseIdFromServer(e,t){let s=e.map((e=>Number.parseInt(e))),a=t.map((e=>Number.parseInt(e)));const i=await Jr.default.getnuid(s,a).then(Xr.a).catch((s=>{this.logger.zsymb(18,"EufC56",(()=>["get noise id from server error",s]));const a=s.code||s.error_code;if(a===Y.NetWorkError.NO_NETWORK||-69===a)throw ul.default.increaseFailed(Dg.f.REQ_NOISE_ID,0,0,Dg.d.NO_NET_OR_TOO_MUCH_REQ,Date.now()),s;return this.logger.zsymb(0,"q8Hbps",(()=>["return empty result for ids:",{uids:e,gids:t}])),ul.default.increaseFailed(Dg.f.REQ_NOISE_ID,0,0,s.error_code,Date.now()),{fids:[],gids:[]}}));if(s.length>0&&s.length!==i.fids.length)throw this.logger.zsymb(18,"TeyJ9K",`data mismatch: uids: ${s.length}, fids: ${i.fids.length}`),ul.default.increaseFailed(Dg.f.REQ_NOISE_ID,0,0,Dg.d.U_MIS_MATCH,Date.now()),new Error("data mismatch reason:uids");if(a.length>0&&a.length!==i.gids.length)throw this.logger.zsymb(18,"cGI50z",`data mismatch: gids: ${a.length}, gids: ${i.gids.length}`),ul.default.increaseFailed(Dg.f.REQ_NOISE_ID,0,0,Dg.d.G_MIS_MATCH,Date.now()),new Error("data mismatch reason:gids");let n=[];return i.gids&&i.gids.forEach(((e,s)=>{e=e.startsWith("g")?e:`g${e}`,n.push([t[s],e]),Pm.set(t[s],e)})),i.fids&&i.fids.forEach(((t,s)=>{const a=`g${t}`;hn.default.getGroupByIdSync(a)?(n.push([e[s],a]),Pm.set(e[s],a)):(n.push([e[s],t]),Pm.set(e[s],t))})),n}getType(){return"REQUEST_NOISE_ID"}getHardcodeError(e){return 0}})||km)||km)||km)||km),Object(m.j)()(Nm=Object(a.injectable)()(Nm=class extends Em.a{async execute(){return Array.from(Pm.entries())}getType(){return"REQUEST_ALL_NOISE_ID"}})||Nm);var jm;Object(m.j)()(jm=Object(a.injectable)()(jm=class extends Em.a{async execute({params:e}){const t=a.ModuleContainer.resolve(En.PreviewDataManager);await t.onReceiveNewMessages("sync-db",e)}getType(){return"UPDATE_CONVERSATION_PREVIEW"}})||jm);var Um;Object(m.j)()(Um=Object(a.injectable)()(Um=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Um=Reflect.metadata("design:type",Function)(Um=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Um=class extends Em.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("feat",["sync-message","reload-msg-handler"])}async execute({params:e}){if(!zr.b.messageCache)return;zr.b.messageCache.deleteConversation(e.convId);const t=Gr.a.getExistConvIds();this.logger.zsymb(0,"XGV2AU",`ReloadMessagehandle ${t.includes(e.convId)} ${e.convId}`),t.includes(e.convId)&&xr.a.getLastMessagesForConversation(e.convId,{})}getType(){return"RELOAD_MESSAGE"}})||Um)||Um)||Um)||Um);var Bm,zm=s("1KLq"),Gm=s("nuPU");Object(m.j)()(Bm=Object(a.injectable)()(Bm=function(e,t){return Object(a.inject)(zm.b)(e,void 0,0)}(Bm=Reflect.metadata("design:type",Function)(Bm=Reflect.metadata("design:paramtypes",[void 0===zm.IMediaEventEmitter?Object:zm.IMediaEventEmitter])(Bm=class extends Em.a{constructor(e){super(),this._mediaEventEmitter=void 0,this._mediaEventEmitter=e}async execute({params:e}){this._mediaEventEmitter.emit(Gm.a.RELOAD_MEDIA_OF_CONV,e)}getType(){return"RELOAD_MEDIA"}})||Bm)||Bm)||Bm)||Bm);var xm=s("Erqw");const{setTimeoutUnlimited:Vm,clearTimeoutUnlimited:Hm}=function(e={}){var t,s;const a=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,i=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:(e,t,...s)=>{const n=(e=>{var t;const s=e.step,a=e.registry;let i=null!==(t=e.timeout)&&void 0!==t?t:0;const n=e.callback,r=e.args,o=performance.now()+i;let l;function c(){let e=Math.min(o-performance.now(),s);return performance.now()>o?a[l]=setTimeout(n,0,r):a[l]=setTimeout(c,e),a[l]}return function(){let e=Math.min(o-performance.now(),s);return l=setTimeout(c,e),a[l]=l,l}()})({step:a,registry:i,callback:e,timeout:t,args:s});return n},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:i})}}}({registry:{}});var Wm,qm=s("1p+n"),Km=s("UYft"),$m=s("AULX");Object(a.injectable)()(Wm=Object(a.singleton)($m.a)(Wm=Object(m.h)()(Wm=Object(m.f)()(Wm=function(e,t){return Object(a.inject)(o)(e,void 0,0)}(Wm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(Wm=Reflect.metadata("design:type",Function)(Wm=Reflect.metadata("design:paramtypes",[void 0===r?Object:r,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Wm=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new qm.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!Ce.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",Ce.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-Ct.default.getTimeNow(),a=Vm((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{Hm(a),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!Ce.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",Ce.default.groupLink.enableCache]);e=Zm(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(xm.a.isOverflowAtTime(s.ts))return!1;const a=Ct.default.getTimeNow();if(s.ts+Ce.default.groupLink.maxCacheDuration<a)return!1;if(t.enabled&&t.expirationDate<a)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=Ct.default.getTimeNow(),a=await t(),i={enabled:a.enabled,expirationDate:a.expiration_date,link:a.link};let n={ts:s};return await this._cache.setItem(e,{data:i,meta:n}),i}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t=!1){this._logger.zsymb(12,"gGJVy3",["getting",e]);let s=Zm(e),a=await this._getFromCache(s);if(a&&!t)return this._logger.zsymb(12,"oS6k8F",["cache hit",s]),this._scheduleRenew(s,a),a;this._logger.zsymb(12,"f-zdsd",["fetching",s]);let i=ui.default.getRawGroupId(s);let n=await this._fetchAndPutToCache(s,(()=>Cl.default.getGroupLinkDetail(i))).catch(Km.a.catch((e=>this._logger.zsymb(18,"C7DAhO",["get failed",s,e]))));return this._scheduleRenew(s,n),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,"Zmqdcl",["done",s]),n}async renewGroupLink(e){this._logger.zsymb(12,"SaE0wK",["renewing",e]);let t=Zm(e),s=ui.default.getRawGroupId(t);let a=await this._fetchAndPutToCache(t,(()=>Cl.default.renewGroupLink(s))).catch(Km.a.catch((e=>this._logger.zsymb(18,"RWsLOj",["renew failed",t,e]))));return this._scheduleRenew(t,a),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,"_b8bRW",["renew done",e]),a}async disableGroupLink(e){this._logger.zsymb(12,"C4hKtE",["disabling",e]);let t=Zm(e),s=ui.default.getRawGroupId(t);await Cl.default.disableGroupLink(s).catch(Km.a.catch((e=>this._logger.zsymb(18,"12VRuB",["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,"niaeSn",["disable done",e])}async _emitGroupLinkUpdated(e,t=!1){const s=Zm(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||Wm)||Wm)||Wm)||Wm)||Wm)||Wm)||Wm);function Zm(e){return Y.GROUPID_PREFIX+ui.default.getRawGroupId(e)}var Qm,Ym=s("TO4U");const Jm={loading:!0};Object(Ai.b)(Ym.a)(Qm=function(e,t){return Object(a.inject)($m.a)(e,void 0,0)}(Qm=Reflect.metadata("design:type",Function)(Qm=Reflect.metadata("design:paramtypes",[void 0===$m.a?Object:$m.a])(Qm=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new u.default({maxSize:50}),this._handleUpdate=e=>{const t=Xm(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(Y.GROUPID_PREFIX))return;const s=Xm(e.key);this._startFetchAndSetToSession(s);let a=this._cache.get(s);return a||Jm}static shouldSignal(e,t){var s,a,i,n,r,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(a=t.data)||void 0===a||a.enabled,null!=e&&null!==(i=e.data)&&void 0!==i&&i.enabled&&null!=t&&null!==(n=t.data)&&void 0!==n&&n.enabled&&(null==e||null===(r=e.data)||void 0===r||r.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,a){e.shouldSignal(s,a)&&Object(Po.h)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const a={loading:!1,data:s};this._cache.set(e,a),this.signalIfNeeded(e,t,a)})).catch((s=>{const a={loading:!1,error:s};this._cache.set(e,a),this.signalIfNeeded(e,t,a)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Qm)||Qm)||Qm);function Xm(e){return Y.GROUPID_PREFIX+ui.default.getRawGroupId(e)}var ep=s("oOjv"),tp=s("bB26"),sp=s("lteq");const ap={[hr.c]:{}};a.ModuleContainer.registerSingleton(ep.b,class{constructor(){this.state=ap,this.animationControllers=new Map,this._manuallyOff=!1,this.name=ep.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&Ce.default.preview_msg_time.enable,this.state=ap}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new tp.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=sp.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),pl.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const a=this.getAnimController(e);null==a||a.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const a=this.getAnimController(e);null==a||a.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});var ip=s("px+z"),np=s("AqnK"),rp=s("X2DH"),op=s("3Rxw"),lp=s("V2fg"),cp=s("RUx3"),dp=s("DhYn"),up=s("Bvld"),hp=s("bavj"),gp=s("KgJV");var mp,pp=s("QmNg"),fp=s("ACSi");let vp=Object(a.injectable)()(mp=class{constructor(){this.MAX_REGEN_TASKS=10,this.MAX_MEMORY_USAGE=52428800,this.MetadataCache=new u.default({maxSize:100,maxAge:3e5}),this.requests=[],this.availableTask=this.MAX_REGEN_TASKS,this.totalMemoryUsage=0,this.regenImageFromLocal=async e=>{const{getSourcePath:t,getGenThumbPath:s}=e;Object(ua.a)(!!t,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!s,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const a=await t(),i=await this.checkSize(a);await this.acquireTaskLock(i);let n=np.n.oriUrl,r="";try{var o;let t={type:"",width:e.sizes.originalWidth,height:e.sizes.originalHeight,size:0};if(void 0!==this.MetadataCache.peek(a))t=this.MetadataCache.get(a);else{const s=$znode.path.extname(a);if(Object(fp.c)(e.sizes.originalWidth)&&Object(fp.c)(e.sizes.originalHeight)&&s)t.size=i,t.type=s.replace(".","");else{const s=await $zFileManager.getFileArrayBuffer(a);t=await Object(gp.a)(s),t.size=i,e.sizes.originalWidth=t.width,e.sizes.originalHeight=t.height}this.MetadataCache.set(a,t)}lp.b.log(null===(o=e.log)||void 0===o?void 0:o.clientId,{msgFormat:`image/${t.type}`,originalSize:i,originalWidth:t.width,originalHeight:t.height}),n=function(e,t,s=Ce.default.image_loader.max_original){const a=Ce.default.image_loader.max_original,i=Ce.default.image_loader.max_hd,n=Ce.default.image_loader.max_normal,r=Ce.default.image_loader.max_thumb,o=[{quality:np.n.oriUrl,min:i,max:a},{quality:np.n.hdUrl,min:n,max:i},{quality:np.n.normalUrl,min:r,max:n},{quality:np.n.thumbUrl,min:1,max:r}].sort(((e,t)=>t.max-e.max)),[l,c]=Object(hp.d)(e,t,s,s,!1);let d=np.n.oriUrl;for(let u of o){const[e,t,s]=Object(hp.d)(l,c,u.max,u.max,!1);if(s)break;d=u.quality}return d}(t.width,t.height,e.sizes.maxDimension),r=await s();const l=new pp.c(r);l.q=n,r=l.getGenPath();if(r&&Object(ki.a)(r)){if(Object(fp.b)(e.getOldLocalPathForMigration)){let t=await(null==e?void 0:e.getOldLocalPathForMigration());t=t?this._toJpeg(t):t,t&&Object(ki.a)(t)&&(zconsole.zsymb(3,"73QOlY",["MediaDiskFetcher: delete existed old. no regen","zi5Mp1"],t,"->",r),await this._deleteLocalSource(t))}return np.l.Success({mediaURL:r})}if(Object(fp.b)(e.getOldLocalPathForMigration)){let t=await e.getOldLocalPathForMigration();t=t?this._toJpeg(t):t,t&&Object(ki.a)(t)&&(zconsole.zsymb(3,"NzeIFE",["MediaDiskFetcher: delete existed old. regen","ZIa5zi"],t,"->",r),await this._deleteLocalSource(t))}const[d,u,h]=Object(hp.d)(t.width,t.height,e.sizes.maxDimension,e.sizes.maxDimension,!1);if(!h&&"jxl"!==t.type)return r=a,np.l.Success({mediaURL:a});const g=Object(I.a)(Object(I.a)({},e),{},{getGenThumbPath:()=>Promise.resolve(r),metadata:t,output:{width:d,height:u}});try{const e=await this.regenImageFromLocalUsingNativelibs(g);return ul.default.increaseSuccess(cp.a,0,0),ul.default.increaseSuccess(cp.c,0,0),e}catch(c){ul.default.increaseFailed(cp.a,0,0,Object(cp.k)(),Date.now())}try{const e=await this.regenImageFromUrlUsingNativeElectron(g);return ul.default.increaseSuccess(cp.c,0,0),e}catch(c){throw c}}catch(c){throw ul.default.increaseFailed(cp.c,0,0,Object(cp.i)(),Date.now()),c}finally{var l;const t=await this.checkSize(r),s=n===np.n.normalUrl,a=n===np.n.thumbUrl;lp.b.endLog(null===(l=e.log)||void 0===l?void 0:l.clientId,{regenStatus:1,localSize:t,hdSize:t,normalSize:s?t:void 0,thumbSize:a?t:void 0}),this.releaseTaskLock(i)}},this.regenImageFromLocalUsingNativelibs=async e=>{try{const{getSourcePath:r,getGenThumbPath:o,sizes:l={width:void 0,height:void 0},removeOriginalAfterGenerate:c=!1,priority:d=-1}=e;Object(ua.a)(!!r,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!o,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const u=await o();if($znode.fs.existsSync(u))return np.l.Success({mediaURL:u});const h=await r(),g="jxl"===e.metadata.type;try{if(dp.a.jxl.version===up.a.V2&&g){var t,s;zconsole.zsymb(14,"7qKDkL","JXL: regen jxl using native libs",e);const a="number"==typeof(null==e||null===(t=e.sizes)||void 0===t?void 0:t.maxDimension)?(null==e||null===(s=e.sizes)||void 0===s?void 0:s.maxDimension)+1:void 0;await Object(rp.b)(h,{tasks:[{width:e.sizes.originalWidth,height:e.sizes.originalHeight,outputPath:u,maxWidth:a,maxHeight:a}]},{priority:d})}else{const t=await $zFileManager.getFileArrayBuffer(h),s=new Blob([t]),a=await Object(op.a)(s,{width:e.output.width,priority:d,quality:.9}),i=$znode.path.dirname(u);await this.ensureDir(i),await $zFileManager.writeBufferToPath(u,await a.arrayBuffer())}}catch(i){var a;throw lp.b.endLog(null===(a=e.log)||void 0===a?void 0:a.clientId,{regenStatus:0}),i}if(c)try{$znode.fs.unlinkSync(h)}catch(n){}return np.l.Success({mediaURL:u})}catch(i){throw i}},this.regenImageFromUrlUsingNativeElectron=async e=>{try{const{getSourcePath:i,getGenThumbPath:n,removeOriginalAfterGenerate:r=!1}=e;Object(ua.a)(!!i,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!n,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const o=await n();if($znode.fs.existsSync(o))return np.l.Success({mediaURL:o});const l=await i();let c=null;try{const t=await $zFileManager.getFileArrayBuffer(l),s=new Blob([t]),a=await createImageBitmap(s);c=document.createElement("canvas"),c.width=e.output.width,c.height=e.output.height;const i=c.getContext("2d");null==i||i.drawImage(a,0,0,e.output.width,e.output.height);const n=await new Promise(((e,t)=>{c.toBlob((s=>{s?e(s):t(new Error("Failed to convert canvas to blob"))}),"image/jpeg",.9)})),r=$znode.path.dirname(o);await this.ensureDir(r),await $zFileManager.writeBufferToPath(o,await n.arrayBuffer())}catch(s){throw zconsole.error("[JXL]: regen erorr",s),s}finally{var t;const e=null===(t=c)||void 0===t?void 0:t.getContext("2d");e&&e.clearRect(0,0,c.width,c.height),c&&(c.width=0,c.height=0)}if(r)try{$znode.fs.unlinkSync(l)}catch(a){}return np.l.Success({mediaURL:o})}catch(s){throw s}},this.ensureDir=e=>new Promise(((t,s)=>{$znode.fsExtra.ensureDir(e,1533,(e=>{if(e)return s(e);t()}))})),this.createDeferred=(e=0)=>{let t,s;return{promise:new Promise(((e,a)=>{t=e,s=a})),resolve:t,reject:s,fileSize:e}},this.acquireTaskLock=async e=>{const t=this.createDeferred(e),s=this.availableTask<this.MAX_REGEN_TASKS;(this.availableTask<=0||this.totalMemoryUsage+e>this.MAX_MEMORY_USAGE&&s)&&(this.requests.push(t),await t.promise),this.totalMemoryUsage+=e,this.availableTask--},this.releaseTaskLock=e=>{if(this.availableTask=Math.min(this.MAX_REGEN_TASKS,this.availableTask+1),this.totalMemoryUsage=Math.max(0,this.totalMemoryUsage-e),this.availableTask>0&&this.requests.length>0){const e=this.requests[0],t=this.availableTask<this.MAX_REGEN_TASKS;if(e.fileSize+this.totalMemoryUsage<=this.MAX_MEMORY_USAGE||!t){this.requests.shift().resolve()}}},this.checkSize=e=>new Promise((t=>{$znode.fs.stat(e,((e,s)=>{if(e)t(0);else{const e=s.size;t(e)}}))})),this._deleteLocalSource=async e=>{if(e)try{await new Promise(((t,s)=>{$znode.fs.unlink(e,(a=>{a?(zconsole.zsymb(18,"I4BC2Z","MediaDiskFetcher: deleteLocalSource error",e,a),s(a)):t(!0)}))}))}catch(t){zconsole.zsymb(15,"MTUXMN",["MediaDiskFetcher: deleteLocalSource error","8SU_GB"],t)}else zconsole.zsymb(21,"_WhQuz",["MediaDiskFetcher: deleteLocalSource localPath cannot be null","dDfxv4"],e)},this._copySource=async(e,t,s=!0)=>{if(e&&t)try{const a=`${e}.tmp`;await new Promise(((t,s)=>{$znode.fsExtra.rename(e,a,(a=>{a?(zconsole.zsymb(18,"aES_hP","MediaDiskFetcher: migrateSource error",e,a),s(a)):t(!0)}))})),await $znode.fsExtra.copy(a,t,{dereference:!0,overwrite:!0}),s||await this._deleteLocalSource(a)}catch(a){zconsole.zsymb(15,"U3gnMK",["MediaDiskFetcher: migrateSource error","g_hYxO"],a)}else zconsole.zsymb(21,"Q4GQGO",["MediaDiskFetcher: migrateSource oldPath and newPath cannot be null","E7PqB-"],e,t)},this._toJpeg=(e,t="")=>{if(".jxl"===$znode.path.extname(e))return e.replace(/\.jxl$/,".jpg");if(t){const s=$znode.path.basename(e),a=$znode.path.dirname(e);return $znode.path.join(a,`${t}-${s}`)}return e}}})||mp;a.ModuleContainer.registerSingleton(ip.a,vp);var _p=s("tDXj");const bp=Object(a.define)("JIT_MEDIA_CODEC");var Ip;let yp=Object(a.injectable)()(Ip=class{constructor(){this._blobURLMapping=new Map,this._conversationCache=new Map}async preload(e,t,s){let a=e;if(this._isHttpURL(e))try{if(this._blobURLMapping.has(e))return np.l.Success({mediaURL:e});const t=Object(at.j)().toString(),s=await Object(at.h)(t,e,at.a.dev,void 0,{useDiskCache:!1});if(s.error)return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:s.error});a=s.data}catch(i){return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:i})}else if(this._isBlobURL(e)){if(this._blobURLMapping.has(e))return np.l.Success({mediaURL:e});if(!(await this.isBlobURLAlive(e)))return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:"blob url expired"})}return this._cache(a,t,s),np.l.Success({mediaURL:a})}async isBlobURLAlive(e,t){const s=null!=t&&t.document?t.document.createElement("img"):new Image;s.src=e;try{return await s.decode(),!0}catch(a){return!1}}async preloadImageDOM(e,t){let s=0,i=null,n=1,r=t&&"async"!==(null==t?void 0:t.mode)&&"auto"!==(null==t?void 0:t.mode)?"sync":"async";const o=e.src,l=null==o?void 0:o.endsWith("jxl"),c=!!dp.a.jxl.enable_native_electron_jxl||!Object(he.a)()&&dp.a.jxl.enable_native_electron_jxl;if(l&&!c)try{var d,u;const t=null===(d=e.rawSrc)||void 0===d||null===(u=d.replace("file://",""))||void 0===u?void 0:u.replace("zfile://",""),s=await a.ModuleContainer.resolve(bp).decodeLocalImage(t);if(!s)throw new Error("JXL decode failed. Empty url");e.src=s}catch(h){zconsole.zsymb(21,"gnxdZQ",["Failed to decode JXL image","6AOLKQ"],h)}if("async"===r){n=2;try{return await this._preloadImageAsync(e)}catch(h){s++,i=h}}try{return await this.preloadImageSync(e)}catch(h){s++,i=h}if(s===n)throw new Error(`preloadImageDOM failed ${i}`);return null}async _preloadImageAsync(e){try{const t=new Image;t.draggable=!1;for(const s in e)s&&e[s]&&t.setAttribute(s,e[s]);return await t.decode(),t}catch(t){throw t}}async preloadImageSync(e){const t=new Image;t.draggable=!1;for(const i in e)i&&e[i]&&t.setAttribute(i,e[i]);const s=new Promise(((e,s)=>{t.onload=e,t.onerror=s}));try{return await s,t}catch(a){throw a}}_cache(e,t,s){if(this._blobURLMapping.set(e,{blobURL:e,cacheMode:t,convId:s}),s){const t=this._conversationCache.get(s)||[];t.push(e),this._conversationCache.set(s,t)}}_isHttpURL(e){return e.startsWith("http")||e.startsWith("https")}_isBlobURL(e){return e.startsWith("blob")}})||Ip;a.ModuleContainer.registerSingleton(_p.a,yp);var Sp=s("UeuQ"),Cp=s("XDVU");function Ep(e){return e.startsWith("http")||e.startsWith("https")}function Op(e){return e.startsWith("blob")}var Mp=s("iD3V"),Tp=s("tqrY");var wp=s("Q8nW"),Rp=s("Ageb"),Lp=s("qvbK"),Dp=s("5+PA"),Ap=s("dog1"),Fp=s("6e5J");const kp=(e,t)=>{if(!t)return e;const s=new URL(e);return s.pathname=`${t}${s.pathname}`,s.search=decodeURIComponent(s.search),s.href},Np=new u.default({maxSize:300,maxAge:3e5}),Pp=3;async function jp(e,t={}){var s;if("boolean"==typeof(null===(s=Np.peek(e))||void 0===s?void 0:s.alive))return!0===Np.get(e).alive;const{retries:a=Pp,cacheResponse:i=!1,retryableErrorCodes:n=[]}=t,r=Object(Mp.a)((async e=>{try{return await ui.default.checkAlive(e),!0}catch(t){throw t}}),{min:5e5,max:1e3,retries:a,lastTryDelayTime:{min:5e3,max:1e4},shouldRetryOnError:async({error:e,currentState:t})=>(zconsole.debug((function(e){return e[0]})`checkAlive: should retry on error`,e,t),t.nTry!=Pp||Array.isArray(n)&&n.length>0&&n.some((t=>t===e))),afterRetry:async({success:e,nTry:t})=>{const s=t===Pp;zconsole.debug((function(e){return e[0]})`checkAlive: afterRetry`,{success:e,nTry:t,isLastTry:s})}});let o=!1;try{o=await r(e)}catch(l){zconsole.zsymb(18,"XCYQv2","checkAlive with cache caught error",l)}return i&&Np.set(e,{alive:o,contentLength:null,contentType:null}),o}class Up{constructor(){this.aborted=void 0,this.aborted=!0}}class Bp{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const a=()=>{this._aborted=!0,s(new Up),this._abortController.signal.removeEventListener("abort",a)};this._abortController.signal.addEventListener("abort",a),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",a),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}}function zp(e,...t){return new Bp(e,t)}class Gp{constructor(e,t){this.taskId=e,this.executor=t}}class xp{constructor(e,t){this.limit=void 0,this.runningTasks=void 0,this.taskQueue=void 0,this.taskMap=void 0,this.onTaskCompleted=void 0,this.isRunning=e=>this.runningTasks.has(e),this.abortTask=e=>{const t=this.taskMap.get(e);t&&(t.executor.abort(),this.removeTask(e))},this.limit=e,this.runningTasks=new Set,this.taskQueue=[],this.taskMap=new Map,this.onTaskCompleted=t||(()=>{})}addTask(e){this.runningTasks.has(e.taskId)||(this.taskMap.has(e.taskId)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e.taskId))),this.taskQueue.push(e),this.taskMap.set(e.taskId,e),this._tryToRunTasks())}removeTask(e){const t=this.taskMap.get(e);t&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e)),this.taskMap.delete(e)),this.runningTasks.has(e)&&(this.runningTasks.delete(e),t&&t.executor.abort())}_tryToRunTasks(){if(!(this.runningTasks.size>=this.limit))for(;this.runningTasks.size<this.limit&&this.taskQueue.length>0;){const e=this.taskQueue.pop();e&&this._runTask(e)}}_runTask(e){this.runningTasks.add(e.taskId),e.executor.promise.then((()=>{this._taskFinished(e.taskId)})).catch((()=>{this._taskFinished(e.taskId)}))}_taskFinished(e){this.removeTask(e),this._tryToRunTasks(),this.onTaskCompleted(e)}}var Vp;let Hp=Object(a.injectable)()(Vp=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Vp=Reflect.metadata("design:type",Function)(Vp=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Vp=class{constructor(e){this.Logger=void 0,this.BigFileTaskQueue=new xp(1),this.BIG_FILE_THRESHOLD=10485760,this.fetch=async e=>{const t=await(s=e.source,void 0!==Np.peek(s)?Promise.resolve(Np.get(s)):new Promise(((e,t)=>{const a=new XMLHttpRequest;let i=s.replace("http://","https://");i=ui.default.removeE2eeProtocol(i),a.open("HEAD",i),a.responseType="arraybuffer",a.timeout=5e3,a.onload=()=>{const t={contentType:a.getResponseHeader("Content-Type"),contentLength:ui.default.ZSafeFunction((()=>parseInt(a.getResponseHeader("Content-Length"))),null),alive:!(404===a.status||a.responseURL&&a.responseURL.indexOf("default")>=0),status:a.status};Np.set(s,t),e(t)},a.onerror=t=>{zconsole.error((function(e){return e[0]})`checkHEAD error`,t);const i={contentType:null,contentLength:null,alive:!1,status:a.status};Np.set(s,i),e(i)},a.ontimeout=t=>{const i={contentType:null,contentLength:null,alive:!1,status:a.status};Np.set(s,i,{maxAge:6e4}),e(i)},a.onabort&&(a.onabort=()=>{const t={contentType:null,contentLength:null,alive:!1,status:a.status};Np.set(s,t,{maxAge:6e4}),e(t)}),a.send()})));var s;if(zconsole.zsymb(0,"xoEmxH","MediaBlobFetcher: check HEAD response",e.source,t),"number"==typeof(null==t?void 0:t.contentLength)&&t.contentLength>=this.BIG_FILE_THRESHOLD){var a,i;const t=`${e.mediaId}-${(null===(a=e.options)||void 0===a||null===(i=a.regenerateFromSource)||void 0===i?void 0:i.regenId)||""}`,s=zp(this._fetch,e),n=new Gp(t,s);return this.BigFileTaskQueue.addTask(n),await n.executor.promise}return await this._fetch(e)},this._fetch=async e=>{var t;let{mediaId:s,source:a,options:i={},entry:n}=e;Object(Cp.a)("string"==typeof a&&Ep(a),`Media source must be a (http|https) URL. Got ${a}`);const r={start:performance.now(),end:performance.now()};zconsole.zsymb(3,"pXQYdt",["MediaBlobFetcher: fetch start. {} {} {}","Sn0SFK"],s,n,a,null===(t=i.regenerateFromSource)||void 0===t?void 0:t.regenId);try{var o;let t=(null===(o=i.regenerateFromSource)||void 0===o?void 0:o.maxDimension)||Ce.default.image_loader.max_original;if(null!=i&&i.regenerateFromSource){delete i.regenerateFromSource.getLocalPath;const e=i.regenerateFromSource;Object(fp.c)(e.originalWidth)&&e.originalWidth>0&&Object(fp.c)(e.originalHeight)&&e.originalHeight>0&&([t]=Object(hp.d)(e.originalWidth,e.originalHeight,t,t,!1))}const n=Object(I.a)(Object(I.a)({cacheControl:"cache",useMemCache:!0,useDiskCache:!1},i),{},{convertible:Object(wp.g)(a)});if(null!=i&&i.regenerateFromSource){n.regenerateJXL={outputWidth:t,outputHeight:t};const s=i.regenerateFromSource.regenId;a=Object(wp.b)(i.regenerateFromSource.url,"regenw",t.toString()),"cache"===n.cacheControl&&(n.useDiskCache="thumb"===s||"normal"===s,n.useDiskCache&&(a=Object(Rp.d)(a))),e.source=a}if("cache"==n.cacheControl){var l;if(Dp.b.has(a)){var c;const e=null===(c=Dp.b.get(a))||void 0===c?void 0:c.prepared;return np.l.Success({mediaURL:e})}const e=kp(a,(null===(l=i.regenerateFromSource)||void 0===l?void 0:l.regenId)||""),t=await Dp.a.getFile(e);if(t){const e=URL.createObjectURL(t);return Dp.b.set(a,t.size,e),np.l.Success({mediaURL:e})}}const d=await this.getFetcher()(Object(at.j)().toString(),a,"dev",void 0,n,void 0,(e=>{if(!e)return null;const[t,s,a]=e.split(".");return{cliMsgId:t,fromUid:s,toUid:a}||null})(s),at.c.IMAGE_COMPONENT);return r.end=performance.now(),d.error||!d.data?(zconsole.zsymb(18,"9Zebf6",`MediaBlobFetcher: fetch failed. ${s} ${a}. took: ${Date.now()-r.start}`,d),await this.handleFailure(e,n,d,r)):await this.handleSuccess(e,n,d,r)}catch(d){return this.Logger.zsymb(0,"EHUDuG",`MediaBlobFetcher: fetch caught error. ${s} ${a}. took: ${Date.now()-r.start}`,d,null==d?void 0:d.code),np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:a,error:d}})}},this.getFetcher=()=>{const e={[Ap.a.V1]:at.h,[Ap.a.V2]:at.i}[Tp.a.image_loader.version];Object(Cp.a)(!!e,`Invalid fetcher: targeting ${Tp.a.image_loader.version}`);return Object(Mp.a)(e,{min:Tp.a.image_loader.retryMin,max:Tp.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Tp.a.image_loader.lastTryDelayTime.min,max:Tp.a.image_loader.lastTryDelayTime.max},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:a})=>{e||this.Logger.zsymb(0,"x6CdFM",`MediaBlobFetcher: Try ${s}: failed. Should retry: ${t} after ${a}ms`),e||t||this.Logger.zsymb(0,"dg_9aK",`MediaBlobFetcher: Download failed after ${s} tries`)}})},this.handleFailure=async(e,t,s,a)=>{var i;const{mediaId:n,source:r}=e;this.Logger.zsymb(0,"rmNxNN",`MediaBlobFetcher: fetch failed. ${n} ${r}. took: ${Date.now()-a.start}`,s.error,s.data,null==s||null===(i=s.error)||void 0===i?void 0:i.code);const o=a.end-a.start;if(Object(Lp.l)(s.error)){var l;const e=Object(Lp.m)(null===(l=s.error)||void 0===l?void 0:l.code);if(e){const{qosCommand:t,errorCode:s}=e;ul.default.increaseFailed(t,0,o,s,a.start)}return ul.default.increaseFailed(cp.a,0,o,Object(cp.k)(),a.start),np.l.Failure({code:np.d.LIBJXL_ERROR,mediaURL:r,error:{mediaURL:r,error:s.error}})}return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:r,error:s.error}})},this.handleSuccess=async(e,t,s,a)=>{Object(Cp.a)(!!s.data,"Data must be present in response");try{var i,n;const{source:l}=e,c=a.end-a.start;if(Object(wp.g)(l)&&s.data&&(ul.default.increaseSuccess(cp.b,0,c),ul.default.increaseSuccess(cp.a,0,c)),"string"==typeof s.data)return np.l.Success({mediaURL:s.data});let d=s.data;const u=null===(i=e.options)||void 0===i?void 0:i.regenerateFromSource;if(u){const e=u.maxDimension||Ce.default.image_loader.max_original;let t=u.originalWidth,s=u.originalHeight,a=!1,i=0,n=0;if(Object(fp.c)(t)&&Object(fp.c)(s)&&Object(fp.c)(e))[i,n,a]=Object(hp.d)(t,s,e,e,!1);else{const[r,o]=await E.c.catchAsyncFn((()=>Fp.default.getDimension({key:l,file:d})));!r&&o&&(t=o.width,s=o.height,[i,n,a]=Object(hp.d)(o.width,o.height,e,e,!1))}a&&(d=await Object(op.a)(d,{width:i,height:n,priority:0,quality:.75}))}"image/jxl"!==(null===(n=d)||void 0===n?void 0:n.type)||null!=t&&t.downloadAsJxl||(d=Object(Rp.b)(d,"image/jpeg"));const h=URL.createObjectURL(d);if("cache"===t.cacheControl&&(Dp.b.set(l,d.size,h),!0===t.useDiskCache)){var r,o;const t=kp(l,(null==e||null===(r=e.options)||void 0===r||null===(o=r.regenerateFromSource)||void 0===o?void 0:o.regenId)||"");await Dp.a.putFile(t,d)}return np.l.Success({mediaURL:h})}catch(l){np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:e.source,error:l}})}},this.createDeferredTask=e=>{let t=()=>{},s=()=>{};return{promise:new Promise(((e,a)=>{t=e,s=a})),resolve:t,reject:s,source:e}},this.Logger=e.createZLogger(R.ZLoggerNametags.imageLoader,[R.ZLoggerNametags.mediaBlobFetcher])}})||Vp)||Vp)||Vp)||Vp;a.ModuleContainer.registerSingleton(Sp.a,Hp);var Wp,qp=s("xQyS"),Kp=s("HOwT"),$p=s("CI+W"),Zp=s("BDVO"),Qp=s("UD1y");const Yp=$znode.path;let Jp=Object(a.injectable)()(Wp=class{constructor(){this._Logger=null,this.fetch=async e=>{let{mediaId:t,source:s,options:i,entry:n}=e;Object(Cp.a)(!!Yp,"Path module cannot be null"),Object(Cp.a)("string"==typeof s&&Ep(s),`Media source must be a http|https. Got ${s}`);const r=await i.getSavePath(s);let o=null,l=null,c=null;try{const e=t.split(".");3===e.length&&(o=e[0],c=e[1],l=e[2])}catch(m){}let d=r;const u=i.regenerateFromSource;u&&(Object(Cp.a)(!!u.getLocalPath,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),Object(Cp.a)(!!u.url,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),d=await u.getLocalPath(u.url));let h=!1;if(!Object(ki.a)(d)){if(Object(fp.b)(i.getOldLocalPathForMigration)&&!i.regenerateFromSource){const e=await i.getOldLocalPathForMigration(s);if(e&&Object(ki.a)(e))return this.Logger.zsymb(0,"kY9w72",`MediaDiskFetcher: migrateSource ${e} -> ${d}`),await this._copySource(e,d,!1),np.l.Success({mediaURL:d})}h=!0;try{let e={url:s,mediaId:t,localPath:d,entrySerial:i.entrySerial,sendDttm:null==i?void 0:i.sendDttm,noCacheRespFail:(null==i?void 0:i.sendDttm)&&Object(Zp.a)(null==i?void 0:i.sendDttm),options:{isLastFallbackUrl:i.isLastFallbackUrl}};!0===i.autoDownload&&(e.options=Object(I.a)(Object(I.a)({},e.options),{},{srcAction:tt.default.constants.srcAction.Auto})),this.Logger.zsymb(0,"z7WHaG",`MediaDiskFetcher: try fetch sendDttm:${e.sendDttm} ${e.url} -> ${e.localPath}. cacheFail:${e.noCacheRespFail}`),o&&lp.a.log(o,{clientId:o,dest_id:l,srcId:c,msgFormat:$znode.path.extname(d)});const a=await this._downloadWithRetry(e);if(o&&lp.a.endLog(o,{clientId:o}),a.error)return this.Logger.zsymb(18,"84S6mf",`MediaDiskFetcher: error ${s} | ${e.localPath} -> ${JSON.stringify(a.error)}`),np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:a.error}})}catch(m){return this.Logger.zsymb(14,"HLT1cH",`MediaDiskFetcher: fetch throws unknown error ${s}`,m),np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:m}})}}if(!i.regenerateFromSource)return np.l.Success({mediaURL:d});Object(Cp.a)(!!u,"MediaDiskFetcher: regenerateFromSource cannot be null");const g=await a.ModuleContainer.resolve(ip.a).regenImageFromLocal({priority:null==u?void 0:u.priority,getSourcePath:()=>Promise.resolve(d),getGenThumbPath:()=>Promise.resolve(r),sizes:{originalWidth:u.originalWidth,originalHeight:u.originalHeight,maxDimension:u.maxDimension},log:{clientId:o,originalWidth:null==u?void 0:u.originalWidth,originalHeight:null==u?void 0:u.originalHeight},getOldLocalPathForMigration:()=>{var e;return Promise.resolve(null==i||null===(e=i.getOldLocalPathForMigration)||void 0===e?void 0:e.call(i,s))}}).finally((()=>{u.enableStandalone&&h&&this._deleteLocalSource(d)}));return"ERROR"===g.type?(this.Logger.zsymb(18,"KRWTXY","MediaDiskFetcher: regenerateFromSource failed",t,n,s,d),np.l.Failure({code:np.d.FAILURE_BY_REGENERATE,error:{mediaURL:s,error:g.data.error}})):np.l.Success({mediaURL:g.data.mediaURL})},this._toJpeg=(e,t="")=>{if(".jxl"===$znode.path.extname(e))return e.replace(/\.jxl$/,".jpg");if(t){const s=$znode.path.basename(e),a=$znode.path.dirname(e);return $znode.path.join(a,`${t}-${s}`)}return e},this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(qp.a)($p.loadPC,e),a=s.ok?t:"";if(s.ok)return{mediaURL:a,error:void 0};throw s.error},this._downloadWithRetry=Object(Mp.a)(this._downloadHandler,{min:Tp.a.image_loader.retryMin,max:Tp.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Tp.a.image_loader.lastTryDelayTime.min,max:Tp.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>{if(!a.ModuleContainer.resolve(Qp.b).isOnline)return!1;return e instanceof Kp.NotReadyError||e instanceof Kp.TimeoutTTFB||e instanceof Kp.TimeoutError},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:a})=>{e||this.Logger.zsymb(0,"6ptLRY",`Try ${s}: failed. Should retry: ${t} after ${a}ms`),e||t||this.Logger.zsymb(0,"kZk_Sh",`MediaDiskFetcher: Download failed after ${s} tries`)}}),this._deleteLocalSource=async e=>{if(e)try{await new Promise(((t,s)=>{$znode.fs.unlink(e,(a=>{a?(this.Logger.zsymb(18,"Twsy6L","MediaDiskFetcher: deleteLocalSource error",e,a),s(a)):t(!0)}))}))}catch(t){zconsole.zsymb(15,"FnRnXg",["MediaDiskFetcher: deleteLocalSource error","8SU_GB"],t)}else zconsole.zsymb(21,"Y8ITUv",["MediaDiskFetcher: deleteLocalSource localPath cannot be null","dDfxv4"],e)},this._copySource=async(e,t,s=!0)=>{if(e&&t)try{let a=e;s||(a=`${e}.tmp`,await new Promise(((t,s)=>{$znode.fsExtra.rename(e,a,(a=>{a?(this.Logger.zsymb(18,"TnDxhY","MediaDiskFetcher: migrateSource error",e,a),s(a)):t(!0)}))}))),await $znode.fsExtra.copy(a,t,{dereference:!0,overwrite:!0}),s||await this._deleteLocalSource(a)}catch(a){zconsole.zsymb(15,"zlR9wr",["MediaDiskFetcher: migrateSource error","g_hYxO"],a)}else zconsole.zsymb(21,"FtZrqP",["MediaDiskFetcher: migrateSource oldPath and newPath cannot be null","E7PqB-"],e,t)}}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.imageLoader,[R.ZLoggerNametags.mediaDiskFetcher])),this._Logger}})||Wp;var Xp;a.ModuleContainer.registerSingleton(Sp.b,Jp);let ef=Object(a.injectable)()(Xp=class extends hs.b{async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:i,sendDttm:n,isLastFallbackUrl:r=!1,regenerateFromSource:o,entry:l}=e;let c;Object(Cp.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Cp.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),c=i&&i.savePath?np.j.DiskCache:np.j.MemoryCache;const d=Ep(s),u=Op(s);if(!d&&u)return np.l.Success({mediaURL:s});if(!d&&!u){var h,g;const e=!u||["file://","zfile://"].some((e=>s.startsWith(e))),t=null==s||null===(h=s.replace("file://",""))||void 0===h?void 0:h.replace("zfile://","");if(e&&(null===(g=$znode.fs)||void 0===g?void 0:g.existsSync(t)))return np.l.Success({mediaURL:t});if(e)return np.l.Failure({code:np.d.FAILURE_BY_FETCH})}if(e.useHttpsSource){try{return await ui.default.checkAlive(s),np.l.Success({mediaURL:s})}catch(_){}return np.l.Failure({code:np.d.FAILURE_BY_FETCH})}if(c===np.j.MemoryCache)try{return await a.ModuleContainer.resolve(Sp.a).fetch({mediaId:t,source:s,options:{cacheControl:"cache",sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,useDiskCache:!1,useMemCache:!0},entry:l})}catch(b){return Promise.reject(b)}Object(Cp.a)("object"==typeof i&&"string"==typeof i.savePath&&!!i.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${i}`);const{savePath:m,downloadEntrySerial:p,getSavePath:f,getOldLocalPathForMigration:v}=i;return a.ModuleContainer.resolve(Sp.b).fetch({mediaId:t,source:s,options:{entrySerial:p,savePath:m,sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,getSavePath:f,getOldLocalPathForMigration:v},entry:l})}async fetchSocialMediaStandalone(e){const{mediaId:t,source:s,entry:i=np.k.UNKNOWN}=e;Object(Cp.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Cp.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`);const n=Ep(s),r=Op(s);if(!n&&r)return np.l.Success({mediaURL:s});try{return await a.ModuleContainer.resolve(Sp.a).fetch({mediaId:t,source:s,options:{cacheControl:"noCache"},entry:i})}catch(o){return Promise.reject(o)}}})||Xp;a.ModuleContainer.registerSingleton(Sp.c,ef);var tf,sf=s("Evs5");let af=Object(a.injectable)()(tf=class{constructor(){this.loadMedia=async(e,t)=>{const{mediaId:s,entry:a,qualityFallback:i,fetchStrategy:n}=e,{fetcher:r,diskCacheConfig:o,disableLocalCache:l}=n,c=null==t?void 0:t.onFirstAvailable;let d=i,u=null;const h=new Set;let g=!1;for(;d;){const t=d.data.url,i=d.data.getLocalPath,p=d.data.getOldLocalPathForMigration;let f=d.data.regenerateFromSource;if(!t){d=d.nextOR||d.next;continue}const v=!d.nextOR&&!d.next;if(h.has(t)&&!v){d=d.nextOR||d.next;continue}g=!0;const _=await this._buildFetchConfig({mediaId:s,entry:a,source:t,getLocalPath:()=>null==i?void 0:i(t),downloadEntrySerial:null==o?void 0:o.downloadEntrySerial,autoDownload:!!u,sendDttm:e.sendDttm,isLastFallbackUrl:v,regenerateFromSource:f,disableLocalCache:l,getOldLocalPathForMigration:p}),b=await r(_);if("ERROR"==b.type){if(b.data.error&&Object(Lp.l)(b.data.error))return np.l.Failure({code:np.d.LIBJXL_ERROR,error:b.data.error});h.add(t),d=d.nextOR||d.next;continue}let I=null,y=null,S=null;try{const t=e.mediaId.split(".");3===t.length&&(I=t[0],y=t[1],S=t[2])}catch(m){}if(I&&lp.c.log(I,{msgFormat:Object(wp.g)(t)?".jxl":".jpg"}),!u&&(u={mediaURL:b.data.mediaURL},null==c||c(np.l.Success(u)),!n.fetchAllAvailable))break;d=d.next}return g?null===u?np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:s}):np.l.Success(u):np.l.Failure({code:np.d.EMPTY_SOURCE,error:s})},this.loadImage=async(e,t)=>{const{mediaId:s,entry:i,srcs:n,downloadAllResources:r}=e,o=a.ModuleContainer.resolve(Sp.c).fetch,l=null==t?void 0:t.onFirstAvailable;let c=null;const d=new Set;let u=!1;const h=(e=>{const t={},s=[];for(const a of e)a.src&&!t[a.src]&&(s.push(a),t[a.src]=!0);return s})(n);for(let a=0;a<h.length;a++){var g,m,p,f;const t=h[a],n=t.src,_=null===(g=t.downloadConfig)||void 0===g?void 0:g.getLocalPath,b=null===(m=t.downloadConfig)||void 0===m?void 0:m.getOldLocalPathForMigration;let I=t.regenerateFromSource;const y=a===h.length-1;if(d.has(n)&&!y)continue;u=!0;if(e.useHttpsSource)try{if(Ep(n)){if(!(await jp(n,{cacheResponse:!0,retryableErrorCodes:Tp.a.image_loader.retryErrorCodes})))throw new Error("url is not alive. Continue to the next source");return np.l.Success({mediaURL:n})}return np.l.Success({mediaURL:n})}catch(v){d.add(n);continue}const S=await this._buildFetchConfig({mediaId:s,entry:i,source:n,getLocalPath:()=>null==_?void 0:_(n),downloadEntrySerial:null===(p=t.downloadConfig)||void 0===p?void 0:p.downloadEntrySerial,autoDownload:!!c,sendDttm:null===(f=t.downloadConfig)||void 0===f?void 0:f.sendDttm,isLastFallbackUrl:y,regenerateFromSource:I,useHttpsSource:e.useHttpsSource,getOldLocalPathForMigration:b}),C=await o(S);if("ERROR"==C.type){if(zconsole.error((function(e){return e[0]})`MediaPackageManager: fetch error`,C),C.data.error&&Object(Lp.l)(C.data.error))return np.l.Failure({code:np.d.LIBJXL_ERROR,error:C.data.error});if(d.add(n),a===h.length-1)return C;continue}let E=null,O=null,M=null;try{const t=e.mediaId.split(".");3===t.length&&(E=t[0],O=t[1],M=t[2]),E&&lp.c.log(E,{msgFormat:Object(wp.g)(n)?".jxl":".jpg"})}catch(v){}if(!c&&(c={mediaURL:C.data.mediaURL},null==l||l(np.l.Success(c)),!r))break}return u?null===c?np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:s}):np.l.Success(c):np.l.Failure({code:np.d.EMPTY_SOURCE,error:s})},this._buildFetchConfig=async e=>{Object(Cp.a)(!!e&&"object"==typeof e,`_buildDownloadConfig: config must be object, got ${e}`);const t=Object(e);Object(Cp.a)("string"==typeof t.mediaId,`_buildDownloadConfig: mediaId must be string, got ${null==t?void 0:t.mediaId}`),Object(Cp.a)(t.entry in np.k,`_buildDownloadConfig: entry must be MediaDisplayTarget, got ${null==t?void 0:t.entry}`),Object(Cp.a)("string"==typeof t.source,`_buildDownloadConfig: source must be string, got ${null==t?void 0:t.source}`);const s={mediaId:t.mediaId,source:t.source,sendDttm:t.sendDttm,isLastFallbackUrl:t.isLastFallbackUrl,regenerateFromSource:t.regenerateFromSource,entry:t.entry};if(t.getLocalPath&&!t.disableLocalCache){const e=await t.getLocalPath();s.diskFetcherConfig={savePath:e,downloadEntrySerial:t.downloadEntrySerial,autoDownload:t.autoDownload,getSavePath:t.getLocalPath,getOldLocalPathForMigration:t.getOldLocalPathForMigration}}return s}}abort(e,t){}})||tf;a.ModuleContainer.registerSingleton(sf.a,af);var nf=s("o46R"),rf=s("OgkW"),of=s.n(rf);const lf={FORWARD_MESSAGE:"FORWARD_MESSAGE",DOWNLOAD_MESSAGE:"DOWNLOAD_MESSAGE",RELOAD_MEDIA:"RELOAD_MEDIA"};var cf=s("Mf3M");const df=["failure"];var uf;Object(a.injectable)()(uf=Object(Ai.b)(Qp.b)(uf=function(e,t){return Object(a.inject)(sf.a)(e,void 0,0)}(uf=function(e,t){return Object(a.inject)(m.a)(e,void 0,1)}(uf=Reflect.metadata("design:type",Function)(uf=Reflect.metadata("design:paramtypes",[Object,void 0===m.a?Object:m.a])(uf=class{constructor(e,t){this.mediaPackageManager=e,this.application=t,this._revokedBlobURL=new Map,this._activeContextWindow=null,this._retryItems=new u.default({maxSize:1e3}),this.TaskQueue=void 0,this.UserSourceTracker=new Map,this.MAX_LOAD_TASKS=8,this._eventEmitter=new of.a,this.MAX_RETRIES=4,this._isOnline=!0,this.NETWORK_STABLE_TIMEOUT=2e3,this._networkRetryTimeout=null,this._retryNetworkWhenAliveQueue=new Map,this._PreTaskQueue=[],this.trackTempBlob=(e,t)=>{this.UserSourceTracker.set(e.toString(),t)},this.removeTrackTempBlob=e=>{this.UserSourceTracker.delete(e.toString())},this.setActiveWindowContext=e=>("WeakRef"in globalThis?this._activeContextWindow=new globalThis.WeakRef(e):this._activeContextWindow=e,this.removeActiveWindowContext),this.removeActiveWindowContext=()=>{this._activeContextWindow=null},this.getActiveWindowContext=()=>this._activeContextWindow instanceof globalThis.WeakRef?this._activeContextWindow.deref():this._activeContextWindow,this.manualRetry=async(e,t,s=!1)=>{var a,i,n,r,o,l;if(Tp.a.image_loader.version===Ap.a.V2)return this.retryEntry(e,t,s);const c=this.data.get(e),d=`${e}-${t}`;if((null==c||null===(a=c.failure)||void 0===a?void 0:a.code)!==np.d.FORCE_EXPIRE&&!this.TaskQueue.isRunning(d)&&(s||(null==c||null===(i=c.view)||void 0===i||null===(n=i[t])||void 0===n||null===(r=n.failure)||void 0===r?void 0:r.code)!==np.d.FORCE_ERROR))if(this._retryable(d)||s)if(c){if(s&&this._retryItems.set(d,0),c&&c.view&&null!==(o=c.view)&&void 0!==o&&null!==(l=o[t])&&void 0!==l&&l.failure){var u,h;this._handleRevokeURL({payload:{blobURL:null==c||null===(u=c.view[t])||void 0===u?void 0:u.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==c||null===(h=c.view[t])||void 0===h?void 0:h.expected,mediaId:e}});const s=c.view,{[t]:a}=s,i=Object(zi.a)(s,[t].map(nf.a)),{failure:n}=c,r=Object(zi.a)(c,df),o=Object(I.a)(Object(I.a)({},r),{},{view:i});this.data.set(e,o)}this.emit(lf.RELOAD_MEDIA,{mediaId:e,entry:t,hotSwapSource:!0})}else this.emit(lf.RELOAD_MEDIA,{mediaId:e,entry:t});else this.forceError(e,t)},this.forceError=(e,t,s)=>{var a;const i=this.data.get(e)||{mediaId:e,view:{}},n=(null==i?void 0:i.view)||{},r=null==s||null===(a=s.data)||void 0===a?void 0:a.code,o=r&&Object.values(np.d).some((e=>e===r))?r:np.d.FORCE_ERROR;this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},n),{},{[t]:{failure:{code:o,message:`ForceError=${r}`}}})})),this._signalRenderItem(this.name,e)},this.loadMedia=async(e,t={})=>{const s=zp(this._loadMedia,e,t),a=`${e.mediaId}-${e.entry}`,i=new Gp(a,s);this.TaskQueue.addTask(i)},this._handleTaskQueueCompleted=e=>{if(this._PreTaskQueue.length>0&&this._PreTaskQueue.some((t=>t.taskId===e))){const e=this.MAX_LOAD_TASKS-this.TaskQueueSize;if(e>0&&this._PreTaskQueue.length>0){const t=this._PreTaskQueue.slice(0,e);this._PreTaskQueue.splice(0,t.length);const s=new Set;for(let e of t){const{mediaId:t,entry:a}=e;this._mayInitState(t);const i=this.data.get(t),n=Array.from(new Set([...(null==i?void 0:i.hotLoad)||[],a]));this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{hotLoad:n})),s.add(t)}Array.from(s).forEach((e=>{this._signalRenderItem(this.name,e)}))}}},this.enqueueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s[t]={mediaId:e,entry:t},this._retryNetworkWhenAliveQueue.set(e,s)},this.dequeueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s&&(delete s[np.k[t]],Object.values(s).length>0?this._retryNetworkWhenAliveQueue.set(e,s):this._retryNetworkWhenAliveQueue.delete(e))},this._removeEntryFromPreTaskQueue=(e,t)=>Array.isArray(e)&&0!==e.length?e.filter((e=>e!==t)):[],this._loadMedia=async(e,t={})=>{var s,a,i,n,r,o,l;const{forceLoad:c=!1}=t,d=(e.mediaId,e.entry,this.data.get(e.mediaId));if(globalThis.__alwaysForcePhotoExpired)return this.forceExpire(e.mediaId);if((null==d||null===(s=d.failure)||void 0===s?void 0:s.code)===np.d.FORCE_EXPIRE||(null==d||null===(a=d.view)||void 0===a||null===(i=a[e.entry])||void 0===i||null===(n=i.failure)||void 0===n?void 0:n.code)===np.d.FORCE_ERROR)return;const u=this._revokedBlobURL.get(e.mediaId),h=null==d||null===(r=d.view)||void 0===r?void 0:r[e.entry],g=!(null==h||!h.actual||null!=u&&u.has(h.actual)),m=[np.e.EmptySource,np.e.ZaloSource,np.e.ExpiredSource];if(g&&m.some((e=>e===h.dataSrcId))||null!=d&&d.failure&&!1===c)return;if(this._mayInitState(e.mediaId,{rotateDeg:90*e.vOrient}),null!==(o=e.uploadSource)&&void 0!==o&&null!==(l=o.oriUrl)&&void 0!==l&&l.startsWith("blob:"))return void this._updateViewUpload(e.mediaId,e.entry,e.uploadSource);let p=null,f=null,v=null;try{const t=e.mediaId.split(".");3===t.length&&(p=t[0],f=t[1],v=t[2])}catch(_){}p&&lp.c.log(p,{clientId:p,dest_id:v,srcId:f});try{let s=!1;const a=this.data.get(e.mediaId),i=Object(I.a)(Object(I.a)({},t),{},{expiryCheck:e.expiryCheck}),n=await this.mediaPackageManager.loadMedia(e,{hasHd:null==a?void 0:a.hasHd,skipHdCheck:null==a?void 0:a.hasHd,onFirstAvailable:t=>{s=!0,this._handleLoadResponse(e.mediaId,e.entry,t,i)}});s||this._handleLoadResponse(e.mediaId,e.entry,n,i)}catch(_){zconsole.zsymb(18,"IQEIYy","ImageLoaderController: loadMedia error",_),p&&lp.c.endLog(p,{clientId:p,dest_id:v,srcId:f,renderStatus:0})}},this._retryable=e=>!((this._retryItems.get(e)||0)>=this.MAX_RETRIES||this.TaskQueue.isRunning(e)),this.runFullflow=(e,t)=>{var s,a,i,n;const r=this.data.get(e),o=`${e}-${t}`;if((null==r||null===(s=r.failure)||void 0===s?void 0:s.code)===np.d.FORCE_EXPIRE||this.TaskQueue.isRunning(o)||(null==r||null===(a=r.view)||void 0===a||null===(i=a[t])||void 0===i||null===(n=i.failure)||void 0===n?void 0:n.code)===np.d.FORCE_ERROR)return;if(!this._retryable(o))return void this.forceError(e,t);this.abanbonMedia(e,t);const l=this._retryItems.get(o)||0;this._retryItems.set(o,l+1),this.manualRetry(e,t)},this.abort=e=>{const t=this._retryItems.get(e)||0;this._retryItems.set(e,Math.max(t-1,0)),this.TaskQueue.abortTask(e)},this.loadDOMSuccess=(e,t)=>{try{const t=e.split(".");if(t.length){const e=t[0];lp.c.endLog(e,{renderStatus:1})}}catch(s){}this._retryItems.delete(`${e}-${t}`)},this.loadDOMError=(e,t)=>{},this._signalRenderItem=(...e)=>{Object(Po.h)(...e)},this._updateView=(e,t,s,a)=>{if(!s)return;const i=this.data.get(e);let n=i.view[t]||{};if(2===Tp.a.image_loader.version)for(const[d,u]of Object.entries(i.view))u.failure&&u.failure.code===np.d.FORCE_ERROR&&delete i.view[d];const r=this._revokedBlobURL.get(e);if(!n||!Boolean(n.actual)||n.actual&&null!=r&&r.has(n.actual))i.view=Object(I.a)(Object(I.a)({},i.view),{},{[t]:{actual:s,expected:s,dataSrcId:np.e.ZaloSource}}),this.data.set(e,i),n&&n.actual&&n.actual!==n.expected&&this._handleRevokeURL({payload:{blobURL:n.actual,mediaId:e}});else if(Boolean(n.actual)&&n.actual!==s){const a=Object(I.a)(Object(I.a)({},n),{},{expected:s});i.view=Object(I.a)(Object(I.a)({},i.view),{},{[t]:a}),this.data.set(e,i)}if(null!=a&&a.hotSwapSource){var o,l;const i=this.data.get(e);var c;if(n=i.view[t]||{},a.reloadUploadSource&&null!==(o=n)&&void 0!==o&&o.actual&&n.actual!==s)URL.revokeObjectURL(null===(c=n)||void 0===c?void 0:c.actual),this.UserSourceTracker.delete(e.split(".")[0]);this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},null==i?void 0:i.view),{},{[t]:Object(I.a)(Object(I.a)({},null==i||null===(l=i.view)||void 0===l?void 0:l[t]),{},{actual:s,expected:s,dataSrcId:np.e.ZaloSource})})})),n&&n.actual&&n.actual!==n.expected&&this._handleRevokeURL({payload:{blobURL:n.actual,mediaId:e}})}this._signalRenderItem(this.name,e)},this._handleRevokeURL=e=>{const t=null==e?void 0:e.payload;Object(Cp.a)(!!t,"ImageLoaderController: revoke event payload undefined");const{blobURL:s,mediaId:a}=t;s&&URL.revokeObjectURL(s)},this.listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),_e.default.subscribe(this._handleNetworkChange)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),_e.default.unsubscribe(this._handleNetworkChange)},this.loadImage=async e=>{const t=zp(this._loadImage,e),s=`${e.mediaId}-${e.entry}`,a=new Gp(s,t);this.TaskQueue.addTask(a)},this.reloadImage=async(e,t)=>{const s=this.data.get(e);if(!s)return;s.view[t]&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},s.view),{},{[t]:{}})})),this._signalRenderItem(this.name,e))},this.abortLoadImage=(e,t)=>{const s=`${e}-${t}`;this.TaskQueue.abortTask(s),this.dequeueNetworkRetry(e,np.k[t])},this.swapUploadSourceOutview=(e,t)=>{const s=this.data.get(e),a=null==s?void 0:s.view[t],i=(null==s?void 0:s.uploadSource)===(null==a?void 0:a.actual);return!!a&&(!(!i||a.actual===a.expected||!Boolean(a.expected))&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},null==s?void 0:s.view),{},{[t]:Object(I.a)(Object(I.a)({},a),{},{actual:a.expected,dataSrcId:np.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,a.actual),!0))},this.freeImageCache=(e,t)=>{},this.retryEntry=(e,t,s=!1)=>{var a,i,n,r,o,l,c,d;const u=this.data.get(e);if(!u||null===(a=u.view)||void 0===a||null===(i=a[t])||void 0===i||!i.failure)return;const h=`${e}-${t}`;var g,m,p,f;if((null==u||null===(n=u.failure)||void 0===n?void 0:n.code)===np.d.FORCE_EXPIRE||this.TaskQueue.isRunning(h)||!s&&(null==u||null===(r=u.view)||void 0===r||null===(o=r[t])||void 0===o||null===(l=o.failure)||void 0===l?void 0:l.code)===np.d.FORCE_ERROR)zconsole.log("retryEntry: early return",e,t,(null==u||null===(g=u.failure)||void 0===g?void 0:g.code)===np.d.FORCE_EXPIRE,this.TaskQueue.isRunning(h),!s&&(null==u||null===(m=u.view)||void 0===m||null===(p=m[t])||void 0===p||null===(f=p.failure)||void 0===f?void 0:f.code)===np.d.FORCE_ERROR);else if(this._retryable(h)||s){var v,_;if(s&&this._retryItems.set(h,0),u&&u.view&&null!==(c=u.view)&&void 0!==c&&null!==(d=c[t])&&void 0!==d&&d.failure)this._handleRevokeURL({payload:{blobURL:null==u||null===(v=u.view[t])||void 0===v?void 0:v.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==u||null===(_=u.view[t])||void 0===_?void 0:_.expected,mediaId:e}}),null!=u&&u.view[t]&&(null==u||delete u.view[t]),null!=u&&u.failure&&(null==u||delete u.failure),this.data.set(e,u),u.hotLoad=this._removeEntryFromPreTaskQueue(u.hotLoad,t);this._signalRenderItem(this.name,e)}else this.forceError(e,t)},this._loadImage=async e=>{var t;const{mediaId:s,entry:a,uploadSource:i}=e;let n=null,r=null,o=null;this._mayInitState(e.mediaId),null!=i&&i.blobUrl&&"string"==typeof i.blobUrl&&i.blobUrl.startsWith("blob:")&&await this._prepareUploadingSource(e);const l=this.data.get(s);if(null===(t=l.uploadSource)||void 0===t||!t.startsWith("blob:")||e.reloadUploadSource){try{const t=e.mediaId.split(".");3===t.length&&(n=t[0],r=t[1],o=t[2])}catch(c){}n&&lp.c.log(n,{clientId:n,dest_id:o,srcId:r});try{let t=!1;const i={hotSwapSource:e.hotSwapSource,reloadUploadSource:e.reloadUploadSource},n=await this.mediaPackageManager.loadImage(e,{onFirstAvailable:s=>{t=!0,this._handleLoadResponse(e.mediaId,np.k[e.entry],s,i)}});if(!this.isOnline&&e.retryWhenOnline&&"ERROR"===n.type&&n.data.code===np.d.FAILURE_BY_FETCH)return this.enqueueNetworkRetry(s,np.k[e.entry]),void this.forceError(s,np.k[a],np.l.Failure({code:np.d.FAILURE_BY_NETWORK,error:n.data.error}));t||this._handleLoadResponse(e.mediaId,np.k[e.entry],n)}catch(c){this.forceError(s,np.k[a]),n&&lp.c.endLog(n,{clientId:n,dest_id:o,renderStatus:0})}}else this._updateViewUpload(s,np.k[a],{oriUrl:l.uploadSource})},this._resetItemState=(e,t)=>{if(!this.data.has(e))return;const s=this.data.get(e)||{mediaId:e,view:{}};if(!s.view[t])return;const a=s.view;delete a[t],this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)({},a)})),this._signalRenderItem(this.name,e)},this._retryNetworkTasks=()=>{const e=Array.from(this._retryNetworkWhenAliveQueue.values());this._retryNetworkWhenAliveQueue.clear();for(let t of e){const e=Object.values(t);for(let t of e)this._resetItemState(t.mediaId,np.k[t.entry])}},this._clearNetworkRetryTimeout=()=>{this._networkRetryTimeout&&(clearTimeout(this._networkRetryTimeout),this._networkRetryTimeout=null)},this._handleNetworkChange=(e,t)=>{e===ve.GeneralActions.NETWORK_STATUS_CHANGED&&(this._isOnline=!0===t),this._isOnline&&this._retryNetworkWhenAliveQueue.size>0?(this._clearNetworkRetryTimeout(),this._networkRetryTimeout=setTimeout(this._retryNetworkTasks,this.NETWORK_STABLE_TIMEOUT)):this._clearNetworkRetryTimeout()},this._prepareUploadingSource=async e=>{var t;const{mediaId:s,uploadSource:i}=e;let n=this.data.get(s)||{mediaId:s,view:{}};if(null!=i&&null!==(t=i.blobUrl)&&void 0!==t&&t.startsWith("blob:")){const e=s.split(".")[0],t=this.UserSourceTracker.get(e);if(t)n=Object(I.a)(Object(I.a)({},n),{},{uploadSource:t});else{const[t,s,o]=Object(hp.d)(i.width,i.height,1024,1024);{let e=(await a.ModuleContainer.resolve(cf.a.IPhotoMessageProcessorDef).getTempBlob(+i.clientId)).data;try{Object(Cp.a)(!!e,`ImageLoaderController: no blob found by getTempBlob::${i.clientId}`),e&&o&&(e=await Object(op.a)(e,{width:t,height:s,priority:2}));const a=URL.createObjectURL(e);n=Object(I.a)(Object(I.a)({},n),{},{uploadSource:a})}catch(r){}}n.uploadSource&&this.UserSourceTracker.set(e,n.uploadSource)}}this.data.set(s,n)},this.name=Qp.a,this.data=new Map,this.key="mediaId",this.init=()=>{this.listenEvents(),this._eventEmitter.setMaxListeners(50)},this.TaskQueue=new xp(this.MAX_LOAD_TASKS,this._handleTaskQueueCompleted),this.init()}get TaskQueueSize(){return this.TaskQueue.taskQueue.length+this.TaskQueue.runningTasks.size}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in lf&&this._eventEmitter.emit(e,t)}registerPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1),this._PreTaskQueue.push({mediaId:e,entry:t,taskId:`${e}-${t}`})}unregisterPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1)}getViewState(e,t){var s,a;return null===(s=this.data.get(e))||void 0===s||null===(a=s.view)||void 0===a?void 0:a[t]}allowOutviewUpdate(e,t){const s=this.data.get(e),a=null==s?void 0:s.view[t];a&&(a.dataSrcId!==np.e.Upload||a.expected)?a.actual!==a.expected&&Boolean(a.expected)&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},null==s?void 0:s.view),{},{[t]:Object(I.a)(Object(I.a)({},a),{},{actual:a.expected,dataSrcId:np.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,a.actual)):this.emit("RELOAD_MEDIA",{mediaId:e,entry:t,hotSwapSource:!0,forceLoad:!0})}forceExpire(e){var t;this._retryNetworkWhenAliveQueue.has(e)&&this._retryNetworkWhenAliveQueue.delete(e);const s=this.data.get(e)||{mediaId:e,view:{}};(null==s||null===(t=s.failure)||void 0===t?void 0:t.code)!==np.d.FORCE_EXPIRE&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{failure:{code:np.d.FORCE_EXPIRE,message:"Force expire"},view:{}})),this._signalRenderItem(this.name,e))}rotateMedia(e,t){let s=this.data.get(e);if(!s)throw new Error(`rotateMedia failed with ${e}: ${t}`);let a=s.rotateDeg||0;a+=t,s=Object(I.a)(Object(I.a)({},s),{},{rotateDeg:a}),this.data.set(e,s),this._signalRenderItem(this.name,e)}abanbonMedia(e,t){if(!this.data.has(e))return;const s=this.data.get(e);null!=s&&s.view[t]&&(delete s.view[t],this.data.set(e,Object(I.a)({},s)),this._signalRenderItem(this.name,e))}clearItemData(e,t,s){const a=this.data.get(e);a&&(delete a.view[t],a.hotLoad=this._removeEntryFromPreTaskQueue(a.hotLoad,t),this.data.set(e,a),!0===(null==s?void 0:s.signalRenderItem)&&this._signalRenderItem(this.name,e))}_runCleanup(e,t){if(!t||!t.startsWith("blob:"))return;const s=this.data.get(e);if(!s)return void URL.revokeObjectURL(t);const a=s.view;Object.values(a).forEach((e=>{e.actual!==t&&e.expected})),URL.revokeObjectURL(t)}_mayInitState(e,t={},s=!0){let a=this.data.get(e);a||(a=Object(I.a)(Object(I.a)({mediaId:e,view:{}},t),{},{hotLoad:[]}),this.data.set(e,a)),s||this._signalRenderItem(this.name,e)}_handleLoadResponse(e,t,s,a){switch(s.type){case"ERROR":this._handleLoadError(s,e,t,a);break;case"SUCCESS":this._handleLoadSuccess(s,e,t,a);break;default:throw new Error(`Unknown response type: ${e} ${t} got ${null==s?void 0:s.type}`)}}_handleLoadError(e,t,s,a={}){const i=e.data,n=()=>{try{var e;const a=null==i||null===(e=i.error)||void 0===e?void 0:e.error;return[`id=${t}-${s}`,`stt=${i.code}`,`dlerr=${null==a?void 0:a.name}:${null==a?void 0:a.code}`].join("\n")}catch(a){return zconsole.zsymb(18,"ABfHaj","ImageLoaderController: buildDebugInfo error",a),`status: ${i.code}`}};switch(i.code){case np.d.FAILURE_BY_FETCH:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case np.d.FAILURE_BY_PRELOAD:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case np.d.EMPTY_SOURCE:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case np.d.LIBJXL_ERROR:this.forceError(t,s)}}async _updateViewUpload(e,t,s){var a;if(null==s||!s.oriUrl)return;let i=this.data.get(e);const n=s.oriUrl;i?(null===(a=i.view[t])||void 0===a?void 0:a.actual)!==n&&Boolean(n)&&(i=Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},i.view),{},{[t]:{actual:n,expected:n,dataSrcId:np.e.Upload}})})):i={mediaId:e,view:{[t]:{actual:n,expected:n,dataSrcId:np.e.Upload}}},this.data.set(e,i),this._signalRenderItem(this.name,e)}_handleLoadSuccess(e,t,s,a){const i=e.data;this._updateView(t,s,i.mediaURL,a)}get isOnline(){return this._isOnline}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||uf)||uf)||uf)||uf)||uf);s("vUp1");var hf,gf=s("Mf7h"),mf=s("8c0e"),pf=s("alF8");const ff=new ui.LocalId;Object(a.injectable)()(hf=Object(a.singleton)(mf.a)(hf=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&pf.a.isEqualUrl(s,t)}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(I.a)({},s));const a={action:ve.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(I.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,a),gf.a.emit(ve.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(I.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:ff.next(),convId:e,content:{title:le.a.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(I.a)({},s));const a={action:ve.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(I.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,a),gf.a.emit(ve.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(I.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:ve.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),gf.a.emit(ve.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:ff.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||hf);var vf,_f=s("iy3m"),bf=s("twqL");Object(m.j)()(vf=Object(a.singleton)(bf.a)(vf=Reflect.metadata("design:type",Function)(vf=Reflect.metadata("design:paramtypes",[])(vf=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object(_f.d)())}setupTimer(e){Dd.b.TimeFlushNotiReact=e,Dd.b.TimeMaxWaiting=Object(_f.a)(),Dd.b.setupIntervalToFlushNotiReact(),Dd.b.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===ce.a.CONNECTED){const e=ce.b.getPreStateNetwork();e!==ce.a.CONNECTED&&e!==ce.a.NOT_SET&&this.changeTimeFlushNotiReact(Object(_f.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object(_f.e)())}changeTimeFlushNotiReact(e){Dd.b.notiReactTimeoutId?(Dd.b.TimeFlushNotiReact!==e&&(Dd.b.TimeFlushNotiReact=e,Dd.b.setupIntervalToFlushNotiReact()),Dd.b.TimeMaxWaiting!==Object(_f.a)()&&(Dd.b.TimeMaxWaiting=Object(_f.a)(),Dd.b.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||vf)||vf)||vf);var If=s("5cla"),yf=s("WV6O");class Sf{static resetNewFriendList(){delete this.newListFriend,this.newListFriend=void 0}static addNewFriendUid(e){void 0===this.newListFriend&&this.getNewFriendList(),this.newListFriend.push(e)}static getNewFriendList(){we.default.removeNewFriend("",!0);let e=[];try{const t=n.default.getInstance().getItemForCurrentUser("f_nf");t&&(e=JSON.parse(t))}catch(t){}this.newListFriend=e.map((e=>e.userId))}static getFriendList(e){const{userId:t}=e,s=[];return new Promise(((e,a)=>{Ii.default.getFriends().then((a=>{if(a){const i=Boolean(Me.g.getConfigShowAllUser(t));for(let e=0;e<a.length;e++)(1===a[e].isFr||a[e].isFr||a[e].userId===Ce.default.supportPage)&&a[e].userId!=t&&a[e].isValid&&a[e].userId!=Ce.default.sendToMeId&&(i||a[e].isActive||a[e].isActivePC||a[e].isActiveWeb)&&s.push(a[e].userId);e(s)}else e([])})).catch((e=>a(e)))}))}static getFriendInfo(e){var t;const{userId:s}=e,a=Ii.default.getProfileFriendSync(s);return a?(void 0===this.newListFriend&&this.getNewFriendList(),{userId:a.userId,avatar:a.avatar,displayName:a.displayName,isFr:a.isFr,zaloName:a.zaloName,bizPkg:a.bizPkg,bizInfo:a.bizInfo,isNewFriend:(null===(t=this.newListFriend)||void 0===t?void 0:t.includes(s))||!1,isBlocked:a.isBlocked}):null}}Sf.newListFriend=void 0;class Cf{static getGroupList(){return hn.default.getGroupsList()}static getGroupInfo(e){const{userId:t}=e;return new Promise(((e,s)=>{hn.default.getGroupById(t).then((t=>{e({userId:t.userId,avatar:t.avatar,displayName:t.displayName,topMember:t.topMember,totalMember:t.totalMember,creatorId:t.creatorId,type:t.type})})).catch(s)}))}static getGroupInfoSync(e){const{userId:t}=e,s=hn.default.getGroupByIdSync(t);return s?{userId:s.userId,avatar:s.avatar,displayName:s.displayName,topMember:s.topMember,totalMember:s.totalMember,creatorId:s.creatorId,type:s.type}:null}}class Ef{static getRecommendFriendList(){return new Promise(((e,t)=>{Cl.default.getRecommendedFriends().then((t=>e(t.recommItems))).catch(t)}))}static getRelatedGroup(e){return new Promise(((t,s)=>{Cl.default.getRelatedGroup(e).then(t).catch(s)}))}static getRequestedFriendList(){return new Promise(((e,t)=>{Cl.default.getRequestedFriends().then(e).catch(t)}))}static acceptAddFriend(e){return ye.a.acceptAddFriend(e)}static rejectAddFriend(e){return ye.a.rejectRequestAddFriend(e)}static makeUndoSentRequestFriend(e){return ye.a.undoRequestAddFriend(e.userId)}static removeSuggestFriend(e){return new Promise(((t,s)=>{Cl.default.removeRecommendedFriendV2(e.uid,e.src,e.type).then(t).catch(s)}))}}var Of;const Mf={currentView:yf.j.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[],newGroupInvitations:new Set,isUnread:!1}};Object(Ai.b)(If.b)(Of=Reflect.metadata("design:type",Function)(Of=Reflect.metadata("design:paramtypes",[])(Of=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=If.a,this.key=If.a,this.data.set(hr.c,Mf),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_updateState(e,t=hr.c,s=!0){this.data.set(t,e),s&&Object(Po.h)(this.name,t)}_getState(e=hr.c){return this.data.get(e)}_getAccessTime(){try{return JSON.parse(n.default.getInstance().getItemForCurrentUser(yf.g))}catch(e){return this.Logger.zsymb(18,"NBa6YB","[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){n.default.getInstance().setItemForCurrentUser(yf.g,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let a=[];try{a=JSON.parse(n.default.getInstance().getItemForCurrentUser(yf.i))||[]}catch(r){this.Logger.zsymb(18,"D5kMhu","[_setLastRequestFriendTime], error: "+JSON.stringify(r))}let i=[];switch(e){case"NEW":a.find((e=>(null==e?void 0:e.userId)===s))?(i=a.filter((e=>e.userId!==s)),i=[{ts:t,userId:s},...a]):i=[{ts:t,userId:s},...a];break;case"REMOVE":i=a.filter((e=>e.userId!==s))}n.default.getInstance().setItemForCurrentUser(yf.i,JSON.stringify(i))}_setLastReceivedGroupInvitationTime(e,t,s){let a=[];try{const e=n.default.getInstance().getItemForCurrentUser(yf.h);a=e&&JSON.parse(e)||[]}catch(r){this.Logger.zsymb(18,"ED4k-L","[_setListReceivedGroupInvitationTime], error: "+JSON.stringify(r))}let i=[];switch(e){case"NEW":a.some((e=>(null==e?void 0:e.groupId)==s))&&(i=a.filter((e=>e.groupId!=s))),i=[{ts:t,groupId:s},...a];break;case"REMOVE":i=a.filter((e=>(null==e?void 0:e.groupId)!==s))}n.default.getInstance().setItemForCurrentUser(yf.h,JSON.stringify(i))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(n.default.getInstance().getItemForCurrentUser(yf.i))}catch(t){this.Logger.zsymb(18,"Rea6Kc","[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_getLastReceivedGroupInvitationTime(){let e;try{const t=n.default.getInstance().getItemForCurrentUser(yf.h);e=t?JSON.parse(t):null}catch(t){this.Logger.zsymb(18,"Wq2Wml","[_getLastReceivedGroupInvitationTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(a.ModuleContainer.resolve(jo.SidebarController).updateSelectedId(null),e){case yf.j.FRIEND_LIST:Object(Ao.f)({type:ve.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case yf.j.GROUP_LIST:Object(Ao.f)({type:ve.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case yf.j.FRIEND_REQUEST:Object(Ao.f)({type:ve.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}});break;case yf.j.GROUP_INVITATION:Object(Ao.f)({type:ve.SideBarActions.SELECT_GROUP_INVITATION_CENTER,payload:{userId:"999"}})}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let a=s.unread;switch(t){case"FRIEND":s.currentView!==yf.j.FRIEND_REQUEST&&(a.newFriendRequests.push(e),a.isUnread=!0);break;case"GROUP":a.newGroupRequests.push(e);break;case"GROUP_INV":Ce.default.group_privacy.invitation_box.enable&&s.currentView!==yf.j.GROUP_INVITATION&&(a.newGroupInvitations.add(e),a.isUnread=!0)}this._updateState(Object(I.a)(Object(I.a)({},s),{},{unread:a}),hr.c,!0)}_clearUnreadOnOpenView(){const e=this._getState();if(!e)return;let t=e.unread;if(e.currentView===yf.j.GROUP_INVITATION){t.newGroupInvitations.size>0&&(t.isUnread=!1),t.newGroupInvitations.clear();const e=this._getLastReceivedGroupInvitationTime();e&&n.default.getInstance().setItemForCurrentUser(yf.h,JSON.stringify([e]))}else t.newFriendRequests.length+t.newGroupRequests.length>0&&(t.isUnread=!1),t.newFriendRequests=[],t.newGroupRequests=[];this._updateState(Object(I.a)(Object(I.a)({},e),{},{unread:t}),hr.c,!0)}_clearGroupInvitationUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newGroupInvitations.delete(e);0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),hr.c,!0)}_clearFriendRequestUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newFriendRequests=s.newFriendRequests.filter((t=>t!==e));0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),hr.c,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",Sf.resetNewFriendList(),a.ModuleContainer.resolve(If.b).resetData(),a.ModuleContainer.resolve(If.g).resetData(),a.ModuleContainer.resolve(If.f).resetData(),a.ModuleContainer.resolve(If.l).resetData(),a.ModuleContainer.resolve(If.j).resetData(),a.ModuleContainer.resolve(If.o).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(I.a)(Object(I.a)({},e),{},{currentView:yf.j.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(I.a)(Object(I.a)({},t),{},{currentView:e}),hr.c,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||Mf.currentView;this._onChangeView(t)}}onContactTab(e){a.ModuleContainer.resolve(If.c).onOpenContactTab(e),this._setAccessTime(e),this._clearUnreadOnOpenView()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime(),s=this._getLastReceivedGroupInvitationTime();if(!t)return Ce.default.group_privacy.invitation_box.enable&&s&&s.ts>=Ct.default.getTimeNow()-Ce.default.group_privacy.invitation_box.max_auto_focus_time?this.currentTab=yf.j.GROUP_INVITATION:this.currentTab=yf.j.FRIEND_LIST,this.currentTab;const a=!Ce.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,i=t.ts<Ct.default.getTimeNow()-864e5;return Ce.default.group_privacy.invitation_box.enable&&s&&s.ts>t.ts&&s.ts>=Ct.default.getTimeNow()-Ce.default.group_privacy.invitation_box.max_auto_focus_time?(this.currentTab=yf.j.GROUP_INVITATION,this.currentTab):(this.currentTab=i&&a?yf.j.FRIEND_LIST:yf.j.FRIEND_REQUEST,this.currentTab)}getState(e){return this._getState(e)||Mf}clearFriendRequestUnread(e){const t=this._getState();if(e.length>0&&t){const s=new Set(e),a=t.unread,i=a.newFriendRequests.filter((e=>!s.has(e)));i.length!==a.newFriendRequests.length&&(a.newFriendRequests=i,a.isUnread=a.newFriendRequests.length>0||a.newGroupInvitations.size>0,this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:a}),hr.c,!0))}for(const s of e)this._setLastRequestFriendTime("REMOVE",0,s)}clearGroupInvitationUnread(e){const t=this._getState();if(e.length>0&&t){const s=t.unread,a=new Set(s.newGroupInvitations.values());e.forEach((e=>a.delete(e))),a.size!==s.newGroupInvitations.size&&(s.newGroupInvitations=a,s.isUnread=s.newFriendRequests.length>0||s.newGroupInvitations.size>0,this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),hr.c,!0))}for(const s of e)this._setLastReceivedGroupInvitationTime("REMOVE",0,s)}onUpdateRequestTracking(e,t,s,a){switch("NEW"===t?this._onUpdateUnreadRequest(a,e):"REMOVE"===t&&(Ce.default.group_privacy.invitation_box.enable&&"GROUP_INV"===e&&a?this._clearGroupInvitationUnreadItem(a):this._clearFriendRequestUnreadItem(a)),e){case"FRIEND":this._setLastRequestFriendTime(t,s||0,a);break;case"GROUP":default:break;case"GROUP_INV":Ce.default.group_privacy.invitation_box.enable&&this._setLastReceivedGroupInvitationTime(t,s||0,a)}}computeUpdateUnread(){const e=this._getState();let t=(null==e?void 0:e.unread)||Mf.unread;const s=(null==e?void 0:e.currentView)||Mf.currentView,a=this._getAccessTime(),i=this._getLastRequestAddFriendTime(),n=this._getLastReceivedGroupInvitationTime();a&&(i&&a<i.ts&&t.newFriendRequests.push(i.userId),Ce.default.group_privacy.invitation_box.enable&&n&&a<n.ts&&t.newGroupInvitations.add(n.groupId),t.isUnread=t.newFriendRequests.length>0||t.newGroupInvitations.size>0,this._updateState({currentView:s,unread:t},hr.c,!0))}onInitUnreadRequest(){this.computeUpdateUnread()}onReceivedControlEvents(e){for(const t of e)if(t.act===yf.a.CLICKED)t.data.ts_clicked&&(this._setAccessTime(t.data.ts_clicked),this._clearUnreadOnOpenView());else this.Logger.zsymb(18,"oXglAV","unhandled event",t)}})||Of)||Of);var Tf,wf=s("iq5K"),Rf=s("d++c");Object(Ai.b)(If.g)(Tf=Object(a.injectable)()(Tf=function(e,t){return a.ModuleContainer.inject(If.f)(e,void 0,0)}(Tf=function(e,t){return a.ModuleContainer.inject(jo.LabelDataManager)(e,void 0,1)}(Tf=Reflect.metadata("design:type",Function)(Tf=Reflect.metadata("design:paramtypes",[void 0===If.f?Object:If.f,void 0===jo.LabelDataManager?Object:jo.LabelDataManager])(Tf=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=If.e,this.key=If.e,this.listState=wf.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Po.i)(this.name,"all")}_signalRenderItem(){Object(Po.h)(this.name,"all")}_signalRenderBoth(){Object(Po.h)(this.name,"all"),Object(Po.i)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),Sf.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((a=>{if(this.friendInfoManager.onLoadInfo({userId:a}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===a));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(a),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=_e.default.on(ve.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener(jo.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(jo.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(jo.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Ii.default.unsubscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener(jo.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(jo.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(jo.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await Sf.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(wf.g.searching.searchText,wf.g.searching.sorter,wf.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(wf.g.searching.searchText,wf.g.searching.sorter,wf.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,"ZqZQlB","[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return Object(Rf.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!un.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===wf.p.DEFAULT)return t;return t.sort(((t,s)=>{const a=this._getItemInfo(t),i=this._getItemInfo(s);return((t,s)=>{const a=/^[a-zA-Z]/,i=a.test(ui.default.simpleStripVietnamese(t)),n=a.test(ui.default.simpleStripVietnamese(s));switch(e){case wf.p.ALPHA_INCREASE:return!i&&n?1:i&&!n?-1:t.localeCompare(s);case wf.p.ALPHA_DECREASE:return!i&&n?-1:i&&!n?1:s.localeCompare(t);default:return 0}})((null==a?void 0:a.displayName.toLowerCase())||(null==a?void 0:a.zaloName.toLowerCase())||"",(null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let a=e.length-1;a>=0;a--){const i=this._getItemInfo(e[a]);null!=i&&i.isNewFriend?t.unshift(null==i?void 0:i.userId):s.unshift(null==i?void 0:i.userId)}return[...t,...s]}_handleFilter(e,t,s,a,i){var n;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onFilterHidden(i,e,r),a&&(r=this.onMovingNewFriend(r)),r}_checkDidSort(e){return e!==wf.p.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(wf.g.searching.searchText,wf.g.searching.sorter,wf.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const a=this._checkDidSort(t);a&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!a,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:wf.p.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||Tf)||Tf)||Tf)||Tf)||Tf);var Lf;Object(Ai.b)(If.f)(Lf=Reflect.metadata("design:type",Function)(Lf=Reflect.metadata("design:paramtypes",[])(Lf=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=If.d,this.key=If.d}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=Sf.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(Po.h)(this.name,e.userId))}loadInfoNotRender(e){const t=Sf.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Lf)||Lf);var Df;Object(Ai.b)(If.l)(Df=Object(a.injectable)()(Df=function(e,t){return a.ModuleContainer.inject(If.j)(e,void 0,0)}(Df=function(e,t){return a.ModuleContainer.inject(En.PreviewDataManager)(e,void 0,1)}(Df=function(e,t){return a.ModuleContainer.inject(jo.LabelDataManager)(e,void 0,2)}(Df=Reflect.metadata("design:type",Function)(Df=Reflect.metadata("design:paramtypes",[void 0===If.j?Object:If.j,void 0===En.PreviewDataManager?Object:En.PreviewDataManager,void 0===jo.LabelDataManager?Object:jo.LabelDataManager])(Df=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=If.i,this.key=If.i,this.listState=wf.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Po.i)(this.name,"all")}_signalRenderItem(){Object(Po.h)(this.name,"all")}_signalRenderBoth(){Object(Po.h)(this.name,"all"),Object(Po.i)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await Cf.getGroupList(),t=e.map((e=>e.userId));this.listGroup=t,this.initListGroup=t,this.listState.totalRecord=t.length,this.groupInfoManager.setMultiGroupInfo(e),this.listGroup=this._handleFilter(wf.h.searching.searchText,wf.h.searching.sorter,wf.h.searching.filter,!1),this.initListGroup=this._handleFilter(wf.h.searching.searchText,wf.h.searching.sorter,wf.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,"9eWPnh","[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return Object(Rf.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&!Dl.q.isCommunityFromInfo(s)}))}onFilterMyAdminCommunity(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&Dl.q.isCommunityFromInfo(s)}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===wf.p.DEFAULT||e===wf.p.ACTION_INCREASE||e===wf.p.ACTION_DECREASE?t:t.sort(((t,s)=>{const a=this._getItemInfo(t),i=this._getItemInfo(s),n=(null==a?void 0:a.displayName.toLowerCase())||"",r=(null==i?void 0:i.displayName.toLowerCase())||"";switch(e){case wf.p.ALPHA_INCREASE:return n.localeCompare(r);case wf.p.ALPHA_DECREASE:return r.localeCompare(n);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!un.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===wf.p.DEFAULT||e===wf.p.ALPHA_INCREASE||e===wf.p.ALPHA_DECREASE?t:t.sort(((t,s)=>{var a,i;const n=(null===(a=this.previewDataManager.getPreviewByIDSync(t))||void 0===a?void 0:a.messageTime)||0,r=(null===(i=this.previewDataManager.getPreviewByIDSync(s))||void 0===i?void 0:i.messageTime)||0;switch(e){case wf.p.ACTION_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case wf.p.ACTION_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}_handleFilter(e,t,s,a){var i;let n=[];return n=this.onFilterByName(e),n=this.onFilterByLabel(null==s||null===(i=s.label)||void 0===i?void 0:i.convs,n),n=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",n),s&&s.adminComm&&(n=this.onFilterMyAdminCommunity(s.adminComm,n)),n=this.onFilterAll(n),n=this.onSortAlpha(t,n),n=this.onSortActionTime(t,n),n=this.onFilterHidden(a,e,n),n}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((a=>{if(this.groupInfoManager.onLoadInfo({userId:a}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===a));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(a),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){hn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener(jo.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(jo.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(jo.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){hn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener(jo.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(jo.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(jo.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:wf.p.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||Df)||Df)||Df)||Df)||Df)||Df);var Af;Object(Ai.b)(If.j)(Af=Reflect.metadata("design:type",Function)(Af=Reflect.metadata("design:paramtypes",[])(Af=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=If.h,this.key=If.h}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=Cf.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(Po.h)(this.name,e.userId))}loadInfoNotRender(e){const t=Cf.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}setMultiGroupInfo(e){for(const t of e)this.data.set(t.userId,t)}openGroupMemberPopup(e){const t=this.data.get(e);Ie.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||Af)||Af);let Ff=function(e){return e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE",e}({});const kf=500,Nf=500;var Pf;Object(Ai.b)(If.o)(Pf=function(e,t){return a.ModuleContainer.inject(If.b)(e,void 0,0)}(Pf=Reflect.metadata("design:type",Function)(Pf=Reflect.metadata("design:paramtypes",[void 0===If.b?Object:If.b])(Pf=class extends hs.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=If.m,this.key=If.m,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(Po.h)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:a=[],listFriendSent:i=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":n||0!==s.length||0!==a.length||(n=!0);break;case"OFF":n&&(n=!1)}if("RequestedFriendList"===e)switch(t){case"ON":r||0!==i.length||(r=!0);break;case"OFF":r&&(r=!1)}this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await Ef.getRequestedFriendList();Date.now()-e<kf&&await Object(Rf.b)(Nf),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,a;const i=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,n=null===(a=t.fReqInfo)||void 0===a?void 0:a.time;return n>i?1:n<i?-1:0})),{listFriendReceived:a=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}catch(t){Date.now()-e<kf&&await Object(Rf.b)(Nf),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,"cOJAE6","[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await Ef.getRecommendFriendList();if(Date.now()-e<kf&&await Object(Rf.b)(Nf),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===Ff.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===Ff.RECOMMEND})),{listFriendSent:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{};this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:a,listFriendSuggest:s,mapRelatedGroup:i})),s.length>0&&this.dispatchEvent(new yf.f(yf.e.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<kf&&await Object(Rf.b)(Nf),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,"AqZGqT","[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var a,i,n,r,o,l;const c=t[null===(a=e.dataInfo)||void 0===a?void 0:a.userId]&&t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId].length,d=(null===(n=e.dataInfo)||void 0===n?void 0:n.displayName)||"",u=t[null===(r=s.dataInfo)||void 0===r?void 0:r.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,h=(null===(l=s.dataInfo)||void 0===l?void 0:l.displayName)||"";return c&&u?c===u?d.localeCompare(h):u>c?1:-1:c&&!u?-1:!c&&u?1:c||u?0:d.localeCompare(h)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await Ef.getRelatedGroup(t),{listFriendReceived:a=[],listFriendSent:i=[]}=this.data.get("all")||{},n=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:i,listFriendSuggest:n,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,"wRjroS","[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:a=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const i=Ii.default.getDName(e),n=t.findIndex((t=>t.dataInfo.userId===e));-1!==n&&(t[n].displayName=i);const r=s.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(s[r].displayName=i);const o=a.findIndex((t=>t.userId===e));-1!==o&&(a[o].displayName=i)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let a=0;a<t.length;a++){var s;const i=t[a].ts,n="add"===t[a].act&&t[a].data||(null===(s=t[a].data)||void 0===s?void 0:s.fromUid),r=n===e.userId;if(i&&n&&!r&&"fr"===t[a].act_type)switch(t[a].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",i,n);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new yf.f(yf.e.UndoAddFriendEvent,"",n));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new yf.f(yf.e.AcceptAddFriendEvent,"",n));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new yf.f(yf.e.RejectAddFriendEvent,"",n))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let a={};a.userId=s[e].userId,a.zaloName=s[e].zaloName,a.avatar=s[e].avatar,a.displayName=s[e].displayName,a.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},a.recommTime=s[e].friendRequestFetchTime,a.recommType=s[e].friendRequestType,t.push({dataInfo:a,recommItemType:1})}this.dispatchEvent(new yf.f(yf.e.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(yf.e.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(yf.e.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),Ii.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=e.concat(t);this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{Ef.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,"s8CrF7","[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{Ef.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,"k6g8du","[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:n,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}onRemoveFriendSent(e){Ef.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,"UourMe","[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?Wo.default.createError(le.a.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?Wo.default.createError(le.a.str("STR_CHECK_NET")):Wo.default.createError(le.a.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=a.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:i})),this._signalRenderItem()}onAddFriendSuggest(e){ng.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,"ccCZxk","[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){Ef.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,"hF5UsJ","[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){Ie.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:a={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:a})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:a={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:a})),this._signalRenderItem()}}markSeenFriendRequests(e){const t=this.data.get("all")||{},{listFriendReceived:s=[]}=t;if(e.length>0&&s.length>0){const a=new Set(e);let i=!1;for(const e of s){const t=e.dataInfo;t&&!t.isSeenFriendReq&&a.has(t.userId)&&(e.dataInfo.isSeenFriendReq=!0,i=!0)}i&&(this.data.set("all",Object(I.a)(Object(I.a)({},t),{},{listFriendReceived:s})),this._signalRenderItem())}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Pf)||Pf)||Pf);var jf,Uf=s("2x/M"),Bf=s("FhUL"),zf=s("zU/x"),Gf=s("dhU0"),xf=s("2e02"),Vf=s("HnA5");function Hf(e){return{avatar:e.avatar,displayName:Ii.default.getDName(e.id)||e.dName||e.zaloName,userId:e.id,zaloName:e.zaloName,type:e.type}}Object(Ai.b)(xf.b)(jf=Reflect.metadata("design:type",Function)(jf=Reflect.metadata("design:paramtypes",[])(jf=class extends hs.b{constructor(){super(),this.name=void 0,this.key=void 0,this._Logger=void 0,this.data=void 0,this.metadata=void 0,this.timer=void 0,this.isOpeningInvitationBox=void 0,this.handleNetworkStatusChange=e=>{e===ce.a.CONNECTED&&0===this.data.size&&this.getReceivedInvitations({page:0})},this.name=xf.a,this.key="groupId",this.data=new Map,this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.timer={instance:new x.b,intervalId:null},this.isOpeningInvitationBox=!1}init(){throw new Error("Method not implemented.")}getList(){return Array.from(this.data.keys())}getItem(e){const t=this.data.get(e.key);return t||this.Logger.zsymb(5,"f-1e2l",["try to get item not exist in cache {}","XkWqJN"],e.key),t}onGetItemFailure(e){this.Logger.zsymb(18,"PujRaI","Get group invitation item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(18,"OwBdRK","Get group invitation list failed",e)}signalUpdateList(){Object(Po.i)(this.name,"all")}signalUpdateItem(e){Object(Po.h)(this.name,e)}signalUpdateListMeta(){this.dispatchEvent(new yf.d(yf.b.UpdateUIListMetadata,this.metadata))}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}async getCreatorInfos(e){const t=await Ii.default.getProfileFriendForGroup(Object.fromEntries(e.map((e=>[e.creatorId||e,0]))));return new Map(e.map((e=>[e.groupId,t[e.creatorId]])))}async getCreatorInfoForGroup(e){return Ii.default.getProfileFriendForGroup({[e]:0})}startTimer(){this.stopTimer(),this.timer.intervalId=window.setInterval((()=>this.timer.instance.publish(Ct.default.getTimeNow())),yf.c.COUNT_INTERVAL)}stopTimer(){null!==this.timer.intervalId&&window.clearInterval(this.timer.intervalId),this.timer.intervalId=null}getTimer(){return this.timer.instance}isValidInvitation(e){var t;return!!(null!==(t=e.groupInfo)&&void 0!==t&&t.groupId&&e.grCreatorInfo&&e.inviterInfo)&&e.expiredTs-Ct.default.getTimeNow()>0}convertToGroupInvitation(e){const t=Y.GROUPID_PREFIX+e.groupInfo.groupId,s=function(e){return{avatar:e.avt,creatorId:e.creatorId,displayName:e.name,name:e.name,setting:e.setting,adminIds:e.adminIds,totalMember:e.totalMember,userId:e.groupId,type:e.type,topMember:e.currentMems.map(Hf),isGroup:!0}}(e.groupInfo),a=Hf(e.inviterInfo),i=Hf(e.grCreatorInfo);return Object(I.a)(Object(I.a)({},e),{},{groupId:t,groupInfo:s,inviterInfo:a,grCreatorInfo:i})}async loadServerReceivedInvitations(){var e;const{invitations:t,hasMore:s,total:a}=await Cl.default.getGroupInvitationList(this.metadata.page,Ce.default.group_privacy.invitation_box.paging_limit,Ce.default.group_privacy.invitation_box.mcount_item,null===(e=this.metadata)||void 0===e?void 0:e.lastGroupId);this.metadata=Object(I.a)(Object(I.a)({},this.metadata),{},{hasMore:s,total:a});const i=await this.getCreatorInfos(t.map((e=>e.groupInfo))),n=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.grCreatorInfo||(e.grCreatorInfo=i.get(e.groupInfo.groupId)),this.isValidInvitation(e)){const s=Y.GROUPID_PREFIX+e.groupInfo.groupId,a=this.convertToGroupInvitation(e);n.push(a),r===t.length-1&&(this.metadata.lastGroupId=s)}}return n}onInvitationListUIAppear(){this.isOpeningInvitationBox=!0,this.startTimer(),this.getReceivedInvitations({page:0}).catch((e=>{this.Logger.zsymb(18,"0gQR8j","Init load invitation failed",e)})).finally((()=>{this.metadata.loading&&(this.metadata.loading=!1,setTimeout((()=>{this.signalUpdateListMeta()}),300))})),J.p.listenEvent(J.k,this.handleNetworkStatusChange)}onInvitationListUIDisappear(){this.stopTimer(),this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.data.clear(),J.p.removeListenEvent(J.k,this.handleNetworkStatusChange),this.isOpeningInvitationBox=!1}getUIListMeta(){return this.metadata}async getReceivedInvitations(e={}){const{page:t=0}=e;if(!this.metadata.hasMore)return[];this.metadata.page=t,this.data=new Map(this.data);const s=await this.loadServerReceivedInvitations();return s.forEach((e=>{this.data.set(e.groupId,e)})),this.signalUpdateListMeta(),this.signalUpdateList(),s}async loadMoreReceivedInvitations(){const e=Ce.default.group_privacy.invitation_box.paging_limit,t=Math.trunc(this.data.size/e);return this.getReceivedInvitations({page:t})}handleNewInvitation(e,t){this.metadata.total+=1,this.data=new Map([[e,t],...Array.from(this.data.entries())]),this.signalUpdateListMeta(),this.signalUpdateList()}async acceptInvitation(e,t){try{if(e.type===Bf.a.PENDING_REVIEW)throw{error_code:zf.a.WAITING_APPROVE};const t=ui.default.getRawGroupId(e.groupId);await Cl.default.joinGroupFromInvitation(t),this.Logger.zsymb(2,"Ml3nMI","Join group success",e.groupId),a.ModuleContainer.resolve(Q.b).openConversation(e.groupId,Q.d.fromGroupInvitation()),this.deleteInvitationsFromCache([e.groupId])}catch(s){this.Logger.zsymb(18,"2Cjwy3","Join group failed",e.groupId,s),this.handleJoinInvitationError(e,null==s?void 0:s.error_code,t)}}async rejectInvitation(e,t={}){try{if(e.type===Bf.a.PENDING_REVIEW)throw{error_code:zf.a.WAITING_APPROVE};const s=ui.default.getRawGroupId(e.groupId);await Cl.default.deleteGroupInvitation([{grid:s}],t.blockGroup),this.Logger.zsymb(2,"I4YUmM","Reject group invitation success",e.groupId,t),t.blockInviter&&Ii.default.blockFriend(e.inviterInfo.userId,Y.SET_BLOCK),this.deleteInvitationsFromCache([e.groupId]),Wo.default.createInfo(le.a.str(Vf.a.get("STR_GROUP_INVITATION_DELETED",e.groupInfo)))}catch(s){this.Logger.zsymb(18,"FfsF1T","Reject group invitation failed",e.groupId,s),Wo.default.createError(le.a.str("STR_ERROR_OCCUR"))}}async deleteInvitations(e){const t=e.map((e=>({grid:ui.default.getRawGroupId(e.groupId)})));try{await Cl.default.deleteGroupInvitation(t,!1),this.Logger.zsymb(2,"W52lYS","Delete group invitations success",t),this.deleteInvitationsFromCache(e.map((e=>e.groupId)))}catch(s){this.Logger.zsymb(18,"6xnPfs","Delete group invitations failed",t,s),Wo.default.createError(le.a.str("STR_ERROR_OCCUR"))}}deleteInvitationsFromCache(e){let t=0;for(const s of e)this.data.has(s)&&(this.data.delete(s),t+=1);0!==t&&(this.metadata.total=Math.max(this.metadata.total-t,0),this.signalUpdateListMeta(),this.signalUpdateList(),this.metadata.hasMore&&this.data.size<Ce.default.group_privacy.invitation_box.paging_limit&&this.loadMoreReceivedInvitations())}getInvitationSync(e){return this.data.get(e)||null}getInvitation(e){return new Promise((t=>{const s=ui.default.getRawGroupId(e);Cl.default.getGroupInvitationInfo(s).then((e=>{e.grCreatorInfo?t(this.convertToGroupInvitation(e)):this.getCreatorInfoForGroup(e.groupInfo.creatorId).then((s=>{e.grCreatorInfo=s,t(this.convertToGroupInvitation(e))})).catch((()=>t(null)))})).catch((s=>{this.Logger.zsymb(18,"EuKjKB","Get invitation info failed",e,s),t(null)}))}))}updateInvitationFromCache(e){const{groupId:t}=e;this.data.has(t)&&this.data.set(t,e)}updateInvitationStatus(e,t){const s=this.data.get(e);if(s){const a=Object(I.a)(Object(I.a)({},s),{},{type:t});this.updateInvitationFromCache(a),this.data.set(e,a),this.signalUpdateItem(e)}}onReceivedInvitationEvents(e,t){const s=t.groupId;if(!s)return;const i=Y.GROUPID_PREFIX+s;switch(this.Logger.zsymb(0,"bUq6j7","Received new event",e,i),e){case Uf.b.NEW_INVITATION:this.isOpeningInvitationBox&&this.getInvitation(i).then((e=>{e&&this.handleNewInvitation(i,e)})).catch((e=>{this.Logger.zsymb(18,"r0v1LN","Load new invitation item by event failed",i,e)})),a.ModuleContainer.resolve(Gf.b).onUpdateRequestTracking("GROUP_INV","NEW",Ct.default.getTimeNow(),i);break;case Uf.b.UPDATE_INVITATION:const e=this.data.get(i);"number"==typeof t.invitationType&&(null==e?void 0:e.type)!==t.invitationType&&this.updateInvitationStatus(i,t.invitationType);break;case Uf.b.REMOVE_INVITATION:this.deleteInvitationsFromCache([i]),a.ModuleContainer.resolve(Gf.b).onUpdateRequestTracking("GROUP_INV","REMOVE",Ct.default.getTimeNow(),i)}}handleJoinInvitationError(e,t,s){switch(t){case zf.a.WAITING_APPROVE:this.updateInvitationStatus(e.groupId,Bf.a.PENDING_REVIEW),Wo.default.createInfo(le.a.str(Vf.a.get("STR_GROUP_INVITATION_JOIN_ERR_240",e.groupInfo)));break;case zf.a.EXCEED_MAX_GROUP:case zf.a.CANNOT_CHANGE:case zf.a.BANNED:case zf.a.NOT_PERMITTED:Wo.default.createInfo(le.a.str(Vf.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case zf.a.NOT_EXIST:case zf.a.ALREADY_MEMBER:case zf.a.EXPIRED:this.deleteInvitationsFromCache([e.groupId]),Wo.default.createInfo(le.a.str(Vf.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:case Y.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:Ce.default.group_privacy.community.enable_upgrade?a.ModuleContainer.resolve(Dl.e).onReceivedCommunityError({errorCode:t,windowId:s,groupId:e.groupId}):Wo.default.createError(le.a.str("STR_ERROR_OCCUR"));break;default:Wo.default.createError(le.a.str("STR_ERROR_OCCUR"))}}})||jf)||jf);var Wf;Object(m.j)()(Wf=Object(m.h)()(Wf=Object(m.d)()(Wf=Object(a.singleton)(If.c)(Wf=class{constructor(){this.logger=void 0,this.handleFetchClearUnread=async()=>{if(Ce.default.contactTabV2.seen_friendrequest){this.Logger.zsymb(18,"d-56fK","overflow queue -> fetch clear unread");try{const{ts:e}=await Cl.default.getLastReadContactTab(),t=this.getLastCachedAccessTs();"number"==typeof e&&e>t&&(this.Logger.zsymb(0,"CvsvIc",`do reinit unread lastTs=${t} ts=${e}`),n.default.getInstance().setItemForCurrentUser(yf.g,String(e)),a.ModuleContainer.resolve(If.b).computeUpdateUnread())}catch(e){this.Logger.zsymb(18,"0eeyHx","fetch clear unread fail",e)}}}}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.contactTabV2,["unread-manager"])),this.logger}getLastCachedAccessTs(){const e=n.default.getInstance().getItemForCurrentUser(yf.g);return e&&!isNaN(+e)?+e:0}clearFriendRequestUnread(e,t=!1){a.ModuleContainer.resolve(If.o).markSeenFriendRequests(e),a.ModuleContainer.resolve(If.b).clearFriendRequestUnread(e),t&&Cl.default.sendClearUnreadFriendRequest(e).then((()=>{this.Logger.zsymb(0,"_i_vKI","sync read friend req tab success total=",e.length)})).catch((e=>{this.Logger.zsymb(18,"l04veu","sync read friend req tab fail",e)}))}onStart(){J.p.listenEvent(J.n,this.handleFetchClearUnread)}onApplicationReady(){a.ModuleContainer.resolve(If.b).onInitUnreadRequest()}onDispose(){J.p.removeListenEvent(J.n,this.handleFetchClearUnread)}onOpenContactTab(e){const t=a.ModuleContainer.resolve(If.b).getState(hr.c).unread,s=t.isUnread&&t.newFriendRequests.length>0&&Ce.default.contactTabV2.seen_friendrequest;this.Logger.zsymb(0,"QQFz9c",`open contact tab -> friend req=${t.newFriendRequests.length} group inv=${t.newGroupInvitations.size}`),s&&Cl.default.readContactTab(e).then((()=>{this.Logger.zsymb(0,"ZGSyBh","sync read contact tab success",e)})).catch((t=>{this.Logger.zsymb(18,"Aeaa9p","sync read contact tab fail",e,t)}))}onOpenFriendRequestTab(e){const t=e.filter((({dataInfo:e})=>e&&!e.isSeenFriendReq)).map((({dataInfo:e})=>e.userId));t.length>0&&this.clearFriendRequestUnread(t,!!Ce.default.contactTabV2.seen_friendrequest)}onOpenGroupInvitationTab(){const e=a.ModuleContainer.resolve(If.b),t=e.getState(hr.c).unread;if(t.newGroupInvitations.size){const s=Array.from(t.newGroupInvitations);e.clearGroupInvitationUnread(s)}}onSeenBannerFriendRequest(e){if(Ce.default.contactTabV2.seen_friendrequest&&Ce.default.contactTabV2.seen_friendrequest_chat_view){a.ModuleContainer.resolve(If.b).getState(hr.c).unread.newFriendRequests.includes(e)&&this.clearFriendRequestUnread([e],!0)}}onSeenFriendRequests(e){Ce.default.contactTabV2.seen_friendrequest&&this.clearFriendRequestUnread(e,!1)}})||Wf)||Wf)||Wf);var qf=s("akSd"),Kf=s("fqRP"),$f=s("L904"),Zf=s("EiAw"),Qf=s("IoRb"),Yf=s("CzFt");let Jf;class Xf{static get instance(){return Jf||(Jf=new Xf),Jf}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,a=[];if(e.ok?({conversation:t,toUid:s,allItems:a}=e.value):({conversation:t,toUid:s,allItems:a}=e.error),t)return;if(a.length&&a.every((e=>e.ttlType===Ad.a.Quote)))return;const i={type:ve.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(i),Yf.a.dispatch(i),_e.default.send(i.type,i.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const a=s.filter((e=>e.ttlType===Ad.a.Message)),i=a.map((e=>e.msgId));Object(Zf.a)({msgId:i,conversation:t,messages:a.map((e=>JSON.parse(JSON.stringify(e)))),trackingSource:"ttlPrune"})},this._emitUpdateUnread=(e,t)=>{let s,a=[];e.ok?({toUid:s,allItems:a}=e.value):({toUid:s,allItems:a}=e.error),me.a.UnreadDataManager.updateUnreadTTLConversation(s,a,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(qp.a)(this._emitConversationDeleted,e);s.ok||Object(Qf.a)("_emitConversationDeleted failed",s.error),s=await Object(qp.a)(this._emitDeletedMsgs,e),s.ok||Object(Qf.a)("_emitDeletedMsgs failed",s.error),s=await Object(qp.a)(this._emitUpdateUnread,e,t),s.ok||Object(Qf.a)("_emitUpdateUnread failed",s.error)}}}var ev,tv=s("LA52"),sv=s("GSaP");const av=e=>null==e?void 0:e.toUid,iv=e=>null!=e&&e.ok?"success":"error";Object(a.singleton)(tv.a)(ev=Reflect.metadata("design:type",Function)(ev=Reflect.metadata("design:paramtypes",[])(ev=class{constructor(){this._pruning=!1,this._task=void 0,this._ttl=a.ModuleContainer.resolve(Kf.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=Ct.default.getTimeNow();this._logger.zsymb(0,"MZ5bqG","Pruner execute task",e);const t=await Object(qp.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,"z98yBC","Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(gi.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,"XmN0gx",["running a batch {}","ZhoaKp"],e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=Ct.default.getTimeNow();this._logger.zsymb(15,"5310iu",["deriving {}","1k65N5"],e.length);let s=sv.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,"9JwAiJ",["ttlItems count: {}","TP97ts"],s.length),s=s.filter((e=>{const s=+e.expireOn+Ce.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,"kXZmhW",["expired count: {}","3b79mg"],s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,"BWREaC",["no cache count: {}","zYIiiA"],s.length),s.length?(this._logger.zsymb(3,"3jM-dv",["pruning {}, {}","9tXhQX"],s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,"RJP9I7",["no items to prune","fpnitV"])},this._pruneMsgCache=new u.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,"TkEuxQ",["pruning {} items: {}","NdSAXC"],t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(qp.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,"tFLiFO","Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:a}=s.error;this._logger.zsymb(0,"YkzqhT","_retryErrorDelete "+a,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(qp.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(qp.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,"QMIRSl","Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(qp.b)(Xf.instance.emitPerConversation,s,t)},this._deletePerConversation=async(e,t=[])=>{var s,a,i,n,r,o,l,c,d;const u=await Object(qp.b)(hd.b.vanishMessages,e,t);if(!u.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const h=null===(s=u.value.vanish)||void 0===s?void 0:s[0],g=null===(a=u.value.quote)||void 0===a?void 0:a[0];if(!h&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(i=u.value.vanish)||void 0===i||null===(n=i[0])||void 0===n||null===(r=n.conv)||void 0===r?void 0:r.conversation;let p=[...null!==(o=null===(l=u.value.vanish)||void 0===l?void 0:l.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(c=null===(d=u.value.quote)||void 0===d?void 0:d.flat())&&void 0!==c?c:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object($f.a)(p,iv),_=f.map((e=>e.info)),b=v.map((e=>e.info)),I=[..._,...b];return b.length?{ok:!1,error:{toUid:e,conversation:m,allItems:I,successItems:_,errorItems:b}}:{ok:!0,value:{toUid:e,conversation:m,allItems:I,successItems:_}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object($f.a)(e,av),s=Object.keys(t).map((async e=>(Object(qp.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async(e,t=[])=>setTimeout((async()=>{const s=await Object(qp.b)(this._cancelSendingPerConversation,e,t);s.ok||this._logger.zsymb(18,"3Awp0g","cancelSendingPerConversation failed",s.error);const a=await Object(qp.b)(this._syncDeletePerConversation,e,t);a.ok||this._logger.zsymb(18,"evR380","syncDeletePerConversation failed",a.error)}),0),this._cancelSendingPerConversation=async(e,t=[])=>{t.forEach((t=>Object(qp.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async(e,t=[])=>{if(!Ce.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(qf.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(qp.b)(s,e)))},this._pruning=!1,this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(qp.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,"oLjHl_","Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||ev)||ev);s("Ceyj");var nv,rv=s("K0f4"),ov=s("buT3"),lv=s("wudS");Object(m.j)()(nv=Object(m.f)()(nv=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(lv.d)(t),s=`${e}_${rv.m}`,a=ov.a.getItem(s);if(!(null!==a))return;const i=97124,n="1"===a,r=`${e}_${rv.g}`,o=+(ov.a.getItem(r)||"-1"),l=isNaN(o)?-1:o,c=`${e}_${rv.i}`,d=+(ov.a.getItem(c)||"-1"),u=isNaN(d)?-1:d;if(n)ul.default.increaseSuccess(i,0,l,[u]);else{const t=`${e}_${rv.c}`,s=ov.a.getItem(t),a=Number(s);ul.default.increaseFailed(i,0,l,a,Date.now(),[u])}ov.a.removeItem(s),ov.a.removeItem(r),ov.a.removeItem(c)}}onStart(){const e=rv.l,t=ov.a.getItem(e);if(!(null!==t))return;const s="1"===t,a=rv.f,i=+(ov.a.getItem(a)||"-1"),n=isNaN(i)?-1:i,r=rv.h,o=+(ov.a.getItem(r)||"-1"),l=isNaN(o)?-1:o;if(s)ul.default.increaseSuccess(97123,0,n,[l]);else{const e=ov.a.getItem(rv.b),t=Number(e);ul.default.increaseFailed(97123,0,n,t,Date.now(),[l])}ov.a.removeItem(e),ov.a.removeItem(a),ov.a.removeItem(r)}})||nv);var cv,dv=s("l9L4"),uv=s("CDcE");Object(m.d)()(cv=Object(a.injectable)()(cv=Object(a.singleton)(dv.a)(cv=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(cv=Reflect.metadata("design:type",Function)(cv=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(cv=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=n.default.getInstance().getItemForCurrentUser(Y.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,"IbMRo6",["getFirstLoginTime error {} - {}","LfDI2O"],e,Object(uv.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{n.default.getInstance().setItemForCurrentUser(Y.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,"jehwMU",["setFirstLoginTime error {} - {} - {}","NS27yx"],e,t,Object(uv.f)(s,2))}}removeFirstLoginFlag(){const e=Ii.default.getUidMe(),t=n.default.getInstance();t.getItem(Y.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(Y.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return Ct.default.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||cv)||cv)||cv)||cv)||cv);let hv=function(e){return e.USER_OFFLINE="USER_OFFLINE",e}({});class gv extends hs.a{constructor(){super(hv.USER_OFFLINE)}}var mv,pv=s("uGvo"),fv=s("cHDa");Object(Yr.e)()(mv=Object(Yr.g)([{token:Ja.token,useFactory:()=>_e.default}])(mv=Object(Ai.b)(Ya)(mv=function(e,t){return Object(a.inject)(Ja)(e,void 0,0)}(mv=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(mv=Reflect.metadata("design:type",Function)(mv=Reflect.metadata("design:paramtypes",[void 0===pv.IEventBus?Object:pv.IEventBus,"undefined"==typeof BaseApplication?Object:BaseApplication])(mv=class extends hs.b{constructor(e,t){super(),this.eventBus=e,this.prevNetworkState=void 0,this.onUserOffline=()=>{this.dispatchEvent(new gv)},this.onUserActiveChanged=e=>{e===fv.c.LOCK_SCREEN&&this.onUserOffline()},this.onNetworkStatusChanged=e=>{e!==this.prevNetworkState&&(this.prevNetworkState=e,e===ce.a.DISCONNECT&&this.onUserOffline())},this.prevNetworkState=null,this.registerListener(t)}registerListener(e){this.eventBus.subscribe(((e,t)=>{switch(e){case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case ve.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t)}})),e.addEventListener(m.b.Exit,this.onUserOffline),e.addEventListener(m.b.BeforeUnload,this.onUserOffline),e.addEventListener(m.b.LogOut,this.onUserOffline)}})||mv)||mv)||mv)||mv)||mv)||mv);var vv;const _v="last-ts-online",bv="last-ts-online-prev-session";let Iv=Object(m.j)()(vv=Object(m.h)()(vv=Object(a.injectable)()(vv=Object(Yr.g)([{token:Ja.token,useFactory:()=>_e.default},{token:ti.token,useFactory:()=>Jc.default},{token:si.token,useFactory:()=>n.default.getInstance()}])(vv=function(e,t){return Object(a.inject)(Ja)(e,void 0,0)}(vv=function(e,t){return Object(a.inject)(St.b)(e,void 0,1)}(vv=function(e,t){return Object(a.inject)(ti)(e,void 0,2)}(vv=function(e,t){return Object(a.inject)(si)(e,void 0,3)}(vv=Reflect.metadata("design:type",Function)(vv=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,void 0===n.default?Object:n.default])(vv=class{constructor(e,t,s,a){this.eventBus=e,this.systemTime=t,this.socketPolling=s,this.localStorage=a,this.lastTsOnline=void 0,this.intervalUpdate=void 0,this.prevNetworkState=void 0,this.lastTsOnlinePrevSession=void 0,this.startTsOnlineCurrSession=void 0,this.onNetworkStatusChanged=e=>{if(e!==this.prevNetworkState)switch(this.prevNetworkState=e,e){case ce.a.CONNECTED:this.startIntervalUpdate();break;case ce.a.DISCONNECT:this.updateLastTsUserOnline(),this.stopIntervalUpdate()}},this.onStartPullOffline=()=>{this.startTsOnlineCurrSession=this.systemTime.getTimeNow(),this.updateLastTsUserOnlineInPrevSession()},this.onDonePullOffline=()=>{this.updateLastTsUserOnline(),this.startIntervalUpdate()},this.updateLastTsUserOnline=()=>{const e=this.systemTime.getTimeNow();return this.lastTsOnline=e,this.localStorage.setItemForCurrentUserAsync(_v,e.toString())},this.updateLastTsUserOnlineInPrevSession=async()=>{const e=await this.getLastTsOnline();return this.lastTsOnlinePrevSession=e,this.localStorage.setItemForCurrentUserAsync(bv,e.toString())},this.lastTsOnline=null,this.intervalUpdate=null,this.prevNetworkState=null,this.lastTsOnlinePrevSession=null,this.startTsOnlineCurrSession=null}onStart(){this.registerListener()}onDispose(){this.updateLastTsUserOnline(),this.stopIntervalUpdate()}async getLastTsOnline(){var e;return null!==(e=this.lastTsOnline)&&void 0!==e?e:this.lastTsOnline=Number(await this.localStorage.getItemForCurrentUserAsync(_v))||0}async getLastTsOnlinePrevSession(){var e;return null!==(e=this.lastTsOnlinePrevSession)&&void 0!==e?e:this.lastTsOnlinePrevSession=Number(await this.localStorage.getItemForCurrentUserAsync(bv))||0}async getStartTsOnlineCurrSession(){var e;return null!==(e=this.startTsOnlineCurrSession)&&void 0!==e?e:this.startTsOnlineCurrSession=this.systemTime.getTimeNow()}registerListener(){this.eventBus.subscribe(((e,t)=>{if(e===ve.GeneralActions.NETWORK_STATUS)return this.onNetworkStatusChanged(t)})),this.socketPolling.addEventListener(Jc.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(Xc.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(Xc.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOffline)}))}startIntervalUpdate(){var e;null!==(e=this.intervalUpdate)&&void 0!==e||(this.intervalUpdate=setInterval((()=>{this.updateLastTsUserOnline()}),E.j.timeInMs("10m")))}stopIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||vv)||vv)||vv)||vv)||vv)||vv)||vv)||vv)||vv)||vv;a.ModuleContainer.registerSingleton(ei,Iv);var yv=s("/7c0");const Sv=Object(a.define)("transfer-data-suggestion-loader");var Cv=s("cgeJ"),Ev=s("XVri"),Ov=s("bAqL");var Mv=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,"76POMK",this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,"arkhnR",this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(Ov.d)(e,Object(Ov.a)())}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("msg-sync",[Ev.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var Tv,wv=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new Mv(this.moduleName)}get Logger(){return this._logger}};function Rv(e){try{return JSON.stringify(e)}catch(t){return""}}function Lv(e){return JSON.parse(e)}Object(a.injectable)()(Tv=Object(a.singleton)(Sv)(Tv=Reflect.metadata("design:type",Function)(Tv=Reflect.metadata("design:paramtypes",[])(Tv=class extends wv{constructor(){super(Cv.f.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Cv.b);return null!=t?Lv(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(Cv.d);return null!=t?Lv(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadRolledConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load rolled conversations from DB failed cause invalid storage"),Promise.reject([]);try{let t=[];const s=await e.getItemForCurrentUserAsync(Cv.e);null!=s&&(t=Lv(s));const i=a.ModuleContainer.resolve(En.PreviewDataManager),n=await i.getAllPreviews(!0);for(let e=0;e<n.length;e++){const s=n[e].convId;if(s===Ce.default.sendToMeId)continue;if(-1!==t.indexOf(s))continue;const a=await yv.a.messageDBHandler.getOldestMsgsFromConv(s,Object(Yd.a)(),1);a&&a.items&&a.items.length>0&&t.push(s)}return this.Logger.logError("Load list rolled conversations from DB failed null"),t}catch(t){return this.Logger.logError("Load list rolled conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(Y.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:Lv(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?Lv(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Cv.m);return t?Lv(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Cv.b,Rv(e)):Promise.reject("Invalid storage")}async setLastCloseFirstLoginTransferModal(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Cv.c,Rv(e)):Promise.reject("Invalid storage")}async addRolledConversationToDB(e){const t=this.getSecureLocalStorageDB();if(!t)return Promise.reject("Invalid storage");let s=await this.loadRolledConversationsFromDB();return-1===s.indexOf(e)&&s.push(e),await t.setItemForCurrentUserAsync(Cv.e,Rv(s))}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Cv.d,Rv(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(Cv.m,Rv(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return n.default.getInstance()}})||Tv)||Tv)||Tv);var Dv=s("n09q"),Av=s("31cx"),Fv=s("a1r1"),kv=s("BO4k");var Nv,Pv=class extends wv{constructor(e,t){super(Ev.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._isTransferAfterLogin=void 0,this._rolledConversations=[],this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this._isTransferAfterLogin=!1,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?Ev.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?Ev.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}getIsTransferAfterLogin(){return this.isTransferAfterLogin}hasConversationBeforeFirstLogin(e){return e!==Ce.default.sendToMeId&&this._listConversationsBeforeLogin.includes(e)}hasRolledConversation(e){return e!==Ce.default.sendToMeId&&this._rolledConversations.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=a.ModuleContainer.resolve(Fv.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(kv.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin(),this.initListRolledConversations()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&kv.e()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!kv.f()&&!!this.hasConversationBeforeFirstLogin(e))}isRolledConversation(e){return!1}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&kv.i()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&kv.j()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&kv.g()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&kv.h()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&kv.k()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!kv.n()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!kv.m()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!kv.l()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&kv.o()}isEnabledFeature(){return kv.p()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}setIsTransferAfterLogin(e){this.isTransferAfterLogin=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}canShowFirstTimeLoginTransferMessageModal(){return!1}async addRolledConversationToDB(e){}registerSubscriptions(){Ce.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return a.ModuleContainer.resolve(Fv.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}async initListRolledConversations(){}handleUpdateConfigs(e={}){const{data_content:t}=kv.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(Av.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e,...t){const s=this.eventMap.get(e);Array.isArray(s)&&s.forEach((e=>Promise.resolve((()=>e(...t)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get isTransferAfterLogin(){return this._isTransferAfterLogin}set isTransferAfterLogin(e){this._isTransferAfterLogin=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=a.ModuleContainer.resolve(m.a),{userId:t}=e.getSession()||{};return t||""}},jv=s("mgoj"),Uv=s("JCvM"),Bv=s("y4fj");Object(a.injectable)()(Nv=Object(m.d)()(Nv=Object(a.singleton)(Dv.a)(Nv=function(e,t){return Object(a.inject)(Sv)(e,void 0,0)}(Nv=function(e,t){return Object(a.inject)(jv.a)(e,void 0,1)}(Nv=function(e,t){return Object(a.inject)(Gg.a)(e,void 0,2)}(Nv=Reflect.metadata("design:type",Function)(Nv=Reflect.metadata("design:paramtypes",[Object,void 0===Uv.ITransferDataSuggestionUIManager?Object:Uv.ITransferDataSuggestionUIManager,void 0===Gg.a?Object:Gg.a])(Nv=class extends Pv{constructor(e,t,s){super(e,t),this._moduleSyncMessages=void 0,this._isImportedMessages=!1,this._isRegisteredOnThisDevice=!1,this._shouldTransferMessages=!1,this._transferMessagesData={lastTransferSuccessTime:void 0},this._moduleSyncMessages=s}callTransferMessages(e){this.Logger.log("call transfer messages",e);switch(this.syncMessagesModule.getCurrentSyncScreenState()){case sm.a.Hidden:case sm.a.SuggestNewSync:return void this.syncMessagesStartSync(e);case sm.a.SuggestResume:return void this.syncMessagesResume();case sm.a.SyncGuide:return this.syncMessagesModule.metricts.clickViewGuide(),void this.syncMessagesModule.showSuggestPopup();case sm.a.WaitForBackup:case sm.a.DownloadingBackup:case sm.a.DecryptingBackup:case sm.a.SyncInProgress:case sm.a.ClearData:case sm.a.SyncSuccess:return void this.syncMessagesShowToast();case sm.a.WaitForNetwork:case sm.a.Error:return void this.syncMessagesStartSync(e);default:return}}async initialize(){await super.initialize(),await this.loadTransferMessagesData(),await this.loadSyncMessagesData(),await this.loadRegisteredData(),this.loadImportMessagesData()}hideTransferMessagesModal(){const e=Ct.default.getTimeNow();this.UIManager.hideTransferMessagesModal(),this._moduleLoader.setLastCloseFirstLoginTransferModal(e)}isDisplayedBannerDownloadPCSuggestion(){return!1}isDisplayedBubbleInfoEcard(e){return!!super.isDisplayedBubbleInfoEcard(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedConversationFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedGlobalSearchFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedMilestoneInPreviewMedia(e){return!!super.isDisplayedMilestoneInPreviewMedia(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSearchInConversationFooter(e){return!!super.isDisplayedSearchInConversationFooter(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSuggestionInMediaList(e){return!!super.isDisplayedSuggestionInMediaList(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}shouldTransferMessages(){return this._shouldTransferMessages}isValidForTransferMessages(){return!0}needTransferMessages(){this._shouldTransferMessages=!0}onApplicationReady(e){this.delayedCheckTransferMessagesSuggestionOnApplicationReady(),this.isEnabledFeature()&&(this.isRegisteredOnThisDevice()&&this.UIManager.turnOffDisplayingEntryPoints(),this.isTransferredMessages()||this.isImportedMessages()||this.isRegisteredOnThisDevice()||Bv.a.logAction(Bv.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE))}showTransferMessagesModal(){Bv.a.logAction(Bv.a.Modal.DISPLAYED),this.UIManager.showTransferMessagesModal()}isFullDiskStorage(){const e=we.default.getFullDiskChatPopupNoti();return(null==e?void 0:e.level)===Cn.e.FULL||!((null==e?void 0:e.level)!==Cn.e.ALMOST_FULL_2||null!=e&&e.dismiss)}canShowFirstTimeLoginTransferMessageModal(){return Boolean(this.isEnabledFeature()&&this.isFirstLogin()&&!this.isTransferredMessages()&&this.shouldTransferMessages()&&this.isDBCorruptionNotDetected()&&!this.isFullDiskStorage())}checkTransferMessagesSuggestionOnApplicationReady(){!this.getIsTransferAfterLogin()&&this.canShowFirstTimeLoginTransferMessageModal()&&this.showTransferMessagesModal()}delayedCheckTransferMessagesSuggestionOnApplicationReady(){setTimeout((()=>this.checkTransferMessagesSuggestionOnApplicationReady()),Im.a.transfer_when_login.time_wait_for_temp_key)}handleEvents(e,t){if(e===wl.c.EXPORT_IMPORT_FINISHED){const{type:e,error:s}=t;e!==wl.g.IMPORT_TYPE||s||this.handleImportMessagesSuccess()}}handleImportMessagesSuccess(){this._isImportedMessages=!0,this.UIManager.turnOffDisplayingEntryPoints(),a.ModuleContainer.resolve(jo.ConvListController).rerenderList()}handleSyncMessagesFailed(){this.UIManager.onProcessSync("sync-failed")}handleSyncMessagesStart(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesResume(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesRetry(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesSuccess(){this.transferMessagesData={lastTransferSuccessTime:Ct.default.getTimeNow()},this.loaderModule.updateTransferMessagesData(this.transferMessagesData),this.UIManager.onProcessSync("synced"),this.UIManager.turnOffDisplayingEntryPoints(),a.ModuleContainer.resolve(jo.ConvListController).rerenderList()}isImportedMessages(){return this._isImportedMessages}isRegisteredOnThisDevice(){return this._isRegisteredOnThisDevice}isTransferredMessages(){return Boolean(this.transferMessagesData&&null!=this.transferMessagesData.lastTransferSuccessTime)}isDBCorruptionNotDetected(){return!J.p.getIsDBCorruptionDetected()}loadImportMessagesData(){const e=s("XSmZ").default;if(e){const t=e.getExportImportInformation();t&&null!=t.lastTimeImportSuccess&&(this._isImportedMessages=!0)}}async loadRegisteredData(){const e=await this.loaderModule.loadRegisteredData();e&&null!=e.isRegisteredOnThisDevice&&(this._isRegisteredOnThisDevice=e.isRegisteredOnThisDevice)}async loadSyncMessagesData(){try{const e=await this.loaderModule.loadSyncMessagesData();e&&e.lastSync&&0!=e.lastSync&&this.updateLastTransferSuccessTime(e.lastSync)}catch(e){}}async loadTransferMessagesData(){try{const e=await this.loaderModule.loadTransferMessagesData();e&&(this.transferMessagesData=e,this.UIManager.turnOffDisplayingEntryPoints())}catch(e){}}updateLastTransferSuccessTime(e){this.transferMessagesData.lastTransferSuccessTime=e}registerSubscriptions(){super.registerSubscriptions(),this.syncMessagesModule.addEventListener(Kg.e.ON_START,this.handleSyncMessagesStart.bind(this)),this.syncMessagesModule.addEventListener(Kg.e.ON_RETRY,this.handleSyncMessagesRetry.bind(this)),this.syncMessagesModule.addEventListener(Kg.e.ON_RESUME,this.handleSyncMessagesResume.bind(this)),this.syncMessagesModule.addEventListener(Kg.e.ON_SUCCESS,this.handleSyncMessagesSuccess.bind(this)),this.syncMessagesModule.addEventListener(Kg.e.ON_FAILED,this.handleSyncMessagesFailed.bind(this)),_e.default.subscribe(this.handleEvents.bind(this))}syncMessagesShowToast(){be.default.show({textKey:"STR_TRANSFERRING_MSG_TOAST",type:be.TOAST_TYPE.INFO,noBackground:!0,duration:kv.d()})}syncMessagesStartSync(e){let t;switch(e){case Ev.j.CONVERSATION:t=Dg.j.CSC_LIST;break;case Ev.j.BUBBLE_CSC:t=Dg.j.CSC;break;case Ev.j.SEARCH_IN_CONVERSATION:case Ev.j.GLOBAL_SEARCH:t=Dg.j.SEARCH;break;default:t=Dg.j.FIRST_TIME_LOGIN}this.syncMessagesModule.sync(t)}syncMessagesResume(){this.syncMessagesModule.resume()}get syncMessagesModule(){return this._moduleSyncMessages}get transferMessagesData(){return this._transferMessagesData}set transferMessagesData(e){this._transferMessagesData=e}})||Nv)||Nv)||Nv)||Nv)||Nv)||Nv)||Nv);var zv,Gv=class extends wv{constructor(){super(Ev.c.UI),this.key=Uv.c,this.name=Uv.c,this.dataState=Object(I.a)({},Ev.f),this.UIState=Object(I.a)({},Ev.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(kv.b)(Object(kv.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===Ev.e?this.dataState:e.key===Ev.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}onProcessSync(e){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(Lg.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(Po.h)(this.name,Ev.e))}setUIState(e){const t=Object(Lg.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(Po.h)(this.name,Ev.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(Ai.b)(Uv.b)(zv=class extends Gv{hideTransferMessagesModal(){this.setUIState((e=>{e[Cv.l.TRANSFER_MODAL].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let a={};if(e.key===Cv.h){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var i;a[t]||(a[t]={}),a[t][e]=null===(i=s[e])||void 0===i?void 0:i.pc}}}else a=s;return a}showTransferMessagesModal(){this.setUIState((e=>{e[Cv.l.TRANSFER_MODAL].isDisplayed=!0}))}onProcessSync(e){"syncing"===e?this.setUIState((e=>{e.syncStatus="syncing"})):"sync-failed"===e?this.setUIState((e=>{e.syncStatus="sync-failed"})):"synced"===e&&this.setUIState((e=>{e.syncStatus="synced"}))}});var xv=Object(a.define)("forward-message-pool-factory"),Vv=s("oAAg");var Hv=class{createPool(e,t){return Object(Vv.createPool)(e,t)}};a.ModuleContainer.register(xv,Hv);var Wv=s("iuM+"),qv=s("WOYD"),Kv=s("qWd+");function $v(e){const t={success:[],failed:[]};for(const s of e)s.success&&s.success.length&&t.success.push(...s.success),s.failed&&s.failed.length&&t.failed.push(...s.failed);return t}function Zv(e){let t=[],s=[],a="";return e.forEach((e=>{e===Ce.default.sendToMeId?a=e:e.startsWith(Y.GROUPID_PREFIX)?t.push(e):s.push(e)})),{groups:t,oneOnes:s,sendToMe:a}}function Qv(e,t=50){let s=[];for(let a=0;a<e.length;a+=t)s.push(e.slice(a,a+t));return s}function Yv(e,t,s,i){const{userId:n}=a.ModuleContainer.resolve(m.a).getSession()||{};let r=ui.default.getMsgIdSendingFromCliMsgId(t),o=e.startsWith(Y.GROUPID_PREFIX);const l=new Vl.c(n,e,r,t,s,o,i);return Hl.a.instance().isOnE2ee(e)&&(l.e2eeStatus=Y.MSG_E2EE),l}var Jv=s("Eyfw");var Xv=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(hr.c);if(s.failed.length){const i=s.failed[0].error,n=null==i?void 0:i.code;if(n===Bu.a.DeleteConversationHasSendingMsg||n===Bu.a.DeleteSendingMsg||n===Bu.a.MsgArrivedBeforeAPIResponse)return;const r=s.failed[0].clientId;a._handleForwardedMessageFailure(i,{toUid:t.userId,message:e,clientId:r},t,e)}};const e_={USER:3,GROUP:6,OA:5};function t_(e){let t=e;return t&&t.startsWith(Y.GROUPID_PREFIX)&&(t=t.substr(Y.GROUPID_PREFIX.length)),t}function s_(e,t,s){if(!(e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm&&t))return{};if(s!==Ce.default.sendToMeId)return{};let a=e.toUid||e.userId,i=function(e){if(!e)return!1;let t=e.userId||e.id;return"string"==typeof t&&!t.startsWith(Y.GROUPID_PREFIX)&&e.type>=1}({userId:s})?e_.OA:a.startsWith(Y.GROUPID_PREFIX)?e_.GROUP:e_.USER;return{tId:t_(a),srcType:i,srcId:"0"==e.fromUid?t:e.fromUid,cmi:e.cliMsgId,gmi:e.msgId,ts:e.sendDttm+""}}function a_(e){const t=K.default.getChatBoxControllerByWindowId(hr.c)._getConversationInfo(e);if(!t){if(e.startsWith(Y.GROUPID_PREFIX)){return hn.default.getGroupByIdSync(e)}return Ii.default.getProfileFriendByIdSync(e)}return t}var i_=s("e2PW");var n_=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1,i=a?e.cliMsgId:xl.a.next(),n=(a&&e.msgId,Jv.a.preprocessMessage(i+"",e,void 0,!1,null)),r=Object(i_.b)(e,{send2Me:t===Ce.default.sendToMeId});n.reference=Object(i_.c)(r);const o={forwardRefLog:r,decorLog:Object(i_.a)(r)},l=a_(t),c={success:[],failed:[]};try{const e=await Jv.a.forward(i+"",n,l,o);if(e){const s=e.msgId||e.minGlobalMsgId;c.success.push({clientId:i+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else c.failed.push({clientId:i+"",error:"invalid response",toUid:t})}catch(d){c.failed.push({clientId:i+"",error:d,toUid:t})}return Xv(n,l,c),c},r_=s("/5+7"),o_=s("sANj"),l_=s("UyAE");var c_=async function(e,t,s=[],i=!1){const n={},r={},o=i?e.msgId:"",l=Object(i_.b)(e,{send2Me:!1}),c=Object(i_.b)(e,{send2Me:!0});for(let d=0;d<t.length;d++){let i=s[d]||xl.a.next();const u=t[d];n[u]=i;const h=Yv(u,i,Y.MSG_FILE,Object(I.a)({},e.message)),g=u===Ce.default.sendToMeId?c:l;h.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(g)),h.localPath=e.localPath,h.folderPath=e.folderPath,r[u]=h;const m=K.default.getChatBoxControllerByWindowId(hr.c),p=a_(u);if(Ce.default.forward_messages.enable_tracking_log){a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("forward-log",["track forward file"]).zsymb(18,"9YOqtG","call _showLocalMessage: ",JSON.stringify(h))}m._showLocalMessage(h,p,e,o,Y.MSG_CHECKING_EXIST);const f=`${i}_${J.p.getSessionUserId()}_${t[d]}`;r_.a.dispatch(o_.FileActionType.ExtraInfo,{fileKey:r_.a.getFileKey(f),extraInfo:{sendFileError:void 0}}),l_.a.set(null==i?void 0:i.toString(),{localPath:e.localPath,folderPath:e.folderPath})}return{localMsgs:r}},d_=s("D5jy");var u_=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(hr.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);t.success.length&&t.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=t.error;n===Y.FORWARD_ERR_CODE.EXPIRED||n===d_.a.FILE_EXPIRED||n===Y.FORWARD_ERR_CODE.SERVER_YAWNING||Y.FORWARD_ERR_CODE.SEND_FAIL;const r=null==t||null===(i=t.error)||void 0===i?void 0:i.code;r!==Bu.a.DeleteConversationHasSendingMsg&&r!==Bu.a.DeleteSendingMsg&&r!==Bu.a.MsgArrivedBeforeAPIResponse&&s._handleForwardedMessageFailure(n,e,a_(e.conversationId),a)}(i[e.clientId],e,a,s)}))};var h_=async function(e,t,s){var a;const i={success:[],failed:[]},n=null!=s&&s.retry?parseInt(e.cliMsgId):xl.a.next(),{localMsgs:r}=await c_(e,[t],[n],null==s?void 0:s.retry),o=null===(a=r[t].reference)||void 0===a?void 0:a.data,l={forwardRefLog:o,decorLog:Object(i_.a)(o)};try{const s=await Cl.default.forwardMessage(t,e,n,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,r[t],l);if(s){const e=s.msgId||s.minGlobalMsgId;i.success.push({clientId:n+"",msgId:e+"",minGlobalMsgId:s.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:n+"",error:"invalid response",toUid:t})}catch(c){i.failed.push({clientId:n+"",error:c,toUid:t})}return await u_(r,i,e),i},g_=function(e){return async function(e,t,s={}){const a=Kv.a.checkIsMessageFileE2ee(e),i=[];for(let n=0;n<t.length;n++){const r=Hl.a.instance().isOnE2ee(t[n]);Kv.a.checkIsForwardCrossConversation(a,r)?i.push(n_(e,t[n],s)):i.push(h_(e,t[n],s))}return $v(await Promise.all(i))}(e.message,e.toUids,e.options)},m_=s("dm9D"),p_=s("iEwR");const f_=(e,t)=>{const[s,i]=E.g.safeParseJson(null!=t?t:"");if(Number(null==i?void 0:i.is_original)){const t=Ce.default.file_photo_limit,s=Hl.a.instance().isOnE2ee(e);if(t.enable_upload_original&&t.free_user_can_reupload_original)return{photoResolutionMode:cf.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,isPhotoOriginal:1};switch(a.ModuleContainer.resolve(cf.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode()){case cf.a.PHOTO_RESOLUTION_MODE.ORIGINAL:return{photoResolutionMode:cf.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1};case cf.a.PHOTO_RESOLUTION_MODE.HD:default:return t.keep_original_param_when_forward?{keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1}:{keepPhotoOriginalParamWhenForward:!1,isPhotoOriginal:1}}}return{}};var v_=async function(e,t,s={}){var i;const{userId:n}=a.ModuleContainer.resolve(m.a).getSession()||{},r={},o=(null==s?void 0:s.retry)||!1,l=o?e.msgId:"",c=Object(i_.b)(e,{send2Me:!1}),d=Object(i_.b)(e,{send2Me:!0});null!==(i=e.message)&&void 0!==i&&i.params&&(e.message.params=(e=>{const[t,s]=E.g.safeParseJson(null!=e?e:"");if(s.is_original){const e=a.ModuleContainer.resolve(cf.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode(),t=Ce.default.file_photo_limit;if(e===cf.a.PHOTO_RESOLUTION_MODE.HD&&!t.keep_original_param_when_forward)return delete s.is_original,JSON.stringify(s)}return e})(e.message.params));for(let a=0;a<t.length;a++){let s=o?e.cliMsgId:xl.a.next();const i=t[a],n=Yv(i,s,Y.MSG_PHOTO,Object(I.a)({},e.message)),u=i===Ce.default.sendToMeId?d:c;n.updateMessageProp("properties",e.properties),n.updateMessageProp("localPath",e.localPath),n.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(u)),r[i]=n;const h=K.default.getChatBoxControllerByWindowId(hr.c),g=a_(i);h._showLocalMessage(n,g,e,l,Y.MSG_CHECKING_EXIST)}return{localMsgs:r}};var __=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(hr.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);s.success.length&&s.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e)})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=s.error;if(n===Y.FORWARD_ERR_CODE.EXPIRED||n===d_.a.FILE_EXPIRED);else{if(n===Y.FORWARD_ERR_CODE.SERVER_YAWNING)return;if(n===Y.FORWARD_ERR_CODE.SEND_FAIL)return}const r=null==s||null===(i=s.error)||void 0===i?void 0:i.code;r!==Bu.a.DeleteConversationHasSendingMsg&&r!==Bu.a.DeleteSendingMsg&&r!==Bu.a.MsgArrivedBeforeAPIResponse&&a._handleForwardedMessageFailure(n,e,a_(e.conversationId),t)}(i[e.clientId],t,e,a)}))};var b_=async function(e,t,s){const{localMsgs:i,forwardLogData:n,forwardLogDataMyCloud:r}=await v_(e,t,s),o={success:[],failed:[]},l=a.ModuleContainer.resolve(p_.TAIStickerMessageAppService);for(let a=0;a<t.length;a++){var c;const s=i[t[a]],n=s.clientId,r=Object(I.a)({},e);Hl.a.instance().isOnE2ee(t[a])&&(r.e2eeStatus=Y.MSG_E2EE);const u=null===(c=s.reference)||void 0===c?void 0:c.data,h={forwardRefLog:u,decorLog:Object(i_.a)(u)};try{const e=await l.forwardAIStickerMessage(t[a],n,r,{retryTimeout:Y.RETRY_MSG_TIMEOUT_DEFAULT,lowPriority:!1,fwAdditional:h});o.success.push(Object(I.a)(Object(I.a)({},e),{},{clientId:n+"",toUid:t[a]}))}catch(d){o.failed.push({clientId:n+"",error:d,toUid:t[a]})}}return await __(i,e,o),o},I_=s("Ullg");var y_=async function(e,t,s){const{localMsgs:a}=await v_(e,t,s),i={success:[],failed:[]};for(let o=0;o<t.length;o++){var n;const s=t[o],l=a[s],c=l.clientId,d=Object(I.a)({},e);Hl.a.instance().isOnE2ee(s)&&(d.e2eeStatus=Y.MSG_E2EE);const u=null===(n=l.reference)||void 0===n?void 0:n.data,h={forwardRefLog:u,decorLog:Object(i_.a)(u)};try{const e=await I_.a.Helper.forwardPhotoSticker(s,d,c,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,h);i.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:s,clientId:c+""}))}catch(r){i.failed.push({clientId:c+"",error:r,toUid:s})}}return await __(a,e,i),i};var S_=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1?e.cliMsgId:xl.a.next(),i=Jv.a.preprocessMessage(a+"",e,s.photoBundle),n=a_(t),r=await async function(e,t){const s=Object(i_.b)(e,{send2Me:t===Ce.default.sendToMeId});return Object(I.a)({forwardRefLog:s,decorLog:Object(i_.a)(s)},f_(t,e.message.params))}(e,t),o={success:[],failed:[]};i.reference=Object(i_.c)(null==r?void 0:r.forwardRefLog);try{const e=await Jv.a.forward(a+"",i,n,r);if(e){let s=e.msgId||e.minGlobalMsgId;o.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else o.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(l){o.failed.push({clientId:a+"",error:l,toUid:t})}return Xv(i,n,o),o};var C_=async function(e,t,s){var a;const i={success:[],failed:[]};let n=ui.default.safeParseJson(null==e||null===(a=e.message)||void 0===a?void 0:a.params)||{};null!=n&&n.group_layout_id&&(delete n.group_layout_id,delete n.id_in_group,delete n.is_group_layout,delete n.total_item_in_group),s.photoBundle&&Object.assign(n,{is_group_layout:1,group_layout_id:s.photoBundle.groupLayoutId,id_in_group:s.photoBundle.idInGroup,total_item_in_group:s.photoBundle.totalItemInGroup});const r=Object(I.a)({},e.message);r.params=JSON.stringify(n);const o=Object(I.a)(Object(I.a)({},e),{},{message:r}),{localMsgs:l}=await v_(o,[t],s),c=l[t].clientId+"";try{var d;let a=!1;s.photoBundle&&(a=Object(I.a)(Object(I.a)({},s.photoBundle),{},{clientId:c}));const n=null===(d=l[t].reference)||void 0===d?void 0:d.data,o=Object(I.a)({forwardRefLog:n,decorLog:Object(i_.a)(n)},f_(t,e.message.params)),u=await Cl.default.forwardMessage(t,Object(I.a)(Object(I.a)({},e),{},{message:r,forwardInGroup:a}),c,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,l[t],o);if(u){let e=u.msgId||u.minGlobalMsgId;i.success.push({clientId:c,msgId:e+"",minGlobalMsgId:u.minGlobalMsgId+"",toUid:t,thumbUrl:u.thumbUrl,oriUrl:u.oriUrl||u.hdUrl||u.rawUrl,hdUrl:u.hdUrl,fileMsgParams:u.fileMsgParams})}else i.failed.push({clientId:c,error:"invalid response",toUid:t})}catch(u){i.failed.push({clientId:c,error:u,toUid:t})}return await __(l,e,i),i};var E_=async function(e,t,s){const a=Kv.a.checkIsMessageFileE2ee(e),i=[];for(let n=0;n<t.length;n++){const r=Hl.a.instance().isOnE2ee(t[n]);Kv.a.checkIsForwardCrossConversation(a,r)?i.push(S_(e,t[n],s)):i.push(C_(e,t[n],s))}return $v(await Promise.all(i))},O_=function(e){return async function(e,t,s={}){return Object(m_.a)(e)?await b_(e,t,s):Object(m_.D)(e)?await y_(e,t,s):await E_(e,t,s)}(e.message,e.toUids,e.options)};var M_=async function(e,t,s){const a={success:[],failed:[]},i=(null==s?void 0:s.retry)||!1?e.cliMsgId:xl.a.next(),n=Jv.a.preprocessMessage(i+"",e,s.photoBundle),r=Object(i_.b)(e,{send2Me:t===Ce.default.sendToMeId});n.reference=Object(i_.c)(r);const o={forwardRefLog:r,decorLog:Object(i_.a)(r)},l=a_(t);try{const e=await Jv.a.forward(i+"",n,l,o);if(e){const s=e.msgId||e.minGlobalMsgId;a.success.push({clientId:i+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else a.failed.push({clientId:i+"",error:"invalid response",toUid:t})}catch(c){a.failed.push({clientId:i+"",error:c,toUid:t})}return Xv(n,l,a),a};var T_=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1,i=a?e.msgId:"",n=a?e.cliMsgId:xl.a.next(),r=Jv.a.preprocessMessage(n+"",e,s.photoBundle),o=Yv(t,n,Y.MSG_VIDEO,Object(I.a)({},r.message)),l=Object(i_.b)(e,{send2Me:t===Ce.default.sendToMeId});o.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(l)),o.localPath=e.localPath;const c=K.default.getChatBoxControllerByWindowId(hr.c),d=a_(t);return c._showLocalMessage(o,d,null,i,Y.MSG_CHECKING_EXIST),[o,r]};var w_=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(hr.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);s.success.length&&s.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e)})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=s.error;n===Y.FORWARD_ERR_CODE.EXPIRED||n===d_.a.FILE_EXPIRED||n===Y.FORWARD_ERR_CODE.SERVER_YAWNING||Y.FORWARD_ERR_CODE.SEND_FAIL;const r=null==s||null===(i=s.error)||void 0===i?void 0:i.code;r!==Bu.a.DeleteConversationHasSendingMsg&&r!==Bu.a.DeleteSendingMsg&&r!==Bu.a.MsgArrivedBeforeAPIResponse&&a._handleForwardedMessageFailure(n,e,a_(e.conversationId),t)}(i[e.clientId],t,e,a)}))};var R_=async function(e,t,s){const a={success:[],failed:[]},[i,n]=await T_(e,t,s),r=i.clientId+"";let o=!1;s.photoBundle&&(o=Object(I.a)(Object(I.a)({},s.photoBundle),{},{clientId:r}));try{var l;const e=null===(l=i.reference)||void 0===l?void 0:l.data,s={forwardRefLog:e,decorLog:Object(i_.a)(e)},o=await Cl.default.forwardMessage(t,n,r,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,i,s);if(o){const e=o.msgId||o.minGlobalMsgId;a.success.push({clientId:r,msgId:e+"",minGlobalMsgId:o.minGlobalMsgId+"",toUid:t,_msgObject:o._msgObject||null})}else a.failed.push({clientId:r,error:"invalid response",toUid:t})}catch(c){a.failed.push({clientId:r,error:c,toUid:t})}return await w_({[t]:i},e,a),a};var L_=async function(e,t,s={}){const a=[];for(let i=0;i<t.length;i++){const n=t[i],r=Hl.a.instance().isOnE2ee(n),o=Kv.a.checkIsMessageFileE2ee(e);Kv.a.checkIsForwardCrossConversation(o,r)?a.push(M_(e,t[i],s)):a.push(R_(e,t[i],s))}return $v(await Promise.all(a))};var D_=async function(e){return L_(e.message,e.toUids,e.options)};var A_=async function(e,t,s={}){const a=e.message,i=[];for(let n=0;n<t.length;n++){const e=t[n];let r=xl.a.next();for(let t=0;t<a.length;t++){const n=a[t],o={isGroupLayout:1,groupLayoutId:r,totalItemInGroup:a.length,idInGroup:t};s.photoBundle=o,n.msgType===Y.MSG_VIDEO?i.push(D_({message:n,toUids:[e],options:s})):i.push(O_({message:n,toUids:[e],options:s}))}}return $v(await Promise.all(i))},F_=function(e){return A_(e.message,e.toUids,e.options)},k_=s("Hllb"),N_=s("KZut");var P_=async function(e,t,s={}){var a;const i=e.message&&"object"==typeof e.message&&"rtf"===e.message.action,n=ui.default.getSubtypeMessage(e);let r=null;const o=(null==s?void 0:s.retry)||!1,l=o?e.msgId:"",c={},d={};let u=ui.default.ZSafeFunction((()=>-1==n||n==Y.MSG_SUBTYPE_LINK||i?ui.default.stripInvalidChar(e.message):e.message&&"object"==typeof e.message?e.message.title:""),"");if(!u)throw Object(k_.c)("Empty message",k_.a.EmptyString,e);let h=$r.default.findFirstUrl(u,!0,!1);h&&N_.a.checkValidSuffix(h)&&e.shouldParseLinkOrContact&&(e.containType=2),i&&"object"==typeof e.message&&null!==(a=e.message)&&void 0!==a&&a.params&&(c.rtfProps=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return""}}(e.message.params),c.styles=c.rtfProps);const g=Object(i_.b)(e,{send2Me:!1}),m=Object(i_.b)(e,{send2Me:!0});for(let p=0;p<t.length;p++){const s=t[p];const a=Yv(s,(o?e.cliMsgId:xl.a.next())+"",Y.MSG_TEXT),n=s===Ce.default.sendToMeId?m:g;a.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(n)),i&&"object"==typeof e.message?(a.updateMessageContentProp(Vl.a.RTF,e.message),a.updateMessageContentProp(Vl.a.TEXT,e.message.title)):a.updateMessageContentProp(Vl.a.TEXT,u),e.containType&&(a.containType=e.containType,a.shouldParseLinkOrContact=e.shouldParseLinkOrContact),d[s]=a;const c=K.default.getChatBoxControllerByWindowId(hr.c),f=a_(s);if(c._showLocalMessage(a,f,null,l),h&&e.shouldParseLinkOrContact){const t=Ro.c.create(h).withTimeout(me.a.ParserConfig.get("max_delay_send_message"));me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Ro.a.SHARE_MESSAGE,s]):t.do("parse",[Ro.a.SHARE_MESSAGE]);const i=await t.exec().toPromise();i&&(a.type=Y.MSG_LINK_CLIENT,a.updateMessageContentProp(Vl.a.LINK,Object(I.a)({},i)),d[s]=a,r=a.convertToUIMessageObject(),c._showLocalMessage(a,f,null,l)),Ro.b.getInstance().report({key:null==e?void 0:e.msgId,href:h,entry:Ro.a.SHARE_MESSAGE,preview:i})}}return{localMsgs:d,additional:c,updatedForwardMsgItem:r}};async function j_(e,t){const s=K.default.getChatBoxControllerByWindowId(hr.c),a={};for(const i in e)e[i]&&e[i].clientId&&(a[e[i].clientId]=e[i]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(a[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{var t;const i=null==e||null===(t=e.error)||void 0===t?void 0:t.code;if(i!==Bu.a.DeleteConversationHasSendingMsg&&i!==Bu.a.DeleteSendingMsg&&i!==Bu.a.MsgArrivedBeforeAPIResponse&&s){const t=a[e.clientId],i=t.conversationId;we.default.deleteMessageById(ui.default.getMsgIdSendingFromCliMsgId(e.clientId),i),s._handleForwardedMessageFailure(e.error,t,a_(i))}}))}async function U_(e,t,s){var a,i;const n=Ce.default.sendToMeId||"",r={forwardRefLog:null===(a=t.reference)||void 0===a?void 0:a.data,decorLog:Object(i_.a)(null===(i=t.reference)||void 0===i?void 0:i.data)};let o=s?Object(I.a)(Object(I.a)({},s),r):r,l=t.clientId;const c={success:[],failed:[]};try{const t=await Cl.default.forwardMultiMessage([{clientId:l,toUid:n}],e,!1,1e4,!1,o);t.success&&t.success.length&&t.success.forEach((e=>{c.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:n}))})),t.failed&&t.failed.length&&t.failed.forEach((e=>{c.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:n}))}))}catch(d){c.failed.push({clientId:""+l,error:d,toUid:n})}return c}var B_=s("A/lx");async function z_(e,t,s,a){const i=[],n=[],r={success:[],failed:[]};if(t.forEach((e=>{const t=hn.default.getGroupByIdSync(e);var a;t&&t.totalMember>=Ce.default.forward_group_limit_mem?n.push(e):i.push({clientId:(null===(a=s[e])||void 0===a?void 0:a.clientId)||xl.a.next(),grid:Object(B_.a)(e)})})),n.length)for(let c=0;c<n.length;c++){var o;const e=n[c],t=null===(o=s[Y.GROUPID_PREFIX+e].reference)||void 0===o?void 0:o.data,i={forwardRefLog:t,decorLog:Object(i_.a)(t)},d=a?Object(I.a)(Object(I.a)({},a),i):i;try{const t=await Cl.default.sendMsgObject(s[e],null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,d);r.success.push({clientId:s[e].clientId,msgId:t.msgId,toUid:Y.GROUPID_PREFIX+e})}catch(l){r.failed.push({clientId:s[e].clientId,error:l,toUid:Y.GROUPID_PREFIX+e})}}if(i.length){const t=Qv(i),s={};i.forEach((e=>{s[e.clientId]=e.grid}));try{for(let i=0;i<t.length;i++){const n=await Cl.default.forwardMultiMessage(t[i],e,!0,1e4,!1,a);n.success&&n.success.length&&n.success.forEach((e=>{r.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:Y.GROUPID_PREFIX+s[e.clientId]}))})),n.failed&&n.failed.length&&n.failed.forEach((e=>{r.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:Y.GROUPID_PREFIX+s[e.clientId]}))}))}}catch(l){for(let e=0;e<i.length;e++)r.failed.push({clientId:""+i[e].clientId,error:l,toUid:Y.GROUPID_PREFIX+i[e].grid})}}return r}async function G_(e,t,s,a){const i=[];t.forEach((e=>{var t;i.push({clientId:(null===(t=s[e])||void 0===t?void 0:t.clientId)||xl.a.next(),toUid:e})}));const n={success:[],failed:[]},r=Qv(i),o={};i.forEach((e=>{o[e.clientId]=e.toUid}));for(let c=0;c<r.length;c++){const t=r[c];try{const s=await Cl.default.forwardMultiMessage(t,e,!1,1e4,!1,a);s.success&&s.success.length&&s.success.forEach((e=>{n.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:o[e.clientId]}))})),s.failed&&s.failed.length&&s.failed.forEach((e=>{n.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:o[e.clientId]}))}))}catch(l){for(let e=0;e<t.length;e++)n.failed.push({clientId:""+t[e].clientId,error:l,toUid:t[e].toUid})}}return n}var x_=async function(e,t,s={}){const{groups:a,oneOnes:i,sendToMe:n}=Zv(t),{localMsgs:r,additional:o,updatedForwardMsgItem:l}=await P_(e,t,Object(I.a)(Object(I.a)({},s),{},{send2Me:!!n})),c=l||e,d=[];if(n){const e=await U_(c,r[n],o);d.push(e)}if(a.length){const e=await z_(c,a,r,o);d.push(e)}if(i.length){const e=await G_(c,i,r,o);d.push(e)}const u=({success:[],failed:[]}=$v(d));return await j_(r,u),u};var V_=async function(e){return x_(e.message,e.toUids,e.options)};var H_=async function(e,t,s={}){const i={},n={},{userId:r}=a.ModuleContainer.resolve(m.a).getSession()||{},o=K.default.getChatBoxControllerByWindowId(hr.c),l=(null==s?void 0:s.retry)||!1,c=l?e.msgId:"",d=Object(i_.b)(e,{send2Me:!1}),u=Object(i_.b)(e,{send2Me:!0});for(let a=0;a<t.length;a++){const s=t[a];const i=Yv(s,l?e.cliMsgId:xl.a.next(),Y.MSG_STICKER),r=s===Ce.default.sendToMeId?u:d;i.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(r)),i.updateMessageContentProp(Vl.a.STICKER,e.message),n[s]=i;const h=a_(s);o._showLocalMessage(i,h,null,c)}for(let a=0;a<t.length;a++){const s=s_(e,r||"",t[a]);i[t[a]]=s}return{localMsgs:n,additionalList:i}};var W_=async function(e,t,s={}){const{groups:a,oneOnes:i,sendToMe:n}=Zv(t),{localMsgs:r,additionalList:o}=await H_(e,t,s),l=[];if(n){const t=await U_(e,r[n]);l.push(t)}if(a.length){const t=await z_(e,a,r);l.push(t)}if(i.length){const t=await G_(e,i,r);l.push(t)}const c=({success:[],failed:[]}=$v(l));return await j_(r,c),c};var q_=async function(e){return W_(e.message,e.toUids,e.options)};var K_=async function(e,t,s={}){const[a,i]=$r.default.shouldReparseLink(e),n=K.default.getChatBoxControllerByWindowId(hr.c),r=(null==s?void 0:s.retry)||!1,o=r?e.msgId:"";let l={localMsgs:{},preview:null};l=a&&s.isForwardSingleMsg?await async function(e,t,s,a){var i;const n=$r.default.isLongUrl(e||""),r=me.a.LinkPreviewRespository.getKey("meta-data",[e]),o=null===(i=me.a.LinkPreviewRespository.metaData.get(r))||void 0===i?void 0:i.value,l={localMsgs:{},preview:null};for(let g=0;g<s.length;g++){const i=s[g],r=Yv(i,a?t.cliMsgId:xl.a.next(),Y.MSG_LINK_CLIENT),m=Object(i_.b)(t,{send2Me:i===Ce.default.sendToMeId});r.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(m)),o&&!n?(r.updateMessageContentProp(Vl.a.TEXT,t.message.title),r.updateMessageContentProp(Vl.a.LINK,o)):(r.updateMessageContentProp(Vl.a.TEXT,t.message.title||t.message.href),r.type=Y.MSG_TEXT);let p=new Promise((e=>e(null)));if(n){Ro.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ro.a.SHARE_MESSAGE,preview:null}),l.localMsgs[i]=r;continue}if(o){let t=!1;const s=Ro.c.create(e);if(me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")){var c,d;const a=me.a.LinkPreviewRespository.getKey("meta-data",[e]);t=!(null===(c=me.a.LinkPreviewRespository.metaData.get(a))||void 0===c||null===(d=c.value)||void 0===d||!d.thumbOrigin),t&&s.do("download-thumb")}else{var u,h;const s=me.a.LinkPreviewRespository.getKey("thumb-local",[e]);t=!(null===(u=me.a.LinkPreviewRespository.thumbLocal.get(s))||void 0===u||null===(h=u.value)||void 0===h||!h.thumbLocal)}t&&(p=s.do("upload-thumb",[i]).exec().toPromise())}else if(null!==o){const t=Ro.c.create(e).withTimeout(me.a.ParserConfig.get("max_delay_send_message"));me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Ro.a.SHARE_MESSAGE,i]):t.do("parse",[Ro.a.SHARE_MESSAGE]),p=t.exec().toPromise()}const f=await p;Ro.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ro.a.SHARE_MESSAGE,preview:f}),f&&(r.type=Y.MSG_LINK_CLIENT,r.updateMessageContentProp(Vl.a.LINK,E.g.clone(f)),l.preview=f),l.localMsgs[i]=r}return l}(i||"",e,t,r):await async function(e,t,s,a){const i={localMsgs:{},preview:null},n=$r.default.isLongUrl(e||""),[,r]=E.g.safeParseJson(t.message.params);for(let o=0;o<s.length;o++){const l=a?t.cliMsgId:xl.a.next(),c=s[o],d=Yv(c,l,Y.MSG_TEXT),u=Object(i_.b)(t,{send2Me:c===Ce.default.sendToMeId});d.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(u)),n||(d.type=Y.MSG_LINK_CLIENT,d.updateMessageContentProp(Vl.a.LINK,{width:r.width,height:r.height,desc:t.message.description,href:t.message.href,src:r.src,media:r,thumb:t.message.thumb,title:r.mediaTitle})),Ro.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ro.a.SHARE_MESSAGE,preview:null}),t.message.title&&d.updateMessageContentProp("text",t.message.title),i.localMsgs[c]=d}return i}(i||"",e,t,r);for(let c in l.localMsgs){const t=l.localMsgs[c],s=a_(c);n._showLocalMessage(t,s,e,o)}return l};var $_=async function(e,t,s={}){const{localMsgs:a,preview:i}=await K_(e,t,s),n=Object(I.a)({},e);if(i){var r;const t=i.media||{};let s="";if(Object.keys(t).length>0)s=JSON.stringify(t);else{const[t,a]=E.g.safeParseJson(e.message.params);a.mediaTitle=i.title,s=JSON.stringify(a)}n.message={action:"recommened.link",childnumber:0,description:i.desc||"",href:i.href,params:s,thumb:i.thumb||"",title:e.message.title,type:(null===(r=i.media)||void 0===r?void 0:r.type)||""}}const{groups:o,oneOnes:l,sendToMe:c}=Zv(t),d=[];if(c){const e=await U_(n,a[c]);d.push(e)}if(o.length){const e=await z_(n,o,a);d.push(e)}if(l.length){const e=await G_(n,l,a);d.push(e)}const u=({success:[],failed:[]}=$v(d));return await j_(a,u),u};var Z_=async function(e){return $_(e.message,e.toUids,e.options)};var Q_=async function(e,t,s){const a={localMsgs:{}},i=K.default.getChatBoxControllerByWindowId(hr.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"",o=Object(i_.b)(e,{send2Me:!1}),l=Object(i_.b)(e,{send2Me:!0});for(let c=0;c<t.length;c++){const s=t[c];const d=Yv(s,(n?e.cliMsgId:xl.a.next())+"",e.msgType,e.message),u=s===Ce.default.sendToMeId?l:o;d.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(u)),a.localMsgs[s]=d;const h=a_(s);i._showLocalMessage(d,h,null,r)}return a};var Y_=async function(e,t,s={}){const{localMsgs:a}=await Q_(e,t,s),i={success:[],failed:[]};for(let o=0;o<t.length;o++){var n;const s=t[o],l=a[s],c=null===(n=l.reference)||void 0===n?void 0:n.data,d={forwardRefLog:c,decorLog:Object(i_.a)(c)};try{const a=await Cl.default.forwardMessage(t[o],e,l.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,l,d);i.success.push({clientId:l.clientId+"",msgId:(a.msgId||a.minGlobalMsgId)+"",minGlobalMsgId:a.minGlobalMsgId+"",toUid:s})}catch(r){i.failed.push({clientId:l.clientId+"",error:r,toUid:s})}}return await j_(a,i),i};var J_=async function(e){return Y_(e.message,e.toUids,e.options)};var X_=async function(e,t,s={}){const a=[];for(let n=0;n<t.length;n++){const r={success:[],failed:[]},o=s.retry?e.cliMsgId:xl.a.next(),l=Jv.a.preprocessMessage(o+"",e,null),c=a_(t[n]),d=t[n]===Ce.default.sendToMeId,u=Object(i_.b)(e,{send2Me:d}),h={forwardRefLog:u,decorLog:Object(i_.a)(u)};l.reference=Object(i_.c)(u);try{const e=await Jv.a.forward(o+"",l,c,h);e?r.success.push({clientId:o+"",msgId:(e.msgId||e.minGlobalMsgId)+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t[n]}):r.failed.push({clientId:o+"",error:"invalid response",toUid:t[n]})}catch(i){r.failed.push({clientId:o+"",error:i,toUid:t[n]})}Xv(l,c,r),a.push(r)}return $v(a)};var eb=async function(e){return X_(e.message,e.toUids,e.options)};var tb=async function(e,t,s={}){const a={},i=K.default.getChatBoxControllerByWindowId(hr.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"",o=Object(i_.b)(e,{send2Me:!1}),l=Object(i_.b)(e,{send2Me:!0});for(let c=0;c<t.length;c++){const s=t[c];const d=Yv(s,n?e.cliMsgId:xl.a.next(),Y.MSG_GIF);let{oriUrl:u,normalUrl:h,params:g}=e.message;if(g){let e=r_.a.utils.safeParseJSON(g);const{width:t=0,height:s=0}=e,a={};u&&(a.original={width:t,height:s,url:u}),h&&(a.normal={width:t,height:s,url:h}),d.updateMessageContentProp(Vl.a.GIF,a)}d.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(s===Ce.default.sendToMeId?l:o)),a[s]=d;const m=a_(s);i._showLocalMessage(d,m,e,r)}return{localMsgs:a}};var sb=async function(e,t,s={}){const a={success:[],failed:[]},{localMsgs:i}=await tb(e,t,s);for(let o=0;o<t.length;o++){var n;const s=t[o],l=i[s],c=null===(n=l.reference)||void 0===n?void 0:n.data,d={forwardRefLog:c,decorLog:Object(i_.a)(c)};try{const t=await Cl.default.forwardMessage(s,e,l.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,l,d);t?a.success.push({clientId:l.clientId+"",msgId:(t.msgId||t.minGlobalMsgId)+"",minGlobalMsgId:t.minGlobalMsgId+"",toUid:s}):a.failed.push({clientId:l.clientId+"",error:"invalid response",toUid:s})}catch(r){a.failed.push({clientId:l.clientId+"",error:r,toUid:s})}}return await j_(i,a),a};var ab=async function(e){return sb(e.message,e.toUids,e.options)};var ib=async function(e,t,s,a={}){const{localMsgs:i,additionalList:n}=s,r={success:[],failed:[]};for(let c=0;c<t.length;c++){var o;const s=t[c],a=i[s],d=null===(o=a.reference)||void 0===o?void 0:o.data,u=Object(I.a)(Object(I.a)({},n[s]||{}),{},{forwardRefLog:d,decorLog:Object(i_.a)(d)});try{const i=await Cl.default.forwardMessage(t[c],e,a.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,a,u);r.success.push({clientId:a.clientId+"",msgId:(i.msgId||i.minGlobalMsgId)+"",minGlobalMsgId:i.minGlobalMsgId+"",toUid:s})}catch(l){r.failed.push({clientId:a.clientId+"",error:l,toUid:s})}}return r};var nb=class{constructor(e,t,s){this.message=e,this.toUids=t,this.options=s,this.preprocessResult=void 0,this.result=void 0,this.preprocessResult={},this.result={success:[],failed:[]}}async execute(){return this.preprocessResult=await this.preprocess(),this.result=await this.process(),this.postprocess(),this.result}};var rb=async function(e,t,s){const a={localMsgs:{},additionalList:{}},i=K.default.getChatBoxControllerByWindowId(hr.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const l=Yv(s,(n?e.cliMsgId:xl.a.next())+"",e.msgType,e.message),c=Object(i_.b)(e,{send2Me:s===Ce.default.sendToMeId});l.updateMessageProp(Vl.b.REFERENCE,Object(i_.c)(c)),a.localMsgs[s]=l;const d=a_(s);i._showLocalMessage(l,d,null,r)}return a};class ob extends nb{async preprocess(){return rb(this.message,this.toUids,this.options)}async process(){return ib(this.message,this.toUids,this.preprocessResult,this.options)}async postprocess(){return j_(this.preprocessResult.localMsgs,this.result)}}var lb=async function(e){return new ob(e.message,e.toUids,e.options).execute()};qv.a.registerHandler(Wv.a.PHOTO,O_),qv.a.registerHandler(Wv.a.FILE,g_),qv.a.registerHandler(Wv.a.VIDEO,D_),qv.a.registerHandler(Wv.a.TEXT,V_),qv.a.registerHandler(Wv.a.STICKER,q_),qv.a.registerHandler(Wv.a.LINK,Z_),qv.a.registerHandler(Wv.a.CONTACT,J_),qv.a.registerHandler(Wv.a.VOICE,eb),qv.a.registerHandler(Wv.a.GIF,ab),qv.a.registerHandler(Wv.a.GROUP_PHOTO,F_),qv.a.registerHandler(Wv.a.DEFAULT,lb);class cb{constructor(e){this._state=cb.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=void 0,this._reject=void 0,this._promise=new e(((e,t)=>{this._resolve=e,this._reject=t}))}reject(e){this._state===cb.PENDING&&(this._state=cb.REJECTED,this._reject(e))}resolve(e){this._state===cb.PENDING&&(this._state=cb.FULFILLED,this._resolve(e))}get state(){return this._state}get promise(){return this._promise}}cb.PENDING="PENDING",cb.FULFILLED="FULFILLED",cb.REJECTED="REJECTED";var db=cb;const ub={cancelledReason:"Task cancelled",timeoutReason:"Task timeout"};class hb extends db{constructor(e,t=void 0,s=ub){super(Promise),this.executor=e,this.ttl=t,this.options=s,this._events=new Map,this._creationTimestamp=0,this._timeout=0,this.creationTimestamp=performance.now(),this.timeout=0,void 0!==t&&this.setTimeout()}addEventListener(e,t){let s=this.events.get(e);s||(s=[],this.events.set(e,s)),s.push(t)}cancel(){this.reject(this.getOptions().cancelledReason)}execute(...e){return this.executor.apply(this,e).then(this.resolve.bind(this)).catch(this.reject.bind(this)),this.promise}removeEventListener(e,t){const s=this.events.get(e);if(!s)return;this.events.set(e,s.filter((e=>e!==t)))}getOptions(){return Object(I.a)(Object(I.a)({},ub),this.options)}removeTimeout(){this.timeout&&clearTimeout(this.timeout),this.timeout=0}setTimeout(){if(this.state!==hb.PENDING)return;if(isNaN(this.ttl)||this.ttl<=0)throw new Error("delay must be a positive int");const e=performance.now()-this.creationTimestamp;this.timeout&&this.removeTimeout(),this.timeout=window.setTimeout((()=>this.reject(this.getOptions().timeoutReason)),Math.max(this.ttl-e,0))}get events(){return this._events}get creationTimestamp(){return this._creationTimestamp}set creationTimestamp(e){this._creationTimestamp=e}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var gb=hb,mb=s("gOiJ"),pb=s("1OYu");var fb=function(e){const t=e.msgType;return t===Y.MSG_PHOTO_GROUP?[Wv.a.GROUP_PHOTO,qv.a.getHandler(Wv.a.GROUP_PHOTO)]:t===Y.MSG_PHOTO||t===Y.MSG_PHOTO_2||t===Y.MSG_DOODLE?[Wv.a.PHOTO,qv.a.getHandler(Wv.a.PHOTO)]:t===Y.MSG_FILE?[Wv.a.FILE,qv.a.getHandler(Wv.a.FILE)]:t===Y.MSG_VIDEO?[Wv.a.VIDEO,qv.a.getHandler(Wv.a.VIDEO)]:t===Y.MSG_TEXT?[Wv.a.TEXT,qv.a.getHandler(Wv.a.TEXT)]:t===Y.MSG_STICKER?[Wv.a.STICKER,qv.a.getHandler(Wv.a.STICKER)]:t===Y.MSG_CONTACT&&"recommened.link"==e.message.action||"link"===e.type?[Wv.a.LINK,qv.a.getHandler(Wv.a.LINK)]:t!==Y.MSG_CONTACT||"recommened.user"!=e.message.action&&"recommened.vip"!=e.message.action?t===Y.MSG_VOICE?[Wv.a.VOICE,qv.a.getHandler(Wv.a.VOICE)]:t===Y.MSG_GIF?[Wv.a.GIF,qv.a.getHandler(Wv.a.GIF)]:[Wv.a.DEFAULT,qv.a.getHandler(Wv.a.DEFAULT)]:[Wv.a.CONTACT,qv.a.getHandler(Wv.a.CONTACT)]};var vb,_b=class{constructor(e,t){this.messages=e,this.toUids=t,this.startTime=0,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("forward-log",["track forward message"])),this._Logger}startForward(){this.startTime=performance.now()}endForward(e){for(let t=0;t<e.length;t++)this.logForMsg(this.messages[t],e[t]);this.logForwardDone()}logForwardDone(){let e=0,t=0,s=0,a=0;for(let i=0;i<this.toUids.length;i++){const n=this.toUids[i];n.startsWith(Y.GROUPID_PREFIX)?e++:n===Ce.default.sendToMeId?a++:(t++,Ii.default.isFriend(n)||s++)}for(let i=0;i<this.messages.length;i++){const n=this.messages[i];Ia.default.logActionInfoV2(Ia.FeaturesInfo.ForwardMessage,0,{src_id:n.toUid||n.userId,msgType:n.msgType,gapTime:Date.now()-+n.sendDttm,duration:performance.now()-this.startTime,totalConv:this.toUids.length,chatgroup:e,chat11:t,stranger:s,mycloud:a})}}logForMsg(e,t){t.success.length>0&&this.logSuccess(e,t.success),t.failed.length>0&&this.logFail(e,t.failed)}logSuccess(e,t){}logFail(e,t){const s=e.toUid||e.userId,a=Hl.a.instance().isOnE2ee(s);for(let i=0;i<t.length;i++){const{error:n,toUid:r}=t[i],o=Hl.a.instance().isOnE2ee(r);let l=0;l=a||o?a&&o?1:2:0;let c=1;r.startsWith(Y.GROUPID_PREFIX)?c=2:r===Ce.default.sendToMeId&&(c=3);let d=0;if(d="string"==typeof n||"number"==typeof n?n:(null==n?void 0:n.code)||(null==n?void 0:n.errorCode)||(null==n?void 0:n.error_code)||n.message,d===Bu.a.DeleteConversationHasSendingMsg||d===Bu.a.DeleteSendingMsg||d===Bu.a.MsgArrivedBeforeAPIResponse)return;const u={fail_error:d,e2ee:l,msgtype:e.msgType,src_id:s,chat_type:c,duration:performance.now()-this.startTime,number_conversation:this.toUids.length};Ce.default.forward_messages.enable_tracking_log?this.Logger.zsymb(21,"_VAQwZ",["forwardMessageFromLocal fail : {} {}","-WEiVK"],JSON.stringify(u),e):this.Logger.zsymb(21,"KU2G9d",["forwardMessageFromLocal fail : {}","8CwuCl"],JSON.stringify(u)),Ia.default.logActionInfoV2(Ia.FeaturesInfo.ForwardMsgFail,0,u)}}};Object(a.injectable)()(vb=Object(a.singleton)(pb.a)(vb=function(e,t){return Object(a.inject)(xv)(e,void 0,0)}(vb=Reflect.metadata("design:type",Function)(vb=Reflect.metadata("design:paramtypes",[Object])(vb=class{constructor(e){this.poolFactory=e,this._pool=void 0}async forwardMessages(e,t,s={}){this.pool||this.initializePool(),e.forEach((e=>{e.toUid||(e.toUid=e.userId)}));const a=this.buildTask(e,t,s||{});return this.pool.use(a).then((e=>Promise.resolve(e)))}async retryForwardMessages(e,t={}){const s=Object(I.a)(Object(I.a)({},t),{},{retry:!0});this.pool||this.initializePool();const a=e.map((e=>e.toUid)),i=this.buildTask(e,a,s);return this.pool.use(i).then((e=>Promise.resolve(e)))}buildTask(e,t,s){return async()=>{try{return await this.runTaskInSerialization(e,t,s)}catch(a){return Promise.reject(a)}}}cleanUp(){this.pool&&this.pool.drain(),this.pool=void 0}initializePool(){const e={max:Object(mb.b)(),min:Object(mb.c)(),autostart:!0};this.pool=this.poolFactory.createPool({create:async()=>({}),destroy:async()=>{}},e)}async runSubTask(e,t,s){const[a,i]=fb(e);if(null==i)return Promise.reject("Invalid handler");try{const a=new gb(i,Object(mb.a)());return await a.execute({message:e,toUids:t,options:s})}catch(n){return Promise.reject(n)}}async runTaskInSerialization(e,t,s){const a=[];e.forEach((e=>{a.push(this.runSubTask.bind(null,Object(I.a)(Object(I.a)({},e),{},{mentions:null}),t,s))}));const i=new _b(e,t);i.startForward();const n=await async function(e){if(!Array.isArray(e))return Promise.reject("Params functions is invalid");const t=[...e],s=[];for(const i of t)try{const e=await i();s.push({isSuccess:!0,data:e})}catch(a){s.push({isSuccess:!1,error:a})}return s}(a);try{const e=n.map(((e,t)=>e.data));i.endForward(e)}catch(o){}const r=n.map(((t,s)=>({id:e[s].msgId,isSuccess:t.isSuccess,data:t.data,error:t.error})));return Promise.resolve(r)}get pool(){return this._pool}set pool(e){this._pool=e}})||vb)||vb)||vb)||vb);const bb=Object(a.define)("ACTIVE_CONVERSATION_INFO_LIST_FOR_PIN_TOPIC");var Ib;Object(a.injectable)()(Ib=Object(a.singleton)(bb)(Ib=class{constructor(){this._activeConversationInfoList=new Map}activateConversation(e,t){if(!e||!t)return;const s=this._activeConversationInfoList.get(e);if(s){const a=s.tokens.indexOf(this._getToken(e,t));-1===a&&s.tokens.push(this._getToken(e,t));const i=s.windowIds.indexOf(t);-1===i&&s.windowIds.push(t),-1!==a&&-1!==i||(s.lastModified=Date.now(),this._activeConversationInfoList.set(this._getKey(e),s))}else this._activeConversationInfoList.set(this._getKey(e),{lastModified:Date.now(),tokens:[this._getToken(e,t)],windowIds:[t]})}deactivateConversation(e,t){const s=this._activeConversationInfoList.get(e);if(s){s.lastModified=Date.now();let a=s.tokens.indexOf(this._getToken(e,t));a>-1&&s.tokens.splice(a,1);const i=s.windowIds.indexOf(t);i>-1&&s.windowIds.splice(i,1),0===s.windowIds.length&&0===s.tokens.length?this._activeConversationInfoList.delete(e):this._activeConversationInfoList.set(e,s)}}getActiveConversationInfo(e){const t=this._activeConversationInfoList.get(e);return t?{lastModified:t.lastModified,tokens:[...t.tokens],windowIds:[...t.windowIds]}:{lastModified:0,tokens:[],windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfoList.size>0&&(e=Array.from(this._activeConversationInfoList.keys())),e}_getKey(e){return e}_getToken(e,t){return`${e}_${t}`}})||Ib);var yb=s("+3r3"),Sb=s("YYsv"),Cb=s("3ZdV");var Eb=Object(a.define)("pin-topic-data-repository");var Ob=Object(a.define)("pin-topic-message-loader"),Mb=s("0URt"),Tb=s("DRpF");function wb(e){return!(-1===Object(Mb.g)().indexOf(e.msgType))&&!Object(Tb.a)(e)}function Rb(e,t,s){return s===e?1:s<t?0:-1}function Lb(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,a=function(e){return xm.a.isOverflowAtTime(e)}(s);if(a)return t.needFetch=!0,t.reason="overflow",t;const i=function(e){return Date.now()-e>Object(Cb.e)()}(s);if(i)return t.needFetch=!0,t.reason="expired",t;const r=function(e){const t=n.default.getInstance().getItemForCurrentUser(Sb.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return r?(t.needFetch=!0,t.reason="forcedByServer",t):t}function Db(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}var Ab=s("UIHX");function Fb(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function kb(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function Nb(e,t,s){let a=t;const{topics:i}=s;if(!Array.isArray(i))return a;switch(e){case Ab.a.ADD:{const{index:e}=s;a=null==e?[...i,...t]:[...t.slice(0,e),...i,...t.slice(e)];break}case Ab.a.REMOVE:{const e={};i.forEach((t=>{e[t.id]=t.type})),a=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&a.push(t)}));break}}return a}function Pb(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const a=e[s];a&&(null!=a.id&&(a.id=a.id.toString()),null!=a.topicId&&(a.topicId=a.topicId.toString()),null!=a.type&&(a.type=parseInt(a.type)),null!=a.topicType&&(a.topicType=parseInt(a.topicType)),t.push(a))}return t},s=Object(I.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function jb(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}function Ub(e){return new Promise((t=>{let s=0,a=0,i={};for(let n in e)s++,e[n].then((e=>{i[n]=e,a++,a===s&&t(i)})).catch((()=>{i[n]=null,a++,a===s&&t(i)}));0===s&&t({})}))}function Bb(e,t){return Object(uv.f)(e,Number.isInteger(+t)?t:1/0)}var zb=Object(a.define)("pin-topic-one-on-one-controller");var Gb=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(18,"mlHsVt",...t)}info(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(0,"MhGDOS",...t)}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(R.ZLoggerNametags.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return a.ModuleContainer.resolve(es.ZLoggerFactory)}},xb=function(e){return e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(xb||{});var Vb,Hb=class extends Gb{constructor(){super(Ab.f.OneOnOneController,[xb.CONTROL,xb.CREATE,xb.LOAD,xb.REORDER,xb.UNPIN])}infoControl(...e){this.logInfo(xb.CONTROL,...e)}infoCreate(...e){this.logInfo(xb.CREATE,...e)}infoLoad(...e){this.logInfo(xb.LOAD,...e)}infoReorder(...e){this.logInfo(xb.REORDER,...e)}infoUnpin(...e){this.logInfo(xb.UNPIN,...e)}errorControl(...e){this.logError(xb.CONTROL,...e)}errorCreate(...e){this.logError(xb.CREATE,...e)}errorLoad(...e){this.logError(xb.LOAD,...e)}errorReorder(...e){this.logError(xb.REORDER,...e)}errorUnpin(...e){this.logError(xb.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Cb.g)()}};Object(a.injectable)()(Vb=Object(a.singleton)(zb)(Vb=function(e,t){return Object(a.inject)(Eb)(e,void 0,0)}(Vb=function(e,t){return Object(a.inject)(Ob)(e,void 0,1)}(Vb=Reflect.metadata("design:type",Function)(Vb=Reflect.metadata("design:paramtypes",[Object,Object])(Vb=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new Hb,this.requestID=new De.a}getPinTopic(e,t,s){return new Promise(((a,i)=>{this.loadPinTopics(e).then((e=>{const{topics:n}=e,r=n.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));r?a(r):i(null)})).catch(i)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(Cb.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t=!1){if(!Object(Cb.k)())return Promise.reject({code:Sb.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var a;let i;t&&(i=Sb.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const n=await this.DataRepository.loadPinTopics(e,i);return this.Logger.infoLoad(s,`res cId:${e}`,!!n,n.conversationId,null===(a=n.topics)||void 0===a?void 0:a.length),{conversationId:n.conversationId,topics:n.topics}}catch(i){return this.Logger.errorLoad(s,`err cId:${e}`,Bb(i,Object(Cb.a)())),Promise.reject(i)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)if(s[i]===t){s.splice(i,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(Cb.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,Bb(e.data,Object(Cb.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,Bb(s,Object(Cb.a)())),e.act===Sb.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),Ub(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.conversationId,s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,Bb(s,Object(Cb.a)()))}))}async createPinTopic(e,t,s=2){if(!Object(Cb.k)())return Promise.reject({code:Sb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoCreate(a,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:Sb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorCreate(a,`err cId:${e}`,Bb(n,Object(Cb.a)())),Promise.reject(n)}}async reorderPinTopics(e,t,s=2){if(!Object(Cb.k)())return Promise.reject({code:Sb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoReorder(a,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Sb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorReorder(a,`err cId:${e}`,Bb(n,Object(Cb.a)())),Promise.reject(n)}}async unpinPinTopics(e,t,s=2){if(!Object(Cb.k)())return Promise.reject({code:Sb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoUnpin(a,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Sb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorUnpin(a,`err cId:${e}`,Bb(n,Object(Cb.a)())),Promise.reject(n)}}isMessagePinnable(e){return function(e){return wb(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(yb.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const a=(()=>{if(t.type===Sb.i.MESSAGE){const a=s.topics,i=t.params.global_msg_id,n=t.params.client_msg_id,r=t.params.senderUid;for(let t=0;t<a.length;t++){const s=a[t];if(s.type===Sb.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=i&&t.msgId===i)return s;if(null!=t&&null!=n&&t.cliMsgId===n&&t.fromUid===r&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(Cb.c)()||a?{enable:!0,oldTopic:a}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,Sb.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:a}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(a,Sb.e.OUT_OF_DATE);return s?await s():e}catch(i){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,Sb.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:Sb.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(a){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:Sb.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:Sb.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===Sb.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===Sb.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===Sb.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===Sb.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return ce.b.getStateNetwork()===ce.a.CONNECTED}notifyEvent(e,...t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)"function"==typeof s[i]&&s[i](...t)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s=2){if(!this.FriendManager.isFriend(e))return Promise.reject({code:Sb.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:Sb.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(e,s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(n){if(n.code===Sb.c.PINBOARD_OVER_MAXIMUM){var a;const s=null==n||null===(a=n.data)||void 0===a?void 0:a.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(n)}}}async processReorderPinTopics(e,t,s=2){try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(i){return Promise.reject(i)}}}async processUnpinPinTopics(e,t,s=2){try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(i){return Promise.reject(i)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:Sb.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return Ii.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||Vb)||Vb)||Vb)||Vb)||Vb);var Wb,qb=s("74m0");Object(a.injectable)()(Wb=Object(a.singleton)(qb.a)(Wb=function(e,t){return Object(a.inject)(zb)(e,void 0,0)}(Wb=Reflect.metadata("design:type",Function)(Wb=Reflect.metadata("design:paramtypes",[Object])(Wb=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(Tb.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(Tb.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(Tb.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return Cb.k()}isEnablePinTopicOneOnOneEntryPoint(){return Cb.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==Y.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(Tb.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(Tb.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(Tb.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return wb(e)}get OneOnOneController(){return this.oneOnOneController}})||Wb)||Wb)||Wb)||Wb);var Kb=Object(a.define)("pin-topic-storage"),$b=Kb;var Zb,Qb=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var Yb=Object(a.injectable)()(Zb=function(e,t){return Object(a.inject)($b)(e,void 0,0)}(Zb=Reflect.metadata("design:type",Function)(Zb=Reflect.metadata("design:paramtypes",[Object])(Zb=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=Qb(),this.clientMsgCache=Qb()}clear(e){switch(e){case Ab.g.GLOBAL:return void this.globalMsgCache.clear();case Ab.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e,t){return new Promise(((s,a)=>{t&&0!==t.length||a("Invalid topics");const i=t.length;for(let n=0;n<i;n++){const s=t[n];if(!s)continue;let i=kb(s);if(i&&"0"!==i)this.getMessage(e,Ab.g.GLOBAL,i).then().catch((e=>{a(e)}));else{let t=Fb(s);if(t){let i=s.params&&s.params.senderUid;this.getMessage(e,Ab.g.CLIENT,t,{userId:i}).then().catch((e=>{a(e)}))}}}s()}))}getMessageFromTopic(e){if(e.type!==Ab.i.MESSAGE||!e.params)return{};let t=kb(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=Fb(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=kb(e),s=Fb(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s,a={}){return new Promise(((i,n)=>{switch(t){case Ab.g.GLOBAL:{let a=this.globalMsgCache.get(s);a?i(a):this.storage.getMessagesByIds(e,[s]).then((e=>{e?(this.setMessage(t,s,e),i(e)):n("Not found")})).catch((e=>{n(e)}));break}case Ab.g.CLIENT:{const{userId:r}=a;let o=this.clientMsgCache.get(s);o?i(o):this.storage.getMessageByCliMsgId(e,s,{myUID:Ii.default.getUidMe(),userId:r}).then((e=>{e?(this.setMessage(t,s,e),i(e)):n("Not found")})).catch((e=>{n(e)}));break}default:n("Unknown")}}))}setMessage(e,t,s){switch(e){case Ab.g.GLOBAL:return void this.globalMsgCache.set(t,s);case Ab.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||Zb)||Zb)||Zb)||Zb;a.ModuleContainer.register(Ob,Yb);var Jb=s("vSga");var Xb=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var eI=function(e){const t=[];let s=!1;const a=e||(()=>{}),i=()=>t.length,n=e=>{s=e},r=()=>{if(s)return;if(!i())return void a();const e=t.shift();e&&(n(!0),e().then((()=>{n(!1),r()})).catch((()=>{n(!1),r()})))};return{enqueue:e=>{t.push(e),r()},dequeue:r,getLength:i}};var tI=function(){const e=[];let t;const s=()=>e.length,a=(i,n)=>{if(n&&(t=n),!s())return t&&t(i);const r=e.shift();r&&((e,t)=>{const{callback:s}=e;let i;"function"==typeof s&&(i=s(e.data,t)),a(i)})(r,i)};return{enqueue:t=>{e.push(t)},dequeue:a,getLength:s}},sI=s("u+F0");var aI=Object(a.define)("pin-topic-request-handler"),iI=function(e){return e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(iI||{});var nI,rI=class extends Gb{constructor(){super(Ab.f.DataRepository,[iI.CONTROL,iI.CREATE,iI.FETCH,iI.LOAD,iI.REORDER,iI.UNPIN])}infoControl(...e){this.logInfo(iI.CONTROL,...e)}infoCreate(...e){this.logInfo(iI.CREATE,...e)}infoFetch(...e){this.logInfo(iI.FETCH,...e)}infoLoad(...e){this.logInfo(iI.LOAD,...e)}infoReorder(...e){this.logInfo(iI.REORDER,...e)}infoUnpin(...e){this.logInfo(iI.UNPIN,...e)}errorControl(...e){this.logError(iI.CONTROL,...e)}errorCreate(...e){this.logError(iI.CREATE,...e)}errorFetch(...e){this.logError(iI.FETCH,...e)}errorLoad(...e){this.logError(iI.LOAD,...e)}errorReorder(...e){this.logError(iI.REORDER,...e)}errorUnpin(...e){this.logError(iI.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Cb.h)()}};var oI=Object(a.injectable)()(nI=function(e,t){return Object(a.inject)($b)(e,void 0,0)}(nI=function(e,t){return Object(a.inject)(aI)(e,void 0,1)}(nI=Reflect.metadata("design:type",Function)(nI=Reflect.metadata("design:paramtypes",[Object,Object])(nI=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=Xb(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new rI,this.requestID=new De.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t=!1){this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s={}){return new Promise(((a,i)=>{const n=this.getRequestID();this.Logger.infoCreate(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{checkEnableToCreate:o}=s||{};let l=null;if(o){const{enable:s,oldTopic:a}=o(e,t,r);if(!s)return this.Logger.infoCreate(n,`cId:${e} react limit`),i({code:sI.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:r}});a&&(l=a)}const{version:c}=r;this.Logger.infoCreate(n,`cId:${e}`,c),this.Fetcher.createTopic(e,t,c).then((t=>{this.Logger.infoCreate(n,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=c,l&&(s.oldTopic={topicId:l.id,topicType:l.type}),s=Pb(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>a(e))))})).catch((t=>{const s=t.error;s.data=Object(I.a)(Object(I.a)({},null==s?void 0:s.data),{},{cache:r}),this.Logger.errorCreate(n,`cId:${e}, create topic fail`,Bb(t,Object(Cb.b)())),i(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,a)=>{if(this.Logger.infoControl(`call ${e}`,Bb(t,Object(Cb.b)())),e===Ab.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return a("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var i;const n=null===(i=e[t])||void 0===i?void 0:i.toString();n&&(this.clearPinTopicsForConversation(n),this.fetchTopics(n).then((e=>{s(e)})).catch(a))}}else{const{conversationId:i}=t;this.loadDataFromCacheOrDB(i).then((i=>{this.processEventControl(e,t,i,s,a)}))}}))}loadPinTopics(e,t){return new Promise(((s,a)=>{e||a({status:Ab.h.ERROR,error:{code:sI.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const i=this.getRequestID();if(this.Logger.infoLoad(i,`call cId:${e}`),t&&t!==Ab.d.NONE)return this.Logger.infoLoad(i,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((n=>{if(this.Logger.infoLoad(i,`cId:${e}`),t===Ab.d.NONE)return s(n);this.doCheckAndFetchData(n).then((e=>{s(e)})).catch(a)}))}))}reorderPinTopics(e,t){return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoReorder(i,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=Db(t);this.Logger.infoReorder(i,`cId:${e}`,r),this.Fetcher.reorderTopics(e,o,r).then((a=>{this.Logger.infoReorder(i,`cId:${e}, reorder topic success`);let n=a.response.data;n.oldVersion=r,n.topics=t,n=Pb(n),this.enqueueEvent(e,this.setTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(i,`cId:${e}, reorder topic fail`,Bb(t,Object(Cb.b)())),a(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoUnpin(i,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=Db(t);this.Logger.infoUnpin(i,`cId:${e}`,r),this.Fetcher.unpinTopics(e,o,r).then((a=>{this.Logger.infoUnpin(i,`cId:${e} unpin topic success`);let n=a.response.data;n.oldVersion=r,n.topics=t,n=Pb(n),this.enqueueEvent(e,this.removeTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(i,`cId:${e}, unpin topic fail`,Bb(t,Object(Cb.b)())),a(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=tI():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((a=>{const i=this.handleLoadDBFinish(e,a);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:Ab.h.SUCCESS,response:{data:i}})})).catch((a=>{const i=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,Bb(null==a?void 0:a.error,Object(Cb.b)())),t({status:Ab.h.ERROR,response:{data:i}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let a;var i;t&&(a={conversationId:(i=t).conversationId,topics:i.topics,version:i.boardVersion,lastFetch:i.lastFetch,lastModified:Date.now()}),t&&(null===(s=a)||void 0===s?void 0:s.conversationId)===e||(a=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let n=a;if(!Lb(n).needFetch&&this.isInPending(e)){const t=e=>{e&&(n=e)};this.pendingWhenLoadQueue[e].dequeue(a,t)}return this.closePendingQueue(e),n}fetchTopics(e,t=0){this.openPendingQueue(e);return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoFetch(i,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(i,`cId:${e} success`),this.closePendingQueue(e);const{response:a}=t,n=a.data.topics;for(let e=0;e<n.length;e++)n[e]=jb(n[e]);this.loadExtraDataForTopics(n).then((t=>{const i={conversationId:e,topics:t,version:a.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,i),this.setTopicsToDB(i),s(i)}))})).catch((t=>{this.Logger.errorFetch(i,`cId:${e} fail`,Bb(t,Object(Cb.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const a=Lb(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${a.needFetch} reason:${a.reason}`),!a.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:Nb(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s=0){const a=this.getCache(e),{topic:i,version:n}=t;let r=Date.now(),o=[];a?(o=Nb(Ab.a.ADD,a.topics,{topics:[i],index:s}),r=a.lastFetch):o.push(i),t.lastFetch&&(r=t.lastFetch);const l={conversationId:e,topics:o,version:n,lastModified:Date.now(),lastFetch:r};return this.setToCache(e,l)}removeInCache(e,t,s=0){if(!this.cache.has(e))return null;const a=this.getCache(e),{topics:i}=a;if(t.topic)for(let r=0;r<i.length;r++){const e=i[r];if(e.id===t.topic.id&&e.type===t.topic.type){i.splice(r,1);break}}else i.splice(s,1);const n={conversationId:e,topics:i,version:t.version,lastModified:Date.now(),lastFetch:a.lastFetch};return this.setToCache(e,n)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=eI(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((a,i)=>{if(this.isInPending(e)){const s={data:{type:Ab.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const n=i=>{const{oldVersion:n,version:r}=t,o=Rb(n,r,i.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,n,r,i.version),1===o){const{oldTopic:i,index:n,topic:o}=t;i&&i.topicId&&this.removeInCache(e,{topic:{id:i.topicId,type:i.topicType},version:r}),jb(o),this.loadExtraDataForTopics([o]).then((i=>{const r={topic:i[0],version:t.version},o=this.addToCache(e,r,n);this.setTopicsToDB(o),a(),s&&s(this.getCache(e))})).catch((()=>{a()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}removeTopics(e,t,s){return new Promise((a=>{if(this.isInPending(e)){const s={data:{type:Ab.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const i=i=>{const{oldVersion:n,version:r}=t,o=Rb(n,r,i.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,n,r,i.version),1===o){const{topics:n}=t;let o=i;for(let t=0;t<n.length;t++)o=this.removeInCache(e,{topic:n[t],version:r});return this.setTopicsToDB(o),s&&s(this.getCache(e)),a()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{i(e)}))}))}setTopics(e,t,s){return new Promise((a=>{if(this.isInPending(e)){const s={data:{type:Ab.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const i=i=>{const{oldVersion:n,version:r}=t,o=Rb(n,r,i.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,n,r,i.version),1===o){const n=i.topics,r=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],a=n.find((e=>e.id===s.id&&e.type===s.type));a&&r.push(a)}const o={conversationId:e,topics:r,version:t.version,lastModified:Date.now(),lastFetch:(null==i?void 0:i.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),a()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{i(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const a=s.response.data;this.setToCache(e,a),t(a)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const a={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(a).then(t).catch(s)}))}processEventControl(e,t,s,a,i){const{conversationId:n}=t;let r={oldVersion:t.oldVersion,version:t.version};const o=Pb(t);switch(e){case Ab.c.CREATE:r=Object(I.a)(Object(I.a)({},r),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(n,this.addTopic.bind(this,n,r,(e=>a(e))));break;case Ab.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),r=Object(I.a)(Object(I.a)({},r),{},{topics:t}),this.enqueueEvent(n,this.removeTopics.bind(this,n,r,(e=>a(e))));break}case Ab.c.REORDER:{var l;const e=[],t=(null===(l=o.topics)||void 0===l?void 0:l.length)||0;for(let a=0;a<t;a++){var c;const t=null===(c=o.topics)||void 0===c?void 0:c[a];if(t&&null!=t.topicId&&null!=t.topicType){const a=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));a&&e.push(a)}}r=Object(I.a)(Object(I.a)({},r),{},{topics:e}),this.enqueueEvent(n,this.setTopics.bind(this,n,r,(e=>a(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const a={};for(let o=0;o<e.length;o++){var i,n;const s=e[o];if((null===(i=s.params)||void 0===i?void 0:i.msg_type)===Y.MSG_STICKER||(null===(n=s.params)||void 0===n?void 0:n.msg_type)===Y.CLI_MSG_TYPE_STICKER){var r;const e=null===(r=s.params)||void 0===r?void 0:r.extra;e&&null!=e.catId&&null!=e.id&&(a[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(a).length>0?Ub(a).then((a=>{for(let s=0;s<e.length;s++){const i=e[s],n=a[t(i)];n&&n.id===parseInt(i.params.extra.id)&&n.cateId===parseInt(i.params.extra.catId)&&(i.params.thumb=n.stickerUrl||"",e[s]=i)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return Jb.g}get Storage(){return this.storage}})||nI)||nI)||nI)||nI)||nI;a.ModuleContainer.register(Eb,oI);var lI=class{createOneOnOneTopic(e="",t,s=0,a="vi"){let i={conversationId:e,topic:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12067)}getListOneOnOnePinTopics(e="",t=0){let s={conversationId:e,version:t};ui.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const a=H.b.getFriendBoardDomain()+"/api/friendboard/list?"+Jr.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(a,null,12065)}reorderOneOnOnePinTopics(e="",t,s=0,a="vi"){let i={conversationId:e,topics:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12068)}unpinOneOnOneTopics(e="",t,s=0,a="vi"){let i={conversationId:e,topics:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12069)}getCommonParams(){return Jr.default._getCommonParams()}getEncodedParams(e){return Jr.default.getEncodedParams(e)}getRequest(e,t,s,a,i,n,r,o,l){return Jr.default._get(e,t,s,a,i,n,r,o,l)}};var cI=function(){let e;function t(){return e||(e=new lI),e}const s=e=>new Promise(((t,s)=>{e.then(Xr.a).then(t).catch(s)}));return{createOneOnOneTopic:(e,a,i=0)=>{const n=Object(I.a)({},a),{params:r}=n;r&&r.extra&&r.extra.constructor===Object&&(r.extra=JSON.stringify(r.extra)),r&&(n.params=JSON.stringify(r)),null==n.src&&(n.src=-1),null==n.pinAct&&(n.pinAct=1);const o=le.a.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,n,i,o))},getListOneOnOnePinTopics:(e,a=0)=>s(t().getListOneOnOnePinTopics(e,a)),reorderOneOnOnePinTopics:(e,a,i=0)=>{const n=le.a.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,a,i,n))},unpinOneOnOneTopics:(e,a,i=0)=>{const n=le.a.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,a,i,n))}}},dI=function(e){return e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin",e}(dI||{});var uI=class extends Gb{constructor(){super(Ab.f.Network,[dI.CREATE,dI.FETCH,dI.REORDER,dI.UNPIN])}infoCreate(...e){this.logInfo(dI.CREATE,...e)}infoFetch(...e){this.logInfo(dI.FETCH,...e)}infoReorder(...e){this.logInfo(dI.REORDER,...e)}infoUnpin(...e){this.logInfo(dI.UNPIN,...e)}errorCreate(...e){this.logError(dI.CREATE,...e)}errorFetch(...e){this.logError(dI.FETCH,...e)}errorReorder(...e){this.logError(dI.REORDER,...e)}errorUnpin(...e){this.logError(dI.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Cb.i)()}};var hI,gI=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=cI(),this.logger=new uI,this.requestID=new De.a}async fetchTopics(e,t=0){const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const a=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,a.version),{status:Ab.h.SUCCESS,response:{data:{topics:a.data,version:a.version}}}}catch(a){return this.Logger.errorFetch(s,`cId:${e} fail`,Bb(a,Object(Cb.d)())),Promise.reject({status:Ab.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async createTopic(e,t,s=0){const a=this.getRequestId();this.Logger.infoCreate(a,`call cId:${e}`,s);try{const i=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(a,`cId:${e} success`,i.version),{status:Ab.h.SUCCESS,response:{data:{topic:i.data,version:i.version}}}}catch(i){return this.Logger.errorCreate(a,`cId:${e} fail`,Bb(i,Object(Cb.d)())),Promise.reject({status:Ab.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async unpinTopics(e,t,s=0){const a=this.getRequestId();this.Logger.infoUnpin(a,`call cId:${e}`,s);try{const i=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(a,`cId:${e} success`,i.version),{status:Ab.h.SUCCESS,response:{data:i}}}catch(i){return this.Logger.errorUnpin(a,`cId:${e} fail`,Bb(i,Object(Cb.d)())),Promise.reject({status:Ab.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async reorderTopics(e,t,s=0){const a=this.getRequestId();this.Logger.infoReorder(a,`call cId:${e}`,s);try{const i=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(a,`cId:${e} success`,i.version),{status:Ab.h.SUCCESS,response:{data:i}}}catch(i){return this.Logger.errorUnpin(a,`cId:${e} fail`,Bb(i,Object(Cb.d)())),Promise.reject({status:Ab.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};a.ModuleContainer.register(aI,gI);var mI=Object(a.singleton)(Kb)(hI=class{constructor(){this._storage=void 0}async clearTopics(e,t=!1){try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},a=["topics"];s=this.storage.updateGroupTopic(t,a)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=n.default.getInstance().getItemForCurrentUser(Ab.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e,t){try{const s=await this.storage.getMessagesByIds(e,t);let a;t&&t.length>0&&(a=t[0]);let i=null;return a&&(i=s[a]),i||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}async getMessageByCliMsgId(e,t,s={}){try{const{myUID:a,userId:i}=s;if(i){let s=i;a==i&&(s="0");const n=await this.storage.getMessageByCliMsgIdOwnerId(e,t,s);return n||Promise.reject("Not found")}const n=await this.storage.getMessageByCliMsgId(t,e);if(!n||!n.length)return Promise.reject("Not found");n.length;const r=n&&n[0];return r||Promise.reject("Not found")}catch(a){return Promise.reject(a)}}setEntryPointPromotionalTooltipShowedStatus(e){n.default.getInstance().setItemForCurrentUser(Ab.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){n.default.getInstance().setItemForCurrentUser(Ab.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:Ab.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:Ab.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||hI;a.ModuleContainer.register($b,mI);var pI=s("RF0b"),fI=s("z7jJ"),vI=s("3ZsK"),_I=s("k5QF"),bI=s("oEIH");function II(e,t,s,a=hr.c){let i;switch(t){case"error":i=be.TOAST_TYPE.ERROR;break;case"info":default:i=be.TOAST_TYPE.INFO;break;case"success":i=be.TOAST_TYPE.SUCCESS;break;case"warning":i=be.TOAST_TYPE.WARNING}be.ZToastManagerHolder.getZToastManagerByWindowId(a).show({duration:s,noBackground:!0,textKey:e,type:i})}var yI={error:function(e,t,s){II(e,"error",null!=s?s:3e3,t)},info:function(e,t,s){II(e,"info",null!=s?s:3e3,t)},success:function(e,t,s){II(e,"success",null!=s?s:3e3,t)},warning:function(e,t,s){II(e,"warning",null!=s?s:3e3,t)}},SI=s("AyM1"),CI=s("3Ewa");var EI,OI=class{constructor(e,t){this.conversationId=e,this.windowId=t,this.dispatch=null,this.events={},this.topics=[],this.toDispatch=e=>{"function"==typeof this.dispatch&&this.dispatch(Object(I.a)({windowId:this.windowID},e))}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}cancelLimitationModal(e){Object(Tb.d)(this.conversationID)||(e===Sb.f.CONFIRM?bI.a.logAction(bI.a.OneOnOne.LimitationModal.CLOSE_MODAL):e===Sb.f.MULTI_UNPIN&&bI.a.logAction(bI.a.OneOnOne.LimitationMultipleUnpinModal.CLOSE_MODAL))}cancelUnpinModal(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLOSE_UNPIN_MODAL)}cleanUp(){this.events={},this.setDispatch(null)}clickCancelOnLimitationModal(e){Object(Tb.d)(this.conversationID)||(e===Sb.f.CONFIRM?bI.a.logAction(bI.a.OneOnOne.LimitationModal.CLICK_CANCEL):e===Sb.f.MULTI_UNPIN&&bI.a.logAction(bI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CANCEL))}clickCancelUnpinTopic(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_NOT_UNPIN_FROM_MODAL)}clickConfirmOnLimitationModal(e,t,s){if(Object(Tb.d)(this.conversationID)||(s===Sb.f.CONFIRM?bI.a.logAction(bI.a.OneOnOne.LimitationModal.CLICK_CONFIRM):s===Sb.f.MULTI_UNPIN&&bI.a.logAction(bI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CONFIRM)),Array.isArray(e)&&e.length>0)this.unpinTopics(e).then((()=>{if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(Mb.a)(e,Sb.b.UNPIN_MODAL);bI.a.locActionDetails(t)}}))}))}}));else if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(Mb.a)(e,Sb.b.UNPIN_MODAL);bI.a.locActionDetails(t)}}))}))}}clickConfirmUnpinTopic(e){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_UNPIN_FROM_MODAL),this.unpinTopic(e)}clickCopyTopic(e){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_COPY),this.copyTopic(e)}clickTopic(e){switch(Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.LEFT_CLICK),e.type){case Y.TEXT_TOPIC:case Y.LINK_TOPIC:break;case Y.MSG_TOPIC:this.jumpToMessage(this.conversationID,e,this.toDispatch);case Y.POLL_TOPIC:case Y.REMINDER_TOPIC:}}clickRaiseTopic(e){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_PUSH_TO_TOP),this.raiseTopic(e)}clickShowMoreIcon(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_THREE_DOT)}clickSwitchToMultipleUnpinTopicsMode(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.LimitationModal.CLICK_CHANGE_OPTION)}clickTopicToSelectForUnpin(e){Object(Tb.d)(this.conversationID)||e&&bI.a.logAction(bI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_TOPIC_TO_SELECT_FOR_UNPIN)}clickUnpinTopic(e){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.CLICK_UNPIN),this.showUnpinTopicModal(e)}collapseBoard(e){const t=Object(Tb.d)(this.conversationID);switch(e){case Sb.a.BUTTON_CLICKED:t||bI.a.logAction(bI.a.OneOnOne.Board.COLLAPSE_BY_CLICK_BUTTON);break;case Sb.a.BY_ESC:t||bI.a.logAction(bI.a.OneOnOne.Board.COLLAPSE_BY_ESC);break;case Sb.a.OUTSIDE_CLICKED:t||bI.a.logAction(bI.a.OneOnOne.Board.COLLAPSE_BY_CLICK_OUTSIDE)}}copyTopic(e){if(!e)return;let t="";const s=e.params;switch(e.type){case Y.MSG_TOPIC:s&&(t=s.title);break;case Y.LINK_TOPIC:case Y.TEXT_TOPIC:s&&(s.linkCaption?t=s.linkCaption:s.title&&(t=s.title))}t.length>0?ui.default.copyTextToClipboard(t):yI.error(le.a.str("STR_ERROR_UNKNOWN"),this.windowId)}createPinTopic(e){return Sb.j.GetManager().createPinTopic(this.conversationId,e).catch((e=>{if(e.code===Sb.c.FULL_THREAD_PIN_TOPIC&&!e.message){const t=Ii.default.getDName(this.conversationID);if(t)return Wo.default.createError(le.a.trans("STR_PIN_FRIEND_REACH_PIN_LIMIT",[t]),5e3),Promise.reject(e)}return e.message&&yI.error(le.a.str(e.message),this.windowId),Promise.reject(e)}))}createPinTopicFromMessage(e,t=Sb.b.UNKNOWN){var s;let i=null===(s=Ce.default.settings.group.topic_colors)||void 0===s?void 0:s[0],n=Y.MSG_TOPIC;const r=Object(I.a)({},e);let o=r.fromUid;if(!o||"0"===o){const e=a.ModuleContainer.resolve(m.a);var l;if(e)o=null===(l=e.getSession())||void 0===l?void 0:l.userId}const c=ui.default.getUnicodeCorrMSGType(r);let d={client_msg_id:r.cliMsgId,global_msg_id:r.msgId,senderUid:o,senderName:r.dName||""};switch(r.msgType){case Y.MSG_CONTACT:switch(r.message.action){case"recommened.link":case"recommened.user":case"recommened.stickerset":case"recommened.vip":if(d.href=r.message.href,d.thumb=r.message.thumb,d.title=r.message.title,d.linkCaption=r.message.title,"recommened.link"===r.message.action&&r.message.params){let e=JSON.parse(r.message.params);!d.title&&e&&e.mediaTitle&&(d.title=e.mediaTitle),d.redirect_url=e.redirect_url?e.redirect_url:"",d.streamUrl=e.streamUrl?e.streamUrl:"",d.artist=e.artist?e.artist:"",d.stream_icon=e.stream_icon?e.stream_icon:"",d.type=e.type?e.type:""}}d.extra={action:r.message.action},"recommened.user"===r.message.action?d.extra.dpn=d.title:"recommened.link"===r.message.action&&r.message.params&&(d.extra.params=r.message.params),d.msg_type=Y.CLI_MSG_TYPE_CONTACT;break;case Y.MSG_TEXT:"string"==typeof r.message?d.title=r.message:r.message&&r.message.title&&(d.title=r.message.title),d.msg_type=Y.CLI_MSG_TYPE_TEXT;break;case Y.MSG_DOODLE:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title,d.msg_type=Y.CLI_MSG_TYPE_DOODLE;break;case Y.MSG_PHOTO:{let e=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl;const t=Object(wp.d)(e),s=Object(wp.g)(e);if(s&&(t||dp.a.jxl.enable_pin_jxl?e=Object(wp.k)(e):(e=Object(wp.o)(e),d.convertible="jxl")),d.thumb=e,d.title=r.message.title,d.msg_type=Y.CLI_MSG_TYPE_PHOTO,r.properties&&r.properties.type===Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER){const e={msgBubbleLayoutType:Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,pStickerType:0},a=r.message.params;if(a){let i=null;if("string"==typeof a)try{i=JSON.parse(a)}catch(p){ui.default.logCoreError("Try to parse params has failed",p)}else a.webp&&(i=a);var u,h;if(i)s&&(t||dp.a.jxl.enable_pin_jxl?i=Object(wp.l)(i):(i=Object(wp.m)(i),d.convertible="jxl")),e.webpUrl=(null===(u=i.webp)||void 0===u?void 0:u.url)||"",e.subType=1,e.pStickerType=null!==(h=i.pStickerType)&&void 0!==h?h:0}d.extra=e}break}case Y.MSG_FILE:d.title=r.message.title,d.extra=r.message.params,d.msg_type=Y.CLI_MSG_TYPE_FILE;break;case Y.MSG_GIF:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.msg_type=Y.CLI_MSG_TYPE_GIF;break;case Y.MSG_STICKER:d.extra=r.message,d.msg_type=Y.CLI_MSG_TYPE_STICKER;break;case Y.MSG_VOICE:d.msg_type=Y.CLI_MSG_TYPE_VOICE;break;case Y.MSG_LOCATION:d.msg_type=Y.CLI_MSG_TYPE_LOCATION,d.title=r.message.desc;break;case Y.MSG_VIDEO:d.msg_type=Y.CLI_MSG_TYPE_VIDEO,d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title;break;case Y.MSG_UNDO:return void Wo.default.createWarning(le.a.str("STR_TOAST_UNDO_MESSAGE"));case Y.MSG_POLL:{let e=null;if(e){let t=e.pollData;t&&(d.title=t.question)}n=Y.POLL_TOPIC;break}case Y.MSG_ZINSTANT_OLD:case Y.MSG_ZINSTANT:{const e=SI.default.getZInstantData(r);d.msg_type=Y.MSG_ZINSTANT,e&&e.customMsg&&(d.extra=Object(I.a)({},e.customMsg));break}default:d.msg_type=r.msgType}const g={color:i,duration:-1,emoji:c,params:d,repeat:0,startTime:-1,type:n};this.createPinTopic(g).then((()=>{const s=Object(Mb.a)(e,t);bI.a.locActionDetails(s)}))}editTopic(e,t){}expandBoard(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Board.EXPAND_BOARD),this.fetchTopics()}fetchTopics(e){let t=e;null==t&&(t=this.conversationID),Sb.j.GetManager().loadPinTopics(t,!0).then((e=>{this.onUpdateTopics(t,e.topics)}))}getConversationID(){return this.conversationID}getTopics(){return this.topics}openBoard(e){}openPinLimitModal(e,t){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.LimitationModal.DISPLAY_MODAL),Ie.ModalManagerV2.openModal({windowId:this.windowID,name:Y.ModalIdentitiesDefine.PIN_LIMIT_MODAL,params:{conversationID:this.conversationID,limitNumber:3,currentTopics:e,pinTopic:t}})}raiseTopic(e){let t=this.topics.slice();const s=t.findIndex((t=>t.id===e.id&&t.type===e.type));s>-1&&(t.splice(s,1),t.unshift(e),Sb.j.GetManager().reorderPinTopics(this.conversationID,t).catch((e=>{e.message&&yI.error(le.a.str(e.message),this.windowId)})))}removeEventListener(e,t){const s=this.events[e];if(!s)return;const a=(s||[]).length;for(let i=0;i<a;i++)if(s[i]===t){s.splice(i,1);break}0===s.length&&delete this.events[e]}rightClick(){Object(Tb.d)(this.conversationID)||bI.a.logAction(bI.a.OneOnOne.Content.RIGHT_CLICK)}setDispatch(e){this.dispatch=e}showContextMenu(){}showUnpinTopicModal(e){Ie.ModalManagerV2.openModal({windowId:this.windowID,name:Y.ModalIdentitiesDefine.UNPIN_MODAL,params:{conversationID:this.conversationID,unpinTopic:e}})}unpinTopic(e){return this.unpinTopics([e])}unpinTopics(e){return Sb.j.GetManager().unpinPinTopics(this.conversationID,e).catch((e=>(e.message&&yI.error(le.a.str(e.message),this.windowId),Promise.reject(e))))}updateConversation(e){this.conversationID!==e&&Sb.j.GetManager().loadPinTopics(e).then((t=>{this.onUpdateTopics(e,t.topics)}))}updateTopics(e){this.onUpdateTopics(this.conversationID,e)}async getMessageFromTopic(e,t){var s;const a=t.params.global_msg_id,i=t.params.client_msg_id,n=t.params.senderUid;return null===(s=zr.b.messageCache)||void 0===s?void 0:s.getMessageAsync(a,e,i,n)}jumpToMessage(e,t,s){let i,n="0",r="0";t.params.global_msg_id&&(n=t.params.global_msg_id),t.params.client_msg_id&&(r=t.params.client_msg_id),null!=t.params.senderUid&&(i=t.params.senderUid),"0"===n&&(n=0);try{const e=CI.a.Tracking.getInstance();e.reset().getBuilder().setEntryPoint(CI.a.EntryPoint.PINNED_MESSAGE),e.track(n)}catch(o){}xr.a.jumpToMessage({msgId:n,cliMsgId:r,fromUid:i},e,s).catch((()=>{if(t&&t.params){var s;const i={allowDelete:!1,allowEdit:!1,allowPin:!1},n=null===(s=a.ModuleContainer.resolve(_I.a))||void 0===s?void 0:s.getWindowIdFromConvId(e);if(!n)return;Ie.ModalManagerV2.openModal({windowId:n,name:Y.ModalIdentitiesDefine.VIEW_NOTICE,params:{viewNoticeMsgAction:Y.VIEW_NOTICE_MSG_ACTION.PIN_MSG,payload:t.params,setting:i}})}else yI.success(le.a.str("STR_MESSAGE_NOT_FOUND"),this.windowId);Object(vI.e)(vI.a.JT_PIN_MSG_NOT_AT_LOCAL)}))}notifyEvent(e,...t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)"function"==typeof s[i]&&s[i](...t)}onUpdateTopics(e,t){this.conversationID===e&&(this.setTopics(t),this.notifyEvent("onchange",t))}setTopics(e){this.topics=e}get conversationID(){return this.conversationId}get windowID(){return this.windowId}},MI=s("JOr/");Object(a.singleton)(MI.a)(EI=Fc()(EI=Ac()(EI=Reflect.metadata("design:type",Function)(EI=Reflect.metadata("design:paramtypes",[])(EI=class{constructor(){this._activeConversationInfoList=void 0,this._controllersMap=new Map,this.isDisplayedOneOnOneEPPromotionalTooltip=void 0,this.isRegisteredEvents=!1,this.modalControllers={},this._activeConversationInfoList=a.ModuleContainer.resolve(bb),this.onChangeData=this.onChangeData.bind(this),this.onExceed=this.onExceed.bind(this)}activateConversation(e,t){const s=this.getToken(e,t);if(!this.isActivatedController(s)){const a=new OI(e,t);this.registerController(s,a),this._activeConversationInfoList.activateConversation(e,t)}}deactivateConversation(e,t){const s=this.getToken(e,t);if(this.isActivatedController(s)){const a=this.controllersMap.get(s);a&&a.cleanUp(),this.unregisterController(s),this._activeConversationInfoList.deactivateConversation(e,t)}}displayOneOnOneEntryPointPromotionalTooltip(){this.isDisplayedOneOnOneEPPromotionalTooltip||(this.isDisplayedOneOnOneEPPromotionalTooltip=!0,Sb.j.GetManager().displayOneOnOneEntryPointPromotionalTooltip())}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return void 0!==this.isDisplayedOneOnOneEPPromotionalTooltip?this.isDisplayedOneOnOneEPPromotionalTooltip:this.isDisplayedOneOnOneEPPromotionalTooltip=Sb.j.GetManager().isDisplayedOneOnOneEntryPointPromotionalTooltip()}loadAndRegisterToDisplayBanner(e){Sb.j.GetManager().loadPinTopics(e).then((t=>{t&&t.conversationId===e&&t.topics&&t.topics.length>0&&this.onChangeData(e,t.topics)})).catch((()=>{}))}onConversationDidClose(e){this.deactivateConversation(e.conversationID,e.windowID)}onConversationWillOpen(e){this.activateConversation(e.conversationID,e.windowID)}getController(e,t){const s=this.getToken(e,t);return this.controllersMap.get(s)}registerController(e,t){this.registerEventListeners(),this.controllersMap.set(e,t)}unregisterController(e){this.controllersMap.delete(e),this.unregisterEventListeners()}getModalController(e){return this.modalControllers[e]}registerModalController(e,t){this.modalControllers[e]=t}unregisterModalController(e){delete this.modalControllers[e]}registerEventListeners(){this.isRegisteredEvents||(this.isRegisteredEvents=!0,Sb.j.GetManager().addEventListener("onchange",this.onChangeData),Sb.j.GetManager().addEventListener("onexceed",this.onExceed))}unregisterEventListeners(){this.isRegisteredEvents&&0===this.controllersMap.size&&(this.isRegisteredEvents=!1,Sb.j.GetManager().removeEventListener("onchange",this.onChangeData),Sb.j.GetManager().removeEventListener("onexceed",this.onExceed))}getActiveControllers(){return Array.from(this.controllersMap.values())}getToken(e,t){return t+"_"+e}isActivatedController(e){return this.controllersMap.has(e)}onChangeData(e,t){var s;const a=this.getActiveControllers();a.length>0&&a.forEach((s=>{s&&s.getConversationID()===e&&s.updateTopics(t.slice())}));const i=null===(s=this.activeConversationInfoList.getActiveConversationInfo(e))||void 0===s?void 0:s.windowIds;Array.isArray(i)&&i.forEach((s=>{this.isActivatedController(this.getToken(e,s))&&(t&&t.length>0?this.requestShowBanner(e,s):this.requestHideBanner(e,s))}))}onExceed(e,t,s){const a=this.getActiveControllers();a.length>0&&a.forEach((a=>{a&&a.getConversationID()===e&&a.openPinLimitModal(t.slice(),Object(I.a)({},s))}))}requestShowBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(pI.a.PIN_TOPIC_BANNER,e)||this.ChatBoxBannerModule.ChatBoxBannerManager().requestShowBanner(pI.a.PIN_TOPIC_BANNER,{convId:e})}requestHideBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(pI.a.PIN_TOPIC_BANNER,e)&&this.ChatBoxBannerModule.ChatBoxBannerManager().requestHideBanner(pI.a.PIN_TOPIC_BANNER,{convId:e})}get activeConversationInfoList(){return this._activeConversationInfoList}get controllersMap(){return this._controllersMap}get ChatBoxBannerModule(){return{ChatBoxBannerManager:()=>a.ModuleContainer.resolve(fI.a)}}})||EI)||EI)||EI)||EI);var TI,wI=s("CPou"),RI=s("MnxE"),LI=s("1rNO"),DI=s("NDwn");Object(Ai.b)(zc.b)(TI=Reflect.metadata("design:type",Function)(TI=Reflect.metadata("design:paramtypes",[])(TI=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=zc.a,this.key=zc.a,1===Ce.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),DI.a||RI.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let a={lockSendMsg:!1};for(let i in e)Object.keys(wI.a).includes(i)&&i===wI.a.lockSendMsg&&(a[wI.a.lockSendMsg]=!t&&!s&&Boolean(e[wI.a.lockSendMsg]));return a}_onUpdateSettings(e,t,s,a){this.me||(this.me=Ii.default.getUidMe());const i=this.me===t,n=this._filterSettingKeys(a,i,s);return this.settings.set(e,n),Object(Po.h)(this.name,e),n}showNoti(e){if("TOAST"===e.type)be.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||hr.c).show(Object(I.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:a}=e,i=this.settings.get(t);return i?(a&&a.triggerValue===i[s]&&this.showNoti(a),i&&i[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let a in t)Object.keys(wI.a).includes(a)&&(s[a]=t[a]);this.settings.set(e,s),Object(Po.h)(this.name,e)}_addPublicGroupSettingEventListener(){hn.default.subscribeEventGroup(Y.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),hn.default.subscribeEventGroup(Y.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),hn.default.subscribeEventGroup(Y.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),hn.default.subscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),K.default.subscribe(hr.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),_e.default.subscribe(((e,t)=>{switch(e){case ve.FetchActions.UPDATE_GROUP_SETTING:{var s,a;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(a=s.groupId)&&void 0!==a&&a.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||Ii.default.isBlocked(e),a=1===Ce.default.block_msg_call_setting.enable_block_msg_call_setting;let i=Boolean(s)&&a;if(!i&&Ii.default.isOA(e,!1)){const t=LI.a(Ii.default.getOAStatus(e));t&&t.enable&&(i=!0)}this.onSettingsUpdate(e,{[wI.a.lockSendMsg]:i})}_addPublicFriendEventListener(){Ii.default.subscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),Ii.default.subscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),_e.default.subscribe(((e,t)=>{if(e===ve.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((({userId:e})=>{this.updateFriendBLockSetting(e)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=Ii.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{hn.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,"7vCcpL","[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const a=s.setting,i=s.creatorId,n=this._checkGroupAdmin(s),r=this._onUpdateSettings(e,i,n,a);a&&!a.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,"38rzAH","[GroupSetting]: Dont have field lockSendMsg in setting data"),t(r)})).catch((s=>{this.Logger.zsymb(18,"_LRP90","[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==Ce.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),DI.a?null:void RI.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||TI)||TI);s("daJc");var AI=s("t5n0"),FI=s("aQZC");var kI,NI=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.appStatus,[R.ZLoggerNametags.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.appStatus,[R.ZLoggerNametags.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.appStatus,[R.ZLoggerNametags.focusStatus])),this.focusStatus}};let PI=Object(a.injectable)()(kI=Object(m.f)()(kI=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(kI=Reflect.metadata("design:type",Function)(kI=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(kI=class extends hs.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&NI.FM.zsymb(0,"BnotTr","disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&NI.FM.zsymb(0,"Xg9Q86","onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,a="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,a=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new AI.a(AI.b.LostFocus,{scope:"app",reason:a})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&NI.FM.zsymb(0,"EPT9i7","onRefocus",e),this.dispatchEvent(new AI.a(AI.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&NI.FM.zsymb(0,"ENnKL5","onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==hr.c)return FI.b;if(this.detectors.has(e))return NI.FM.zsymb(0,"5Fz_Jk","acquire exists",e),this.detectors.get(e);this.enableLog&&NI.FM.zsymb(0,"4MshQw","acquire new",e);const a=new FI.a(e,t,s);return this.listenDetector(e,a),a}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector(hr.c,FI.b)}})||kI)||kI)||kI)||kI)||kI;const jI=Object(a.define)("lost-focus-service"),UI=Object(a.define)("active-service");var BI,zI=function(e){return e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus",e}(zI||{});let GI=Object(a.injectable)()(BI=Object(m.f)()(BI=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(BI=function(e,t){return Object(a.inject)(jI)(e,void 0,1)}(BI=Reflect.metadata("design:type",Function)(BI=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a,void 0===jI?Object:jI])(BI=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=zI.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&NI.FSTT.zsymb(0,"hCZFDF","onAuthenticated",t),this.init()}init(){const e=a.ModuleContainer.resolve(AI.c);e.addEventListener(AI.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==zI.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&fv.b.setAppStatus(fv.a.BACKGROUND),this.currentState=zI.LostFocus)})),e.addEventListener(AI.b.Focus,(e=>{this.currentState==zI.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&fv.b.setAppStatus(fv.a.FOREGROUND),this.currentState=zI.Focus}))}})||BI)||BI)||BI)||BI)||BI)||BI;var xI;let VI=Object(a.injectable)()(xI=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(xI=Reflect.metadata("design:type",Function)(xI=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a])(xI=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?Jr.default.lostFocus().then(Xr.a).then((()=>{NI.FSV.zsymb(0,"wSzAWf","send noti lost success")})).catch((e=>{NI.FSV.zsymb(0,"IRoWR0","send noti lost fail",JSON.stringify(e))})):NI.FSV.zsymb(0,"SZmFQA","call send noti lost but feat disable")}})||xI)||xI)||xI)||xI;var HI,WI=s("a8HX");let qI=Object(a.injectable)()(HI=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(HI=function(e,t){return Object(a.inject)(UI)(e,void 0,1)}(HI=Reflect.metadata("design:type",Function)(HI=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===UI?Object:UI])(HI=class extends Vg.a{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(R.ZLoggerNametags.activeDeactive,[R.ZLoggerNametags.stateMachine]),t=this.service,Object(rm.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,"OVO75f",["unset","UG_OhC"]),on:{FOCUS:{actions:()=>{e.zsymb(3,"aI0rJt",["start life cycle normal case!","odweEt"])},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,"F3kbTJ",["start life cycle app auto lock case!","_37Kk_"])},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,"pL7Rha",["start life cycle lost focus case!","yH8s-i"])},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,"JMKO7d",["state: foreground_active","lMj9v0"]),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,"WEfTyF",["state: background_active","J89Hah"]),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,a)=>{e.zsymb(3,"HZprSx",["state: background_deactive","dTWamt"],a.status),t.startDeactive(a.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,a;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(a=this.interpreter)||void 0===a||a.off(t),e())};this.onChange(t)}}})||HI)||HI)||HI)||HI)||HI;var KI,$I=s("4zJP");const ZI=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let QI=Object(a.injectable)()(KI=Object(m.j)()(KI=Object(m.h)()(KI=Object(a.singleton)(WI.a)(KI=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(KI=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(KI=function(e,t){return Object(a.inject)(UI)(e,void 0,2)}(KI=Reflect.metadata("design:type",Function)(KI=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===UI?Object:UI])(KI=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,"CsT8h7","app locked",this.authenticated),this.appLocked=!0,this.authenticated&&(this.machine.send({type:"APP_LOCK",status:2}),$zInAppPayment.closeInAppPayment())},this.onAppUnLock=()=>{this.logger.zsymb(0,"ML_Wl_","app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{Ce.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,"G8tH6H","onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");a.ModuleContainer.resolve(AI.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,"V_PpSf","lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,"grMZYy","active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,"BUoCFl","onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,"tS4z7Z","onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=a.ModuleContainer.resolveToken(qI),this.logger=t.createZLogger(R.ZLoggerNametags.activeDeactive,[R.ZLoggerNametags.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},J.p.listenEvent(J.m,this.onConfigChanged);try{this.machine.create()}catch(i){return void this.logger.zsymb(18,"Tvv1s_",(()=>["create error",{error:i}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,"0ms4AE","feature is not enable")}setup(){if(this.logger.zsymb(0,"zgMA9Z","setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=a.ModuleContainer.resolve(AI.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(AI.b.LostFocus,this.onLostFocus),e.addEventListener(AI.b.Focus,this.onFocus),this.appLocked=J.p.getAppLock(),$I.b.on($I.a.APP_LOCKED,this.onAppLock),$I.b.on($I.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=a.ModuleContainer.resolve(AI.c);e.removeEventListener(AI.b.LostFocus,this.onLostFocus),e.removeEventListener(AI.b.Focus,this.onFocus),$I.b.off($I.a.APP_LOCKED,this.onAppLock),$I.b.off($I.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){$zFeatures.activeDeactive.setup({delta:Ce.default.online_configs.idle_interval_check,inactiveTime:Ce.default.online_configs.idle_time,trackActive:Ce.default.online_configs.track_inactive_alive_back,currStatus:this.service.getStatus(),backgroundTracking:Ce.default.online_configs.enable_background_tracking,fullBgTracking:this.isEnableFullBackgroundTrack()}),$zsub.$zFeatures.activeDeactive.onActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.onDeactiveFromBackground(this.onDeactiveFromBackground)}clearBackgroundTracking(){$zFeatures.activeDeactive.clearTimer(this.isEnableBackgroundTrack()),$zsub.$zFeatures.activeDeactive.offActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.offDeactiveFromBackground(this.onDeactiveFromBackground)}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=ZI.get(e);_e.default.send(ve.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,"DgIfsk",["handle event os ","boVt6S"],t)}isUsingApp(){const e=this.appLocked||J.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return this.config.get("online_configs.enable_background_tracking")}isEnableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||KI)||KI)||KI)||KI)||KI)||KI)||KI)||KI)||KI;var YI,JI=s("8RMw"),XI=s("oQzU"),ey=function(e){return e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground",e}(ey||{}),ty=function(e){return e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff",e}(ty||{}),sy=function(e){return e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive",e}(sy||{});const ay={[sy.Foreground]:ey.KeepActiveForeground,[sy.BackgroundActive]:ey.KeepActiveBackground};let iy=Object(a.injectable)()(YI=function(e,t){return Object(a.inject)(Ih.a)(e,void 0,0)}(YI=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(YI=function(e,t){return Object(a.inject)(AI.c)(e,void 0,2)}(YI=Reflect.metadata("design:type",Function)(YI=Reflect.metadata("design:paramtypes",[void 0===Ih.a?Object:Ih.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===AI.c?Object:AI.c])(YI=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.countPingWssFail=0,this.logger=t.createZLogger(R.ZLoggerNametags.activeDeactive,[R.ZLoggerNametags.service]),this.status=sy.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}onLogin(){this.sendActiveToServer(ey.ActiveBackground)}startTrackIdle(e=!0){this.enableBackgroundTracking?(this.logger.zsymb(0,"YSuzp2","startTrackIdle"),$zFeatures.activeDeactive.createTimer(e)):this.logger.zsymb(0,"9RMCMg","in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,"VeffdJ","stopTrackIdle"),$zFeatures.activeDeactive.clearTimer(this.enableBackgroundTracking)}startForegroundMode(){this.status=sy.Foreground,this.sendActiveToServer(ey.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(ey.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=sy.BackgroundActive,this.enableBackgroundTracking||this.clearPingTimer(),this.enableBackgroundTracking&&this.createPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?ey.ActiveBackground:ey.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,"vq36tW","user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=ty.Idle;break;case 1:t=ty.ComputerLock;break;case 2:t=ty.AppLock;break;case 3:t=ty.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===sy.Foreground&&t==ty.Idle&&this.startTrackIdle(!1),t!=ty.ComputerLock&&t!=ty.AppLock||this.stopTrackIdle(),this.status=sy.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,"GhjIjM","createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=ay[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,"aTRYGK","call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,"WmFu-p","clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){let t=this.focusManager.getAppIdleTime();{const e=await $zFeatures.activeDeactive.getIdleTime();t=Math.min(t,e)}return t<e}canSendDeactive(e){return e!==ty.Idle||(this.status===sy.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===sy.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,"NmLq1c",["call ping but discard, because the user don't have action!","um3Fkp"])}sendActiveToServer(e,t={additionText:""}){const{additionText:s}=t;if(!this.enActiveUsingSocket||Jc.default.getMsgSrcType()!==Y.MsgSources.SOCKET)return ul.default.increaseFailed(88888,0,0,e,Date.now()),this.sendActiveViaHttp(e,s).then((e=>(e&&(this.countPingWssFail=0),e)));let a=null;return a=this.enSendActiveToKeepAlive?JI.default.pingActiveViaKeepAlive(e):XI.a.instance().pingActive(e),a.then((()=>(this.countPingWssFail=0,this.logger.zsymb(3,"be00R0",["{}Call active app SUCCESS: socket - {}","ht3zzB"],s,e),!0))).catch((t=>(this.logger.zsymb(21,"-8qCrW",["{}Call active fail: socket - {} - {}","IFnZpj"],s,e,JSON.stringify(t)),this.countPingWssFail++,ul.default.increaseFailed(88888,1,0,e,Date.now()),this.sendActiveViaHttp(e).then((t=>(t&&this.countPingWssFail>=3&&(this.countPingWssFail=0,ul.default.increaseFailed(88888,2,0,e,Date.now())),t))))))}sendActiveViaHttp(e,t=""){return new Promise((s=>{Jr.default.active(e).then(Xr.a).then((()=>{this.logger.zsymb(3,"SHH3ay",["{}Call active app SUCCESS: http - {}","dZF440"],t,e),s(!0)})).catch((a=>{this.logger.zsymb(21,"RJ-bA_",["{}Call active fail: http - {} - {}","cd1WQ5"],t,e,JSON.stringify(a)),s(!1)}))}))}sendDeactiveToServer(e){return Jr.default.deactiveV2().then(Xr.a).then((()=>(this.logger.zsymb(3,"eNOFY-",["Call deactive app SUCCESS {}","jsSe-b"],e),!0))).catch((e=>(this.logger.zsymb(21,"bHVwht",["Call deactive fail: ","Xm2Zq6"],JSON.stringify(e)),!1)))}})||YI)||YI)||YI)||YI)||YI)||YI;a.ModuleContainer.registerSingleton(jI,VI),a.ModuleContainer.registerSingleton(AI.c,PI),a.ModuleContainer.registerSingleton(UI,iy),a.ModuleContainer.resolve(AI.c),a.ModuleContainer.resolveToken(GI),a.ModuleContainer.resolveToken(QI);s("rBRb");var ny,ry=s("jbAT"),oy=s("zLd2"),ly=s("5txd");Object(a.injectable)()(ny=Object(a.singleton)(oy.c)(ny=function(e,t){return Object(a.inject)(ry.b)(e,void 0,0)}(ny=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(ny=Reflect.metadata("design:type",Function)(ny=Reflect.metadata("design:paramtypes",[void 0===ry.a?Object:ry.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(ny=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,me.a.ConvInfoDataManager.addEventListener(ai.b.DeleteConv,this._onDeleteConversation.bind(this)),me.a.ConvInfoDataManager.addEventListener(ai.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(oy.b,["manage-utils-media-in-ui"]),this._log=Object(ly.b)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||ny)||ny)||ny)||ny)||ny);s("37f1");var cy,dy=s("lT2C"),uy=s("C8zZ"),hy=s("wmCV");let gy=Object(Ai.b)(uy.GroupPollManager)(cy=function(e,t){return a.ModuleContainer.inject(En.ConvInfoDataManager)(e,void 0,0)}(cy=Reflect.metadata("design:type",Function)(cy=Reflect.metadata("design:paramtypes",[void 0===En.ConvInfoDataManager?Object:En.ConvInfoDataManager])(cy=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new u.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.pollV3,[R.ZLoggerNametags.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((([t,s])=>{s.group_id===ui.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(t)}))}setUpEvent(){this.convDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const a=hn.default.getGroupByIdSync(e);if(!a)return!1;if(t===a.creatorId)return!0;let i=!1;return null===(s=a.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(i=!0)})),i}isAllowSetTopic(e){var t;const s=hn.default.getGroupByIdSync(e);return!!s&&!(!Ce.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,Ii.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=Ii.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:a}=e,i={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:ui.default.getGroupIdFromConversationId(s),pollData:i,src:a}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:a,src:i}=this.createPollRequestData(e);try{const n=await Cl.default.createPoll(s,a,i);t&&this.pinPoll(n.poll_id,e.groupId,n.question)}catch(n){throw this.Logger.zsymb(18,"4L_SdY",n),n}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await we.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await Cl.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let a=s;if(!a){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");a=t.question}hy.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:a},null,null,Gr.a.getWinIdByConvId(t))}unpinPoll(e,t){hy.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{Cl.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,"-dtgtd","[lockPoll] ",e,s)}}async sharePollInGroup(e){try{Cl.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,"3Oxcxq","[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:a}=e,i=ui.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await Cl.default.addNewOptionPoll(i,s,JSON.stringify(t),a):await Cl.default.vote(i,s,a)}catch(n){throw this.Logger.zsymb(18,"OKf1t6","[votePoll] ",n,s),n}}})||cy)||cy)||cy)||cy;var my,py=s("ILDi");let fy=Object(Ai.b)(uy.GroupPollInfoManager)(my=Reflect.metadata("design:type",Function)(my=Reflect.metadata("design:paramtypes",[])(my=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new qm.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(a){t={}}return t}getLastMessagePoll(e,t,s){let a=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(a=s)})),a}getContinuosPollInfoSection(e,t){const s=[];let a=0;return t.forEach((t=>{var i;t.msgType===Y.MSG_POLL&&this.getPollParams(t).pollId===e?(s[a]||(s[a]=[]),s[a].push(t)):null!==(i=s[a])&&void 0!==i&&i[0]&&(a+=1)})),s.filter((e=>e.length>Ce.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const a=this.getLastMessagePoll(e,t,s);return _d.b.isSameMsg(t,a)}getPollInfoShowStatus(e,t,s){const a=this.getContinuosPollInfoSection(e,s);for(const i of a)for(let e=i.length-1;e>=0;e--)if(_d.b.isSameMsg(t,i[e]))return e!==i.length-1?"HIDE":i[e-1]&&this.viewedMoreFromMsgIds.has(i[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let a=[];const i=this.getContinuosPollInfoSection(e,s);for(const n of i)if(n[n.length-1].msgId===t){a=n.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:a}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||my)||my)||my;a.ModuleContainer.registerSingleton(dy.a,gy),a.ModuleContainer.registerSingleton(py.a,fy);var vy,_y,by=s("qLo6");Object(m.f)()(vy=class{onAuthenticated(e){Ce.default.e2ee.enable_wasm&&by.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(m.f)()(_y=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?ul.default.increaseSuccess(97136,0,0):ul.default.increaseFailed(97136,0,0,0,0)}catch{ul.default.increaseFailed(97136,0,0,1,0)}}});var Iy,yy=s("3+ZU"),Sy=s("MEZx");a.ModuleContainer.registerSingleton(yy.a,class{getDebugMenu(){return Ce.default.mediaStatus.debug.enable?{type:Sy.MENU_ITEM_TYPE.SUBMENU,text:"Media Status",items:[{text:"Disable expired soon status",onclick:()=>{Ce.default.mediaStatus.enable_expired_soon=!Ce.default.mediaStatus.enable_expired_soon},checked:!Ce.default.mediaStatus.enable_expired_soon},{text:"Revert media status",onclick:()=>{Ce.default.mediaStatus.enable_media_status=!Ce.default.mediaStatus.enable_media_status},checked:!Ce.default.mediaStatus.enable_media_status},{text:"Disable view in folder for auto download",onclick:()=>{Ce.default.mediaStatus.enable_view_folder_option_for_auto_download=!Ce.default.mediaStatus.enable_view_folder_option_for_auto_download},checked:!Ce.default.mediaStatus.enable_view_folder_option_for_auto_download},{text:"Disable inview file download",onclick:()=>{Ce.default.mediaStatus.enable_file_inview_download=!Ce.default.mediaStatus.enable_file_inview_download},checked:!Ce.default.mediaStatus.enable_file_inview_download},{text:"Open Media Status Debugger Modal",onclick:()=>{const e=s("h0sc");e&&e.ModalManagerV2&&e.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.MEDIA_STATUS_DEBUGGER,params:{show:!0}})}}]}:null}});let Cy=Object(a.injectable)()(Iy=function(e,t){return Object(a.inject)(nt)(e,void 0,0)}(Iy=Reflect.metadata("design:type",Function)(Iy=Reflect.metadata("design:paramtypes",[Object])(Iy=class{constructor(e){this.queue=e}push(e,t,s){const a={convId:e,msgId:t,action:s};this.queue.push(a)}})||Iy)||Iy)||Iy)||Iy;class Ey extends Error{constructor({message:e,name:t,options:s}){super(e),this.code=void 0,this.name=void 0,this.name=t,s&&s.code&&(this.code=s.code),s&&s.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,Ey.prototype)}}var Oy=(e,t)=>{const s={code:e.code,stack:t};return new Ey({name:e.name,options:s,message:e.message})};const My={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},Ty={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},wy={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"},Ry={name:"TEMP_DISABLE_LOG_PHOTO_SUBTYPE_2",code:4,message:"Temporary disable actionlog info for photo in subType 2"};var Ly=s("tmLI"),Dy=s("jjJf"),Ay=s("eZ5W");function Fy(e){return e===Y.MSG_E2EE?it.c.YES:it.c.NO}function ky(e){return"0"!=e?it.d.RECEIVER:it.d.SENDER}var Ny=s("HPXo");class Py{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:Fy(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ky(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=Ny.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:null!=e&&e.forceStatus?i.file_status=null==e?void 0:e.forceStatus:i.file_status=null==e?void 0:e.mediaStatus}return i}}class jy{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:Fy(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ky(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=Ny.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=null==e?void 0:e.forceStatus}return i}}class Uy{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:Fy(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ky(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=Ny.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=e.mediaStatus}return i}}class By{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:Fy(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ky(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=Ny.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=e.mediaStatus}return i}}class zy{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0,this.isZCloud=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){var t,s,a,i,n,r,o;let l="";var c,d,u,h,g,m;return null!==(t=e)&&void 0!==t&&t.isExpired&&(l=qu.e.Expired),null!==(s=e)&&void 0!==s&&s.isExpiredSoon&&(l=qu.e.ExpiredSoon),Object(Dy.b)().isEnableViewPCloudFileStatus()&&null!==(a=e)&&void 0!==a&&a.personalCloud&&null!==(c=e)&&void 0!==c&&null!==(d=c.personalCloud)&&void 0!==d&&null!==(u=d.status)&&void 0!==u&&u.isUncloud&&e===qu.e.ExpiredSoon&&(e=qu.e.ExpiredSoon),Object(Dy.b)().isEnableViewPCloudFileStatus()&&null!==(i=e)&&void 0!==i&&i.personalCloud&&null!==(h=e)&&void 0!==h&&null!==(g=h.personalCloud)&&void 0!==g&&null!==(m=g.status)&&void 0!==m&&m.isClouded&&(l=qu.d.CloudSaved),null!==(n=e)&&void 0!==n&&n.autoDownloadPath&&(l=qu.e.DownloadedAuto),(null!==(r=e)&&void 0!==r&&r.localPath||null!==(o=e)&&void 0!==o&&o.folderPath)&&(l=qu.e.DownloadedManual),l}(e),this}withForceStatus(e=""){return this.forceStatus=e,this}withZCloud(e=0){return this.isZCloud=e?1:0,this}build(){var e,t;const s=function(e){const t=Object(Ly.n)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),a=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(i=null===(t=this.msg)||void 0===t?void 0:t.toUid,ui.default.isOAType(Ii.default.getProfileFriendSync(i))?it.a.OA:ui.default.getConversationType(i));var i;const n=a===it.a.GROUP&&function(e){let t;const s=hn.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),r=a===it.a.CLOUD?function(e,t){let s=e;return e!==qu.d.DownloadedAuto&&e!==qu.d.DownloadedManual&&t<=Ay.b.getCloudLimitBigFileInBytes()&&(s=qu.d.CloudSaved),s}(this.mediaStatus,s):this.mediaStatus;let o={};const l={msg:this.msg,size:s,isZCloud:this.isZCloud,mediaStatus:r,convType:a,forceStatus:this.forceStatus,entryPoint:this.entryPoint,groupSize:n};switch(this.msg.msgType){case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:o=(new jy).build(l,this.subType);break;case Y.MSG_FILE:o=(new Py).build(l,this.subType);break;case Y.MSG_VIDEO:o=(new Uy).build(l,this.subType);break;case Y.MSG_VOICE:o=(new By).build(l,this.subType)}return o}}var Gy=class{verify(e){return!!e.file_status&&(!!Object.values(it.c).includes(e.is_e2ee)&&(!!Object.values(it.d).includes(e.is_sender)&&(!!Object.values(it.d).includes(e.is_sender)&&(!!Object.values(it.f).includes(e.conv_type)&&(!!Object.values(it.g).includes(e.sync_source)&&!!Object.values(it.h).includes(e.msg_type))))))}},xy=s("a4lh");Y.MSG_FILE,Y.MSG_VIDEO,Y.MSG_VOICE;const Vy=[Y.MSG_PHOTO,Y.MSG_PHOTO_2];var Hy;let Wy=Object(a.injectable)()(Hy=function(e,t){return Object(a.inject)(nt)(e,void 0,0)}(Hy=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(Hy=function(e,t){return Object(a.inject)(ct)(e,void 0,2)}(Hy=Reflect.metadata("design:type",Function)(Hy=Reflect.metadata("design:paramtypes",[Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,Object])(Hy=class{constructor(e,t,s){this.queue=e,this.mediaActionLogInfoCronToGroupData=s,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(R.ZLoggerNametags.mediaStatus,["action-log-consumer"]),this.DB=Xt.default.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return Oy(wy);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return Oy(Ty);const t=e.msgId,s=e.action,a=e.convId,i=await this.DB.Core.Message.get(t,{partition:a});let n;if(!i)return Oy(My);if((i.msgType===Y.MSG_PHOTO||i.msgType===Y.MSG_PHOTO_2)&&!Ce.default.mediaStatus.actionLogInfo.enable_sub_type_2_for_photo&&s.subType===it.j.MediaStatusInView)return Ry;const r=(new zy).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(i).withStatus(n).withForceStatus((null==s?void 0:s.forceStatus)||"").withZCloud((null==s?void 0:s.isZCloud)||0).build();if((new Gy).verify(r))if(Vy.includes(i.msgType)){const e=Object(I.a)({},r);delete e.sent_time,delete e.size;const t=JSON.stringify(e);this.mediaActionLogInfoCronToGroupData.runCron({key:t,data:Object(I.a)(Object(I.a)({},r),{},{subType:s.subType})})}else xy.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,"ReBVJU",["error {}","bRwnsh"],JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||Hy)||Hy)||Hy)||Hy)||Hy)||Hy;var qy;let Ky=Object(a.injectable)()(qy=function(e,t){return Object(a.inject)(rt)(e,void 0,0)}(qy=function(e,t){return Object(a.inject)(lt)(e,void 0,1)}(qy=Reflect.metadata("design:type",Function)(qy=Reflect.metadata("design:paramtypes",[Object,Object])(qy=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t,s){}})||qy)||qy)||qy)||qy)||qy;var $y=s("z97J");const Zy=new class{constructor(e){this.lru=void 0,this.lru=new u.default({maxSize:e.maxSize()})}set(e,t){if(t)if(this.has(e)){const s=this.lru.get(e);s.sent_time=`${parseInt(s.sent_time)+parseInt(t.sent_time)}`,s.size&&t.size&&(s.size=`${parseInt(s.size)+parseInt(t.size)}`),++s.count,this.lru.set(e,s)}else this.lru.set(e,Object(I.a)(Object(I.a)({},t),{},{count:1}))}get(e){return this.lru.get(e)}has(e){return this.lru.has(e)}delete(e){return this.lru.delete(e)}getAll(){return[...this.lru.values()]}clear(){this.lru.clear()}}({maxSize:()=>Ce.default.maxSizeMemCacheMediaStatusPhotoActionLogInfo});a.ModuleContainer.registerSingleton(nt,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),a.ModuleContainer.registerSingleton(rt,Cy),a.ModuleContainer.registerSingleton(ct,class{constructor(){this.startCron=void 0,this.startCron=!1}setStart(){this.startCron||(this.startCron=!0)}isStartCron(){return this.startCron}runCron(e){const t=new $y.CronJob(Ce.default.mediaStatus.actionLogInfo.time_to_log_photo,(()=>{const e=Zy.getAll();if(e.length){for(const s of e){var t;const e=s.subType;delete s.subType,s.sent_time=Math.round(s.sent_time/s.count),s.size=(null!==(t=s.size)&&void 0!==t?t:0)/s.count,xy.a.LogActionInfo(e,s)}Zy.clear()}}));this.isStartCron()?Zy.set(e.key,e.data):(Zy.set(e.key,e.data),t.start(),this.setStart())}}),a.ModuleContainer.registerSingleton(lt,Wy),a.ModuleContainer.registerSingleton(ot,Ky);var Qy=s("imbw"),Yy=s("1EWQ");const Jy=1,Xy=2,eS=3;let tS=function(e){return e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT",e}({}),sS=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),aS=function(e){return e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP",e}({}),iS=function(e){return e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE",e}({}),nS=function(e){return e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE",e}({}),rS=function(e){return e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL",e}({}),oS=function(e){return e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL",e}({});var lS;let cS=Object(Ai.b)(Qy.a)(lS=Reflect.metadata("design:type",Function)(lS=Reflect.metadata("design:paramtypes",[])(lS=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let a;switch(t){case"ShowManualRetry":a=Jy;break;case"InteractManualRetry":a=Xy;break;case"ShowBannerNetwork":a=eS}Ia.default.logActionInfoV2(Ia.FeaturesInfo.AutoRetry,a,s)}getChatTypeFromConvId(e){return ui.default.isGroup(e)?sS.CHAT_GROUP:Yy.a.isSendToMe(e)?sS.MY_CLOUD:sS.CHAT_11}getRetryMsgType(e){switch(e){case Y.MSG_TEXT:return tS.TEXT;case Y.MSG_GIF:return tS.GIF;case Y.MSG_FILE:case Y.MSG_VIDEO:return tS.FILE;case Y.MSG_PHOTO:case Y.MSG_PHOTO_GROUP:return tS.PHOTO;case Y.MSG_CONTACT:return tS.CONTACT;case Y.MSG_STICKER:case Y.MSG_STICKER_GROUP:case Y.MSG_STICKER_2:return tS.STICKER;case Y.MSG_LINK_CLIENT:return tS.LINK;default:return}}getMsgCombineType(e){return[Y.MSG_PHOTO_GROUP,Y.MSG_STICKER_GROUP].includes(e)?aS.GROUP:aS.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType),is_manual_btn:e.errorMessageInfo?0:1}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=Ct.default.getTimeNow()}networkBannerDisappearReport(){const e=Ct.default.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:iS[e.source],is_resend:this.getMsgCombineType(e.msgType)===aS.GROUP?rS.RESEND_ALL:rS.RESEND_SINGLE,is_deleted:oS.NO_DELETE,action_type:nS.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:iS[e.source],is_resend:rS.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===aS.GROUP?oS.DELETE_ALL:oS.DELETE_SINGLE,action_type:nS.DELETE}})}})||lS)||lS)||lS;a.ModuleContainer.registerSingleton(Qy.a,cS);var dS,uS=s("Z1oQ"),hS=s("QbTC"),gS=s("xtzN"),mS=s("n32m"),pS=s("hKna");let fS=Object(Ai.b)(mS.RetryErrorController)(dS=Reflect.metadata("design:type",Function)(dS=Reflect.metadata("design:paramtypes",[])(dS=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=Ce.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,"h9e_Ex",e,t)}shouldRetry(e,t,s){if(!e||pS.a.includes(e.code))return!1;if(!pS.c.includes(e.code))return!1;const a=pS.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(a&&(!Ce.default.retry_err_no_network||ce.b.getStateNetwork()!==ce.a.CHECKING&&ce.b.getStateNetwork()!==ce.a.DISCONNECT))return!1;const i=this.getRetryErrorCodeGroupName(e.code);if(i&&this.getRetryErrorCodeMapping()[i].off)return!1;const n=a&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!n)return!1;const r=this.getRetryTimeout(t);return!!(r&&Ct.default.getTimeNow()-t.timestamp<r)&&(t.count&&!a&&t.count--,a&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return Ce.default.retryConfig&&Ce.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===Y.RETRY_MSG_TIMEOUT_DEFAULT?t=Ce.default.retryConfig.time_retry_default:e.timeout===Y.RETRY_MSG_TIMEOUT_LONG&&(t=Ce.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(pS.d).find((t=>pS.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(pS.b).find((t=>pS.b[t].includes(e)))}getRetryErrorCodeMapping(){return Ce.default.retryConfig.retry_strategy&&"object"==typeof Ce.default.retryConfig.retry_strategy?Object.keys(Ce.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=Ce.default.retryConfig.retry_strategy[t],e)),{}):pS.e}})||dS)||dS)||dS;var vS,_S=s("yoj5");let bS=Object(Ai.b)(hS.a)(vS=Reflect.metadata("design:type",Function)(vS=Reflect.metadata("design:paramtypes",[])(vS=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=_S.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,JI.default.getSocketState()===pS.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,_e.default.subscribe(((e,t)=>{if(e===ve.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===pS.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),JI.default.getChatHandler().subcribe(Xc.b.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return Ce.default.retryConfig&&Ce.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===Y.RETRY_MSG_TIMEOUT_DEFAULT?t=Ce.default.retryConfig.time_retry_default:e.timeout===Y.RETRY_MSG_TIMEOUT_LONG&&(t=Ce.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===pS.f.ERR_CONNECTION_TIMED_OUT&&ce.b.getStateNetwork()!==ce.a.CONNECTED&&(t=pS.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let a=this.getErrorCode(e);if(a===pS.f.ERR_CONNECTION_TIMED_OUT||a===pS.f.ERR_SOCKET_CLOSED||a===pS.f.ERR_NO_NETWORK){var i;const e=null!==(i=this.retryCountMapping.get(t))&&void 0!==i?i:0;let n=Ce.default.retryConfig.max_retry_count;if(a===pS.f.ERR_SOCKET_CLOSED&&(n=Ce.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<n){const e=this.getRetryTimeout(s);return!!(e&&Ct.default.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const i=a.ModuleContainer.resolve(uS.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const n=this.getErrorCode(e);if(n!==pS.f.ERR_CONNECTION_TIMED_OUT){var r;if(n===pS.f.ERR_SOCKET_CLOSED||n===pS.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(r=this.retryCountMapping.get(s))&&void 0!==r?r:1),void this.waitingSocketOpenQueue.push(t)}else{var o,l;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,a=(null!==(l=i.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==l?l:3e4)*e+_S.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),a)}}logRetryError(e,t){this.Logger.zsymb(18,"bjdKwv",e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||vS)||vS)||vS;a.ModuleContainer.registerSingleton(uS.a,fS),a.ModuleContainer.registerSingleton(hS.a,bS),a.ModuleContainer.registerSingleton(gS.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=_S.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=_S.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,J.p.listenEvent(J.k,(e=>{e===ce.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===ce.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){ce.b.getStateNetwork()===ce.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),Ce.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});class IS{static getMinNumberOfE2eeConvs(){var e;return null===(e=Ce.default.notify_missing_e2ee_message.conditions)||void 0===e?void 0:e.min_number_of_e2ee_convs}static isEnableEntryTransferFromE2ee(){return!0===Ce.default.notify_missing_e2ee_message.enable}}var yS;const SS=Object(a.define)("entries-transfer-metrics");let CS=Object(a.injectable)()(yS=class{receiveChangeDeviceOnE2eeConvsSignal(){this.logAction(2090211)}receiveOverqueueMsgSignal(){this.logAction(2090210)}logAction(e){Ia.default.logAction(e)}logActionInfo(e){}})||yS;var ES;a.ModuleContainer.registerSingleton(SS,CS);Object(m.f)()(ES=Object(a.injectable)()(ES=Object(Ai.b)(Wg.b)(ES=function(e,t){return Object(a.inject)(SS)(e,void 0,0)}(ES=Reflect.metadata("design:type",Function)(ES=Reflect.metadata("design:paramtypes",[void 0===SS?Object:SS])(ES=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.entriesTransferManager,[R.ZLoggerNametags.e2eeNotifyMissingMsg])),this._Logger}constructor(e){super(),this.name=void 0,this.syncSourceQueueForSuggestTransfer=void 0,this._missingMessageEventList=void 0,this._Logger=void 0,this.metricts=void 0,this.name=Wg.a,this.syncSourceQueueForSuggestTransfer=[],this._missingMessageEventList=[],this.metricts=e}get missingMessageEventList(){return this._missingMessageEventList}enSyncSourceQueueForSuggestTransfer(e){this.syncSourceQueueForSuggestTransfer.includes(e)||this.syncSourceQueueForSuggestTransfer.push(e),this.Logger.zsymb(0,"C9EFhl","[enSyncSourceQueueForSuggestTransfer] Push entry transfer in queue: "+JSON.stringify(e))}isEmptySyncSourceQueueForSuggestTransfer(){return 0===this.syncSourceQueueForSuggestTransfer.length}deSyncSourceQueueForSuggestTransfer(){return this.syncSourceQueueForSuggestTransfer.shift()}detectEntryTransferFromE2ee(){const e=IS.isEnableEntryTransferFromE2ee();try{const t=Hl.a.instance().getListUserE2ee();if(t&&t.length>=IS.getMinNumberOfE2eeConvs())return e&&(this.enSyncSourceQueueForSuggestTransfer(Dg.j.E2EE_MISSING_MESSAGE),this.dispatchEvent(new bm.b(bm.a.NotifyE2eeConvChangeDevice))),this.dispatchEvent(new bm.b(bm.a.HasE2eeConvChangeDevice)),this.metricts.receiveChangeDeviceOnE2eeConvsSignal(),void this._missingMessageEventList.push(Dg.j.E2EE_MISSING_MESSAGE);this.dispatchEvent(new bm.b(bm.a.NoE2eeConvChangeDevice))}catch(t){}}detectEntryTransferOverQueue(){const e=Ce.default.cross_setting.enableOverQueue;this._missingMessageEventList.push(Dg.j.OVERFLOW),e&&(this.enSyncSourceQueueForSuggestTransfer(Dg.j.OVERFLOW),this.dispatchEvent(new bm.b(bm.a.NotifyOverqueue))),this.metricts.receiveOverqueueMsgSignal()}handlePublicEvents(e){switch(e.type){case bm.a.NotifyE2eeSessionChange:{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.hasChanged;this.Logger.zsymb(0,"Pkj3Bt",`[handlePublicEvents] Receive notify e2e session change. isE2eeKeyChanged ${s}`),s?(this.Logger.zsymb(0,"rLp4fN","[handlePublicEvents] Event change device"),this.detectEntryTransferFromE2ee()):this.dispatchEvent(new bm.b(bm.a.NoE2eeConvChangeDevice));break}}}handleEventShowSuggestion(){this.detectEntryTransferOverQueue(),this.Logger.zsymb(0,"zeFoRm","")}addPublicListeners(){this.addEventListener(bm.a.NotifyE2eeSessionChange,this.handlePublicEvents.bind(this)),a.ModuleContainer.resolve(Sm.AFMC_TModule).get(Sm.AFMC_TController).addEventListener(ym.a.SHOW_SYNC_MESSAGE_SUGGESTION,this.handleEventShowSuggestion.bind(this))}onAuthenticated(e){this.addPublicListeners()}getSyncSource(){const e=this.deSyncSourceQueueForSuggestTransfer();return e&&this.Logger.zsymb(0,"tmxHse","[getSyncSource] Get sync source in queue: "+JSON.stringify(e)),e}})||ES)||ES)||ES)||ES)||ES);var OS=s("dhS6"),MS=s("WzIS"),TS=s("sLvT");const wS=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var RS;let LS=Object(Ai.b)(OS.a)(RS=Reflect.metadata("design:type",Function)(RS=Reflect.metadata("design:paramtypes",[])(RS=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.uiBannerController,[R.ZLoggerNametags.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this.timeoutNextBanner=void 0,this._Logger=void 0,this.name=OS.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0,this.timeoutNextBanner=null}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.doRemoveBannerQueueItem(s.key),t){case MS.a.NORMAL:this.queue.push(e);break;case MS.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}doRemoveBannerQueueItem(e){this.removeBannerQueueItem(e),0===this.queue.length&&(this.isFirtTriggerShowOnQueueCycle=!0)}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Object(TS.b)().isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const a=this.isExistingShow();if(a&&(s=this.queryBannerQueueItem(a)),Object(TS.b)().isEnableForceCloseNormalBanner()&&a&&t===MS.a.HIGH&&s)return this.uiState.set(s.key,!1),Object(Po.h)(this.name,s.key),this.uiState.set(e,!0),void Object(Po.h)(this.name,e);a||(this.uiState.set(e,!0),Object(Po.h)(this.name,e),this.Logger.zsymb(0,"_7-pcc","[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(Po.h)(this.name,e)}handleHideUIBanner(e){Object(TS.b)().isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){this.doRemoveBannerQueueItem(e),this.uiState.get(e)&&(this.uiState.set(e,!1),Object(Po.h)(this.name,e),this.timeoutNextBanner&&clearTimeout(this.timeoutNextBanner),this.timeoutNextBanner=setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()&&(this.uiState.set(e.key,!0),Object(Po.h)(this.name,e.key),this.Logger.zsymb(0,"z1B3r3","[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue)))}),Object(TS.b)().getTimeDelayOnNextBanner()))}hideMultiUI(e){this.doRemoveBannerQueueItem(e),this.uiState.set(e,!1),Object(Po.h)(this.name,e)}async onShowBanner(e,t,s){s&&await wS(s);const a=Object(TS.b)().getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&a?(await wS(a),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await wS(t),this.handleHideUIBanner(e)}getBannerList(){return this.queue}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||RS)||RS)||RS;a.ModuleContainer.registerSingleton(OS.a,LS);var DS=s("LvDl"),AS=s.n(DS);var FS=()=>({version:1,max_num:2,enabled_banners:[{name:pI.a.PIN_TOPIC_BANNER,on:[pI.b.ONE_TO_ONE,pI.b.GROUP]},{name:pI.a.MY_CLOUD_BANNER,on:[pI.b.MY_CLOUD]},{name:pI.a.COMMUNITY_ENCOURAGE_BANNER,on:[pI.b.GROUP]},{name:pI.a.MUTE_BANNER,on:[pI.b.GROUP,pI.b.ONE_TO_ONE]},{name:pI.a.STRANGER_BANNER,on:[pI.b.ONE_TO_ONE]},{name:pI.a.BLOCKED_BANNER,on:[pI.b.ONE_TO_ONE]}],order_by:"desc",priority_matrix:[["6_6","6_6","5_6","6_4","6_5","6_6"],["0_0","0_0","6_6","6_5","0_0","0_0"]]});const kS=Object(a.define)("cbb-configuration");var NS;Object(a.injectable)()(NS=Object(a.singleton)(kS)(NS=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(NS=Reflect.metadata("design:type",Function)(NS=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(NS=class extends X.ZFeatureConfig{constructor(e){super({default:FS(),valiator:new X.ObjectValidator({version:X.Rule.field().number().min(1),max_num:X.Rule.field().number().min(0),enabled_banners:X.Rule.field().array("object"),order_by:X.Rule.field().string().oneOf(["asc","desc"]),priority_matrix:X.Rule.field().array("object")})}),this.chatBoxBannerConfigData_=void 0,this.logger_=void 0,this.logger_=e.createZLogger(R.ZLoggerNametags.cbbConfiguration,[R.ZLoggerNametags.manageCbbConfig])}getVersion(){return this.getChatBoxBannerConfigData_().version}getOrderingType(){return this.getChatBoxBannerConfigData_().orderBy}getMaxBannerCount(){return this.getChatBoxBannerConfigData_().maxBannerCount}getEnabledBannerConfigList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs}getEnabledBannerNameList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs.map((e=>e.name))}getDefaultBannerPriorities(){return this.getChatBoxBannerConfigData_().defaultBannerPriorities}getBannerPrioritiesMatrixByFullAppearences(){return this.getChatBoxBannerConfigData_().bannerPrioritiesMatrixByFullAppearences}getChatBoxBannerConfigData(){return this.getChatBoxBannerConfigData_()}getChatBoxBannerConfigData_(){return this.chatBoxBannerConfigData_||this.updateConfig_(),this.chatBoxBannerConfigData_}updateConfig_(){this.chatBoxBannerConfigData_||(this.chatBoxBannerConfigData_={});const{version:e,enabled_banners:t,priority_matrix:s,order_by:a,max_num:i}=this.config;this.chatBoxBannerConfigData_.version=e,this.chatBoxBannerConfigData_.orderBy=a,this.chatBoxBannerConfigData_.maxBannerCount=i,this.chatBoxBannerConfigData_.enabledBannerConfigs=t.map((e=>{var t,s;return{name:null!==(t=e.name)&&void 0!==t?t:"",enabledOn:null!==(s=e.on)&&void 0!==s?s:[]}}));const n=s.reduce(((e,s)=>{if(Array.isArray(s)&&s.length===t.length){const t=s.map((e=>this.parseCellStringToMatrixCellObject_(e)));e.push(t)}return e}),[]);this.chatBoxBannerConfigData_.defaultBannerPriorities=n[0],this.chatBoxBannerConfigData_.bannerPrioritiesMatrixByFullAppearences=n.slice(1)}parseCellStringToMatrixCellObject_(e){const t={priority:0,subPriority:0};if(!e||"string"!=typeof e)return t;const s=e.split("_"),a=(e,t)=>{try{const t=parseInt(e);if(!isNaN(t))return t}catch(s){this.logger_.zsymb(18,"xUkbHR",`[parseIntSafely]: ${s.message}`)}return t};return t.priority=a(s[0],0),t.subPriority=a(s[1],0),t}generateDefaultMatrixCellObjectArray_(e){return Array.from({length:e},(()=>({priority:0,subPriority:0})))}selector(e){return e.chat_box_banner||{}}listener(e){const t=this.selector(e);if(!t)return;if(null==t.version)return;let s=null;if(t.version!==FS().version)s=FS();else{let e="Valid"===this.options.valiator.validate(t);if(e){const s=t.enabled_banners.length;for(let a=0;a<t.priority_matrix.length;a++){if(s!==t.priority_matrix[a].length){e=!1;break}}}s=e?t:null}if(!s)return;this.shouldConfigUpdate(this.config,s)&&(this.config=s,this.updateConfig_(),this.dispatchEvent(new X.UpdateConfigEvent(s)))}shouldConfigUpdate(e,t){return!new E.g.Comparer(e,t,!0).AND("version").AND("max_num").AND("order_by").AND("enabled_banners",AS.a.isEqual).AND("priority_matrix",AS.a.isEqual).exec()}})||NS)||NS)||NS)||NS);const PS=Object(a.define)("cbb-app-service");var jS;Object(a.injectable)()(jS=Object(a.singleton)(PS)(jS=function(e,t){return Object(a.inject)(kS)(e,void 0,0)}(jS=Reflect.metadata("design:type",Function)(jS=Reflect.metadata("design:paramtypes",["undefined"==typeof IChatBoxBannerConfiguration?Object:IChatBoxBannerConfiguration])(jS=class{constructor(e){this.chatBoxBannerConfiguration_=void 0,this.chatBoxBannerConfiguration_=e}isBannerEnabled(e,t){const{convType:s}=t;let a=this.chatBoxBannerConfiguration_.getEnabledBannerConfigList().find((t=>t.name===e));if(!a)return!1;const{enabledOn:i}=a;return i.includes(s)||i.includes(pI.b.ALL)}addBannerNameToBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[e];return this.processRawBannerNameList_([...t,e],e)}removeBannerNameFromBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[];if((t=t.filter((t=>t!==e))).length<=1)return t;return this.processRawBannerNameList_(t)}getMaxBannerCount(){return this.chatBoxBannerConfiguration_.getMaxBannerCount()}getVersion(){return this.chatBoxBannerConfiguration_.getVersion()}getOrderingType(){return this.chatBoxBannerConfiguration_.getOrderingType()}getChatBoxBannerConfigData(){return this.chatBoxBannerConfiguration_.getChatBoxBannerConfigData()}processRawBannerNameList_(e,t){const s={};e.forEach((e=>{s[e]=!0}));const a=this.chatBoxBannerConfiguration_.getEnabledBannerNameList(),i=this.chatBoxBannerConfiguration_.getBannerPrioritiesMatrixByFullAppearences();let n=!1,r=Array.from({length:a.length},(()=>({priority:0,subPriority:0,bannerName:pI.a.UNKNOWN})));if(i.length>0)for(let h=0;h<i.length&&!n;h++){const e=i[h];for(let t=0;t<e.length;t++){const i=e[t],o=a[t];if(!(s[o]&&i.priority>0&&i.subPriority>0||!s[o]&&0===i.priority&&0===i.subPriority)){n=!1;break}if(r[t]=Object(I.a)(Object(I.a)({},i),{},{bannerName:o}),t===e.length-1){n=!0;break}}}if(!n){this.chatBoxBannerConfiguration_.getDefaultBannerPriorities().forEach(((e,t)=>{const i=a[t];s[i]?r[t]=Object(I.a)(Object(I.a)({},e),{},{bannerName:i}):r[t]={priority:0,subPriority:0,bannerName:pI.a.UNKNOWN}}))}r=r.filter((e=>e.bannerName!==pI.a.UNKNOWN&&0!==e.priority&&0!==e.subPriority));const o={};r.forEach((e=>{const s=e.priority;(!o[s]||o[s].subPriority<e.subPriority||o[s].subPriority===e.subPriority&&o[s].bannerName!==t&&e.bannerName===t)&&(o[s]=e)}));const l=Object.values(o),c="asc"===this.chatBoxBannerConfiguration_.getOrderingType()?1:-1,d=l.sort(((e,t)=>(e.priority-t.priority)*c)),u=this.chatBoxBannerConfiguration_.getMaxBannerCount();return d.slice(0,u).map((e=>e.bannerName))}})||jS)||jS)||jS)||jS);var US=s("ShRB"),BS=s("wx14"),zS=s("AZMc"),GS=s("XnQq"),xS=s("eHWI");const VS=e=>{const{toggleBlock:t,reportUser:s,topBannerRef:a,pendingFriendRequest:i}=e,n=Object(xS.a)(t,i?2390304:2390104),r=Object(xS.a)(s,i?2390305:2390105);return rr.a.createElement(GS.a,{status:"info",iconOptions:{name:"Block_24_Line"},titleTextKey:"STR_YOU_BLOCK_TITLE",contentTextKey:"STR_YOU_BLOCK_DESC",htmlTitle:le.a.str("STR_YOU_BLOCK_DESC"),maxContentLines:1,closable:!1,alignment:"space-between",actions:[{type:"button",variant:"neutral",textKey:"STR_UNBLOCK",onClick:n},{type:"button",variant:"secondary-danger",textKey:"STR_REPORT_USER",onClick:r}],ref:a})};var HS=rr.a.forwardRef(((e,t)=>rr.a.createElement(VS,Object(BS.a)({},e,{topBannerRef:t})))),WS=s("AHNY"),qS=s("o5gc"),KS=s("sB1e");const $S=(e,t,s)=>{const[a,i]=rr.a.useState(Ii.default.isBlocked(t));return Object(WS.a)(((e,s)=>{switch(e){case ve.ConversationListActions.BLOCK_CONVERSATION:s&&s.userId===t&&i(s.blocked);break;case ve.FetchActions.STATUS_BLOCKED_CHANGED:s&&s.includes(t)&&i(Ii.default.isBlocked(t))}}),[t]),rr.a.useEffect((()=>{i(Ii.default.isBlocked(t))}),[t]),rr.a.useEffect((()=>{s&&i(s.isBlocked)}),[s]),{isBlocked:a,toggleBlock:()=>{if(ce.b.getStateNetwork()==ce.a.DISCONNECT)Wo.default.createWarning(le.a.str("STR_NET_SSL_DATE_ERROR_TITLE"));else{let s=a;i(!s),Ii.default.blockFriend(t,s?Y.UNSET_BLOCK:Y.SET_BLOCK).then((()=>{s||Wo.default.createSuccess(le.a.str("STR_YOU_BLOCK_SUCCESS")),e({type:ve.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!s,userId:t}})})).catch((()=>{i(s)}))}}}},ZS=(e,t)=>rr.a.useCallback(((e,t,s)=>{a.ModuleContainer.resolve(qS.d).onOpenReport(e);const i={userId:e,report:{item:s,view:Y.PROFILE_INIT_MODE.REPORT_USER}};Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:i})}),[e,t]);var QS=s("7okM"),YS=s("+JmS");const JS=rr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a}=e,{isPendingFriendRequest:i}=Object(QS.g)(s),{friendInfo:n}=Object(QS.d)(s),r=Object(YS.a)(),o=ZS(a,s),{toggleBlock:l}=$S(r,s,n);return rr.a.createElement(HS,{ref:t,reportUser:()=>o(s,a,{}),toggleBlock:l,pendingFriendRequest:i})}));var XS=s("/MKj");var eC=rr.a.forwardRef((function(e,t){const{convId:s,myId:i,windowId:n,pendingFriendRequest:r,friendRequestSent:o=!1,dispatch:l,toggleBlock:c,reportUser:d}=e,u=rr.a.useRef(null),h=rr.a.useRef(a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("messageView",["stranger-banner"])),{userRank:g,fallback:m}=((e,t,s=!1,a)=>{const[i,n]=rr.a.useState(KS.f),[r,o]=rr.a.useState(!1),l=rr.a.useCallback((()=>{n(KS.f),o(!0)}),[]);return rr.a.useEffect((()=>{let i=!1;return ng.a.getStrangerBannerInfo(e,t).then((e=>{if(!i)if(e.data_render)n(e);else switch(e.rank_type||e.userRank){case KS.e.GRAY:n(s?KS.d:KS.c);break;case KS.e.BLACK:n(s?KS.b:KS.a);break;case KS.e.WHITE:default:n(KS.f)}})).catch((e=>{a(e)})),()=>{i=!0}}),[e,t,s]),{userRank:i,fallback:r,fallbackDefault:l}})(s,i,!!r,(e=>h.current.zsymb(20,"lDX2El","[error get rank user] "+(null==e?void 0:e.err_msg)))),[,p]=rr.a.useState(!1);rr.a.useEffect((()=>{r&&a.ModuleContainer.resolve(If.c).onSeenBannerFriendRequest(s)}),[r,s]);const f=Object(xS.a)((()=>{d()}),r?2390306:2390106,r?7:3,{rank:g.rank_type}),v=Object(xS.a)((e=>{const t=e[0];u&&u.current&&u.current.show(t,t.target),t.preventDefault(),t.stopPropagation()}),r?2390302:2390102),_=Object(xS.a)(rr.a.useCallback((()=>{a.ModuleContainer.resolve(ag.b).acceptFriendRequest(s,n)}),[s]),2390301,5,{rank:g.rank_type}),b=rr.a.useCallback(((e,t)=>{ye.a.setFriendRequestSource(e,Y.FRIEND_REQUEST_SRC_CHAT,{uidTo:e}),ng.a.doAddFriend(e,Y.FRIEND_REQUEST_SRC_CHAT,t,n)}),[]),I=Object(xS.a)((()=>{b(s,l)}),2390101,r?7:1,{rank:g.rank_type}),y=Object(xS.a)((()=>{c()}),r?2390303:2390103,r?6:2,{rank:g.rank_type}),S=rr.a.useCallback((e=>{e.preventDefault(),e.stopPropagation(),qo.ConfirmManagerV2.openConfirm({windowId:n,name:Y.MODAL_CONFIRM.confirmIdentities,params:{title:le.a.str("STR_CONTACT_TAB_TITLE_RECALL_REQ"),message:le.a.str("STR_CONTACT_TAB_CONFIRM_RECALL_REQ"),okText:le.a.str("STR_CONTACT_TAB_OKE_TEXT_RECALL_REQ"),cancelText:le.a.str("STR_CONTACT_TAB_CANCEL_TEXT_RECALL_REQ"),okType:"danger",cancelType:"neutral",onOk:()=>{a.ModuleContainer.resolve(If.o).onRemoveFriendSent({userId:s})}}})}),[s]),C=rr.a.useCallback((()=>p((e=>!e))),[]);var E;E=C,rr.a.useEffect((()=>(le.a.callUpdate(E),()=>{le.a.removeUpdate(E)})),[]);const O=rr.a.useMemo((()=>({block:{textKey:"STR_BLOCK_USER",onclick:y},report:{textKey:"STR_REPORT_USER",onclick:f}})),[s,n,!!r]),M=[];g.data_render&&g.data_render.menu&&Array.from(Object.keys(g.data_render.menu)).forEach((e=>{var t,s;!g.data_render.menu[e].show||g.data_render.buttons&&null!==(t=g.data_render)&&void 0!==t&&null!==(s=t.buttons[e])&&void 0!==s&&s.show||M.push(O[e])}));let T="",w="";const R=le.a.getCurrentLanguageName();g.data_render&&(g.data_render.title&&g.data_render.title.vi&&(T=g.data_render.title[R]),g.data_render.desc&&g.data_render.desc.vi&&(w=g.data_render.desc[R]));const L=e=>rr.a.createElement(Sy.default,{popoverProps:{identity:{windowId:n,name:Y.PopoverIdentitiesDefine.CHAT_BOX_LIST_1},placement:"bottom-right",deltaPosition:{top:"8px",left:"5px"}},ref:u,items:e});let D=null;if(g.rank_type===KS.e.WHITE||m)if(o)D=rr.a.createElement(GS.a,{status:"info",iconOptions:{name:"FriendReq_24_Line"},closable:!1,contentTextKey:"STR_PROFILE_FRIEND_REQ_SENT",alignment:"start",maxContentLines:1,ref:t});else{let e="btn_Chat_AddFrd",s="AddUser_24_Line",a="STR_PROFILE_ADD_FRIEND_LONG";r&&(e="btn_Chat_AcceptFrdReq",s="FriendReq_24_Line",a="STR_FRIEND_REQ_ACCEPT_DESC"),D=rr.a.createElement(rr.a.Fragment,null,rr.a.createElement(GS.a,{status:"info",iconOptions:{name:s},contentTextKey:a,"data-id":e,closable:!1,maxContentLines:1,alignment:"space-between",actions:[{type:"button",variant:r?"secondary":"neutral",textKey:r?"STR_ACCEPT":"STR_FRIEND_REQ_SEND",onClick:r?_:I},{type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}],ref:t}),L(Object.values(O)))}else{var A,F;let e="STR_FRIEND_REQ_SEND",s=I;o?(e="STR_UNDO_REQUEST",s=S):r&&(e="STR_ACCEPT",s=_);const a=[];a.push({textKey:e,onClick:s,type:"button",variant:(null===(A=g.data_render.buttons)||void 0===A||null===(F=A.add)||void 0===F?void 0:F.type)||"neutral"}),g.data_render.buttons.block&&g.data_render.buttons.block.show&&a.push({textKey:"STR_BLOCK_STRANGER_BANNER",onClick:y,type:"button",variant:g.data_render.buttons.block.type||"neutral"}),g.data_render.buttons.report&&g.data_render.buttons.report.show&&a.push({textKey:"STR_REPORT_USER",onClick:f,type:"button",variant:g.data_render.buttons.report.type||"secondary-danger"}),M.length&&a.push({type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}),D=rr.a.createElement(rr.a.Fragment,null,rr.a.createElement(GS.a,{status:"info",iconOptions:{name:"Warning_Circle_24_Line"},titleTextKey:T,contentTextKey:w,maxContentLines:1,closable:!1,actions:a,alignment:"space-between",ref:t}),M.length?L(M):null)}return D}));const tC=e=>e.user.userId,sC=rr.a.forwardRef(((e,t)=>{const{windowId:s,convId:a}=e,{friendInfo:i}=Object(QS.d)(a),{isPendingFriendRequest:n}=Object(QS.g)(a),{isFriendRequestSent:r}=Object(QS.f)(a),o=Object(YS.a)(),l=ZS(s,a),{toggleBlock:c}=$S(o,a,i),d=Object(XS.g)(tC);return rr.a.createElement(eC,{ref:t,reportUser:()=>l(a,s,{}),convId:a,myId:d,windowId:s,toggleBlock:c,pendingFriendRequest:n,friendRequestSent:r,dispatch:o})})),aC=rr.a.forwardRef(((e,t)=>{const{convId:s}=e,{startTime:a,duration:i}=Object(Po.l)(En.MuteDataManager,s,(e=>e?{startTime:e.startTime,duration:e.duration}:{startTime:0,duration:-1})),n=rr.a.useMemo((()=>ui.default.getHMTime(a,i)||""),[a,i]),r=n?`${le.a.str("STR_MUTE_TIME_LIMIT_V2")} ${n}`:`${le.a.str("STR_MUTE_TIME_LIMIT_FULL_V2")}`;return rr.a.createElement(GS.a,{ref:t,className:"mute-banner",htmlTitle:r,maxContentLines:1,status:"info",iconOptions:{name:"Notif_Off_24_Line"},alignment:"space-between",content:n?rr.a.createElement(rr.a.Fragment,null,rr.a.createElement(lr.a,{textKey:"STR_MUTE_TIME_LIMIT_V2"})," ",` ${n}`):rr.a.createElement(lr.a,{textKey:"STR_MUTE_TIME_LIMIT_FULL_V2"}),actions:[{onClick:()=>(e=>{me.a.MuteDataManager.onUnMute(e),Ia.default.logAction(1065101)})(s),textKey:"STR_REOPEN_0",type:"button",variant:"secondary"}],closable:!1})}));var iC=s("YCoq"),nC=s("ro+J"),rC=s("17x9"),oC=s.n(rC),lC=s("iuhU"),cC=s("i8i4"),dC=s.n(cC),uC=s("dRu9"),hC=s("2pdp"),gC=s("yh7P"),mC=s("n39p");const pC=function(e){const{conversationId:t,textContent:s="",hasCollapseButton:a}=e;let i=null;return a&&(i=rr.a.createElement(cr.a,{className:"collapse-button-container",onClick:e=>{e&&e.stopPropagation(),Object(Eu.c)(mC.a.PinBoard.COLLAPSE_BY_CLICK_BUTTON),gC.a.getInstance(t).collapseBoard()},textKey:"STR_COLLAPSE",postIcon:"Chevron_Up_24_Line",size:"small",type:"tertiary-neutral"})),rr.a.createElement("div",{className:"title-container"},rr.a.createElement(lr.a,{className:"title-content",textKey:`${s}`}),i)};pC.propTypes={conversationId:oC.a.string,textContent:oC.a.string.isRequired,hasCollapseButton:oC.a.bool};var fC=pC;const vC=function(e){const{topic:t={},hasCollapseButton:s}=e;return rr.a.createElement(rr.a.Fragment,null,t?rr.a.createElement("div",{className:"upcoming"},rr.a.createElement(fC,{textContent:"Sp din ra",hasCollapseButton:s}),rr.a.createElement(hC.a,{windowId:e.windowId,topic:t,isShowFullTime:!0})):null)};vC.propTypes={topic:oC.a.object,hasCollapseButton:oC.a.bool};var _C=vC,bC=s("vA3+"),IC=s("c7k8"),yC=s("YbZ6"),SC=s("1CKO");const CC=function(e){const{conversationId:t,topics:s=[],hasUpcoming:a}=e,{selfWindow:i}=Object(SC.a)(),[n,r]=Object(nr.useState)(i.innerHeight),o=Object(nr.useRef)(),l=Object(nr.useRef)(),c=Object(nr.useRef)(),d=Object(nr.useCallback)((()=>{var e;null===(e=o.current)||void 0===e||e._onResize()}),[o.current]),u=Object(nr.useCallback)(Object(yC.a)((()=>{const e=i.innerHeight;e&&r(e)}),150),[i.innerHeight]),h=Object(nr.useCallback)((()=>{gC.a.getInstance(t).closePopover()}),[]);Object(nr.useEffect)((()=>(i.addEventListener("resize",d),i&&o&&(c.current=o.current._parentNode,l.current=new i.ResizeObserver(d),l.current.observe(c.current)),()=>{i.removeEventListener("resize",d),c.current&&l.current.unobserve(c.current)})),[i]);let g=[];for(let f=0;f<s.length;f++){const a=s[f];a&&g.push(rr.a.createElement(hC.a,{windowId:e.windowId,conversationId:t,key:f,topic:a,index:f,isShowFullTime:a.startTime>0,size:mC.i.LARGE,mode:mC.h.EXPAND}))}const m=s.length*mC.b,p=Object(Eu.f)(n,a);return rr.a.createElement("div",{className:"board-list",style:{maxHeight:p,height:m}},rr.a.createElement(IC.a,{onResize:u,ref:o},(({width:e,height:t})=>rr.a.createElement(bC.c,{onScroll:h,noVScroll:!1,noHScroll:!0,autoHide:!0,style:{width:e+1,height:t+2}},rr.a.createElement("div",{tabIndex:"100"},g)))))};CC.propTypes={conversationId:oC.a.string,topics:oC.a.array.isRequired,hasUpcoming:oC.a.bool};var EC=CC,OC=s("AbDx"),MC=s("zRkS");const TC=function(e){const{conversationId:t}=e,s=Object(OC.a)(Object(YS.b)(),t);return rr.a.createElement("div",{className:"view-all-board-container",onClick:e=>{Object(Eu.c)(mC.a.PinBoard.CLICK_VIEW_ALL_GROUP_BOARD),gC.a.getInstance(t).closePopover(),s.emit(ve.GeneralActions.OPEN_MEDIA_BOARD,{type:ve.GeneralActions.OPEN_GROUP_BOARD_ALL,uid:t}),gC.a.getInstance(t).collapseBoard(),e&&(e.preventDefault(),e.stopPropagation())}},rr.a.createElement("div",{className:"view-all-board-content"},rr.a.createElement(lr.a,{className:"view-all-board-text-content",textKey:Vf.a.get("STR_VIEW_ALL_IN_BOARD",t)}),rr.a.createElement(MC.a,{icon:"Chevron_Right_24_Line",className:"view-all-board-icon"})))};TC.propTypes={conversationId:oC.a.string};var wC=TC;function RC(e,t){const{conversationId:s,topics:a=[],upcomingEvent:i}=e,n=a;let r=null;return Object(iC.i)()&&i&&(r=rr.a.createElement(_C,{windowId:e.windowId,topic:i,hasCollapseButton:!0})),rr.a.createElement("div",{ref:t,className:"topic-board-details"},r,rr.a.createElement(fC,{conversationId:s,textContent:le.a.trans("STR_PIN_BOARD",[n.length]),hasCollapseButton:!r}),rr.a.createElement(EC,{windowId:e.windowId,conversationId:s,topics:n,hasUpcoming:!!r}),rr.a.createElement(wC,{conversationId:s}))}const LC=rr.a.forwardRef(RC);LC.propTypes={conversationId:oC.a.string,topics:oC.a.array.isRequired,upcomingEvent:oC.a.object};var DC=LC,AC=s("Cl2u");const FC="topic-board-details-wrapper",kC={Block:FC,Modifiers:{Transitioning:"--"},Elements:{Overlay:`${FC}__overlay`}},NC=e=>{var t;const{selfWindow:s}=Object(SC.a)(),a=null!==(t=s.document.getElementById("messageView"))&&void 0!==t?t:s.document.body,i=rr.a.useRef(null);return rr.a.createElement(uC.d,{nodeRef:i,in:e.show,appear:!0,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=i.current)||void 0===t||t.addEventListener("transitionend",e,!1)}},(t=>dC.a.createPortal(rr.a.createElement("div",{className:Object(lC.a)(kC.Block,e.className,`${kC.Modifiers.Transitioning}${t}`)},rr.a.createElement(AC.a,{nodeRef:i,state:t},((t,s)=>rr.a.createElement(DC,{ref:s,windowId:e.windowId,conversationId:e.convId,topics:e.topics,dispatch:e.dispatch,upcomingEvent:e.upcomingEvent}))),rr.a.createElement("div",{className:kC.Elements.Overlay,onClick:e.onCollapse})),a)))};const PC=function(e){const{conversationId:t,topic:s,numberOfMoreTopics:a,hasUnread:i,isHighlighted:n}=e;return rr.a.createElement("div",{className:"chat-group-topic__preview"},rr.a.createElement("div",null,rr.a.createElement(hC.a,{windowId:e.windowId,conversationId:t,topic:s,isInPreview:!0,numberOfMoreTopics:a,hasUnread:i,size:mC.i.LARGE,mode:mC.h.PREVIEW,isHighlighted:n,index:-1,isShowFullTime:!0,emitter:e.emitter})))};PC.propTypes={conversationId:oC.a.string,topic:oC.a.object.isRequired,numberOfMoreTopics:oC.a.number,hasUnread:oC.a.bool,isHighlighted:oC.a.bool};var jC=PC,UC=s("kQ1Y"),BC=s("Lqdh");const zC="Preview",GC="Details";function xC(e,t){const{conversationId:s,topics:a=[],upcomingEvent:i,dispatch:n=(()=>{}),confirm:r=(()=>{}),settings:o={}}=e;if(0===(null==a?void 0:a.length)&&!i)return null;const[l,c]=Object(nr.useState)(zC),[d,u]=Object(nr.useState)(!1),h=()=>{c(zC)},g=()=>{var e;const t=null===(e=Cu.a.getInstance(s).getConversation())||void 0===e?void 0:e.userId;Cu.a.getInstance(s).fetchTopicsOnOpenBoardDetails(t);c(GC)},m=e=>{u(e)},p=e=>{var t;if(l===zC)return;let s=!0;if(null!=e&&null!==(t=e.detail)&&void 0!==t&&t.from&&"PopoverButton"===e.detail.from&&(s=!1),s){{const e=we.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===Cn.e.FULL&&(null==e||!e.dissmis))return}Object(Eu.c)(mC.a.PinBoard.COLLAPSE_BY_CLICK_OUTSIDE),h()}};function f(){return e.selfWindow||window}Object(nr.useEffect)((()=>{UC.a.setDispatch(s,n),UC.a.setConfirm(s,r),UC.a.setCollapse(s,h),UC.a.setExpandBoard(s,g),UC.a.setToggleHighlightPreview(s,m);const e=BC.default.registerFunc(Y.K_ESC,(()=>{{const e=we.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===Cn.e.FULL&&(null==e||!e.dissmis))return}Object(Eu.c)(mC.a.PinBoard.COLLAPSE_BY_ESC),h()}));return()=>{BC.default.unregister(Y.K_ESC,e),UC.a.removeCallbacks(s)}}),[s]),Object(nr.useEffect)((()=>(f().addEventListener("click",p),()=>{f().removeEventListener("click",p)})),[l]),Object(nr.useEffect)((()=>{gC.a.getInstance(s).callUpdateComp()}),[o]);const v=Object(Eu.g)(a)||i,_=null!=a&&a.length?a.length-1:0,b=Object(Eu.l)(a);return rr.a.createElement(nC.a,null,rr.a.createElement("div",{className:"chat-group-topic",onClick:e=>{e&&e.stopPropagation()},ref:t},rr.a.createElement(jC,{windowId:e.windowId,conversationId:s,topic:v,numberOfMoreTopics:_,dispatch:n,confirm:r,hasUnread:b,isHighlighted:d,emitter:e.emitter}),rr.a.createElement(NC,{show:l===GC,windowId:e.windowId,convId:s,topics:a,dispatch:n,upcomingEvent:i,onCollapse:h})))}const VC=Object(nr.forwardRef)(xC);VC.propTypes={conversationId:oC.a.string,topics:oC.a.array.isRequired,upcomingEvent:oC.a.object,dispatch:oC.a.func,confirm:oC.a.func,settings:oC.a.object};var HC=VC,WC=s("medu"),qC=s("Ssn2");const KC=rr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a,confirm:i}=e,{selfWindow:n}=Object(SC.a)(),r=Object(nr.useMemo)((()=>Object(qC.a)(s)),[s]),o=Su.a.getTopics(s),{groupInfo:l}=Object(QS.e)(s),c=Object(YS.a)(),d=Object(YS.b)();let u=null;if(r){let e=!1,r=null;var h;if(o.length>0)e=!0;else if(Object(iC.i)())r=Cu.a.getInstance(s).getUpcomingEvent(),null!==(h=r)&&void 0!==h&&h.id&&(e=!0);e&&(u=rr.a.createElement(nC.a,null,rr.a.createElement("div",{ref:t,className:"chat-group-topic-outer"},rr.a.createElement(HC,{key:s,confirm:i,conversationId:s,dispatch:c,emitter:d,selfWindow:n,settings:null==l?void 0:l.setting,upcomingEvent:r,topics:o,windowId:a}))))}else u=rr.a.createElement(WC.b,{key:s,ref:t,conversationId:s,dispatch:c});return u}));var $C=s("Sn9s");const ZC=rr.a.forwardRef(((e,t)=>{const s=Object(Po.l)(Dl.e,e.convId);return rr.a.createElement($C.e,{ref:t,windowId:e.windowId,position:Dl.f.CHAT_BOX,type:null==s?void 0:s.bannerStatus.type,groupId:e.convId})}));var QC=s("YbKq"),YC=s("85uQ"),JC=s("Ilka"),XC=s("FLoU"),eE=s("Ov6d"),tE=s("93l+"),sE=s("KJYm"),aE=s("4ZGW");const iE=rr.a.forwardRef(((e,t)=>{const{windowId:s,convId:a}=e,{status:i,showBanner:r,dismissBanner:o}=Object(tE.a)();let{usage:l=0,quota:c=0}=Object(aE.a)()||{usage:0,quota:0};const d=Math.round(l/c*100),u=ui.default.sizeToStringV2(c-l),h=rr.a.useMemo((()=>Math.pow(Object(JC.d)(),2)),[]);rr.a.useEffect((()=>{r&&(i===YC.a.NEARY_FULL?sE.a.logViewMyCloudBanner({quota_warning_name:"yellow"}):i===YC.a.FULL?sE.a.logViewMyCloudBanner({quota_warning_name:"full"}):i===YC.a.ALMOST_FULL&&sE.a.logViewMyCloudBanner({quota_warning_name:"red"}))}),[i,r]);const g={source:XC.b.CSC,mycloud_size:l/h};function m(){Object(eE.a)(s),ue.a.getInstance().loadMyCloudMessagesInBackground(),function(){let e;const t=n.default.getInstance(),s="1st_cl_tool";t.getItemForCurrentUser(s)||(e=(new Date).toLocaleDateString("fr-CA").replaceAll("-",""),t.setItemForCurrentUser(s,e))}(),sE.a.logClickBannerButtons()}function p(){o()}return(e=>{let s,a,i,n,r,o,l="info",c=!1;switch(e){case YC.a.NEARY_FULL:s=QC.a.NEARLY,a="STR_CLOUD_BANNER_NEARLY_FULL_TITLE",i="STR_CLOUD_BANNER_NEARLY_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",c=!0,r=[d,Ii.default.getDName(Ce.default.sendToMeId)],o=[Ii.default.getDName(Ce.default.sendToMeId)],g.warning=XC.d.YELLOW,l="warning";break;case YC.a.ALMOST_FULL:s=QC.a.ALMOST,a="STR_CLOUD_BANNER_ALMOST_FULL_TITLE",i="STR_CLOUD_BANNER_ALMOST_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",r=[u,Ii.default.getDName(Ce.default.sendToMeId)],g.warning=XC.d.RED,l="error";break;case YC.a.FULL:s=QC.a.FULL,a="STR_CLOUD_BANNER_FULL_TITLE",i="STR_CLOUD_BANNER_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",r=[Ii.default.getDName(Ce.default.sendToMeId)],g.warning=XC.d.FULL,l="error";break;default:return null}return rr.a.createElement(rr.a.Fragment,null,rr.a.createElement(GS.a,{ref:t,className:"cloud-banner",titleTextKey:a,titleArgs:r,contentTextKey:i,contentArgs:o,status:l,iconOptions:{name:"warning-24"},alignment:"space-between",actions:n?[{onClick:m,textKey:n,type:"button",variant:"outline-tertiary-neutral"}]:void 0,closable:c,onClose:p}))})(i)}));var nE=s("ZSw7");class rE{constructor(){this.version=void 0}render(e,t){return this.checkIfShouldShowBannersOrNot(e),this.createChatBoxBannerView(e,t)}checkIfShouldShowBannersOrNot(e){const{convId:t,windowId:s}=e;var i;Object(nr.useEffect)((()=>{const e=a.ModuleContainer.resolve(zS.a).getBannerManagers();if(e.length>0){const i=a.ModuleContainer.resolve(fI.a);e.forEach((e=>{e.checkShowMyBanners(t,s).forEach((e=>{e.shouldShow?i.requestShowBanner(e.bannerName,{convId:t}):i.requestHideBanner(e.bannerName,{convId:t})}))}))}}),[t,s]),(e=>{const{friendInfo:t}=Object(QS.d)(e),{isBlocked:s}=$S((()=>{}),e,t),i=Object(nr.useMemo)((()=>Object(qC.a)(e)),[e]);Object(nr.useEffect)((()=>{const n=a.ModuleContainer.resolve(fI.a);0!==Ce.default.block_msg_call_setting.enable_block_msg_call_setting||!s||i||ui.default.isOAType(t)?n.requestHideBanner(pI.a.BLOCKED_BANNER,{convId:e}):n.requestShowBanner(pI.a.BLOCKED_BANNER,{convId:e})}),[s,e,t])})(t),(e=>{const{friendInfo:t}=Object(QS.d)(e),{isBlocked:s}=$S((()=>{}),e,t);Object(nr.useEffect)((()=>{if(t){const{isFr:i,type:n}=t,r=!i&&n===Y.FRIEND_TYPE_NORMAL,o=a.ModuleContainer.resolve(fI.a);r&&!s?o.requestShowBanner(pI.a.STRANGER_BANNER,{convId:e}):o.requestHideBanner(pI.a.STRANGER_BANNER,{convId:e})}}),[e,s,t])})(t),i=t,Object(nr.useEffect)((()=>{const e=Object(qC.a)(i);if(e){const e=Ii.default.getUidMe();Cu.a.getInstance(i).changeConversation(i,e)}else Sb.j.GetUIManager().loadAndRegisterToDisplayBanner(i);return()=>{e&&Cu.a.freeInstance(i)}}),[i]),(e=>{const t=Object(Po.l)(En.MuteDataManager,e);rr.a.useEffect((()=>{let s=!1,i=!1,n=null,r=!1;if(t&&-1==t.duration&&Object(nE.a)().hide_endless_mute_banner_after_seconds>=0){const s=1e3*Object(nE.a)().hide_endless_mute_banner_after_seconds-(Date.now()-1e3*t.startTime);s>0?n=setTimeout((()=>{const t=a.ModuleContainer.resolve(fI.a),s={convId:e};t.requestHideBanner(pI.a.MUTE_BANNER,s)}),s):r=!0}i=r,s=!!t&&!i;const o=a.ModuleContainer.resolve(fI.a),l={convId:e};return s?o.requestShowBanner(pI.a.MUTE_BANNER,l):o.requestHideBanner(pI.a.MUTE_BANNER,l),()=>{n&&clearTimeout(n)}}),[t,e])})(t),(e=>{const t=Object(Po.l)(Dl.e,e);rr.a.useEffect((()=>{var s;const i=Object(qC.a)(e)&&Ce.default.group_privacy.community.enable_upgrade&&(null==t?void 0:t.bannerStatus.show)&&(null===(s=t.bannerStatus.position)||void 0===s?void 0:s.has(Dl.f.CHAT_BOX)),n=a.ModuleContainer.resolve(fI.a),r={convId:e};i?n.requestShowBanner(pI.a.COMMUNITY_ENCOURAGE_BANNER,r):n.requestHideBanner(pI.a.COMMUNITY_ENCOURAGE_BANNER,r)}),[t,e])})(t),(e=>{const{showBanner:t}=Object(tE.a)();Object(nr.useEffect)((()=>{const s=a.ModuleContainer.resolve(fI.a);t?s.requestShowBanner(pI.a.MY_CLOUD_BANNER,{convId:e}):s.requestHideBanner(pI.a.MY_CLOUD_BANNER,{convId:e})}),[e,t])})(t)}}class oE extends rE{constructor(...e){super(...e),this.version=1}createChatBoxBannerView(e,t){return rr.a.createElement(lE,Object(BS.a)({ref:t},e))}}const lE=rr.a.memo(rr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a,chatBoxBannerState:i,confirm:n}=e,r=rr.a.useRef(null),{chatBoxBannerObjectPool:o}=Object(QS.a)();rr.a.useImperativeHandle(t,(()=>({getChatBoxBannerHeight:()=>{var e,t;return null!==(e=null===(t=r.current)||void 0===t?void 0:t.clientHeight)&&void 0!==e?e:0}})),[]);const l=null==i?void 0:i.bannerNameList;return null!=l&&l.length?rr.a.createElement("div",{ref:r,className:"list-chat-box-banner"},rr.a.createElement("div",{className:"list-chat-box-banner__content"},l.map((e=>o.getBannerComponent(e,{windowId:a,convId:s,confirm:n}))))):null})));var cE;Object(a.injectable)()(cE=Object(a.singleton)(US.a)(cE=class{constructor(){this._bannerManagerContainer=new Map,this._isLoadedBannerManagers=!1}getBannerComponent(e,t,s){let a=null;switch(e){case pI.a.PIN_TOPIC_BANNER:a=rr.a.createElement(KC,{key:e,ref:s,windowId:t.windowId,convId:t.convId,confirm:t.confirm});break;case pI.a.MUTE_BANNER:a=rr.a.createElement(aC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case pI.a.BLOCKED_BANNER:a=rr.a.createElement(JS,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case pI.a.STRANGER_BANNER:a=rr.a.createElement(sC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case pI.a.COMMUNITY_ENCOURAGE_BANNER:a=rr.a.createElement(ZC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case pI.a.MY_CLOUD_BANNER:a=rr.a.createElement(iE,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;default:a=null}return null==a&&zconsole.zsymb(18,"ASGvti",`[getBannerComponent] ${e} is null!`),a}getChatBoxBannerFactory(){return new oE}getBannerManagers(){const e=Array.from(this._bannerManagerContainer.values());return e.length||this._isLoadedBannerManagers?e:(this._loadBannerManagers(),this.getBannerManagers())}_loadBannerManagers(){this._isLoadedBannerManagers||(this._isLoadedBannerManagers=!0)}})||cE);var dE,uE=s("QCfS"),hE=s("l9M7");Object(a.singleton)(uE.b)(dE=Object(Ai.b)(uE.b)(dE=function(e,t){return Object(a.inject)(PS)(e,void 0,0)}(dE=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(dE=Reflect.metadata("design:type",Function)(dE=Reflect.metadata("design:paramtypes",[Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(dE=class{constructor(e,t){this.type=void 0,this.key=uE.a,this.name=uE.a,this.chatBoxBannerUIStateMap_=new Map,this.requestingBannerNameListMap_=new Map,this.chatBoxBannerAppService_=void 0,this.logger_=void 0,this.chatBoxBannerAppService_=e,this.logger_=t.createZLogger(R.ZLoggerNametags.cbbManager,[R.ZLoggerNametags.manageCbbUiState])}init(){}getItem(e,t){if(e.key&&Object(hE.b)(e.key)){return this.getChatBoxBannerUIState_(e.key)}}getList(e,t){return[]}onGetItemFailure(e,t){this.logger_.zsymb(21,"ydTTmw",["[onGetItemFailure] key: {}, error: {}","RmcrN1"],e,t.message)}onGetListFailure(e,t){this.logger_.zsymb(21,"1FQoTr",["[onGetListFailure] key: {}, error: {}","fHmJDJ"],e,t.message)}isBannerDisplaying(e,t){if(!t){const e=`[isBannerDisplaying] Invalid required parameter convId: ${t}.`;return this.logger_.zsymb(0,"PAuBDD",e),!1}const s=Object(hE.a)(t);return this.getChatBoxBannerUIState_(s).bannerNameList.includes(e)}requestShowBanner(e,t){const s=t.convId;if(!s){const e=`[requestShowBanner] Invalid required parameter convId: ${s}.`;return this.logger_.zsymb(0,"SxZJE-",e),!1}return this.processShowBanner_(e,s)}requestHideBanner(e,t){const s=t.convId;if(s)this.processHideBanner_(e,s);else{const e=`[requestHideBanner] Invalid required parameter convId: ${s}.`;this.logger_.zsymb(0,"fYV1Bb",e)}}createDefaultChatBoxBannerUIState_(){return{lastModifiedTime:Date.now(),bannerNameList:[]}}getConvType_(e){return e?e===Ce.default.sendToMeId?pI.b.MY_CLOUD:e.startsWith("g")?pI.b.GROUP:pI.b.ONE_TO_ONE:pI.b.UNKNOWN}processShowBanner_(e,t){const s={convType:this.getConvType_(t)};if(!this.chatBoxBannerAppService_.isBannerEnabled(e,s))return this.logger_.zsymb(3,"h123dm",["[processShowBanner_] {} is not enabled.","mW0WJq"],e),!1;if(!this.isBannerDisplaying(e,t)){const s=Object(hE.a)(t),a=this.getChatBoxBannerUIState_(s),i=this.getRequestingBannerNameList_(s),n=Object(Lg.a)(a,(t=>{const s=this.chatBoxBannerAppService_.addBannerNameToBannerNameList(e,[...i]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,n),Object(Po.h)(this.name,s)}return this.refreshRequestingBannerInList_(e,t,"add_new"),!0}refreshRequestingBannerInList_(e,t,s){const a=Object(hE.a)(t);const i=this.getRequestingBannerNameList_(a).filter((t=>t!==e));"add_new"===s&&i.push(e),this.requestingBannerNameListMap_.set(a,i)}processHideBanner_(e,t){const s={convType:this.getConvType_(t)};if(this.chatBoxBannerAppService_.isBannerEnabled(e,s)){if(this.isBannerDisplaying(e,t)){const s=Object(hE.a)(t),a=this.getRequestingBannerNameList_(s),i=this.getChatBoxBannerUIState_(s),n=Object(Lg.a)(i,(t=>{const s=this.chatBoxBannerAppService_.removeBannerNameFromBannerNameList(e,[...a]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,n),Object(Po.h)(this.name,s)}this.refreshRequestingBannerInList_(e,t,"remove")}else this.logger_.zsymb(3,"ytrvXD",["[processHideBanner_] {} is not enabled.","IVC_I1"],e)}getChatBoxBannerUIState_(e){let t=this.chatBoxBannerUIStateMap_.get(e);return t||(t=this.createDefaultChatBoxBannerUIState_(),this.chatBoxBannerUIStateMap_.set(e,t)),t}getRequestingBannerNameList_(e){let t=this.requestingBannerNameListMap_.get(e);return t||(t=[],this.requestingBannerNameListMap_.set(e,t)),t}getChatBoxBannerUIState(e){const t=Object(hE.a)(e);return this.getChatBoxBannerUIState_(t)}getRequestingChatBoxBanners(e){const t=Object(hE.a)(e);return this.getRequestingBannerNameList_(t)}getShowingChatBoxBanners(e){const t=Object(hE.a)(e);return this.getChatBoxBannerUIState_(t).bannerNameList}getChatBoxBannerConfigData(){return this.chatBoxBannerAppService_.getChatBoxBannerConfigData()}})||dE)||dE)||dE)||dE)||dE);var gE,mE=s("pqQ2"),pE=s("1Pg6"),fE=s("0NOU");Object(Ai.b)(pE.a)(gE=Reflect.metadata("design:type",Function)(gE=Reflect.metadata("design:paramtypes",[])(gE=class extends Or.a{constructor(){super(mE.a,mE.b),this.key=void 0,this.key=mE.a}startDownloadProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=0,e.entry=t}),e)}updateProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=Math.min(Math.max(t,0),100)}),e)}completeDownloadProgress(e){this.removeDownloadProgress(e)}handleAfterDownloadError(e){this.removeDownloadProgress(e)}removeDownloadProgress(e){this.removeItem(e)}getDownloadInfo(e){return this.getItem({key:e,version:0,extraData:{}},{})}getDownloadInfoByMessage(e){const t=Object(fE.a)(e);return this.getItem({key:t,version:0,extraData:{}},{})}isDownloading(e){var t;const s=this.getItem({key:e,version:0,extraData:{}},{});return null!==(t=null==s?void 0:s.isDownloading)&&void 0!==t&&t}})||gE)||gE);var vE=s("kZZr"),_E=s("VteK"),bE=s("zNPY"),IE=s("UwMY"),yE=s("bWos"),SE=s("/YHU");class CE{constructor(e){var t,s,a,i,n,r;this.noiseId=void 0,this.zCloudKey=void 0,this.size=void 0,this.ts=void 0,this.extraInfo=void 0,this.message=void 0,this.isDuplicated=void 0,this.noiseId=e.noiseId,this.zCloudKey=yE.a.getZCloudKeyFromCloudItem(e),this.size=e.mediaInfo.mediaSize,this.ts=e.msgInfo.ts,this.isDuplicated=e.isDuplicated||!1;const o=(null==e||null===(t=e.msgInfo)||void 0===t?void 0:t.destId)==Ce.default.sendToMeId?null===(s=e.mediaInfo)||void 0===s||null===(a=s.mediaExtInfo)||void 0===a?void 0:a.data:null===(i=e.mediaInfo)||void 0===i||null===(n=i.mediaExtInfo)||void 0===n?void 0:n.decryptedData;if(o){const e=Object(SE.a)(o);e&&(this.extraInfo={title:e.title,thumbUrl:e.thumbUrl,params:o})}const l=ui.default.normalizeMessageType(e.msgInfo.msgType);var c;(this.message={cliMsgId:e.msgInfo.cliMsgId+"",fromUid:e.msgInfo.srcId+"",toUid:yE.a.getConversationIdFromCloudItem(e,we.default.getUserId()),msgType:l,msgId:e.msgInfo.glbMsgId+"",isE2EE:!!e.msgInfo.isE2EE},null!==(r=this.extraInfo)&&void 0!==r&&r.thumbUrl)&&(this.message.message={thumbUrl:null===(c=this.extraInfo)||void 0===c?void 0:c.thumbUrl})}static transfer(e){const t=new CE(e);return Object.assign({},t)}}var EE=s("JP/W"),OE=s("na98"),ME=s("Qf4l"),TE=s("lGS6"),wE=s("iA9X"),RE=s("4LiO"),LE=s("oG6Z"),DE=s("sNf9");const AE="enable_view_mode",FE="enable_view_mode_for_free_user",kE={[`${AE}`]:!1,[`${FE}`]:!1},NE=new X.ObjectValidator({[`${AE}`]:X.Rule.field().boolean(),[`${FE}`]:X.Rule.field().boolean()}),PE=new X.AdvancedRemoteConfigs("zcloud_management_tool",kE,{validator:NE});var jE,UE=s("t9fU");const BE="cloud",zE={verifyQueueDone:!1,cloudItems:null,displayData:null,selectedItems:{},lastClickSelectItem:null,currentFilter:QC.e.ALL,currentSort:QC.g.SIZE_DESCENDING,status:null,fetching:!1,fetchLimit:null,hasMore:!1,lastItemInfo:null,queryError:null,cloudThumbItemMode:DE.a.ViewMode};Object(a.injectable)()(jE=Object(a.singleton)(vE.b)(jE=Object(Ai.b)(vE.b)(jE=function(e,t){return Object(a.inject)(bE.a)(e,void 0,0)}(jE=function(e,t){return Object(a.inject)(bE.b)(e,void 0,1)}(jE=Reflect.metadata("design:type",Function)(jE=Reflect.metadata("design:paramtypes",[void 0===bE.a?Object:bE.a,void 0===bE.b?Object:bE.b])(jE=class extends Or.a{constructor(e,t){super(),this.zCloudConversationController=e,this.zCloudSideBarController=t,this.config=void 0,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.cloudViewItems=void 0,this.getDefaultCloudState=()=>Object(I.a)(Object(I.a)({},zE),{},{cloudThumbItemMode:this.isViewModeEnabled()?DE.a.ViewMode:DE.a.SelectableMode}),this.toggleCloudThumbItemMode=e=>{this._toggleCloudThumbItemMode(e)},this._toggleCloudThumbItemMode=e=>{this.updateItem((t=>{t.cloudThumbItemMode=e}),BE),this.resetSelectedItem()},this.config=PE,this.name=vE.a,this.key=vE.a,this.data.set(BE,this.getDefaultCloudState()),this.cloudViewItems=null}_getState(e=BE){return this.data.get(e)}async _sort(e){this.updateItem((t=>{t.currentSort=e}),BE)}_filter(e){try{this.updateItem((t=>{t.currentFilter=e}),BE)}catch(t){}}_getCurrentSort(){const{currentSort:e}=this._getState();return e}isSortedBySize(e){return[QC.g.SIZE_ASCENDING,QC.g.SIZE_DESCENDING].includes(e)}getMappingTypeFromFilter(e){switch(e){case QC.e.ALL:return[Y.MSG_PHOTO,Y.MSG_PHOTO_2,Y.MSG_DOODLE,Y.MSG_VIDEO,Y.MSG_FILE,Y.MSG_VOICE];case QC.e.PHOTO:return[Y.MSG_PHOTO,Y.MSG_PHOTO_2,Y.MSG_DOODLE];case QC.e.VIDEO:return[Y.MSG_VIDEO];case QC.e.FILE:return[Y.MSG_FILE];case QC.e.VOICE:return[Y.MSG_VOICE]}}isSameFilterType(e){const{currentFilter:t}=this._getState(),s=this.getMappingTypeFromFilter(t),a=ui.default.normalizeMessageType(e.msgInfo.msgType);return s&&Array.isArray(s)&&s.includes(a)}getConsideredItems(e){if(!e||!Array.isArray(e))return null;let t=[...e];this.zCloudSideBarController.getCurrentView()!==ME.b.MY_CLOUD&&(t=t.filter((e=>e.zConv!==Ce.default.sendToMeId)));const s=this.zCloudConversationController.getCurrentSelectedConvId();return s&&(t=t.filter((e=>e.zConv===s))),t=t.filter((e=>!un.a.isThreadHidden(e.zConv))),t=t.filter((e=>this.isSameFilterType(e))),t}checkIsInRange(e,t,s){return e>=t&&e<=s}addCloudItemSizeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].size,n=s[s.length-1].size;a=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,n,i)||(s>i||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.size;return t.size-s}));this.updateItem((e=>{e.displayData=i}),BE)}addCloudItemSizeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].size,n=s[s.length-1].size;a=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,i,n)||(s<i||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.size;return-(t.size-s)}));this.updateItem((e=>{e.displayData=i}),BE)}addCloudItemTimeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].ts,n=s[s.length-1].ts;a=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,n,i)||(s>i||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.ts;return t.ts-s}));this.updateItem((e=>{e.displayData=i}),BE)}addCloudItemTimeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].ts,n=s[s.length-1].ts;a=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,i,n)||(s<i||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.ts;return-(t.ts-s)}));this.updateItem((e=>{e.displayData=i}),BE)}filter(e){this._filter(e),this.isViewModeEnabled()&&this.toggleCloudThumbItemMode(DE.a.ViewMode)}sort(e){this._sort(e)}getCurrentFilter(){const{currentFilter:e}=this._getState();return e}getCurrentSort(){const{currentSort:e}=this._getState();return e}setVerifyQueueDone(e){this.updateItem((t=>{t.verifyQueueDone=e}),BE)}setViewPortItemInfo(e){this.updateItem((t=>{t.viewPortItemInfo=e}),BE)}async addCloudItems(e){const{currentSort:t}=this._getState();let s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;Object(Dy.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&_E.a.getInstance().updateExtMediaInfo(s),a.ModuleContainer.resolve(Dy.c).calculateZCloudStatusByCloudItems(s);const i=s.map((e=>CE.transfer(e)));t===QC.g.SIZE_DESCENDING?this.addCloudItemSizeDescending(i):t===QC.g.SIZE_ASCENDING?this.addCloudItemSizeAscending(i):t===QC.g.TIME_DESCENDING?this.addCloudItemTimeDescending(i):t===QC.g.TIME_ASCENDING&&this.addCloudItemTimeAscending(i)}updateCloudItems(e){const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;const a=t.flatMap((t=>{const a=s.findIndex((e=>yE.a.getZCloudKeyFromCloudItem(e)===t.zCloudKey));return-1===a?t:CE.transfer(e[a])}));a&&Array.isArray(a)&&this.updateItem((e=>{e.displayData=a}),BE)}removeCloudItems(e){if(!e||!Array.isArray(e))return;const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=e;Object(EE.b)("removeCloudItems | displayData before remove: ",t);const a=t.filter((e=>!s.includes(e.zCloudKey)));this.updateItem((e=>{e.displayData=a}),BE),Object(EE.b)("removeCloudItems | displayData after remove: ",t)}getCurrentQueryIdentity(){const e=this.zCloudSideBarController.getCurrentView(),{currentFilter:t,currentSort:s}=this._getState();return`${e||e+""}_${t}_${s}`}async getAllByTypeSizeOrDate(e,t,s,a,i=!0){try{const{currentSort:n,currentFilter:r,lastItemInfo:o}=this._getState(),l=r===QC.e.ALL;let c=null;switch(n){case QC.g.SIZE_DESCENDING:c=l?await _E.a.getInstance().getAllByTypeSize("",i?OE.c:t,s,a,O.c.PREV,o?o.offset:0):await _E.a.getInstance().getAllByTypesSize(e,i?OE.c:t,s,a,O.c.PREV,o?o.offset:0);break;case QC.g.SIZE_ASCENDING:c=l?await _E.a.getInstance().getAllByTypeSize("",t,s,a,O.c.NEXT,o?o.offset:0):await _E.a.getInstance().getAllByTypesSize(e,t,s,a,O.c.NEXT,o?o.offset:0);break;case QC.g.TIME_DESCENDING:c=l?await _E.a.getInstance().getAllByTypeDate("",i?OE.b:t,s,a,O.c.PREV,o?o.offset:0):await _E.a.getInstance().getAllByTypesDate(e,i?OE.b:t,s,a,O.c.PREV,o?o.offset:0);break;case QC.g.TIME_ASCENDING:c=l?await _E.a.getInstance().getAllByTypeDate("",t,s,a,O.c.NEXT,o?o.offset:0):await _E.a.getInstance().getAllByTypesDate(e,t,s,a,O.c.NEXT,o?o.offset:0);break;default:c=null}return{result:c,identity:this.getCurrentQueryIdentity()}}catch(n){throw{error:n,identity:this.getCurrentQueryIdentity()}}}async getAllConvByTypeSizeOrDate(e,t,s,a,i,n=!0){try{const{currentFilter:r,currentSort:o,lastItemInfo:l}=this._getState(),c=r===QC.e.ALL;let d=null;switch(o){case QC.g.SIZE_DESCENDING:d=c?await _E.a.getInstance().getAllByConversationTypeSize(e,"",n?OE.c:s,a,i,O.c.PREV,l?l.offset:0):await _E.a.getInstance().getAllByConversationTypesSize(e,t,n?OE.c:s,a,i,O.c.PREV,l?l.offset:0);break;case QC.g.SIZE_ASCENDING:d=c?await _E.a.getInstance().getAllByConversationTypeSize(e,"",s,a,i,O.c.NEXT,l?l.offset:0):await _E.a.getInstance().getAllByConversationTypesSize(e,t,s,a,i,O.c.NEXT,l?l.offset:0);break;case QC.g.TIME_DESCENDING:d=c?await _E.a.getInstance().getAllByConversationTypeDate(e,"",n?OE.b:s,a,i,O.c.PREV,l?l.offset:0):await _E.a.getInstance().getAllByConversationTypesDate(e,t,n?OE.b:s,a,i,O.c.PREV,l?l.offset:0);break;case QC.g.TIME_ASCENDING:d=c?await _E.a.getInstance().getAllByConversationTypeDate(e,"",s,a,i,O.c.NEXT,l?l.offset:0):await _E.a.getInstance().getAllByConversationTypesDate(e,t,s,a,i,O.c.NEXT,l?l.offset:0);break;default:d=null}return{result:d,identity:this.getCurrentQueryIdentity()}}catch(r){throw{error:r,identity:this.getCurrentQueryIdentity()}}}updateLastItemInfo(e,t){if(!e)return;const s=this._getCurrentSort();this.updateItem((a=>{a.lastItemInfo={type:e.zType,sizeOrDate:this.isSortedBySize(s)?e.zSize:e.zDate,noiseId:e.noiseId,offset:t}}),BE)}setLastItemFromQueryData(e){if(!e||!Array.isArray(e))return;const t=e[e.length-1];Object(EE.b)("currLastItem: ",t);const{lastItemInfo:s}=this._getState();(null==t?void 0:t.noiseId)!==(null==s?void 0:s.noiseId)&&this.updateLastItemInfo(t,((null==s?void 0:s.offset)||0)+e.length)}checkHasMoreCloudMedia(e,t){return e&&Array.isArray(e)&&e.length>=t}setHasMoreFromQueryData(e,t){if(!e||!Array.isArray(e))return;const s=this.checkHasMoreCloudMedia(e,t);Object(EE.b)("hasMore: ",s),this.updateItem((e=>{e.hasMore=s}),BE)}filterNonMyCloudMediaItem(e){return e&&Array.isArray(e)?e.filter((e=>e.zConv!==Ce.default.sendToMeId)):null}filterInvalidCloudItems(e){if(!e||!Array.isArray(e))return null;let t;t=e.filter((e=>!un.a.isThreadHidden(e.zConv)));return this.zCloudSideBarController.getCurrentView()!==ME.b.MY_CLOUD&&(t=this.filterNonMyCloudMediaItem(t)),t}setDisplayDataFromQueryData(e,t,s){if(!e||!Array.isArray(e))return;const a=e,{displayData:i}=this._getState();!t&&i&&Array.isArray(i)?this.updateItem((e=>{e.displayData=[...i,...a]}),BE):this.updateItem((e=>{e.displayData=a}),BE)}filterDuplicatedItems(e){if(!e||e.length<=0)return e;let t={},s=[];for(let a=0;a<e.length;a++){let i=e[a];if(!i)continue;let{zKey:n}=i;if(n)if(t.hasOwnProperty(n)){let{index:e}=t[n],{actionType:a}=i;Object(wE.b)("found dup item",n,i,e),a===IE.b.add_new?s.splice(e,1,Object(I.a)(Object(I.a)({},i),{},{isDuplicated:!0})):s[e].isDuplicated=!0}else s.push(i),t[n]=Object(I.a)(Object(I.a)({},i),{},{index:s.length-1})}return s}async fetchAllCloudMedia(e,t,s,i,n,r=!1,o=-1){try{var l;const c=this.zCloudSideBarController.getCurrentView();this.updateItem((e=>{e.fetching=!0,e.fetchLimit=n,e.queryError=null,r&&(e.selectedItems={}),i||(e.lastItemInfo=null)}),BE);let d=null;if(c===ME.b.MEDIA_TYPE?d=await this.getAllByTypeSizeOrDate(t,s,i,n,r):c===ME.b.CONVERSATION?d=await this.getAllConvByTypeSizeOrDate(e+"",t,s,i,n,r):c===ME.b.MY_CLOUD&&(d=await this.getAllConvByTypeSizeOrDate(Ce.default.sendToMeId+"",t,s,i,n,r)),Object(EE.b)("fetchAllCloudMedia | data from db: ",d),!d)return void this.updateItem((e=>{e.fetching=!1}),BE);let{result:u,identity:h}=d;if(!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),BE);if(this.setHasMoreFromQueryData(u,n),this.setLastItemFromQueryData(u),u=this.filterInvalidCloudItems(u),c!==ME.b.CONVERSATION&&(u=this.filterDuplicatedItems(u)),!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),BE);Object(Dy.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&_E.a.getInstance().updateExtMediaInfo(u),a.ModuleContainer.resolve(Dy.c).calculateZCloudStatusByCloudItems(u);const g=u.map((e=>CE.transfer(e)));this.setDisplayDataFromQueryData(g,r,h),-1==o?o=g.length:o+=g.length,null!==(l=this._getState())&&void 0!==l&&l.hasMore&&o<n?this.handleFetchMore(n,o):this.updateItem((e=>{e.fetching=!1}),BE)}catch(c){this.updateItem((e=>{e.fetching=!1,r&&(e.queryError=c)}),BE)}}forceGetCloudMedia(){const{currentFilter:e,fetchLimit:t}=this._getState(),s=this.zCloudConversationController.getCurrentSelectedConvId();if(!e||null===s||!t)return;const a=TE.a.getCurrentMappingQueryType(e);this.fetchAllCloudMedia(s,a,0,"",t,!0)}handleFetchMore(e,t=-1){const{currentFilter:s,lastItemInfo:a,hasMore:i,fetching:n}=this._getState(),r=TE.a.getCurrentMappingQueryType(s),o=this.zCloudConversationController.getCurrentSelectedConvId();Object(EE.b)("call fetch more... ",a),n&&-1===t||!a||!i||this.fetchAllCloudMedia(o,r,a.sizeOrDate,a.noiseId,e,!1,t)}isSelectedAll(){const{displayData:e,selectedItems:t}=this._getState();return Object.keys(t).length===(null==e?void 0:e.length)}handleSelectAll(){const{displayData:e,selectedItems:t}=this._getState();if(!e)return;const s=Object(I.a)({},t);e.forEach((e=>{const t=e.zCloudKey;s[t]||(s[t]=e)})),this.updateItem((e=>{e.selectedItems=s}),BE)}handleDeselectAll(){this.resetSelectedItem()}handleToggleSelectAll(){this.isSelectedAll()?this.handleDeselectAll():this.handleSelectAll()}handleSelectItem(e){const{selectedItems:t,currentFilter:s}=this._getState(),a=Object(I.a)({},t);let i;const n=e.zCloudKey;if(a[n])delete a[n],i=null,Object(Dy.b)().isEnableUserPCloud()&&RE.a.logClickUncheckItem({unselect_type:"single_unselect"});else{var r;if((null===(r=Object.keys(a))||void 0===r?void 0:r.length)>Ce.default.max_msg_per_del-1)return void Wo.default.createSuccess(le.a.trans("STR_MY_CLOUD_MAX_SELECTED_ITEMS",[Ce.default.max_msg_per_del.toString()]));if(a[n]=e,i=e,Object(Dy.b)().isEnableUserPCloud()){var o;const{extension:t}=Object(LE.b)((null==e||null===(o=e.extraInfo)||void 0===o?void 0:o.title)||""),a=this.zCloudSideBarController.getCurrentView();RE.a.logClickCheckItem({tab_filter:s,file_extension:t,file_size:e.size,source_tab:a})}}this.updateItem((e=>{e.selectedItems=a,e.lastClickSelectItem=i}),BE)}resetSelectedItem(){this.updateItem((e=>{e.selectedItems={}}),BE)}resetAllStates(){this.data.set(BE,this.getDefaultCloudState()),Object(Po.h)(this.name,BE)}isViewModeEnabled(){try{return UE.a.getInstance().isPaidUser()||UE.a.getInstance().isInGracePeriod()?this.config.key(AE).boolean:!(!UE.a.getInstance().isFree()&&!UE.a.getInstance().isAfterGracePeriod())&&this.config.key(FE).boolean}catch(e){return Object(EE.a)("daivd error when check view mode enabled: ",e),!1}}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||jE)||jE)||jE)||jE)||jE)||jE);var GE,xE=s("tP1L"),VE=s("9XoL"),HE=s("bO3J"),WE=s("cCVI"),qE=s("k+eZ"),KE=s("CBkG");const $E="1",ZE="zcloud-promo",QE={showPromoTooltip:!1,showPromoPopover:!1,showTip:!1,showEntry:!1};Object(a.injectable)()(GE=Object(a.singleton)(qE.b)(GE=Object(Ai.b)(qE.b)(GE=function(e,t){return Object(a.inject)(VE.b)(e,void 0,0)}(GE=function(e,t){return Object(a.inject)(WE.a)(e,void 0,1)}(GE=function(e,t){return Object(a.inject)(jo.SidebarController)(e,void 0,2)}(GE=Reflect.metadata("design:type",Function)(GE=Reflect.metadata("design:paramtypes",[void 0===VE.b?Object:VE.b,void 0===WE.a?Object:WE.a,void 0===jo.SidebarController?Object:jo.SidebarController])(GE=class extends Or.a{constructor(e,t,s){super(),this.eventsResolver=e,this.onboardEventsResolver=t,this.sidebarController=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=qE.a,this.key=qE.a,this.data.set($E,QE),this.blockOnboardingHandler=this.blockOnboardingHandler.bind(this),this.triggerOnboardingHandler=this.triggerOnboardingHandler.bind(this),this.pcDoneOnboardingHandler=this.pcDoneOnboardingHandler.bind(this),this.offPlanHandler=this.offPlanHandler.bind(this),this.upgradePlanHandler=this.upgradePlanHandler.bind(this),this.receiveKeyHandler=this.receiveKeyHandler.bind(this)}save(){n.default.getInstance().setItemForCurrentUser(ZE,JSON.stringify(this.getState()))}load(){let e=n.default.getInstance().getItemForCurrentUser(ZE);e&&this.data.set($E,JSON.parse(e))}getLocal(){let e=n.default.getInstance().getItemForCurrentUser(ZE);return e?JSON.parse(e):void 0}getState(e=$E){return this.data.get(e)}blockOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!1,e.showTip=!1}),$E),this.save()}triggerOnboardingHandler(e){if(Object(EE.a)("trigger onboarding event: ",e),e.type===HE.b.MOBILE_COMPLETED_BEFORE)this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),$E),this.save()}pcDoneOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!0,e.showTip=!1}),$E),this.save()}offPlanHandler(e){Object(EE.a)("off plan | current: FREE"),this.sidebarController.changeTab(jo.SidebarTab.MESSAGE_TAB),this.sidebarController.updateSelectedId(null),this.removeSubmitOnboaringDoneKey(),this.updateItem((e=>{e.showEntry=!1,e.showTip=!1,e.showPromoTooltip=Object(Dy.b)().isEnablePromoTooltip()&&UE.a.getInstance().isFree(),e.showPromoPopover=Object(Dy.b)().isEnablePromoPopover()&&UE.a.getInstance().isFree()}),$E),this.save()}upgradePlanHandler(e){Object(EE.a)("upgrade plan | current: PAID"),this.updateItem((e=>{e.showPromoTooltip=!1,e.showPromoPopover=!1}),$E),this.save()}receiveKeyHandler(e){}doesSubmitOnboardingDoneBefore(){return!!n.default.getInstance().getItemForCurrentUser("zcl_sm_ob")}setSubmitOnboardingDone(){n.default.getInstance().setItemForCurrentUser("zcl_sm_ob","true")}removeSubmitOnboaringDoneKey(){n.default.getInstance().removeItemForCurrentUser("zcl_sm_ob")}setShowPromoTooltip(e){this.updateItem((t=>{t.showPromoTooltip=e}),$E),this.save()}setShowPromoPopover(e){this.updateItem((t=>{t.showPromoPopover=e}),$E),this.save()}initPromoStates({showPromoTooltip:e,showPromoPopover:t}){this.updateItem((s=>{s.showPromoTooltip=e,s.showPromoPopover=t}),$E),this.save()}initShouldShowEntry(e){Object(EE.a)("init check zcloud user: ",e),this.updateItem((t=>{t.showEntry=e}),$E),this.save()}addListener(){this.onboardEventsResolver.addEventListener(HE.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.addEventListener(HE.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.addEventListener(KE.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.addEventListener(KE.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(KE.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(KE.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}removeListener(){this.onboardEventsResolver.removeEventListener(HE.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.removeEventListener(HE.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.removeEventListener(KE.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.removeEventListener(KE.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(KE.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(KE.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}onDoneOnboarding(){this.submitDoneOnboarding(),this.updateItem((e=>{e.showTip=!1}),$E),this.save()}async submitDoneOnboarding(){Object(EE.a)("submit done onboarding");try{if(this.doesSubmitOnboardingDoneBefore())return;await xE.a.submitOnboardingInfo(),this.setSubmitOnboardingDone()}catch(e){}}})||GE)||GE)||GE)||GE)||GE)||GE)||GE);var YE=s("NoK8"),JE=s("u/Xa"),XE=s("3/Az");class eO{static closeZCloudPhotoViewer(){a.ModuleContainer.resolve(JE.b).emit("CLOSE_VIEWER",{conversationId:"",openSource:XE.l.ZCloudManagementTool})}}const tO=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloudManagementTool,["PreviewUtils","daivd"]);class sO{static closePhotoAndFilePreview(){try{eO.closeZCloudPhotoViewer()}catch(e){tO.zsymb(18,"qabXRa","Error closing photo and file preview: ",e)}}}var aO;const iO="1",nO={currentView:null,pageStack:[]};Object(a.injectable)()(aO=Object(a.singleton)(YE.b)(aO=Object(Ai.b)(YE.b)(aO=Reflect.metadata("design:type",Function)(aO=Reflect.metadata("design:paramtypes",[])(aO=class extends Or.a{constructor(){super(),this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.lastMediaView=void 0,this.name=YE.a,this.key=YE.a,this.data.set(iO,nO),this.lastMediaView=null}_getState(e=iO){return this.data.get(e)}setInitView(e){this.updateItem((t=>{t.currentView=e}),iO)}changeView(e){null===e&&sO.closePhotoAndFilePreview(),this.updateItem((t=>{t.currentView=e}),iO),e!==ME.b.SETTING&&(this.lastMediaView=e)}closeSetting(){this.changeView(this.lastMediaView||ME.b.MEDIA_TYPE)}getCurrentView(){const{currentView:e}=this._getState();return e}getPageStack(){const{pageStack:e}=this._getState();return e}pushPageStack(e){const{pageStack:t}=this._getState();this.updateItem((s=>{s.pageStack=[...t,e]}),iO)}setPageStack(e){e&&Array.isArray(e)&&this.updateItem((t=>{t.pageStack=e}),iO)}popPageStack(){const{pageStack:e}=this._getState(),t=[...e];t.pop(),this.updateItem((e=>{e.pageStack=t}),iO)}})||aO)||aO)||aO)||aO);s("umN7");var rO=s("5y3u");a.ModuleContainer.registerSingleton(rO.a,rO.b);var oO=s("iyDo"),lO=s("UDME"),cO=s("A9no"),dO=s("bKXo"),uO=s("tIXy");var hO=class{constructor(){this.data=void 0,this.data=new Map}startCapture(e,t={}){this.data.set(e,{start:Ct.default.getTimeNow(),end:null,params:t})}finishCapture(e,t={}){const s=this.data.get(e);if(s){const a=Object(I.a)(Object(I.a)({},s),{},{end:Ct.default.getTimeNow(),params:Object(Av.a)(s.params,t)});return this.data.set(e,a),a}return s}getItem(e){return this.data.get(e)}clearItem(e){this.data.delete(e)}};let gO=function(e){return e[e.NORMAL=0]="NORMAL",e[e.SILENTLY=1]="SILENTLY",e[e.BLOCKING=2]="BLOCKING",e[e.SILENTLY_BLOCKING=3]="SILENTLY_BLOCKING",e}({}),mO=function(e){return e[e.OFF=0]="OFF",e[e.ON=1]="ON",e}({}),pO=function(e){return e[e.MEMBER=0]="MEMBER",e[e.OWNER=1]="OWNER",e[e.ADMIN=2]="ADMIN",e}({}),fO=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),vO=function(e){return e[e.MANUAL=0]="MANUAL",e[e.DEFAULT=1]="DEFAULT",e[e.NOT_SILENTLY=-1]="NOT_SILENTLY",e}({}),_O=function(e){return e[e.LEAVE_GROUP=1]="LEAVE_GROUP",e[e.CHANGE_HIDE_MEMBER_SETTING=1]="CHANGE_HIDE_MEMBER_SETTING",e[e.CLICK_GROUP_LINK=1]="CLICK_GROUP_LINK",e[e.UPGRADE_COMMUNITY=1]="UPGRADE_COMMUNITY",e[e.VERIFY_ACCOUNT=2]="VERIFY_ACCOUNT",e[e.CLICK_LEARN_MORE=3]="CLICK_LEARN_MORE",e[e.ENTER_UPGRADE_FLOW=4]="ENTER_UPGRADE_FLOW",e[e.ENTER_KYC_FLOW=5]="ENTER_KYC_FLOW",e[e.ACTION_KYC_FLOW=6]="ACTION_KYC_FLOW",e[e.AFTER_ACTION_KYC_FLOW=7]="AFTER_ACTION_KYC_FLOW",e[e.PREVENT_UPGRADE_FLOW=8]="PREVENT_UPGRADE_FLOW",e[e.ACTION_ZBIZ_REGISTER=9]="ACTION_ZBIZ_REGISTER",e}({});a.ModuleContainer.registerSingleton(oO.a,class{constructor(){this.upgradeCommunityCapture=void 0,this.verificationCapture=void 0,this.upgradeCommunityCapture=new hO,this.verificationCapture=new hO}logAction999(e){const{type:t,payload:s,noisedIds:a}=e;let i;switch(t){case"LEAVE_GROUP":i=_O.LEAVE_GROUP,Ia.default.logActionInfoV2(Ia.FeaturesInfo.LeaveGroupSilently,i,s,a);break;case"CHANGE_HIDE_MEMBER_SETTING":i=_O.CHANGE_HIDE_MEMBER_SETTING,Ia.default.logActionInfoV2(Ia.FeaturesInfo.HideMemberPresence,i,s,a);break;case"CLICK_GROUP_LINK":i=_O.CLICK_GROUP_LINK,Ia.default.logActionInfoV2(Ia.FeaturesInfo.ClickGroupLink,i,s,a);break;case"UPGRADE_COMMUNITY":i=_O.UPGRADE_COMMUNITY,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"VERIFY_ACCOUNT":i=_O.VERIFY_ACCOUNT,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"CLICK_LEARN_MORE":i=_O.CLICK_LEARN_MORE,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ENTER_KYC_FLOW":i=_O.ENTER_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ENTER_UPGRADE_FLOW":i=_O.ENTER_UPGRADE_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ACTION_KYC_FLOW":i=_O.ACTION_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"AFTER_ACTION_KYC_FLOW":i=_O.AFTER_ACTION_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"PREVENT_UPGRADE_FLOW":i=_O.PREVENT_UPGRADE_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ACTION_ZBIZ_REGISTER":i=_O.ACTION_ZBIZ_REGISTER,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a)}}getChatTypeFromConvId(e){return ui.default.isGroup(e)?fO.CHAT_GROUP:Yy.a.isSendToMe(e)?fO.MY_CLOUD:fO.CHAT_11}getMemberRole(e,t){return lO.GroupSettingHelper.isOwner(e,t)?pO.OWNER:lO.GroupSettingHelper.isAdmin(e,t)?pO.ADMIN:pO.MEMBER}isDefaultLeaveSilently(e){return!(!Ce.default.group_privacy.hide_member.enable||!lO.GroupSettingHelper.isLockViewMember(e))||!(!Ce.default.group_privacy.leave_group_silently.enable||!cO.isCommunity(e))}getLeaveGroupSilentlyType(e,t){return this.isDefaultLeaveSilently(e)?vO.DEFAULT:"SILENTLY"===t?vO.MANUAL:vO.NOT_SILENTLY}changeHideMemberSettingReport(e){const t=ui.default.getGroupIdFromConversationId(e.groupId),s=Ii.default.getUidMe();this.logAction999({type:"CHANGE_HIDE_MEMBER_SETTING",payload:{mode:e.value?mO.ON:mO.OFF,des_id:t,src_id:s},noisedIds:[t,s]})}clickGroupLinkReport(e){const t=ui.default.getGroupIdFromConversationId(e.groupId),s=Ii.default.getUidMe();this.logAction999({type:"CLICK_GROUP_LINK",payload:{chat_type:e.conversationId?this.getChatTypeFromConvId(e.conversationId):null,src_id:s,des_id:t,lobby_version:Ce.default.group_privacy.hide_member.enable?1:0},noisedIds:[s,t]})}leaveGroupReport(e){let t=e.groupId;t.startsWith(Y.GROUPID_PREFIX)||(t=Y.GROUPID_PREFIX+t);const s=ui.default.getGroupIdFromConversationId(e.groupId),i=Ii.default.getUidMe(),n=this.getMemberRole(t,i);this.logAction999({type:"LEAVE_GROUP",payload:{des_id:s,src_id:i,user_role:n,status:this.isDefaultLeaveSilently(t)?gO.SILENTLY:gO[e.leaveType],silent_default:this.getLeaveGroupSilentlyType(t,e.leaveType)},noisedIds:[s,i]}),a.ModuleContainer.resolve(dO.b).onLeaveGroup({groupId:t,actorId:i,memberId:i,leaveType:e.leaveType,memberRole:n})}openPreventUpgradeCommunityReport(e){const{groupId:t,entryPoint:s,currentPkgId:a,errorCode:i}=e,n=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"PREVENT_UPGRADE_FLOW",payload:{des_id:n,entrypoint:s,error_code:i,user_type:a},noisedIds:[n]})}openPopupUpgradeCommunityReport(e){const{groupId:t,entryPoint:s}=e;this.upgradeCommunityCapture.startCapture(t,{entryPoint:s})}getVerificationStatusLogNumber(e){switch(e){case uO.b.NEED_VERIFY:return 0;case uO.b.VERIFIED:return 1;default:return 3}}actionBusinessRegistrationReport(e){const{groupId:t,pkgId:s,action:a}=e,i=this.upgradeCommunityCapture.finishCapture(t);if(!i)return;const n=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"ACTION_ZBIZ_REGISTER",payload:"close"===a?{des_id:n,action:a,entrypoint:i.params.entryPoint}:{des_id:n,action:a,register_package:s,entrypoint:i.params.entryPoint},noisedIds:[n]})}closePopupUpgradeCommunityReport(e){const{groupId:t,verificationStatus:s,upgradeStatus:a,errorCode:i,currentPkgId:n}=e,r=this.upgradeCommunityCapture.finishCapture(t);if(!r)return;const o=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"UPGRADE_COMMUNITY",payload:{des_id:o,upgrade_status:a,fail_error:i,duration:r.end-r.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:r.params.entryPoint,action:i?"confirm_upgrade":"close",user_type:n},noisedIds:[o]}),this.upgradeCommunityCapture.clearItem(t)}openPopupVerificationReport(e){const{groupId:t,entryPoint:s}=e;this.verificationCapture.startCapture(t,{entryPoint:s})}actionPopupVerificationReport(e){const{groupId:t,action:s,currentPkgId:a,totalMember:i,isAfterAction:n}=e,r=this.verificationCapture.getItem(t);if(!r)return;const o=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:n?"AFTER_ACTION_KYC_FLOW":"ACTION_KYC_FLOW",payload:{des_id:o,action:s,entrypoint:r.params.entryPoint,member_size:i,user_type:a},noisedIds:[o]})}closePopupVerificationReport(e){const{groupId:t,verificationStatus:s,action:a,currentPkgId:i}=e,n=this.verificationCapture.finishCapture(t);if(!n)return;const r=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"VERIFY_ACCOUNT",payload:{des_id:r,duration:n.end-n.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:n.params.entryPoint,action:a||"close",user_type:i},noisedIds:[r]}),this.verificationCapture.clearItem(t)}clickCommunityLearnMoreReport(e){const{groupId:t,entryPoint:s,currentPkgId:a}=e,i=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"CLICK_LEARN_MORE",payload:{des_id:i,entrypoint:s,user_type:a},noisedIds:[i]})}mapGroupEntryToCommunity(e){switch(e){case"gr_add_member":return"comm_add_member";case"gr_member_approval":return"comm_member_approval";case"message_info":return"msg_info";default:return e}}openPreventAddMemberReport(e){const{entryPoint:t,groupId:s,type:a,currentPkgId:i,totalMember:n}=e,r=ui.default.getGroupIdFromConversationId(s);this.logAction999({type:"need_kyc"===a?"ENTER_KYC_FLOW":"ENTER_UPGRADE_FLOW",payload:{des_id:r,entrypoint:this.mapGroupEntryToCommunity(t),user_type:i,member_size:n},noisedIds:[r]})}});var bO=s("sEfC"),IO=s.n(bO);var yO,SO=class{constructor(e){this.key=void 0,this._data=void 0,this.key=e}get data(){if(!this._data){const e=n.default.getInstance().getItemForCurrentUser(this.key);let t=[];if(null!==e){try{t=JSON.parse(e)}catch{t=[]}Array.isArray(t)||(t=[])}this._data=new Set(t)}return this._data}addItem(e){this.data.has(e)||(this.data.add(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}removeItem(e){this.data.has(e)&&(this.data.delete(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}clear(){this.data.clear(),n.default.getInstance().removeItemForCurrentUser(this.key)}hasItem(e){return this.data.has(e)}},CO=s("+jN4"),EO=s("Ei7k");Object(a.injectable)()(yO=Object(m.j)()(yO=Object(m.h)()(yO=Object(Ai.b)(Dl.e)(yO=function(e,t){return Object(a.inject)(Dl.h)(e,void 0,0)}(yO=Reflect.metadata("design:type",Function)(yO=Reflect.metadata("design:paramtypes",[void 0===Dl.h?Object:Dl.h])(yO=class{constructor(e){this.onboardController=e,this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.verification=void 0,this.hiddenChatBoxBannerGroups=void 0,this.handleUpdateDataItemImmediately=({groupId:e})=>{const t={groupId:e,bannerStatus:this.getBannerStatusForItem(e)};this.data.set(e,t),this.signalUpdateItem(e)},this.handleUpdateDataItem=IO()(this.handleUpdateDataItemImmediately,300,{leading:!1,trailing:!0}),this.handleUsagedGroupInfoChange=({groupId:e},t)=>{if(!t&&!lO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe()))return;const s=K.default.isOpenChildWindowByConvId(e),i=e==a.ModuleContainer.resolve(jo.SidebarController).getCurrMainConvId();(s||i)&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItem({groupId:e})})),this.verification.loaded=!0):this.handleUpdateDataItem({groupId:e}))},this.handleChangeOwnnerEvent=({groupId:e,ownerId:t})=>{(t==Ii.default.getUidMe()||this.data.has(e))&&this.handleUsagedGroupInfoChange({groupId:e},!0)},this.handleMultiGroupInfoChange=e=>{for(const t of e)this.handleUsagedGroupInfoChange({groupId:t})},this.handleProfileVerificationChange=e=>{this.verification={loaded:!0,status:e};const t=[];this.data.forEach((e=>{t.push([e.groupId,Object(I.a)(Object(I.a)({},e),{},{bannerStatus:this.getBannerStatusForItem(e.groupId)})])})),this.data=new Map(t),this.signalUpdateAllItems()},this.handleLeaveGroupEvent=e=>{for(const t of e)this.data.delete(t),this.hiddenChatBoxBannerGroups.removeItem(t)},this.name=Dl.a,this.key="groupId",this.data=new Map,this.verification={loaded:!1,status:null},this.hiddenChatBoxBannerGroups=new SO(Dl.c)}init(){throw new Error("Method not implemented.")}onStart(){hn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),hn.default.subscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),hn.default.subscribeEventGroup(Y.EventGroup.CHANGE_OWNER,this.handleChangeOwnnerEvent),hn.default.subscribeEventGroup(Y.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),hn.default.subscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Ii.default.subscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){hn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),hn.default.unsubscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),hn.default.unsubscribeEventGroup(Y.EventGroup.CHANGE_OWNER,this.handleUsagedGroupInfoChange),hn.default.unsubscribeEventGroup(Y.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),hn.default.unsubscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Ii.default.unsubscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(Po.h)(this.name,e)}signalUpdateAllItems(){this.data.forEach((e=>{this.signalUpdateItem(e.groupId)}))}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.community,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"HRYOIj","Get community data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"rp6dRx","Get community data list failed",e)}getOwnedCommunities(){const e=hn.default.getGroupsListSync(),t=Ii.default.getUidMe(),s=[];for(const a of e)a.creatorId===t&&Dl.q.isCommunityFromInfo(a)&&s.push(a);return s}getJoinedCommunities(){const e=hn.default.getGroupsListSync(),t=[];for(const s of e)Dl.q.isCommunityFromInfo(s)&&t.push(s);return t}getProfileVerificationStatus(){return this.verification.status}getBannerStatusForItem(e){if(null===this.verification.status)return{show:!1};const t=hn.default.getGroupByIdSync(e);if("number"!=typeof(null==t?void 0:t.totalMember)||t.creatorId!=Ii.default.getUidMe())return{show:!1};const s=Dl.q.isCommunityFromInfo(t);let a,i=!1;const n=new Set([Dl.f.CHAT_BOX,Dl.f.RIGHT_BAR]);return this.verification.status===uO.b.VERIFIED?(i=!s&&t.totalMember>=Ce.default.group_privacy.community.grouptype_threshold,a=Dl.g.REACHED_UPGRADE):(i=s||t.totalMember>=Ce.default.group_privacy.community.minimum_warn_upgrade,a=s?Dl.g.UPGRADED_VERIFY:t.totalMember>=Ce.default.group_privacy.community.grouptype_threshold?Dl.g.REACHED_VERIFY:Dl.g.NEARLY_REACH_VERIFY),this.hiddenChatBoxBannerGroups.hasItem(e)&&n.delete(Dl.f.CHAT_BOX),{show:i,type:a,position:n}}getAccountVerificationStatus(e){Ii.default.getVerificationStatusMe().then((t=>{this.verification.status=t,null==e||e(t)})).catch((e=>{this.Logger.zsymb(18,"nnmJWi","Get account verification status failed",e)}))}upgradeToCommunity(e){return new Promise(((t,s)=>{Cl.default.upgradeGroupToCommunity(e).then((()=>{this.Logger.zsymb(18,"NdGhjs","Upgrade community succeed",e),t()})).catch((t=>{this.Logger.zsymb(18,"ZEbLJy","Upgrade community failed",e,t),s(t)}))}))}shouldLoadVerificationStatus(e){if(this.verification.loaded&&this.verification.status===uO.b.VERIFIED)return!1;const t=hn.default.getGroupByIdSync(e);return"number"==typeof(null==t?void 0:t.totalMember)&&(Dl.q.isCommunityFromInfo(t)||t.totalMember>=Ce.default.group_privacy.community.minimum_warn_upgrade)}onConversationDidOpen(e){this.onboardController.onConversationDidOpen(e),yd.a.isGroup(e)&&lO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe())&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItemImmediately({groupId:e})})),this.verification.loaded=!0):this.data.has(e)||this.handleUpdateDataItemImmediately({groupId:e}))}onReceivedCommunityError({groupId:e,errorCode:t,windowId:s,src:i}){const n=lO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe());switch(t){case Y.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:n?(CO.b(s,e,i),i&&a.ModuleContainer.resolve(Dl.p).openPreventAddMemberReport({groupId:e,type:"need_kyc",entryPoint:i,currentPkgId:Ii.default.getPkgIdCurrent(),totalMember:hn.default.getTotalMember(e)})):Ie.ModalManagerV2.openModal({windowId:s,name:Y.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:i}});break;case Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:Ie.ModalManagerV2.openModal({windowId:s,name:Y.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:i}}),i&&n&&a.ModuleContainer.resolve(Dl.p).openPreventAddMemberReport({groupId:e,type:"need_upgrade",entryPoint:i,currentPkgId:Ii.default.getPkgIdCurrent(),totalMember:hn.default.getTotalMember(e)})}}closeChatBoxBanner(e){this.hiddenChatBoxBannerGroups.addItem(e),this.handleUpdateDataItemImmediately({groupId:e})}async checkCommunityQuota(e){const t=await Cl.default.getQuotaCommunity(e);if(t&&t.canUpgr)return!0;throw{data:t}}async checkUpgradeCondition(e){const t=Ce.default.group_privacy.community_zbiz.base_pkg;if(!Ii.default.isMeBAAccount()){const s=this.getOwnedCommunities(),a=EO.a.getQuotaCommunity(t);return!(s.length>=a)||this.checkCommunityQuota(e)}return this.checkCommunityQuota(e)}async checkCommunityMemberQuota(e,t){try{const s=await Cl.default.checkQuotaCommunityMember(e,t);this.Logger.zsymb(0,"kyP1dO","check member quota ok",e,t,s);const a={isQualified:s.canUpgr,content:s.content};if(s.canUpgr||s.othersCanUpgr)return a;throw{data:a}}catch(s){throw this.Logger.zsymb(18,"ODVKpz","check member quota fail",e,t,s),s}}async checkCreateCondition(e){const t=Ii.default.getPkgIdCurrent();if(e===Dl.n.COMMUNITY){const e=EO.a.getQuotaCommunity(t),s=this.getOwnedCommunities().length;if(s>=e)throw{error_code:Y.GROUP_APPOINTMENT_ERROR.REACHED_LIMIT_OWNED_COMMUNITY,data:{error_message_localize:Dl.q.getReachedQuotaErrorMessageLocalize(e,s)}};return!0}const s=EO.a.getQuotaGroup(t);if(hn.default.getGroupsListSync().length>=s)throw{error_code:Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_GROUP,data:{error_message_localize:le.a.trans("STR_GROUP_PRIVACY_CANNOT_CREATE_GROUP_COMMUNITY_LIMIT",[String(s)])}};return!0}})||yO)||yO)||yO)||yO)||yO)||yO);var OO,MO=s("7Ull");Object(m.j)()(OO=Object(m.h)()(OO=Object(a.singleton)(Dl.h)(OO=Reflect.metadata("design:type",Function)(OO=Reflect.metadata("design:paramtypes",[])(OO=class{constructor(){this.onboardedGroups=void 0,this.lastOnboardedGroupId=void 0,this.onboardingCounter=void 0,this.status=void 0,this.emitter=void 0,this.recentUpgradedGroups=void 0,this.closeOnboard=e=>{this.status[e]&&(this.status=Object(I.a)(Object(I.a)({},this.status),{},{[e]:!1}),this.emitter.emit("change",this.status))},this.isCanShowOnboard=e=>{const t=this.onboardingCounter.getItem(e);return"number"!=typeof t||t<Ce.default.group_privacy.community.max_onboard_times},this.handleGroupUpgradeEvent=({groupId:e})=>{this.recentUpgradedGroups.add(e);const t=K.default.isOpenChildWindowByConvId(e),s=e==a.ModuleContainer.resolve(jo.SidebarController).getCurrMainConvId();Ce.default.group_privacy.community.enable_ui&&(t||s)&&(lO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe())?(this.status=Object(I.a)(Object(I.a)({},this.status),{},{popup:!0,tip:!1}),this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Dl.i.POPUP)):this.isCanShowOnboard(Dl.i.TIP)&&(this.status=Object(I.a)(Object(I.a)({},this.status),{},{tip:!0,popup:!1}),this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),Ce.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Dl.i.TIP)))},this.handleLeaveGroupEvent=e=>{for(const t of e)this.recentUpgradedGroups.delete(t)},this.handleOpenChildWindow=({windowId:e})=>{const t=K.default.getConvIdFromWindowId(e);this.onConversationDidOpen(t)},this.onboardedGroups=new Set,this.lastOnboardedGroupId=null,this.onboardingCounter=new MO.a(Dl.d),this.status={tip:!1,popup:!1},this.recentUpgradedGroups=new Set,this.emitter=new qm.a}onStart(){hn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),hn.default.subscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),K.default.subscribe(hr.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow)}onDispose(){hn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),hn.default.unsubscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),K.default.unsubscribe(hr.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow),this.recentUpgradedGroups.clear()}getStatus(){return this.status}hasOnboardedGroupId(e){return this.onboardedGroups.has(e)}getLastOnboardedGroupId(){return this.lastOnboardedGroupId}isDoneOnboard(){return!Object.values(Dl.i).some(this.isCanShowOnboard)}getStatusForGroup(e){return this.recentUpgradedGroups.has(e)?{tip:!1,popup:this.isCanShowOnboard(Dl.i.POPUP)}:{tip:this.isCanShowOnboard(Dl.i.TIP),popup:!1}}onConversationDidOpen(e){Ce.default.group_privacy.community.enable_ui&&yd.a.isGroup(e)&&Dl.q.isCommunity(e)&&!this.onboardedGroups.has(e)&&(this.status=this.getStatusForGroup(e),this.status.tip&&(this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),Ce.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Dl.i.TIP)),this.status.popup&&(this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Dl.i.POPUP)))}onDoneNewOnboardingLevel(e,t){if(this.isDoneOnboard())return;this.lastOnboardedGroupId=e,e&&this.onboardedGroups.add(e);let s=this.onboardingCounter.getItem(t);"number"!=typeof s&&(s=0),this.onboardingCounter.setItem(t,s+1)}resetOnboardFlagFromLocal(){this.lastOnboardedGroupId=null,this.onboardedGroups.clear(),this.onboardingCounter.clear()}})||OO)||OO)||OO)||OO);var TO,wO=s("eCBG");Object(m.h)()(TO=Object(m.j)()(TO=Object(a.singleton)(Dl.o)(TO=Reflect.metadata("design:type",Function)(TO=Reflect.metadata("design:paramtypes",[])(TO=class extends hs.b{constructor(){super(),this.cachedGroupOwnerInfo=void 0,this.logger=void 0,this.onOpenConvChildWindow=e=>{const t=K.default.getConvIdFromWindowId(e);this.onOpenConversation(t)},this.cachedGroupOwnerInfo=new Set}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.community,[Dl.k])),this.logger}handlePreloadOwnerInfo(e){const t=hn.default.getMiniInfoGroup(e);null!=t&&t.creatorId&&!this.cachedGroupOwnerInfo.has(e)&&a.ModuleContainer.resolve(wO.PersonalController).getUserInfo(t.creatorId).then((t=>{this.cachedGroupOwnerInfo.add(e),this.dispatchEvent(new Dl.m("done-preload-owner-info",e,{info:t}))})).catch((e=>{this.Logger.zsymb(18,"NqEwgP","Load owner info fail",t,e)}))}onStart(){K.default.subscribe(hr.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow)}onDispose(){K.default.unsubscribe(hr.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow),this.cachedGroupOwnerInfo.clear()}onOpenConversation(e){ui.default.isGroup(e)&&Ce.default.group_privacy.group_created_by_oa&&this.handlePreloadOwnerInfo(e)}getMiniGroupInfo(e){return hn.default.getMiniInfoGroup(e)}})||TO)||TO)||TO)||TO);const RO=["groupId","memberId","actorId"],LO=["groupId","memberId","actorId"];var DO;Object(a.singleton)(Dl.l)(DO=Reflect.metadata("design:type",Function)(DO=Reflect.metadata("design:paramtypes",[])(DO=class{constructor(){this.name=void 0,this.logger=void 0,this.name=Dl.j}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.group,[this.name])),this.logger}onAppointAdmin(e){const{groupId:t,memberId:s,actorId:a}=e;this.Logger.zsymb(0,"n-zSAu",`add admin group=${t} mem=${s} actor=${a}`)}onRemoveAdmin(e){const{groupId:t,memberId:s,actorId:a}=e;this.Logger.zsymb(0,"bID0VI",`remove admin group=${t} mem=${s} actor=${a}`)}onLeaveGroup(e){const{groupId:t,memberId:s,actorId:a}=e,i=Object(zi.a)(e,RO);this.Logger.zsymb(0,"A6hcKZ",`leave group=${t} mem=${s} actor=${a}`,i)}onRemoveMember(e){const{groupId:t,memberId:s,actorId:a}=e,i=Object(zi.a)(e,LO);this.Logger.zsymb(0,"2rfMOo",`kickout group=${t} mem=${s} actor=${a}`,i)}})||DO)||DO);var AO=s("P+Nn");let FO=function(e){return e[e.SEND_FSS=4]="SEND_FSS",e[e.SEND_CARD=5]="SEND_CARD",e}({}),kO=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({});var NO=s("nmtd");a.ModuleContainer.registerSingleton(AO.a,class{logAction999(e){const{type:t,payload:s,noisedIds:a}=e;switch(t){case NO.a.CARD:Ia.default.logActionInfoV2(Ia.FeaturesInfo.SendFSS,FO.SEND_CARD,s,a);break;case NO.a.STICKER:Ia.default.logActionInfoV2(Ia.FeaturesInfo.SendFSS,FO.SEND_FSS,s,a)}}getChatTypeFromConvId(e){return ui.default.isGroup(e)?kO.CHAT_GROUP:Yy.a.isSendToMe(e)?kO.MY_CLOUD:kO.CHAT_11}getRawDestinationId(e,t){return t===kO.CHAT_GROUP?ui.default.getGroupIdFromConversationId(e):e}sendCardReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),a=Ii.default.getUidMe();this.logAction999({type:NO.a.CARD,payload:{src_id:a,des_id:s,chat_type:t,group_id:t===kO.CHAT_GROUP?s:null,ecard:{background_id:e.backgroundId,char_count:e.charCount,list_title_id:e.listTitleId,tagline_id:e.taglineId}},noisedIds:[a,s]})}sendFSSReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),a=Ii.default.getUidMe();this.logAction999({type:NO.a.STICKER,payload:{src_id:a,des_id:s,chat_type:t,cate_id:e.categoryId,sticker_id:e.stickerId,group_id:t===kO.CHAT_GROUP?s:null},noisedIds:[a,s]})}});var PO=s("dgg9"),jO=s("MjbT");class UO{constructor(){this.didChangeBusinessInfo=e=>{if(e&&e.bizInfo){const t=e.bizInfo.pkgId,s=a.ModuleContainer.resolve(PO.f);s.getBannerPositions().forEach((e=>{var a;const i=s.getBannerAtPosition(e);i&&i.type===PO.a.BUSINESS&&null!==(a=i.targetPkgIds)&&void 0!==a&&a.includes(t)&&s.closeBannerAtPosition(e)}))}}}onStart(){Ii.default.subscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),Ii.default.subscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}onDispose(){Ii.default.unsubscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),Ii.default.unsubscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}allowAddBannerAtPosition(e,t){if(e.type===PO.a.BUSINESS){var s;const t=Ii.default.getPkgInfo(Ii.default.getUidMe());if(t&&null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t.pkgId))return"number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0&&"number"==typeof t.expired&&t.expired-Ct.default.getTimeNow()<=e.targetPkgRenewThreshold}return!0}}var BO,zO=s("ABlC");class GO{constructor(){this.didChangeZCloudPlan=e=>{const t=a.ModuleContainer.resolve(PO.f);t.getBannerPositions().forEach((s=>{var a;const i=t.getBannerAtPosition(s);i&&i.type===PO.a.ZCLOUD&&null!==(a=i.targetPkgIds)&&void 0!==a&&a.includes(e)&&t.closeBannerAtPosition(s)}))}}onStart(){_E.a.getInstance().addListener(IE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}onDispose(){_E.a.getInstance().removeListener(IE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}allowAddBannerAtPosition(e,t){if(e.type===PO.a.ZCLOUD){var s;const t=UE.a.getInstance().plan;if(null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t)){if("number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0){var a,i;const t=null===(a=zO.a.getInstance().getCloudInfo())||void 0===a||null===(i=a.subscription_info)||void 0===i?void 0:i.expire_time;if("number"==typeof t&&t-Ct.default.getTimeNow()<=e.targetPkgRenewThreshold)return!0}return!1}}return!0}}Object(m.d)()(BO=Object(m.j)()(BO=Object(m.h)()(BO=Object(a.singleton)(PO.f)(BO=Reflect.metadata("design:type",Function)(BO=Reflect.metadata("design:paramtypes",[])(BO=class{constructor(){this.logger=void 0,this.cacheBanners=void 0,this.hiddenBanners=void 0,this.repushedTimeCache=void 0,this.repushTimeout=void 0,this.businessManager=void 0,this.zcloudManager=void 0,this.isAppReady=void 0,this.businessManager=new UO,this.zcloudManager=new GO,this.cacheBanners=new Map,this.hiddenBanners=new MO.a(PO.j),this.repushedTimeCache=new MO.a(PO.k),this.repushTimeout=new Map}onStart(){this.businessManager.onStart(),this.zcloudManager.onStart()}onApplicationReady(){this.isAppReady=!0}onDispose(){this.businessManager.onDispose(),this.zcloudManager.onDispose()}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(es.ZLoggerNametags.operationBanner)),this.logger}allowAddBannerAtPosition(e,t){switch(e.type){case PO.a.BUSINESS:return this.businessManager.allowAddBannerAtPosition(e,t);case PO.a.ZCLOUD:return this.zcloudManager.allowAddBannerAtPosition(e,t);default:return!0}}checkForRepushingBannerItem(e){const t=this.cacheBanners.get(e);if(t&&t.max_repush&&jO.a._isValidEventData(t)){this.Logger.zsymb(0,"iaLO7m","check repush hidden",e);let s=this.repushedTimeCache.getItem(e)||0;const a=this.hiddenBanners.getItem(e),i=t.delay_time_repush||0;if(a&&i>0&&s<t.max_repush){const n=a+i-Ct.default.getTimeNow();this.Logger.zsymb(0,"N3VKCz",`do repush ${e} remaining_time=${n}`),n<=0?(s+=1,this.repushedTimeCache.setItem(e,s),this.hiddenBanners.removeItem(e),this.showBannerAtPosition(t,t.displayPosition)):this.repushTimeout.set(t.displayPosition,window.setTimeout((()=>this.checkForRepushingBannerItem(e)),n))}else this.Logger.zsymb(0,"b34561",`not allow repush ${e}`,`delay=${i}`,`repushed=${s} max_repush=${t.max_repush}`)}}checkForRepushing(){this.hiddenBanners.keys().forEach((e=>{this.checkForRepushingBannerItem(e)}))}bannerWillProcess(){this.cacheBanners.clear(),this.repushTimeout.forEach((e=>{window.clearTimeout(e)})),this.repushTimeout.clear()}bannerDidProcess(e){this.isAppReady?setTimeout((()=>{e.forEach(this.showBannerAtPosition.bind(this)),this.checkForRepushing()}),200):a.ModuleContainer.resolve(m.a).addEventListenerOnce(m.b.ServicesReady,(()=>{this.isAppReady=!0,this.bannerDidProcess(e)}))}comparePriority(e,t){if(!t)return!0;const s=e.priority||0,a=t.priority||0;return s>a||!(s<a)&&e.startTimeInMillis>=t.startTimeInMillis}addPrioritizedBannerToMap(e,t,s){const a=this.getGlobalBannerId(t);return!(n.default.getInstance().getItemForCurrentUser(a)||this.hiddenBanners.hasItem(a))&&this.allowAddBannerAtPosition(t,e)&&this.comparePriority(t,s.get(e))?s.set(e,t):s}getGlobalBannerId(e){let t=e.displayPosition+"_"+e.id;return e.actionContent&&e.actionContent.version&&(t=t+"_"+e.actionContent.version),t}processBannerFromServerInfo(e){this.bannerWillProcess();const t=new Map;if(!e||"object"!=typeof e)return this.bannerDidProcess(t),this.Logger.zsymb(0,"F_jvJ6","invalid data banner!",e),t;for(const s in e)if(Array.isArray(e[s]))for(let a=0;a<e[s].length;a++){const i=e[s][a];if(!i)continue;try{i.actionContent=JSON.parse(i.actionContent)}catch{}if(!jO.a._isValidEventData(i))continue;const n=this.getGlobalBannerId(i);if(i.displayPosition===Y.BANNER_POS_CSC_HEADER||i.displayPosition===Y.BANNER_POS_EMPTY_SCREEN){const e=i.displayPosition===Y.BANNER_POS_CSC_HEADER?i.actionContent.topBanners:i.actionContent.emptyBanners;if(e){const s=[];for(let t=0;t<e.length;t++){const a=e[t];!a||a.condition&&!ui.default.userMeetConditions(jO.a._fnCallbackTmp?jO.a._fnCallbackTmp():jO.a._getUserData(),a.condition)||s.push(a)}if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];this.addPrioritizedBannerToMap(i.displayPosition,e,t),this.cacheBanners.set(n,e)}}}else this.addPrioritizedBannerToMap(i.displayPosition,i,t),this.cacheBanners.set(n,i)}return this.bannerDidProcess(t),t}getBannerAtPosition(e){switch(e){case Y.BANNER_POS_TAB_MSG_HEADER:return Ce.default.messageBanner;case Y.SIDEBAR_TOP_AVATAR:return Ce.default.santa_hat;case Y.SIDEBAR_LEFT_MENU:return Ce.default.leftMenu;case Y.BANNER_POS_CSC_HEADER:return Ce.default.topBanner;case Y.BANNER_POS_EMPTY_SCREEN:return Ce.default.emptyBanner;default:return null}}getBannerPositions(){return[Y.BANNER_POS_TAB_MSG_HEADER,Y.SIDEBAR_TOP_AVATAR,Y.SIDEBAR_LEFT_MENU,Y.BANNER_POS_CSC_HEADER,Y.BANNER_POS_EMPTY_SCREEN]}closeBannerAtPosition(e){const t=this.getBannerAtPosition(e);if(t){const s=this.getGlobalBannerId(t);this.hiddenBanners.setItem(s,Ct.default.getTimeNow()),jO.a._setBannerAtPosition(null,e);const i=t.delay_time_repush||0;return e===Y.BANNER_POS_TAB_MSG_HEADER&&a.ModuleContainer.resolve(jo.ConvListController).rerenderList(),i>0&&this.repushTimeout.set(e,window.setTimeout((()=>this.checkForRepushingBannerItem(s)),i)),this.Logger.zsymb(0,"hTfPy9","closed banner",s,e,`delay repush=${i}`),!0}return!1}showBannerAtPosition(e,t){if(this.Logger.zsymb(0,"Z0omoO","request show banner",e.id,t),this.allowAddBannerAtPosition(e,t)){const s=this.getBannerAtPosition(t);if(this.comparePriority(e,s))return jO.a._setBannerAtPosition(e,t),t===Y.BANNER_POS_TAB_MSG_HEADER&&a.ModuleContainer.resolve(jo.ConvListController).rerenderList(),this.Logger.zsymb(0,"QEe9fF","done show banner",e.id),!0}return!1}})||BO)||BO)||BO)||BO)||BO);var xO=s("yQd5");const VO=`${xO.b}-network-manager`;var HO=Object(a.define)(VO),WO=s("DPHK");var qO=class{constructor(){}updateMyAvatar(e,t,s,a={},i=!1){return Ii.default.updateMyAvatar(e,s,t,a)}updateGroupAvatar(e,t,s,a,i){let n=xO.a.w,r=xO.a.h;return i&&(i.originWidth&&(n=i.originWidth),i.originHeight&&(r=i.originHeight)),this.resolveRequest(Jr.default.updateAvatar(e,t,a,s,n,r))}updateAvatar(e,t,s=120,a={},i=!1){const n=e+WO.a.getFullTimeFromMilisecond((new Date).getTime());return ui.default.isGroup(e)?this.updateGroupAvatar(e,s,t,n,a):this.updateMyAvatar(s,t,n,a,i)}async reuseAvatar(e,t){let s={photoId:e,isPostSocial:t?1:0};const a=H.b.getProfileDomain()+"/api/social/reuse-avatar?"+this._getCommonParams()+"&params="+this.getEncodedParams(s);return this.resolveRequest(this._get(a,null,12453))}async getAvatarHistory(e,t,s,a){let i={page:e,albumId:s,count:a};t&&(i.photoId=t);const n=H.b.getProfileDomain()+"/api/social/avatar-list?"+this._getCommonParams()+"&params="+this.getEncodedParams(i);return this.resolveRequest(this._get(n,null,12451))}deleteAvatarHistory(e){let t={delPhotos:JSON.stringify(e.map((e=>({photoId:e.toString()}))))};const s=H.b.getProfileDomain()+"/api/social/del-avatars?"+this._getCommonParams()+"&params="+this.getEncodedParams(t);return this.resolveRequest(this._get(s,null,12452))}_get(e,t,s){return Jr.default._get(e,t,s)}_getCommonParams(){return Jr.default._getCommonParams()}getEncodedParams(e){return Jr.default.getEncodedParams(e)}resolveRequest(e){return new Promise(((t,s)=>{e.then(Xr.a).then(t).catch(s)}))}};a.ModuleContainer.register(HO,class{get api(){return this._api||(this._api=new qO),this._api}constructor(){this._api=void 0,this._logger=void 0,this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(xO.b,["network-manager"])}async updateAvatar(e,t,s,a,i){this._logger.zsymb(0,"TgQD9-",`updateAvatar [convId: ${e}], [s: ${t.size}] [share: ${i}] [meta:`,a);try{return await this.api.updateAvatar(e,t,s,a,i),Promise.resolve(!0)}catch(n){return this._logger.zsymb(18,"bL-htG",`updateAvatar [convId: ${e}], [err:`,n),Promise.reject(n)}}async getAvatarHistory(e,t,s,a){return this._logger.zsymb(0,"7XnHaY",`getAvatarHistory [p:${e}], [pId:${t}], [aId:${s}], [c:${a}]`),this.api.getAvatarHistory(e,t,s,a)}async reuseAvatar(e,t){return this._logger.zsymb(0,"-s6pxP",`reuseAvatar [photoId: ${e}], [isPostSocial:`,t,"]"),this.api.reuseAvatar(e,t)}async deleteAvatarHistory(e){this._logger.zsymb(0,"Q0dMaJ","deleteAvatarHistory [photoIds: ",e);try{return await this.api.deleteAvatarHistory(e),Promise.resolve(!0)}catch(t){return Promise.reject(t)}}});const KO=`${xO.b}-repository`;var $O=Object(a.define)(KO);const ZO=`${xO.b}-storage`;var QO,YO=Object(a.define)(ZO),JO=s("nKYX"),XO=s("dVwc");let eM=Object(a.injectable)()(QO=function(e,t){return Object(a.inject)(YO)(e,void 0,0)}(QO=function(e,t){return Object(a.inject)(HO)(e,void 0,1)}(QO=Reflect.metadata("design:type",Function)(QO=Reflect.metadata("design:paramtypes",[Object,Object])(QO=class{constructor(e,t){this.storage=e,this.fetcher=t}reuseAvatar(e,t){return this.fetcher.reuseAvatar(e,t)}updateAvatar(e,t,s,a,i){return this.fetcher.updateAvatar(e,t,s,a,i)}async getAvatarHistory(e=0,t="",s="0",a=50){try{const i=await this.fetcher.getAvatarHistory(e,t,s,a);return this.mapApiDataToBackup(i),this.mapApiDataToModel(i)}catch(i){let e=JO.a.ERR_GET_AVA_HISTORY;return i&&i.code&&(e=i.code),Promise.reject({code:e,message:(null==i?void 0:i.message)||i})}}deleteAvatarHistory(e){return this.fetcher.deleteAvatarHistory(e)}mapApiDataToBackup(e){e.photos.length&&e.photos.forEach((({url:e,bkUrl:t})=>{XO.a.getInstance().setBackup(e,t)}))}mapApiDataToModel(e){return{albumId:e.albumId,hasMore:Boolean(e.hasMore),nextPhotoId:e.nextPhotoId,photos:e.photos.length?e.photos.map((e=>({photoId:e.photoId,thumb:e.thumbnail,url:e.url}))):[]}}})||QO)||QO)||QO)||QO)||QO;a.ModuleContainer.register($O,eM);var tM;a.ModuleContainer.register(YO,class{constructor(){this._storage=void 0,this._logger=void 0}get storage(){return this._storage||(this._storage=Xt.default.getInstance()),this._storage}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(xO.b,["storage"])),this._logger}async getAvatarHistory(){return new Promise((async(e,t)=>{try{e(await this.storage.Core.AvaHistory.getAll())}catch(s){return this.logger.zsymb(18,"1M7TLq","getAvatarHistory",s),t(s)}}))}addNewAvatarToHistory(e){const t=(new Date).getTime();return this.storage.Core.AvaHistory.insert(Object(I.a)(Object(I.a)({},e),{},{submit_dttm:t}),{replace:!0})}deleteAvatarHistory(e){return this.storage.Core.AvaHistory.delete(e)}});let sM=Object(a.injectable)()(tM=function(e,t){return Object(a.inject)($O)(e,void 0,0)}(tM=Reflect.metadata("design:type",Function)(tM=Reflect.metadata("design:paramtypes",[Object])(tM=class{get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(xO.b,[R.ZLoggerNametags.controller])),this._logger}constructor(e){this.repository=e,this._logger=void 0,this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._historyAvatars=[],this._retryLoadMore=1}getFrameList(e){return e?Ce.default.operation_frame_list.group:Ce.default.operation_frame_list.personal}getDefaultAvatarList(){var e,t;return(null===Ce.default||void 0===Ce.default||null===(e=Ce.default.settings)||void 0===e||null===(t=e.group)||void 0===t?void 0:t.avt_group_template)||null}async getInitialAvatarHistory(e=50){return this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._retryLoadMore=1,await this.getAvatarHistory(e)}async loadMoreAvatarHistory(){if(this._avatarHistoryMeta.hasMore&&this._retryLoadMore<3)try{return await this.getAvatarHistory()}catch(e){return this.logger.zsymb(0,"dcHQ2r","loadMoreAvatarHistory error",e),this.logger.zsymb(0,"s6Rbat","retry loadmore",this._retryLoadMore),this._retryLoadMore++,this.loadMoreAvatarHistory()}return[]}async getAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:JO.a.ERR_NO_NETWORK,message:""});try{const t=await this.repository.getAvatarHistory(this._avatarHistoryMeta.page,this._avatarHistoryMeta.photoId,this._avatarHistoryMeta.albumId,e||50);return this._avatarHistoryMeta={albumId:t.albumId,page:this._avatarHistoryMeta.page+1,photoId:t.nextPhotoId,hasMore:t.hasMore},Array.prototype.push.apply(this._historyAvatars,t.photos),t.photos}catch(t){return this.logger.zsymb(18,"rLyDcx","Error getting avatar history",t),Promise.reject({code:JO.a.ERR_GET_AVA_HISTORY,message:(null==t?void 0:t.msg)||(null==t?void 0:t.message)})}}async deleteAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:JO.a.ERR_NO_NETWORK,message:""});try{return await this.repository.deleteAvatarHistory([e]),this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),!0}catch(t){if(this.logger.zsymb(18,"bi_nk_","deleteAvatarHistory",t),t&&t.errMap){const s=t.errMap;return Promise.reject({code:s[e],message:""})}return Promise.reject({code:JO.a.DELETE_AVATAR_ERROR,message:""})}}updateAvatar(e,t,s,a,i){return this.isValidNetwork()?this.repository.updateAvatar(e,t,s,a,i):Promise.reject({code:JO.a.ERR_NO_NETWORK,message:""})}async reuseAvatar(e,t){try{await this.repository.reuseAvatar(e,t);const s=this._historyAvatars.find((t=>t.photoId===e));return s&&(this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),this._historyAvatars.unshift(s)),!0}catch(s){return Promise.reject(!1)}}isValidNetwork(){return ce.b.getStateNetwork()===ce.a.CONNECTED}})||tM)||tM)||tM)||tM;var aM=s("TGcW").a;a.ModuleContainer.registerSingleton(aM,sM);var iM=s("jB3n");class nM extends iM.a{constructor(){super()}}var rM=nM;var oM,lM=Object(a.define)("chat-list-manager-event-emitter");Object(a.singleton)(lM)(oM=Reflect.metadata("design:type",Function)(oM=Reflect.metadata("design:paramtypes",[])(oM=class extends rM{constructor(){super()}})||oM)||oM);var cM,dM=Object(a.define)("chat-list-ui-event-emitter");Object(a.singleton)(dM)(cM=Reflect.metadata("design:type",Function)(cM=Reflect.metadata("design:paramtypes",[])(cM=class extends rM{constructor(){super(),this.broadcastEventChanged=e=>{this.emit(Z.ChatListRenderEvent.OnDataChange,e)},a.ModuleContainer.resolve(lM).on(Z.ChatListRenderEvent.OnDataChange,this.broadcastEventChanged)}})||cM)||cM);var uM=class{constructor(e){this._token=void 0,null!=e&&(this.token=e)}isValidated(){return Boolean(this._token)}setToken(e){this.token=e}toString(){return void 0===this.token||null===this.token?"":String(this.token)}get token(){return this._token}set token(e){this._token=e}},hM=s("dA2Z");var gM=class{constructor(e){this._chatID="",this._messages=[],this._name="",void 0!==e.chatID&&e.chatID,this.chatID=e.chatID,e.name&&(this.name=e.name)}cleanUp(){}getMessages(){return Object(Ho.a)(this.chatID).messages||[]}async requestMessages(e,t){const{amount:s=this.getDefaultLoadMoreMessagesAmount(),direction:a=hM.d.Backwards,fromMessageID:i}=e||{},{events:n,opts:r}=t||{};return i?a===hM.d.Backwards?xr.a.loadTopMessagesForConversation(this.chatID,n,r):a===hM.d.Forwards?xr.a.loadBottomMessagesForConversation(this.chatID,n,r):a===hM.d.Around?xr.a.jumpToMessage():[]:xr.a.getLastMessagesForConversation(this.chatID)}getDefaultLoadMoreMessagesAmount(){return Ce.default.numberMessage}get chatID(){return this._chatID}set chatID(e){this._chatID=e}get messages(){return this._messages}set messages(e){this._messages=e}get name(){return this._name}set name(e){this._name=e}};var mM,pM=Object(a.define)("chat-list-controller-factory");Object(a.singleton)(pM)(mM=class{constructor(){this._instanceMap=new Map,this._localID=new De.a}createController(e,t,s){if(t){if(this.isExistingController(t)){const e=this.instanceMap.get(t);if(e)return[t,e]}const s=new gM({chatID:e,name:t.toString()});return this.mapControllerToToken(t,s),[t,s]}const a=this.getUniqueToken(),i=new gM({chatID:e,name:a.toString()});return this.mapControllerToToken(a,i),[a,i]}deleteController(e){if(!this.isExistingController(e))return!1;return this.getExistingController(e).cleanUp(),this.instanceMap.delete(e.toString()),!0}getController(e){if(this.isExistingController(e))return this.getExistingController(e)}getExistingController(e){return this.instanceMap.get(e.toString())}getUniqueToken(){return new uM(this.localID.next().toString())}isExistingController(e){return this.instanceMap.has(e.toString())}mapControllerToToken(e,t){this.instanceMap.set(e.toString(),t)}get instanceMap(){return this._instanceMap}set instanceMap(e){this._instanceMap=e}get localID(){return this._localID}set localID(e){this._localID=e}});var fM=pM;var vM,_M=class{constructor(){this._map=new Map}deleteToken(e){this.map.delete(e)}hasToken(e){return this.map.has(e)}getToken(e){return this.map.get(e)}setToken(e,t){this.isValidatedToken(t)&&this.map.set(e,t)}isValidatedToken(e){return Boolean(e&&"function"==typeof e.isValidated&&e.isValidated())}get map(){return this._map}set map(e){this._map=e}},bM=s("wv5Y");Object(a.injectable)()(vM=Object(a.singleton)(bM.a)(vM=function(e,t){return Object(a.inject)(fM)(e,void 0,0)}(vM=function(e,t){return Object(a.inject)(lM)(e,void 0,1)}(vM=Reflect.metadata("design:type",Function)(vM=Reflect.metadata("design:paramtypes",[Object,Object])(vM=class{constructor(e,t){this.controllerFactory=e,this.eventEmitter=t,this._tokenManager=new _M}closeConversation(e,t){const s=this.createTokenForController(e,t);this.controllerFactory.deleteController(s),this.deleteTokenFromWindowID(t,s)}getMessages(e,t){const s=this.getController(e,t);return s?s.getMessages():[]}openConversation(e,t){const s=this.createTokenForController(e,t),[a,i]=this.controllerFactory.createController(e,s);this.mapTokenToWindowID(t,a),i.requestMessages().then((()=>{const e={messages:i.getMessages()};this.notifyEventRender(hM.b.OnDataChange,e)})).catch((e=>{}))}async requestMessages(e,t,s,a){const i=this.getController(e,t);return i?i.requestMessages(s,a):[]}transformMessages(e){return e}createTokenForController(e,t){return new uM(t+"_"+e)}deleteTokenFromWindowID(e,t){this.tokenManager.deleteToken(e)}getController(e,t){const s=this.createTokenForController(e,t);return this.controllerFactory.getController(s)}notifyEvent(e,t){this.eventEmitter.emit(e,t)}notifyEventRender(e,t){this.notifyEvent(e,t)}mapTokenToWindowID(e,t){this.tokenManager.setToken(e,t)}get tokenManager(){return this._tokenManager}set tokenManager(e){this._tokenManager=e}})||vM)||vM)||vM)||vM)||vM);var IM=s("7w+8");var yM,SM=class{constructor(e){this.key="",this.name="",this._state={messages:[]},void 0!==e.key&&e.key,this.key=e.key,void 0!==e.name&&e.name,this.name="ChatListUIController_"+e.name,this.handleEventDataChanged=this.handleEventDataChanged.bind(this),this.init(e)}cleanUp(){Object(Po.k)(this),this.unregisterEventListeners()}getItem(e,t){if(e.key===hM.c.Messages)return this.state.messages}getList(e,t){return[]}init(e){Object(Po.e)(this),this.registerEventListeners()}onGetItemFailure(e,t){}onGetListFailure(e,t){}handleEventDataChanged(e){e.messages&&this.setState((t=>{t.messages=e.messages}),[hM.c.Messages])}registerEventListeners(){a.ModuleContainer.resolve(dM).on(hM.b.OnDataChange,this.handleEventDataChanged)}setState(e,t){const s=Object(Lg.a)(this.state,e);this.state!==s&&(this.updateState(s),Array.isArray(t)&&t.forEach((e=>{Object(Po.h)(this.name,e)})))}unregisterEventListeners(){a.ModuleContainer.resolve(dM).off(hM.b.OnDataChange,this.handleEventDataChanged)}updateState(e){this.state=e}get state(){return this._state}set state(e){this._state=e}};Object(a.singleton)(IM.a)(yM=class{constructor(){this._existingTokenMap=new Map,this._instanceMap=new Map,this._localID=new De.a}createController(e,t){let s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);if(e)return[s,e]}s=this.generateToken(e,t);const a=new SM({key:s.toString(),name:s.toString()});return this.createControllerWithNewToken(e,t,s,a),[s,a]}deleteController(e,t){const s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);e&&e.cleanUp(),this.removeController(s)}this.removeExistingToken(e,t)}addExistingToken(e,t,s){const a=this.getKeyFrom(e,t);this.existingTokenMap.set(a,s)}createControllerWithNewToken(e,t,s,a){this.addExistingToken(e,t,s),this.mapController(s,a)}getController(e){return this.instanceMap.get(e.toString())}getExistingToken(e,t){const s=this.getKeyFrom(e,t);return this.existingTokenMap.get(s)}getKeyFrom(e,t){return t+"_"+e}generateToken(e,t){const s=t+"_"+e+"_"+this.localID.next();return new uM(s)}isExistingController(e){return this.instanceMap.has(e.toString())}mapController(e,t){this.instanceMap.set(e.toString(),t)}removeController(e){this.instanceMap.delete(e.toString())}removeExistingToken(e,t){const s=this.getKeyFrom(e,t);this.existingTokenMap.delete(s)}get existingTokenMap(){return this._existingTokenMap}get instanceMap(){return this._instanceMap}get localID(){return this._localID}});var CM=Object(a.define)("chat-list-render-service"),EM=s("1Kge"),OM=s("rJdt"),MM=s("vUxW"),TM=s("g7V2"),wM=s("dMXo");class RM{constructor(){this.isAvatarShown=!1,this.isDateChanged=!1,this.isFirstInBlock=!1,this.isFirstInList=!1,this.isLastInBlock=!1,this.isLastInList=!1,this.isTimeSeparatorShown=!1,this.timestamp=0,this.vanishMode=void 0}setAvatarShown(e){return this.isAvatarShown=Boolean(e),this}setDateChanged(e){return this.isDateChanged=Boolean(e),this}setFirstInBlock(e){return this.isFirstInBlock=Boolean(e),this}setFirstInList(e){return this.isFirstInList=Boolean(e),this}setLastInBlock(e){return this.isLastInBlock=Boolean(e),this}setLastInList(e){return this.isLastInList=Boolean(e),this}setTimeSeparatorShown(e){return this.isTimeSeparatorShown=Boolean(e),this}setTimestamp(e){const t="number"==typeof e||!isNaN(Number(e));return Object(ua.b)(t,"Timestamp should be a number"),t&&(this.timestamp=+e),this}setVanishModeEnded(){return this.vanishMode="end",this}setVanishModeStarted(){return this.vanishMode="start",this}build(){return{isAvatarShown:this.isAvatarShown,isDateChanged:this.isDateChanged,isFirstInBlock:this.isFirstInBlock,isFirstInList:this.isFirstInList,isLastInBlock:this.isLastInBlock,isLastInList:this.isLastInList,isTimeSeparatorShown:this.isTimeSeparatorShown,timestamp:this.timestamp,vanishMode:this.vanishMode}}}class LM{constructor(e,t){this.type=void 0,this.data=void 0,this.UIDataBuilder=new RM,wM.a.isChatItem(e)?this.type=e:this.type=wM.a.for(String(e)),this.data=t}getData(){return this.data}getType(){return this.type}getUIBuilder(){return this.UIDataBuilder}getUIData(){return this.UIDataBuilder.build()}}var DM=s("x/wQ");function AM(e){return e.msgType}function FM(e){return e.message}function kM(e,t,s){if(!e)return[];let a=[];const i=AM(e);if(i===Y.MSG_INFO_CHAT)a.push(new LM(wM.a.MessageInfo,e));else if(i===Y.MSG_INFO||i===Y.MSG_GROUP_NOTI||i===Y.MSG_FRIEND_SENT_REQUEST||i===Y.MSG_SUGGEST_IN_CHAT){let i=!1;Ce.default.e2ee.invisible&&"update_e2ee"===e.act&&(i=!0),i||(a.push(new LM(wM.a.MessageEvent,e)),Ce.default.enable_hi_group_member&&e.msgType===Y.MSG_INFO&&"join"===e.act&&e.updateMemberIds&&e.updateMemberIds.indexOf(J.p.getSessionUserId())>=0&&s.length-t<=15&&a.push(new LM(wM.a.Guide,e)))}else if(i===Y.MSG_ECARD){const t=function(e,t){let s=!0;if(FM(e).type===Y.ECARD_TYPE.FRIEND_ACCEPT||FM(e).type===Y.ECARD_TYPE.FRIEND_ACCEPT_PASSIVE){const a=t.findIndex((t=>t.msgId===e.msgId));for(let e=a+1;e<a+15;e++){const a=t[e];if(!a)break;if(AM(a)===Y.MSG_ECARD&&FM(a).type===Y.ECARD_TYPE.BIRTHDAY){s=!1;break}}}return s?new LM(wM.a.Ecard,e):null}(e,s);t&&a.push(t)}else if(i===Y.MSG_POLL)a.push(new LM(wM.a.Poll,e));else if(i===Y.MSG_TODO)a.push(new LM(wM.a.Todo,e));else if(Object(m_.W)(e)){let t=!1;const i=s.findIndex((t=>t.msgId===e.msgId));let n,r=s[i+1];r&&Object(m_.W)(r)&&(n=r),TM.isZInstantTypeSupported(e)&&(TM.shouldCollapseZInstantMsg(e,n)||TM.shouldRenderDefaultLayout(e))&&(t=!0);let o=null;o=new LM(!0===t?wM.a.ZInstant:wM.a.MessageItem,e),o&&a.push(o)}else a.push(new LM(wM.a.MessageItem,e));return a.length>0&&a.forEach((t=>{var s;t.getUIBuilder().setTimestamp(null!==(s=e.sendDttm)&&void 0!==s?s:e.ts)})),a}var NM=function(e,t,s){return Array.isArray(e)?e.map(((e,t)=>kM(e,t,s))).flat().map(((e,s,a)=>{var i;return 0===s&&(e.getUIBuilder().setFirstInBlock(!0),t.forEach((s=>{s===DM.a.VanishModeStarted?e.getUIBuilder().setVanishModeStarted():s===DM.a.VanishModeEnded?e.getUIBuilder().setVanishModeEnded():s===DM.a.SentTimeTooLong?e.getUIBuilder().setTimeSeparatorShown(!0):s===DM.a.DateChanged?e.getUIBuilder().setTimeSeparatorShown(!0).setDateChanged(!0):s===DM.a.FirstBlock?e.getUIBuilder().setTimeSeparatorShown(!0):s===DM.a.DifferentSender||s===DM.a.StandaloneTypeChanged&&(e.getUIBuilder().setTimeSeparatorShown(!0),e.getType()!==wM.a.MessageInfo&&e.getType()!==wM.a.MessageEvent&&e.getType()!==wM.a.Poll||t.includes(DM.a.SentTimeTooLong)||t.includes(DM.a.DateChanged)||e.getUIBuilder().setTimeSeparatorShown(!1)),s&&e.getUIBuilder().setAvatarShown(!0)}))),s===a.length-1&&e.getUIBuilder().setLastInBlock(!0),e.getType()===wM.a.MessageItem&&(null===(i=a[s-1])||void 0===i?void 0:i.getType())===wM.a.ZInstant&&e.getUIBuilder().setAvatarShown(!0),e})):[]},PM=s("XkoV"),jM=s("Gy64"),UM=s("CFkE");function BM(e){try{return parseInt(e.cliMsgId)}catch(t){return 0}}var zM=function(e,t,s){const a=new Map;if(e.length<=0)return e;const i={},n={},r={},o=[];for(let d=0;d<e.length;d++){if(i[d])continue;const u=e[d];let h=u;const g=null!=n[d]?n[d]:t.getGroupPhotoId(u);if(g){var l;let a=u;const o=[u];let c=t.getTotalGroupPhotoItem(u)-1;if(c<=0)continue;for(let s=d+1;s<e.length;s++){if(i[s])continue;let a,r=e[s];if(null!=n[s]?a=n[s]:(a=t.getGroupPhotoId(r),n[s]=a),!a||g!=a)break;if(o.push(r),i[s]=!0,c--,0==c)break}o.sort(((e,t)=>BM(e)-BM(t)));const m=o.reduce(((e,t)=>t.e2eeStatus===Y.MSG_E2EE||e),!1);let p;a=o[o.length-1],o.some((e=>{const t=Object(fe.i)(e);return jM.a.getInstance().isExisted(s,t)&&(p=jM.a.getInstance().getGroupId(s,t)),!!p})),p||(p=Object(fe.i)(o[0]));let f=p;r[f]&&(f=p+"_"+jM.a.getInstance().getRandKey()),r[f]=!0,o.forEach((e=>{const t=Object(fe.i)(e);jM.a.getInstance().setGroupId(s,t,f)})),h=Object(I.a)({msgId:f,cliMsgId:f,msgType:Y.MSG_PHOTO_GROUP,sendDttm:a.sendDttm,status:null!==(l=t.getGroupStickerPhotoStatus(o))&&void 0!==l?l:a.status,fromUid:a.fromUid,toUid:a.toUid,message:o},m&&{e2eeStatus:Y.MSG_E2EE})}const m=t.isStickerButNotNewFSSMessage(u),p=t.isNewFSSMessage(u),f=!m&&!p&&t.isAIStickerMessage(u),v=!m&&!p&&!f&&t.isPhotoStickerMessage(u),_=!m&&!p&&!f&&!v&&t.isNoBorderPhotoStickerMessage(u);if(m||v||f||p||_){var c;let s=u,n=s.cliMsgId;const r=[s];let o=u.status===Y.MSG_FAIL;const l=t.getGroupStickerId(u.msgId),g=l&&!a.has(l)?l:"grp"+h.msgId,m=v?UM.e.PhotoSticker:f?UM.e.AISticker:p?UM.e.NewFSSticker:_?UM.e.NoBorderPhotoSticker:UM.e.Sticker,b=PM.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(u),I=t.getMaxStickerItemInGroup(b?UM.e.Sticker:m);for(let a=d+1;a<e.length;a++){if(i[a])continue;if(r.length>=I)break;let n=e[a];const l=t.isStickerButNotNewFSSMessage(n)||PM.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(n);if(!(n.sendDttm-s.sendDttm<3e5&&l))break;s=n,r.push(s),i[a]=!0,o&&n.status!==Y.MSG_FAIL&&(o=!1)}r.length>1&&r.sort(((e,t)=>BM(e)-BM(t))),a.set(g,!0),h={msgId:g,cliMsgId:n,msgType:Y.MSG_STICKER_GROUP,sendDttm:s.sendDttm,status:o?Y.MSG_FAIL:null!==(c=t.getGroupStickerPhotoStatus(r))&&void 0!==c?c:s.status,fromUid:s.fromUid,toUid:s.toUid,message:r,UIContent:r,UIStickerTypeInGroup:m}}o.push(h)}return o};var GM,xM=function(e,t){var s,a;const i=[];if(!Array.isArray(e)||0===e.length)return i;const n=e.reduce(((e,t)=>(Array.prototype.push.apply(e,t.messages),e)),[]),r=e.length;let o,l=[];for(let g=0;g<r;g++){var c,d,u,h;const{messages:s,reasons:a}=e[g],r=null!==(c=null===(d=t.rules)||void 0===d||null===(u=d[MM.a.GroupMessages])||void 0===u||null===(h=u[Y.MSG_STICKER_GROUP])||void 0===h?void 0:h.max)&&void 0!==c?c:1,m="function"==typeof r?r:()=>r,p=zM(s,{getGroupPhotoId:$r.default.isGroupPhoto,getTotalGroupPhotoItem:$r.default.getTotalItem,getMaxStickerItemInGroup:m,isStickerButNotNewFSSMessage:m_.L,isDFEOrUndoNewFSSMessage:e=>Object(m_.h)(e)||Object(m_.Q)(e),isAIStickerMessage:m_.a,isNewFSSMessage:m_.x,isPhotoStickerMessage:m_.D,isNoBorderPhotoStickerMessage:m_.y,getGroupStickerPhotoStatus:OM.d.getGroupStickerPhotoStatus,getGroupStickerId:EM.a.getGroupId.bind(EM.a),setGroupStickerId:EM.a.setGroupId.bind(EM.a)},t.windowId);l.push(...NM(p,a,n)),Array.prototype.push.apply(i,l),l=[],o=p[p.length-1]}return null===(s=i[0])||void 0===s||s.getUIBuilder().setFirstInList(!0),null===(a=i[i.length-1])||void 0===a||a.getUIBuilder().setLastInList(!0),i};function VM(e){return e.sendDttm}function HM(e){return e.msgType}function WM(e){return PM.a.getStandaloneMessageTypes().includes(e.msgType)}function qM(e){var t;return void 0!==(null===(t=e.eventInfo)||void 0===t?void 0:t.ttl)}function KM(e,t){return{messages:e,reasons:t}}function $M(e,t,s){if(void 0===e)return{isInContinuousBlock:!0,reasons:[]};const a=null==s?void 0:s[MM.a.BreakItem];let i=!0;const n=new Set,r=function(e,t){const s=HM(e),a=HM(t),i=s===Y.MSG_INFO_CHAT||s===Y.MSG_INFO&&"update_ttl"===s.act,n=a===Y.MSG_INFO_CHAT||a===Y.MSG_INFO&&"update_ttl"===t.act;return i&&n}(e,t),o=null==a?void 0:a[DM.a.SentTimeTooLong.toString()];var l,c,d;!r&&Boolean(o)&&(l=e,c=t,d="app-config"!==(null==o?void 0:o.time_to_break)?+o.time_to_break:PM.a.getTimeToBreakBlockMessages(),Math.abs(VM(c)-VM(l))>d)&&(i=!1,n.add(DM.a.SentTimeTooLong));const u=null==a?void 0:a[DM.a.DifferentSender.toString()];r||!Boolean(u)||function(e,t){return e.fromUid===t.fromUid}(e,t)||(i=!1,n.add(DM.a.DifferentSender));const h=null==a?void 0:a[DM.a.VanishModeStarted.toString()];!r&&Boolean(h)&&qM(t)&&(i=!1,!function(e){return null!=e.eventInfo&&e.eventInfo.ttl>0}(t)?n.add(DM.a.VanishModeEnded):n.add(DM.a.VanishModeStarted));const g=null==a?void 0:a[DM.a.StandaloneTypeChanged.toString()];return!r&&Boolean(g)&&function(e,t){return WM(e)!==WM(t)}(e,t)&&(i=!1,n.add(DM.a.StandaloneTypeChanged)),r||function(e,t){const s=VM(e),a=VM(t);if(!s||!a)return!1;let i=new Date(parseInt(s.toString())),n=new Date(parseInt(a.toString()));return i.getFullYear()===n.getFullYear()&&i.getMonth()===n.getMonth()&&i.getDate()===n.getDate()}(e,t)||(i=!1,n.add(DM.a.DateChanged)),{isInContinuousBlock:i,reasons:Array.from(n)}}function ZM(e){return Object(I.a)({},e)}Object(a.singleton)(CM)(GM=class{buildChatItems(e,t){const s=function(e,t){if(!Array.isArray(e))return[];const s=e.filter((e=>Boolean(e))),a=[];let i=[];for(let n=s.length-1;n>=0;n--){const e=s[n];if(0===i.length){i.unshift(ZM(e));continue}const r=i[0],{isInContinuousBlock:o,reasons:l}=$M(e,r,t.rules);o?i.unshift(ZM(e)):(a.unshift(KM(i,l)),i=[ZM(e)])}return i.length>0&&a.unshift(KM(i,[DM.a.FirstBlock])),a}(e,t);return xM(s,t)}});var QM=s("5xVU");var YM=function(e){const{conversation:t,data:s}=e;return rr.a.createElement(QM.a,{isGroup:Boolean(null==t?void 0:t.isGroup),fromUid:null==s?void 0:s.fromUid})},JM=s("VHye");var XM=function(e){return rr.a.createElement(JM.a,null)},eT=s("j7nq");var tT=function(e,t){var s;if(!e)return;let a={message:""};if("string"==typeof e.msg)a.message=e.msg;else try{const t=e.msg;a=Object(I.a)(Object(I.a)({},t),{},{message:t.title||""})}catch(r){}const i=null!==(s=e.ownerId)&&void 0!==s?s:e.fromUid,n=function(e,t){let s="";const a=e.fromUid||e.ownerId;if(a===J.p.getSessionUserId()){const e=Ii.default.getMiniProfileMe();s=(null==e?void 0:e.dName)||""}else if(Object($c.a)(t)){const e=Ii.default.getDName(a);if(e)s=e;else{var i;const e=(null===(i=hn.default.getMiniInfoGroup(t))||void 0===i?void 0:i.topMember)||[];for(let t of e)if(t.id===a){s=t.dName;break}}}return s||(s=Ii.default.getDName(a)||""),s}(e,t);return{attachment:eT.a.deep(e.attach),attach:eT.a.deep(e.attach),rootClientMessageID:e.cliMsgId,cliMsgId:e.cliMsgId,rootClientMessageType:e.cliMsgType,cliMsgType:e.cliMsgType,rootContent:a,msg:e.msg,rootGlobalMessageID:e.globalMsgId,globalMsgId:e.globalMsgId,rootSentTime:+e.ts,ts:+e.ts,rootSenderName:n,fromD:n,rootSenderID:i,ownerId:i,ttl:e.ttl}};var sT=function(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}};var aT=function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{eventInfo:sT(e.eventInfo),quote:tT(e.quote,e.toUid),type:-1})};var iT=function(e){var t,s,a;if(!e)return;let i=e.params;if("string"==typeof i)try{i=JSON.parse(i)}catch(c){}i||(i={});const n=function(e){switch(e){case 1:return $.a.CALLEE_BUSY;case 2:return $.a.TIMEOUT_HAVE_RINGING;case 3:return $.a.CALLEE_REJECT;case 4:return $.a.CALLER_REJECT_HAVE_RINGING;case 5:return $.a.CALLER_REJECT_NOT_RINGING;default:return $.a.DEFAULT}}(i.reason),r=e.action===Y.CallMessageAction.MissCall?$.b.MISSCALL:$.b.CALLTIME,o=null!=i.isCaller?!!i.isCaller?$.c.CALLER:$.c.CALLEE:function(e){return e===Y.CallMessageAction.Calling?$.c.CALLER:$.c.CALLEE}(e.action),l=function(e){return 1===e?$.d.VIDEO:$.d.AUDIO}(i.calltype);return{duration:null!==(t=null!==(s=i.duration)&&void 0!==s?s:e.duration)&&void 0!==t?t:0,isEnabledCallback:null!==(a=Boolean(i.isEnableCallback))&&void 0!==a&&a,reason:n,status:r,subject:o,type:l}};var nT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:iT(e.message)})};var rT=function(e){if(!e)return;let t=e.description,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(i){s={}}else"object"==typeof t&&(s=t);let a=-1;return e.action===Y.MessageContentAction.User?a=UM.b.User:e.action===Y.MessageContentAction.OA&&(a=UM.b.OA),{name:e.title,phone:s.phone,QRCodeURL:s.qrCodeUrl,gUid:s.gUid,oaShortLink:s.oaShortLink,href:e.href,thumb:e.thumb,type:a,userId:e.params}};var oT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:rT(e.message)})};var lT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:e.message})};var cT=function(e){if(e)return{pArtist:e.artist,pCount:e.count,pMediaTitle:e.mediaTitle,pSource:e.src,pStreamUrl:e.streamUrl,pStreamIcon:e.stream_icon,pType:e.type}};var dT=function(e){if(!e)return;const t=e.params;let s;if("string"==typeof t)try{const e=JSON.parse(t);s=cT(e)}catch(a){}else"object"==typeof t&&(s=cT(t));return Object(I.a)({title:e.title,description:e.description,href:e.href,thumb:e.thumb},s)};var uT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:dT(e.message)})};var hT=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(a){s={}}else"object"==typeof t&&(s=t);return{title:e.title,description:e.desc,isUserLocation:e.isUserLocation||s.isUserLocation||0,latitude:e.lat||s.latitude,longitude:e.lo||s.longitude,sourceID:e.sourceID||s.srcId||""}};var gT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:hT(e.message)})};var mT=function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{id:e.id,cateId:e.catId,type:e.type,extInfo:e.extInfo})};var pT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:mT(e.message),msgType:e.msgType,UIType:UM.e.Sticker,src:e.src})};var fT=function(e){return{thumb_height:e.thumb_height,thumb_width:e.thumb_width,width:e.width,height:e.height,contentId:e.contentId,webp:{hd:e.webp.hd,url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var vT=function(e){const t=e.params;let s={};if("string"==typeof t)try{s=fT(JSON.parse(t))}catch(a){}else"object"==typeof t&&(s=fT(t));return Object(I.a)(Object(I.a)({},e),{},{thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,parsedParams:s})};var _T=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:vT(e.message),msgType:e.msgType,UIType:UM.e.PhotoSticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext}})},bT=s("z80d");var IT=function(e){return{contentId:e.contentId,pStickerType:bT.c.AI_STICKER,height:e.height,width:e.width,thumb_height:e.thumb_height,thumb_width:e.thumb_width,webp:{url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var yT=function(e){const t=e.params;let s={contentId:"",thumb_height:-1,thumb_width:-1,width:-1,height:-1,pStickerType:bT.c.AI_STICKER,webp:{url:"",width:-1,height:-1}};if("string"==typeof t)try{s=IT(JSON.parse(t))}catch(a){0}else"object"==typeof t&&(s=IT(t));return{title:e.title,description:e.description,thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,UIParsedParams:s}};var ST=function(e){let t={sSrcStr:"",sSrcType:-1};const s=e.properties.ext;if("string"==typeof s)try{t=JSON.parse(s)}catch(a){0}else"object"==typeof s&&(t=s);return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:yT(e.message),msgType:e.msgType,src:e.src,UIType:UM.e.AISticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext,UIParsedExt:t}})};function CT(e){const t=e.params,s=function(e){let t={};try{"string"==typeof e?t=JSON.parse(e):"object"==typeof e&&(t=e)}catch(s){zconsole.zsymb(3,"1uocdh",["[transformMessageContent::NBPSParsedParams] failed: {}","oa2seT"],null==s?void 0:s.message)}return{width:t.width,height:t.height}}(t);return{oriUrl:e.oriUrl,normalUrl:e.normalUrl,thumbUrl:e.thumbUrl,params:t,parsedParams:s}}var ET=function(e){return Array.isArray(e)?e.map((e=>{return Object(m_.D)(e)?_T(e):Object(m_.M)(e)?pT(e):Object(m_.a)(e)?ST(e):Object(m_.y)(e)?(t=e,Object(I.a)(Object(I.a)({},aT(t)),{},{UIContent:CT(t.message),msgType:t.msgType,UIType:UM.e.NoBorderPhotoSticker,properties:{color:t.properties.color,size:t.properties.size,type:t.properties.type,subType:t.properties.subType,ext:t.properties.ext}})):e;var t})):[]};var OT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:ET(e.message),msgType:Y.MSG_STICKER_GROUP,UIType:UM.e.StickerGroup})};var MT=function(e){return Object(I.a)(Object(I.a)({},e),{},{id:e.id,name:e.name,desc:e.desc,isFree:e.isFree,iconUrl:e.iconUrl,iconPreview:e.iconPreview,thumbUrl:e.thumbUrl,totalImage:e.totalImage,group:e.group,version:e.version,permission:e.permission,isHidden:e.is_hidden,thumbImg:e.thumbImg,expireTime:e.expireTime})};var TT=function(e){let t=e.params,s={};if("string"==typeof t)try{s=MT(JSON.parse(t))}catch(a){}else"object"==typeof t&&(s=MT(t));return{title:e.title||s.name,thumb:e.thumb,action:e.action,href:e.href,description:e.description||s.desc,parsedParams:s}};var wT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:TT(e.message),UIType:UM.e.StickerSet})};var RT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:e.message})};var LT=function(e){var t,s,a,i;if(!e)return;let n=e.params,r={};if("string"==typeof n)try{r=JSON.parse(n)}catch(o){r={}}else"object"==typeof n&&(r=n);return{caption:null!==(t=e.title)&&void 0!==t?t:"",duration:null!==(s=null!==(a=r.duration)&&void 0!==a?a:e.duration)&&void 0!==s?s:0,fileSize:r.fileSize,height:r.video_height,quality:1===r.isHD?"HD":void 0,rotation:r.video_rotation,width:r.video_width,thumbUrl:null!==(i=e.thumbUrl)&&void 0!==i?i:"",parsed:r.parsed}};var DT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:LT(e.message)})};var AT=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(a){s={}}else"object"==typeof t&&(s=t);return{source:e.href,duration:s.duration||0,formats:{m4a:s.m4a}}};var FT=function(e){return Object(I.a)(Object(I.a)({},aT(e)),{},{UIContent:AT(e.message)})};var kT=s("ZTgy"),NT=s("3nWQ");const PT="call-message",jT={Caller:PT+"--caller",Callee:PT+"--callee",Selected:PT+"--selected",HasFooter:PT+"--has-footer"},UT=PT+"__title-wrapper",BT={Red:UT+"--red"},zT=PT+"__content-container",GT=PT+"__icon-wrapper",xT=PT+"__content-txt-wrapper",VT=PT+"__separator",HT=PT+"__callback-wrapper";var WT=s("z5gp"),qT=s("7veT");function KT(e){const{subject:t}=e;return t===$.c.CALLER?function(e){const{reason:t,status:s,type:a}=e;return s===$.b.CALLTIME?a===$.d.AUDIO?le.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):le.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):s===$.b.MISSCALL?t===$.a.CALLER_REJECT_NOT_RINGING||t===$.a.CALLER_REJECT_HAVE_RINGING?le.a.str("STR_CALL_TITLE_OUTGOING_CALL_CANCEL"):t===$.a.CALLEE_REJECT?le.a.str("STR_CALL_TITLE_OUTGOING_CALL_REJECTED"):t===$.a.CALLEE_BUSY?le.a.str("STR_CALL_TITLE_OUTGOING_CALL_BUSY"):a===$.d.AUDIO?le.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):le.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):""}(e):t===$.c.CALLEE?function(e){const{reason:t,status:s,type:a}=e;return s===$.b.CALLTIME?a===$.d.AUDIO?le.a.str("STR_CALL_TITLE_INCOMING_CALL_AUDIO"):le.a.str("STR_CALL_TITLE_INCOMING_CALL_VIDEO"):s===$.b.MISSCALL?t===$.a.CALLEE_REJECT?le.a.str("STR_CALL_TITLE_INCOMING_CALL_REJECTED"):le.a.str("STR_CALL_TITLE_INCOMING_CALL_MISSED"):""}(e):""}const $T={IncomingAudio:"call-incoming-audio",IncomingMissedAudio:"call-incoming-missed-audio",IncomingMissedAudioGrayscale:"call-incoming-missed-audio-grayscale",IncomingMissedVideo:"call-incoming-missed-video",IncomingMissedVideoGrayscale:"call-incoming-missed-video-grayscale",IncomingVideo:"call-incoming-video",OutgoingAudio:"call-outgoing-audio",OutgoingMissedAudio:"call-outgoing-missed-audio",OutgoingMissedVideo:"call-outgoing-missed-video",OutgoingVideo:"call-outgoing-video",RejectedAudio:"call-rejected-audio",RejectedVideo:"call-rejected-video"};function ZT(e,t=!1){const{subject:s}=e;return s===$.c.CALLER?function(e){const{reason:t,status:s,type:a}=e;if(s===$.b.CALLTIME){if(a===$.d.AUDIO)return $T.OutgoingAudio;if(a===$.d.VIDEO)return $T.OutgoingVideo}else if(s===$.b.MISSCALL){if(a===$.d.AUDIO)return t===$.a.CALLEE_REJECT?$T.RejectedAudio:$T.OutgoingMissedAudio;if(a===$.d.VIDEO)return t===$.a.CALLEE_REJECT?$T.RejectedVideo:$T.OutgoingMissedVideo}return""}(e):s===$.c.CALLEE?function(e,t=!1){const{reason:s,status:a,type:i}=e;if(a===$.b.CALLTIME){if(i===$.d.AUDIO)return $T.IncomingAudio;if(i===$.d.VIDEO)return $T.IncomingVideo}else if(a===$.b.MISSCALL){if(i===$.d.AUDIO)return s===$.a.CALLEE_REJECT?$T.RejectedAudio:t?$T.IncomingMissedAudioGrayscale:$T.IncomingMissedAudio;if(i===$.d.VIDEO)return s===$.a.CALLEE_REJECT?$T.RejectedVideo:t?$T.IncomingMissedVideoGrayscale:$T.IncomingMissedVideo}return""}(e,t):""}function QT(e){const t=e||0,s=t%60,a=Math.floor(t/60)%60,i=Math.floor(t/3600);const n=`${s} ${le.a.str("STR_SEC")}`;let r=`${`${a} ${a>1?le.a.str("STR_MINS"):le.a.str("STR_MIN")}`} ${n}`;if(i>0){r=`${`${i} ${i>1?le.a.str("STR_HOURS"):le.a.str("STR_HOUR")}`} ${r}`}return r}var YT=function(e){const t=ZT(e),s=function(e){const{duration:t,reason:s,status:a,subject:i,type:n}=e;if(a===$.b.CALLTIME)return QT(t);if(a===$.b.MISSCALL){if(i===$.c.CALLER&&(s===$.a.DEFAULT||s===$.a.TIMEOUT_HAVE_RINGING))return QT(0);if(n==$.d.AUDIO)return le.a.str("STR_CALL_CONTENT_AUDIO");if(n==$.d.VIDEO)return le.a.str("STR_CALL_CONTENT_VIDEO")}return""}(e);return rr.a.createElement("div",{className:zT},rr.a.createElement("div",null,rr.a.createElement("div",{className:GT},rr.a.createElement(WT.a,{icon:t,size:"medium"})),rr.a.createElement("div",{className:xT},rr.a.createElement("span",null,s))))};var JT=function(e){const t=e.subject===$.c.CALLEE&&e.status===$.b.MISSCALL;return rr.a.createElement("div",{className:Object(lC.a)(UT,t&&BT.Red)},KT(e))};const XT=()=>null;function ew(e){return e.visible?rr.a.createElement("div",{className:VT}):rr.a.createElement(XT,null)}function tw(e){return e.visible?rr.a.createElement("div",{className:HT,onClick:e.onClick},le.a.str("STR_CALL_CALL_BACK")):rr.a.createElement(XT,null)}var sw=function(e){const{data:t,isSelected:s,observeIntersectionForReading:a}=e,i=t.ttl,n=t.UIContent,{duration:r,isEnabledCallback:o,reason:l,status:c,subject:d,type:u}=n,h=rr.a.useRef(null);Object(kT.a)(h,a);const g=o,m=Object(lC.a)(PT,s&&jT.Selected,d===$.c.CALLER&&jT.Caller,d===$.c.CALLEE&&jT.Callee,g&&jT.HasFooter);return rr.a.createElement(NT.a,{border:6,className:Object(lC.a)(m,!Boolean(t.ttl)&&"shadow-bubble"),ttl:i,variant:"common"},rr.a.createElement("div",{ref:h,"data-qId":Object(fe.g)(t)},rr.a.createElement(JT,{reason:l,status:c,subject:d,type:u}),rr.a.createElement(YT,{duration:r,reason:l,status:c,subject:d,type:u}),rr.a.createElement(ew,{visible:g}),rr.a.createElement(tw,{onClick:e=>{const{makeCall:s}=Object(q.c)();"function"==typeof s&&function(e,t,s){const a=qT.a.ActionLog.getCallbackActionLog(t);Ia.default.logAction(a),"function"==typeof s&&s(e,t.type)}(e,n,s.bind(null,{chatID:t.toUid,callType:u}))},visible:g})))},aw=s("3jpH");const iw="contact-message",nw=iw+"__container",rw={HighlightFromPrivilegedUser:nw+"--highlight-from-privileged-user"},ow=iw+"__footer-container",lw={Blue:ow+"--blue",Selected:ow+"--selected"},cw=iw+"__footer-item-container",dw=iw+"__footer-item",uw=iw+"__footer-item-separator";let hw="";function gw(e){e&&(e.stopPropagation(),e.preventDefault())}function mw(e,t){var s;const i=e.data;if(!i)return[];const n=(null===(s=i.UIContent)||void 0===s?void 0:s.userId)||"",r=[];if(n===Ce.default.sendToMeId){const e={id:"ShareToMyCloudButton",text:"STR_SEND2ME_SHARE",textArguments:[{textKey:"KEY_NAME_SEND2ME"}],handler:t.shareToMyCloud};return r.push(e),r}if(n===function(){if(!hw){const t=a.ModuleContainer.resolve(m.a);var e;t&&(hw=(null===(e=t.getSession())||void 0===e?void 0:e.userId)||"")}return hw}())return r;const o=Ii.default.isFriend(n);if(!(i.UIContent.type===UM.b.OA))if(o){if(Kl.d.isSupport()){const e={id:"CallButton",text:"STR_CONTACT_CARD_CALL_BTN",handler:t.makeCall};r.push(e)}}else{const e={id:"AddFriendButton",text:"STR_CONTACT_CARD_ADD_FRIEND_BTN",handler:t.addFriend};r.push(e)}const l={id:"ChatBtn",text:"STR_CONTACT_CARD_CHAT_BTN",handler:t.openChat,type:"secondary"};return r.push(l),r}function pw({item:e}){return rr.a.createElement("div",{className:cw,onClick:e.handler},rr.a.createElement(lr.a,{className:Object(lC.a)(dw,e.type&&dw+`--${e.type}`),textKey:e.text,textArguments:e.textArguments,textTransform:"capital-case"}))}function fw(e){const{items:t,isSelected:s,isSentFromMe:a,isShowShadow:i}=e;return rr.a.createElement("div",{className:Object(lC.a)(ow,a&&lw.Blue,s&&lw.Selected,i&&"shadow-bubble")},t.map(((e,t)=>rr.a.createElement(rr.a.Fragment,null,0!==t&&rr.a.createElement("div",{className:uw}),rr.a.createElement(pw,{key:e.id,item:e})))))}var vw=function(e){var t,s;const{data:a,isFocused:i,isHighlightedByPrivilegedUser:n,isMultiSel:r,MessageQuickActionRenderer:o,observeIntersectionForReading:l,selectedMsg:c={},windowId:d}=e,u=a.UIContent,h="0"===a.fromUid,g=Boolean(r&&c[a.msgId]),m=Boolean(r),p=null===(t=e.conversation)||void 0===t?void 0:t.userId,f=(null===(s=a.UIContent)||void 0===s?void 0:s.userId)||"",v=Ii.default.getDName(f)||(null==u?void 0:u.name)||"",_=rr.a.useRef(null);Object(kT.a)(_,l);const b=mw(e,{addFriend:e=>{if(m)return;gw(e);const{addFriend:t}=Object(q.c)();t&&t({userID:f,chatID:p,windowID:d})},makeCall:e=>{if(m)return;gw(e);const{makeVoiceCall:t}=Object(q.c)();t&&t({chatID:f,windowID:d})},openChat:e=>{if(m)return;gw(e);const{openChat:t}=Object(q.c)();t&&t({chatID:f,source:Q.a.MessageOnMessaging})},shareToMyCloud:e=>{if(m)return;gw(e);const{makeVoiceCall:t}=Object(q.c)();t&&t({chatID:f,windowID:d})}}),I=b.length>0;return rr.a.createElement(NT.a,{border:6,className:Object(lC.a)(nw,n&&(null==a.ttl||0==a.ttl)&&rw.HighlightFromPrivilegedUser,"rounded-6","focused-item",i&&"focused-item--highlight-border"),isAdmin:n,variant:"common",ttl:a.ttl},rr.a.createElement("div",{ref:_,"data-qId":Object(fe.g)(a),onContextMenu:function(t){if("function"!=typeof e.showContextMenu)return;e.showContextMenu({event:t,message:e.data})}},rr.a.createElement(aw.ContactCard,{className:Object(lC.a)("rounded-t-6","cursor-pointer",!I&&"rounded-b-6"),avatarURL:u.thumb,name:v,description:u.phone||u.oaShortLink,isSelected:g,QRCodeURL:u.QRCodeURL,type:u.type,onClick:e=>{if(!m)if(gw(e),f===Ce.default.sendToMeId){const{openChat:e}=Object(q.c)();e&&e({chatID:f})}else{const{openProfileModal:e}=Object(q.c)();e&&e({userId:f,selectConversationSource:178003})}},userId:u.userId}),I&&rr.a.createElement(fw,{items:b,isSelected:g,isSentFromMe:h,isShowShadow:!Boolean(a.ttl)}),o&&rr.a.createElement(o,null)))};var _w=function(e){const{className:t,data:s}=e;let a;return a=s.uidSenderDel?rr.a.createElement("div",null,s.uidSenderDel==Ii.default.getUidMe()||"0"==s.uidSenderDel?rr.a.createElement(lr.a,{textKey:"STR_ME_DEL"}):rr.a.createElement("span",null,Ii.default.getDName(s.uidSenderDel)),rr.a.createElement(lr.a,{textKey:"STR_DEL_EVERYONE_MSG"})):rr.a.createElement(lr.a,{textKey:"STR_DEL_EVERYONE"}),rr.a.createElement("div",{className:Object(lC.a)("dfe-message__container",t)},a)},bw=s("F1UR"),Iw=s("Wwxf"),yw=s("hIA4"),Sw=s("t77n"),Cw=s("ggG7"),Ew=s("/Z5y"),Ow=s("EIuX"),Mw=s("QMJy"),Tw=s("SzKC"),ww=s("yhYV");class Rw extends Tw.a{constructor(e){super(e),this.state=Object(I.a)({},this.state)}shouldComponentUpdate(e,t){return this.props.message.reacts!==e.message.reacts||this.props.shouldShowStatus!==e.shouldShowStatus||this.state.store.params!==t.store.params||this.props.message.status!==e.message.status||this.props.message.isLastMsg!==e.message.isLastMsg||this.props.message.isErrorInfo!==e.message.isErrorInfo||this.props.message.sendError!==e.message.sendError||this.props.onContextMenu!==e.onContextMenu||this.props.showInFolder!==e.showInFolder||this.props.className!==e.showInFolder}_loading(){return this._utils.loading({store:this.state.store,props:this.props})}render(){const{onContextMenu:e,onDoubleClick:t,onMouseOver:s,onMouseLeave:a,onTouchStart:i,onTouchEnd:n}=this.props,r={onMouseOver:s,onMouseLeave:a,onTouchStart:i,onTouchEnd:n},{fileIcon:o,fileThumb:l,fileTitle:c,fileTextInfo:d,fileActionDisplay:u,cloudDownloadingOrUploading:h,clickAction:g,isMe:m,notLoading:p}=this._loading();return p?rr.a.createElement(ww.a,Object(BS.a)({isMe:m},this.props)):rr.a.createElement("div",Object(BS.a)({className:"file-message-v2 file-message__container"},r,{onClick:g,onContextMenu:e,onDoubleClick:t}),l,rr.a.createElement("div-13",{className:"file-message__content-container",style:{minHeight:"49px"}},o,rr.a.createElement("div",{className:"file-message__content"},c,rr.a.createElement("div-13",{className:"file-message__content-info-container"},d,u),h)))}}var Lw=s("mE0M");function Dw(e){e&&(e.preventDefault(),e.stopPropagation())}function Aw(e,t){const s=rr.a.useMemo((()=>function(e){var t,s;const a=e.message||e.file;let i=""+a.msgId,n="0"==a.fromUid?J.p.getSessionUserId():a.fromUid;const r=Sw.a.utils.getPrimaryId(a),{FileChatModel:o}=Sw.a.models,l=Sw.a.getFileKey(r),c=Sw.a.get(l);let d=Object(Ow.o)(c);d||!a.isErrorInfo&&a.status!=Y.MSG_FAIL||a.cancelled||(d=a.subType&&23==a.subType?{strKey:"STR_ERR_UPLOAD_FILE_FOLDER_ERROR",strKeyParams:[]}:{strKey:"STR_ERR_UPLOAD_FILE_ERROR",strKeyParams:[]});const u=Sw.a.utils.getMessageFileParams(a),h=Object(SE.a)(u),g=(null==h?void 0:h.fdata)&&Object(SE.a)(null==h?void 0:h.fdata),m=null!==(t=null==g?void 0:g.upSrc)&&void 0!==t?t:a.upSrc,p=null!==(s=null==g?void 0:g.reader)&&void 0!==s?s:a.reader,f=null==a?void 0:a.originMsgType,v={fromUid:n,localPath:Sw.a.utils.getLocalPath(e),folderPath:Sw.a.utils.getFolderPath(e),sendTime:a.sendDttm,cancelUpload:a.cancelled,sendFileError:d,upSrc:m,reader:p,originMsgType:f};Object.keys(v).forEach((e=>void 0===v[e]&&delete v[e]));const _=new o({params:u,conversationId:Sw.a.utils.getMessageConversationId(a),fileUrl:Sw.a.utils.getFileMessageUrl(a),status:Sw.a.utils.getFileMessageStatus(a),indicatorState:Sw.a.utils.getFileMessageIndicatorState(a),extraInfo:v});return Sw.a.dispatch(o_.FileActionType.Init,{data:_,id:{p:r,s:i}}),r}(e)),[e.message.folderPath,e.message.localPath]),{windowId:a}=Object(SC.a)(),{setTrustedFileMsg:i}=e;e=Object(I.a)(Object(I.a)({},e),{},{pIdOrMsgId:s,windowKey:a});const{status:n,flag:r}=Object(Lw.a)(e.message),o=function(e){const{showActionInjectable:t,pIdOrMsgId:s}=e,a=Object(Cw.a)(e),i=Object(Ew.a)(s||"",Ow.j),n=Object(Ew.a)(s||"",Ow.i);return rr.a.useCallback((e=>null==t?void 0:t(e,{contextMenu:!0,message:a,localPath:i,folderPath:n})),[a,t,i,n])}(Object(I.a)(Object(I.a)({},e),{},{status:n,flag:r})),l=Object(Cw.a)(e);rr.a.useEffect((()=>{i&&i(l)}),[l,i]);const c=function(e){return Object(Mw.a)(e)}(Object(I.a)(Object(I.a)({},e),{},{status:n,flag:r}));return rr.a.createElement(Rw,Object(BS.a)({ref:t},e,{onContextMenu:o,onDoubleClick:Dw,showInFolder:c}))}var Fw=rr.a.memo(rr.a.forwardRef(Aw));var kw=rr.a.forwardRef((function(e,t){return rr.a.createElement(nC.a,null,rr.a.createElement(Fw,Object(BS.a)({},e,{ref:t})))}));const Nw=ui.default.isWeb();let Pw,jw;Nw||(Pw=s("Dprd").default,jw=$znode.path);var Uw=function(e){var t,s,i;const n=e.data,[r,o]=Object(nr.useState)(n.localPath||""),[l,c]=Object(nr.useState)(n.folderPath||""),[d,u]=Object(nr.useState)(!(null==n||!n.msgId)&&void 0!==(null===(t=Pw)||void 0===t?void 0:t.getDownloadProgress(n.msgId))),[h,g]=Object(nr.useState)(null!=n&&n.msgId&&(null===(s=Pw)||void 0===s?void 0:s.getDownloadProgress(n.msgId))||0),[m,p]=Object(nr.useState)(0),[f,v]=Object(nr.useState)(!1),[_,b]=Object(nr.useState)(!1);return Object(nr.useEffect)((()=>{(null==n?void 0:n.localPath)&&o(n.localPath),(null==n?void 0:n.folderPath)&&c(n.folderPath)}),[null==n?void 0:n.localPath,null==n?void 0:n.folderPath]),Object(nr.useEffect)((()=>{yw.a.getInstance().push(n,yw.b.chatview)}),[]),Object(nr.useEffect)((()=>{const e=(e,t)=>{if(e===ve.ChatBoxActions.FILEPATH_UPDATED){if(t.msgId!==n.msgId)return;t.localPath!==r&&o(t.localPath)}};return _e.default.subscribe(e),()=>{_e.default.unsubscribe(e)}}),[r,n.msgId]),Object(nr.useEffect)((()=>{var e;if(Nw)return;const t=n.msgId;null===(e=a.ModuleContainer.resolve(Re.a))||void 0===e||e.getMultiMedias("file",n.toUid,[t]).then((e=>{let s=e[0];s&&s.msgId===t&&(s.localPath&&o(s.localPath),s.folderPath&&c(s.folderPath),(s.localPath||s.folderPath)&&u(!1),s.downloadError&&v(!0))}))}),[n.msgId]),rr.a.createElement(kw,{windowId:e.windowId,conversation:e.conversation,isOnline:e.isOnline,dispatch:e.dispatch,emitter:e.emitter,uploadFiles:e.uploadFiles,uploadFilesNative:e.uploadFilesNative,scrollToBottom:e.scrollToBottom,message:n,userId:null===(i=e.user)||void 0===i?void 0:i.userId,senderName:function(){var t,s,a,i;if(null!==(t=e.conversation)&&void 0!==t&&null!==(s=t.userId)&&void 0!==s&&s.startsWith(Y.GROUPID_PREFIX))return null==e?void 0:e.senderName;return"0"==(null==n?void 0:n.fromUid)?null===(i=e.user)||void 0===i?void 0:i.displayName:null==e||null===(a=e.friendInfo)||void 0===a?void 0:a.displayName}(),localPath:r||"",folderPath:l||"",isDownloading:d,downloadProgress:h,progressInBytes:m,downloadError:f,showShareError:_,showInFolder:function(e){e.preventDefault(),e.stopPropagation(),Object(bw.default)(n),Ia.default.logAction(107190901)},manualDownload:function(e){e.preventDefault(),e.stopPropagation()},resendMessage:()=>{var t;null===(t=e.resendHandler)||void 0===t||t.call(e,n.resend,n)},showActionInjectable:(t,s)=>{!function(t,s){if("function"==typeof e.showContextMenu){const a=`openCtxMenu_File_${e.data.cliMsgId}`;Iw.a.stopAll(),Iw.a.for(a);const i={event:t,message:s.message,detail:{trackingCmdId:a,fileData:{localPath:s.localPath||r,folderPath:s.folderPath||l},fileHandler:{saveToDeviceHandler:(e,t)=>{"update"===e&&t.hasOwnProperty("isDownloading")&&u(t.isDownloading)}}}};e.showContextMenu(i)}}(t,s)}})},Bw=s("ymth");var zw=s("Hscn"),Gw=s("QG4v");const xw="bubble-message-retry-indicator-button",Vw={Block:xw,Modifiers:{black:"--black",grey:"--grey",sm:"--sm",md:"--md",lg:"--lg"},Elements:{RetryIcon:`${xw}__retry-icon`}},Hw=e=>{const{size:t="md",bg:s="black"}=e;return rr.a.createElement("div",{className:Object(lC.a)(Vw.Block,t&&Vw.Modifiers[t],s&&Vw.Modifiers[s],e.className),onContextMenu:e.onRetryContextMenu,onClick:e.onRetryClick},rr.a.createElement(MC.a,{className:Vw.Elements.RetryIcon,icon:"Retry_24_Line"}))},Ww=e=>{const t=t=>{var s;null===(s=e.onRetryClick)||void 0===s||s.call(e,t)};return rr.a.createElement("div",{className:Object(lC.a)("failed-overlaying-message-status-wrapper",e.show&&"--show")},e.show&&rr.a.createElement("div",{className:"failed-overlaying-message-status",onContextMenu:t=>{var s;null===(s=e.onRetryContextMenu)||void 0===s||s.call(e,t)},onClick:t},rr.a.createElement(Hw,{size:"lg",bg:"black",onRetryClick:t})),e.children)},qw=e=>rr.a.createElement("div",{className:Object(lC.a)("failed-side-message-status-wrapper",e.show&&"--show")},e.show&&rr.a.createElement("div",{className:"failed-side-message-status"},rr.a.createElement(Hw,{size:"sm",bg:"grey",onRetryClick:t=>{var s;null===(s=e.onRetryClick)||void 0===s||s.call(e,t)}})),e.children);var Kw=s("JyLG"),$w=s("s1dB");const Zw="bubble-message-sending-indicator-button",Qw={Block:Zw,Modifiers:{black:"--black",grey:"--grey",sm:"--sm",md:"--md",lg:"--lg"},Elements:{Loading:`${Zw}__loading`,Clock:`${Zw}__clock`}},Yw=e=>{const t=rr.a.useRef(null),s=rr.a.useMemo((()=>{let t=Kw.b;return"number"==typeof Ce.default.message_status.delay_show_sending&&Ce.default.message_status.delay_show_sending>=0&&(t=Ce.default.message_status.delay_show_sending),Ct.default.getTimeNow()-e.sendDttm<t}),[]),[a,i]=rr.a.useState(!s),{bg:n="black",size:r="md",type:o="loading"}=e;if(rr.a.useEffect((()=>(s&&(()=>{let e=Kw.b;"number"==typeof Ce.default.message_status.delay_show_sending&&Ce.default.message_status.delay_show_sending>=0&&(e=Ce.default.message_status.delay_show_sending),t.current=window.setTimeout((()=>{i(!0)}),e)})(),()=>{null!==t.current&&(window.clearTimeout(t.current),t.current=null)})),[]),!a)return null;const l="loading"===o?{size:"sm"===r?16:"md"===r?28:46,baseRingColor:"var(--WA100)",ringColor:"var(--NG70)",ringThick:"sm"===r?2:3}:{};return rr.a.createElement("div",{className:Object(lC.a)(Qw.Block,n&&Qw.Modifiers[n],r&&Qw.Modifiers[r]),onContextMenu:e.onSendingContextMenu,onClick:e.onSendingClick},"loading"===o?rr.a.createElement($w.a,Object(BS.a)({},l,{className:Qw.Elements.Loading})):rr.a.createElement(MC.a,{icon:"Clock_24_Line",className:Qw.Elements.Clock}))},Jw=e=>{const t=t=>{var s;null===(s=e.onSendingClick)||void 0===s||s.call(e,t)},s=t=>{var s;null===(s=e.onSendingContextMenu)||void 0===s||s.call(e,t)};return rr.a.createElement("div",{className:Object(lC.a)("local-overlaying-message-status-wrapper",e.show&&"--show")},e.show&&rr.a.createElement("div",{className:"local-overlaying-message-status",onContextMenu:s,onClick:t},rr.a.createElement(Yw,{type:"loading",size:"lg",bg:"black",sendDttm:e.sendDttm,onSendingContextMenu:s,onSendingClick:t})),e.children)},Xw=e=>{const t=t=>{var s;null===(s=e.onSendingClick)||void 0===s||s.call(e,t)};return rr.a.createElement("div",{className:Object(lC.a)("local-side-message-status-wrapper",e.show&&"--show")},e.show&&rr.a.createElement("div",{onClick:t,className:Object(lC.a)("local-side-message-status")},rr.a.createElement(Yw,{type:"clock",size:"sm",bg:"grey",sendDttm:e.sendDttm,onSendingClick:t})),e.children)},eR=e=>{const{msgStatus:t,type:s}=e;let a;if(t===Y.MSG_FAIL){const i=t===Y.MSG_FAIL;a="side"===s?rr.a.createElement(qw,{show:i,children:e.children,onRetryClick:e.onRetryClick}):rr.a.createElement(Ww,{show:i,children:e.children,onRetryContextMenu:e.onRetryContextMenu,onRetryClick:e.onRetryClick})}else{const i=t===Y.MSG_LOCAL;a="side"===s?rr.a.createElement(Xw,{show:i,sendDttm:e.sendDttm,children:e.children}):rr.a.createElement(Jw,{show:i,sendDttm:e.sendDttm,children:e.children,onSendingContextMenu:e.onSendingContextMenu})}return a};var tR=function(e){const{children:t,className:s,isSelected:a}=e;return t?rr.a.cloneElement(t,{style:t.props.style,className:Object(lC.a)(a&&"selected-message-overlay",s,t.props.className)}):rr.a.createElement(rr.a.Fragment,null)};const sR="gif-message__container",aR={HighlightFromPrivilegedUser:sR+"--highlight-from-privileged-user"};var iR=s("39bE"),nR=s("H/0Q");function rR(e){const t=e=>"string"==typeof e?e:"";return[t(null==e?void 0:e.oriUrl),t(null==e?void 0:e.normalUrl),t(null==e?void 0:e.thumbUrl)]}var oR=function(e){const{containerWidth:t,data:s,isFocused:a,isHighlightedByPrivilegedUser:i,isSelected:n=!1,observeIntersectionForReading:r}=e,[o,l]=rr.a.useState(s.localPath),c=rr.a.useRef(null),d=`${null==s?void 0:s.cliMsgId}.${null==s?void 0:s.fromUid}.${null==s?void 0:s.toUid}`;Object(kT.a)(c,r);const u=function(e,t=-1,s=0){const a=160+s,i=110,n=368;let r=Math.min(798,isNaN(t)?798:t);t<=-1&&(r=n);let o=!1;if(e.message&&e.message.params)try{let t=JSON.parse(e.message.params),s=-1,l=-1;if(s=e.width?e.width:t.width,l=e.height?e.height:t.height,void 0!==s&&null!=l||(s=n,l=n,o=!0),s>0&&l>0){let e=s,c=l;if(s<a&&l<i)c=i,e=a;else if(s>r&&l>n){let t=n/l;if(c=n,e=Math.round(s*t),e>r){t=r/e,e=r;let s=Math.round(c*t);c=Math.max(s,i)}e=Math.max(e,a)}else if(l>n){let t=n/l;c=n;let i=Math.round(s*t);e=Math.max(a,i)}else if(l>=i&&l<=n){if(s>r){let t=r/s;e=r;let a=Math.round(l*t);c=Math.max(i,a)}else if(s<a){e=a;let t=a/s,r=Math.round(l*t);c=Math.min(Math.max(i,r),n)}}else if(l<i){c=i;let t=i/l,n=Math.round(t*s);e=s>r?r:Math.min(Math.max(a,n),r)}return{height:c,width:e,defaultSize:o,rotation:t.rotation,flip:t.flip}}}catch(l){}return{width:n,height:n,defaultSize:!0}}(s,t-192),h=rR(s.message).map((e=>({src:e}))),g=rr.a.useMemo((()=>({backgroundColor:"transparent",borderRadius:"4px",height:u.height+"px",width:u.width+"px"})),[u.height,u.width]);async function m(){return Object(nR.a)(s)}return rr.a.createElement(eR,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},rr.a.createElement(tR,{isSelected:n},rr.a.createElement(NT.a,{border:6,className:Object(lC.a)(sR,i&&(null==s.ttl||0==s.ttl)&&aR.HighlightFromPrivilegedUser,"rounded-6","focused-item",a&&"focused-item--highlight-border"),isAdmin:i,variant:"common",ttl:s.ttl,style:{height:u.height+2+"px",width:u.width+2+"px"},onContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:e.data,detail:{handleManualDownloadSuccess:e=>{l(e)},handleUpdateFilePath:e=>{l(e)},localPath:o}};e.showContextMenu(s)}},rr.a.createElement("div",{ref:c,"data-qId":Object(fe.g)(s)},rr.a.createElement("div",{style:g},2===Tp.a.image_loader.version&&rr.a.createElement(iR.a.CenterBox,{className:"image-box",width:"100%",height:"100%"},rr.a.createElement(iR.a.Loader,{entry:np.k.MESSAGE_LIST,mediaId:d,srcs:h,retryWhenOnline:!0,useHttpsSource:!0},rr.a.createElement(iR.a.Image,null),rr.a.createElement(iR.a.LoaderErrorCatch,{expiryCheck:m,manualRetryOnClick:!0,render:e=>rr.a.createElement(iR.a.DefaultImageError,{mediaId:d,error:e,style:{width:"inherit",height:"inherit"}})}))),1===Tp.a.image_loader.version&&rr.a.createElement(Gw.a,{entry:np.k.MESSAGE_LIST,mediaId:d,urls:Object(zw.a)(rR(s.message)),imageStyle:g,status:s.status,expiryCheck:m}))))))},lR=s("blq4"),cR=s("O7EA"),dR=s("0cNv"),uR=s("OONb"),hR=s("UZOM");const gR=["CHAT_BOX_LIST_LOAD_MORE_2"];class mR extends rr.a.Component{constructor(e){super(e),this._timer=null,this.state={statusText:"CHAT_BOX_LIST_LOAD_MORE_1"}}componentDidMount(){const e=()=>{"function"==typeof this.props.onShow&&this.props.onShow()};this.props.delayedTime?(this.setConfigTimer(),this._timer=setTimeout((()=>{this.domRef&&(this.domRef.className=this.domRef.className.replace("hidden",""),this.props.updateShowSpinner&&this.props.updateShowSpinner(this.domRef.clientHeight),this._setStatusText(),e())}),this.props.delayedTime)):e()}shouldComponentUpdate(e,t){return this.state.statusText!==t.statusText}componentWillUnmount(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._clearTimerStatusText(),"function"==typeof this.props.onHide&&this.props.onHide()}setConfigTimer(){const e=Ce.default.cloud.loading_text_timer;this.arStatusConfig=[],e.length&&e.forEach(((e,t)=>{const s=t>1?1:t;e&&this.arStatusConfig.push({timer:parseInt(e),text:gR[s]})}))}_clearTimerStatusText(){this.setTextTimer&&(clearTimeout(this.setTextTimer),this.setTextTimer=null)}_setStatusText(){this._clearTimerStatusText();const e=this.arStatusConfig.shift();e&&e.timer&&e.text&&(this.setTextTimer=setTimeout((()=>{this.setState({statusText:e.text}),this._setStatusText()}),e.timer))}render(){const{statusText:e}=this.state,{isPinedTop:t=!1,title:s="",delayedTime:a,hideTitle:i=!1}=this.props;return rr.a.createElement("div",{ref:e=>this.domRef=e,className:`z-chat-loading ${a?"hidden":""} ${t?"z-chat-loading-pined":""}`,id:""+(t?"z-chat-loading-pined":""),style:{paddingBottom:i?0:void 0}},rr.a.createElement(uR.a,{className:`chat-loading-icon ${this.props.outerClassname}`,size:this.props.size,style:this.props.style}),i?null:rr.a.createElement(lr.a,{className:"z-chat-loading__text "+this.props.outerClassname,textKey:s||e}))}}mR.defaultProps={outerClassname:""};var pR=Object(hR.a)(mR,97128),fR=s("ncjs"),vR=s("qJfJ"),_R=s("dGAM"),bR=s("1PLK"),IR=s("30XY"),yR=s("/sDj"),SR=s("QQLV"),CR=s("UFGt"),ER=s("YbIt"),OR=s("J0AE");const MR={bigThumb:{width:375,height:212},smallThumb:{width:64,height:64}};function TR(){const e=Ce.default.message_bubble.link.big_thumb_width_threshold;return isNaN(Number(e))?380:e}function wR(){Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.SETTINGS,params:{data:{tab:cR.f.MESSAGES}},forceCloseAll:!0})}var RR=function(e){var t,s;null===(t=e.quickMessageActionFunc)||void 0===t||t.call(e,{localPath:"",folderPath:"",downloadFileFunc:()=>{}});const a=e.data,i=null==a?void 0:a.message,n=Object(nr.useRef)(hr.c);n.current=e.windowId||n.current;const r=Object(nr.useRef)(!(!i||!i.thumb)&&-1!==Object.values(ui.DEFAULT_THUMB_URLS).indexOf(i.thumb)),o=Object(nr.useRef)(null),[l,c]=Object(nr.useState)(function(){const e=w();if(void 0!==e)return e;return!(r.current||null==i||!i.thumb)||!(null!=i&&i.href&&(ui.default.checkGoogleDriveLinks(i.href)||ui.default.isThumbFail(i.thumb)))}()),[d,u]=Object(nr.useState)(!1),[h,g]=Object(nr.useState)(Me.g.getYoutubePreview(e.userId)),[m,p]=Object(nr.useState)(!0),[f,v]=Object(nr.useState)(MR.bigThumb),_=Object(lR.a)((()=>{var t;if(!l)return;let s;if(void 0===(s=null===(t=o.current)||void 0===t?void 0:t.clientWidth))return;let a;if(a=e.containerWidth&&e.containerWidth-200>MR.bigThumb.width?MR.bigThumb.width:s,void 0===a)return;const i=9*a/16;a===(null==f?void 0:f.width)&&i===(null==f?void 0:f.height)||v({width:a,height:i})}),200);Object(nr.useEffect)((()=>{let e;return _e.default.subscribe(R),_(),o.current&&(e=new ResizeObserver((()=>{_()})),e.observe(o.current)),()=>{var t;_e.default.unsubscribe(R),null===(t=e)||void 0===t||t.disconnect()}}),[]),Object(nr.useEffect)((()=>{_()}),[e.containerWidth]),Object(nr.useEffect)((()=>{!function(){if(l&&null!=i&&i.thumb){let[,e]=E.g.safeParseJson(i.params);e&&e.width?e.width<TR()&&c(!1):me.a.MediaSizeParserManager.parseAsync(i.thumb).then((t=>{let s=t;if(s&&"number"==typeof s.width&&"number"==typeof s.height){s.width<TR()&&c(!1);const t=Ce.default.file_photo_limit;if(s.width<=t.width&&s.height<=t.height){const t=Object(I.a)({},a);t.status!==Y.MSG_LOCAL&&t.status!==Y.MSG_FAIL&&(e.width=s.width,e.height=s.height,t.message.params=JSON.stringify(e),we.default.updateMessageParams(t.msgId,{width:e.width,height:e.height},t))}else u(!0)}else c(!1)})).catch((()=>{c(!1)}))}}()}),[null==i?void 0:i.thumb]);let b={};if(""!==(null==a||null===(s=a.message)||void 0===s?void 0:s.params))try{var y;b=JSON.parse(null==a||null===(y=a.message)||void 0===y?void 0:y.params)}catch(j){return ui.default.logCoreError(j),rr.a.createElement("div",{className:e.className},e.displayName,rr.a.createElement("div",null,"Tin nhn khng hin th c"),e.sendTime)}let S=e.className||"";S+=" card--link"+(l?" has-big-thumb":"");const C=function(){let e=null;if(h){var t;const s={width:"640",height:"360"},i=null==a||null===(t=a.message)||void 0===t?void 0:t.href;let n=null;switch(b.src){case _R.a.mp3Src:case _R.a.mp3SrcNewBeta:case _R.a.mp3SrcNew:n=_R.b.getMp3CodeFromUrl(i),s.height="180";break;case _R.a.youtubeShortlinkSrc:case _R.a.youtubeSrc:n=_R.b.getYoutubeCodeFromUrl(i);break;case _R.a.soundcloudSrc:n=_R.b.getSoundCloudUrl(i)}n&&(e=rr.a.createElement(fR.a,{className:"video-youtube__frame",scrolling:"no",width:s.width,height:s.height,src:n,frameBorder:"0",allowFullScreen:!1,additionalSandboxPolicy:"allow-presentation"}))}return e}(),O=a.status===Y.MSG_LOCAL,M=!$r.default.isMultiURL(null==i?void 0:i.title,!0,null),T="0"===(null==a?void 0:a.fromUid)&&((null==a?void 0:a.isLastMsg)?"div_LastSentMsg_Link":"div_SentMsg_Link")||(null==a?void 0:a.isLastMsg)&&"div_LastReceivedMsg_Link"||"div_ReceivedMsg_Link";return rr.a.createElement("div",{id:P(),className:"link-message-v2 "+S,"data-id":T,onContextMenu:k},e.displayName,rr.a.createElement(vR.a,{urgency:null==a?void 0:a.urgency}),function(){var t,s,r,c,u;const h=null==a||null===(t=a.message)||void 0===t?void 0:t.href,g="string"==typeof h?ui.default.extractDomain(h):"",v=(null==a||null===(s=a.message)||void 0===s?void 0:s.description)||"",_=v.split("..."),y=!(null==a||!a.extra||!a.extra.todoInfo||ui.default.isEmptyObject(a.extra.todoInfo)||1!==(null===(r=we.default.getTaskSetting())||void 0===r?void 0:r.ui_v2)),S=(null==a||null===(c=a.message)||void 0===c?void 0:c.title)||"",E=Object(OR.a)(S,e);let T=rr.a.createElement("div",null,E?rr.a.createElement("div",{style:M?{marginBottom:"8px"}:{},className:"text",onDoubleClick:F},function(e){if(!e)return null;const t=e.props.children?e.props.children:[];return rr.a.createElement(e.type,e.props,t&&t.length>0?t:null)}(E)):null,M?rr.a.createElement("div",{id:N(),onContextMenu:k,onDoubleClick:F},null!=C&&!0!==y?rr.a.createElement("div",{key:"player",className:"flx flx-al-s "+(null!=C?" video-youtube":"")+" clickable"},rr.a.createElement("div",{className:"video-youtube__config"},rr.a.createElement("i",{className:"video-youtube__config__btn fa fa-chat-video-icon-setting",onClick:wR}),n.current==hr.c&&rr.a.createElement("i",{className:"video-youtube__config__close fa fa-chat-video-icon-float",onClick:D})),C):!0===y?null:rr.a.createElement("div",{key:"player",className:"flx flx-al-s card--link-content text-is-card-link"+(null!=C?" video-youtube":"")+" clickable"+(l&&!d?" has-big-thumb":""),onClick:L},rr.a.createElement("div",{ref:o,style:{width:l?"100%":void 0}},function(){if(M&&Boolean(""!==(null==i?void 0:i.thumb)&&!d)){if(void 0===w())return null;const e=l?f:MR.smallThumb;return m?rr.a.createElement("div",{className:"card--link-loading card--link-img flx flx-center flx-al-c",style:Object(I.a)({},e)},rr.a.createElement(pR,{hideTitle:!0,delayedTime:1e3})):null}return null}(),rr.a.createElement("div",{className:Object(lC.a)("card--link-container",d&&"card--link-container--error"),style:{visibility:m?"hidden":"visible",overflow:"hidden",height:m?0:"auto"}},function(){let t=null;if(M&&Boolean(""!==(null==i?void 0:i.thumb)&&!d)){var s,r;const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId,c=l?f:MR.smallThumb;t=rr.a.createElement(ER.a,{key:"link-thumb",ctxWindow:window,enableCheckSize:!0,windowId:n.current,entry:"MESSAGE_LIST",className:"card--link-img",thumbUrl:i.thumb,width:"number"==typeof(null==c?void 0:c.width)?c.width:0,height:"number"==typeof(null==c?void 0:c.height)?c.height:0,mediaId:`${a.cliMsgId}.${a.fromUid}.${a.toUid}`,localPathMapper:async(e,t)=>await Object(CR.b)(o,a.msgId,e,O&&i.href)||"",conversationId:o,msgId:a.msgId,containerWidth:e.containerWidth||0,onLoad:()=>{p(!1)},onError:A,renderError:()=>rr.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c",style:Object(I.a)({},c)})})}else t=rr.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c"});return t}())),rr.a.createElement("div-15",{key:"link-content",className:Object(lC.a)("card-content",d&&"ml-0")},rr.a.createElement("span-b14",{className:"card-title on-hover"},b.mediaTitle||h),v&&(null==a||null===(u=a.message)||void 0===u||!u.title||a.message.title&&"string"==typeof a.message.title&&a.message.title.indexOf(_[0])<0)?rr.a.createElement("span-14",{className:"card--link__sub clp clp--two"},v):null,rr.a.createElement("span-13",{className:"card--link__src clp clp--one"},b.src||g)))):null);!0===y&&(T=rr.a.createElement(dR.a,{windowId:n.current,data:null==a?void 0:a.extra.todoInfo,htmlInner:T,user:{userId:e.userId},confirm:e.confirm,dispatch:e.dispatch,focusId:e.focusId}));return T}(),e.isLast||M?rr.a.createElement("div",{className:"flx"},e.sendTime,e.thread):null,e.msgAction,e.reaction);function w(){let e;try{e=JSON.parse(i.params)}catch(j){}if(e&&"number"==typeof e.width)return e.width>=TR()}function R(e,t){e===ve.GeneralActions.CHANGE_YOUTUBE_PREVIEW&&g(t)}function L(t){var s,r;t.preventDefault(),t.stopPropagation();const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId;Ce.default.cloud_send2me.enable&&o==Ce.default.sendToMeId&&yR.b.log(yR.a.OPEN,1,a);const l=(null==i?void 0:i.href)||"",c=Tl.a.parseUriInApp(l);if(Ce.default.groupLinkRegEx.test(l))Ie.ModalManagerV2.openModal({windowId:n.current,name:Y.ModalIdentitiesDefine.GROUP_PREVIEW,params:l});else if(SR.a.checkLinkZaloShop(l)){var d;SR.a.setLinkOpen(l),null===(d=e.dispatch)||void 0===d||d.call(e,{type:ve.SideBarActions.SELECT_TAB_ZALO_SHOP})}else if(IR.b.isCatalogProductLink(l)){var u,h,g;const t=null==o?void 0:o.startsWith(Y.GROUPID_PREFIX);null===(u=e.emitter)||void 0===u||u.emit(ve.GeneralActions.OPEN_MEDIA_BOARD,{type:ve.GeneralActions.OPEN_LINK_CATALOG,uid:null!==(h=e.chatId)&&void 0!==h?h:null===(g=e.conversation)||void 0===g?void 0:g.userId,url:l,src:e.isOA?33:t?31:30}),Ia.default.logActionInfoV2(Ia.FeaturesInfo.BusinessCatalog,1,{source:1})}else c?Tl.a.handleUriAction(c,e.dispatch,o||null,(()=>bR.b.open(l))):bR.b.open(l,!0,!1,null,n.current)}function D(t){var s,i,n,r;t.preventDefault(),t.stopPropagation();const o=JSON.parse(null==a||null===(s=a.message)||void 0===s?void 0:s.params),l={id:null==a?void 0:a.msgId,title:o.mediaTitle||(null==a||null===(i=a.message)||void 0===i?void 0:i.description),artist:o.artist,original:o.mediaTitle,url:null==a||null===(n=a.message)||void 0===n?void 0:n.href,src:o.src,originalMessage:a};null===(r=e.dispatch)||void 0===r||r.call(e,{type:ve.PopupActions.MP3_PREVIEW,payload:l})}function A(){c(!1),u(!0),p(!1)}function F(e){e.preventDefault(),e.stopPropagation()}function k(t){if("function"!=typeof e.showContextMenu)return;const s=`openCtxMenu_Link_${e.data.cliMsgId}`;Iw.a.stopAll(),Iw.a.for(s);const a={event:t,message:e.data,detail:{trackingCmdId:s,linkMessageContainerId:P(),linkContentContainerId:N()}};e.showContextMenu(a)}function N(){return`link-content-container_${a.cliMsgId}_${a.fromUid}_${a.toUid}`}function P(){return Y.UIMessagePrefixElementID.LinkMessage+Object(fe.j)(a)}},LR=s("dbb5"),DR=s("Qd2S");const AR="location-message",FR=AR+"__container",kR={Blue:FR+"--blue",Focusing:FR+"--focusing",Selected:FR+"--selected",HighlightFromPrivilegedUser:FR+"--highlight-from-privileged-user"},NR=AR+"__map-container",PR=AR+"__map",jR=AR+"__marker-icon-container",UR=AR+"__marker-icon",BR=AR+"__info-container",zR=AR+"__info-title-container",GR={Center:zR+"--center"},xR=AR+"__info-description-container";function VR(e){const{isUserLocation:t,senderAvatarURL:s}=e;return t?rr.a.createElement("div",{className:jR},rr.a.createElement("div",{className:UR,style:{backgroundImage:"url('"+s+"')"}})):null}var HR=function(e){const{latitude:t,longitude:s,onClick:a}=e;let i="";return 1===Ce.default.map_embeded_mode?i="https://maps.google.com/maps?ll="+t+","+s+"&z=14&output=embed":2===Ce.default.map_embeded_mode&&Ce.default.map_api_key&&(i=`https://www.google.com/maps/embed/v1/view?key=${Ce.default.map_api_key}&center=${t},${s}&zoom=14`),i?rr.a.createElement("div",{className:NR,onClick:e=>{a&&a(e)}},rr.a.createElement(VR,e),rr.a.createElement(fR.a,{additionalSandboxPolicy:"allow-presentation",className:PR,src:i,frameBorder:0,marginHeight:0,marginWidth:0,scrolling:"no",style:{pointerEvents:"none"}})):null},WR=s("AM4K");function qR(e){return"https://maps.google.com/maps?q="+e.latitude+","+e.longitude+"&z=14&t=m&mapclient=embed"}var KR=function(e){const{latitude:t,longitude:s,onClick:a}=e,i=qR({latitude:t,longitude:s});return rr.a.createElement("div",null,WR.a.getHtmlFromText(i,!0,a))};function $R(e){const{data:t,senderName:s}=e,a=t.UIContent,i="0"===t.fromUid,n=Boolean(a.isUserLocation);return Object(LR.b)(),rr.a.createElement("div",{className:BR},rr.a.createElement("div",{className:Object(lC.a)(zR,n&&GR.Center)},rr.a.createElement("span",null,function(e,t,s,a){return t?s?le.a.str("STR_MY_LOCATION"):le.a.str("STR_LOCATION_OF")+` ${a}`:e}(a.title,n,i&&n,s))),!n&&rr.a.createElement("div",{className:xR},rr.a.createElement("span",null,a.description)))}function ZR(e){const{data:t,senderAvatar:s,windowId:a}=e,i=t.UIContent,n=(e,t)=>{e.stopPropagation(),e.preventDefault(),null==t&&(t=qR({latitude:i.latitude,longitude:i.longitude})),bR.b.open(t,!1,!0,null,a)},r=Boolean(i.isUserLocation),o=HR({isUserLocation:r,latitude:i.latitude,longitude:i.longitude,onClick:n,senderAvatarURL:s||""});return null==o?rr.a.createElement(KR,{latitude:i.latitude,longitude:i.longitude,onClick:n}):rr.a.createElement(rr.a.Fragment,null,o,rr.a.createElement($R,e))}var QR=function(e){const{data:t,isHighlightedByPrivilegedUser:s,isFocused:a,isMultiSel:i,selectedMsg:n={},observeIntersectionForReading:r}=e,o="0"===t.fromUid,l=i&&n[t.msgId],c=rr.a.useRef(null);Object(kT.a)(c,r);const d=Object(DR.a)((()=>Y.UIMessagePrefixElementID.LocationMessage+Object(fe.j)(t))),u=Object(DR.a)((t=>{"function"==typeof e.showContextMenu&&e.showContextMenu({event:t,message:e.data})}));return rr.a.createElement(NT.a,{border:6,className:Object(lC.a)(FR,o&&kR.Blue,l&&kR.Selected,s&&(null==t.ttl||0==t.ttl)&&kR.HighlightFromPrivilegedUser,!Boolean(t.ttl)&&"shadow-bubble","rounded-6","focused-item",a&&"focused-item--highlight-border"),isAdmin:s,variant:"common",ttl:t.ttl},rr.a.createElement("div",{ref:c,"data-qId":Object(fe.g)(t),id:d(),onContextMenu:u},rr.a.createElement(ZR,e)))};var YR=s("oxAw"),JR=s("REbt"),XR=s("KRIz"),eL=s("OkKQ"),tL=s("fjQr"),sL=s("h9Os"),aL=s("Ena7"),iL=s("x/O3"),nL=s("dI1f"),rL=s("aKpv"),oL=s("9+7Y"),lL=s("sOq/"),cL=s("TtXJ"),dL=s("qtre");function uL(e){return e.reduce(((e,t)=>(t&&e.indexOf(t)<0&&e.push(t),e)),[])}var hL=s("GSHM");a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.chatList,["ImageMessageV2"]);const gL="img-msg-v2",mL=`${gL}__bub`,pL=`${gL}__bub--audit`,fL=`${gL}__cap`,vL=`${gL}__st`,_L=`${gL}__err`,bL=`${gL}__ft`,IL=rr.a.forwardRef(((e,t)=>{var s,i,n,r,o,l;const{windowId:c,ctxWindow:d,message:u,containerWidth:h,containerHeight:g=90,isSignAdminMsg:m,isFocused:p,showContextMenu:f,onFilePathUpdated:v,observeIntersectionForReading:_}=e,b=J.p.getSessionUserId()===u.fromUid||0==u.fromUid,y=null==u||null===(s=u.message)||void 0===s?void 0:s.title,S=!!y,C=Object(fe.j)(u),E=Y.UIMessagePrefixElementID.ImageMessage+C,O=Y.UIMessagePrefixElementID.ImageMessageCaption+C,M=Object(SE.a)(null==u||null===(i=u.message)||void 0===i?void 0:i.params),{width:T,height:w}=Object(iL.f)(M),R=(null==u?void 0:u.toUid)||(null==u?void 0:u.userId),L=`${u.cliMsgId}.${u.fromUid}.${R}`,{failure:D}=Object(iL.g)(L,np.k.MESSAGE_LIST),A=Object(iL.l)(L,D,j),F=rr.a.useRef(null);Object(kT.a)(F,_),Object(nr.useEffect)((()=>{lp.c.log(u.cliMsgId,{originalWidth:T,originalHeight:w})}),[]);let k=Object(XR.a)((e=>{f({event:e,message:u,detail:{localPath:"",captionContainerElementId:O}})}));const N=Object(eL.a)(null,Object(Ld.f)(u)===Y.MSG_E2EE),P=((e,t)=>{if(null!=u&&null!==(e=u.message)&&void 0!==e&&null!==(t=e.oriUrl)&&void 0!==t&&t.startsWith("blob:")){var s,a;const e=null==u||null===(s=u.resend)||void 0===s||null===(a=s.content)||void 0===a?void 0:a.photos;if(e){const t=e[0];return{oriUrl:null==t?void 0:t.img,file:null==t?void 0:t.file,width:t.width,height:t.height,clientId:u.cliMsgId,blobUrl:null==t?void 0:t.img}}}})();function j(){return Object(cL.a)(u)}const U=null==M?void 0:M.hasOwnProperty("hd"),B=Object(hL.a)(M),{conWidth:z,conHeight:G,mediaWidth:x,mediaHeight:V}=Object(iL.c)({containerWidth:h,containerHeight:g,width:T,height:w,mediaId:`${u.cliMsgId}.${u.fromUid}.${R}`,vOrient:u.vOrient,mayEnforceSinglePhotoCaption:{hasCaption:S,captionLength:null==y?void 0:y.length}}),[H,W,q,K,$]=function(e){const t=rr.a.useRef();t.current=e;const[[s,i],n]=rr.a.useState([!0,!0]),r=rr.a.useCallback((function(e,s){if(s.stopPropagation(),t.current.isMultiSel){const e=Object(I.a)({},t.current.message),{selectedMsg:a,onChooseMsg:i}=t.current;if(a.hasOwnProperty(t.current.message.msgId)){const e=a[t.current.message.msgId];n([!1,!1]),i(e,s)}else e&&e.message&&(e.message=Object(I.a)({},(null==e?void 0:e.message)||{}),n([!0,!0]),i(e,s))}else e===SL&&t.current.imageClickHandler&&t.current.imageClickHandler(s)}),[]),o=rr.a.useCallback((function(e){var s,a;t.current.isMultiSel&&null!==(s=t.current.message)&&void 0!==s&&null!==(a=s.message)&&void 0!==a&&a.title&&r(CL,e)}),[]),l=rr.a.useCallback((function(e){var s,i;if((null===(s=t.current)||void 0===s||null===(i=s.message)||void 0===i?void 0:i.status)==Y.MSG_FAIL){var n,o,l,c,d;if(a.ModuleContainer.resolve(zc.b).verifySetting({field:"lockSendMsg",convId:null===(n=t.current)||void 0===n||null===(o=n.message)||void 0===o?void 0:o.toUid,showNoti:{windowId:null===(l=t.current)||void 0===l?void 0:l.windowId,type:"TOAST",config:{textKey:Object(zc.d)(null===(c=t.current)||void 0===c||null===(d=c.message)||void 0===d?void 0:d.toUid),type:be.TOAST_TYPE.ERROR,noBackground:!0},triggerValue:!0}}))return}r(SL,e)}),[]),[[c,d],u]=rr.a.useState([!1,!1]);return rr.a.useEffect((()=>{var e,a;const n=!(null===(e=t.current.message)||void 0===e||null===(a=e.message)||void 0===a||!a.title);t.current.selectedType!==Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL?t.current.selectedType!==Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_PARTIAL?u([!1,!1]):u([i,n&&s]):u([!0,n])}),[i,s,e.selectedType]),rr.a.useDebugValue(c,d),[e.isMultiSel,c,d,l,o]}(e);let Z=Object(oL.a)(u);const Q=b&&(e.message.isLastMsg?"div_LastSentMsg_Photo":"div_SentMsg_Photo")||e.message.isLastMsg&&"div_LastReceivedMsg_Photo"||"div_ReceivedMsg_Photo",X=Object(nL.d)(u),ee=Object(lC.a)("chatImageMessage--audit",gL,y&&"-caption",b&&"-me",u.status==Y.MSG_FAIL&&"-fail",H&&"-multi-select",m&&"-admin",X&&"-promote-btn","photo-message-v2",!u.ttl&&"shadow-bubble","focused-item",p&&"focused-item--highlight-border"),te={"--thumb-cw":`${z}px`},se=ui.default.getConversationType(R),ae=rr.a.useMemo((()=>new oe.c(oe.a.ChatBoxView).getBuilder().withType(oe.f.Photo).withMode(oe.e.Manual).withCode(oe.d.CBVMessage).withConvType(oe.b[se]).build()),[]),ie=rr.a.useCallback(((e,t)=>Object(CR.a)(R,u.msgId,e,t)),[R,u.msgId]),ne=P||u.status!==Y.MSG_LOCAL&&u.status!==Y.MSG_FAIL,re=(()=>{const e=null==u?void 0:u.message,t=wp.g(null==e?void 0:e.oriUrl),s=!!e.normalUrl&&e.oriUrl!==e.normalUrl,a=t||s?()=>ie(e.normalUrl,np.n.normalUrl):void 0,i=()=>pp.a.ZaloDownload_Photo(R,Object(pp.d)({cliMsgId:u.cliMsgId,fromUid:u.fromUid,toUid:R})),n={url:e.oriUrl,getLocalPath:e=>ie(e,np.n.oriUrl),originalWidth:T,originalHeight:w,maxDimension:Ce.default.image_loader.max_normal,regenId:"normal",priority:1,quality:np.n.normalUrl};return 2===Tp.a.image_loader.version?uL([e.normalUrl,e.hdUrl,e.oriUrl]).map((e=>({src:e,downloadConfig:{getLocalPath:i,downloadEntrySerial:ae,sendDttm:u.sendDttm,getOldLocalPathForMigration:a},regenerateFromSource:n}))):Object(zw.a)(uL([e.normalUrl,e.hdUrl,e.oriUrl]),{regenerateFromSource:n,getLocalPath:i,getOldLocalPathForMigration:a})})();Object(Dy.r)({message:u,needReload:!!Z,reloadImage:()=>{2!==Tp.a.image_loader.version?a.ModuleContainer.resolve(Qp.b).manualRetry(L,np.k.MESSAGE_LIST):a.ModuleContainer.resolve(Qp.b).loadImage({mediaId:L,entry:np.k.MESSAGE_LIST,srcs:re})}});const le=()=>{const e=(null==u?void 0:u.msgType)===Y.MSG_VIDEO,t=`${sL.a}__cap-v2`;return rr.a.createElement(lr.a,{className:t,textKey:e?"STR_VIDEO_UNAVAILABLE":"STR_PHOTO_UNAVAILABLE"})},ce=()=>{const e=(null==u?void 0:u.msgType)===Y.MSG_VIDEO;return rr.a.createElement(sL.b,{key:`chatImageMessageError-${L}`,className:sL.a,caption:le(),isVideo:e})},de=m&&!Boolean(u.ttl)?4:6,ue=!Z&&A!==np.e.ExpiredSource,he=(null==u?void 0:u.msgType)===Y.MSG_DOODLE;return rr.a.createElement("div",{ref:e=>{F.current=e,null==t||t(e)},id:E,className:ee,"data-id":Q,"data-qId":Object(fe.g)(u),style:te,key:`cim-${L}`,onDragStart:N,onContextMenu:k},rr.a.createElement(NT.a,{ttl:y&&u.ttl,isAdmin:m,variant:"photo",border:6},rr.a.createElement("div",{className:Object(lC.a)(mL,pL,y?" --capt":"",X?" --promote":"",m&&!Boolean(u.ttl)&&mL+"--highlight-from-privileged-user")},rr.a.createElement(eR,{type:"overlay",msgStatus:u.status,sendDttm:u.sendDttm,onRetryClick:t=>{var s;t.preventDefault(),t.stopPropagation(),null===(s=e.resendMessage)||void 0===s||s.call(e,t,u)}},rr.a.createElement(NT.a,{ttl:!y&&(null==u?void 0:u.ttl),isAdmin:m,variant:"photo",border:6},rr.a.createElement(JR.a,{selected:W},Z?rr.a.createElement(Dy.e,{style:{width:z,height:G},msgIds:[null==u?void 0:u.msgId],windowId:c,type:"photo",disableEvents:H,entry:lL.a.CSC,message:u,devSrc:"ImageMessage"}):rr.a.createElement("div",{onClick:e=>{null==e||e.preventDefault(),null==e||e.stopPropagation();[Y.MSG_LOCAL,Y.MSG_FAIL].includes(u.status)||[np.e.ErrorSource,np.e.NetworkError].some((e=>e===A))||K(e)}},2===Tp.a.image_loader.version&&rr.a.createElement(iR.a.CenterBox,{className:"bg-color",width:z,height:G,style:{borderRadius:de}},ne&&rr.a.createElement(iR.a.Loader,{mediaId:L,entry:"MESSAGE_LIST",srcs:re,retryWhenOnline:!0,placeholder:u.previewThumb,uploadSource:P,showDevOnlyJxlIndicator:wp.g(null==u||null===(n=u.message)||void 0===n?void 0:n.oriUrl),enableDOMCache:iR.a.CachingMode.enabled},rr.a.createElement(iR.a.Image,{className:Object(lC.a)("fit_contain",{"is-doodle":he}),width:x,height:V}),rr.a.createElement(iR.a.LoaderErrorCatch,{enableDebugInfo:!0,expiryCheck:j,manualRetryOnClick:!0,subscribedUIErrors:ne?iR.a.Errors.ExpiredSource:iR.a.Errors.All,style:{width:"100%",height:"100%"},render:e=>(null==u?void 0:u.status)!==Y.MSG_FAIL&&ne?e===np.e.ExpiredSource?ce():rr.a.createElement(tL.a,{className:_L}):null}))),1===Tp.a.image_loader.version&&rr.a.createElement(aL.a,{mediaId:L,entry:"MESSAGE_LIST",status:u.status,containerSize:{width:z,height:G},mediaSize:{width:x,height:V},previewThumb:u.previewThumb,isUpload:null==u||null===(r=u.message)||void 0===r||null===(o=r.oriUrl)||void 0===o?void 0:o.startsWith("blob:"),uploadSource:P,loadStrategy:{type:"Lazy",config:{windowId:c,ctxWindow:d}},urls:re,fetchStrategy:{fetcher:a.ModuleContainer.resolve(Sp.c).fetch,diskCacheConfig:{downloadEntrySerial:ae}},preloadStrategy:"Async",onFilePathUpdated:v,expiryCheck:j,hasHd:U,sendDttm:null==u?void 0:u.sendDttm,renderError:({mediaId:e,errorCode:t,reload:s})=>t===np.e.ExpiredSource?ce():rr.a.createElement(tL.a,{className:_L,onClick:s}),showDevOnlyJxlIndicator:wp.g(null==u||null===(l=u.message)||void 0===l?void 0:l.oriUrl)}),X?rr.a.createElement(nL.c,{style:{maxWidth:"100%"},windowId:c,convId:u.toUid||"",fromUid:u.fromUid}):null,rr.a.createElement(rL.b,{entry:rL.a.csc,message:u,devSrc:"ImageMessage"}))))),ue&&rr.a.createElement(dL.a,{key:`qualityBadge-${L}`,badgeName:B}),rr.a.createElement(JR.a,{selected:q},rr.a.createElement("div",{className:bL,onClick:$},y&&rr.a.createElement("div",{id:O,className:fL},rr.a.createElement(vR.a,{urgency:u.urgency}),function(e){const{message:t,renderHtmlMessage:s,forceShowCardBtnTitle:a}=e;if(a){let e=YR.a.getMessageReact();if(e)return function(e,t,s){YR.a.showReactBtnForKey(null==s?void 0:s.msgId);let a=(null==e?void 0:e.style)||{},i=null==e?void 0:e.message,n=null==i?void 0:i.items;return rr.a.createElement("div",null,rr.a.createElement("div",{style:Object(I.a)({userSelect:"none",display:"flex",justifyContent:"center"},a.txtContainer||{})},null!=n&&n.length?rr.a.createElement("div",{style:{whiteSpace:"pre-wrap"}},n.map(((e,t)=>function(e,t){return e?rr.a.createElement("span",{style:Object(I.a)({whiteSpace:"pre-wrap"},e.s||{})},e.t):null}(e)))):null),0!=s.fromUid&&null!=i&&i.btn?rr.a.createElement("div",{className:"seasonal__template__bubble__textv2",onClick:e=>{e.stopPropagation(),e.preventDefault(),YR.a.clickReactBtn(s)},style:a.styleContainer},a.icon?rr.a.createElement("i",{className:a.icon+" seasonal__template__bubble__text_icon",style:a.styleIcon}):null,rr.a.createElement("div",{className:"seasonal__template__bubble__text_content",style:a.styleText},t)):null)}(e,a,t)}return s()}(e)),e.sendTime?rr.a.createElement("div",{className:vL},rr.a.createElement(e.sendTime,null)):null)))))}));var yL=rr.a.memo(IL);const SL="IMAGE",CL="TITLE";var EL=function(e){var t,s,a;const i=e.data,n=null===(t=e.conversation)||void 0===t||null===(s=t.userId)||void 0===s?void 0:s.startsWith(Y.GROUPID_PREFIX);let r="";var o;(null==i?void 0:i.msgType)===Y.MSG_PHOTO&&null!=i&&null!==(a=i.message)&&void 0!==a&&a.title&&(r=YR.a.isCardTitle(null==i||null===(o=i.message)||void 0===o?void 0:o.title,n));const l=e.focusId&&(null==i?void 0:i.msgId)&&e.focusId.indexOf(i.msgId)>=0&&1===e.focusType;return rr.a.createElement(yL,{windowId:e.windowId||"",ctxWindow:e.selfWindow||window,containerWidth:e.containerWidth||0,message:i,imageClickHandler:e.imageClickHandler||(()=>{}),renderHtmlMessage:()=>{var t;return Object(OR.a)((null==i||null===(t=i.message)||void 0===t?void 0:t.title)||"",e)},selectedType:e.selectedType,forceShowCardBtnTitle:r,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel||!1,onChooseMsg:e.onChooseMsg,isSignAdminMsg:e.isHighlightedByPrivilegedUser||!1,highlight:l||!1,isFocused:e.isFocused,onFilePathUpdated:e.onFilePathUpdated||(()=>{}),showContextMenu:e.showContextMenu,resendMessage:e.resendMessage,sendTime:e.SentTimeCompRenderer,observeIntersectionForReading:e.observeIntersectionForReading})},OL=s("/PwA"),ML=s("oRa2"),TL=s("5tQl"),wL=s("oNsl"),RL=s("7fJY"),LL=s("Wb+/"),DL=s("9/5/"),AL=s.n(DL),FL=s("x0gP"),kL=s("yfqh"),NL=s("IMYd"),PL=s("GzlV"),jL=s("116d"),UL=s("ADT0"),BL=s("apzQ"),zL=s("yhZf"),GL=s("yyM+"),xL=s("z+wX"),VL=s("pWOx");const HL=ui.default.isWeb();let WL,qL;HL||(WL=s("Dprd").default,qL=$znode.path);class KL extends rr.a.Component{constructor(e){super(e),this._handleUpdateLayoutConfig=e=>{BL.a.updateConfig(Object(I.a)({},e)),this.setState((t=>Object(I.a)(Object(I.a)({},t),{},{layoutConfig:Object(I.a)(Object(I.a)({},t.layoutConfig),e)})))},this.isCloud=e=>!(!e||"string"!=typeof e||e!==Ce.default.sendToMeId),this.windowId=e.windowId||hr.c,this.imageLocalPath={},this.state={checkedLocalPath:!1,resetLayout:!1,forceRender:!1,layoutConfig:BL.a.config},this.limitShowDynamic=Ce.default.dynamic_layout_photo.total_limit,this.border=4,Ce.default.dynamic_layout_photo&&!0!==GL.a.media_group_layout.enable&&this.props.photos&&this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.focusedElement=[],this._groupPhotoRowRefs=new Map,this.selectedPhoto={},this._onFilePathUpdated=this._onFilePathUpdated.bind(this),this.findPhotoByIdInGroup=this.findPhotoByIdInGroup.bind(this),this.onResize=ui.default.throttle((()=>{var e;if(1==GL.a.media_group_layout.enable)return this.maxWidth=this.computeMaxWidth(),void this.setState({forceRender:!this.state.forceRender});(null===(e=this.props.photos)||void 0===e?void 0:e.length)<4&&(this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.setState({forceRender:!this.state.forceRender}))}),500),this.enableFileStoreComp=wL.a.isActivated("enable_file_store_comp"),this.localedPhotosRef=rr.a.createRef(),this.localedPhotosRef.current=[]}_equalSendTime(e,t){return!e&&!t||!(!e&&t||!t&&e)&&(!(!e||!t)&&e.key==t.key)}shouldComponentUpdate(e,t){var s,a,i,n,r,o,l,c,d,u;return!this.props.photos.equals(e.photos)||!this._equalSendTime(this.props.sendTime,e.sendTime)||this.props.className!==e.className||!ui.default.arraysEqual(this.props.focusId,e.focusId)||this.state.resetLayout!==t.resetLayout||this.state.checkedLocalPath!==t.checkedLocalPath||this.props.isSelected!==e.isSelected||this.state.forceRender!==t.forceRender||this.props.isMultiSel!==e.isMultiSel||this.props.selectedMsg!==e.selectedMsg||this.props.isMouseMoveSelecting!==e.isMouseMoveSelecting||this.props.containerWidth!==e.containerWidth||this.props.focusedMessageId!==e.focusedMessageId||(null===(s=this.state.layoutConfig)||void 0===s?void 0:s.scaleFactor)!==(null===(a=t.layoutConfig)||void 0===a?void 0:a.scaleFactor)||(null===(i=this.state.layoutConfig)||void 0===i?void 0:i.containerWidth)!==(null===(n=t.layoutConfig)||void 0===n?void 0:n.containerWidth)||(null===(r=this.state.layoutConfig)||void 0===r?void 0:r.targetItemHeight)!==(null===(o=t.layoutConfig)||void 0===o?void 0:o.targetItemHeight)||(null===(l=this.state.layoutConfig)||void 0===l?void 0:l.borderRadius)!==(null===(c=t.layoutConfig)||void 0===c?void 0:c.borderRadius)||(null===(d=this.state.layoutConfig)||void 0===d?void 0:d.spacing)!==(null===(u=t.layoutConfig)||void 0===u?void 0:u.spacing)}componentWillMount(){var e;this.props.selfWindow.addEventListener("resize",this.onResize),this.emitter=null===(e=this.context.zemitter)||void 0===e?void 0:e.on(UL.a.UPDATE_LAYOUT_CONFIG,this._handleUpdateLayoutConfig),ui.default.log("image-group-message: Mount");const t=this.props.message;t&&t.msgId&&t.message&&t.message.length&&VL.a.startLoad(t.msgId,t.message)}componentWillUpdate(e){this.props.photos.equals(e.photos)||!0===GL.a.media_group_layout.enable||this.props.photos.length!==e.photos.length&&this.props.message&&(TL.default.disableGroupPhotoSkeleton(this.props.message),this._preGridPhoto(e.photos),this.maxWidth=this.computeMaxWidth(e)),e.containerWidth!==this.props.containerWidth&&(this.maxWidth=this.computeMaxWidth(e))}componentDidMount(){for(let[e,t]of this._groupPhotoRowRefs.entries()){const s=sp.a.getInViewController(this.windowId);null==s||s.observe(t,{identifier:e,onIntersect:this.props.onMsgIntersect.bind(null,e),threshold:.9})}this.mountCallback(this.props.focusHandler)}componentWillUnmount(){this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.cacheId&&TL.default.deleteCache(this.cacheId)),this.props.selfWindow.removeEventListener("resize",this.onResize),ui.default.log("image-group-message: componentWillUnmount");for(let[e,t]of this._groupPhotoRowRefs.entries()){const e=sp.a.getInViewController(this.windowId);null==e||e.unobserve(t)}this.emitter.remove(),VL.a.onUnmount(this.props.message.msgId)}componentWillReceiveProps(e){if(this.props.focusId!==e.focusId&&(this.focusedElement=[]),e.selectedMsg&&0!==Object.keys(e.selectedMsg).length){var t,s;const a={};null===(t=this.props.message)||void 0===t||null===(s=t.message)||void 0===s||s.forEach((t=>{e.selectedMsg[t.msgId]&&(a[t.msgId]=!0)}));let i=!1;const n=Object.keys(this.selectedPhoto),r=Object.keys(a);if(n.length!==r.length)i=!0;else for(const e of r)if(!this.selectedPhoto[e]){i=!0;break}i&&(this.selectedPhoto=a,this.setState({forceRender:!this.state.forceRender}))}else this.selectedPhoto={}}componentDidUpdate(e,t){var s;(this.mountCallback(this.props.focusHandler),e.photos.length!==this.props.photos.length)&&VL.a.onReLayout(null===(s=this.props.message)||void 0===s?void 0:s.msgId)}computeMaxWidth(e){var t,s,a,i,n,r;e=null!==(t=e)&&void 0!==t?t:this.props;let o=(null!==(s=null!==(a=null===(i=this.props)||void 0===i?void 0:i.containerWidth)&&void 0!==a?a:null===(n=this.props.selfWindow.document.getElementById("messageViewContainer"))||void 0===n?void 0:n.clientWidth)&&void 0!==s?s:400)-170;const l=this.gridPhotoMap?TL.default.getLengthSkeleton(this.gridPhotoMap):this.props.photos.length;return(l<4&&!(null!==(r=e.photos)&&void 0!==r&&r.length)<4||l<Ce.default.dynamic_layout_photo.total_limit)&&(o=Math.min(o,450)),o=this.gridPhotoMap&&this.gridPhotoMap.length==TL.default.getLengthSkeleton(this.gridPhotoMap)?Math.min(o,335):Math.min(o,450),o}mountCallback(e){if(ui.default.log("image-group-focus: not mounted"),this.focusedElement&&this.focusedElement.length){let t=[],s=[];this.focusedElement.forEach((e=>{e.element&&(s.push(e.messageID),t.push({ele:e.element,ref:null}))})),e(s,t,null,!0)}}_onFilePathUpdated(e,t){var s;(null==e?void 0:e.status)<Y.MSG_SENT||e&&e.msgId&&(this.imageLocalPath[e.msgId]=t,this.setState({checkedLocalPath:!this.state.checkedLocalPath}),(e.msgType===Y.MSG_VIDEO||e.subType===Y.MSG_SUBTYPE_MEDIA_VIDEO||e.msgType===Y.MSG_PHOTO)&&(null===(s=a.ModuleContainer.resolve(Re.a))||void 0===s||s.updateMedia("image",e.toUid,e.msgId,{localPath:t},["localPath"]),we.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t},["localPath"],this.props.conversation.userId),this.props.dispatch({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:e})))}_resendMessage(e,t,s={}){this.props.resendMessage(e,t)}_showInFolder(e,t){t&&(t.preventDefault(),t.stopPropagation());let s=this.imageLocalPath[e.msgId];WL&&s&&WL.fileExists(s).then((t=>{t?WL.showInFolder(s):(Wo.default.createError(le.a.str("STR_TOAST_FILE_NOT_FOUND")),this.imageLocalPath[e.msgId]="",this.setState({checkedLocalPath:!this.state.checkedLocalPath}))})),Ia.default.logAction(107190903)}_onDownloadFileDone(e,t,s,a=!0,i=""){if(!e&&ui.default.isWindows()&&(s||i)){const e=Date.now();Ce.default.recent_photo.enableFeature&&ui.default.isWindows()&&Oe.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:e,name:qL.basename(s),shortenPath:ui.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})}}showAction(e,t){t&&(t=Object(RL.a)(t),this.props.showMessageAction(e,!0,t,this.imageLocalPath[t.msgId],this._resendMessage.bind(this),this._showInFolder.bind(this,t),(e=>{if(e&&(e.preventDefault(),e.stopPropagation()),!HL&&t&&(t.msgType===Y.MSG_PHOTO||t.msgType===Y.MSG_DOODLE||t.msgType===Y.MSG_VIDEO)&&t.message.oriUrl){var s;const e=t.msgType===Y.MSG_VIDEO?tt.default.constants.DownloadType.Video:tt.default.constants.DownloadType.Photo;let a=ui.default.getConversationType(null===(s=this.props.conversation)||void 0===s?void 0:s.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(t.msgType===Y.MSG_VIDEO?oe.f.Video:oe.f.Photo).withMode(oe.e.Manual).withCode(oe.d.CBVPhotoGr).withConvType(oe.b[a]).build();ue.a.downloadWithMultiSrc("runByMsg",t,{entry:i,type:e,options:{srcAction:tt.default.constants.srcAction.Manual,saveAs:!0,showProgress:{progressBar:!1,taskBar:!0},duplicate:!1}}).then((e=>{this.setState({isDownloading:!1});const{isFolder:s,savePath:a}=e||{};let i=s?"":a,n=s?n:"";this._onDownloadFileDone(!1,t&&t.msgId,i,!1,n)})).catch((e=>{this._onDownloadFileDone(e)}))}})))}_extractThumbUrl(e){return ui.default.removeProtocol(e&&e.message&&e.message.thumbUrl)}_renderDuration(e){if(!e||isNaN(e))return null;let t=Math.round(e/1e3),s=Math.floor(t/60);return t-=60*s,ui.default.strPadLeft(s+"","0",2)+":"+ui.default.strPadLeft(t+"","0",2)}_onClickNoPhoto(e){}_preGridPhoto(e){if(this.isDynamicLayout=this.props.photos.length<=this.limitShowDynamic,e&&e.length){const t=Sw.a.utils.safeParseJSON(e[0].message.params);let s=null;const a=e=>{this.gridPhotoMap=TL.default.genSkeleton(e,this.props.message.msgId)};if(null!=t&&t.group_layout_id&&(this.cacheId=t.group_layout_id+"_"+e[0].fromUid,s=TL.default.getGroupPhotoSkeleton(this.cacheId)),s){let i=TL.default.normalizeSkeleton(s),n=TL.default.getLengthSkeleton(i);this.hasSkeleton=!0,i&&n>=e.length?(n>e.length&&!this.timeoutSkeleton?this.timeoutSkeleton=setTimeout((()=>{TL.default.getLengthSkeleton(this.gridPhotoMap)!==this.props.photos.length&&(TL.default.deleteCache(t.group_layout_id+"_"+e[0].fromUid),a(this.props.photos),this.hasSkeleton=!1,this.setState({forceRender:!this.state.forceRender}))}),Ce.default.time_clear_cache_skeleton_group_photo):n==e.length&&this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.timeoutSkeleton=null),this.gridPhotoMap=i,this.isDynamicLayout=n<=this.limitShowDynamic):a(e)}else this.hasSkeleton=!1,a(e)}}findPhotoByIdInGroup(e){if(this.hasSkeleton){for(let s of this.props.photos)try{let t=JSON.parse(s.message.params);if(t.id_in_group>=0&&t.id_in_group==e)return s}catch(t){ui.default.logCoreError("show dynamic layout",t)}return null}return this.props.photos[e]}extractDimensions(e){return e.map((e=>{var t;let s=90,a=90;const i=Sw.a.utils.safeParseJSON(null==e||null===(t=e.message)||void 0===t?void 0:t.params);s=+(null==i?void 0:i.width)||+(null==i?void 0:i.video_width),a=+(null==i?void 0:i.height)||+(null==i?void 0:i.video_height),(isNaN(s)||s<=0)&&(s=np.b),(isNaN(a)||a<=0)&&(a=np.b);const n=null!=i&&i.hasOwnProperty("video_width")||null!=i&&i.hasOwnProperty("video_height")?"video":"image";return{width:s,height:a,group_layout_id:null==i?void 0:i.group_layout_id,type:n}}))}getGroupImageMessageContainerID(){return Y.UIMessagePrefixElementID.GroupImageMessage+Object(fe.j)(this.props.message)}render(){var e;ui.default.log("image-group-message: render "+this.props.photos.length),this.focusedElement=[];let t=Object(lC.a)(this.props.className,"card--group-photo","-bg-v-"+Ce.default.image.bg_v),s=0,a=!1,i=0,n=[],r={};n=this.extractDimensions(this.props.photos),r=PL.a.layout(n,{aspectRatio:this.state.layoutConfig.aspectRatio,containerWidth:this.state.layoutConfig.containerWidth,borderRadius:this.state.layoutConfig.borderRadius,spacing:this.state.layoutConfig.spacing,targetItemHeight:this.state.layoutConfig.targetItemHeight,isCloud:this.isCloud(null===(e=this.props.conversation)||void 0===e?void 0:e.userId)});const o=Math.min(this.maxWidth,this.state.layoutConfig.containerWidth,r.width),l=Math.min(o/r.width,1)||1;r=PL.a.fullLayoutScale(r,l),s<Object.keys(this.selectedPhoto).length&&(this.reMapSelected=!0,s=0);let c=(e=>!e.message||!e.message.every((e=>e.msgType===Y.MSG_UNDO||e.msgType===Y.MSG_DEL_EVERYONE)))(this.props.message),d=null,u=this.props.sendTime?null:this.props.thread,h=this.props.message.fromUid===this.props.userId||"0"===this.props.message.fromUid,g="thread-photo-ico thr-photo"+(this.props.message.root>0&&!this.props.message.refMessageId?" rootmsg":"");c?(d=!this.props.isMultiSel&&u?rr.a.createElement("div",{className:"rl-react-thread"},this.props.reaction,rr.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):u?rr.a.createElement("div",{style:{height:16}},this.props.reaction,rr.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):rr.a.createElement("div",{style:this.props.sendTime?{height:16}:void 0},this.props.reaction),Object(zL.a)().ENABLE_REACTION_V2&&(d=null)):d=null;const m="0"===this.props.photos[0].fromUid&&([...this.props.photos].pop().isLastMsg?"div_LastSentMsg_GrpPhoto":"div_SentMsg_GrpPhoto")||[...this.props.photos].pop().isLastMsg&&"div_LastReceivedMsg_GrpPhoto"||"div_ReceivedMsg_GrpPhoto";let p=null;if(Object(zL.a)().ENABLE_REACTION_V2&&1==GL.a.media_group_layout.enable&&r&&r.layout){var f,v,_,b;const e=180,t=r.layout[r.layout.length-2],s=r.layout[r.layout.length-1],i=(null==t?void 0:t.y)!==(null==s?void 0:s.y),n=(null==s?void 0:s.width)||0;a=0==this.props.message.fromUid||i&&n<e;const o={position:"absolute",left:s.x+s.width,bottom:0};null===(f=(v=this.props).changeReactionPosition)||void 0===f||f.call(v,{left:s.x+s.width,bottom:4}),null===(_=(b=this.props).toggleReactionSpace)||void 0===_||_.call(b,a),p=rr.a.createElement("div",{style:o},this.props.reaction)}return rr.a.createElement("div",{className:t,"data-id":m},this.props.displayName,rr.a.createElement("div",{id:"album-container",style:{position:"relative"}},rr.a.createElement(jL.a,{layout:r,renderItem:({rowId:e,position:t,style:a})=>{let n=this.props.photos[i],r=!1;this.isDynamicLayout&&(n=this.findPhotoByIdInGroup(i));let o=t.width,l=t.height,c=a.objectFit,d=(n&&ui.default.removeProtocol(n.message.oriUrl),n?ui.default.removeProtocol(n.message.thumbUrl):null),u=(n&&ui.default.removeProtocol(n.message.normalUrl),null),h=e=>{if(e.stopPropagation(),!this.props.isMultiSel||this.props.isMouseMoveSelecting){if(!this.props.isMultiSel){if(n.msgType===Y.MSG_VIDEO){[].push(n);const e={user:this.props.user,selectedId:n.msgId,oriUrl:n.message.oriUrl,userId:this.props.userId,isVideo:n.msgType===Y.MSG_VIDEO||2===n.subType,message:n,conversation:this.props.conversation,isMessageConv:!0,images:this.props.photos,iconMap:Dd.b.getIconMap(),appConfig:Object(Ce.getPVConfigs)()};return void me.a.OpenPhoto.openPhotoViewer(e)}this.props.onClickImage(n)}}else{if(this.props.selectedMsg.hasOwnProperty(this.props.message.msgId)){let t=!1,s=Object.assign({},this.props.selectedMsg[this.props.message.msgId]);for(let a=0;a<s.message.length;a++){let i=s.message[a];if(i.msgId==n.msgId){s.message.splice(a,1),delete this.selectedPhoto[i.msgId],s.message.length&&Object.keys(this.selectedPhoto).length?this.props.increaseCountMsg&&!ui.default.isPreventCountSelectMessage(i)&&this.props.increaseCountMsg(-1):(this.props.onChooseMsg(s,e),this.selectedPhoto={},t=!0),this.setState({forceRender:!this.state.forceRender});break}if(a==s.message.length-1){this.props.increaseCountMsg&&!ui.default.isPreventCountSelectMessage(n)&&this.props.increaseCountMsg(1)&&(s.message.push(n),this.selectedPhoto[n.msgId]=!0,this.setState({forceRender:!this.state.forceRender}));break}}t||this.props.onMultiSelGroupPhoto(this.props.message.msgId,s)}else{let t=Object.assign({},this.props.message);for(let e=0;e<t.message.length;e++){let s=t.message[e];if(s.msgId==n.msgId){t.message=[s],this.selectedPhoto[n.msgId]=!0,this.setState({forceRender:!this.state.forceRender});break}}this.props.onChooseMsg(t,e)}e.preventDefault()}},g=this.props.isMultiSel&&n&&this.selectedPhoto.hasOwnProperty(n.msgId);g&&s++;let m=!1;var p;void 0!==this.props.focusedMessageId&&(m=(null===(p=n)||void 0===p?void 0:p.msgId)===this.props.focusedMessageId);let f="row_"+i;if(n){if(n.msgType===Y.MSG_UNDO||n.msgType===Y.MSG_DEL_EVERYONE)u=rr.a.createElement(NT.a,{border:8,isAdmin:this.props.isHighlightedByPrivilegedUser,variant:"photo",ttl:n.ttl},rr.a.createElement("div",{key:"gimgu_"+n.cliMsgId,onClick:this.props.isMultiSel?h:this._onClickNoPhoto.bind(this),style:{width:o,height:l,borderRadius:"0px",textAlign:"center"},className:Object(lC.a)("card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center","recalled-bg-color","0"==n.fromUid?" me":"",g?" selected-overlay":"")},rr.a.createElement("i",{className:"fa fa-icon-outline-picture recalled-icon-color",style:{fontSize:"var(--f24)"}}),rr.a.createElement(lr.a,{className:"recalled-text-color",style:{fontSize:"var(--f14)"},textKey:n.msgType===Y.MSG_UNDO?"STR_RECALLED":"STR_DEL_EVERYONE_GROUP_PHOTO"})));else if(n.status===Y.MSG_FAIL);else if(n.msgType===Y.MSG_PHOTO){var v,_;FL.a.logActionMediaCaption(this.props.conversation,n,o),kL.a.logOldLayoutAction(this.props.conversation,n,i,{width:o,height:l,fit:"cover"});const e={overflow:"hidden",width:o,height:l,borderRadius:"0px",objectFit:c};u=rr.a.createElement("div",{className:Object(lC.a)("chat-message-picture__photooverlay",g&&"selected-overlay","no-shadow-border",n.message.hdUrl&&!this.props.isMultiSel&&!this.enableFileStoreComp&&"card--picture__high-definition-group"),key:`msg_photo-${n.cliMsgId}`,style:e},rr.a.createElement(NL.a,{windowId:this.windowId,ctxWindow:this.props.selfWindow,key:n.cliMsgId,groupPhotoId:(null===(v=this.props.message)||void 0===v?void 0:v.msgId)||"",onClick:h,onClickCapture:e=>{Object(xL.b)(n,xL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(xL.b)(n,xL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},message:n,isMultiSelect:this.props.isMultiSel,onFilePathUpdated:e=>this._onFilePathUpdated(n,e),containerWidth:o,containerHeight:l,width:e.width,height:e.height,objectFit:e.objectFit,total:null===(_=this.props.photos)||void 0===_?void 0:_.length}))}else if(n.msgType===Y.MSG_VIDEO){if(FL.a.logActionMediaCaption(this.props.conversation,n,o),kL.a.logOldLayoutAction(this.props.conversation,n,i,{width:o,height:l,fit:"cover"}),Ce.default.e2ee.debug.show_indicator_video_v2&&Ce.default.stagingAccount&&_d.b.getMsgE2eeStatus(n)===Y.MSG_E2EE){const e=n.message.oriUrl;r="2"===ui.default.getQueryParamFromUrl(e,"version")}u=rr.a.createElement(ML.a,{onClick:h.bind(this),onClickCapture:e=>{Object(xL.b)(n,xL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(xL.b)(n,xL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},selectedPhoto:g,key:n.cliMsgId,className:"card--group-photo__row__item__img card--group-photo__row__item__video clickable "+("0"==n.fromUid?" me":""),style:{width:o,height:l,borderRadius:"0px"},userId:this.props.userId,indexInGroup:i,cacheFolderName:"Cache",src:d,message:n,msgId:n.msgId,onFilePathUpdated:(e,t)=>this._onFilePathUpdated(n,t),conversation:this.props.conversation})}}else u=rr.a.createElement("div",{key:"msg_skeleton",style:{width:o,height:l,borderRadius:"0px",textAlign:"center"},className:"card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center"+(g?" selected-overlay":"")});let b=null;return Ce.default.e2ee.debug.show_msg_src&&Ce.default.stagingAccount&&(b=_d.b.getMsgE2eeStatus(n)===Y.MSG_E2EE),i++,rr.a.createElement(ZL,{key:f,ancestorProps:this.props,content:u,focusedElement:this.focusedElement,groupPhotoRowRefs:this._groupPhotoRowRefs,height:l,isDynamicLayout:this.isDynamicLayout,isItemFocused:m,isOnFocusedMode:this.props.isMultiSel,mClickAction:h,msgSrcDev:b,photo:n,resendMessage:this._resendMessage.bind(this),selectedPhoto:g,showAction:this.showAction.bind(this),showVideov2Indicator:r,style:a,width:o})},scaleFactor:this.state.layoutConfig.scaleFactor}),p),d,a&&this.props.reactionV2Space,this.props.sendTime)}}KL.contextType=Ao.a,KL.propTypes={userId:oC.a.string.isRequired};var $L=KL;function ZL(e){const{ancestorProps:t,content:s,focusedElement:a,groupPhotoRowRefs:i,height:n,isDynamicLayout:r,isItemFocused:o,isOnFocusedMode:l,key:c,mClickAction:d,msgSrcDev:u,photo:h,resendMessage:g,selectedPhoto:m,showAction:p,showVideov2Indicator:f,style:v,width:_}=e,b=rr.a.useRef(null);return Object(kT.a)(b,t.observeIntersectionForReading),rr.a.createElement("div",{key:c,className:Object(lC.a)("album__item","card--group-photo","card--group-photo-v2","focused-background",o&&" focused-background--focused"),ttl:null==h?void 0:h.ttl,isAdmin:t.isSignAdminMsg,width:_,height:n,style:v},rr.a.createElement("div",{key:c,ref:e=>{b.current=e,h&&i.set(h.msgId,e),h&&t.focusId.indexOf(h.msgId)>=0&&a.push({messageID:h.msgId,element:e})},className:Object(lC.a)("card--group-photo__row__item",!r&&"no-dynamic","focused-item",o&&"focused-item--highlight-border focused-item--animation focused-item--higher-index"),"data-component":Y.DataAttributes.Component.PHOTO,"data-qId":Object(fe.g)(h),style:{width:_,height:n,borderRadius:v.borderRadius,zIndex:l?3:null},onContextMenu:e=>p(e,h)},u?rr.a.createElement("i",{style:Object(I.a)(Object(I.a)({position:"absolute",fontSize:10,top:3,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3}),className:"fa fa-icon-solid-lock-2"}):null,f?rr.a.createElement("i",{style:Object(I.a)(Object(I.a)({position:"absolute",fontSize:14,top:2,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3})},"v2"):null,rr.a.createElement(eR,{type:"overlay",msgStatus:h.status,sendDttm:h.sendDttm,onRetryClick:e=>g(e,h,{fromBubble:!0})},s),(h&&h.loadSrc,null),l?rr.a.createElement("div",{className:"select-btn",style:{lefImgLoaderCtx:"5px",top:"6px"},onClick:d},rr.a.createElement("i",{className:m?"fa fa-multiselect_checkbox_hover selected-msg ":" fa fa-multiselect-stroke-checkbox unselect-msg"}),m?null:rr.a.createElement("i",{className:"fa fa-multiselect_checkbox_hover hover-unselected-msg"})):null))}const QL=new u.default({maxSize:20});const YL=Object(LL.a)(KL,((e,t,s)=>{var a;const i=null===(a=t.message)||void 0===a?void 0:a.cliMsgId;if(!i)return void e();const n=function(e){if(QL.has(e))return QL.get(e);let t=AL()((e=>e()),300,{maxWait:1e3}),s={batch:(e,s,a)=>{var i,n,r;(null===(i=s.photos)||void 0===i?void 0:i.length)>1&&(null===(n=s.photos)||void 0===n?void 0:n.length)!==(null==a||null===(r=a.photos)||void 0===r?void 0:r.length)?t(e):(t.cancel(),e())}};return QL.set(e,s),s}(i);n.batch(e,t,s)}));var JL=function(e){var t,s;const a=e.data,i=Ce.default.image.enable_image_group_batch?YL:$L,n=Object(OL.b)(),r=rr.a.useMemo((()=>{var e;if(void 0!==(null==n||null===(e=n.state)||void 0===e?void 0:e.focusedMessageId)&&Array.isArray(null==a?void 0:a.message)){const e=a.message.find((e=>e.msgId===n.state.focusedMessageId));if(e)return e.msgId}}),[null==n||null===(t=n.state)||void 0===t?void 0:t.focusedMessageId,null==a?void 0:a.message]);return rr.a.createElement(i,{showMessageAction:(t,s,a,i,n,r,o,l,c,d)=>{if("function"==typeof e.showContextMenu){const s={event:t,message:a,detail:{localPath:i,resendFunc:n,showInFolder:r,downloadFunc:o,onExtension:l,indexOAChild:c,folderPath:d}};e.showContextMenu(s)}},userId:null===(s=e.user)||void 0===s?void 0:s.userId,user:e.user,conversation:e.conversation,photos:null==a?void 0:a.message,replyMessage:e.replyMessage,deleteMessage:e.deleteMessage,recallMessage:e.recallMessage,shareMessage:e.shareMessage,resendMessage:e.resendMessage,onClickImage:e.onClickImage,focusId:e.focusId,focusType:e.focusType,focusedMessageId:r,message:a,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel,isSelected:e.isSelected,isMouseMoveSelecting:e.isMouseMoveSelecting,onMultiSelGroupPhoto:e.onMultiSelGroupPhoto,onChooseMsg:e.onChooseMsg,dispatch:e.dispatch,increaseCountMsg:e.increaseCountMsg,onMsgIntersect:()=>{},isSignAdminMsg:e.isAdmin,selfWindow:e.selfWindow||window,windowId:e.windowId,changeReactionPosition:e.changeReactionPosition,toggleReactionSpace:e.toggleReactionSpace,containerWidth:e.containerWidth,isHighlightedByPrivilegedUser:e.isHighlightedByPrivilegedUser,focusHandler:e.focusHandler,observeIntersectionForReading:e.observeIntersectionForReading})};var XL=function(e){const t=e.data,[s,i]=Object(nr.useState)(null==t?void 0:t.localPath),n=Object(nr.useRef)(null);rr.a.useEffect((()=>{yw.a.getInstance().push(t,yw.b.chatview)}),[]);let r=Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;null!=t&&t.msgId&&e.isSelected&&e.selectedMsg&&e.selectedMsg[t.msgId]&&(r=e.selectedMsg[t.msgId].multipleSelectedType||Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const o=Object(I.a)(Object(I.a)({},e),{},{imageClickHandler:function(s){if(!t||null!=t&&t.isErrorInfo)return;s&&s.stopPropagation();n.current&&(clearTimeout(n.current),n.current=null);n.current=setTimeout((()=>{var s,a;n.current&&clearTimeout(n.current),n.current=null,null===(s=e.onClickImage)||void 0===s||s.call(e,t),Ce.default.cloud_send2me.enable&&(null===(a=e.conversation)||void 0===a?void 0:a.userId)==Ce.default.sendToMeId&&yR.b.log(yR.a.OPEN,1,t)}),200)},onFilePathUpdated:function(s){i(s),function(e,t,s,i){if(!e)return;if(e.status<Y.MSG_SENT)return;const n=a.ModuleContainer.resolve(Re.a),r=e.toUid;e.msgType===Y.MSG_FILE&&(e.localPath=t,e.folderPath=s,n.updateFile(r,e.msgId,{localPath:t,folderPath:s},["localPath","folderPath"])),e.msgType!==Y.MSG_VIDEO&&e.msgType!==Y.MSG_PHOTO||n.updateMedia("image",r,e.msgId,{localPath:t},["localPath"]),we.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t,folderPath:s},["localPath","folderPath"],r),null==i||i({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:e})}(t,s,void 0,e.dispatch)},selectedType:r});return(null==t?void 0:t.msgType)===Y.MSG_PHOTO||(null==t?void 0:t.msgType)===Y.MSG_DOODLE?rr.a.createElement(EL,o):(null==t?void 0:t.msgType)===Y.MSG_PHOTO_GROUP?rr.a.createElement(JL,o):null};var eD=s("NuRm"),tD=s("9hee");var sD=function(e){const{conversation:t,data:s,isFocused:a,observeIntersectionForReading:i}=e,n=Object(YS.a)(),r=Object(YS.b)(),o=Object(eD.a)(),l=rr.a.useRef(null);Object(kT.a)(l,i);const c=Object(DR.a)(((t,s)=>{if("function"!=typeof e.showContextMenu)return;const a={event:t,message:e.data,detail:{indexOAChild:s}};e.showContextMenu(a)}));return rr.a.createElement(tD.a,{containerRef:l,oaContextMenu:c,className:"card",content:s.message,dispatch:n,conversation:t,emitter:r,isFocused:a,message:s,windowId:o})};const aD=e=>{if(!e)return null;let t=null;try{var s;let a="string"==typeof e?JSON.parse(e):"object"==typeof e?e:null;null!=a&&a.params&&("string"==typeof a.params?t=JSON.parse(a.params):"object"==typeof a.params&&(t=a.params)),null!==(s=t)&&void 0!==s&&s.thumbUrl||(t=null)}catch(a){t=null}return t},iD=e=>e===Y.MSG_UNDO,nD=e=>e===Y.MSG_DEL_EVERYONE,rD=e=>(e=>e===Y.MSG_FAIL)(e)||(e=>e===Y.MSG_LOCAL)(e);let oD=function(e){return e.DEFAULT="default",e.STICKER="sticker",e.NEW_FSS_STICKER="new-fss-sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const lD=(e,t)=>nD(e.msgType)?oD.DEL_EVERYONE:iD(e.msgType)?oD.UNDO:t?((e,t)=>{var s,a,i;if(!Ce.default.enable_new_fss)return!1;if(null==e||null===(s=e.UIContent)||void 0===s||!s.extInfo)return!1;let n=aD(null!==(a=null!==(i=e.UIContent.extInfo)&&void 0!==i?i:null==t?void 0:t.fssInfo)&&void 0!==a?a:"");return Boolean(n)&&!((null==e?void 0:e.src)===Y.MSG_SRC.SYNC_MOBILE_DB&&0==(null==n?void 0:n.subtype))})(e,t)?oD.NEW_FSS_STICKER:oD.STICKER:oD.DEFAULT,cD="sticker-message-selectable",dD={Selected:"--selected"},uD=e=>{const{isSelected:t=!1}=e;return rr.a.createElement(tR,{isSelected:t},rr.a.createElement("div",{className:Object(lC.a)(cD,t&&dD.Selected,e.className),onClick:s=>{var a;null===(a=e.onSelectClick)||void 0===a||a.call(e,s,t)},onContextMenu:s=>{var a;null===(a=e.onSelectContextMenu)||void 0===a||a.call(e,s,t)}},e.children))},hD=()=>{const e=Object(nr.useRef)(!1);return Object(nr.useEffect)((()=>()=>{e.current=!0}),[]),{unmountedHolder:e}},gD=e=>{var t;const{identity:{id:s,cateId:a}}=e,{unmountedHolder:i}=hD(),[n,r]=Object(nr.useState)((()=>Jb.g.getStickerFromCache(a,s)));return Object(nr.useMemo)((()=>{if(!n||n.id!==s||n.cateId!==a){if(n&&(n.id!==s||n.cateId!==a)){const e=Jb.g.getStickerFromCache(a,s);if(e)return void r(e)}Jb.g.getStickerIfNotExist(a,s).then((e=>{i.current||r(e)}))}}),[s,a]),rr.a.createElement(rr.a.Fragment,null,null===(t=e.children)||void 0===t?void 0:t.call(e,n))},mD=e=>{const[t,s]=Object(nr.useState)((()=>Object(nL.d)({msgId:e.msgId,toUid:e.toUid,sendDttm:e.sendDttm})));return Object(nr.useEffect)((()=>{const t=a.ModuleContainer.resolve(nL.a);return t.addUpdateOperationCallback(e.msgId,(function(e){s(e)})),()=>{t.removeUpdateOperationCallback(e.msgId)}}),[e.msgId]),{showOperation:t}},pD=(e,t)=>"0"===e&&(t?"div_LastSentMsg_Sticker":"div_SentMsg_Sticker")||t&&"div_LastReceivedMsg_Sticker"||"div_ReceivedMsg_Sticker",fD=ui.default.isWeb(),vD=!fD&&s("Dprd").default,_D=e=>{const{fssUrl:t,msgId:s,convId:a}=e,[i,n]=Object(nr.useState)(""),r=Object(nr.useRef)("unknown"),{unmountedHolder:o}=hD();return Object(nr.useEffect)((()=>{const e=async()=>{if(!fD&&Ce.default.enable_cache_fss){r.current="downloading";const e=await Object(Ni.getZaloDownloadsCacheDir)("g",J.p.getSessionUserId()),i=vD.getCachedFileName(t);tt.default.run({type:tt.default.constants.DownloadType.Photo,data:{url:t,fileName:i,msgId:s,conversationId:a},options:{srcAction:tt.default.constants.srcAction.Dev,saveDir:e,caching:!0}}).then((e=>{o.current||(r.current="downloaded",n(e.savePath?"file://"+e.savePath:t))})).catch((e=>{o.current||(r.current="failed",n(t))}))}else r.current="not-supported",n(t)};"unknown"===r.current&&t&&e()}),[t,s,a]),{preview:i}},bD=e=>e.overlay?rr.a.createElement("div",{className:"preload-spinner-overlay"},e.children,rr.a.createElement("div",{className:"preload-spinner-wrapper"},rr.a.createElement("div",{className:"preload-spinner"}))):rr.a.createElement(rr.a.Fragment,null,e.children),ID=e=>{const{showTitle:t=!0,disablePlay:s=!1,content:a,msgInfo:i}=e,n=a.thumb,{preview:r}=_D({msgId:i.msgId,convId:i.convId,fssUrl:a.fssUrl}),[o,l]=Object(nr.useState)(!1);return rr.a.createElement("div",{className:Object(lC.a)("fullscreen-sticker",e.className)},rr.a.createElement(bD,{overlay:e.showOverlay},rr.a.createElement("div",{className:"fullscreen-sticker__content",onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},!r||s||o?rr.a.createElement("img",{className:"fullscreen-sticker__preview",src:n,onLoad:t=>{"function"==typeof e.onLoadThumb&&e.onLoadThumb(n)},onError:t=>{"function"==typeof e.onLoadThumbError&&e.onLoadThumbError(n)}}):rr.a.createElement("img",{className:"fullscreen-sticker__preview",src:r,onLoad:t=>{l(!1),"function"==typeof e.onLoadPreview&&e.onLoadPreview(r)},onError:t=>{l(!0),"function"==typeof e.onLoadPreviewError&&e.onLoadPreviewError(r)}}),t&&rr.a.createElement("div",{className:"fullscreen-sticker__title"},rr.a.createElement(MC.a,{className:"fullscreen-sticker__icon",icon:"Sticker_24_Line"}),rr.a.createElement(lr.a,{textKey:"STR_CLICK_TO_VIEW_2"})))))},yD="fullscreen-sticker-message-content",SD={Block:yD,Modifiers:{NoBorderBottomRadius:"--no-border-bottom-radius"},Elements:{FullscreenSticker:`${yD}__fullscreen-sticker`}},CD=e=>{var t,s,a;const{sticker:i,messageInfo:n}=e,r=null!==(t=n.UIContent.id)&&void 0!==t?t:i.id,o=null!==(s=n.UIContent.cateId)&&void 0!==s?s:i.cateId,{showOperation:l}=mD({msgId:n.msgId,toUid:n.toUid,sendDttm:n.sendDttm}),c=rr.a.useMemo((()=>{var e,t;return aD(null!==(e=null!==(t=n.UIContent.extInfo)&&void 0!==t?t:i.fssInfo)&&void 0!==e?e:"")}),[n.UIContent.extInfo,i.fssInfo]);return rr.a.createElement("div",{"data-id":pD(n.fromUid,null!==(a=n.isLastMsg)&&void 0!==a&&a),className:Object(lC.a)(SD.Block,l&&SD.Modifiers.NoBorderBottomRadius,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},rr.a.createElement(ID,{className:SD.Elements.FullscreenSticker,showOverlay:!!e.isLoadingFSSToPlay,disablePlay:e.disablePlay,content:{id:r,cateId:o,thumb:c.thumbUrl,fssUrl:i.fss},msgInfo:{msgId:n.msgId,convId:n.toUid}}),l&&rr.a.createElement(nL.c,{windowId:e.windowId||hr.c,convId:n.toUid,fromUid:n.fromUid}))};var ED=s("cuiR");const OD=130,MD=80,TD="default-sticker-message-content",wD={Block:TD,Modifiers:{},Elements:{ThumbIcon:`${TD}__thumb-icon`}},RD=e=>{const{size:t=OD,thumbSize:s,thumbPercentage:a=MD}=e,i=rr.a.useMemo((()=>`${Math.round(null!=s?s:t*a/100)}px`),[t,s,a]);return rr.a.createElement("div",{className:Object(lC.a)(wD.Block,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu,style:{width:`${t}px`,height:`${t}px`}},rr.a.createElement(MC.a,{icon:"ThumbSticker_24_Filled",className:wD.Elements.ThumbIcon,style:{fontSize:i,width:i,height:i}}))};var LD=s("+ou9");const DD="normal-sticker-message-content",AD={Block:DD,Modifiers:{},Elements:{Sticker:`${DD}__sticker`}},FD=e=>{var t,s,a,i,n;const{sticker:r,messageInfo:o,disablePlay:l=!1}=e,c=(null!==(t=o.UIContent.id)&&void 0!==t||r.id,null!==(s=o.UIContent.cateId)&&void 0!==s||r.cateId,Object(OL.b)()),d=rr.a.useMemo((()=>{var e;return void 0!==(null==c||null===(e=c.state)||void 0===e?void 0:e.focusedMessageId)&&c.state.focusedMessageId===o.msgId}),[null==c||null===(a=c.state)||void 0===a?void 0:a.focusedMessageId,o.msgId]),{showOperation:u}=mD({msgId:o.msgId,toUid:o.toUid,sendDttm:o.sendDttm});return rr.a.createElement("div",{"data-id":pD(o.fromUid,null!==(i=o.isLastMsg)&&void 0!==i&&i),className:Object(lC.a)(AD.Block,e.className,d&&"focused-item focused-item--animation"),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},rr.a.createElement(LD.a,{key:String(l),className:Object(lC.a)(AD.Elements.Sticker,"sticker-message "),autoStop:!0,sticker:r,thumbSize:OD,stickerView:!0,display:!0,interation:5,fullScreenEffectId:e.isLoadingFSSToPlay,highPriority:!0,autoPlay:!0,isFlip:null!==(n=e.isSentFromMe)&&void 0!==n&&n,disablePlay:l}),u&&rr.a.createElement(nL.c,{windowId:e.windowId||hr.c,convId:o.toUid,fromUid:o.fromUid}))};var kD=s("1Luk"),ND=s("5A7B");const PD="sticker-message-content-wrapper",jD=rr.a.forwardRef((function(e,t){const{sticker:s,data:a,observeIntersectionForReading:i}=e,n=rr.a.useRef(null);if(Object(kT.a)(n,i),!a)return null;const r=rr.a.useMemo((()=>lD(a,s)),[a,s]),o=r===oD.NEW_FSS_STICKER,l=rD(a.status),c=Boolean(e.isMultiSel),{handleClick:d,isLoadingFSSToPlay:u}=(e=>{const{unmountedHolder:t}=hD(),[s,a]=rr.a.useState(!1);return{handleClick:(s,i)=>{if(!s.shiftKey&&!e.isMultiSel){const{message:n,contentType:r}=i,{id:o,cateId:l}=n.UIContent;switch(r){case oD.NEW_FSS_STICKER:case oD.STICKER:case oD.DEFAULT:{const i=(s,i)=>{let n=!1;const r=we.default.getStickerEffectCache(s,i);return r&&"function"==typeof e.dispatch&&(Object(kD.d)(kD.c.PLAY_SS),e.dispatch({type:ve.PopupActions.TOGGLE_COCOS_SCREEN,payload:{effectId:r},windowId:e.windowId||hr.c}),ND.a.register("fullscreensticker"+r,(()=>{t.current||a(!1)}),5e3),n=!0,a(!0)),n};i(o,l)||"function"!=typeof e.showStickerSet||(e.showStickerSet({stickerId:o,id:l}),s&&(s.preventDefault(),s.stopPropagation()));break}case oD.DEL_EVERYONE:case oD.UNDO:s&&(s.preventDefault(),s.stopPropagation())}}},isLoadingFSSToPlay:s}})(e),{handleToggleSelection:h}=(e=>({handleToggleSelection:(t,s)=>{const{isMultiSel:a=!1}=e,{message:i}=s;t.shiftKey||a&&(e.isMouseMoveSelecting||(e.selectMessage(t,i),t.preventDefault(),t.stopPropagation()))}}))(e),g=t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:a};e.showContextMenu(s)},m={onClick:e=>{const t={message:a,contentType:r};c?h(e,t):d(e,t)},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:g};return rr.a.createElement("div",{ref:e=>{n.current=e,null==t||t(e)},className:Object(lC.a)(PD,e.className),"data-component":Y.DataAttributes.Component.STICKER,"data-qId":Object(fe.g)(a),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},rr.a.createElement(eR,{type:o?c?void 0:"side":"overlay",msgStatus:a.status,sendDttm:a.sendDttm,onRetryContextMenu:g,onSendingContextMenu:g,onRetryClick:t=>{var s;t.preventDefault(),t.stopPropagation(),null===(s=e.resendMessage)||void 0===s||s.call(e,t,a)}},rr.a.createElement(uD,{isSelected:e.isSelected,onSelectClick:e=>{h(e,{message:a,contentType:r})},onSelectContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:a};e.showContextMenu(s)}},(()=>{switch(r){case oD.STICKER:return rr.a.createElement(FD,Object(BS.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:l,sticker:s,messageInfo:{msgId:a.msgId,fromUid:a.fromUid,toUid:a.toUid,cliMsgId:a.cliMsgId,UIContent:a.UIContent,isLastMsg:a.isLastMsg}},m));case oD.NEW_FSS_STICKER:return rr.a.createElement(CD,Object(BS.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:l,sticker:s,messageInfo:{cliMsgId:a.cliMsgId,msgId:a.msgId,toUid:a.toUid,UIContent:a.UIContent,fromUid:a.fromUid,sendDttm:a.sendDttm,isLastMsg:a.isLastMsg}},m));case oD.UNDO:case oD.DEL_EVERYONE:return rr.a.createElement(ED.a,Object(BS.a)({messageInfo:{msgId:a.msgId,msgType:a.msgType,cliMsgId:a.cliMsgId,fromUid:a.fromUid,toUid:a.toUid}},m));case oD.DEFAULT:default:return rr.a.createElement(RD,Object(BS.a)({thumbPercentage:80,messageInfo:{msgId:a.msgId,fromUid:a.fromUid,toUid:a.toUid,cliMsgId:a.cliMsgId}},m))}})())))}));var UD=rr.a.forwardRef(((e,t)=>{const s=e.data.UIContent.id,a=e.data.UIContent.cateId;return rr.a.createElement(gD,{identity:{id:s,cateId:a}},(s=>rr.a.createElement(jD,Object(BS.a)({ref:t},e,{sticker:s}))))}));const BD={Block:"core-image",Modifiers:{NonSelectable:"--non-selectable",NonDraggable:"--non-draggable"}},zD=e=>{const{width:t,height:s,draggable:a=!1,selectable:i=!1}=e,n=a?{draggable:!0}:{draggable:!1,onDragStart:e=>{a||(e.preventDefault(),e.stopPropagation())}};return rr.a.createElement("img",Object(BS.a)({className:Object(lC.a)(e.className,BD.Block,!a&&BD.Modifiers.NonDraggable,!i&&BD.Modifiers.NonSelectable),alt:"",src:e.src,width:t,height:s,onLoad:e.onLoad,onError:e.onError},n))},GD="loading-image",xD={Block:GD,Modifiers:{Loading:"--loading"},Elements:{DefaultThumb:`${GD}__default-thumb`,EmbededImage:`${GD}__embeded-image`}},VD=80,HD=e=>{const{useDefaultThumb:t=!0,initialLoading:s=!0,draggable:a=!1,selectable:i=!1,width:n=0,height:r=0,MaxDefaultThumbSize:o,MaxDefaultThumbPercentage:l=VD}=e,[c,d]=rr.a.useState(s),u=o,h=l;return rr.a.createElement("div",{className:Object(lC.a)(xD.Block,c&&xD.Modifiers.Loading,e.className)},t&&c&&rr.a.createElement(RD,{className:xD.Elements.DefaultThumb,messageInfo:e.messageInfo,thumbPercentage:h,thumbSize:u}),rr.a.createElement(zD,{className:Object(lC.a)(xD.Elements.EmbededImage),src:e.src,height:r,width:n,draggable:a,selectable:i,onLoad:t=>{var s;c&&d(!1),null===(s=e.onLoad)||void 0===s||s.call(e,t)},onError:t=>{var s;null===(s=e.onError)||void 0===s||s.call(e,t)}}))},WD=I_.a.Constant.DisplayModeProps,qD="Preview",KD="Play",$D=function(e,t){e===qD?t(KD):e===KD&&t(qD)},ZD=function(e,t){e&&$D(qD,t)},QD=function(e,t,s,a,i){e&&I_.a.Helper.parseInt(s)&&(i.current&&clearTimeout(i.current),i.current=setTimeout((()=>{a.current=!1,function(e,t){e&&$D(KD,t)}(e,t),i.current&&clearTimeout(i.current),i.current=null}),s))},YD="photo-sticker",JD={Block:YD,Elements:{PreviewImage:`${YD}__preview-image`,PlayImage:`${YD}__play-image`}};function XD(e){const{data:t,width:s=0,height:a=0,mode:i=WD.PLAY_FIRST,useDefaultThumb:n=!0,onlyLoadLocal:r=!1,animationDuration:o=5e3,draggable:l=!1,selectable:c=!1}=e,[d,u]=function(e){return e===WD.PREVIEW_ONLY?[qD,!1]:e===WD.PLAY_ONLY?[KD,!1]:e===WD.PREVIEW_FIRST?[qD,!0]:e===WD.PLAY_FIRST?[KD,!0]:[qD,!1]}(i),[h,g]=Object(nr.useState)(d),m=Object(nr.useRef)(!0),p=Object(nr.useRef)(!1),f=Object(nr.useRef)(null),v=I_.a.Helper.getStickerThumbUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),_=I_.a.Helper.getStickerUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),b=e=>{e&&(ZD(u,g),!p.current&&QD(u,g,o,m,f))};return rr.a.createElement("div",{id:"pSticker_"+t.id,key:"pSticker_"+t.id,className:Object(lC.a)(JD.Block,e.className),draggable:l,style:{width:s,height:a},onClick:t=>{var s;null===(s=e.onClick)||void 0===s||s.call(e,t)},onDoubleClick:t=>{var s;null===(s=e.onDoubleClick)||void 0===s||s.call(e,t)},onContextMenu:t=>{var s;null===(s=e.onContextMenu)||void 0===s||s.call(e,t)},onMouseEnter:()=>{m.current=!0,p.current=!0,ZD(u,g)},onMouseOut:()=>{p.current=!1,QD(u,g,o,m,f)}},h===qD?rr.a.createElement(HD,{className:JD.Elements.PreviewImage,messageInfo:e.messageInfo,useDefaultThumb:n,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localPreview,src:ui.default.transformLocalUrl(v),width:s,height:a,draggable:l,selectable:c,onLoad:()=>{b(i===WD.PLAY_FIRST&&m.current)}}):rr.a.createElement(HD,{className:JD.Elements.PlayImage,messageInfo:e.messageInfo,useDefaultThumb:n,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localUrl,src:ui.default.transformLocalUrl(_),width:s,height:a,selectable:c,draggable:l,onLoad:()=>{b(i===WD.PLAY_FIRST&&m.current)}}),rr.a.createElement(rL.b,{message:e.messageInfo,devSrc:"PhotoSticker",visible:!1}))}const eA=e=>{const[,t]=rr.a.useState(0),{data:s}=e,a=I_.a.Cache.FileToPath,i=a.getPathById(s.id,s.url),n=a.getPathById(s.id,s.pngUrl),r=a.getPathById(s.id,s.previewUrl);return i&&(s.localUrl=i),n&&(s.localPng=n),r&&(s.localPreview=r),rr.a.useEffect((()=>{I_.a.Helper.runDownload(s,(()=>t((e=>1^e))))}),[s.id,s.url,s.pngUrl,s.previewUrl]),rr.a.createElement(XD,Object(BS.a)({},e,{data:s}))},tA="photo-sticker-message-content",sA={Block:tA,Elements:{PhotoSticker:`${tA}__photo-sticker`}},aA=(e,t)=>{const{data:s,observeIntersectionForReading:a}=e,i=rr.a.useRef(null);Object(kT.a)(i,a);const n=rr.a.useMemo((()=>I_.a.Helper.convertMessageToPhotoStickerData(s)),[s]),r=rr.a.useMemo((()=>{const[e,t]=I_.a.Helper.getRenderedPhotoStickerSizeAtChatList(n.width,n.height),[s,a]=I_.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:a}}}),[n.width,n.height]),o=t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},l=I_.a.Constant.DisplayModeProps.PLAY_FIRST,c=I_.a.Config.getMessageAnimationDuration();return rr.a.createElement(eR,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:o,onSendingContextMenu:o,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},rr.a.createElement(uD,{isSelected:e.isSelected},rr.a.createElement("div",{id:Y.UIMessagePrefixElementID.PhotoStickerMessage+Object(fe.j)(s),ref:e=>{i.current=e,null==t||t(e)},className:Object(lC.a)(sA.Block,e.className),"data-component":Y.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(fe.g)(s),style:Object(I.a)({},r.message),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onClickCapture:t=>{var a;null==e||null===(a=e.onClickCapture)||void 0===a||a.call(e,t,s)},onContextMenu:o,onContextMenuCapture:e.onContextMenuCapture},rr.a.createElement(eA,{mode:l,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,sendDttm:s.sendDttm},className:sA.Elements.PhotoSticker,width:r.photoSticker.width,height:r.photoSticker.height,data:n,MaxDefaultThumbPercentage:MD,animationDuration:c,onlyLoadLocal:!0}))))},iA=rr.a.forwardRef(aA),nA="no-border-photo-sticker-message-content",rA={Block:nA,Modifiers:{},Elements:{ImageContainer:`${nA}__image-container`,Image:`${nA}__image`}},oA=e=>{var t,s;const{fromUid:a,toUid:i,cliMsgId:n,UIContent:r,msgId:o}=e.messageInfo,l=null!==(t=r.parsedParams.width)&&void 0!==t?t:0,c=null!==(s=r.parsedParams.height)&&void 0!==s?s:0,d=`${n}::${a}::${i}`,u=ui.default.removeProtocol(r.oriUrl),h=rr.a.useMemo((()=>{const[e,t]=I_.a.Helper.getRenderedPhotoStickerSizeAtChatList(l,c),[s,a]=I_.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:a}}}),[l,c]);return rr.a.createElement("div",{className:Object(lC.a)(rA.Block,e.className),style:h.message,onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},rr.a.createElement("div",{className:rA.Elements.ImageContainer,style:h.photoSticker},rr.a.createElement(Gw.a,{className:rA.Elements.Image,mediaId:d,mediaSize:h.photoSticker,urls:Object(zw.a)([u]),loadStrategy:{type:"Instant"},entry:"MESSAGE_LIST",preloadStrategy:"Async",renderPlaceholder:()=>rr.a.createElement(RD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:a,toUid:i,cliMsgId:n}}),renderError:()=>rr.a.createElement(RD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:a,toUid:i,cliMsgId:n}})}),rr.a.createElement(rL.b,{message:e.messageInfo,visible:!1,devSrc:"NoBorderPhotoStickerMessageContent"})))};class lA{static getInstance(){return lA.instance_||(lA.instance_=new lA),lA.instance_}constructor(){if(this.trackingData_=new u.default({maxSize:1e3}),this._LogThreshold_=1,lA.instance_)return lA.instance_;lA.instance_=this}onNoBorderStickerDisplayedAtWhere(e){if(!e)return;const t=this.getTrackingId_(e);if(!t)return;const s=this.updateTrackingData_(t);this.submitLogIfNeeded_({id:t,count:s,where:e.where})}getTrackingId_(e){if(e.id&&e.where)return`[${e.where}]:${e.id}`}updateTrackingData_(e){let t=this.trackingData_.get(e);return t=null==t?1:t+1,this.trackingData_.set(e,t),t}submitLogIfNeeded_(e){this.shouldSubmitLog_(e)&&this.$ubmitLog_()}shouldSubmitLog_(e){return!!(e&&e.id&&e.where)&&e.count===this._LogThreshold_}$ubmitLog_(){Ia.default.logAction(107150334)}}lA.instance_=void 0;const cA="no-border-photo-sticker-message-content-wrapper",dA=rr.a.forwardRef(((e,t)=>{const{data:s,observeIntersectionForReading:a}=e,i=rr.a.useRef(null);Object(kT.a)(i,a);var n;return n={msgId:s.msgId},Object(nr.useEffect)((()=>{lA.getInstance().onNoBorderStickerDisplayedAtWhere({id:n.msgId,where:"csc"})}),[]),rr.a.createElement("div",{ref:e=>{i.current=e,null==t||t(e)},className:Object(lC.a)(cA),"data-component":Y.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(fe.g)(s),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},rr.a.createElement(eR,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},rr.a.createElement(uD,{isSelected:e.isSelected},rr.a.createElement(oA,{onContextMenu:t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,ttl:s.ttl,localPath:s.localPath,UIContent:s.UIContent,isLastMsg:s.UIIsLastInList,sendDttm:s.sendDttm}}))))}));var uA=s("gXIT"),hA=s("05R2");const gA="ai-sticker-message-content",mA={Block:gA,Modifiers:{Audit:"--audit"},Elements:{Sticker:`${gA}__sticker`,Badge:`${gA}__badge`}},pA=e=>{const[t,s]=rr.a.useState(!1),a=e.sticker.thumb||"",i=e.sticker.url;return rr.a.createElement("div",{className:Object(lC.a)(mA.Block,mA.Modifiers.Audit,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},rr.a.createElement(uA.a,{thumb:a,src:i,className:mA.Elements.Sticker,width:e.sticker.renderedWidth,height:e.sticker.renderedHeight,thumbPercentage:80,draggable:e.draggable,selectable:e.selectable,onLoad:(e,t,a)=>{s("src"===t)}}),Object(p_.$AIStickerConfiguration)().isEnable("AIStickerMessage")&&t&&rr.a.createElement(hA.a,{className:mA.Elements.Badge}),rr.a.createElement(rL.b,{message:e.messageInfo,devSrc:"AIStickerMessageContent#2",visible:!1}))};let fA=function(e){return e.STICKER="sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const vA="ai-sticker-message-content-wrapper",_A=(e,t)=>{const{data:s,observeIntersectionForReading:i}=e,n=(e=>e.msgType===Y.MSG_UNDO?fA.UNDO:e.msgType===Y.MSG_DEL_EVERYONE?fA.DEL_EVERYONE:fA.STICKER)(s),r=rr.a.useRef(null);Object(kT.a)(r,i);const o=rr.a.useMemo((()=>a.ModuleContainer.resolve(p_.TAIStickerAppService).transformFromAIStickerMessage(s)),[s]),l=t=>{"function"==typeof e.showContextMenu&&(t.preventDefault(),t.stopPropagation(),e.showContextMenu({event:t,message:s}))};return rr.a.createElement("div",{ref:e=>{r.current=e,null==t||t(e)},className:Object(lC.a)(vA,e.className),"data-component":Y.DataAttributes.Component.STICKER,"data-qId":Object(fe.g)(s),onClick:e=>{},onClickCapture:e.onClickCapture,onContextMenu:l,onContextMenuCapture:e.onContextMenuCapture,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},rr.a.createElement(eR,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:l,onSendingContextMenu:l,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},rr.a.createElement(uD,{isSelected:e.isSelected},(()=>{switch(n){case fA.STICKER:return rr.a.createElement(pA,{messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,UIContent:s.UIContent,isLastMsg:s.isLastMsg,ttl:s.ttl,sendDttm:s.sendDttm},sticker:o,draggable:!1,selectable:!1});case fA.UNDO:case fA.DEL_EVERYONE:return rr.a.createElement(ED.a,{messageInfo:{msgId:s.msgId,msgType:s.msgType,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}});default:return rr.a.createElement(RD,{thumbPercentage:80,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}})}})())))},bA=rr.a.forwardRef(_A);var IA=s("NWd+"),yA=s("VeD8");const SA=Object.values||(e=>Object.keys(e).map((t=>e[t])));function CA(e){return(Array.isArray||(e=>"[object Array]"===Object.prototype.toString.call(e)))(e)}class EA extends yA.a{constructor(e,t){super(e,t),this.isMounted_=!1}static getDerivedStateFromProps(e,t){return yA.a.getDerivedStateFromProps(e,t)}render(){return super.render()}componentDidMount(){super.componentDidMount(),this.isMounted_=!0}DEFAULT_checkShouldRunUpdateState(e,t,s){const{prevChildren:a,nextChildren:i}=s;return n=SA(a).map((e=>e.key)),r=SA(i).map((e=>e.key)),!(CA(n)&&CA(r)&&(n===r||n.length===r.length&&n.every(((e,t)=>e===r[t]))));var n,r}enableUpdateState_(e,t){const s={prevProps:e,nextProps:this.props},a={prevState:t,nextState:this.state},i={prevChildren:t.children,nextChildren:this.state.children};return(!0===this.props.update?this.DEFAULT_checkShouldRunUpdateState:"function"==typeof this.props.update?this.props.update:()=>!1)(s,a,i)}getSnapshotBeforeUpdate(e,t){if(this.enableUpdateState_(e,t)){return SA(t.children).reduce(((e,t)=>{var s;const a=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(a){var i;const s=a.getBoundingClientRect(),n=t.key,r={reactKey:n,clientRect:s};e[n]=r,(null!==(i=t.props.onUpdateFlipMove)&&void 0!==i?i:function(){})(n,a,s)}return e}),{})}return null}componentDidUpdate(e,t,s){if(this.enableUpdateState_(e,t)){const e=SA(this.state.children).reduce(((e,t)=>{var s;const a=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(a){const s=a.getBoundingClientRect(),i=t.key,n={reactKey:i,clientRect:s};e[i]=n}return e}),{}),t=SA(s).reduce(((t,s)=>{const{reactKey:a}=s,i=e[a];return i&&(t[a]={prev:s,next:i}),t}),{});SA(t).forEach((({prev:e,next:t})=>{let[s,a]=[t.clientRect.x-e.clientRect.x,t.clientRect.y-e.clientRect.y];if([s,a].some((e=>Math.abs(e)>0))){var i;const e=this.state.children[t.reactKey],r=null==e||null===(i=e.props.nodeRef)||void 0===i?void 0:i.current;if(r){var n;(null!==(n=e.props.onUpdatingFlipMove)&&void 0!==n?n:function(){})(e.key,r,t.clientRect);const i=r.animate([{transform:`translate(${-s}px, ${-a}px)`},{transform:"none"}],{duration:300,easing:"cubic-bezier(.29,.91,.52,1)"});i.onfinish=()=>{var e;if(!this.isMounted_)return;const s=this.state.children[t.reactKey],a=null==s||null===(e=s.props.nodeRef)||void 0===e?void 0:e.current;var n;a&&(null!==(n=s.props.onUpdatedFlipMove)&&void 0!==n?n:function(){})(s.key,a,t.clientRect);i.cancel()}}}}))}}componentWillUnmount(){this.isMounted_=!1}}uC.d;var OA=s("pQ8y");class MA extends OA.a{}const TA=["className","children","nodeRef"],wA="burrow-up-transition",RA=e=>{const{className:t,children:s,nodeRef:a=rr.a.useRef(null)}=e,i=Object(zi.a)(e,TA);return rr.a.createElement(MA,Object(BS.a)({},i,{nodeRef:a,classNames:wA,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=a.current)||void 0===t||t.addEventListener("transitionend",e,!1)}}),rr.a.createElement("div",{ref:a,className:Object(lC.a)(wA,t)},s))};class LA extends EA{static getDerivedStateFromProps(e,t){const s=t.firstRender;let a=EA.getDerivedStateFromProps(e,t);if(s){const t=SA(a.children).reduce(((e,t)=>(t.props.in&&(e[t.key]=t),e)),Object.create(null));if(Object.keys(t).length>=2){let s=null;rr.a.Children.map(e.children,(e=>e)).forEach(((e,a)=>{t[e.key]&&(!s||s.index<a)&&(s={index:a,child:e})})),SA(t).forEach((e=>{s&&e.key===s.child.key||(a.children[e.key]=rr.a.cloneElement(e,{appear:!1,enter:!1}))}))}}return a}componentDidMount(){super.componentDidMount()}}const DA=["className","items","children","component"],AA="animated-sticker-group-message",FA=e=>{const{className:t,items:s,children:a,component:i="div"}=e,n=Object(zi.a)(e,DA),r=rr.a.useMemo((()=>s.map((e=>({nodeRef:rr.a.createRef(),item:e})))),[s]);return rr.a.createElement(LA,Object(BS.a)({className:Object(lC.a)(AA,t),component:i},n),r.map((({item:e,nodeRef:t})=>rr.a.createElement(RA,{key:e.cliMsgId,nodeRef:t},a(e)))))};var kA=s("Hi8h");const NA=e=>{var t,s;const{data:a}=e,i=null!==(t=a.UIContent)&&void 0!==t?t:[],n=i.map((e=>({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}))),r=Boolean(a.UIIsLastInList),o=rr.a.useMemo((()=>{const e=a.toUid,t=Object(IA.a)(),s=t.getASetOfJustAddedMessage(e);return void 0!==n.find((e=>{var a;const i=t.buildJustAddedMessageStateKey({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}),n=null===(a=s[i])||void 0===a?void 0:a.src,r=["just-sent","just-received"].includes(n);return r&&t.removeJustAddedMessage(i,!1),r}))}),[r,n.map((e=>e.cliMsgId)).join("_")]),l=Boolean(Object(kA.b)().enable),c=null!==(s=e.component)&&void 0!==s?s:"div";return rr.a.createElement(rr.a.StrictMode,null,r&&l?rr.a.createElement(FA,{component:c,appear:o,enter:o,update:o,exit:!1,className:e.className,items:i,children:e.children}):rr.a.createElement(c,{className:e.className},i.map((t=>e.children(t)))))};var PA=s("ptyt");function jA(e){const t=Object(nr.useRef)(e||null),s=()=>(t.current||(t.current=new Map),t.current),a=(e,t)=>{s().has(e)||s().set(e,t)},i=e=>{s().delete(e)};return{getItemRefList:s,addItemRefToList:a,removeItemRefFromList:i,clearAllItemRefFromList:()=>{s().clear()},getItemRefFromList:e=>s().get(e),updateItemRefInList:(e,t)=>{t?a(e,t):i(e)}}}var UA=s("ynGT");const BA=e=>{const{noVisible:t=!1}=e;return rr.a.createElement("div",{className:Object(lC.a)("download-entry-point",t&&"--no-visible",e.className),title:le.a.str("STR_DOWNLOAD_STICKER"),onClick:e.onDownloadClick,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},rr.a.createElement(MC.a,{icon:"Download-bold_24_Filled",className:"download-entry-point__download-icon"}))};function zA(e){if(!function(e){const t=Boolean(e&&e.msgType===Y.MSG_STICKER_GROUP&&e.message&&1===e.message.length);if(!t)return t;const s=e.message[0];return Boolean(s&&(s.msgType===Y.MSG_STICKER||s.msgType===Y.MSG_STICKER_2))}(e))return null;const t=e.message[0];return{id:t.message.id,catId:t.message.catId}}function GA(e,t){return new Promise(((s,a)=>{var i;if(!e)return s(!1);if(null==t||null===(i=t.signal)||void 0===i?void 0:i.aborted)return a("Aborted");Jb.g.getDownloadedCateIds().then((i=>{var n;return(null==t||null===(n=t.signal)||void 0===n?void 0:n.aborted)?a("Aborted"):i&&i.length&&-1!==i.indexOf(e)?s(!1):void Jb.g.getStickerCategoriesV2().then((i=>{var n;if(null==t||null===(n=t.signal)||void 0===n?void 0:n.aborted)return a("Aborted");let r=!1;return i&&i.length&&(r=i.some((t=>t&&t.id===e&&![UA.g.HIDE_STORE,UA.g.OFF].includes(t.is_hidden)))),s(r)})).catch(a)})).catch(a)}))}const xA=e=>{const{stickerGroupMessage:t}=e,s=zA(t),[a,i]=rr.a.useState(!1);rr.a.useEffect((()=>{let e=null,t=null;const a=null==s?void 0:s.catId;return a?(e=new AbortController,GA(a,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||i(t)})).catch((e=>{zconsole.zsymb(21,"efJkDe",["[checkCanDownloadStickerCateOrNot] error: {}","39NXQV"],null==e?void 0:e.message)})),t=t=>{const s=-1===t.findIndex((e=>e===a));i(!!s&&(t=>{var s;t||(null===(s=e)||void 0===s||s.abort(),e=new AbortController,GA(a,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||i(t)})).catch((e=>{zconsole.zsymb(21,"A2YhIF",["[checkCanDownloadStickerCateOrNot] error: {}","39NXQV"],null==e?void 0:e.message)})));return t}))},Jb.g.addPersonalStickerListener(t)):i(!1),()=>{e&&e.abort(),t&&Jb.g.removePersonalStickerListener(t)}}),[null==s?void 0:s.catId]);const n=!s||!s.catId,r="0"==t.fromUid,o=Boolean(e.isMultiSel),l=r?"left":"right",c=!n&&a;return rr.a.createElement("div",{className:Object(lC.a)("sticker-message-downloadable","left"===l?"--left-side":"--right-side")},c&&rr.a.createElement(BA,{noVisible:o,onDownloadClick:t=>{s&&"function"==typeof e.showStickerSet&&(t.preventDefault(),t.stopPropagation(),e.showStickerSet({id:s.catId}))}}),e.children)},VA={Block:"sticker-group-message",Modifiers:{SentFromMe:"--from-me"},Elements:{}},HA=rr.a.forwardRef(((e,t)=>{const{data:s,MessageQuickActionRenderer:a}=e,i="0"==s.fromUid,{isSelectedStickerMessage:n}=(e=>({isSelectedStickerMessage:t=>Boolean(e.isMultiSel&&e.selectedMsg&&e.selectedMsg[t])}))(e),{isFocusedStickerMessage:r}=(e=>({isFocusedStickerMessage:t=>{var s;return!(null===(s=e.focusId)||void 0===s||!s.length)&&e.focusId.includes(t)}}))(e),{bindStickerMessageItemRefs:o}=(e=>{const{getItemRefList:t,updateItemRefInList:s}=jA();return Object(nr.useEffect)((()=>{var s;const a={ids:[],elements:[]};var i;null===(s=e.focusId)||void 0===s||s.forEach((e=>{const s=t().get(e);s&&(a.ids.push(e),a.elements.push({ele:s,ref:null}))})),a.ids.length>0&&(null===(i=e.focusHandler)||void 0===i||i.call(e,a.ids,a.elements,null,!0))}),[e.focusId]),{bindStickerMessageItemRefs:s}})(e),{bindStickerMessageItemRefs:l}=(e=>{const{windowId:t}=Object(SC.a)(),s=(t,s)=>{"function"==typeof e.onSeeMsg&&e.onSeeMsg(s),s&&e.newMsgIds&&e.newMsgIds.length>0&&e.newMsgIds.includes(s)&&"function"==typeof e.clearLatestMessageAction&&e.clearLatestMessageAction();const a=PA.a.getLastSavedPosition(t);if(a){const{msgId:e}=a;e===s&&PA.a.clearSavedPosition(t)}},{getItemRefList:a,updateItemRefInList:i}=jA();return rr.a.useEffect((()=>{const e=a();for(let[a,i]of Array.from(e)){const e=sp.a.getInViewController(t);null==e||e.observe(i,{identifier:a,onIntersect:(...e)=>s("",a),threshold:.9})}return()=>{for(let[s,a]of Array.from(e)){const e=sp.a.getInViewController(t);null==e||e.unobserve(a)}}}),[e.data,t]),{bindStickerMessageItemRefs:i}})(e);(e=>{rr.a.useEffect((()=>()=>{var t;const s=e.data;s&&(null===(t=s.UIContent)||void 0===t||t.forEach((e=>{EM.a.clearGroupId(e.msgId)})))}),[])})(e);const c=(e,t)=>{Object(xL.b)(t,xL.a.LEFT_CLICK_BUBBLE_MESSAGE)},d=(e,t)=>{Object(xL.b)(t,xL.a.RIGHT_CLICK_BUBBLE_MESSAGE)};return rr.a.createElement("div",{ref:t,className:"sticker-group-message-wrapper"},rr.a.createElement(NA,{component:"div",className:Object(lC.a)(VA.Block,i&&VA.Modifiers.SentFromMe,e.className),data:s},(t=>{const a=n(t.msgId),i=r(t.msgId);switch(t.UIType){case UM.e.PhotoSticker:return rr.a.createElement(iA,Object(BS.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case UM.e.NoBorderPhotoSticker:return rr.a.createElement(dA,Object(BS.a)({},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case UM.e.AISticker:return rr.a.createElement(bA,Object(BS.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),l(t.msgId,e)},onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case UM.e.Sticker:return rr.a.createElement(xA,{stickerGroupMessage:s,isMultiSel:e.isMultiSel,showStickerSet:e.showStickerSet},rr.a.createElement(UD,Object(BS.a)({key:t.cliMsgId,ref:e=>{o(t.msgId,e),l(t.msgId,e)}},e,{onClickCapture:e=>c(0,t),onContextMenuCapture:e=>d(0,t),windowId:e.windowId||hr.c,isSelected:a,isFocused:i,data:t})))}})),a&&rr.a.createElement(a,null))})),WA=e=>{const{data:t}=e,a="0"==t.fromUid;return rr.a.createElement("div",{className:Object(lC.a)("sticker-set-message",e.className),onClick:()=>{var e;const a=null===(e=s("k+R1"))||void 0===e?void 0:e.default;if(a){var i;const e=t.toUid,s=a.getChatBoxControllerByConvId(e);null==s||null===(i=s._showStickerSet)||void 0===i||i.call(s,{id:t.UIContent.parsedParams.id})}},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:s=>{if("function"!=typeof e.showContextMenu)return;const a={event:s,message:t};e.showContextMenu(a)}},rr.a.createElement("div",{className:"sticker-set-message__content"},rr.a.createElement("div",{title:le.a.str("STR_STICKER_SET"),className:"sticker-set-message__thumb",style:{backgroundImage:`url(${ui.default.removeProtocol(t.UIContent.thumb)})`}}),rr.a.createElement("div",{className:"sticker-set-message__info"},rr.a.createElement(lr.a,{textKey:"STR_STICKER_SET",tagName:"span",className:"sticker-set-message__title"}),rr.a.createElement("span",{className:"sticker-set-message__name"},t.UIContent.title))),!a&&rr.a.createElement(rr.a.Fragment,null,rr.a.createElement("div",{className:"sticker-set-message__separator"}),rr.a.createElement("div",{className:"sticker-set-message__downloadable"},rr.a.createElement(MC.a,{icon:"Download_24_Line",className:"sticker-set-message__download-icon mr-4"}),rr.a.createElement(lr.a,{textKey:"STR_FREE_DOWNLOAD_STICKER_SET",tagName:"span",className:"sticker-set-message__download-title"}))))};var qA=e=>{var t;const{data:s,isFocused:a,observeIntersectionForReading:i}=e,n="0"==s.fromUid,r=rr.a.useRef(null);Object(kT.a)(r,i);const o=Object(Po.l)(zc.b,null===(t=e.conversation)||void 0===t?void 0:t.userId,(e=>{var t;return null!==(t=null==e?void 0:e.lockSendMsg)&&void 0!==t&&t}));return rr.a.createElement(NT.a,{border:6,isAdmin:e.isHighlightedByPrivilegedUser,variant:"common",ttl:s.ttl},rr.a.createElement("div",{ref:r,className:Object(lC.a)("sticker-set-message-wrapper",n&&"--blue",e.isHighlightedByPrivilegedUser&&!s.ttl&&"--highlighted-from-admin",!1,o&&"--none-clickable","shadow-bubble","rounded-6","focused-item",a&&"focused-item--highlight-border"),"data-qId":Object(fe.g)(s)},rr.a.createElement(WA,e)))},KA=s("mVVk"),$A=s("f08i");var ZA=function(e){return e.INIT="init",e.PROCESSING="processing",e.SUCCESS="success",e.FAILED="failed",e}(ZA||{});const QA=e=>{const[t,s]=rr.a.useState(null),i=rr.a.useRef(null);rr.a.useEffect((()=>{if(!t)return;if(!e.conversation||!e.conversation.userId)return;let s=e.message;if(!s||!s.message)return;if([Y.MSG_LOCAL,Y.MSG_FAIL].includes(s.status))return;if(s.subType===Y.MSG_SUBTYPE_LINK)return;const n=i.current;if(!n||ZA.INIT===n.status||n.payload.cliMsgId!==s.cliMsgId||n.payload.fromUid!==s.fromUid||n.payload.toUid!==s.toUid){const n={status:ZA.PROCESSING,payload:{link:t,msgId:s.msgId,cliMsgId:s.cliMsgId,fromUid:s.fromUid,toUid:s.toUid}};i.current=n,s=Object(I.a)(Object(I.a)({},s),{},{subType:Y.MSG_SUBTYPE_LINK}),((e,t,s)=>new Promise(((i,n)=>{we.default.updateMessage(t.msgId,t,["subType"],e.userId).then((()=>{let e=Object(KA.a)(t,s);const r=a.ModuleContainer.resolve(Re.a),o={newId:`${t.cliMsgId}_${t.fromUid}_${t.toUid}`,oldId:t.msgId};r.isExistedMedia("link",o).then((s=>{s?i({status:"existed",payload:null}):($A.a.receiveMediaFromMessage(t.toUid,[],[],[{msgId:t.msgId,userId:t.toUid,message:e.message,sendDttm:t.sendDttm,cliMsgId:t.cliMsgId,fromUid:t.fromUid,type:"link",ttl:t.ttl}]),i({status:"success",payload:{updatedMessage:t,linkMediaMessage:e}}))})).catch((e=>{zconsole.zsymb(21,"aI-JzK",["Failed to check existed media: {}","DvPMoo"],null==e?void 0:e.message),n(e)}))})).catch((e=>{zconsole.zsymb(21,"HWWec1",["Failed to update link media message: {}","kccYkK"],null==e?void 0:e.message),n(e)}))})))(e.conversation,s,t).then((t=>{if("success"===t.status&&t.payload){const{updatedMessage:s,linkMediaMessage:a}=t.payload;e.dispatch&&e.dispatch({type:ve.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:s}),_e.default.send(ve.ChatBoxActions.ADD_MESSAGE_LINK,{conversation:e.conversation,conversationId:e.conversation.userId,messages:[a]})}n.status=ZA.SUCCESS})).catch((()=>{n.status=ZA.FAILED}))}}),[e.message,e.conversation,t]);return{updateFirstLink:e=>{e&&e!==t&&s(e)}}};var YA=s("GGl6");const JA="text-message__container",XA={HasStatus:JA+"--has-status"};function eF(e){const{conversationID:t,isSelected:s,message:a,topMember:i}=e,n=a.quote;return null==n?null:(""===n.fromD&&(n.fromD=function(e,t){const s=e.quote||{fromUid:"",ownerId:"",fromD:""};let a=s.fromD;if(!a)return a;const i=s.fromUid||s.ownerId;if(i===J.p.getSessionUserId()){const e=Ii.default.getMiniProfileMe();a=(null==e?void 0:e.dName)||""}else if(Array.isArray(t)){const e=Ii.default.getDName(i);if(e)a=e;else for(let s of t)if(s.id===i){a=s.dName;break}}else a=Ii.default.getDName(i)||"";return a}(a,i)),rr.a.createElement(aw.MessageQuoteFragment,{conversationID:t,deprecated:{message:a},quote:n,isSelected:s}))}function tF(e){return void 0===e.urgency||null===e.urgency?null:rr.a.createElement(aw.MessageUrgencyIndicator,{urgency:e.urgency})}function sF(e){const{contentRenderer:t,message:s}=e,a=Object(YS.a)(),i=Object(eD.a)();return rr.a.createElement(dR.a,{windowId:i,message:s,data:s.extra.todoInfo,htmlInner:t,user:{userId:J.p.getSessionUserId()},dispatch:a})}var aF=function(e){const{conversation:t,data:s,isFocusing:a,isMultiSel:i,selectedMsg:n={},topMember:r}=e,o=Boolean(i&&n[s.msgId]),{updateFirstLink:l}=QA({conversation:e.conversation,message:s,dispatch:e.dispatch});if(Object(m_.G)(s))return rr.a.createElement(YA.a,Object(BS.a)({},e,{data:s,isHighlighted:a,isSelected:o}));const c=Y.UIMessagePrefixElementID.TextMessage+Object(fe.j)(s),d=(null==t?void 0:t.userId)||"",u=Object(OR.a)(s.UIContent,e,l),h=function(e){const t=[];return e.shouldShowStatus&&t.push(XA.HasStatus),Object(lC.a)(t)}(e),g=function(e,t){return e.extra&&e.extra.todoInfo?"0"===e.extra.fromUid?"div_TskASGD_Msg":"div_TskRECD_Msg":"0"===e.fromUid?t.isLastMsg?"div_LastSentMsg_Text":"div_SentMsg_Text":t.isLastMsg?"div_LastReceivedMsg_Text":"div_ReceivedMsg_Text"}(s,{isLastMsg:!1});let m=null;return s.extra&&s.extra.todoInfo&&(m=rr.a.createElement(sF,{contentRenderer:u,message:s})),rr.a.createElement("div",{id:c,className:Object(lC.a)(JA,h),"data-id":g},rr.a.createElement(eF,{conversationID:d,isSelected:o,message:s,topMember:r}),rr.a.createElement(tF,{urgency:s.urgency}),m||rr.a.createElement("div",null,u))};var iF=function(e){e.data;const t=lr.a;return rr.a.createElement(t,{className:"undo-message",textKey:"STR_UNDO_MSG"})};var nF=function(e){return e.data,rr.a.createElement("div",null,"Tin nhn khng hin th c")};var rF=(e=!1)=>{const[t,s]=Object(nr.useState)(e);return[t,Object(nr.useCallback)((()=>{s(!0)}),[]),Object(nr.useCallback)((()=>{s(!1)}),[])]};const oF=368;var lF=s("8sI6");var cF=function(e){const{hasCaption:t=!1,convId:s}=e,a=rr.a.useMemo((()=>t?{boxShadow:"initial",borderTopLeftRadius:"inherit",borderTopRightRadius:"inherit",borderBottomLeftRadius:0,borderBottomRightRadius:0}:{boxShadow:"initial"}),[t]);return rr.a.createElement("div",{className:"lqip -error lqip-video-error lqip-video clickable",style:a},rr.a.createElement(sL.b,{isVideo:!0}))},dF=s("IzMZ");const uF="bubble-message-sending-indicator-button",hF={Block:uF,Modifiers:{black:"--black",grey:"--grey",sm:"--sm",md:"--md",lg:"--lg"}};var gF=function(e){const{bg:t="black",size:s="md",ringThick:a}=e,i=rr.a.useMemo((()=>({size:"sm"===s?16:"md"===s?28:46,baseRingColor:"var(--WA100)",ringColor:"var(--NG70)",ringThick:isNaN(+a)?"sm"===s?2:3:+a})),[s]);return rr.a.createElement("div",{className:Object(lC.a)(hF.Block,t&&hF.Modifiers[t],s&&hF.Modifiers[s])},rr.a.createElement($w.a,Object(BS.a)({},i,{className:`${uF}__loading`})))};var mF=function(e){const{variant:t}=e;let s=null;return"play"===t?s=rr.a.createElement("div",{className:lF.j},rr.a.createElement("i",{className:"fa fa-play"})):"loading"===t&&(s=rr.a.createElement(gF,{size:"md",ringThick:2})),rr.a.createElement("div",{className:lF.e},s)};var pF=function(e){const{children:t,className:s,isClickable:a,isHoverDeactivated:i,isNoBackgroundColor:n,isSelected:r}=e;return rr.a.createElement("div",{className:Object(lC.a)(lF.a,r&&lF.b.Selected,a&&lF.b.Clickable,i&&lF.b.HoverDeactivated,s)},t)};function fF(e){return Ee.l||e.localPath?"play":e.isDownloadError?"loading":"play"}var vF=s("eZmn");function _F(e,t){const{className:s,conversation:a,handleDownloadResult:i,message:n,onLoad:r,style:o,thumbUrl:l,userId:c}=e;return rr.a.createElement(vF.a,{ref:t,className:s,onLoad:r,style:o,src:l,cacheFolderName:"Cache",userId:c,message:n,downloadCallback:i,conversation:a,showPlayButton:!1})}var bF=rr.a.forwardRef(_F);const IF=rr.a.forwardRef((function(e,t){var s,a;const{clickVideo:i,contentSize:n,conversation:r,data:o,handleDownloadResult:l,isDownloadError:c,isExpired:d,isMultiSel:u,isNonPersonalCloudKeyError:h,isSelected:g,localPath:m,onLoadVideo:p}=e,{UIContent:f}=o,v=f.thumbUrl,_=f.duration,b=rr.a.useMemo((()=>({height:n.height-2+"px",maxHeight:oF+"px",width:n.width-2+"px"})),[n]);return h?rr.a.createElement("div",{className:"relative flx",onClick:i},rr.a.createElement(Dy.e,{className:Object(lC.a)("outline-bubble","rounded-5",lF.h,g&&lF.i.Selected),disableEvents:u,msgIds:[null==o?void 0:o.msgId],style:b,type:"video",windowId:"1",entry:lL.a.CSC,message:o,devSrc:"VideoMessageNonCaption"})):d?rr.a.createElement("div",{className:Object(lC.a)("relative",d?"":"clickable"),onClick:i,style:Object(I.a)(Object(I.a)({},b),{},{borderRadius:"inherit"})},rr.a.createElement(cF,{convId:null==o?void 0:o.toUid})):rr.a.createElement("div",{className:"relative flx",onClick:i},rr.a.createElement(bF,{ref:t,className:Object(lC.a)(lF.k,"rounded-5"),conversation:r,handleDownloadResult:l,message:o,onLoad:p,style:b,thumbUrl:v,userId:null!==(s=null!==(a=null==r?void 0:r.userId)&&void 0!==a?a:o.toUid)&&void 0!==s?s:""}),rr.a.createElement(pF,{className:Object(lC.a)("rounded-t-5","rounded-b-5"),isClickable:!0,isHoverDeactivated:Boolean(u),isSelected:g},rr.a.createElement(dF.a,{duration:_}),rr.a.createElement(mF,{variant:fF({isDownloadError:c,localPath:m})})),rr.a.createElement(rL.b,{entry:rL.a.csc,message:o,devSrc:"VideoMessageNonCaption"}))}));function yF(e,t){const{data:s,doubleClick:a,isHighlightedByPrivilegedUser:i,isFocused:n,observeIntersectionForReading:r,showMessageContextMenu:o}=e,{UIContent:l}=s,c=rr.a.useRef(null);return Object(kT.a)(c,r),l?rr.a.createElement(NT.a,{className:Object(lC.a)(lF.f,i&&(null==s.ttl||0==s.ttl)&&lF.g.HighlightFromPrivilegedUser,"focused-item",n&&"focused-item--highlight-border"),border:6,isAdmin:i,ttl:s.ttl,variant:"photo"},rr.a.createElement("div",{ref:c,"data-qId":Object(fe.g)(s),onContextMenu:o,onDoubleClick:a},rr.a.createElement(IF,Object(BS.a)({},e,{ref:t})))):null}var SF=rr.a.forwardRef(yF);const CF=rr.a.forwardRef((function(e,t){var s,a;const{clickVideo:i,contentSize:n,conversation:r,data:o,doubleClick:l,handleDownloadResult:c,isDownloadError:d,isExpired:u,isMultiSel:h,isNonPersonalCloudKeyError:g,isSelected:m,localPath:p,onLoadVideo:f}=e,{UIContent:v}=o,_=v.thumbUrl,b=v.duration,y=rr.a.useMemo((()=>({height:n.height-2+"px",maxHeight:oF+"px",width:n.width-2+"px"})),[n]);return g?rr.a.createElement("div",{className:"relative flx",onClick:i,onDoubleClick:l},rr.a.createElement(Dy.e,{className:Object(lC.a)("outline-bubble","rounded-t-5",lF.h,m&&lF.i.Selected),disableEvents:h,msgIds:[null==o?void 0:o.msgId],style:y,type:"video",windowId:"1",entry:lL.a.CSC,message:o,devSrc:"VideoMessageWithCaption"})):u?rr.a.createElement("div",{className:Object(lC.a)("relative",u?"":"clickable"),onClick:i,onDoubleClick:l,style:Object(I.a)(Object(I.a)({},y),{},{borderRadius:"inherit"})},rr.a.createElement(cF,{hasCaption:!0,convId:null==o?void 0:o.toUid})):rr.a.createElement("div",{className:"relative flx",onClick:i,onDoubleClick:l,style:y},rr.a.createElement(bF,{ref:t,className:Object(lC.a)(lF.k,"rounded-t-5"),conversation:r,handleDownloadResult:c,message:o,onLoad:f,style:y,thumbUrl:_,userId:null!==(s=null!==(a=null==r?void 0:r.userId)&&void 0!==a?a:o.toUid)&&void 0!==s?s:""}),rr.a.createElement(pF,{className:Object(lC.a)("rounded-t-5"),isClickable:!0,isHoverDeactivated:Boolean(h),isSelected:m},rr.a.createElement(dF.a,{duration:b}),rr.a.createElement(mF,{variant:fF({isDownloadError:d,localPath:p})})),rr.a.createElement(rL.b,{entry:rL.a.csc,message:o,devSrc:"VideoMessageWithCaption"}))}));function EF(e,t){const{contentSize:s,data:a,isFocused:i,isHighlightedByPrivilegedUser:n,isMultiSel:r,isSelected:o,observeIntersectionForReading:l,SentTimeCompRenderer:c,showMessageContextMenu:d}=e,{UIContent:u}=a,h=rr.a.useRef(null);if(Object(kT.a)(h,l),!u)return null;const g="0"===a.fromUid,m=rr.a.useMemo((()=>({height:s.height-2+"px",maxHeight:oF+"px",width:s.width-2+"px"})),[s]),p=Y.UIMessagePrefixElementID.VideoMessage+Object(fe.j)(a),f=rr.a.useCallback((e=>{d(e,{captionContainerElementId:p})}),[]);return rr.a.createElement(NT.a,{className:Object(lC.a)(lF.n,n&&(null==a.ttl||0==a.ttl)&&lF.o.HighlightFromPrivilegedUser,"rounded-6","focused-item",i&&"focused-item--highlight-border"),border:6,isAdmin:n,variant:"photo",ttl:a.ttl},rr.a.createElement("div",{ref:h,"data-qId":Object(fe.g)(a),onContextMenu:d},rr.a.createElement(CF,Object(BS.a)({},e,{ref:t})),rr.a.createElement("div",{id:p,className:Object(lC.a)(lF.l,"rounded-bl-6","rounded-br-6",o&&lF.m.Selected,g&&lF.m.Blue,r&&"clickable"),onContextMenu:f,style:{width:m.width}},Object(OR.a)(u.caption,e),c?rr.a.createElement(c,null):null)))}var OF=rr.a.forwardRef(EF);var MF=function(e){var t;const{chatId:s,containerWidth:i,conversation:n,data:r,isMultiSel:o,selectedMsg:l={},SentTimeCompRenderer:c,showContextMenu:d,turnOnMultipleSelectionMode:u,user:h}=e,g=Boolean(o&&l[r.msgId]),{status:m}=Object(Lw.a)(r,"VideoMessage"),p=Object(oL.a)(r),[f,v,_]=rF(!1),[b,y]=rr.a.useState(null!==(t=r.localPath)&&void 0!==t?t:""),S=rr.a.useRef(),C=rr.a.useRef(!1),E=Object(YS.a)();rr.a.useEffect((()=>{yw.a.getInstance().push(r,yw.b.chatview)}),[]);const O=Object(DR.a)(((e,t)=>{!0!==e&&(e?v():M(t))})),M=Object(DR.a)((e=>{var t;if(r.status<Y.MSG_SENT)return;y(e),null===(t=a.ModuleContainer.resolve(Re.a))||void 0===t||t.updateMedia("image",r.toUid,r.msgId,{localPath:e},["localPath"]);const s=r.toUid;we.default.updateMessage(r.msgId,{msgId:r.msgId,localPath:e},["localPath"],s),E({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:Object(I.a)(Object(I.a)({},r),{},{localPath:e})})})),[T]=function(e,t=200){const s=Object(lR.a)(e,t);return[s,s.cancel]}((e=>{(()=>{const e=JSON.parse(JSON.stringify(r));b&&(e.localPath=b);const t={user:h,selectedId:e.msgId,oriUrl:e.message.oriUrl,userId:e.userId,isVideo:e.msgType===Y.MSG_VIDEO||2===e.subType,message:e,conversation:n,isMessageConv:!0,images:[r],iconMap:Dd.b.getIconMap(),appConfig:Object(Ce.getPVConfigs)()};me.a.OpenPhoto.openPhotoViewer(t)})(),Object(ge.c)(r,ge.a.UserAction),Ce.default.cloud_send2me.enable&&s==Ce.default.sendToMeId&&yR.b.log(yR.a.OPEN,1,r),_()})),w=Object(DR.a)((e=>{e&&e.stopPropagation(),o?u(e,r):T(e)})),R=Object(DR.a)((()=>{if(!0===C.current)return;const e=JSON.parse(JSON.stringify(r));let t;if(e.UIContent&&e.status!=Y.MSG_LOCAL&&e.status!=Y.MSG_FAIL&&S.current&&"function"==typeof S.current.getThumbEle&&(t=S.current.getThumbEle()))try{const s=e.UIContent.width,a=e.UIContent.height;if(s!==t.naturalWidth||a!==t.naturalHeight){const s={video_width:t.naturalWidth,video_height:t.naturalHeight,parsed:1};C.current=!0,we.default.updateMessageParams(e.msgId,s,e)}}catch(s){}})),L=Object(DR.a)((e=>{e&&e.stopPropagation()})),D=Y.UIMessagePrefixElementID.VideoMessage+Object(fe.j)(r);let A=Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;g&&l[r.msgId]&&(A=l[r.msgId].multipleSelectedType||Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const F=Object(DR.a)(((e,t)=>{"function"==typeof d&&d({event:e,message:r,detail:Object(I.a)({},t)})})),k=function(e,t=-1){const s=160,a=110,i=368;let n=Math.min(798,isNaN(t)?798:t);t<=-1&&(n=i);let r=!1;const o={width:i+"px",height:i+"px",defaultSize:!0};if(!e)return o;let l=e.width,c=e.height;if(void 0!==l&&null!=c||(l=i,c=i,r=!0),!e.parsed&&fp.a(e.rotation)&&Boolean(+e.rotation/90%2)){const e=l;l=c,c=e}if(l>0&&c>0){let t=l,o=c;if(l<s&&c<a)o=a,t=s;else if(l>n&&c>i){let e=i/c;if(o=i,t=Math.round(l*e),t>n){e=n/t,t=n;let s=Math.round(o*e);o=Math.max(s,a)}t=Math.max(t,s)}else if(c>i){let e=i/c;o=i;let a=Math.round(l*e);t=Math.max(s,a)}else if(c>=a&&c<=i){if(l>n){let e=n/l;t=n;let s=Math.round(c*e);o=Math.max(a,s)}else if(l<s){t=s;let e=s/l,n=Math.round(c*e);o=Math.min(Math.max(a,n),i)}}else if(c<a){o=a;let e=a/c,i=Math.round(e*l);t=l>n?n:Math.min(Math.max(s,i),n)}return{height:o+"px",width:t+"px",defaultSize:r,rotation:e.rotation}}return o}(r.UIContent,i-201),N=rr.a.useMemo((()=>{if(k.width){const e=parseInt(k.height),t=parseInt(k.width);return{height:isNaN(e)?oF:e,width:isNaN(e)?oF:t}}return{width:oF,height:oF}}),[k.width,k.height]),P=Object(DR.a)((()=>{FL.a.logActionMediaCaption(n,r,k.width)}));rr.a.useEffect((()=>{P()}),[k.width]);const j=Boolean(r.message&&r.message.title);let U=r.UIContent&&r.status!=Y.MSG_LOCAL&&r.status!=Y.MSG_FAIL&&"none"===m;return j?rr.a.createElement(OF,Object(BS.a)({},e,{ref:S,clickVideo:w,containerId:D,contentSize:N,doubleClick:L,isDownloadError:f,isExpired:U,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:O,localPath:b,onLoadVideo:R,SentTimeCompRenderer:c,showMessageContextMenu:F})):rr.a.createElement(SF,Object(BS.a)({},e,{ref:S,clickVideo:w,containerId:D,contentSize:N,doubleClick:L,isDownloadError:f,isExpired:U,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:O,localPath:b,onLoadVideo:R,showMessageContextMenu:F}))};var TF=Ge;let wF;var RF={GetManager:()=>{var e;return null!==(e=wF)&&void 0!==e?e:wF=a.ModuleContainer.resolve(TF)}};const LF="voice-message-loading",DF=LF+"__indicator-wrapper",AF=LF+"__indicator",FF="voice-message-expired",kF=FF+"__icon-wrapper",NF=FF+"__content-wrapper",PF="voice-message-invalid",jF=PF+"__title-container",UF=PF+"__title-icon-wrapper",BF=PF+"__title-content-wrapper",zF=PF+"__description-container",GF=PF+"__description-icon-wrapper",xF=PF+"__description-content-wrapper",VF="voice-message-normal",HF=VF+"__content-container",WF=VF+"__player-control-wrapper",qF=VF+"__waveform-wrapper",KF=VF+"__waveform-col-one",$F={Playing:KF+"--playing"},ZF=VF+"__waveform-col-two",QF={Playing:ZF+"--playing"},YF=VF+"__waveform-col-three",JF={Playing:YF+"--playing"},XF=VF+"__duration-wrapper";var ek=function(e){let{toUid:t}=null==e?void 0:e.message,s=t===Ce.default.sendToMeId;const a=UE.a.getInstance().isPaidUser()||s?"STR_ZCLOUD_VOICE_UNAVAILABLE":"STR_CLOUD_VOICE_EXPIRED_ALL",i=Object(LR.c)(a);return rr.a.createElement("div",{className:FF},rr.a.createElement("div",{className:kF},rr.a.createElement("i",{className:"fa fa-Mic-off_24_Filled"})),rr.a.createElement("div",{className:NF},i))};var tk=function(e){const t=Object(LR.c)("STR_VOICE_MESSAGE"),s=Object(LR.c)("STR_E2EE_VOICE_NOT_SUPPORT");return rr.a.createElement("div",{className:PF},rr.a.createElement("div",{className:jF},rr.a.createElement("div",{className:UF},rr.a.createElement("i",{className:"fa fa-Mic_24_Line"})),rr.a.createElement("div",{className:BF},t)),rr.a.createElement("div",{className:zF},rr.a.createElement("div",{className:GF},rr.a.createElement("i",{className:"fa fa-Warning_Circle_24_Line"})),rr.a.createElement("div",{className:xF},s)))},sk=s("Nd7d");var ak=function(){return rr.a.createElement("div",{className:VF},rr.a.createElement("div",{className:HF},rr.a.createElement("div",{className:DF},rr.a.createElement(sk.a,{className:AF,color:"var(--B50)",size:20})),rr.a.createElement("div",{className:qF},rr.a.createElement("div",{className:KF}),rr.a.createElement("div",{className:ZF}),rr.a.createElement("div",{className:YF})),rr.a.createElement("div",{className:XF},"--:--")))};const ik=function(){let e=null;return{GetFactory:()=>(null===e&&(e=a.ModuleContainer.resolve(Le)),e)}}();var nk={Audio:RF,MediaPlayer:ik};var rk=s("WKSW"),ok=s("LkXv");const lk="readyplay",ck="loading";var dk=function(e){const{duration:t,message:s,source:i,reloadResource:n}=e,[r,o]=rr.a.useState(null),[l,c]=rr.a.useState(t),[d,u]=rr.a.useState(!1),[h,g]=rr.a.useState(ck),[m,p]=rr.a.useState(!1);rr.a.useEffect((()=>{const e=nk.MediaPlayer.GetFactory().createAudioPlayer();return o(e),()=>{nk.MediaPlayer.GetFactory().deleteMediaPlayer(e.getToken())}}),[]),rr.a.useEffect((()=>(r&&(i!==r.getSource()&&(r.release(),r.setSource(i)),r.prepare(),r.addEventListener("canplay",((e,t)=>{g(lk)})),r.addEventListener("durationchange",((e,t)=>{c(1e3*t)})),r.addEventListener("ended",(()=>{u(!1)})),r.addEventListener("timeupdate",((e,t)=>{c(1e3*t.remainingTime)})),r.addEventListener("onabort",((e,t)=>{Object(ok.c)("onabort",null==s?void 0:s.msgId)})),r.addEventListener("onerror",((e,t)=>{var a;Object(ok.c)("onerror",null==s?void 0:s.msgId),a=e,Object(ok.c)("onerror",null==s?void 0:s.msgId,a),null==r||r.stop(),u(!1)}))),()=>{})),[i,r]),rr.a.useEffect((()=>{m?v():p(!1)}),[m]);const f=function(e){return e<0?"--:--":WO.a.getMinutesFromSeconds(Math.round(e))}(l/1e3),v=()=>{Object(rk.a)(s)?a.ModuleContainer.resolve(Dy.c).getErrorPCloudHandler({msgIds:[null==s?void 0:s.msgId],windowId:hr.c,error:{hasNoKey:!0},showNoti:!0,type:"audio"})():h===lk?(u(!d),r&&(d?r.stop():r.play())):(n((e=>{g(lk),p(!0)}),(e=>{})),u(!1),null==r||r.stop())};return rr.a.createElement("div",{className:VF,onClick:v,id:i},rr.a.createElement("div",{className:HF},rr.a.createElement("div",{className:WF},d?rr.a.createElement("i",{className:"fa fa-StopCircle_24_Filled"}):rr.a.createElement("i",{className:"fa fa-PlayCircle_24_Filled"})),rr.a.createElement("div",{className:qF},rr.a.createElement("div",{className:Object(lC.a)(KF,d&&$F.Playing)}),rr.a.createElement("div",{className:Object(lC.a)(ZF,d&&QF.Playing)}),rr.a.createElement("div",{className:Object(lC.a)(YF,d&&JF.Playing)})),rr.a.createElement("div",{className:XF},f)),rr.a.createElement(rL.b,{entry:rL.a.csc,message:s,devSrc:"VoiceMessageNormal"}))},uk=s("YHwM");function hk(e){var t,s;if(!e)return 0;let a=null==e||null===(t=e.message)||void 0===t?void 0:t.params;if("string"==typeof a)try{a=JSON.parse(a)}catch(i){}return null!==(s=a)&&void 0!==s&&s.duration?Math.round(+a.duration/1e3):0}var gk=function(e){const{data:t}=e,[s,a]=rr.a.useState(null),i=Object(eD.a)(),{flag:n,status:r}=Object(Lw.a)(t,"VoiceMessage"),o=rr.a.useCallback(((e,s)=>{try{RF.GetManager().reloadResourceFromMessage(t).then((i=>{a({localURL:i.localURL,URL:i.URL,status:i.status}),"playable"===(null==i?void 0:i.status)?null==e||e(i.localURL||i.URL):(null==s||s(),Object(uk.a)(t))})).catch((e=>{null==s||s(e)}))}catch(i){null==s||s(i)}}),[t]);rr.a.useEffect((()=>{RF.GetManager().loadResourceFromMessage(Object(I.a)(Object(I.a)({},t),{},{content:t.UIContent}),{windowId:i}).then((e=>{a({localURL:e.localURL,URL:e.URL,status:e.status})}))}),[t.msgId]),rr.a.useEffect((()=>{yw.a.getInstance().push(t,yw.b.chatview)}),[]);let l=null;if("none"===r)l=rr.a.createElement(ek,{message:t});else if(null==s)l=rr.a.createElement(ak,null);else if("playable"===s.status||"clouded"===r||n&It.d.server_temp){var c;l=rr.a.createElement(dk,{duration:null!==(c=t.UIContent.duration)&&void 0!==c?c:hk(t),message:t,source:s.localURL||s.URL,reloadResource:o})}else l="expired"===s.status?rr.a.createElement(ek,{message:t}):"not-supported"===s.status?rr.a.createElement(tk,null):rr.a.createElement(ek,{message:t});return rr.a.createElement("div",{id:Y.UIMessagePrefixElementID.VoiceMessage+Object(fe.j)(t),className:"voice-message"},l)};var mk=s("PWbL");var pk=function(e){const{conversation:t,data:s,isFocused:a,sendTimeComp:i,user:n}=e,r=Object(eD.a)();return rr.a.createElement(mk.b,{key:s.msgId,message:s,user:n,conversation:t,windowId:r,isFocused:a,sourceRender:mk.a.MESSAGE_WIDGET,sendTime:i})};var fk,vk={[UM.e.Call]:{configs:{layoutType:UM.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:sw,transformData:nT},[UM.e.Contact]:{configs:{layoutType:UM.d.NoFrame,layout:{maxWidth:306,width:"100%"}},component:vw,transformData:oT},[UM.e.DFE]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:_w},[UM.e.E2eeDecryptFailed]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:YM},[UM.e.E2eePendingData]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:XM},[UM.e.File]:{configs:{layout:{maxWidth:400,width:"100%"},hasDynamicBorder:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(Bw.a)(e))}}},component:Uw,transformData:lT},[UM.e.GIF]:{configs:{layoutType:UM.d.NoFrame,shouldShowMessageStatusSideIndicator:!1},component:oR},[UM.e.Link]:{"recommened.link":{configs:{layout:{maxWidth:400,minWidth:220}},component:RR,transformData:uT}},[UM.e.Location]:{configs:{layoutType:UM.d.NoFrame},component:QR,transformData:gT},[UM.e.OA]:{configs:{layoutType:UM.d.NoFrame,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:sD},[UM.e.Photo]:{configs:{disablePointerEvent:!1,layoutType:UM.d.NoFrame,reaction:{},messageQuickActionConfig:{canReply:function(e){return!!e&&e.msgType!==Y.MSG_PHOTO_GROUP},canForward:function(e){if(!e)return!1;if(e.msgType===Y.MSG_PHOTO_GROUP){const t=e.message;for(let e=0;e<t.length;e++)if(Object(Bw.a)(t[e]))return!0;return!1}return!!Object(Bw.a)(e)}},shouldShowMessageStatusSideIndicator:e=>{if(!Object(m_.w)(e))return!1;if(!Object(m_.o)(e))return!1;const t=e.message;if(!t||t.length<=1)return!1;return t.every(m_.l)}},component:XL},[UM.e.StickerGroup]:{configs:{canReact:!1,canDoubleClick:!1,disablePointerEvent:!1,messageQuickActionConfig:{canReply:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==Y.MSG_FAIL&&s.status!==Y.MSG_LOCAL&&(s.msgType!==Y.MSG_UNDO&&s.msgType!==Y.MSG_DEL_EVERYONE))},canForward:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==Y.MSG_FAIL&&s.status!==Y.MSG_LOCAL&&(s.msgType!==Y.MSG_UNDO&&s.msgType!==Y.MSG_DEL_EVERYONE))}},layoutType:UM.d.NoFrame,shouldShowMessageStatusSideIndicator:e=>{if(!Object(m_.w)(e))return!1;if(!Object(m_.p)(e))return!1;const t=e.message;if(!t||t.length<=1||Object(m_.x)(t[0]))return!1;return t.every(m_.l)}},component:HA,transformData:OT},[UM.e.StickerSet]:{configs:{canReact:!1,messageQuickActionConfig:{canForward:!1},layoutType:UM.d.NoFrame},component:qA,transformData:wT},[UM.e.Text]:{configs:{hasDynamicBorder:!0},component:aF,transformData:RT},[UM.e.Undo]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1},isEditable:e=>{var t;if("string"!=typeof e.message)return!1;return Date.now()-e.sendDttm<(null===(t=s("NDmK"))||void 0===t?void 0:t.default).time_enable_edit_undo_msg}},component:iF},[UM.e.Unknown]:{configs:{canReact:!1,canClick:!1,canDoubleClick:!1,canContextMenu:!1},component:nF},[UM.e.Video]:{configs:{layoutType:UM.d.NoFrame,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(Bw.a)(e))}}},component:MF,transformData:DT},[UM.e.Voice]:{configs:{alwaysShowTimeOutSide:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(Bw.a)(e))}}},component:gk,transformData:FT},[UM.e.ZInstant]:{configs:{layoutType:UM.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:pk}},_k=s("uave");Object(Ai.b)(_k.b)(fk=Object(a.injectable)()(fk=Reflect.metadata("design:type",Function)(fk=Reflect.metadata("design:paramtypes",[])(fk=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.messageContents=void 0,this.name=_k.a,this.key=_k.a,this.data=new Map,this.messageContents=new Map,this.setupMessageContents()}async onChangeMessages(e){const t=(new Date).getTime().toString();Object(Po.j)(t),e.forEach((e=>{e.msgId&&(this.data.set(e.msgId,e),Object(Po.g)(t,this.name,e.msgId))})),Object(Po.c)(t)}onRemoveMessages(e){e.forEach((e=>{this.data.delete(e)}))}getMessageAction(e,t){const s=this.messageContents.get(e);return s?s.configs?s:t?s[t]:null:null}getItem(e,t){return this.data.get(e.key)}setupMessageContents(){for(const[e,t]of Object.entries(vk))this.messageContents.set(e,t)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||fk)||fk)||fk);var bk,Ik=s("Vh8h"),yk=s("kEG/");function Sk(){return"number"==typeof Ce.default.async_forward.checked_url_cache_expiration_time?Ce.default.async_forward.checked_url_cache_expiration_time:36e5}function Ck(){return!Ce.default.async_forward.disable_cache_check_exist}function Ek(){return Oa.a.now()}var Ok=Object(a.injectable)()(bk=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(bk=Reflect.metadata("design:type",Function)(bk=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(bk=class{constructor(e){this._checkedMap=new Map,this._currentCheckingRequestAmount=0,this._urlChangedMap=new Map,this._logger=void 0,this._isQueueExecuting=!1,this._queue=[],J.p.listenEvent(J.k,this.onNetworkChange.bind(this)),this.Logger=e.createZLogger("utils",["share-file-handler"])}check(e){return new Promise(((t,s)=>{Ck()&&this.checkedMap.has(e)&&Ek()-this.checkedMap.get(e)<Sk()?(t(!0),this.executeQueue()):this.enqueueExecution(e,t,s)}))}getNewUrl(e){return this.urlChangedMap.get(e)||e}updateFileUrl(e,t){this.urlChangedMap.set(e,t),this.checkedMap.set(t,Ek())}decreaseRequestAmount(){this._currentCheckingRequestAmount--}enqueueExecution(e,t,s,a=!0){this.executionQueue.push({url:e,resolve:t,reject:s,shouldRetry:a}),this.executeQueue()}executeQueue(){if(!this.isQueueExecuting()){for(this.setExecutionQueueWorking();this.getCurrentNetworkStatus()!==ce.a.DISCONNECT&&this.getCurrentRequestAmount()<=("number"==typeof Ce.default.async_forward.maximum_requests_in_a_while?Ce.default.async_forward.maximum_requests_in_a_while:5)&&this.executionQueue.length>0;){let e=this.executionQueue.shift();this.increaseRequestAmount(),this.processCheckingRequest(e).then((()=>{this.handleResponse(e,!0,null)})).catch((t=>{var s;this.handleResponse(e,!1,null===(s=t.data)||void 0===s?void 0:s.status)}))}this.setExecutionQueueFree()}}getCurrentNetworkStatus(){return ce.b.getStateNetwork()}getCurrentRequestAmount(){return this._currentCheckingRequestAmount}increaseRequestAmount(){this._currentCheckingRequestAmount++}isQueueExecuting(){return this._isQueueExecuting}onNetworkChange(){this.getCurrentNetworkStatus()===ce.a.CONNECTED&&(this.Logger.zsymb(21,"swK5_K",["network was connected, start executing check-exist queue","3pmHqa"]),this.executeQueue())}setExecutionQueueFree(){this._isQueueExecuting=!1}setExecutionQueueWorking(){this._isQueueExecuting=!0}handleResponse(e,t,s){this.decreaseRequestAmount(),t?(this.checkedMap.set(e.url,Ek()),this.executeQueue()):s===yk.b.ClientError.RequestTimeout&&e.shouldRetry?this.enqueueExecution(e.url,e.resolve,e.reject,!1):(this.checkedMap.set(e.url,0),this.executeQueue()),e.resolve(t)}tryToLoadUrl(e){return new Promise(((t,s)=>{const a=91047;!function(e,t={}){const s=Date.now(),a=Ek();let i=e.replace("http://","https://");i=ui.default.removeE2eeProtocol(i);const{onabort:n=null,onerror:r=null,onload:o=null,ontimeout:l=null,timeout:c=1e4}=t,d=new XMLHttpRequest;d.open("HEAD",i),d.responseType="arraybuffer",d.timeout=c,Ee.l||d.setRequestHeader("Cache-Control","no-cache");const u=()=>({duration:Ek()-a,startTime:s});d.onload=e=>{o&&o(e,u())},d.onerror=e=>{r&&r(e,u())},d.ontimeout=e=>{l&&l(e,u())},d.onabort&&(d.onabort=e=>{n&&n(e,u())}),d.send()}(e,{onabort:(e,t)=>{ul.default.increaseFailed(a,0,t.duration,4,t.startTime),s(e.target.status)},onerror:(e,t)=>{this.Logger.zsymb(21,"yhcT5x",["check-exist error: {}","UDhrgh"],e),ul.default.increaseFailed(a,0,t.duration,2,t.startTime),s(e.target.status)},onload:(e,i)=>{e.target.status>=400?(ul.default.increaseFailed(a,0,i.duration,3,i.startTime),s(e.target.status)):e.target.responseURL&&e.target.responseURL.indexOf("default")>=0?(ul.default.increaseFailed(a,0,i.duration,5,i.startTime),s(e.target.status)):(ul.default.increaseSuccess(a,0,i.duration),t(!0))},ontimeout:(e,t)=>{ul.default.increaseFailed(a,0,t.duration,1,t.startTime),s(e.target.status)}})}))}async processCheckingRequest(e){if(!e)return Promise.reject({message:"Invalid request item",data:null});const{url:t}=e;if(Ck()&&this.checkedMap.has(t)){let e=this.checkedMap.get(t);if(Ek()-e<Sk())return Promise.resolve()}if(Ee.l&&!ui.default.isConnectSrc(t))try{return await Object(Ik.b)(t,"number"==typeof Ce.default.async_forward.checking_url_timeout?Ce.default.async_forward.checking_url_timeout:1e4),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:0}})}try{return await this.tryToLoadUrl(t),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:s}})}}get checkedMap(){return this._checkedMap}get executionQueue(){return this._queue}get urlChangedMap(){return this._urlChangedMap}get Logger(){return this._logger}set Logger(e){this._logger=e}})||bk)||bk)||bk)||bk,Mk=s("vyPS");a.ModuleContainer.register(Mk.a,Ok);s("Ws6j");var Tk=s("GaKD"),wk=s("Y65e");const Rk=a.ModuleContainer.resolve(zs.b),Lk=(e,t)=>(s,a,i)=>{const n=i.value;i.value=function(...s){const a=performance.now(),i=n.apply(this,s);if(i instanceof Promise)return E.c.catchAsyncFn((()=>i)).then((([i,n])=>{const r=performance.now()-a,o=Object(I.a)({commandId:e,success:!i,errorCode:null==i?void 0:i.code,duration:r},null==t?void 0:t(s,[i,n],r));if(Rk.log(o),i)throw i;return n}));{const n=performance.now()-a,r=Object(I.a)({commandId:e,success:!0,duration:n},null==t?void 0:t(s,[null,i],n));return Rk.log(r),i}}};let Dk=function(e){return e[e.CLIENT_PARSER=111026]="CLIENT_PARSER",e[e.SERVER_PARSER=111027]="SERVER_PARSER",e[e.NOOP_PARSER=111028]="NOOP_PARSER",e[e.DOWNLOAD_THUMB=111029]="DOWNLOAD_THUMB",e[e.UPLOAD_THUMB=111030]="UPLOAD_THUMB",e[e.PREVIEW_INTEGRITY=111031]="PREVIEW_INTEGRITY",e}({});var Ak,Fk,kk,Nk,Pk;let jk=(Ak=Lk(Dk.NOOP_PARSER,(([e])=>({params:[e]}))),Fk=Reflect.metadata("design:type",Function),kk=Reflect.metadata("design:paramtypes",[String]),Pk=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e){return!0}async parse(e){return null}},Pk.instance=null,Nk=Pk,Object(wk.a)(Nk.prototype,"parse",[Ak,Fk,kk],Object.getOwnPropertyDescriptor(Nk.prototype,"parse"),Nk.prototype),Nk);var Uk=s("G95d"),Bk=s("dXzg");let zk=function(e){return e[e.UNKNOWN_ERROR=100]="UNKNOWN_ERROR",e[e.URL_ERROR=101]="URL_ERROR",e[e.HTTP_STATUS_ERROR=102]="HTTP_STATUS_ERROR",e[e.REDIRECT_ERROR=103]="REDIRECT_ERROR",e[e.PARSE_XML_HEAD_ERROR=104]="PARSE_XML_HEAD_ERROR",e[e.HTTP_REQUEST_ERROR=105]="HTTP_REQUEST_ERROR",e[e.EMPTY_METADATA=106]="EMPTY_METADATA",e[e.HTTP_TIMEOUT_REQUEST_ERROR=107]="HTTP_TIMEOUT_REQUEST_ERROR",e[e.HTTP_NOTFOUND_ERROR=108]="HTTP_NOTFOUND_ERROR",e[e.HTTP_CONNREFUSED_ERROR=109]="HTTP_CONNREFUSED_ERROR",e[e.HTTP_CONNRESET_ERROR=110]="HTTP_CONNRESET_ERROR",e[e.CLOUDFLARE_MITIGATED_ERROR=111]="CLOUDFLARE_MITIGATED_ERROR",e[e.PARSE_LINK_SERVER_ERROR=200]="PARSE_LINK_SERVER_ERROR",e[e.DOWNLOAD_THUMB_ERROR=300]="DOWNLOAD_THUMB_ERROR",e[e.THUMB_SIZE_ERROR=301]="THUMB_SIZE_ERROR",e[e.THUMB_TYPE_ERROR=302]="THUMB_TYPE_ERROR",e[e.WEBP_THUMB_TYPE_ERROR=303]="WEBP_THUMB_TYPE_ERROR",e[e.UPLOAD_THUMB_ERROR=400]="UPLOAD_THUMB_ERROR",e[e.COMPRESS_THUMB_ERROR=401]="COMPRESS_THUMB_ERROR",e[e.GET_PARSER_ERROR=500]="GET_PARSER_ERROR",e}({});const Gk=(e,t)=>{if(e)throw t};class xk extends Error{constructor(e,t,s,a=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[...a,s],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="UnknownError",code:s=zk.UNKNOWN_ERROR,message:a,stack:i,qosParams:n=[]}=e,r=new xk(t,s,a);return r.qosParams=n,r.setStack(i),r}}class Vk extends xk{constructor(e,t,s){super("ParseLinkServerError",zk.PARSE_LINK_SERVER_ERROR,`Parse link server failed. Url: ${e}. Message: ${t}`,s)}}class Hk extends xk{constructor(e,t){super("UploadThumbError",zk.UPLOAD_THUMB_ERROR,`Upload thumb failed. Message: ${e}`,t)}}class Wk extends xk{constructor(e,t){super("CompressThumbError",zk.COMPRESS_THUMB_ERROR,`Compress thumb failed. Message: ${e}`,t)}}const qk=1048576,Kk={GB:1073741824,MB:qk,KB:1024,byte:1};let $k;var Zk;(Zk=$k||($k={})).sizeInByte=e=>{const t=/(\d+)(byte|KB|MB|GB)/g;let s,a=0;for(;s=t.exec(e);)a+=parseInt(s[1])*Kk[s[2]];return a},Zk.getFileSizeByHead=async(e,t)=>{const s=await fetch(e,{method:"HEAD"}),a=s.headers.get("content-length"),i=s.headers.get("content-type");if(t&&t!=i)throw new Error(`An error occurred when trying to get file size. Error: unexpected content-type.Content-type expectation is "${t}" but received Content-type is "${i}".`);return Number(null!=a?a:0)};var Qk=function(e){return e[e.META_TITLE=0]="META_TITLE",e[e.META_DESCRIPTION=1]="META_DESCRIPTION",e[e.META_THUMB=2]="META_THUMB",e[e.DOCUMENT=3]="DOCUMENT",e}(Qk||{}),Yk=function(e){return e[e.NOT_FOUND=0]="NOT_FOUND",e[e.INVALID_FORMAT=1]="INVALID_FORMAT",e[e.DOWNLOAD_ERROR=2]="DOWNLOAD_ERROR",e}(Yk||{});class Jk{constructor(){}async fetch(e){const[t,s]=await E.c.catchAsyncFn((()=>this.fetchLinkInfoFromServer(e)));Gk(!!t,t&&new Vk(e,null==t?void 0:t.message));const[a,i]=await this.transformResponse(e,s);return Gk(!!a,a),i}fetchLinkInfoFromServer(e){return Jr.default.getLinkInformation(e).then(Xr.a)}async transformResponse(e,t){var s,i,n;if(a.ModuleContainer.resolve(Bk.a).get("enable_verify_parse_link_server")&&E.g.isNotEmptyObject(t.error_maps))return[new Vk(e,JSON.stringify(t.error_maps)),null];if((null===(s=t.error_maps)||void 0===s?void 0:s[Qk.DOCUMENT])===Yk.DOWNLOAD_ERROR)return[new Vk(e,JSON.stringify(t.error_maps)),null];if(e.endsWith(".pdf")){var r;const s=await $k.getFileSizeByHead(e);return t.data=null!==(r=t.data)&&void 0!==r?r:{},t.data.title=pf.a.getFileNameFromUrl(e),t.data.desc=ui.default.sizeToString(s),t.data.thumb=ui.DEFAULT_THUMB_URLS.ICON_PDF,[null,t.data]}return t.data.thumb&&!((null===(i=t.error_maps)||void 0===i?void 0:i[Qk.META_THUMB])in Yk)||t.data.thumb||t.data.title&&t.data.desc?((null===(n=t.error_maps)||void 0===n?void 0:n[Qk.META_THUMB])in Yk&&(t.data.thumb=""),[null,t.data]):[new Vk(e,JSON.stringify(t)),null]}}var Xk,eN,tN,sN,aN,iN=s("o2mE"),nN=s("/vDv");let rN=(Xk=Lk(Dk.SERVER_PARSER,(([e],t,s)=>(a.ModuleContainer.resolve(iN.b).linkParser.zsymb(12,"-lfDIt","ParseLinkMetric",Dk[Dk.SERVER_PARSER],e,s),{params:[e]}))),eN=Reflect.metadata("design:type",Function),tN=Reflect.metadata("design:paramtypes",[String]),(aN=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){const s=a.ModuleContainer.resolve(Bk.a);if(s.get("enable_force_parse_link_server"))return!0;if(!s.get("enable_parse_link_server"))return!1;const i=s.get("white_list_domain");for(const a of i)if(pf.a.isHrefMatchDomain(e,a))return!0;if((null==t?void 0:t.entry)===Uk.a.MESSAGE_WIDGET)return!0;if(!s.get("enable_parse_link_client")){if(null!=t&&t.convId){if(!nN.a.isE2eeConv(t.convId))return!0}if((null==t?void 0:t.entry)===Uk.a.SHARE_MESSAGE)return!0}return!1}async parse(e){const[t,s]=await E.c.catchAsyncFn((()=>(new Jk).fetch(e)));return Gk(!!t,t),{typeParse:Uk.b.SERVER,href:e,desc:null==s?void 0:s.desc,media:null==s?void 0:s.media,src:null==s?void 0:s.src,stream_icon:null==s?void 0:s.stream_icon,thumb:null==s?void 0:s.thumb,title:null==s?void 0:s.title}}}).instance=null,sN=aN,Object(wk.a)(sN.prototype,"parse",[Xk,eN,tN],Object.getOwnPropertyDescriptor(sN.prototype,"parse"),sN.prototype),sN);var oN=s("poQk");let lN;var cN,dN,uN,hN,gN;!function(e){e.toSafeLowerCase=e=>"string"==typeof e?e.toLowerCase():e,e.toSafeUpperCase=e=>"string"==typeof e?e.toUpperCase():e,e.safeSplit=(e,...t)=>"string"==typeof e?e.split(...t):[];const t=e.trim=e=>e.trim().replace(/ +/g," ");e.truncateWord=(e,s)=>{const a=t(e);if(a.length<=s)return a;let i=s;for(;i>=0&&" "!==a[i];)i--;return i<=0?a.slice(0,s)+"":a.slice(0,i)+""}}(lN||(lN={}));cN=Lk(Dk.CLIENT_PARSER,(([e],[t,s],i)=>{a.ModuleContainer.resolve(iN.b).linkParser.zsymb(12,"MDDNwu","ParseLinkMetric",Dk[Dk.CLIENT_PARSER],e,i);const n={params:[e]};return t&&Array.isArray(null==t?void 0:t.qosParams)&&(n.params=t.qosParams),t||s||(n.success=!1,n.errorCode=zk.EMPTY_METADATA),s&&a.ModuleContainer.resolve(zs.b).log({commandId:Dk.PREVIEW_INTEGRITY,subCommandId:0,duration:0,success:!!s.thumb,params:[e]}),n})),dN=Reflect.metadata("design:type",Function),uN=Reflect.metadata("design:paramtypes",[String]),(gN=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!a.ModuleContainer.resolve(Bk.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==Uk.a.MESSAGE_WIDGET}async parse(e){var t;const s=a.ModuleContainer.resolve(Bk.a),i=s.get("max_redirect"),n=s.get("max_title_character"),r=s.get("max_desc_character"),{enable_log_metric:o,delay_parse_client:l}=s.get("debug"),c=globalThis.__configParseLinkTest__;t=null==c?void 0:c.mockRedirect,null==c||c.mockPreview;let d;{const t={};0;const[s,n]=await E.c.catchAsyncFn((()=>oN.b.exec("parseLink",[e,{maxRedirect:i},t],{priority:oN.a.HIGH})));if(Gk(!!s,s&&xk.createFromObject(s)),[d]=n,o){const[t,s]=n;a.ModuleContainer.resolve(iN.b).linkParser.zsymb(12,"3PV3DB","ParseLinkMetric: ",Dk[Dk.CLIENT_PARSER],"DETAIL",e,{fetch:s.endFetch-s.startFetch,parse:s.endParseMetaData-s.startParseMetaData,total:s.endParseMetaData-s.startFetch,htmlSize:s.htmlSize})}}const u=this.sanitizeMetaData(d,{maxTitleLength:n,maxDescLength:r});return this.isMetaDataFailed(u)?null:{typeParse:Uk.b.CLIENT,href:pf.a.getUrlWithHttpProtocol(e),title:u.title,desc:u.desc,thumb:"",thumbOrigin:u.thumb,media:{},src:u.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:a}=t,{title:i="",desc:n=""}=e,r=E.g.clone(e);return r.title=lN.truncateWord(i||"",s),r.desc=lN.truncateWord(n||"",a),r}}).instance=null,hN=gN,Object(wk.a)(hN.prototype,"parse",[cN,dN,uN],Object.getOwnPropertyDescriptor(hN.prototype,"parse"),hN.prototype);var mN,pN,fN,vN,_N;let bN=(mN=Lk(Dk.CLIENT_PARSER,(([e],[t,s],i)=>{a.ModuleContainer.resolve(iN.b).linkParser.zsymb(12,"6Leta8","ParseLinkMetric",Dk[Dk.CLIENT_PARSER],e,i);const n={params:[e]};return t&&Array.isArray(null==t?void 0:t.qosParams)&&(n.params=t.qosParams),t||s||(n.success=!1,n.errorCode=zk.EMPTY_METADATA),s&&a.ModuleContainer.resolve(zs.b).log({commandId:Dk.PREVIEW_INTEGRITY,subCommandId:0,duration:0,success:!!s.thumb,params:[e]}),n})),pN=Reflect.metadata("design:type",Function),fN=Reflect.metadata("design:paramtypes",[String]),(_N=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!a.ModuleContainer.resolve(Bk.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==Uk.a.MESSAGE_WIDGET}async parse(e){const t=a.ModuleContainer.resolve(Bk.a),s=t.get("max_redirect"),i=t.get("max_title_character"),n=t.get("max_desc_character"),{enable_log_metric:r}=t.get("debug"),[o,l]=await E.c.catchAsyncFn((()=>oN.b.exec("parseLink",[e,{maxRedirect:s}],{priority:oN.a.HIGH})));Gk(!!o,o&&xk.createFromObject(o));const[c,d]=l;if(r){a.ModuleContainer.resolve(iN.b).linkParser.zsymb(12,"6UV2Qq","ParseLinkMetric",Dk[Dk.CLIENT_PARSER],"DETAIL",e,{fetch:d.endFetch-d.startFetch,parse:d.endParseMetaData-d.startParseMetaData,total:d.endParseMetaData-d.startFetch,htmlSize:d.htmlSize})}const u=this.sanitizeMetaData(c,{maxTitleLength:i,maxDescLength:n});return this.isMetaDataFailed(u)?null:{typeParse:Uk.b.CLIENT,href:pf.a.getUrlWithHttpProtocol(e),title:u.title,desc:u.desc,thumb:"",thumbOrigin:u.thumb,media:{},src:u.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:a}=t,{title:i="",desc:n=""}=e,r=E.g.clone(e);return r.title=lN.truncateWord(i||"",s),r.desc=lN.truncateWord(n||"",a),r}}).instance=null,vN=_N,Object(wk.a)(vN.prototype,"parse",[mN,pN,fN],Object.getOwnPropertyDescriptor(vN.prototype,"parse"),vN.prototype),vN);var IN;Object(a.injectable)()(IN=Object(a.singleton)(Tk.a)(IN=Reflect.metadata("design:type",Function)(IN=Reflect.metadata("design:paramtypes",[])(IN=class{constructor(){}getLinkParser(e,t){return rN.getInstance().isMatchParser(e,t)?rN.getInstance():bN.getInstance().isMatchParser(e,t)?bN.getInstance():jk.getInstance()}})||IN)||IN)||IN);var yN,SN,CN,EN,ON=s("TQME");class MN{constructor(){}static getInstance(){return MN.instance||(MN.instance=new MN),MN.instance}async process(e){return e}}MN.instance=null;let TN=(yN=Lk(Dk.DOWNLOAD_THUMB,(([e,t])=>({params:[e,t]}))),SN=Reflect.metadata("design:type",Function),CN=Reflect.metadata("design:paramtypes",[String,Number]),EN=class{async download(e,t=1/0){const[s,a]=await E.c.catchAsyncFn((()=>this.doDownload(e,t)));return Gk(!!s,s&&this.transformError(s)),a}async doDownload(e,t){const[s,a]=await $zdownload.downloadThumbTemp(e,t);return Gk(s,s),a}transformError(e){return xk.createFromObject(e)}},Object(wk.a)(EN.prototype,"download",[yN,SN,CN],Object.getOwnPropertyDescriptor(EN.prototype,"download"),EN.prototype),EN);class wN{constructor(){this.config=void 0,this.logger=void 0,this.logger=a.ModuleContainer.resolve(iN.b).linkParser,this.config=a.ModuleContainer.resolve(Bk.a)}static getInstance(){return wN.instance||(wN.instance=new wN),wN.instance}async process(e){const t=null==e?void 0:e.thumbOrigin;if(t){const s=this.config.get("max_thumb_size"),[a,i]=await E.c.catchAsyncFn((()=>(new TN).download(t,s)));if(a&&this.logger.zsymb(18,"_5Rjje",`Download link failed. Url: ${e.href}. ThumbUrlOrigin: ${t}. Error: ${a}`),i){const t=E.g.clone(e);return t.thumbLocal=i.path,t.thumbMeme=i.meme,t}}return e}}wN.instance=null;var RN,LN,DN,AN,FN=s("vPsb"),kN=s("1+6A"),NN=s("PTkj");class PN{constructor(e){this.localPath=e}async read(){const e=await $zFileManager.getFileArrayBuffer(this.localPath),t=$znode.path.basename(this.localPath);return new File([e],t)}}class jN{constructor(e){this.localPath=e}async compress(){try{const e=await new PN(this.localPath).read(),{blob:t,width:s,height:a,fileName:i}=await Object(NN.e)(e,e.name),n=this.calcNewSize(s,a),r=await Object(op.a)(t,{quality:.9,width:n.width,height:n.height});return new File([r],i)}catch(e){throw new Wk(null==e?void 0:e.message)}}calcNewSize(e,t){const s=Ce.default.file_photo_limit.width,a=Ce.default.file_photo_limit.height;let i=e,n=t;return(e>s||t>a)&&(e-s>t-a?(i=s,n=Math.round(s/e*t)):(n=a,i=Math.round(a/t*e))),{width:i,height:n}}}let UN=(RN=Lk(Dk.UPLOAD_THUMB),LN=Reflect.metadata("design:type",Function),DN=Reflect.metadata("design:paramtypes",[String,String]),AN=class{constructor(){}async upload(e,t){const s=a.ModuleContainer.resolve(iN.b).uploadThumb,[i,n]=await E.c.catchAsyncFn((()=>this.doCompress(e)));Gk(i,i),s.zsymb(12,"bu2fjE","Compress done");const[r,o]=await E.c.catchAsyncFn((()=>this.doUpload(n,t)));Gk(r,r),s.zsymb(12,"FMQRfH","Upload done");const[l,c]=this.transformResponse(o);return Gk(l,l),c}async doCompress(e){return await new jN(e).compress()}async doUpload(e,t){try{const s=nN.a.isGroupConv(t),a=nN.a.isE2eeConv(t),i=await $l.b.uploadFile({toUid:t,isGroup:s,rawFile:e,clientId:xl.a.next(),extData:{uploadMainType:kN.c.PhotoThumb,fType:Y.FILE_FTYPE.FILE,e2ee:a},feature:kN.a.SendMsg},{},{signalProgress:()=>{}});return a&&FN.c.enrichEncryptUrlV2(i),i}catch(s){throw this.transformUploadError(s)}}transformUploadError(e){const t=new Hk(`Error: ${JSON.stringify(e)}.`);return null!=e&&e.stack&&t.setStack(null==e?void 0:e.stack),t}transformResponse(e){var t,s,a,i,n,r,o,l;const c=(null==e||null===(t=e.urlRes)||void 0===t||null===(s=t.fileAsync)||void 0===s?void 0:s.oriUrl)||(null==e||null===(a=e.urlRes)||void 0===a||null===(i=a.fileAsync)||void 0===i?void 0:i.hdUrl)||(null==e||null===(n=e.urlRes)||void 0===n||null===(r=n.fileAsync)||void 0===r?void 0:r.normalUrl)||(null==e||null===(o=e.urlRes)||void 0===o||null===(l=o.fileAsync)||void 0===l?void 0:l.thumbUrl);return c?[null,c]:[new Hk(`Cannot get thumbUrl from response. Response ${e}`),null]}},Object(wk.a)(AN.prototype,"upload",[RN,LN,DN],Object.getOwnPropertyDescriptor(AN.prototype,"upload"),AN.prototype),AN);class BN{constructor(){this.logger=void 0,this.logger=a.ModuleContainer.resolve(iN.b).linkParser}static getInstance(){return BN.instance||(BN.instance=new BN),BN.instance}async process(e,t){const s=null==e?void 0:e.thumbLocal;if(s){const[a,i]=await E.c.catchAsyncFn((()=>(new UN).upload(s,t)));if(a&&this.logger.zsymb(18,"nE6zKj",`Upload link failed. Url: ${e.href}. ConvId: ${t} ThumbUrlLocal: ${s}. Error: ${a}`),i){const t=E.g.clone(e);return t.thumb=i,t}}return e}}var zN;BN.instance=null;Object(a.injectable)()(zN=Object(a.singleton)(ON.a)(zN=class{getDownloadProcessor(e){switch(e){case Uk.b.CLIENT:return wN.getInstance();case Uk.b.SERVER:default:return MN.getInstance()}}getUploadProcessor(e){switch(e){case Uk.b.CLIENT:return BN.getInstance();case Uk.b.SERVER:default:return MN.getInstance()}}})||zN);const GN=Object(a.define)("parser-config-event-emitter");var xN;a.ModuleContainer.registerFactory(GN,Yr.f((()=>new qm.a)));Object(a.injectable)()(xN=Object(a.singleton)(Bk.b)(xN=function(e,t){return Object(a.inject)(GN)(e,void 0,0)}(xN=Reflect.metadata("design:type",Function)(xN=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigEventEmitter?Object:IParserConfigEventEmitter])(xN=class{constructor(e){this.eventEmitter=e,this.config={}}setConfig(e){this.isConfigChange(e)&&(this.config=this.mergeConfig(e),this.eventEmitter.emit("on-config-change",this.config))}mergeConfig(e){return Object(I.a)(Object(I.a)({},this.config),e)}isConfigChange(e){return!new E.g.Comparer(this.config,e,!0).AND("enable_force_parse_link_server").AND("enable_parse_link_server").AND("enable_parse_link_client").AND("enable_auto_download_thumb").AND("enable_parse_link_receiver").AND("enable_parse_link_sender").AND("enable_upload_thumb_for_delay_send").AND("enable_download_partial_media_e2ee").AND("enable_verify_parse_link_server").AND("enable_show_loading_thumb").AND("white_list_domain",AS.a.isEqual).AND("white_list_domain_mode").AND("max_time_reparse").AND("max_thumb_size").AND("max_age_cache_preview").AND("max_item_cache").AND("max_url_character").AND("max_title_character").AND("max_desc_character").AND("max_delay_send_message").AND("max_redirect").AND("debug",AS.a.isEqual).exec()}})||xN)||xN)||xN)||xN);var VN,HN=s("1e0e");const WN={enable_force_parse_link_server:!0,enable_parse_link_server:!0,enable_parse_link_client:!0,enable_auto_download_thumb:!0,enable_parse_link_receiver:!0,enable_parse_link_sender:!1,enable_upload_thumb_for_delay_send:!1,enable_download_partial_media_e2ee:!0,enable_verify_parse_link_server:!1,enable_show_loading_thumb:!0,white_list_domain:[".zalo.me",".zaloapp.com","s120.avatar.talk.zdn.vn","cover.talk.zdn.vn","qr.talk.zdn.vn","f22.w640.photo.talk.zdn.vn","res-zalo.zadn.vn","vng.com.vn","stg-shop.zalo.me",".zingplay.me","zalopay.vn","kaka.me","api-internal.mp3.zalo","zstudio.io","123c.vn","adtimaserver.vn","adtima.vn","ad.zing.vn","baomoi.com","baomoi.vn","brand.zing.vn","chat-talk.zing.vn","click.123.vn","epi.com.vn","epi.vn","kakaapp.me","laban.vn","lab.zing.vn","mp3.zing.vn","m.zing.vn","news.zing.vn","nhatkyzalo.vn","playzing.vn","plo.com.vn","plo.vn","stc-tv.zing.vn","sukien.net.vn","tachthongtin.com","talk.zing.vn","trithuctructuyen.com.vn","trithuctructuyen.vn","tv.zing.vn","xdn.vn","xone.fm","zagoo.vn","zalo.ai","zalo.careers","zalochat.com","zalo.cx","zalo.gg","zalo.me","zalomusic.com","zalonews.net","zaloplus.vn","zalo-shop.vn","zalo.vn","zamoji.vn","zapps.vn","zavatar.vn","zavi.me","za.zdvn.vn","zdn.vn","zingmp3.com","zingmp3.vn","zingnews.com.vn","zingnews.vn","zingtv.vn","zstudio.io","zaloshop.me","dr.zapps.vn","hc.zalo.me"],white_list_domain_mode:"append",max_time_reparse:HN.a.timeInMs("24h"),max_thumb_size:$k.sizeInByte("2MB"),max_age_cache_preview:HN.a.timeInMs("24h"),max_item_cache:300,max_url_character:500,max_title_character:80,max_desc_character:200,max_delay_send_message:HN.a.timeInMs("2s"),max_redirect:2,debug:{enable_log_metric:!1,delay_parse_client:HN.a.timeInMs("0s")}};Object(a.injectable)()(VN=Object(a.singleton)(Bk.a)(VN=Reflect.metadata("design:type",Function)(VN=Reflect.metadata("design:paramtypes",[])(VN=class{constructor(){this.config=void 0,this.configValidator=void 0,this.config=WN,this.configValidator=new ee.a({enable_force_parse_link_server:ee.b.field().boolean(),enable_parse_link_server:ee.b.field().boolean(),enable_parse_link_client:ee.b.field().boolean(),enable_auto_download_thumb:ee.b.field().boolean(),enable_parse_link_receiver:ee.b.field().boolean(),enable_parse_link_sender:ee.b.field().boolean(),enable_download_partial_media_e2ee:ee.b.field().boolean(),enable_verify_parse_link_server:ee.b.field().boolean(),enable_show_loading_thumb:ee.b.field().boolean(),white_list_domain:ee.b.field().array("string"),white_list_domain_mode:ee.b.field().string().oneOf(["append","override"]),max_time_reparse:ee.b.field().number().min(0),max_thumb_size:ee.b.field().number().min(0),max_age_cache_preview:ee.b.field().number().min(0),max_item_cache:ee.b.field().number().min(0),max_url_character:ee.b.field().number().min(0),max_title_character:ee.b.field().number().min(0),max_desc_character:ee.b.field().number().min(0),max_delay_send_message:ee.b.field().number().min(0),max_redirect:ee.b.field().number().min(0),debug:ee.b.field().object({enable_log_metric:ee.b.field().boolean(),delay_parse_client:ee.b.field().number()})})}get(e,t){var s;return null!==(s=this.config[e])&&void 0!==s?s:t}setConfig(e){const t=this.configValidator.validateWithFallback(e,WN);this.config=Object(I.a)(Object(I.a)(Object(I.a)({},this.config),t),this.mergeWhiteListDomainConfig(t))}mergeWhiteListDomainConfig(e){const t=e.white_list_domain_mode,s=e.white_list_domain,a=this.config.white_list_domain;switch(t){case"append":default:return{white_list_domain:a.concat(s)};case"override":return{white_list_domain:s}}}})||VN)||VN)||VN);a.ModuleContainer.resolve(GN).on("on-config-change",(e=>{a.ModuleContainer.resolve(Bk.a).setConfig(e)}));class qN{constructor(e){this.maxAge=e,this.mapTsItemIsSet=void 0,this.mapTsItemIsSet=new Map}hookBeforeGet(e,t){const s=this.mapTsItemIsSet.get(e);if(!s)return;Date.now()-s>=this.maxAge&&t(e)}hookAfterSet(e){this.mapTsItemIsSet.set(e,Date.now())}hookAfterDelete(e){this.mapTsItemIsSet.delete(e)}hookAfterClear(){this.mapTsItemIsSet.clear()}}class KN{constructor(e){this.maxItem=e,this.mapTsItemIsVisited=void 0,this.mapTsItemIsVisited=new Map}hookBeforeGet(e){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()})}hookAfterSet(e,t){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()});let s=Math.max(this.mapTsItemIsVisited.size-this.maxItem,0);if(s>0){Array.from(this.mapTsItemIsVisited.values()).sort(((e,t)=>t.ts>e.ts?-1:0)).slice(0,s).forEach((e=>t(e.key)))}}hookAfterDelete(e){this.mapTsItemIsVisited.delete(e)}hookAfterClear(){this.mapTsItemIsVisited.clear()}}class $N{constructor(...e){this.strategies=void 0,this.repository=void 0,this.repositoryDeadItem=void 0,this.markDeadItem=e=>{const t=this.repository.get(e);t&&(t.isAlive=!1,this.repositoryDeadItem.push(e))},this.strategies=e,this.repository=new Map,this.repositoryDeadItem=[]}get(e){this.beforeGet(e);const t=this.repository.get(e);return t&&t.isAlive?t.value:null}set(e,t){const s={isAlive:!0,key:e,value:t};this.repository.set(e,s),this.afterSet(e)}delete(e){this.repository.delete(e),this.afterDelete(e)}reset(){this.repository.clear(),this.afterClear()}beforeGet(e){this.strategies.forEach((t=>t.hookBeforeGet(e,this.markDeadItem))),this.doGC()}afterSet(e){this.strategies.forEach((t=>t.hookAfterSet(e,this.markDeadItem))),this.doGC()}afterDelete(e){this.strategies.forEach((t=>t.hookAfterDelete(e)))}afterClear(){this.strategies.forEach((e=>e.hookAfterClear()))}doGC(){this.repositoryDeadItem.length&&(this.repositoryDeadItem.forEach((e=>this.delete(e))),this.repositoryDeadItem=[])}}var ZN;Object(a.injectable)()(ZN=Object(a.singleton)(Tk.c)(ZN=function(e,t){return Object(a.inject)(Bk.a)(e,void 0,0)}(ZN=Reflect.metadata("design:type",Function)(ZN=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigConsumer?Object:IParserConfigConsumer])(ZN=class{constructor(e){this.metaData=void 0,this.thumbLocal=void 0,this.thumbLive=void 0;const t=e.get("max_item_cache"),s=e.get("max_age_cache_preview");this.metaData=new $N(new KN(t),new qN(s)),this.thumbLocal=new $N(new KN(t),new qN(s)),this.thumbLive=new $N(new KN(t),new qN(s))}getKey(e,t){switch(e){case"meta-data":case"thumb-local":{const[e]=t;return pf.a.removeProtocol(e)}case"thumb-live":{const[e,s=""]=t;return[nN.a.getPrefixConv(s),nN.a.isE2eeConv(s)?"e2ee":"none-e2ee",pf.a.removeProtocol(e)].join("_")}default:return t.join(".")}}})||ZN)||ZN)||ZN)||ZN);var QN,YN=s("WOja");Object(a.injectable)()(QN=Object(a.singleton)(Tk.b)(QN=function(e,t){return Object(a.inject)(iN.b)(e,void 0,0)}(QN=function(e,t){return Object(a.inject)(Tk.c)(e,void 0,1)}(QN=function(e,t){return Object(a.inject)(Tk.a)(e,void 0,2)}(QN=function(e,t){return Object(a.inject)(Bk.a)(e,void 0,3)}(QN=Reflect.metadata("design:type",Function)(QN=Reflect.metadata("design:paramtypes",[void 0===iN.IParserLogger?Object:iN.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof ILinkParserFactory?Object:ILinkParserFactory,void 0===YN.IParserConfigConsumer?Object:YN.IParserConfigConsumer])(QN=class{constructor(e,t,s,a){this.repository=t,this.linkParserFactory=s,this.config=a,this.logger=void 0,this.logger=e.linkParser}parse(e){var t;const s=this.repository.getKey("meta-data",[e]);return(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.value)||null}async preparseAsync(e,t){await this.parseAsync(e,t)}async parseAsync(e,t){if(!this.config.get("enable_parse_link_client")){const e=(null==t?void 0:t.entry)!==Uk.a.SHARE_MESSAGE,s=nN.a.isE2eeConv((null==t?void 0:t.convId)||"");if(e&&s)return null}const s=this.repository.getKey("meta-data",[e]),a=this.repository.metaData.get(s);if(a&&null!==a.value)return a.promise;const i=new E.c.Container;this.repository.metaData.set(s,i);const[n,r]=await E.c.catchAsyncFn((()=>this.linkParserFactory.getLinkParser(e,t).parse(e)));return n&&this.logger.zsymb(18,"KK6o5x",`parse link failed ${n}`),i.resolve(r),i.promise}})||QN)||QN)||QN)||QN)||QN)||QN)||QN);var JN;Object(a.injectable)()(JN=Object(a.singleton)(ON.b)(JN=function(e,t){return Object(a.inject)(iN.b)(e,void 0,0)}(JN=function(e,t){return Object(a.inject)(Tk.c)(e,void 0,1)}(JN=function(e,t){return Object(a.inject)(ON.a)(e,void 0,2)}(JN=Reflect.metadata("design:type",Function)(JN=Reflect.metadata("design:paramtypes",[void 0===iN.IParserLogger?Object:iN.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof IPreviewLinkProcessorFactory?Object:IPreviewLinkProcessorFactory])(JN=class{constructor(e,t,s){this.repository=t,this.linkProcessorFactory=s,this.logger=void 0,this.logger=e.linkParser}async processDownload(e){var t;const s=this.repository.getKey("meta-data",[e]),a=this.repository.getKey("thumb-local",[e]),i=this.repository.thumbLocal.get(a);if(i&&null!==i.value){if(!i.value)return i.promise;{const e=i.value.thumbLocal;if(e){const[t,s]=await E.c.catchAsyncFn((()=>{var t,s;return null===(t=$znode)||void 0===t||null===(s=t.fsPromise)||void 0===s?void 0:s.stat(e)}));if(!t&&s)return i.promise}}}const n=new E.c.Container;this.repository.thumbLocal.set(a,n);const r=await(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.promise)||null,o=await this.linkProcessorFactory.getDownloadProcessor(null==r?void 0:r.typeParse).process(r);return n.resolve(o),n.promise}async processUpload(e,t){var s;const a=this.repository.getKey("thumb-local",[e]),i=this.repository.getKey("thumb-live",[e,t]),n=this.repository.thumbLive.get(i);if(n&&null!==n.value)return n.promise;const r=new E.c.Container;this.repository.thumbLive.set(i,r);const o=await(null===(s=this.repository.thumbLocal.get(a))||void 0===s?void 0:s.promise)||null,l=await this.linkProcessorFactory.getUploadProcessor(null==o?void 0:o.typeParse).process(o,t);return r.resolve(l),r.promise}})||JN)||JN)||JN)||JN)||JN)||JN);class XN{constructor(){}async getDimension(e){const t={key:Date.now(),file:e,srcAction:3},[s,a]=await E.c.catchAsyncFn((()=>Fp.default.getDimension(t)));return Gk(s,s&&this.transformError(s)),this.transformResponse(a)}transformError(e){return e}transformResponse(e){return{width:e.width,height:e.height,rotation:e.orientation}}}var eP=s("8I6r"),tP=s("oSk7"),sP=s("taJj");class aP{constructor(){}async download(e){const[t,s]=ui.default.parseE2eeProtocol(e),i=new Headers;if(t){let e="unsafe-flush";a.ModuleContainer.resolve(Bk.a).get("enable_download_partial_media_e2ee")&&(i.set("Range",`bytes=0-${$k.sizeInByte("64KB")}`),e="safe-flush");const[n,r]=await E.c.catchAsyncFn((()=>fetch(s,{headers:i})));Gk(n,n);const o=new tP.a(r.body).pipe(new sP.a($k.sizeInByte("1MB"))).pipe(new iP(new eP.b(t,"decrypt"),e)).getStream();return await new Response(o,{headers:r.headers}).blob()}i.set("Range",`bytes=0-${$k.sizeInByte("64KB")}`);const[n,r]=await E.c.catchAsyncFn((()=>fetch(e,{headers:i})));return Gk(n,n),await r.blob()}}class iP{constructor(e,t){this.zaes=e,this.modeFlush=t,this.transform=(e,t)=>{const s=this.zaes.update(e);t.enqueue(s)},this.flush=e=>{if("safe-flush"!==this.modeFlush)try{this.zaes.end()}catch(t){e.error(t)}}}}const nP={"image/gif":Y.IMAGE_TYPE_GIF,"image/jpg":Y.IMAGE_TYPE_JPEG,"image/jpeg":Y.IMAGE_TYPE_JPEG,"image/png":Y.IMAGE_TYPE_PNG};class rP{constructor(){}static getInstance(){return rP.instance||(rP.instance=new rP),rP.instance}isMatchParser(e){return Object.keys(nP).includes(e)}async parse(e){const[t,s]=await E.c.catchAsyncFn((()=>(new aP).download(e)));Gk(t,t);const[a,i]=await E.c.catchAsyncFn((()=>(new XN).getDimension(s)));return Gk(a,a),Object(I.a)(Object(I.a)({},i),{},{type:this.transformType(s)})}transformType(e){return nP[e.type]}}rP.instance=null;class oP{constructor(){}static getInstance(){return oP.instance||(oP.instance=new oP),oP.instance}isMatchParser(e){return!0}async parse(e){return null}}oP.instance=null;const lP={"application/pdf":Y.LINK_TYPE_PDF};class cP{constructor(){}static getInstance(){return cP.instance||(cP.instance=new cP),cP.instance}isMatchParser(e){return Object.keys(lP).includes(e)}async parse(e){try{const t=ui.default.removeE2eeProtocol(e),s=(await fetch(t,{method:"HEAD"})).headers.get("content-length");return null===s?null:{size:Number(s),name:pf.a.getFileNameFromUrl(e),type:lP["application/pdf"]}}catch(t){throw t}}}var dP;cP.instance=null;Object(a.singleton)(Tk.d)(dP=class{async getSizeParser(e){const[t,s]=await E.c.catchAsyncFn((()=>this.tryGetContentType(e)));return t||!s?oP.getInstance():rP.getInstance().isMatchParser(s)?rP.getInstance():cP.getInstance().isMatchParser(s)?cP.getInstance():oP.getInstance()}async tryGetContentType(e){if(!pf.a.isBlobUrl(e)){const[t,s]=await E.c.catchAsyncFn((()=>this.tryGetContentTypeByHead(e)));if(!t)return s}return this.tryGetContentTypeByGet(e)}async tryGetContentTypeByHead(e){const t=ui.default.removeE2eeProtocol(e);return(await fetch(t,{method:"HEAD"})).headers.get("content-type")}async tryGetContentTypeByGet(e){const t=ui.default.removeE2eeProtocol(e),s=new AbortController,a=await fetch(t,{signal:s.signal});s.abort();return a.headers.get("content-type")}});var uP;Object(a.injectable)()(uP=Object(a.singleton)(Tk.e)(uP=function(e,t){return Object(a.inject)(iN.b)(e,void 0,0)}(uP=function(e,t){return Object(a.inject)(Tk.d)(e,void 0,1)}(uP=Reflect.metadata("design:type",Function)(uP=Reflect.metadata("design:paramtypes",[void 0===iN.IParserLogger?Object:iN.IParserLogger,"undefined"==typeof ISizeParserFactory?Object:ISizeParserFactory])(uP=class{constructor(e,t){this.sizeParserFactory=t,this.cache=void 0,this.cacheDedupe=void 0,this.logger=void 0,this.cache=new $N(new KN(300)),this.logger=e.mediaSizeLogger,this.cacheDedupe=new Map}parse(e){const t=this.getCacheKey(e);return this.cache.get(t)}async preparseAsync(e){await E.c.catchAsyncFn((()=>this.parseAsync(e)))}async parseAsync(e){const t=this.getCacheKey(e),s=this.cache.get(t);if(s)return s;const a=this.cacheDedupe.get(t);if(a)return a;const i=(await this.sizeParserFactory.getSizeParser(e)).parse(e);this.cacheDedupe.set(t,i);const[n,r]=await E.c.catchAsyncFn((()=>i));return this.cacheDedupe.delete(t),Gk(null!==n,n),null===r?null:(this.cache.set(t,r),r)}getCacheKey(e){return e}})||uP)||uP)||uP)||uP)||uP);var hP,gP=s("2fgy"),mP=s("dG4g"),pP=s("DBGg"),fP=s("bGlS");Object(Ai.b)(gP.b)(hP=Object(a.injectable)()(hP=Reflect.metadata("design:type",Function)(hP=Reflect.metadata("design:paramtypes",[])(hP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.currentConvId=void 0,this.name=gP.a,this.key=gP.a,this.data={list:new Uc.a(Object(zL.a)().MAX_CONVERSATION_QUEUE_SIZE),photoViewData:void 0}}initialize(){}destroy(){}async onChangeMessages(e,t,s,a){this.currentConvId=e;const i={};t.forEach((e=>{let t=$r.default.isGroupPhoto(e);Object(mP.b)(e)&&(i[e.msgId]=t&&jM.a.getInstance().getGroupId(null!=a?a:"1",Object(fe.i)(e))||"")})),await this.getDataFromCache(i,s)}onChangeReactionDataList(e,t,s){const a=(new Date).getTime(),i=a.toString();Object(Po.j)(i),e.forEach(((e,n)=>{var r,o,l;const c=null===(r=this.getCurrentDataOfConversation())||void 0===r?void 0:r.get(n);if((null===(o=this.data.photoViewData)||void 0===o?void 0:o.rMsgId)===n&&(this.data.photoViewData=Object(I.a)(Object(I.a)({},this.data.photoViewData),e),Object(Po.g)(i,this.name,fP.a)),!s&&!c)return;const d=Object.keys((null==c?void 0:c.reactions)||{}).length>Object.keys((null==e?void 0:e.reactions)||{}).length,u=!t||Object(pP.a)(e.reactions)||d?0:a,h=Object(I.a)(Object(I.a)(Object(I.a)({},c),e),{},{lastUpdateEffects:u});null===(l=this.getCurrentDataOfConversation())||void 0===l||l.set(n,h);const g=null==h?void 0:h.groupPhotoMsgId;var m;g?(null===(m=this.getCurrentDataOfConversation())||void 0===m||m.set(g,{isGroupPhotoMsg:!0,groupPhotoMsgId:g,lastUpdate:a,lastUpdateEffects:u}),Object(Po.g)(i,this.name,g),Object(Po.g)(i,this.name,n)):Object(Po.g)(i,this.name,n)})),Object(Po.c)(i)}getReactedListFromMessage(e,t){if(t){if(!e.msgId||!this.data.photoViewData)return{};const t=new Map;return t.set(e.msgId,this.data.photoViewData),Object(mP.d)(e,t)}return Object(mP.d)(e,this.getCurrentDataOfConversation())}removeReactionDataFromList(e){var t,s;if(!e.msgId)return;const a=null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e.msgId);var i;null!=a&&a.isGroupPhotoMsg&&(null===(i=this.getCurrentDataOfConversation())||void 0===i||i.forEach(((t,s)=>{var a;t.groupPhotoMsgId===e.msgId&&(null===(a=this.getCurrentDataOfConversation())||void 0===a||a.delete(s))})));null===(s=this.getCurrentDataOfConversation())||void 0===s||s.delete(e.msgId)}async onChangePhotoViewData(e){if(!e.msgId)return;const t=[e.msgId],s=await Dd.b.get(t);s&&(this.data.photoViewData=s[e.msgId],Object(Po.h)(this.name,fP.a))}removePhotoViewData(){this.data.photoViewData=void 0}async resyncReactionData(){}async getDataFromCache(e,t){const s=Object.keys(e),a=await Dd.b.get(s);if(!a)return;const i=new Map;for(const n in a)i.set(n,Object(I.a)(Object(I.a)({},a[n]),{},{groupPhotoMsgId:e[n]}));this.onChangeReactionDataList(i,!1,!0),null==t||t(Object.keys(a))}getCurrentDataOfConversation(){if(this.currentConvId)return this.data.list.get(this.currentConvId)||this.data.list.push(this.currentConvId,new Map),this.data.list.get(this.currentConvId)}clearData(e){this.data.list.delete(e)}clearAllData(){this.data.list.clearAll(),this.data.photoViewData=void 0}getData(e){var t;return null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e)}getLastUpdateEffects(e,t){var s;return null===(s=this.getData(t||e))||void 0===s?void 0:s.lastUpdateEffects}setLastUpdateEffects(e,t){const s=this.getData(t||e);var a;s&&(null===(a=this.getCurrentDataOfConversation())||void 0===a||a.set(t||e,Object(I.a)(Object(I.a)({},s),{},{lastUpdateEffects:0})))}getItem(e,t){var s;return e.key===fP.a?this.data.photoViewData:null===(s=this.getCurrentDataOfConversation())||void 0===s?void 0:s.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||hP)||hP)||hP);var vP,_P=s("VhZi");function bP(e){return e||fP.b.windowId}Object(Ai.b)(_P.b)(vP=Object(a.injectable)()(vP=Object(a.singleton)()(vP=Reflect.metadata("design:type",Function)(vP=Reflect.metadata("design:paramtypes",[])(vP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=_P.a,this.key=_P.a}initialize(e){const t=bP(e);Ie.ModalManagerV2.addModal({windowId:t,name:fP.b.name,altWindowId:void 0}),Ie.ModalManagerV2.subscribeTriggers({windowId:t,name:fP.b.name,trigger:e=>{}}),this.data.set(t,{message:void 0})}destroy(e){const t=bP(e);this.data.delete(t),Ie.ModalManagerV2.delModal({windowId:t,name:fP.b.name})}toggleReactionPopup(e,t){const s=bP(e);this.data.set(s,{message:t}),t?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},fP.b),{},{windowId:s,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},fP.b),{},{windowId:s})),Object(Po.h)(this.name,s)}getItem(e,t){return this.data.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||vP)||vP)||vP)||vP);var IP=s("NmZm"),yP=s("66W5"),SP=s("xU41");var CP;Object(a.injectable)()(CP=Object(a.singleton)()(CP=Object(Ai.b)(IP.b)(CP=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(CP=Reflect.metadata("design:type",Function)(CP=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(CP=class{constructor(e){this.type=void 0,this.key=yP.c,this.name=IP.a,this._chatBoxInputDOMMap=new Map,this._chatBoxInputStateMap=new Map,this._logger=void 0,this._logger=e.createZLogger(R.ZLoggerNametags.cbiController,[R.ZLoggerNametags.controllCbi])}init(){}getItem(e,t){if((s=e.key)&&s.startsWith(yP.c))return this._getChatBoxInputState(e.key);var s}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"MWXpt5",["[onGetItemFailure] key: {}, error: {}","RmcrN1"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"aCIvw3",["[onGetListFailure] key: {}, error: {}","fHmJDJ"],e,t.message)}setChatInputType(e,t,s,a=!0){if(!e||!t)return this._logger.zsymb(21,"yeAHGw",["[setChatInputType] {} or {} isn't valid!","cGwCYt"],e,t);if(!s)return this._logger.zsymb(21,"3o2zyb",["[setChatInputType] chatInputType isn't existed!","GE5mZ9"]);let i=this._getChatBoxInputState(Object(SP.a)(e,t));const n=Object(Lg.a)(i,(e=>{e.chatInputType=Object(I.a)({},s)}));this._chatBoxInputStateMap.set(Object(SP.a)(e,t),n),a&&n!==i&&Object(Po.h)(this.name,Object(SP.a)(e,t))}getChatInputType(e,t){return this._getChatBoxInputState(Object(SP.a)(e,t)).chatInputType}getDefaultChatInputType(){return{name:yP.g.NORMAL,info:{}}}getChatInputTypeInfo(e,t){return this._getChatBoxInputState(Object(SP.a)(e,t)).chatInputType.info}getChatInputTypeName(e,t){return this._getChatBoxInputState(Object(SP.a)(e,t)).chatInputType.name}bindChatInputScroller(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputScroller=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatInputContent(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputContent=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatBoxInputContainer(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatBoxInputContainer=t,this._chatBoxInputDOMMap.set(e,s)}}getChatInputScroller(e,t){if(e){var s;return null!==(s=this._getChatBoxInputDOM(e).chatInputScroller)&&void 0!==s?s:null==t?void 0:t.document.getElementById(yP.f)}return null}getChatInputContent(e){if(e){return this._getChatBoxInputDOM(e).chatInputContent}return null}getChatBoxInputContainer(e){if(e){return this._getChatBoxInputDOM(e).chatBoxInputContainer}return null}_getChatBoxInputState(e){let t=this._chatBoxInputStateMap.get(e);return t||(t=this._getDefaultChatBoxInputState(),this._chatBoxInputStateMap.set(e,t)),t}_getDefaultChatBoxInputState(){return{chatInputType:this.getDefaultChatInputType()}}_getChatBoxInputDOM(e){let t=this._chatBoxInputDOMMap.get(e);return t||(t=this._getDefaultChatBoxInputDOM(),this._chatBoxInputDOMMap.set(e,t)),t}_getDefaultChatBoxInputDOM(){return{chatBoxInputContainer:null,chatInputScroller:null,chatInputContent:null}}})||CP)||CP)||CP)||CP)||CP);var EP=s("/ApO"),OP=s("DIKB"),MP=s("/wiu"),TP=s("WJhq");function wP(e,t){var s,a;const i=null!==(s=t.duration)&&void 0!==s?s:0,n=null!==(a=t.easing)&&void 0!==a?a:"ease",r=t.animId;return e.animate([{height:t.fromHeight},{height:t.toHeight}],{id:r,duration:i,fill:t.fill,easing:n})}var RP=s("gn4y");let LP=function(e){return e.NORMAL_TO_RTF="normal-to-rtf",e.RTF_TO_NORMAL="rtf-to-normal",e.MINI_TO_EXPAND="mini-to-expand",e.EXPAND_TO_MINI="expand-to-mini",e.RESIZE_WHEN_WINDOW_RESIZE="resize-when-window-resize",e.FADE_IN_RTF_TOOLBAR="fade-in-rtf-toolbar",e.FADE_OUT_RTF_TOOLBAR="fade-out-rtf-toolbar",e}({});var DP,AP=s("dZd7");const FP=new De.a(0);Object(a.injectable)()(DP=Object(a.singleton)(EP.a)(DP=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(DP=Reflect.metadata("design:type",Function)(DP=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(DP=class{constructor(e){this._chatBoxInputAnimsMap=new Map,this._logger=void 0,this._isDevelopment=void 0,this._logger=e.createZLogger(R.ZLoggerNametags.cbiAnimationController,[R.ZLoggerNametags.manageCBIAnimation]),this._isDevelopment=!1}applyChatInputType(e,t,s){this._isDevelopment&&this._logger.zsymb(0,"aVgjlD","(@=@)! >>>applyChatInputType<<<");const{windowId:a,convId:i,selfWindow:n,hasAnim:r}=s;if(this._isDevelopment&&this._logger.zsymb(3,"4MreBV",["from: {} to: {}","tlJhu6"],JSON.stringify(e),JSON.stringify(t)),MP.e(e,t)){if(MP.d(t))return this.switchNormalModeToRTFMode(a,i,n,r);if(MP.c(t))return this.switchRTFModeToNormalMode(a,i,n,r)}else if(MP.c(e)&&MP.d(t)){if(t.info.mode===yP.h.MINI)return this.switchNormalModeToRTFMode(a,i,n,r);t.info.mode,yP.h.EXPAND}else{if(MP.d(e)&&MP.c(t))return this.switchRTFModeToNormalMode(a,i,n,r);if(MP.d(e)&&MP.d(t)){if(e.info.mode===yP.h.EXPAND&&t.info.mode===yP.h.MINI)return this.switchExpandModeToMiniModeInRTFMode(a,i,n,r);if(e.info.mode===yP.h.MINI&&t.info.mode===yP.h.EXPAND)return this.switchMiniModeToExpandModeInRTFMode(a,i,n,r)}}this._isDevelopment&&this._logger.zsymb(3,"K0P5ct",["Do not support this case!","vqPtPE"])}switchNormalModeToRTFMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"lR3Xog","(@=@)! >>>switchNormalModeToRTFMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(RP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(RP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(RP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=()=>{n.classList.add("--rtf-mode","--rtf-mini-mode"),r.classList.add("--visible"),this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.MINI}})};if(this._cancelAllAnimation(e,!0),!a)return o();const l=n.clientHeight,c=Math.round(2*TP.c.PADDING_TOP_BOTTOM+5.5*TP.e+TP.g+TP.b);this._isDevelopment&&this._logger.zsymb(3,"n-HlZI",["heights: {} {}","xPuWMu"],l,c);let d=this._getTransitionDuration(c,l);if(this._isDevelopment&&this._logger.zsymb(3,"ifMYag",["duration: {}","K499AS"],d),d>0){const s=this._getChatInputContentEl(i);if(!Object(RP.a)(!!s,"chatInputContentEl isn't existed."))return;const a=s.clientHeight/TP.e>=2;a||n.classList.add("--animate-from-smallest-height"),n.classList.add("--rtf-mode");const o=wP(n,{animId:`${LP.NORMAL_TO_RTF}::${FP.next()}`,duration:d,easing:"ease",fromHeight:`${l}px`,toHeight:`${c}px`});this._setAnimationById(e,o.id,o),o.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"7ZLMDl",["finished: {}","BlFfiT"],o.id),a||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),o.cancel()},o.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"n6MRng",["canceled: {}","vXG9Vo"],o.id),a||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),this._deleteAnimationById(e,o.id),this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.MINI}})};const u=function(e,t){var s,a,i;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(a=t.delay)&&void 0!==a?a:0;return e.animate([{opacity:0},{opacity:1}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(i=t.easing)&&void 0!==i?i:"ease"})}(r,{animId:`${LP.FADE_IN_RTF_TOOLBAR}::${FP.next()}`,duration:d,easing:"ease"});this._setAnimationById(e,u.id,u),u.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"IU86J8",["finished: {}","BlFfiT"],u.id),r.classList.add("--visible"),u.cancel()},u.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"VZoo94",["canceled: {}","vXG9Vo"],u.id),r.classList.add("--visible"),this._deleteAnimationById(e,u.id)},this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.SWITCHING,info:{inputType:yP.g.RTF,from:yP.g.NORMAL,to:yP.g.RTF}})}else o()}switchRTFModeToNormalMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"3oPwLa","(@=@)! >>>switchRTFModeToNormalMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(RP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(RP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(RP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(i);if(!Object(RP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const l=()=>{n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.NORMAL,info:{}})};if(this._cancelAllAnimation(e,!0),!a)return l();const c=this._getChatInputContentEl(i);if(!Object(RP.a)(!!c,"chatInputContentEl isn't existed."))return;const d=c.clientHeight,u=n.clientHeight,h=d/TP.e>=2;let g=TP.c.SMALLEST_HEIGHT_IN_NORMAL,m=!1;h||(n.classList.add("--simple-normal-mode"),m=c.clientHeight/TP.e>=2,n.classList.remove("--simple-normal-mode")),g=h||m?Math.round((d>TP.d.NORMAL.MAX?TP.d.NORMAL.MAX:d)+TP.g+2*TP.c.PADDING_TOP_BOTTOM+TP.b):TP.c.SMALLEST_HEIGHT_IN_NORMAL,this._isDevelopment&&this._logger.zsymb(3,"bxWdTy",["heights: {} {}","xPuWMu"],u,g);let p=this._getTransitionDuration(g,u);if(this._isDevelopment&&this._logger.zsymb(3,"Yz6pFO",["duration: {}","K499AS"],p),p>0){h||m||n.classList.add("--animate-to-smallest-height"),n.classList.add("--switching-rtf-to-normal-mode"),n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="";const s=wP(n,{animId:`${LP.RTF_TO_NORMAL}::${FP.next()}`,duration:p,easing:"ease",fromHeight:`${u}px`,toHeight:`${g}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"0R5P95",["finished: {}","BlFfiT"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"Bi1Lle",["canceled: {}","vXG9Vo"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.NORMAL,info:{}}),this._deleteAnimationById(e,s.id)};const a=function(e,t){var s,a,i;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(a=t.delay)&&void 0!==a?a:0;return e.animate([{opacity:1},{opacity:0}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(i=t.easing)&&void 0!==i?i:"ease"})}(r,{animId:`${LP.FADE_OUT_RTF_TOOLBAR}::${FP.next()}`,duration:Math.max(p-50,0),easing:"ease-in"});this._setAnimationById(e,a.id,a),a.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"vie45m",["finished: {}","BlFfiT"],a.id),a.cancel()},a.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"DBbSoz",["canceled: {}","vXG9Vo"],a.id),this._deleteAnimationById(e,a.id)},this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.SWITCHING,info:{inputType:yP.g.NORMAL,from:yP.g.RTF,to:yP.g.NORMAL}})}else l()}switchMiniModeToExpandModeInRTFMode(e,t,s,a=!0){var i,n;if(this._isDevelopment&&this._logger.zsymb(0,"wrMpna","(@=@)! >>>switchMiniModeToExpandModeInRTFMode<<<"),!e||!t)return;const r=null!=s?s:K.default.getWindow(e);if(!Object(RP.a)(!!r,"window isn't existed."))return;const o=this._getChatInputContainerEl(r);if(!Object(RP.a)(!!o,"chatInputContainerEl isn't existed."))return;const l=this._getRTFToolbarEl(r);if(!Object(RP.a)(!!l,"rtfToolbarEl isn't existed."))return;const c=this._getChatBoxInputContainerEl(r);if(!Object(RP.a)(!!c,"chatBoxInputContainerEl isn't existed."))return;let d=c.clientHeight,u=Math.round((null!==(i=null===(n=this._getChatViewEl(r))||void 0===n?void 0:n.clientHeight)&&void 0!==i?i:0)*TP.a);const h=()=>{o.classList.replace("--rtf-mini-mode","--rtf-expand-mode"),c.style.height=`${u}px`,this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.EXPAND}})};if(this._cancelAllAnimation(e,!0),!a)return h();d>=u&&(u=d),this._isDevelopment&&this._logger.zsymb(3,"0Sra1Q",["heights: {} {}","xPuWMu"],d,u);let g=this._getTransitionDuration(u,d);if(this._isDevelopment&&this._logger.zsymb(3,"p-Vx6I",["duration: {}","K499AS"],g),g>0){this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.SWITCHING,info:{inputType:yP.g.RTF,from:yP.h.MINI,to:yP.h.EXPAND}}),o.classList.replace("--rtf-mini-mode","--rtf-expand-mode");const s=wP(c,{animId:`${LP.MINI_TO_EXPAND}::${FP.next()}`,duration:g,fromHeight:`${d}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"m_k7v0",["finished: {}","BlFfiT"],s.id),c.style.height=`${u}px`,s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"4Jq54o",["canceled: {}","vXG9Vo"],s.id),c.style.height=`${u}px`,this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.EXPAND}})}}else h()}switchExpandModeToMiniModeInRTFMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"y3G0Us","(@=@)! >>>switchExpandModeToMiniModeInRTFMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(RP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(RP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(RP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(i);if(!Object(RP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const l=()=>{n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.MINI}})};if(this._cancelAllAnimation(e,!0),!a)return l();const c=o.clientHeight,d=n.clientHeight,u=Math.round(c-d+TP.d.RTF.MIN+TP.g+2*TP.c.PADDING_TOP_BOTTOM+TP.b);this._isDevelopment&&this._logger.zsymb(3,"mDXQIg",["heights: {} {}","xPuWMu"],c,u);let h=this._getTransitionDuration(u,c);if(this._isDevelopment&&this._logger.zsymb(3,"YSZVRh",["duration: {}","K499AS"],h),h>0){this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.SWITCHING,info:{inputType:yP.g.RTF,from:yP.h.EXPAND,to:yP.h.MINI}});const s=wP(o,{animId:`${LP.EXPAND_TO_MINI}::${FP.next()}`,duration:h,fromHeight:`${c}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"2VF7_P",["finished: {}","BlFfiT"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"08j7ru",["canceled: {}","vXG9Vo"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:yP.g.RTF,info:{mode:yP.h.MINI}})}}else l()}resizeChatBoxInputWhenWindowResize(e,t,s=!0){var a,i;if(this._isDevelopment&&this._logger.zsymb(0,"v92Xm2","(@=@)! >>>resizeChatBoxInputWhenWindowResize<<<"),!e)return;const n=null!=t?t:K.default.getWindow(e);if(!Object(RP.a)(!!n,"window isn't existed."))return;const r=this._getChatBoxInputContainerEl(n);if(!Object(RP.a)(!!r,"chatBoxInputContainerEl isn't existed."))return;const o=r.clientHeight,l=Math.round((null!==(a=null===(i=this._getChatViewEl(n))||void 0===i?void 0:i.clientHeight)&&void 0!==a?a:0)*TP.a),c=()=>{r.style.height=`${l}px`};if(this._cancelAllAnimation(e,!0),!s)return c();this._isDevelopment&&this._logger.zsymb(3,"ykYjP-",["heights: {} {}","xPuWMu"],o,l);let d=this._getTransitionDuration(l,o);if(this._isDevelopment&&this._logger.zsymb(3,"lXrrzc",["duration: {}","K499AS"],d),d>0){const t=wP(r,{animId:`${LP.RESIZE_WHEN_WINDOW_RESIZE}::${FP.next()}`,duration:d,fromHeight:`${o}px`,toHeight:`${l}px`});this._setAnimationById(e,t.id,t),t.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"t-iOe6",["finished: {}","BlFfiT"],t.id),r.style.height=`${l}px`,t.cancel()},t.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"X4Lp53",["canceled: {}","vXG9Vo"],t.id),r.style.height=`${l}px`,this._deleteAnimationById(e,t.id)}}else c()}get _chatBoxInputController(){return a.ModuleContainer.resolve(OP.a)}_getChatInputContainerEl(e){return e.document.getElementById(yP.d)}_getRTFToolbarEl(e){return e.document.getElementById(yP.i)}_getChatBoxInputContainerEl(e){return e.document.getElementById(yP.b)}_getChatInputContentEl(e){return e.document.getElementById(yP.f)}_getChatViewEl(e){return e.document.getElementById(TP.f)}_getTransitionDuration(e=0,t=0){if(!e||e<=0||!t||t<=0)return 0;const s=Object(AP.a)(),a=Math.abs(e-t);return a<=1?0:Math.round(s*Math.log(a))}_getAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);if(s)return s[t]}_setAnimationById(e,t,s){if(!e||!t||!s)return;let a=this._chatBoxInputAnimsMap.get(e);a||(a={}),a[t]=s,this._chatBoxInputAnimsMap.set(e,a)}_deleteAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);s&&(delete s[t],this._chatBoxInputAnimsMap.set(e,s))}_cancelAnimation(e,t,s=!1){let a=this._chatBoxInputAnimsMap.get(e);if(!a)return;a=Object(I.a)({},a);const i=a[t];i&&(i.cancel(),s&&(delete a[t],this._chatBoxInputAnimsMap.set(e,a)))}_cancelAllAnimation(e,t=!1){const s=this._chatBoxInputAnimsMap.get(e);if(s&&0!==Object.keys(s).length){for(const e in s){var a;if(s[e])null===(a=s[e])||void 0===a||a.cancel(),t&&delete s[e]}this._chatBoxInputAnimsMap.set(e,s)}}})||DP)||DP)||DP)||DP);var kP=s("CkSj"),NP=s("uUhV"),PP=s("I9t9");const jP="qrw",UP=`${jP}__extension`,BP=`${jP}__main`,zP=`${BP}--bd`,GP=`${BP}--content`,xP=`${GP}--c`,VP=`${GP}__title`,HP=`${GP}__desc`,WP=`${GP}__act`,qP=`${jP}__step`,KP=`${qP}--slider`,$P=`${qP}--indicator-c`,ZP=`${qP}--indicator`,QP=`${qP}--content`,YP=`${QP}--c`,JP=`${QP}__title`,XP=`${QP}__desc`,ej=`${QP}__act`;var tj=s("aUrs"),sj=s("/3IL");const aj=["className","style","children","noWrap"];function ij(e){const{className:t,style:s,children:a,noWrap:i=!1}=e,n=Object(zi.a)(e,aj),r=Object(lC.a)(t,"flx",i?"flex-nowrap":"flex-wrap");return rr.a.createElement("div",Object(BS.a)({},n,{className:r,style:s}),a)}ij.propTypes={className:oC.a.string,style:oC.a.object,noWrap:oC.a.bool};var nj=ij,rj=s("h/gz"),oj=s("UUop");function lj(e){const{onClick:t}=e;return rr.a.createElement(sj.a,{className:BP},rr.a.createElement(sj.a,{className:zP},rr.a.createElement("img",{src:"assets/quick-reply-welcome-backdrop.6662d0752f1924cff174a9a07123f9e3.svg",alt:"welcome"})),rr.a.createElement(sj.a,{className:GP},rr.a.createElement(sj.a,{className:xP},rr.a.createElement(sj.a,{className:VP},rr.a.createElement(lr.a,{textKey:"STR_TITLE_QUICK_MESSAGES"})),rr.a.createElement(sj.a,{className:HP},rr.a.createElement(lr.a,{textKey:"STR_QR_WELCOME_MAIN"})),rr.a.createElement(sj.a,{className:WP},rr.a.createElement(nj,null,rr.a.createElement(cr.a,{className:"w-100",type:"primary",size:"medium",onClick:()=>{Object(oj.b)(oj.a.Welcome.CLICK_LEARN_MORE),Object(rj.n)(t)()}},rr.a.createElement(lr.a,{textKey:"STR_LEARN_MORE"})))))))}lj.propTypes={onClick:oC.a.func};var cj=lj;const dj="One",uj="Two";function hj(e){const{onComplete:t}=e,[s,a]=Object(nr.useState)(dj),i=Object(LR.b)();let n=null;return"vi"===i?n=s===dj?"assets/QM_Guide_Vi_1.85c6702df7df6f98bdfc2f7a2933c807.gif":"assets/QM_Guide_Vi_2.ef56a79e86131f474069999be3d6c90e.gif":"en"===i&&(n=s===dj?"assets/QM_Guide_En_1.f24dd518213dc12288c678ce20fb006f.gif":"assets/QM_Guide_En_2.4b0370616555dffd006442bb44328358.gif"),rr.a.createElement(sj.a,{className:qP},rr.a.createElement(sj.a,{className:KP},rr.a.createElement("img",{src:n,alt:"Tip"})),rr.a.createElement(sj.a,{className:QP},rr.a.createElement(sj.a,{className:$P},rr.a.createElement(nj,{className:ZP},rr.a.createElement(MC.a,{className:"red_dot "+(s===dj?"active":"")}),rr.a.createElement(MC.a,{className:"red_dot "+(s===uj?"active":"")}))),rr.a.createElement(sj.a,{className:YP},rr.a.createElement(sj.a,{className:JP},rr.a.createElement(lr.a,{textKey:le.a.trans("STR_STEP",[""+(s===dj?"1":"2"),"2"])})),rr.a.createElement(sj.a,{className:XP},rr.a.createElement(lr.a,{textKey:""+(s===dj?"STR_CLICK":"STR_TYPE_TO")}),rr.a.createElement(lr.a,{className:`${XP}--bold`,textKey:""+(s===dj?"STR_MANAGE":"/")}),rr.a.createElement(lr.a,{textKey:""+(s===dj?"STR_QR_WELCOME_STEP_1":"STR_QR_WELCOME_STEP_2")}),"."),rr.a.createElement(sj.a,{className:ej},rr.a.createElement(nj,{className:`${ej}${s===dj?"--end":"--bw"}`},s===uj?rr.a.createElement(cr.a,{type:"neutral",size:"medium",onClick:()=>{s===uj&&a(dj)}},rr.a.createElement(lr.a,{textKey:""+(s===dj?"STR_SKIP":"STR_BACK")})):null,rr.a.createElement(cr.a,{className:"ml-8",type:"primary",size:"medium",onClick:()=>{s===dj?a(uj):s===uj&&(Object(oj.b)(oj.a.Welcome.CLICK_COMPLETE),Object(rj.n)(t)())}},rr.a.createElement(lr.a,{textKey:""+(s===dj?"STR_CONTINUE":"STR_DONE_2")})))))))}hj.propTypes={onComplete:oC.a.func};var gj=hj;function mj(e,t){const{windowContainer:s,onReject:a,onSkip:i,windowId:n}=e,r=[{textKey:"STR_QM_SKIP",onclick:i},{type:Sy.MENU_ITEM_TYPE.SEPARATE},{textKey:"STR_QM_OFF_FEATURE",onclick:a}];return rr.a.createElement(Sy.default,{ref:t,items:r,popoverProps:{identity:{windowId:n,name:Y.PopoverIdentitiesDefine.QM_WELCOME_EXT_MENU},placement:"bottom-right",windowContainer:s}})}const pj=Object(nr.forwardRef)(mj);pj.propTypes={windowContainer:oC.a.node,onReject:oC.a.func,onSkip:oC.a.func,windowId:oC.a.string};var fj=pj,vj=s("oBev"),_j=s("WvqV"),bj=s("Jmku");const Ij={MAIN:"Main",STEP:"Step"},yj=Y.PopoverIdentitiesDefine.QM_WELCOME;function Sj(e){const{anchor:t,eventHandler:s,isOpen:a,initMode:i,onCompleteWelcome:n,onClosePopover:r,windowId:o}=e,l=Object.values(Ij).indexOf(i)>-1,[c,d]=Object(nr.useState)(l&&i||Ij.MAIN),u=Object(nr.useRef)(null),h=()=>{d(Ij.STEP)},g=()=>{Object(rj.e)(),Object(rj.n)(n)()},m=()=>{g()};if(Object(nr.useEffect)((()=>{const e={windowId:o,name:yj},t=()=>{Object(rj.n)(r)()};return bj.a.on("beforeClose",e,t),()=>{bj.a.removeListener("beforeClose",e,t)}}),[]),Object(nr.useEffect)((()=>{a&&(Object(oj.b)(oj.a.Welcome.SHOW),Object(_j.b)(o,yj))}),[a]),!a)return null;let p;p=c===Ij.MAIN?rr.a.createElement(cj,{onClick:h}):c===Ij.STEP?rr.a.createElement(gj,{onComplete:m}):null;const f=rr.a.createElement(rr.a.Fragment,null,rr.a.createElement("div",null,rr.a.createElement("div",{className:UP,onClick:e=>{var t;Object(oj.b)(oj.a.Welcome.CLICK_EXT),null===(t=u.current)||void 0===t||t.show(e)}},rr.a.createElement("i",{className:"fa fa-solid-more"})),p),rr.a.createElement(fj,{ref:u,onReject:e=>{Object(oj.b)(oj.a.Welcome.CLICK_NO_NEED),Object(rj.n)(r)();vj.a.onUpdateFeatureStatus(!1,(()=>{vj.a.showSettings(o,{show:!0,data:{tab:cR.f.MESSAGES,showQRToolTipTime:Date.now()}})}))},onSkip:()=>{Object(oj.b)(oj.a.Welcome.CLICK_SKIP_EXT),g()},windowId:o}));return rr.a.createElement(bj.b,{anchorEl:t,identity:{windowId:o,name:yj},className:jP,content:f,deltaPosition:{top:-8},placement:"top-right",style:{borderRadius:"4px",padding:0}})}Sj.propTypes={refCB:oC.a.object,onCompleteWelcome:oC.a.func,onClosePopover:oC.a.func};var Cj=Object(tj.b)(Sj),Ej=s("4mSp"),Oj=s("bB2L"),Mj=s("JKN4");const Tj="qrcb-popover-container",wj=`${Tj}__header`,Rj=`${wj}__title`,Lj=wj+"__manage-btn",Dj=`${Tj}__body`,Aj=`${Dj}__hint-c`,Fj=`${Aj}__tip`,kj=`${Aj}__desc`;var Nj=s("tjM/");function Pj(){return rr.a.createElement("div",{className:Aj},rr.a.createElement("div",{className:Fj},rr.a.createElement(Mj.a,{textKey:"STR_TIP"}),":"),rr.a.createElement("div",{className:kj},rr.a.createElement(Mj.a,{textKey:"STR_INPUT"}),rr.a.createElement(Nj.a,{className:"ml-4 mr-4",size:"small"}),rr.a.createElement(Mj.a,{textKey:"STR_INPUT_QR_LIST"}),"."))}Pj.propTypes={};var jj=Pj,Uj=s("QJeg"),Bj=s("egaF"),zj=s("huGB");const Gj={top:0,left:0,right:window.innerWidth-10,bottom:window.innerHeight},xj=Y.PopoverIdentitiesDefine.QM_DASHBOARD;const Vj=Object(tj.b)((function(e){var t,s;const{anchor:a,conversationId:i,data:n={},isOpen:r,onClosePopover:o,windowId:l,popupDocument:c}=e,{selfWindow:d}=Object(SC.a)(),u=Object(YS.b)();let h=Object(rj.p)();const[g,m]=Object(nr.useState)(h),p=e=>{const t={item:e,conversationId:i,sendSrc:"dashboard"};u.emit(ve.GeneralActions.REPLACE_QR_KEYWORD_TO_CHAT_INPUT,t),Object(rj.n)(o)()},f=null!==(t=null==n||null===(s=n.list)||void 0===s?void 0:s.length)&&void 0!==t?t:0;if(Object(nr.useEffect)((()=>{const e={windowId:l,name:xj},t=()=>{m(!1),Object(rj.n)(o)()};return bj.a.on("beforeClose",e,t),()=>{bj.a.removeListener("beforeClose",e,t)}}),[]),Object(nr.useEffect)((()=>{r&&Object(_j.b)(l,xj)}),[r]),!r)return null;const v=rr.a.createElement("div",{className:zj.q},rr.a.createElement(lr.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_1"})," ",rr.a.createElement(lr.a,{textKey:"STR_MANAGE"})," ",rr.a.createElement(lr.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_2"}),"."),_=rr.a.createElement("div",{className:Tj},rr.a.createElement("div",{className:wj},rr.a.createElement("div",{className:Rj,"data-id":"div_QuickMsg_QMTitle"},le.a.trans("STR_TITLE_QUICK_MESSAGES_WITH_COUNTING",[f])),rr.a.createElement(Ej.a,{title:v,boundary:Gj,open:g,delay:100,placement:"top-center",popupDocument:d},rr.a.createElement("div",{className:"rel"},rr.a.createElement(cr.a,{className:Lj,"data-id":"btn_QuickMsg_Manage",type:"tertiary-primary",size:"medium",onClick:()=>{h&&Object(rj.b)(),Object(_j.a)(l,xj),Object(oj.b)(oj.a.Management.ON_OPEN_IN_DASHBOARD),vj.a.showManagerModal(l,{from:"dashboard"})}},rr.a.createElement(lr.a,{textKey:"STR_MANAGE"}))))),rr.a.createElement("div",{className:Dj,style:{height:Object(rj.g)(f)}},rr.a.createElement(Bj.b,{autoHide:!0,noHScroll:!0,noVScroll:!1},rr.a.createElement("div",{"data-id":"div_QuickMsg_QMList",style:{flex:1,height:"100%"}},(e=>{let t=null==e?void 0:e.list;if(!t||!Array.isArray(t)||!t.length)return rr.a.createElement(Uj.a,{mode:"dashboard"});const s=t.map((e=>rr.a.createElement(Oj.a,{borders:{bottom:!0},canActions:!1,className:"clickable",data:e,dataId:"div_QuickMsg_QMItem",onClick:p})));return t.length<=3&&s.push(rr.a.createElement(jj,null)),s})(n)))));return rr.a.createElement(bj.b,{anchorEl:a,identity:{windowId:l,name:xj},className:"qrcb-popover",content:_,deltaPosition:{top:-4},placement:"top-left",zIndex:9999})}));Vj.propTypes={anchor:oC.a.element,conversationId:oC.a.string,data:oC.a.object,isOpen:oC.a.bool,onClosePopover:oC.a.func,windowId:oC.a.string};var Hj=Vj;var Wj=function(e){const{showWelcome:t}=e;return t?rr.a.createElement(Cj,e):rr.a.createElement(Hj,e)},qj=s("aloy");function Kj(e,t){const{onClick:s,isOpen:a}=e,[i,n]=Object(nr.useState)(Object(rj.q)());return rr.a.createElement("div",{className:zj.n},rr.a.createElement("div",null,rr.a.createElement(qj.b,{ref:t,key:"quick-msg",id:"QR_ChatBar-Btn",isActive:a,onClick:e=>{i&&(n(!1),Object(rj.c)()),Object(rj.n)(s)(e)},icon:"Quick-msg",title:"STR_QR_INSERT","data-id":"btn_QuickMsg_Entry"}),i?rr.a.createElement("div",{className:Object(lC.a)(zj.m)},rr.a.createElement("i",{className:`fa fa-red_dot ${zj.l}`})):null))}Kj.propTypes={onClick:oC.a.func};var $j=Object(nr.forwardRef)(Kj),Zj=s("RwJP"),Qj=s("Bdpz");function Yj(e){const{conversationId:t}=e,{windowId:s,selfDocument:a}=Object(SC.a)(),[i,n]=Object(nr.useState)(!1),[,r]=Object(nr.useState)({}),o=Object(nr.useRef)(),l=Object(nr.useRef)(),c=Object(YS.b)(),[,d]=Object(Zj.a)(),u=()=>{n(!1)};Object(nr.useEffect)((()=>{const e=()=>{r({})};return le.a.callUpdate(e),()=>{le.a.removeUpdate(e)}}),[]),Object(nr.useEffect)((()=>{const e=()=>{u()};return a.addEventListener("resize",e),()=>{a.removeEventListener("resize",e)}}),[]),Object(nr.useEffect)((()=>{const e=c.on(ve.GeneralActions.OPEN_QM_DASHBOARD,((e,t)=>{o.current&&"function"==typeof o.current.click&&e===s&&o.current.click()}));return()=>{e.remove()}}),[]),Object(nr.useEffect)((()=>{const e=c.on(ve.GeneralActions.UPDATE_QUICK_MESSAGE_STATUS,(()=>{r({})}));return()=>{e.remove()}}),[]);const h=Object(rj.s)(d);return Qj.a.Config.isEnableQuickReply()&&Qj.a.FeatureSettings.getFeatureStatus()?rr.a.createElement(rr.a.Fragment,null,rr.a.createElement(Wj,{anchor:o.current,conversationId:t,data:d,eventHandler:l.current,isOpen:i,onCompleteWelcome:()=>{n(!1),setTimeout((()=>{n(!0)}),100)},onClosePopover:u,showWelcome:h,windowId:s,popupDocument:a}),rr.a.createElement($j,{ref:e=>o.current=e,onClick:e=>{l.current=Object(I.a)({},e),n(!i),Object(oj.b)(oj.a.Feature.CLICK_ENTRYPOINT)},isOpen:i})):null}Yj.propTypes={conversationId:oC.a.string,onClickEP:oC.a.func,onClosePopover:oC.a.func,refCB:oC.a.any,refEP:oC.a.any,windowId:oC.a.string};var Jj,Xj=Yj;Object(a.singleton)(NP.a)(Jj=Reflect.metadata("design:type",Function)(Jj=Reflect.metadata("design:paramtypes",[])(Jj=class{constructor(){this._chatBoxToolbarButtonsMap=new Map,this._registerChatBoxToolbarButtons()}_registerChatBoxToolbarButtons(){this._chatBoxToolbarButtonsMap.set(kP.b.SEND_STICKER_ITEM,(e=>rr.a.createElement(PP.r,e))),this._chatBoxToolbarButtonsMap.set(kP.b.PICK_PHOTO_ITEM,(e=>rr.a.createElement(PP.l,e))),this._chatBoxToolbarButtonsMap.set(kP.b.PICK_FILE_ITEM,(e=>rr.a.createElement(PP.j,e))),this._chatBoxToolbarButtonsMap.set(kP.b.SCREEN_CAPTURE_ITEM,(e=>rr.a.createElement(PP.n,e))),this._chatBoxToolbarButtonsMap.set(kP.b.SCREEN_CAPTURE_OPTIONS_ITEM,(e=>rr.a.createElement(PP.p,e))),this._chatBoxToolbarButtonsMap.set(kP.b.SHARE_CONTACT_ITEM,(e=>rr.a.createElement(PP.s,e))),this._chatBoxToolbarButtonsMap.set(kP.b.CREATE_REMINDER_ITEM,(e=>rr.a.createElement(PP.d,e))),this._chatBoxToolbarButtonsMap.set(kP.b.CREATE_TODO_ITEM,(e=>rr.a.createElement(PP.e,e))),this._chatBoxToolbarButtonsMap.set(kP.b.TOGGLE_RTF_MODE_ITEM,(e=>rr.a.createElement(PP.u,e))),this._chatBoxToolbarButtonsMap.set(kP.b.MARK_IMPORTANT_MESSAGE_ITEM,(e=>rr.a.createElement(PP.g,e))),this._chatBoxToolbarButtonsMap.set(kP.b.QUICK_MESSAGE_ITEM,(e=>rr.a.createElement(Xj,{conversationId:e.convId}))),this._chatBoxToolbarButtonsMap.set(kP.b.MORE_ITEM,(e=>rr.a.createElement(PP.h,e)))}getChatBoxToolbarButton(e){return this._chatBoxToolbarButtonsMap.get(e)}})||Jj)||Jj);var eU,tU=s("RPT1"),sU=s("TsEa"),aU=s("Y25x"),iU=s("7fvu");Object(Ai.b)(tU.b)(eU=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(eU=Reflect.metadata("design:type",Function)(eU=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(eU=class{constructor(e){this.type=void 0,this.key=iU.a,this.name=tU.a,this._chatBoxCommandUIStateMap=new Map,this._isSupportCommandModeMap=new Map,this._logger=void 0,this._logger=e.createZLogger(R.ZLoggerNametags.cbiCommandController,[R.ZLoggerNametags.cbiCommandMode])}init(){}getItem(e,t){if(!e.key)return;const s=this._chatBoxCommandUIStateMap.get(e.key);if(s)return s;if(Object(aU.b)(e.key)){const t=this._initDefaultState();return this._chatBoxCommandUIStateMap.set(e.key,t),t}}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"Zwi0lL",["[onGetItemFailure] key: {}, error: {}","RmcrN1"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"f5diXG",["[onGetListFailure] key: {}, error: {}","fHmJDJ"],e,t.message)}getChatBoxCommandModeOfConv(e){if(!e){const t=`[getChatBoxCommandModeOfConv] ${e} is invalid!`;return this._logger.zsymb(18,"FOOV6u",t),-1}let t=this._chatBoxCommandUIStateMap.get(Object(aU.a)(e));return t||(t=this._initDefaultState(),this._chatBoxCommandUIStateMap.set(Object(aU.a)(e),t)),t.currentMode}setNewChatBoxCommandModeOfConv(e,t){if(!t){const e=`[setNewChatBoxCommandModeOfConv] ${t} is invalid!`;return void this._logger.zsymb(18,"ycaWD4",e)}let s=this._chatBoxCommandUIStateMap.get(Object(aU.a)(t));s||(s=this._initDefaultState());let a=Object(Lg.a)(s,(t=>{t.currentMode=e}));a!==s&&(this._chatBoxCommandUIStateMap.set(Object(aU.a)(t),a),Object(Po.h)(this.name,Object(aU.a)(t)))}resetChatBoxCommandModeToNormalModeOfConv(e){this.setNewChatBoxCommandModeOfConv(sU.b.NORMAL,e)}getPlaceholderOfMode(e){if(!e||-1===e)return"";const t=sU.c[e];return t.hasOwnProperty("placeholder")&&t.placeholder?t.placeholder:""}_initDefaultState(){return{currentMode:sU.b.NORMAL}}})||eU)||eU)||eU);var nU,rU,oU,lU,cU,dU,uU,hU,gU,mU,pU,fU,vU=s("0EGn"),_U=s("ETgL"),bU=s("xHgQ"),IU=s("PflS"),yU=s("pr8J");const SU={conversationId:"",showSlider:!1,items:[],selectedId:null,hasOlder:!0,hasNewer:!0,entry:XE.l.Unknown,showCaption:!0};nU=Object(a.injectable)(),rU=Object(Ai.b)(JE.b),oU=Reflect.metadata("design:type",Function),lU=Reflect.metadata("design:paramtypes",[]),cU=function(e,t,s){const a=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await a.apply(this,e);return t(),s}catch(s){throw t(),s}},s},dU=Reflect.metadata("design:type",Function),uU=Reflect.metadata("design:paramtypes",[void 0===yU.LoadConfig?Object:yU.LoadConfig,String,Boolean]),hU=function(e,t,s){const a=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await a.apply(this,e);return t(),s}catch(s){throw t(),s}},s},gU=Reflect.metadata("design:type",Function),mU=Reflect.metadata("design:paramtypes",[void 0===yU.LoadConfig?Object:yU.LoadConfig]),nU(pU=rU(pU=oU(pU=lU((fU=class{constructor(){this._runningTasks=new Map,this._eventEmitter=new of.a,this._abortedTask=new Set,this.dispose=()=>{this._runningTasks.forEach((e=>e.abort())),this._runningTasks.clear(),this._abortedTask.clear(),this._eventEmitter.removeAllListeners(),a.ModuleContainer.resolve(Qp.b).removeActiveWindowContext()},this.toggleSlider=e=>{this.ensureInitState(e);let t=this.data.get(e);t=Object(I.a)(Object(I.a)({},t),{},{showSlider:!t.showSlider}),this.data.set(e,t),this._signalRenderItem(this.name,e)},this.ensureInitState=(e,t=!0)=>{this.data.get(e)||(this.data.set(e,Object(I.a)(Object(I.a)({},SU),{},{conversationId:e})),t||this._signalRenderItem(this.name,e))},this.getSelectedItem=e=>{const t=this.data.get(e);if(!t)return null;const s=t.selectedId;if(!s)return null;return t.items.find((e=>e.msgId===s||(null==e?void 0:e.fakeMsgId)===s))},this.manualDownload=async(e,t,s,a)=>{Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload);const i=this.getSelectedItem(s);let n;var r;(Object(ua.a)(!!i,`imageViewer: download item not found for ${s} ${a}`),Ia.default.logActionPhotoViewer(1830904),(null==i?void 0:i.msgType)===Y.MSG_VIDEO&&Ia.default.logActionPhotoViewer(1831306),(null==i?void 0:i.msgType)===Y.MSG_FILE)&&(n=null==i||null===(r=i.message)||void 0===r?void 0:r.title);if(Object(he.a)()){const e=ui.default.getConversationType(s);let t=new oe.c(oe.a.PhotoView).getBuilder().withMode(oe.e.Manual).withConvType(oe.b[e]).withType(oe.f.Photo).withCode(oe.d.PTVButton);if(i.constructor===String)await tt.default.run({entry:t.build(),type:tt.default.constants.DownloadType.Photo,data:{url:i,msgId:Date.now()+""},options:{saveAs:!0,srcAction:tt.default.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}});else{const e=Object(I.a)({},i);(null==e?void 0:e.msgType)!=Y.MSG_VIDEO&&(null==e?void 0:e.subType)!=Y.MSG_SUBTYPE_MEDIA_VIDEO||(t.withType(oe.f.Video),(null==e?void 0:e.msgType)!==Y.MSG_VIDEO&&(e.msgType=Y.MSG_VIDEO)),await tt.default.runByMsg(e,{entry:t.build(),options:{saveAs:!0,srcAction:tt.default.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}})}}else{var o,l;const s="string"==typeof i?i:null!=i&&null!==(o=i.message)&&void 0!==o&&o.href?i.message.href:null==i||null===(l=i.message)||void 0===l?void 0:l.oriUrl;Object(bU.downloadWebV2)(e,t.document,n,void 0,s,!1,{msgType:null==i?void 0:i.msgType,type:null==i?void 0:i.type,subType:null==i?void 0:i.subType})}},this.resetShowSlider=e=>{const t=this.data.get(e);t&&(this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{showSlider:!0})),this._signalRenderItem(this.name,e))},this._signalRenderItem=(...e)=>{Object(Po.h)(...e)},this._abortRunningTasks=(e,t=(()=>!1))=>{Array.from(this._runningTasks.keys()).filter((s=>s.startsWith(e)&&!t(s))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e),this._abortedTask.add(e)}))},this._isValidMessage=e=>(null==e?void 0:e.msgType)!==Y.MSG_UNDO&&(null==e?void 0:e.msgType)!==Y.MSG_DEL_EVERYONE,this._filterDuplicatedImages=e=>{let t=new Map;return e.reduce(((e,s)=>{if(!s)return e;if(null==s.cliMsgId||null==s.fromUid){if(s.msgType&&!isNaN(s.msgType)){let t=+s.msgType;if(t<=0||[Y.MSG_TODO,Y.MSG_TODO_DONE,Y.MSG_FRIEND_SENT_REQUEST,Y.MSG_SUGGEST_IN_CHAT].includes(t))return e.push(s),e}return e.push(s),e}const a=`${s.cliMsgId}_${s.fromUid}`,i=`[${a}]|[${s.msgId}][${s.sendDttm}|${s.src}]`;if(t.has(a)){const{msg:i}=t.get(a);return i.src===Y.MSG_SRC.SYNC_MOBILE_DB&&(s.fakeMsgId=i.msgId,Object.assign(i,s)),e}return t.set(a,{data:i,msg:s}),e.push(s),e}),[])},this._eventBusHandler=(e,t)=>{},this.name=JE.a,this.data=new Map,this.key="conversationId",this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){switch(e){case IU.a.ROTATE_LEFT:{const e=null==t?void 0:t.mediaId;Object(ua.a)("string"==typeof e,"payload must be an object with mediaId property"),a.ModuleContainer.resolve(Qp.b).rotateMedia(e,-90);break}case IU.a.ROTATE_RIGHT:{const e=null==t?void 0:t.mediaId;Object(ua.a)("string"==typeof e,"payload must be an object with mediaId property"),a.ModuleContainer.resolve(Qp.b).rotateMedia(e,90);break}default:this._eventEmitter.emit(e,t)}}undoDeleteMulti(e,t){const s=this.data.get(e);if(!s||!t.length)return;const a=[...s.items,...t];let i=this._filterDuplicatedImages(a.sort(((e,t)=>+e.sendDttm-+t.sendDttm)));i=this._filterDeletingMessages(e,i),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:i})),this._signalRenderItem(this.name,e)}removeItem(e,t){var s;const a=this.data.get(e);if(!a||!t)return;let i=a.items.findIndex((e=>e.msgId===a.selectedId));const n=a.items.filter((e=>e.msgId!==t.msgId));i=Math.min(i,n.length-1);const r=null===(s=n[i])||void 0===s?void 0:s.msgId;this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}removeMulti(e,t){var s;const a=this.data.get(e);if(!a||!t.length)return;const i=a.items.filter((e=>!t.includes(e.msgId)));if(0===i.length)return void this.emit("CLOSE_VIEWER",{conversationId:e});let n=a.items.findIndex((e=>e.msgId===a.selectedId));n=-1===n?i.length-1:n,n=Math.min(n,i.length-1);const r=null===(s=i[n])||void 0===s?void 0:s.msgId;this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{items:i,selectedId:r})),this._signalRenderItem(this.name,e)}async loadSlider(e){const{conversationId:t}=e;Object(ua.a)("string"==typeof t,"conversationId must be provided");try{await this._refreshSliderData(e)}catch(s){}}async loadMore(e,t,s){const{conversationId:a,entry:i,isMessageConv:n}=e;Object(ua.a)("string"==typeof a&&a.length>0,`conversationId must be provided. Got ${a}`),Object(ua.a)("backward"===t||"forward"===t,`direction must be backward or forward. Got ${t}`);const r=this.data.get(a);if(Object(ua.a)(!!r,"imageViewer: load more failed. SliderState must be initialized"),"backward"===t){var o,l;let t=r.hasOlder||s;if(!t)return;const d=`${a}-${i}-backward`;var c;if(this._abortRunningTasks(a,(e=>e!==d)),this._runningTasks.has(d))return void(await(null===(c=this._runningTasks.get(d))||void 0===c?void 0:c.promise));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const u=zp(this._loadMore,{conversationId:a,limit:20,message:r.items[0],options:{backward:!0,forward:!1,isMessageConv:n}});this._runningTasks.set(d,u);let h=await u.promise;if(this._abortedTask.has(d))return void this._abortedTask.delete(d);e.isMessageConv&&(h=h.result||h);const g=h;let m=this._filterDuplicatedImages([...g,...r.items]);m=this._filterDeletingMessages(a,m),t=g.length>0,this.data.set(a,Object(I.a)(Object(I.a)({},r),{},{items:m,hasOlder:t,selectedId:null!==(o=null===(l=this.data.get(a))||void 0===l?void 0:l.selectedId)&&void 0!==o?o:null})),this._signalRenderItem(this.name,a)}else{var d,u;let t=r.hasNewer||s;if(!t)return;const o=`${a}-${i}-forward`;var h;if(this._abortRunningTasks(a,(e=>e!==o)),this._runningTasks.has(o))return void(await(null===(h=this._runningTasks.get(o))||void 0===h?void 0:h.promise));this.onFunctionDone=()=>{this._runningTasks.delete(o)};const l=zp(this._loadMore,{conversationId:a,limit:20,message:r.items[r.items.length-1],options:{backward:!1,forward:!0,isMessageConv:n}});this._runningTasks.set(o,l);let c=await l.promise;if(this._abortedTask.has(o))return void this._abortedTask.delete(o);e.isMessageConv&&(c=c.result||c);const g=c;let m=this._filterDuplicatedImages([...r.items,...g]);m=this._filterDeletingMessages(a,m),t=g.length>0,this.data.set(a,Object(I.a)(Object(I.a)({},r),{},{items:m,hasNewer:t,selectedId:null!==(d=null===(u=this.data.get(a))||void 0===u?void 0:u.selectedId)&&void 0!==d?d:null})),this._signalRenderItem(this.name,a)}}selectPreviousItem(e){const t=this.data.get(e);Object(ua.a)(!!t,"imageViewer: select previous item failed. SliderState must be initialized");const s=Object(ly.d)(t.items),a=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(0===a||!s.length)return;const i=s[a-1],n=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedId:n})),this._signalRenderItem(this.name,e)}selectNextItem(e){const t=this.data.get(e);Object(ua.a)(!!t,"imageViewer: select next item failed. SliderState must be initialized");const s=Object(ly.d)(t.items),a=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(a===s.length-1||!s.length)return;const i=s[a+1],n=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedId:n})),this._signalRenderItem(this.name,e)}selectItem(e,t){const s=this.data.get(e);Object(ua.a)(!!s,"imageViewer: select item failed. SliderState must be initialized"),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedId:t})),this._signalRenderItem(this.name,e)}reset(e){Array.from(this._runningTasks.keys()).filter((t=>t.startsWith(e))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e)})),this._abortedTask.clear(),this.data.has(e)&&this.data.delete(e)}toggleCaption(e,t){if(!this.data.has(e))return;const s=this.data.get(e),a=Object(I.a)({},s);a.showCaption=void 0!==t?t:!s.showCaption,this.data.set(e,a),this._signalRenderItem(this.name,e)}_secureSliderState(e){var t;let{conversationId:s,selectedId:a,defaultItems:i,entry:n,disableSlider:r}=e,o=this.data.get(e.conversationId);const l=null===(t=o)||void 0===t?void 0:t.items.some((e=>e.msgId===a||e.fakeMsgId===a));let c=!0;if(e.disableLoadMore)return n===XE.l.Profile&&(i=i.slice().reverse()),o=Object(I.a)(Object(I.a)({},SU),{},{conversationId:s,items:i,selectedId:a,showSlider:!r,hasOlder:!1,hasNewer:!1,entry:e.entry}),this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s),c;const d=this._filterDeletingMessages(s,i);return o&&l?a!==o.selectedId&&(o=Object(I.a)(Object(I.a)({},o),{},{selectedId:a,entry:e.entry}),c=!1):(o=Object(I.a)(Object(I.a)({},SU),{},{conversationId:s,items:d,selectedId:a,showSlider:!r,hasOlder:!0,hasNewer:!0,entry:e.entry}),c=!1),c||(this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s)),c}async _refreshSliderData(e){const{conversationId:t,isMessageConv:s,entry:a,defaultItems:i}=e;let n=e.selectedId;let r=this._secureSliderState(e);if(e.disableLoadMore)return;let o=this.data.get(e.conversationId),l=o.items.findIndex((e=>e.msgId===n||e.fakeMsgId===n));if(-1===l){const e=o.items.map((e=>e.msgId||e.fakeMsgId));if(zconsole.zsymb(18,"h0aZsC",`MVR:refreshSlider: something wrong: selectedId ${n} not found in ${e}`),!o.items.length)return zconsole.zsymb(0,"Xb8vt3","MVR:refreshSlider: we don't have any items to view so close MVR early."),void this.emit("CLOSE_VIEWER",{conversationId:t});l=o.items.length-1}const c=o.items[l];n=null==c?void 0:c.msgId;const d=`${t}-${a}-${n}`;this._abortRunningTasks(t);let u=o.hasOlder,h=o.hasNewer;const g=l<10&&u,m=l>=o.items.length-10&&h;if(!g&&!m)return void(r||this._signalRenderItem(this.name,t));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const p=async t=>{const s=zp(this._loadMore,t);this._runningTasks.set(d,s);let a=await s.promise;if(e.isMessageConv&&(a=a.result||a),!this._abortedTask.has(d))return a;this._abortedTask.delete(d)};if(g){const e={conversationId:t,limit:10,message:c,options:{backward:!0,forward:!1,isMessageConv:s}},a=await p(e),i=this.data.get(t),o=i.items;let l=this._filterDuplicatedImages([...a,...o]);l=this._filterDeletingMessages(t,l),0==a.length&&(u=!1),this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{selectedId:n,items:l,hasOlder:u,hasNewer:h})),r=!1}if(m){const e={conversationId:t,limit:10,message:c,options:{backward:!1,forward:!0,isMessageConv:s}},a=await p(e),i=this.data.get(t),o=i.items;let l=this._filterDuplicatedImages([...o,...a]);l=this._filterDeletingMessages(t,l),0==a.length&&(h=!1),this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{selectedId:n,items:l,hasOlder:u,hasNewer:h})),r=!1}r||this._signalRenderItem(this.name,t);const f=this.data.get(t);null!=f&&f.items.length||this.emit("CLOSE_VIEWER",{conversationId:t})}async _loadMore(e){var t;const{conversationId:s,message:i,limit:n,options:{forward:r=!0,backward:o=!1,filter:l=null,isMessageConv:c=!1}={}}=e,d=i.msgId,u=(null===(t=Object(ly.a)(i))||void 0===t?void 0:t.total_item_in_group)||0;if(!1===c){let e;try{e=await a.ModuleContainer.resolve(vU.a).getImageMessagesForPhotoViewer(s,d,Math.max(n,u),r,o,l)}catch(h){}const t=_U.b.getOneBannedGroup(s);return t&&(e=_U.b.filterBannedMediaGroup(t.groupId,e)),e}return await we.default.getImagesForPhotoViewerFromMessage(i.toUid||s,i.sendDttm,d,Math.max(n,u),r,o)}_filterDeletingMessages(e,t){return t.filter((t=>!Kr.d.isDeleteMessage(e,t)&&this._isValidMessage(t)&&!ui.default.ZSafeFunction((()=>Object(m_.D)(t)),!1)&&!ui.default.ZSafeFunction((()=>Object(m_.y)(t)),!1)))}listenEvents(){_e.default.subscribe(this._eventBusHandler)}init(){this.listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}},Object(wk.a)(fU.prototype,"loadMore",[cU,dU,uU],Object.getOwnPropertyDescriptor(fU.prototype,"loadMore"),fU.prototype),Object(wk.a)(fU.prototype,"_refreshSliderData",[hU,gU,mU],Object.getOwnPropertyDescriptor(fU.prototype,"_refreshSliderData"),fU.prototype),pU=fU))||pU)||pU)||pU);var CU=s("DRxf"),EU=s("ftrm"),OU=s("pDj3");const MU="zcloud-status-service",TU=Object(a.define)(MU),wU="zcloud-key-service",RU=Object(a.define)(wU),LU="zcloud-plan-service-key",DU=Object(a.define)(LU);var AU=s("2T8k"),FU=s("nTk7");const kU=Object(a.define)("zcloud-status-manager");let NU=function(e){return e[e.ADD_CLOUDS=0]="ADD_CLOUDS",e[e.REMOVE_CLOUDS=1]="REMOVE_CLOUDS",e[e.ADD_TEMP_CLOUDS=2]="ADD_TEMP_CLOUDS",e[e.REMOVE_THREAD=3]="REMOVE_THREAD",e}({});class PU extends FU.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}get cloudDataManager(){return ue.a.getInstance()}get controller(){return a.ModuleContainer.resolve(Dy.c)}get openedConvs(){const e=K.default.getAllCurrentOpens();if(!e||0===e.length)return[];let t=e.map((e=>e===hr.c?a.ModuleContainer.resolve(jo.SidebarController).getCurrMainConvId():K.default.getConvIdFromWindowId(e)));return t=t.filter((e=>!!e)),t}get inInCloudOrZCloudView(){return[ME.b.MEDIA_TYPE,ME.b.CONVERSATION,ME.b.MY_CLOUD].includes(a.ModuleContainer.resolve(bE.b).getCurrentView())}calculateFromAddClouds(e){if(this.inInCloudOrZCloudView||(e=Dy.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e)if(a){const e=s,i=Dy.d.transferCloudItemRes(!0,a,e),n=Object(Dy.p)(a);n&&i&&(t[n]={personalCloud:i})}return t}calculateFromRemoveZCloudKeys(e){const t={};for(const s of e)if(s){s&&(t[s]={personalCloud:void 0})}return t}calculateFromTempClouds(e){if(this.inInCloudOrZCloudView||(e=Dy.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e)if(a){const e=a.msgInfo.isE2EE?null:s,i=Dy.d.transferCloudItemRes(!1,a,e),n=Object(Dy.p)(a);n&&i&&(t[n]={personalCloud:i})}return t}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const e=this.queue.shift();if(!e)break;this.numberOfRunningTasks++;const{data:t,resolve:s,reject:a}=e,{clouds:i=[],removeZCloudKeys:n=[],pCloudUpdate:r,updateSource:o}=t;let l=null;switch(o){case NU.ADD_CLOUDS:l=this.calculateFromAddClouds(i);break;case NU.ADD_TEMP_CLOUDS:l=this.calculateFromTempClouds(i);break;case NU.REMOVE_CLOUDS:l=this.calculateFromRemoveZCloudKeys(n)}l&&this.controller.onZCloudStatus(l),r&&this.controller.onZCloudStatus(r),s(),await new Promise((e=>setTimeout(e,100))),this.numberOfRunningTasks--,this.run()}}}const jU=[],UU=new FU.b(jU),BU=new PU(jU),zU=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}splitIntoBatches(e,t){const s=[];for(let a=0;a<e.length;a+=t)s.push(e.slice(a,a+t));return s}async calculateStatus(e){const{clouds:t=[],removeZCloudKeys:s=[],pCloudUpdate:a,updateSource:i}=e,n=new Promise(((e,n)=>{const r={data:{clouds:t,removeZCloudKeys:s,pCloudUpdate:a,updateSource:i},resolve:e,reject:n};this.provider.send(r),this.consumer.run()}));return n.catch((()=>{})).finally((()=>{})),n}async syncStatus(e,t=!1){if(t)this.calculateStatus({pCloudUpdate:e});else for(const s in e){const t={};t[s]=e[s],this.calculateStatus({pCloudUpdate:t})}}}(UU,BU);a.ModuleContainer.registerValue(kU,zU);var GU,xU=zU;let VU=Object(m.d)()(GU=Object(a.injectable)()(GU=function(e,t){return Object(a.inject)(OU.a)(e,void 0,0)}(GU=function(e,t){return Object(a.inject)(TU)(e,void 0,1)}(GU=function(e,t){return Object(a.inject)(RU)(e,void 0,2)}(GU=function(e,t){return Object(a.inject)(DU)(e,void 0,3)}(GU=Reflect.metadata("design:type",Function)(GU=Reflect.metadata("design:paramtypes",[void 0===OU.a?Object:OU.a,void 0===TU?Object:TU,void 0===RU?Object:RU,void 0===DU?Object:DU])(GU=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e,t,s,a){this.metrics=e,this.statusService=t,this.keyService=s,this.planService=a,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=CU.a,this.key=CU.a}onApplicationReady(){}onBizConfigReady(){if(!Object(EU.a)().isEnableUserPCloud())return this.Logger.zsymb(3,"whrFzU",["requestRSAKey but no permission!","dPCSU6"]),void this.keyService.removeRSAKey();this.metrics.setGetKeyAfterLoginTime(),this.keyService.requestRSAKey(KE.c.LOGIN)}async calculateZCloudStatusByMessages(e,t){if(!EU.b.shouldLoadInitStatus(t))return;let s=EU.b.filterValidMsgs(e);if(s=EU.b.normalizedMsgs(s),!s||!s.length)return;const a=await this.statusService.getStatusByMessages(s,t);xU.syncStatus(a,!0)}async calculateZCloudStatusByCloudItems(e){const t=await this.statusService.getStatusByCloudItems(e);xU.syncStatus(t,!0)}getErrorPCloudHandler(e,t){const{error:s,msgIds:a,windowId:i,showNoti:n,type:r}=e;return s&&null!=s&&s.hasNoKey?()=>this.onInteractMediaWithoutKey({msgIds:a,windowId:i,showNoti:n,type:r},t):()=>{}}checkPCloudWithoutKey(e){return this.keyService.checkPCloudWithoutKey(e)}onZCloudStatus(e){if(Object(AU.d)(e))return;Object.keys(e);this.statusService.syncCachePCloudInfo(e),this.statusService.signalUIPCloudInfo(e),this.statusService.shareUpdatePCloudAction(e)}onHandleHaveKey(){const e=this.keyService.createPCloudUpdateWithValidRSAKey();this.keyService.shareHaveKeyPCloudAction(e)}async onInteractMediaWithoutKey(e,t){if(this.keyService.showToastWarningNoKey(e),!Object(EU.a)().isEnableUserPCloud())return void this.Logger.zsymb(3,"6ESDcM",["requestRSAKey but no permission!","dPCSU6"]);const s=t||KE.c.RETRY;s===KE.c.INVIEW?this.metrics.setGetKeyAfterInviewTime():s===KE.c.RETRY&&this.metrics.setGetKeyAfterRetryTime(),this.keyService.requestRSAKey(s)}onZCloudFreePlan(){const e=this.statusService.createEmptyPCloudUpdate();this.keyService.removeRSAKey(),xU.syncStatus(e,!0),this.planService.shareOffPlanEvent()}onUpgradeZCloudPlan(){this.metrics.setGetKeyAfterChangePlanTime(),this.keyService.requestRSAKey(KE.c.CHANGE_PLAN),this.planService.shareUpgradePlanEvent()}onGracePeriodPlan(){this.planService.shareGracePeriodPlanEvent()}onRemoveThreads(e){for(const t of e){const e=this.statusService.createEmptyGroupPCloudUpdate(t);xU.syncStatus(e)}}})||GU)||GU)||GU)||GU)||GU)||GU)||GU)||GU;var HU,WU=s("0VmO");const qU={valid:!1,status:{isClouded:!0,isUncloud:!1},error:{hasNoKey:!0}},KU={valid:!1,status:{isClouded:!1,isUncloud:!0},error:null},$U={valid:!0,status:{isClouded:!0,isUncloud:!1},error:null};let ZU=Object(m.d)()(HU=Object(a.injectable)()(HU=function(e,t){return Object(a.inject)(WU.a)(e,void 0,0)}(HU=Reflect.metadata("design:type",Function)(HU=Reflect.metadata("design:paramtypes",[void 0===WU.a?Object:WU.a])(HU=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudStatusEventsResolver])),this._Logger}get controller(){return a.ModuleContainer.resolve(CU.b)}get cloudDataManager(){return ue.a.getInstance()}constructor(e){super(),this.zaloCloudConfig=e,this.name=void 0,this.key=void 0,this.msgs=void 0,this.convId=void 0,this._Logger=void 0,this.name=VE.a,this.key=VE.a,this.msgs=[],this.convId=null}onApplicationReady(){(Object(JC.g)()||Object(EU.a)().isEnableBizPCloud())&&(this.addDataCloudListeners(),this.addTestListeners())}addTestListeners(){this.addEventListener(KE.g.INIT_DATA,this.handleTestCloudEvents.bind(this)),this.addEventListener(KE.g.NO_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(KE.g.HAVE_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(KE.g.NOT_YET_CLOUDED,this.handleTestCloudEvents.bind(this))}addDataCloudListeners(){this.cloudDataManager.addListener(IE.c.ADD_CLOUD_ITEMS,this.handleAddedCloudItems.bind(this)),this.cloudDataManager.addListener(IE.c.UPDATE_CLOUD_ITEMS,this.handleUpdatedCloudItems.bind(this)),this.cloudDataManager.addListener(IE.c.TEMP_CLOUD_ITEMS,this.handleTempCloudItems.bind(this)),this.cloudDataManager.addListener(IE.c.REMOVE_CLOUD_ITEMS,this.handleCloudRemoveItems.bind(this)),this.cloudDataManager.addListener(IE.c.UPDATE_CLOUD_KEY_STATUS,this.handleHaveCloudKey.bind(this)),this.cloudDataManager.addListener(IE.c.REMOVE_THREAD_CLOUD,this.handleCloudRemoveThread.bind(this))}async handleTestCloudEvents(e){const t={};switch(e.type){case KE.g.INIT_DATA:for(const s of e.payload){t[Object(AU.f)(s)]={personalCloud:Object(I.a)({},$U)}}this.controller.onZCloudStatus(t);break;case KE.g.NO_KEY:for(const s of e.payload){t[Object(AU.f)(s)]={personalCloud:Object(I.a)({},qU)}}this.controller.onZCloudStatus(t);break;case KE.g.HAVE_KEY:this.controller.onHandleHaveKey();break;case KE.g.NOT_YET_CLOUDED:for(const s of e.payload){t[Object(AU.f)(s)]={personalCloud:Object(I.a)({},KU)}}this.controller.onZCloudStatus(t)}}handleAddedCloudItems(e){const t=xU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)xU.calculateStatus({clouds:t[s],updateSource:NU.ADD_CLOUDS})}handleUpdatedCloudItems(e){}handleTempCloudItems(e){const t=xU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)xU.calculateStatus({clouds:t[s],updateSource:NU.ADD_TEMP_CLOUDS})}handleCloudRemoveItems(e){const t=xU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)xU.calculateStatus({removeZCloudKeys:t[s],updateSource:NU.REMOVE_CLOUDS})}handleCloudRemoveThread(e){this.controller.onRemoveThreads(e)}handleHaveCloudKey(e){e&&(this.Logger.zsymb(3,"2adOnq",["handleHaveCloudKey","PZNK2P"]),this.controller.onHandleHaveKey())}bindMsg(e,t){this.msgs=e,this.convId=t}})||HU)||HU)||HU)||HU)||HU;var QU,YU=s("3+fW");let JU=Object(Ai.b)(YU.a)(QU=Object(a.injectable)()(QU=function(e,t){return Object(a.inject)(OU.a)(e,void 0,0)}(QU=Reflect.metadata("design:type",Function)(QU=Reflect.metadata("design:paramtypes",[void 0===OU.a?Object:OU.a])(QU=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e){this.name=void 0,this.type=void 0,this.key=void 0,this.data=new Map,this.metrics=void 0,this._Logger=void 0,this.name=YU.b,this.key=YU.b,this.metrics=e}_getState(e){return this.data.get(e)}setPCloudInfo(e,t){e?this.data.set(t,e):this.data.delete(t)}signalUIPCloudInfo(e){Object(Po.h)(this.name,e)}getListPCloudInfo(){return this.data.entries()}getPCloudBizState(e){var t,s,a;let i;i="string"==typeof e?e:Object(AU.f)(e);const n=this.data.get(i);return n&&n.status?{valid:n.valid,hasNoKey:(null===(t=n.error)||void 0===t?void 0:t.hasNoKey)||!1,isClouded:null===(s=n.status)||void 0===s?void 0:s.isClouded,isUncloud:null===(a=n.status)||void 0===a?void 0:a.isUncloud,error:n.error,isFreeCloudItem:n.isFreeCloudItem}:null}getPCloudInfo(e){let t;return t="string"==typeof e?e:Object(AU.f)(e),this._getState(t)}getItem(e){return this._getState(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||QU)||QU)||QU)||QU)||QU;const XU="zcloud-repository",eB=Object(a.define)(XU);var tB;let sB=Object(a.injectable)()(tB=Reflect.metadata("design:type",Function)(tB=Reflect.metadata("design:paramtypes",[])(tB=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudStatusRepository])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=XU,this.key=XU}get cloudDataManager(){return ue.a.getInstance()}getZCloudList(e,t){return 0===t.length?Promise.resolve({cloudedItems:[],tempCloudItems:[]}):new Promise((e=>{this.cloudDataManager.getCloudItems(t).then((s=>{let a=[];for(const e of s)e&&a.push(e);const i=a,n=i.map((e=>Object(AU.g)(e))),r=t.filter((e=>!n.includes(Object(AU.f)(e))));e({cloudedItems:i,tempCloudItems:r})})).catch((t=>{this.Logger.zsymb(3,"zwdcB5",["getZCloudList, err:","nNE19t"],t),e({cloudedItems:[],tempCloudItems:[]})}))}))}})||tB)||tB)||tB;var aB;let iB=Object(a.injectable)()(aB=function(e,t){return Object(a.inject)(OU.a)(e,void 0,0)}(aB=function(e,t){return Object(a.inject)(YU.a)(e,void 0,1)}(aB=function(e,t){return Object(a.inject)(VE.b)(e,void 0,2)}(aB=function(e,t){return Object(a.inject)(eB)(e,void 0,3)}(aB=Reflect.metadata("design:type",Function)(aB=Reflect.metadata("design:paramtypes",[void 0===OU.a?Object:OU.a,void 0===YU.a?Object:YU.a,void 0===VE.b?Object:VE.b,void 0===eB?Object:eB])(aB=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudStatusServices])),this._Logger}get cloudDataManager(){return ue.a.getInstance()}constructor(e,t,s,a){this.name=void 0,this.key=void 0,this.metrics=void 0,this.zCloudInfo=void 0,this.eventsResolver=void 0,this.zCloudStatusRepository=void 0,this._Logger=void 0,this.name=MU,this.key=MU,this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.zCloudStatusRepository=a}async getStatusByMessages(e,t){const s={},{cloudedItems:a,tempCloudItems:i}=await this.zCloudStatusRepository.getZCloudList(t,e),n=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const r of a){const e=r.msgInfo.isE2EE?null:n,t=Object(AU.g)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const a=EU.b.transferCloudItemRes(!0,r,e);a&&(s[t]={personalCloud:a})}}for(const r of i){const e=_d.b.isMsgE2ee(r)?null:n,t=Object(AU.f)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const a=EU.b.transferCloudItemRes(!1,r,e);a&&(s[t]={personalCloud:a})}}return Promise.resolve(s)}getStatusByCloudItems(e){const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e){const e=a.msgInfo.isE2EE?null:s,i=Object(AU.g)(a);if(!this.zCloudInfo.getPCloudInfo(i)&&i){const s=EU.b.transferCloudItemRes(!0,a,e);s&&(t[i]={personalCloud:s})}}return Promise.resolve(t)}syncCachePCloudInfo(e){for(const t in e){const s=e[t].personalCloud;this.zCloudInfo.setPCloudInfo(s,t)}}signalUIPCloudInfo(e){for(const t in e)this.zCloudInfo.signalUIPCloudInfo(t)}shareUpdatePCloudAction(e){this.eventsResolver.dispatchEvent(new KE.b(KE.a.UPDATE_STATUS,e))}createEmptyPCloudUpdate(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,a]of t)s&&a&&(a.isFreeCloudItem||(e[s]={personalCloud:void 0}));return e}createEmptyGroupPCloudUpdate(e){const t={},s=this.zCloudInfo.getListPCloudInfo();for(let[a,i]of s)a&&i&&a.includes(e)&&(t[a]={personalCloud:void 0});return t}})||aB)||aB)||aB)||aB)||aB)||aB)||aB;var nB;let rB=Object(a.injectable)()(nB=function(e,t){return Object(a.inject)(OU.a)(e,void 0,0)}(nB=function(e,t){return Object(a.inject)(YU.a)(e,void 0,1)}(nB=function(e,t){return Object(a.inject)(VE.b)(e,void 0,2)}(nB=Reflect.metadata("design:type",Function)(nB=Reflect.metadata("design:paramtypes",[void 0===OU.a?Object:OU.a,void 0===YU.a?Object:YU.a,void 0===VE.b?Object:VE.b])(nB=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudKeyServices])),this._Logger}get cloudDataManager(){return ue.a.getInstance()}constructor(e,t,s){this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=wU,this.key=wU}removeRSAKey(){this.cloudDataManager.checkUpgraded()&&this.cloudDataManager.removeKey()}requestRSAKey(e){this.cloudDataManager.checkUpgraded()&&e!==KE.c.CHANGE_PLAN||(e===KE.c.LOGIN||e===KE.c.CHANGE_PLAN?(this.cloudDataManager.updateZCloudKey(!1,e),this.metrics.onAutoRequestKey()):e===KE.c.RETRY&&(this.cloudDataManager.updateZCloudKey(!0,e),this.metrics.onManualRequestKey()))}checkPCloudWithoutKey(e){var t;const s=this.zCloudInfo.getPCloudInfo(e);return Boolean(null==s||null===(t=s.error)||void 0===t?void 0:t.hasNoKey)}createPCloudUpdateWithValidRSAKey(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,a]of t){if(!s||!a)continue;if(a.isFreeCloudItem)continue;const t=Object(I.a)(Object(I.a)({},a.error),{},{hasNoKey:!1}),i=a.status,n={valid:EU.b.checkValidFromBizState(t,i),status:i,error:t};e[s]={personalCloud:n}}return e}shareHaveKeyPCloudAction(e){this.eventsResolver.dispatchEvent(new KE.b(KE.a.HAVE_KEY,e))}showToastWarningNoKey(e){const{showNoti:t=!0,windowId:s=hr.c}=e,a=be.ZToastManagerHolder.getZToastManagerByWindowId(s);t&&a.show({noBackground:!0,textKey:"STR_PERSONAL_CLOUD_NO_KEY_TOAST",type:be.TOAST_TYPE.INFO,duration:3e3,styles:{width:"400px"},styleText:{whiteSpace:"pre-line"}})}})||nB)||nB)||nB)||nB)||nB)||nB;var oB;let lB=Object(a.injectable)()(oB=function(e,t){return Object(a.inject)(VE.b)(e,void 0,0)}(oB=Reflect.metadata("design:type",Function)(oB=Reflect.metadata("design:paramtypes",[void 0===VE.b?Object:VE.b])(oB=class{constructor(e){this.eventsResolver=e,this.name=void 0,this.key=void 0,this.name=LU,this.key=LU}shareUpgradePlanEvent(e){this.eventsResolver.dispatchEvent(new KE.b(KE.a.UPGRADE_ZCLOUD_PLAN,e||{}))}shareOffPlanEvent(e){this.eventsResolver.dispatchEvent(new KE.b(KE.a.OFF_PERSONAL_CLOUD_PLAN,e||{}))}shareGracePeriodPlanEvent(e){this.eventsResolver.dispatchEvent(new KE.b(KE.a.GRACE_PERIOD_ZCLOUD_PLAN,e||{}))}})||oB)||oB)||oB)||oB;var cB=s("MNOV");a.ModuleContainer.registerSingleton(CU.b,VU),a.ModuleContainer.registerSingleton(VE.b,ZU),a.ModuleContainer.registerSingleton(YU.a,JU),a.ModuleContainer.registerSingleton(eB,sB),a.ModuleContainer.registerSingleton(TU,iB),a.ModuleContainer.registerSingleton(RU,rB),a.ModuleContainer.registerSingleton(DU,lB),a.ModuleContainer.registerSingleton(OU.a,OU.b),a.ModuleContainer.registerSingleton(cB.a,cB.b),a.ModuleContainer.registerSingleton(WU.a,WU.b);var dB,uB=s("WDlm"),hB=s("Ivja"),gB=s("3rJp"),mB=s("j+NN");let pB=Object(a.injectable)()(dB=Reflect.metadata("design:type",Function)(dB=Reflect.metadata("design:paramtypes",[])(dB=class{constructor(){this.name=void 0,this.key=void 0,this.name=uB.b,this.key=uB.b}async doVerify(e){Object(wE.i)("call doVerify",null==e?void 0:e.length);const t=(null==e?void 0:e.length)&&!!hB.a.instance().isKeyAvailable(),{myCloudItems:s,decryptItems:a,submitItems:i,updateThumbUrlItems:n}=await this.analyse(e);Object(wE.i)("analysed...",null==s?void 0:s.length,null==a?void 0:a.length,null==i?void 0:i.length,null==n?void 0:n.length);let r=[];if(Object(Dy.b)().isEnableSubmitExtraInfoConv("mycloud")&&s.length>0){const e=await this.updateMyCloudItems(s);r=[...r,...e]}if(Object(Dy.b)().isEnableSubmitExtraInfoConv("other")&&t&&a.length>0){const e=await this.updatePCloudItems(a);r=[...r,...e]}if(Object(Dy.b)().isEnableSubmitExtraInfoConv("e2ee")&&t&&i.length>0){const e=await this.submitAndUpdatePCloudItems(i);r=[...r,...e]}if(n.length>0){const e=await this.updateThumbUrl(n);r=[...r,...e]}return r}async analyse(e){const t=e,s=Ce.default.sendToMeId;if(0===t.length||!s)return{myCloudItems:[],decryptItems:[],submitItems:[],updateThumbUrlItems:[]};const a=[],i=[],n=[],r=[];for(let g=0;g<t.length;g++){var o,l,c,d,u,h;const e=t[g];if(!e)continue;const m=(null==e||null===(o=e.msgInfo)||void 0===o?void 0:o.destId)==s,p=null==e||null===(l=e.msgInfo)||void 0===l?void 0:l.isE2EE,f=null===(c=e.mediaInfo)||void 0===c||null===(d=c.mediaExtInfo)||void 0===d?void 0:d.data,v=null===(u=e.mediaInfo)||void 0===u||null===(h=u.mediaExtInfo)||void 0===h?void 0:h.decryptedData;if(v){this.shouldUpdateThumbUrl(t[g],v)&&r.push(e)}else m?f||a.push(e):p?v||(f?i.push(e):n.push(e)):v||f&&i.push(e)}return{myCloudItems:a,decryptItems:i,submitItems:n,updateThumbUrlItems:r}}shouldUpdateThumbUrl(e,t){const s=ui.default.normalizeMessageType(e.msgInfo.msgType);if(mB.a.includes(s))try{return!Object(SE.a)(t).thumbUrl}catch(a){return!1}return!1}async updateThumbUrl(e){const t=Object(gB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[];if((t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>yE.a.getZCloudKeyFromCloudItem(e)===yE.a.getZCloudKeyFromQueryItem(i)));if(!i||!n)continue;const r=Object(gB.g)(n,i);r&&a.push(r)}})(s),0===a.length)return[];try{return await ue.a.getInstance().updateCloudQueue(a,["mediaInfo"]),Object(wE.s)("[updateThumbUrl] has success","updateClouds",a.length),a}catch(i){throw Object(wE.r)("[updateThumbUrl] has error",i),i}}async updateMyCloudItems(e){const t=Object(gB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[];if((t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>yE.a.getZCloudKeyFromCloudItem(e)===yE.a.getZCloudKeyFromQueryItem(i)));if(!i||!n)continue;const r=Object(gB.d)(n,i);r&&a.push(r)}})(s),0===a.length)return[];try{return await ue.a.getInstance().updateCloudQueue(a,["mediaInfo"]),Object(wE.s)("[updateMyCloudItems] has success","updateClouds",a.length),a}catch(i){throw Object(wE.r)("[updateMyCloudItems] has error",i),i}}decryptAndUpdateParams(e){return new Promise((async t=>{try{var s,a,i,n;const r=(null===(s=e.mediaInfo.mediaExtInfo)||void 0===s?void 0:s.data)||"",o=(null===(a=e.mediaInfo)||void 0===a||null===(i=a.mediaExtInfo)||void 0===i||null===(n=i.encryptInfo)||void 0===n?void 0:n.encryptKey)||"";Object(wE.i)("decryptAndUpdateParams...",r,o);let l=await hB.a.instance().decryptCloudInfo(r,o);if(l){const s=yE.a.getZCloudKeyFromCloudItem(e),a={};l=await this.updateDecryptedData(e,l),a[s]=l,Object(wE.s)("decrypt succcess",null==e?void 0:e.noiseId),t(a)}}catch(r){Object(wE.r)("[updatePCloudItems] => [decryptAndUpdateParams], has error",r),Object(wE.h)("decrypt info failed",null==e?void 0:e.noiseId,r),t("")}}))}async updateDecryptedData(e,t){const s=ui.default.normalizeMessageType(e.msgInfo.msgType);if(mB.a.includes(s)){let s=Object(SE.a)(t);if(s.thumbUrl)return JSON.stringify(s);const i=Object(gB.b)([e]),n=await ue.a.getInstance().getMultiMessages(i);if(n){const e=n;var a;if(e&&e[0])return s=Object(I.a)(Object(I.a)({},s),{},{thumbUrl:null===(a=e[0].message)||void 0===a?void 0:a.thumbUrl}),JSON.stringify(s)}}return t}async updatePCloudItems(e){const t=[],s=[];let a={};e.forEach((e=>{s.push(this.decryptAndUpdateParams(e))}));try{return(await Promise.allSettled(s)).forEach((e=>{e.value&&(a=Object(I.a)(Object(I.a)({},a),e.value))})),e.forEach((e=>{const s=yE.a.getZCloudKeyFromCloudItem(e);let i=a[s];if(i){const s=Object(gB.e)(e,i);t.push(s)}})),0===t.length?[]:(await ue.a.getInstance().updateCloudQueue(t,["mediaInfo"]),Object(wE.s)("[updatePCloudItems] has success","updateClouds",t.length),t)}catch(i){throw Object(wE.r)("[updatePCloudItems] has error",i),i}}encryptParams(e,t){return new Promise((async s=>{try{const a=await Object(gB.c)(e,t);s(a||"")}catch(a){Object(wE.r)("[submitAndUpdatePCloudItem] =>[encryptParams], has error",a),s("")}}))}async submitAndUpdatePCloudItems(e){const t=Object(gB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[],i=[];(t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>yE.a.getZCloudKeyFromCloudItem(e)===yE.a.getZCloudKeyFromQueryItem(i)));i&&n&&a.push(this.encryptParams(n,i))}})(s);try{const t=(await Promise.allSettled(a)).map((e=>e.value)).filter((e=>!!e)),s=t.map((e=>e.submit));if(0===s.length)return[];0;const n=await xE.a.submitMediaExtInfo({info:s});return Object(wE.s)("submit ext info success",n),t.forEach((t=>{const s=e.find((e=>e.noiseId===t.submit.noiseId));n&&s&&!n.noiseIdsErr.includes(s.noiseId)&&i.push(Object(gB.f)(s,t))})),0===i.length?[]:(await ue.a.getInstance().updateCloudQueue(i,["mediaInfo","encryptInfo"]),Object(wE.s)("[submitAndUpdatePCloudItems] has success","updateClouds",i.length),Object(wE.i)("update cloud success",i),i)}catch(n){throw Object(wE.r)("[submitAndUpdatePCloudItems] has error",n),n}}})||dB)||dB)||dB;var fB=s("LA5e");const vB="zcloud-queue-fetcher",_B=Object(a.define)(vB),bB="zcloud-base-sync-queue";Object(a.define)(bB);var IB;let yB=Object(a.injectable)()(IB=Reflect.metadata("design:type",Function)(IB=Reflect.metadata("design:paramtypes",[])(IB=class{constructor(){this.name=void 0,this.key=void 0,this.name=bB,this.key=bB}groupFetchedCloudsByAction(e){const t=[],s=[],a=[];for(let i=e.length-1;i>=0;i--){let n=e[i];if(n){let{action:e}=n;switch(e){case IE.a.add:a.push(n);break;case IE.a.remove:s.push(n);break;case IE.a.del_thread:t.push(n)}}}return{delThreads:t,delClouds:s,addClouds:a}}})||IB)||IB)||IB;var SB=s("vNFC"),CB=s("FvOk");const EB="zcloud-update-queue-after-fetch-queue",OB=Object(a.define)(EB);var MB=s("ZL0F");const TB=["lastNoiseId"];var wB;let RB=Object(a.injectable)()(wB=function(e,t){return Object(a.inject)(_B)(e,void 0,0)}(wB=function(e,t){return Object(a.inject)(OB)(e,void 0,1)}(wB=function(e,t){return Object(a.inject)(MB.a)(e,void 0,2)}(wB=Reflect.metadata("design:type",Function)(wB=Reflect.metadata("design:paramtypes",[void 0===_B?Object:_B,void 0===OB?Object:OB,void 0===MB.a?Object:MB.a])(wB=class extends yB{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,[R.ZLoggerNametags.zCloudVerifyQueueServices])),this._Logger}constructor(e,t,s){super(),this.queueFetcher=e,this.updateQueueService=t,this.syncZCloudQueueUIState=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=fB.a,this.key=fB.a}get PCloudMetrics(){return a.ModuleContainer.resolve(Dy.g)}async checkVerify(e){const{lastNoiseId:t,forceVerify:s,forceReset:a}=e.mycloudMedia;let i=await ue.a.getInstance().getLastNoiseId();return a?{sourceForceVerify:SB.a.CMD_621_FORCE_RESET}:s?{sourceForceVerify:SB.a.CMD_621_FORCE_VERIFY}:i?t!==i?{sourceVerify:SB.b.CMD_621_VERIFY}:{}:{sourceForceVerify:SB.a.CMD_621_EMPTY_LAST_NOISEID}}async buildVerifyFetchReq(e){try{return{lastNoiseId:await ue.a.getInstance().getLastNoiseId(),lastNoiseIds:[],loadType:IE.d.oldest_to_newest,trackingSource:e.trackingSource}}catch(t){throw t}}buildForceVerifyFetchReq(e){return{lastNoiseId:"",lastNoiseIds:[],loadType:IE.d.oldest_to_newest,trackingSource:e.trackingSource}}shouldCheckResetItem(e){return(null==e?void 0:e.sourceForceVerify)!==SB.a.CMD_620_RESET_CLOUD}async doFetch(e,t,s,a=!1){const i={lastNoiseId:"",cloudItems:[],hasMore:!1};let n=!0,r=!a&&this.shouldCheckResetItem(s);for(t===CB.a.VERIFY_PAGE&&(i.preventCheckResetItem=a);n;){var o;const{cloudItems:s,lastNoiseId:a,hasMore:l}=await this.queueFetcher.fetchQueueByPage(e),c=null!=a?a:null===(o=s[0])||void 0===o?void 0:o.noiseId;if(s.find((e=>e.action===IE.a.reset_cloud))&&this.Logger.zsymb(0,"YAIpNM","doFetch ###### [DEV-DEBUG] ##### FOUND RESET ITEM ######"),r){s.find((e=>e.action===IE.a.reset_cloud))?(this.Logger.zsymb(0,"B1rGUg","doFetch, force verify from [found reset_item], sourceForceVerify",SB.a.VERIFY_FOUND_RESET_CLOUD),await ue.a.getInstance().removeAll(),i.cloudItems=[],i.lastNoiseId="",e.lastNoiseId="",n=!0,r=!1,t===CB.a.VERIFY_PAGE&&(i.preventCheckResetItem=!0)):(i.cloudItems.unshift(...s),i.lastNoiseId=c,i.hasMore=!!l,e.lastNoiseId=c,n=!!l)}else i.cloudItems.unshift(...s),i.lastNoiseId=c,i.hasMore=!!l,e.lastNoiseId=c,n=!!l;if(t===CB.a.VERIFY_PAGE&&i.cloudItems.length>0)break}return i}async verify(e){const{data:t,syncStrategy:s,sourceSync:a,req:i,preventCheckResetItem:n}=e;try{const e=i||await this.buildVerifyFetchReq(t),{cloudItems:r,lastNoiseId:o,hasMore:l,preventCheckResetItem:c}=await this.doFetch(e,s,a,n),{delThreads:d,delClouds:u,addClouds:h}=this.groupFetchedCloudsByAction(r);return{delThreads:d,delClouds:u,addClouds:h,lastNoiseId:o,hasMore:l,preventCheckResetItem:c}}catch(r){throw r}}forceVerify(e){const{data:t,syncStrategy:s,sourceSync:a,req:i,preventCheckResetItem:n}=e,r=i||this.buildForceVerifyFetchReq(t);return this.verify({data:t,syncStrategy:s,sourceSync:a,req:r,preventCheckResetItem:n})}async doVerifyWithSourceVerify(e,t,s){let a=null;return a=await this.verify({data:{trackingSource:IE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceVerify:t},preventCheckResetItem:s}),a}async doForceVerifyWithOtherForceVerify(e,t,s){let a=null;return this.syncZCloudQueueUIState.setForceSyncSource(t),this.Logger.zsymb(0,"xth6vc","syncQueueByVerify, otherForceVerify",t),await ue.a.getInstance().removeAll(),a=await this.forceVerify({data:{trackingSource:IE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceForceVerify:t},preventCheckResetItem:s}),a}async doVerifyWithServerCmd(e,t,s){let a=null;Object(wE.s)("doVerifyWithServerCmd",e,t,s);const{sourceForceVerify:i,sourceVerify:n}=await this.checkVerify(e);return i===SB.a.CMD_621_FORCE_RESET||i===SB.a.CMD_621_FORCE_VERIFY||i===SB.a.CMD_621_EMPTY_LAST_NOISEID?(this.Logger.zsymb(0,"lKblOh","syncQueueByVerify, sourceForceVerify",i),this.syncZCloudQueueUIState.setForceSyncSource(i),await ue.a.getInstance().removeAll(),a=await this.forceVerify({data:{trackingSource:IE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceForceVerify:i},preventCheckResetItem:s})):n===SB.b.CMD_621_VERIFY&&(Object(wE.s)("doVerifyWithServerCmd, sourceVerify",n),a=await this.verify({data:{trackingSource:IE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceVerify:n}})),a}async doVerify(e){const{data:t,syncStrategy:s,sourceVerify:a,otherForceVerify:i,preventCheckResetItem:n=!1}=e;let r=null;if(a?r=await this.doVerifyWithSourceVerify(s,a,n):i===SB.a.TOOL_CLIENT||i===SB.a.CMD_620_RESET_CLOUD||i==SB.a.SELF_VERIFY?r=await this.doForceVerifyWithOtherForceVerify(s,i,n):t&&(r=await this.doVerifyWithServerCmd(t,s,n)),r){var o,l,c;const{lastNoiseId:e}=r,t=Object(zi.a)(r,TB);this.Logger.zsymb(0,"Ply2xd","syncQueueByVerify, after fetched & filtered actions, ","added clouds",null===(o=t.addClouds)||void 0===o?void 0:o.length,"deleted clouds",null===(l=t.delClouds)||void 0===l?void 0:l.length,"deleted thread",null===(c=t.delThreads)||void 0===c?void 0:c.length),await this.updateQueueService.updateQueue(Object(I.a)(Object(I.a)({},t),{},{lastNoiseId:e})),this.Logger.zsymb(0,"RI3P8E","syncQueueByVerify, done update db, lastNoiseId",e)}return r}async submitVerifyAction(e){try{await xE.a.submitVerifyAction({type:e})}catch(t){this.Logger.zsymb(18,"M5Ls2m","submitVerifyAction",t)}}})||wB)||wB)||wB)||wB)||wB)||wB;var LB;let DB=Object(a.injectable)()(LB=Reflect.metadata("design:type",Function)(LB=Reflect.metadata("design:paramtypes",[])(LB=class extends yB{constructor(){super(),this.name=void 0,this.key=void 0,this.name=EB,this.key=EB}async updateQueue(e){const{delThreads:t,delClouds:s,addClouds:a,lastNoiseId:i}=e;return(null==a?void 0:a.length)>0&&(Object(wE.k)("add -------",a),await _E.a.getInstance().setCloudItems(a,!0)),(null==s?void 0:s.length)>0&&(Object(wE.k)("del -------",s),await _E.a.getInstance().removeCloudItems(s,!0)),(null==t?void 0:t.length)>0&&(Object(wE.k)("delThread -------",t),await _E.a.getInstance().delThreads(t,!0)),i&&await _E.a.getInstance().setLastNoiseId(i,Date.now(),{}),[]}})||LB)||LB)||LB;var AB;let FB=Object(a.injectable)()(AB=Reflect.metadata("design:type",Function)(AB=Reflect.metadata("design:paramtypes",[])(AB=class{constructor(){this.name=void 0,this.key=void 0,this.name=vB,this.key=vB}async fetchQueue(e){const{loadType:t,lastNoiseIds:s,trackingSource:a}=e;let{lastNoiseId:i}=e;const n={lastNoiseId:"",cloudItems:[]};let r=!0;for(;r;){var o;const{mediaItems:e,hasMore:l,lastNoiseId:c}=await xE.a.verifyCloudMedia(i,t,s,a);Object(wE.s)("fetchQueue",c,null==e?void 0:e.length,l);const d=null!=c?c:null===(o=e[0])||void 0===o?void 0:o.noiseId,u=e.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));n.cloudItems.unshift(...u),n.lastNoiseId=d,i=d,r=l}return n}async fetchQueueByPage(e){var t;const{lastNoiseId:s,lastNoiseIds:a,loadType:i,trackingSource:n}=e,r={lastNoiseId:"",cloudItems:[],hasMore:0},{mediaItems:o,lastNoiseId:l,hasMore:c}=await xE.a.verifyCloudMedia(s,i,a,n);Object(wE.s)("fetchQueueByPage",null==o?void 0:o.length,l,c);const d=null!=l?l:null===(t=o[0])||void 0===t?void 0:t.noiseId,u=o.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));return r.cloudItems=u,r.lastNoiseId=d,r.hasMore=c,r}})||AB)||AB)||AB;var kB=s("jqP8"),NB=s("Hvyc"),PB=s("Dr9L");const jB="zcloud-media-pc-fetcher",UB=Object(a.define)(jB),BB="zcloud-media-web-fetcher",zB=Object(a.define)(BB);var GB;let xB,VB=Object(m.d)()(GB=Object(m.h)()(GB=Object(m.i)()(GB=Object(a.injectable)()(GB=function(e,t){return Object(a.inject)(UB)(e,void 0,0)}(GB=function(e,t){return Object(a.inject)(zB)(e,void 0,1)}(GB=Reflect.metadata("design:type",Function)(GB=Reflect.metadata("design:paramtypes",[void 0===UB?Object:UB,void 0===zB?Object:zB])(GB=class extends kB.a{constructor(e,t){super(),this.pcFetcher=e,this.webFetcher=t,this.name=void 0,this.key=void 0,this.cleanupTimeoutId=void 0,this.name=NB.b,this.key=NB.b,this.cleanupTimeoutId=null}onSessionExpired(){this.cleanup()}onDispose(){this.cleanup()}onApplicationReady(){this.cleanup()}doCleanupAfterTimeout(e){e&&(this.cleanupTimeoutId=setTimeout((()=>{this.cleanup()}),e))}clearCleanupTimeoutId(){this.cleanupTimeoutId&&clearTimeout(this.cleanupTimeoutId)}async getCloudItem(e){const t=this.getCloudQueryByMessage(e);return t?this.getCloudItemByCloudQuery(t):null}async getDownloadUrl(e,t,s){return this.getUrl(e,t,s)}async getDownloadHeaders(){return this.getHeaders()}async fetch(e){const{cloud:t,message:s,options:a}=e,{type:i}=a,n=await this.getDownloadUrl(t.cloud,s,i),r=await this.getHeaders();if(!n||!r)throw PB.b.getError(Object(I.a)(Object(I.a)({},PB.a.INVALID_PARAMS),{},{message:"No cloud "+(n?"headers":"url")}));return this.pcFetcher.fetch({url:n,headers:r,cloud:t.cloud,options:a})}async cleanup(){}})||GB)||GB)||GB)||GB)||GB)||GB)||GB)||GB;(xB||(xB={})).buildData=function(e){return ui.default.normalizeMessageType(e.msgInfo.msgType),Y.MSG_FILE,function(e){var t,s;const{zKey:a,msgInfo:i,mediaInfo:n}=e,{msgType:r,destId:o}=i,l=ui.default.normalizeMessageType(r),c=Object(pp.e)(null!=a?a:yE.a.getZCloudKeyFromCloudItem(e),l),d=yE.a.getConversationIdFromCloudItem(e,we.default.getUserId()),u=Object(SE.a)(o===Ce.default.sendToMeId?null==n||null===(t=n.mediaExtInfo)||void 0===t?void 0:t.data:null==n||null===(s=n.mediaExtInfo)||void 0===s?void 0:s.decryptedData),{fileSize:h,checksum:g,fType:m,title:p,fileExt:f}=u,v=p||Ju.a.NoNameFile,_=f||v.split(".").pop();return{fileName:v,localPath:c,conversationId:d,msgType:l,fileSize:h,checksum:g,fType:m,ext:_}}(e)};var HB=xB;const WB=["options"];var qB;let KB=Object(a.injectable)()(qB=Reflect.metadata("design:type",Function)(qB=Reflect.metadata("design:paramtypes",[])(qB=class{constructor(){this.name=void 0,this.key=void 0,this.name=jB,this.key=jB}async fetch(e){const{url:t,headers:s,cloud:a,options:i}=e,{options:n}=i,r=Object(zi.a)(i,WB),o=Object.assign(n,{headers:s}),l=Object.assign(HB.buildData(a),{url:t});return tt.default.run(Object(I.a)(Object(I.a)({},r),{},{options:o,data:l}))}})||qB)||qB)||qB;var $B;let ZB=Object(a.injectable)()($B=Reflect.metadata("design:type",Function)($B=Reflect.metadata("design:paramtypes",[])($B=class{constructor(){this.name=void 0,this.key=void 0,this.name=BB,this.key=BB}async fetch(e){const{url:t,options:s}=e,a=null!=s&&s.options?Object(I.a)(Object(I.a)({},null==s?void 0:s.options),{},{headers:e.headers}):{headers:e.headers},i=null==s?void 0:s.queueType,n=null==s?void 0:s.onProgress;return Object(at.h)(Object(at.j)().toString(),t,i,n,a)}})||$B)||$B)||$B;const QB="zcloud-photo-fetcher",YB=Object(a.define)(QB);var JB=s("LeFD");const XB=$znode.path,ez=e=>tt.default.run(e),tz=e=>new Promise((async(t,s)=>{try{var a;const{url:n,localPath:r,timeout:o=6e4,maxTTFB:l=2e4,signal:c,noCacheRespFail:d,disableCache:u,msgId:h,entrySerial:g,mediaId:m,options:p,sendDttm:f}=e,v=XB.basename(r),_=XB.dirname(r),b=Object(I.a)({srcAction:u?tt.default.constants.srcAction.Manual:tt.default.constants.srcAction.Dev,saveDir:_,caching:!0,cacheResp:{noCacheRespFail:d},error:{handleError:!0},maxTTFB:l,mediaId:m},p),y={entrySerial:g,type:tt.default.constants.DownloadType.Photo,data:{url:n,fileName:v,msgId:h,sendDttm:f},options:b},S=()=>{s(new JB.a)};if(null!=c&&c.aborted)return S();null==c||c.addEventListener("abort",S);const C=setTimeout((()=>{s(new JB.d)}),o),E=await Object(qp.a)(ez,y);if(null==c||c.removeEventListener("abort",S),clearTimeout(C),E.ok)return t(null);const O=E.error;if(!O)return s(new JB.f);const M="string"==typeof(null==O?void 0:O.code)||"number"==typeof(null==O?void 0:O.code)?null==O?void 0:O.code:null==O||null===(a=O.downloadError)||void 0===a?void 0:a.code;if(isNaN(M))return s(new JB.f(O.name));if(M>=75e3&&M<76e3){const e=M-75e3;if(Tp.a.image_loader.enable){var i;const t=null===(i=Tp.a.image_loader.retryErrorCodes)||void 0===i?void 0:i.some((t=>t===e));if(!!f&&t&&Object(Zp.a)(f))return s(new Kp.NotReadyError)}return s(new JB.c(e))}return s(1010==M?new JB.d:new JB.f(M))}catch(n){const e=new JB.f("[LoadPhotoPC]"+(null==n?void 0:n.message));return null!=n&&n.stack&&(e.stack=n.stack),s(e)}}));var sz;let az=Object(a.injectable)()(sz=function(e,t){return Object(a.inject)(NB.a)(e,void 0,0)}(sz=Reflect.metadata("design:type",Function)(sz=Reflect.metadata("design:paramtypes",[void 0===NB.a?Object:NB.a])(sz=class extends kB.a{constructor(e){super(),this.mediaZCloudFetcher=e,this._responsesCache=new Map,this._blobURLReserveMap=new Map,this.name=void 0,this.key=void 0,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(qp.a)(tz,e),a=s.ok?t:"";if(s.ok)return{mediaURL:a,error:void 0};throw s.error},this._downloadWithRetry=Object(Mp.a)(this._downloadHandler,{min:Tp.a.image_loader.retryMin,max:Tp.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Tp.a.image_loader.lastTryDelayTime.min,max:Tp.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof Ik.a.NotReadyError||e instanceof Ik.a.TimeoutTTFB||e instanceof Ik.a.TimeoutError}),this.name=QB,this.key=QB}async fetchOnWeb(e,t){Object(Cp.a)("string"==typeof t&&Ep(t),`Media source must be a (http|https) URL. Got ${t}`);const s=this._responsesCache.get(t);if(s&&!s.isRevoked)return np.l.Success({mediaURL:this._responsesCache.get(t).blobURL});try{const s=Object(at.j)().toString(),a=Object(Mp.a)(at.h,{min:Tp.a.image_loader.retryMin,max:Tp.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Tp.a.image_loader.lastTryDelayTime.min,max:Tp.a.image_loader.lastTryDelayTime.max}}),i=await this.mediaZCloudFetcher.getDownloadHeaders(),n=await a(s,t,at.a.dev,void 0,{useDiskCache:!1,headers:i});if(n.error)return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n.error}});const r=this._responsesCache.get(t)||{};return this._cacheResponse(t,Object(I.a)(Object(I.a)({},r),{},{remoteURL:t,blobURL:n.data,mediaId:e,isRevoked:!1})),np.l.Success({mediaURL:n.data})}catch(a){return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:a}})}}_cacheResponse(e,t){this._responsesCache.set(e,t),this._blobURLReserveMap.set(t.blobURL,e)}async fetchOnPC(e,t,s){const{entrySerial:a,savePath:i}=s;if(i&&Object(ki.a)(i))return np.l.Success({mediaURL:i});try{let n={url:t,mediaId:e,localPath:i,entrySerial:a,sendDttm:null==s?void 0:s.sendDttm,noCacheRespFail:(null==s?void 0:s.sendDttm)&&Object(Zp.a)(null==s?void 0:s.sendDttm)};const r=await this.mediaZCloudFetcher.getDownloadHeaders(),o=s.autoDownload?{srcAction:tt.default.constants.srcAction.Auto,headers:r}:{headers:r};n.options=o;const l=await this._downloadWithRetry(n);return l.error?np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:l.error}}):np.l.Success({mediaURL:i})}catch(n){return np.l.Failure({code:np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n}})}}async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:a}=e;let i;Object(Cp.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Cp.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),i=a?np.j.DiskCache:np.j.MemoryCache;const n=Ep(s),r=Op(s);if(!n&&r)return np.l.Success({mediaURL:s});if(!n&&!r){var o,l;const e=!r||["file://","zfile://"].some((e=>s.startsWith(e)));if(e&&(null===(o=$znode.fs)||void 0===o?void 0:o.existsSync(null==s||null===(l=s.replace("file://",""))||void 0===l?void 0:l.replace("zfile://",""))))return np.l.Success({mediaURL:s});if(e)return np.l.Failure({code:np.d.FAILURE_BY_FETCH})}if(i===np.j.MemoryCache)try{return await this.fetchOnWeb(t,s)}catch(u){return Promise.reject(u)}Object(Cp.a)("object"==typeof a&&"string"==typeof a.savePath&&!!a.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${a}`);const{savePath:c,downloadEntrySerial:d}=a;return this.fetchOnPC(t,s,{entrySerial:d,savePath:c})}})||sz)||sz)||sz)||sz;a.ModuleContainer.registerSingleton(uB.a,pB),a.ModuleContainer.registerSingleton(fB.b,RB),a.ModuleContainer.registerSingleton(OB,DB),a.ModuleContainer.registerSingleton(_B,FB),a.ModuleContainer.registerSingleton(NB.a,VB),a.ModuleContainer.registerSingleton(UB,KB),a.ModuleContainer.registerSingleton(zB,ZB),a.ModuleContainer.registerSingleton(YB,az);var iz=s("v9wC"),nz=s("/078"),rz=s("Q8oB");const oz=Object(a.define)("zcloud-offload-client-storage");class lz{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("OffloadStorage already initialized");this.key="zcloud-offload-storage"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}const cz="state_store",dz={isOffloading:!1};class uz{constructor(e){this.adapter=e,this._state=void 0}get isOffloading(){return!!this._state&&this._state.isOffloading}set isOffloading(e){this._state||(this._state=dz),this._state=Object(I.a)(Object(I.a)({},this._state),{},{isOffloading:e}),this.save()}load(){this._state=this.adapter.read(cz,1)}clear(){this._state=null,this.save()}save(){this._state?this.adapter.write(cz,1,this._state):this.adapter.remove(cz)}}a.ModuleContainer.registerSingleton(oz,class{constructor(){this._adapter=void 0,this._offloadStateStore=void 0,this._adapter=new lz,this._offloadStateStore=new uz(this._adapter)}load(){this._adapter.load(),this._offloadStateStore.load()}clear(){this._offloadStateStore.clear()}get offloadState(){return this._offloadStateStore}});var hz=s("LZ6X"),gz=s("n+2d");var mz,pz,fz,vz,_z,bz,Iz,yz,Sz,Cz,Ez,Oz,Mz,Tz,wz,Rz,Lz,Dz,Az,Fz=function(e){return function(t,s,i){const n=i.value;return i.value=function(...t){const s=a.ModuleContainer.resolve(e).getState().zCloudStatus;if(s.hasKey&&s.isPaid)return n.apply(this,t);Object(gz.a)("Not ready for offload: ",JSON.stringify(s))},i}},kz=s("hhQE"),Nz=s("y6jC");let Pz=(mz=Object(m.d)(),pz=Object(m.f)(),fz=Object(m.h)(),vz=Object(a.injectable)(),_z=function(e,t){return a.ModuleContainer.inject(nz.a)(e,void 0,0)},bz=function(e,t){return a.ModuleContainer.inject(rz.b)(e,void 0,1)},Iz=function(e,t){return a.ModuleContainer.inject(oz)(e,void 0,2)},yz=function(e,t){return a.ModuleContainer.inject(WE.a)(e,void 0,3)},Sz=function(e,t){return a.ModuleContainer.inject(Dy.f)(e,void 0,4)},Cz=Reflect.metadata("design:type",Function),Ez=Reflect.metadata("design:paramtypes",[void 0===nz.a?Object:nz.a,void 0===rz.b?Object:rz.b,void 0===oz?Object:oz,void 0===WE.a?Object:WE.a,void 0===Dy.f?Object:Dy.f]),Oz=Fz(rz.b),Mz=Reflect.metadata("design:type",Function),Tz=Reflect.metadata("design:paramtypes",[]),wz=Fz(rz.b),Rz=Reflect.metadata("design:type",Function),Lz=Reflect.metadata("design:paramtypes",[]),mz(Dz=pz(Dz=fz(Dz=vz(Dz=_z(Dz=bz(Dz=Iz(Dz=yz(Dz=Sz(Dz=Cz(Dz=Ez((Az=class{constructor(e,t,s,a,i){this.OffloadConvsManager=e,this.uiController=t,this.storage=s,this.OnboardingEventsResolver=a,this.EventsResolver=i,this.name=void 0,this.key=void 0,this.timeoutId=void 0,this.offloadAbortController=new AbortController,this.eventHandler=void 0,this.name=iz.b,this.key=iz.b,this.timeoutId=null,this.eventHandler=this.exportImportDBEventHandler.bind(this),_e.default.subscribe(this.eventHandler)}abortOffloadIfPossible(e){this.offloadAbortController.abort(),this.offloadAbortController=new AbortController,this.storage.offloadState.clear(),e&&Object(gz.b)("aborted reason: ",e)}onDispose(){this.abortOffloadIfPossible("onDispose lifecycle"),this.clearTimeoutInAppSession(),_e.default.unsubscribe(this.eventHandler),Nz.a.getInstance().reset()}onAuthenticated(e){this.onLoadingOffload(e)}onLoadingOffload(e){this.storage.load(e.getSession().userId),this.storage.offloadState.clear(),this.addPlanListeners(),this.addKeyListeners(),this.addMigrationListeners(),this.addVerifyQueueListeners(),this.addNetworkListeners()}onApplicationReady(){this.onStartingOffload()}onStartingOffload(){this.onInitZCloudStatus(),this.onTryCheckValidCondition()}onChangeEnableSetting(e){e?this.onEnablOffloadSettingChanged():this.onDisableSettingChanged()}onInitZCloudStatus(){const e=this.uiController.getState().zCloudStatus,t=ue.a.getInstance().checkUpgraded(),s=UE.a.getInstance().isPaidUser();Object(gz.b)("init status:",JSON.stringify(Object(I.a)(Object(I.a)({},e),{},{hasKey:t,isPaid:s}))),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{hasKey:t,isPaid:s}))}addPlanListeners(){this.EventsResolver.addEventListener(Dy.a.UPGRADE_ZCLOUD_PLAN,this.onHandleUpgradePlan.bind(this)),this.EventsResolver.addEventListener(Dy.a.OFF_PERSONAL_CLOUD_PLAN,this.onHandleFreePlan.bind(this)),this.EventsResolver.addEventListener(Dy.a.GRACE_PERIOD_ZCLOUD_PLAN,this.onHandleGracePeriod.bind(this))}addKeyListeners(){ue.a.getInstance().addListener(IE.c.UPDATE_CLOUD_KEY_STATUS,this.onChangeCloudKeyStatus.bind(this))}addMigrationListeners(){this.OnboardingEventsResolver.addEventListener(HE.b.MOBILE_NOT_COMPLETED,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(HE.b.MOBILE_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(HE.b.PC_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(HE.b.MOBILE_JUST_MIGRATE_DONE,this.onMobileMigrated.bind(this))}addVerifyQueueListeners(){ue.a.getInstance().addListener(IE.c.VERIFYING_QUEUE,this.onVerifyingQueue.bind(this)),ue.a.getInstance().addListener(IE.c.SYNC_QUEUE_DONE,this.onQueueVerifiedDone.bind(this))}addNetworkListeners(){J.p.listenEvent(J.k,this.networkHandler.bind(this))}exportImportDBEventHandler(e,t){switch(e){case wl.c.EXPORT_IMPORT_START:this.abortOffloadIfPossible("export-import running");break;case wl.c.EXPORT_IMPORT_FINISHED:this.onTryCheckValidCondition()}}onHandleUpgradePlan(){const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleUpgradePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!0})),this.onTryCheckValidCondition()}onHandleGracePeriod(){this.abortOffloadIfPossible("grace period");const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleGracePeriod",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!1})),Nz.a.getInstance().resetNecessaryStates()}onHandleFreePlan(){this.abortOffloadIfPossible("free plan");const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleFreePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!1})),Nz.a.getInstance().clear()}onHavingMigrateStatus(e){const t=this.uiController.getState().zCloudStatus;switch(e.type){case HE.b.MOBILE_NOT_COMPLETED:this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{isMigrated:!1}));break;case HE.b.MOBILE_COMPLETED_BEFORE:case HE.b.PC_COMPLETED_BEFORE:this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{isMigrated:!0})),this.onTryCheckValidCondition()}}onMobileMigrated(){const e=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isMigrated:!0})),this.onTryCheckValidCondition()}onChangeCloudKeyStatus(e){const t=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{hasKey:e})),e&&this.onTryCheckValidCondition()}onVerifyingQueue(){this.abortOffloadIfPossible("verifying queue")}onQueueVerifiedDone(){this.onTryCheckValidCondition()}networkHandler(e){e===ce.a.DISCONNECT?(Object(gz.b)("network disconnected"),this.abortOffloadIfPossible("network disconnected")):e===ce.a.CONNECTED&&(Object(gz.b)("network reconnected"),this.onTryCheckValidCondition())}onTryCheckValidCondition(){this.checkBeforeOffload()}checkBeforeOffload(){this.shouldStartOffload()&&this.startOffload()}shouldStartOffload(){if(!Nz.a.getInstance().getSetting("enableOffload"))return Object(gz.b)("not start offload because enableOffload is falsy"),!1;if(this.storage.offloadState.isOffloading)return Object(gz.b)("not start offload because there is another offloading process"),!1;if(a.ModuleContainer.resolve(MB.a).isSyncing())return Object(gz.b)("not start offload because zcloud queue is verifying"),!1;const e=Nz.a.getInstance().getSetting("lastOffloadTime");if(!e)return!0;const t=Object(hz.a)().getCycleOptions()[0],s=Date.now()-e;if(s<t){Object(gz.b)("not start offload because of no reach interval time");const e=t-s;this.setTimeoutForNextTimeOffload(e)}return s>=t}setTimeoutForNextTimeOffload(e){this.clearTimeoutInAppSession(),this.timeoutId=setTimeout((()=>{this.onTryCheckValidCondition()}),e)}clearTimeoutInAppSession(){this.timeoutId&&clearTimeout(this.timeoutId)}onEnablOffloadSettingChanged(){this.checkShouldRunRightNow()}checkShouldRunRightNow(){this.shouldRightNowOffload()&&this.startOffload()}shouldRightNowOffload(){return!this.storage.offloadState.isOffloading}onDisableSettingChanged(){Object(hz.a)().getAbortPermission()&&this.abortOffloadIfPossible("user off toggle button")}async startOffload(){this.abortOffloadIfPossible(),this.storage.offloadState.isOffloading=!0;try{Object(gz.b)("start offload time: ",Date.now()),Nz.a.getInstance().onSend(Nz.b.onStart,Date.now());await this.OffloadConvsManager.offload(this.offloadAbortController.signal,this.onConvOffloaded.bind(this));Nz.a.getInstance().onSend(Nz.b.onEnd,Date.now()),Date.now()!==Nz.a.getInstance().getSetting("lastOffloadTime")&&(kz.a.logOffloadCompleted({offload_size:Nz.a.getInstance().getSetting("offloadingConvSize")}),Nz.a.getInstance().updateSetting("lastOffloadSize",Nz.a.getInstance().getSetting("offloadingConvSize")),Nz.a.getInstance().updateSetting("offloadingConvId",null),Nz.a.getInstance().updateSetting("offloadingConvSize",0),Nz.a.getInstance().updateSetting("lastOffloadTime",Date.now()),Nz.a.getInstance().updateSetting("isMarkedAsReadLastestOffloadPopup",!1),Nz.a.getInstance().updateSetting("isClickedZCloudOffloadCompletedTooltipMainAction",!1),Nz.a.getInstance().updateSetting("isClickedZCloudOffloadCompletedTooltipSkipAction",!1),Object(gz.b)("end offload time: ",Date.now())),this.setTimeoutForNextTimeOffload(Object(hz.a)().getCycleOptions()[0])}catch(e){Object(gz.a)("offload error: ",e)}finally{this.storage.offloadState.clear()}}onConvOffloaded(e,t){this.uiController.setOffloadingConv(e)}changeEnableOffload(e){Nz.a.getInstance().updateSetting("enableOffload",e),Nz.a.getInstance().updateSetting("onboardingOffloadCompleted",!0)}},Object(wk.a)(Az.prototype,"onTryCheckValidCondition",[Oz,Mz,Tz],Object.getOwnPropertyDescriptor(Az.prototype,"onTryCheckValidCondition"),Az.prototype),Object(wk.a)(Az.prototype,"onEnablOffloadSettingChanged",[wz,Rz,Lz],Object.getOwnPropertyDescriptor(Az.prototype,"onEnablOffloadSettingChanged"),Az.prototype),Dz=Az))||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz);const jz="zcloud-offload-cloud-media-service",Uz=Object(a.define)(jz);let Bz=function(e){return e[e.PAGE_SIZE=20]="PAGE_SIZE",e}({});const zz={noiseId:"",zDate:Object(hz.a)().getMediaTTL(),offset:0};var Gz;let xz=Object(a.injectable)()(Gz=Reflect.metadata("design:type",Function)(Gz=Reflect.metadata("design:paramtypes",[])(Gz=class{constructor(){this.name=void 0,this.key=void 0,this.name=jz,this.key=jz}async fetchCloudMediaFromOldestToNewestByCOnv(e,t,s){const a=(null==t?void 0:t.zDate)||zz.zDate,i=(null==t?void 0:t.noiseId)||zz.noiseId,n=(null==t?void 0:t.offset)||zz.offset,r=(null==s?void 0:s.limit)||Bz.PAGE_SIZE;try{const t=await ue.a.getInstance().getAllByConversationTypeDate(e,"",a,i,r,O.c.NEXT,n),s=Object(I.a)(Object(I.a)({},t[t.length-1]),{},{offset:n+t.length});return t.length<r?{cloudItems:t,hasMore:!1,lastItem:s}:{cloudItems:t,hasMore:!0,lastItem:s}}catch(o){return{cloudItems:[],hasMore:!1,lastItem:null}}}filterCloudMediaByCreatedTime(e){return e.filter((e=>{const t=e.msgInfo.ts,s=Object(hz.a)().getMediaTTL();return Date.now()-t>s}))}})||Gz)||Gz)||Gz;const Vz="zcloud-offload-conversation-service",Hz=Object(a.define)(Vz);let Wz=function(e){return e[e.ACTIVE_DECREASE=0]="ACTIVE_DECREASE",e[e.ACTIVE_INCREASE=1]="ACTIVE_INCREASE",e}({});var qz,Kz=s("qwfD");let $z=Object(a.injectable)()(qz=function(e,t){return a.ModuleContainer.inject(En.PreviewDataManager)(e,void 0,0)}(qz=Reflect.metadata("design:type",Function)(qz=Reflect.metadata("design:paramtypes",[void 0===En.PreviewDataManager?Object:En.PreviewDataManager])(qz=class{constructor(e){this.PreviewDataManager=e,this.name=void 0,this.key=void 0,this.name=Vz,this.key=Vz}onSortActionTime(e,t){return e.sort(((e,s)=>{var a,i;const n=(null===(a=this.PreviewDataManager.getPreviewByIDSync(e))||void 0===a?void 0:a.messageTime)||0,r=(null===(i=this.PreviewDataManager.getPreviewByIDSync(s))||void 0===i?void 0:i.messageTime)||0;switch(t){case Wz.ACTIVE_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case Wz.ACTIVE_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}async getClientUsageWithRetry(e=5,t=1e3){const s=e=>{const t=null==e?void 0:e.usageByConversation;return!(!Array.isArray(t)||null==t||!t.length)};let a=null,i=t,n=t;for(let r=0;r<e;r++){if(a=await Kz.a.getInstance().usage(!1),s(a))return a;await new Promise((e=>setTimeout(e,n)));const e=i+n;i=n,n=e}return Object(gz.b)(`get client usage failed after retry ${e} times`),a}async getConversationList(){const e=await this.getClientUsageWithRetry(),t=null==e?void 0:e.usageByConversation;return t?Object.keys(t):[]}async getConvIdsByActiveAscending(){const e=await this.getConversationList();if(!e||!e.length)return[];return this.onSortActionTime(e,Wz.ACTIVE_INCREASE)}})||qz)||qz)||qz)||qz;const Zz="zcloud-offload-media-message-service",Qz=Object(a.define)(Zz);var Yz=s("C64z");async function Jz(e,t=10){const s=[],a=new Set;for(const i of e)s.push(i),a.add(i),i.then((()=>a.delete(i))),a.size>=t&&await Promise.race(a);return Promise.allSettled(s)}var Xz;const eG=s("IJ+6").FileRes;let tG=Object(a.injectable)()(Xz=Reflect.metadata("design:type",Function)(Xz=Reflect.metadata("design:paramtypes",[])(Xz=class{constructor(){this.name=void 0,this.key=void 0,this.getMessagesByCloudQuery=async(e,t)=>{try{return await yv.a.messageDBHandler.getMessagesByCliIdsOwnerIds(e,t)}catch(s){return Object(gz.a)("mapping messages error: ",s),null}},this.name=Zz,this.key=Zz}getCloudItemGroupByMsgType(e){let t={files:[],images:[],videos:[],voices:[],folders:[]};return e.forEach((e=>{switch(ui.default.normalizeMessageType(e.msgInfo.msgType)){case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:case Y.MSG_DOODLE:t.images.push(e);break;case Y.MSG_VIDEO:t.videos.push(e);break;case Y.MSG_FILE:t.files.push(e);break;case Y.MSG_VOICE:t.voices.push(e)}})),t}async isAllMsgRefsValid(e){try{const t=[];e.forEach((e=>{t.push(yv.a.messageDBHandler.getMessageByMsgId(e.msgId,e.convId))}));const s=(await Promise.allSettled(t)).flatMap((e=>"fulfilled"===e.status?e.value:[])),a=await _E.a.getInstance().getCloudItems(s);return a.every((e=>{if(!e)return Object(gz.b)("ref invalid because item is not clouded"),!1;const t=Date.now()-e.msgInfo.ts>Object(hz.a)().getMediaTTL();return t||Object(gz.b)("ref invalid because of not valid time",e.noiseId,e.msgInfo.ts),t}))}catch(t){return Object(gz.a)("error in check all refs valid: ",t),!1}}async checkValidRefForOffload(e){try{var t;if(null==eG||!eG.cache||null===(t=eG.cache)||void 0===t||!t.getRefsByMessage)return!1;const s=await eG.cache.getRefsByMessage(e);return!(s&&Array.isArray(s)&&s.length>=2)||await this.isAllMsgRefsValid(s)}catch(s){return Object(gz.a)("error check valid refs: ",s),!1}}async getValidTag(e){return{valid:await this.checkValidRefForOffload(e),item:e}}async filterValidFiles(e){const t=[],s=[];e.forEach((e=>{const t=this.getValidTag(e);s.push(t)}));return(await Jz(s)).forEach((e=>{"fulfilled"===e.status&&e.value.valid&&t.push(e.value.item)})),t}async getMediaMessageGroupsByCloudMediaItems(e,t){const{files:s,images:a,videos:i,voices:n}=this.getCloudItemGroupByMsgType(e),r=Object(gB.b)(a),o=await this.getMessagesByCloudQuery(r,t),l=Object(gB.b)(i),c=await this.getMessagesByCloudQuery(l,t),d=Object(gB.b)(s),u=await this.getMessagesByCloudQuery(d,t),h=Object(gB.b)(n),g=await this.getMessagesByCloudQuery(h,t),m={files:[],images:[],videos:[],voices:[],folders:[]};return Array.isArray(o)&&(m.images=o),Array.isArray(c)&&(m.videos=c),Array.isArray(g)&&(m.voices=g),Array.isArray(u)&&u.forEach((e=>{var t,s;(null===(t=Object(Yz.j)(null==e||null===(s=e.message)||void 0===s?void 0:s.params))||void 0===t?void 0:t.fType)===Ju.a.Ftype.Folder?m.folders.push(e):m.files.push(e)})),m.files=await this.filterValidFiles(m.files),m}})||Xz)||Xz)||Xz;const sG="zcloud-offload-delete-local-media-service",aG=Object(a.define)(sG),iG=Object(a.define)("zcloud-offload-local-media-cleaner");let nG,rG;rG=$znode.path,nG=s("Dprd").default;class oG extends FU.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}async clean(e){Object(gz.b)("call clean",e);let t=0;const{data:s}=e,{convId:i,files:n=[],images:r=[],videos:o=[],voices:l=[],folders:c=[]}=s,d=[];n.length>0&&d.push(a.ModuleContainer.resolve(aG).deleteFiles(n,i)),r.length>0&&d.push(a.ModuleContainer.resolve(aG).deletePhotos(r,i)),o.length>0&&d.push(a.ModuleContainer.resolve(aG).deleteVideos(o,i)),l.length>0&&d.push(a.ModuleContainer.resolve(aG).deleteVoices(l,i)),c.length>0&&d.push(a.ModuleContainer.resolve(aG).deleteFolders(c,i));try{Object(gz.b)("cleaning...",{files:n,images:r,videos:o,voices:l,folders:c});return(await Promise.allSettled(d)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),Object(gz.b)("cleaning success",t),t}catch(u){return Object(gz.a)("clean failed",u),0}}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:a,reject:i}=t;try{a(await this.clean(s))}catch(e){i(e)}await new Promise((e=>setTimeout(e,Object(hz.a)().getDelayTimeBetweenCleanTask()))),this.numberOfRunningTasks--,this.run()}}}const lG=[],cG=new FU.b(lG),dG=new oG(lG),uG=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async clean(e){const{data:t}=e,s=new Promise(((e,s)=>{const a={data:{data:t},resolve:e,reject:s};this.provider.send(a),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(cG,dG);a.ModuleContainer.registerValue(iG,uG);var hG=uG;const gG="zcloud-offload-scan-local-media-service",mG=Object(a.define)(gG),pG=Object(a.define)("zcloud-offload-local-media-cleaner");let fG,vG;vG=$znode.path,fG=s("Dprd").default;class _G extends FU.a{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.zCloud,["zcloud-offload"])),this._Logger}constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this._Logger=void 0,this.queue=e,this.numberOfRunningTasks=0}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:i,reject:n}=t;try{const{files:e,images:t,videos:n,voices:r,folders:o}=s.data;let l=0;t&&(l+=await a.ModuleContainer.resolve(mG).calculatePhotoSize(t)),n&&(l+=await a.ModuleContainer.resolve(mG).calculateVideoSize(n)),e&&(l+=await a.ModuleContainer.resolve(mG).calculateFileSize(e)),r&&(l+=await a.ModuleContainer.resolve(mG).calculateVoiceSize(r)),o&&(l+=await a.ModuleContainer.resolve(mG).calculateFolderSize(o)),i(l)}catch(e){n(e)}await new Promise((e=>setTimeout(e,200))),this.numberOfRunningTasks--,this.run()}}}const bG=[],IG=new FU.b(bG),yG=new _G(bG),SG=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async scan(e){const{data:t}=e,s=new Promise(((e,s)=>{const a={data:{data:t},resolve:e,reject:s};this.provider.send(a),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(IG,yG);a.ModuleContainer.registerValue(pG,SG);var CG=SG;var EG;let OG=Object(a.injectable)()(EG=function(e,t){return a.ModuleContainer.inject(Hz)(e,void 0,0)}(EG=function(e,t){return a.ModuleContainer.inject(Uz)(e,void 0,1)}(EG=function(e,t){return a.ModuleContainer.inject(Qz)(e,void 0,2)}(EG=Reflect.metadata("design:type",Function)(EG=Reflect.metadata("design:paramtypes",[void 0===Hz?Object:Hz,void 0===Uz?Object:Uz,void 0===Qz?Object:Qz])(EG=class{constructor(e,t,s){this.ConversationService=e,this.CloudMediaService=t,this.MediaMessageService=s,this.name=void 0,this.key=void 0,this.name=nz.b,this.key=nz.b}get zCloudOffloadUIController(){return a.ModuleContainer.resolve(rz.b)}async offloadByConvId(e,t){let s=0,a=!0,i=null;const n=Object(hz.a)().getDelayTimeBetweenConvQuery();let r=0;for(;a;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const l=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,i,{limit:Object(hz.a)().getConvQueryLimit()}),t]);a=l.hasMore,i=l.lastItem;const c=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(l.cloudItems),e);let d;d=e.startsWith(Y.GROUPID_PREFIX)?hn.default.getDName(e):Ii.default.getDName(e),Object(gz.b)("start clean convId",e,"displayName",d);s+=await hG.clean({data:Object(I.a)(Object(I.a)({},c),{},{convId:e})})}return s}async scanOffloadByConvId(e,t){let s=0,a=!0,i=null;const n=Object(hz.a)().getDelayTimeBetweenConvQuery();let r=0;for(;a;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const l=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,i,{limit:Object(hz.a)().getConvQueryLimit()}),t]);a=l.hasMore,i=l.lastItem;const c=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(l.cloudItems),e);s+=await CG.scan({data:Object(I.a)(Object(I.a)({},c),{},{convId:e})})}return s}async offload(e,t){const s=new Promise(((t,s)=>{const a=()=>{i(),s(new Error("abort offload!"))},i=()=>{e.removeEventListener("abort",a)};e.addEventListener("abort",a)})),a=await this.ConversationService.getConvIdsByActiveAscending();Object(gz.b)("list offload convId: ",a),this.zCloudOffloadUIController.setOffloadConvNum(0),this.zCloudOffloadUIController.setTotalOffloadConvNum(a.length),this.zCloudOffloadUIController.setInProgressOffloadSize(0);let i=0;const n=Nz.a.getInstance().getSetting("offloadingConvId"),r="string"==typeof n?a.findIndex((e=>e===n)):0,o=-1!==r?r:0,l=Nz.a.getInstance().getSetting("offloadingConvSize");l&&"number"==typeof l&&(i=l);for(let c=o;c<a.length;c++){Nz.a.getInstance().updateSetting("offloadingConvId",a[c]);const e=await this.offloadByConvId(a[c],s);i+=e,t(a[c],i),Object(gz.b)("done offload conv: ",a[c],e),this.zCloudOffloadUIController.setOffloadConvNum(c+1),this.zCloudOffloadUIController.setInProgressOffloadSize(i)}return i}async testScanOffload(e){const t=new Promise(((t,s)=>{const a=()=>{i(),s(new Error("abort offload!"))},i=()=>{e.removeEventListener("abort",a)};e.addEventListener("abort",a)}));let s=await this.ConversationService.getConvIdsByActiveAscending();const a=s.length;this.zCloudOffloadUIController.setTotalOffloadConvNum(a);let i=0;for(let n=0;n<a;n++){const e=await this.scanOffloadByConvId(s[n],t);this.zCloudOffloadUIController.setNewEstimatedSizeConv(s[n],e),i+=e}return i}})||EG)||EG)||EG)||EG)||EG)||EG;var MG,TG=s("KQkt"),wG=s("bUHp");const RG=$znode.path,LG=s("Dprd").default;let DG=Object(a.injectable)()(MG=Reflect.metadata("design:type",Function)(MG=Reflect.metadata("design:paramtypes",[])(MG=class{constructor(){this.name=void 0,this.key=void 0,this.name=sG,this.key=sG}isLikeFolderPath(e){return!!RG&&e.endsWith(null==RG?void 0:RG.join("~",RG.sep))}accumulateSize(e){if(!e||"number"!=typeof e)return;const t=Nz.a.getInstance().getSetting("offloadingConvSize")||0;if("number"==typeof t){const s=t+e;Object(gz.b)("accumulateSize",s,t,e),Nz.a.getInstance().updateSetting("offloadingConvSize",s)}}async deletePhoto(e,t){try{const s=await LG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deletePhoto item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deletePhoto item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deletePhotos(e,t){try{let t=0;const s=J.p.getSessionUserId(),a=[];for(const i of e){const e=TG.a.getPathsByMessageIfExistSync(s,i);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deletePhoto(e.path,i);a.push(t)}))}return(await Jz(a)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),Object(gz.b)("deletePhotos totalSize: ",t),t}catch(s){return Object(gz.a)("deletePhotos error",s),0}}async deleteVideo(e,t){try{const s=await LG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteVideo item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteVideo item error : ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVideos(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=TG.a.getPathsByMessageIfExistSync(a,s).filter((e=>e.type===wG.a.Video));Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteVideo(e.path,s);t.push(a)}))}return(await Jz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteVideos totalSize: ",s),s}catch(i){return Object(gz.a)("deleteVideos error",i),0}}async deleteFile(e,t){try{const s=await LG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteFile item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteFile item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteFiles(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=TG.a.getPathsByMessageIfExistSync(a,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteFile(e.path,s);t.push(a)}))}return(await Jz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteFiles totalSize: ",s),s}catch(i){return Object(gz.a)("deleteFiles error",i),0}}async deleteVoice(e,t){try{const s=await LG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteVoice item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteVoice item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVoices(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=TG.a.getPathsByMessageIfExistSync(a,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteVoice(e.path,s);t.push(a)}))}return(await Jz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteVoices totalSize: ",s),s}catch(i){return Object(gz.a)("deleteVoices error",i),0}}async deleteFolder(e,t){const s=this.isLikeFolderPath(e);try{let a=0;if(!s){const t=await LG.isFile(e);a=(null==t?void 0:t.size)||0}return await LG.deleteFolder(e),Object(gz.b)("deleteFolder item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),{size:a,isLikeFolder:s}}catch(a){return Object(gz.a)("deleteFolder item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,a),{size:0,isLikeFolder:s}}}async deleteFolders(e,t){try{let t=0;const s=J.p.getSessionUserId(),a=[];for(const i of e){const e=TG.a.getPathsByMessageIfExistSync(s,i);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deleteFolder(e.path,i);a.push(t)}))}return(await Jz(a)).forEach((e=>{"fulfilled"!==e.status||e.value.isLikeFolder||(t+=2*e.value.size)})),Object(gz.b)("deleteFolders totalSize: ",t),t}catch(s){return Object(gz.a)("deleteFolders error",s),0}}})||MG)||MG)||MG;var AG;const FG=new(s("VIVm").a)({concurrency:400,interval:1e3});let kG,NG;NG=$znode.path,kG=s("Dprd").default;let PG=Object(a.injectable)()(AG=Reflect.metadata("design:type",Function)(AG=Reflect.metadata("design:paramtypes",[])(AG=class{constructor(){this.name=void 0,this.key=void 0,this.name=gG,this.key=gG}async calculatePhotoSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=TG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=FG.throttle(kG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateVideoSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=TG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=FG.throttle(kG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFileSize(e){const t=J.p.getSessionUserId();let s=0;for(const i of e){const e=TG.a.getPathsByMessageIfExistSync(t,i);for(const t of e)try{if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=FG.throttle(kG.isFile);s+=(await e(t.path,!1)).size}}catch(a){}}return s}async calculateVoiceSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=TG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=FG.throttle(kG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFolderSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=TG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=FG.throttle(kG.isFile);s+=(await e(t.path,!1)).size}}}return s}})||AG)||AG)||AG;a.ModuleContainer.registerSingleton(iz.a,Pz),a.ModuleContainer.registerSingleton(Uz,xz),a.ModuleContainer.registerSingleton(Hz,$z),a.ModuleContainer.registerSingleton(Qz,tG),a.ModuleContainer.registerSingleton(nz.a,OG),a.ModuleContainer.registerSingleton(aG,DG),a.ModuleContainer.registerSingleton(mG,PG);var jG=s("GNMY"),UG=s("sGG0");var BG,zG=s("72EQ"),GG=s("v+vz"),xG=s("F1+M"),VG=s("XbxG"),HG=s("U/XY");function WG(){if(!Ce.default.profile.cover.randomUrls.length)return"";const{randomUrls:e}=Ce.default.profile.cover;return e[Math.floor(Math.random()*e.length)]}Object(m.h)()(BG=Object(Ai.b)(jG.a)(BG=Reflect.metadata("design:type",Function)(BG=Reflect.metadata("design:paramtypes",[])(BG=class{constructor(){this.name=jG.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._randomCoverSrc=WG(),this._logger=void 0,this.type=void 0,this.data=new Map}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(this.name,["personal-controller"])),this._logger}init(e){this.didInit||(this._fetchReceiveFriendList(),a.ModuleContainer.resolve(If.o).addEventListener(If.n.ReceiveAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(If.o).addEventListener(If.n.UndoAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(If.o).addEventListener(If.n.AcceptAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(If.o).addEventListener(If.n.RejectAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(If.o).addEventListener(If.n.UndoSentRequestFriendEvent,this.invitationEventHandler.bind(this)),this.didInit=!0)}onDispose(){XO.a.getInstance().removeAll()}bindDispatch(e){this._dispatch=e,_e.default.subscribe(this.eventHandler.bind(this)),this._randomCoverSrc=WG()}unbind(){this._dispatch=null,this._genMessageServer=null,this.data.clear(),_e.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"9_tgKg","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}clearState(e){this.data.has(e)&&this.data.delete(e)}_signalUpdate(e){Object(Po.h)(jG.b,e)}_updateData(e,t,s){const a=this.data.get(e);a?this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{[t]:a&&a[t]?ui.default.deepMerge(a[t],s):s})):this.data.set(e,{[t]:s,version:0}),this._signalUpdate(e)}_udapteInfoData(e,t,s=!0){var a;const i=this.data.get(e);return s&&null!=i&&null!==(a=i.info)&&void 0!==a&&a.avatar&&(t.avatar=i.info.avatar),this._updateData(e,"info",t)}_updateVersion(e){const t=this.data.get(e);t?this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{version:t.version+1})):this.data.set(e,{version:0}),this._signalUpdate(e)}getCover(e){var t;const s=null===(t=this.data.get(e))||void 0===t?void 0:t.info;if(s){const e=s.cover;return e&&e==Ce.default.profile.cover.defaultUrl?this._randomCoverSrc||Ce.default.profile.cover.defaultUrl:e}return this._randomCoverSrc||Ce.default.profile.cover.defaultUrl}async getUserInfo(e,t=!1){const s=Object(I.a)({},Ii.default.getProfileFriendByIdSync(e));this._udapteInfoData(e,s);const a=async()=>{try{const t=await Ii.default.getProfileFriendById(e,Y.SRC_GET_PROFILE.FORCE_GET);return Ii.default.isFriend(e)||this.getStatusFriendRequest(e),t&&(GG.y(e)&&_e.default.send(ve.FetchActions.UDPATE_BUSINESS_INFO,{user:t}),this._udapteInfoData(e,t,!1)),this.getFullAvatar(e),t}catch(t){return this.Logger.zsymb(0,"oOQhz3","[getUserInfo]",t),Ii.default.getProfileFriendByIdSync(e)}};return t||!this.data.has(e)||!s||Object.keys(s).length<=4?a():s}async getExtraInfo(e){try{const t=await ng.a.getProfileExtra(e,Ii.default.getUidMe());if(t){(e=>{if(e.bkPhotos&&e.photos&&e.photos.length)for(let t=0;t<e.photos.length;t++){const s=e.photos[t],a=e.bkPhotos[t];XO.a.getInstance().setBackup(s,a)}})(t);const s=(e=>{const t=e.photos?e.photos.map(((t,s)=>({url:t,meta:e.photoMetas&&e.photoMetas[s]}))):[];let s=[];return e.groupIds&&e.groupIds.length>0&&e.groupIds.forEach((e=>{un.a.checkHiddenChatByPureGroupId(e)||s.push(e)})),{mutualGroups:s,photos:t}})(t);return this._updateData(e,"extra",s),!0===t.fetched&&this.dispatch({type:ve.ConversationListActions.FORCE_UPDATE_MUTUAL_GROUP_ITEM,payload:e}),s}}catch(s){var t;this.Logger.zsymb(0,"ehichJ","[getExtraInfo]",s),this._updateData(e,"extra",(null===(t=this.data.get(e))||void 0===t?void 0:t.extra)||{})}return null}async getFullAvatar(e,t=!1){const s=(t,s)=>{XO.a.getInstance().setBackup(t,s),this._updateData(e,"info",{fullAvatar:t})},a=async()=>{try{const t=await GG.k(e);t&&s(t.full_avatar,t.bk_full_avatar)}catch(t){if(this.Logger.zsymb(18,"z5a__Y","fetch full avatar error:",t),i){if(ui.default.isWeb()){let e=i.url;return e&&s(e),e}{let e=i.path;if(await Object(zG.a)(e))return s("file://"+e),"file://"+e}}}};let i=we.default.getProfileAvatar(e);if(t||!i)return a();{let e=i.ts;if(Date.now()-3e5>e)return a();if(ui.default.isWeb()){let e=i.url;return s(e),e}{let e=i.path;Object(zG.a)(e).then((t=>t?(s("file://"+e),"file://"+e):a()))}}}async getProfileRank(e){try{const t=await ng.a.getProfileRank(e,Ii.default.getUidMe());return this._updateData(e,"rank",t),t}catch(s){var t;this.Logger.zsymb(0,"4OnOtr","[getProfileRank]",s),this._updateData(e,"rank",(null===(t=this.data.get(e))||void 0===t?void 0:t.rank)||{})}return null}async getStatusFriendRequest(e){const t=async()=>{try{await ye.a.getStatusFriendRequest(e,!1)}catch(t){}};let s=J.p.getFriendRequestStatus(e);if(s){let e=s.ts;e&&e>-1&&e<Date.now()-2e3&&t()}else t()}async _fetchReceiveFriendList(e=!1){let t=rg.a.getRecommendedFriendsSync();if(!Object.keys(t).length||e)try{t=await rg.a.getRecommendedFriendsV2(!0,!0)}catch(a){this.Logger.zsymb(0,"7VOjrl","_fetchReceiveFriendList [ERROR]",t)}const s=Object.keys(t);s.length&&s.forEach((e=>{var s,a,i;(null===(s=t[e])||void 0===s||null===(a=s.dataInfo)||void 0===a?void 0:a.recommType)===Ff.RECEIVE&&(this._cachedFriendRequest[e]=null===(i=t[e])||void 0===i?void 0:i.dataInfo)}))}getRequestInfo(e){return this._cachedFriendRequest[e]}async toggleBlock(e,t){var s;const a=this.data.get(e),i=(null==a||null===(s=a.info)||void 0===s?void 0:s.isBlocked)||Ii.default.isBlocked(e);Ia.default.logAction(1460207);try{const s=await Ii.default.blockFriend(e,i?Y.UNSET_BLOCK:Y.SET_BLOCK);return HG.c(t,i?"STR_UNBLOCK_USER_TOAST_SUCCESS":"STR_BLOCK_USER_TOAST_SUCCESS"),a&&this._updateData(e,"info",{isBlocked:!i}),i||Ia.default.logAction(146020701),this.dispatch({type:ve.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!i,userId:e}}),s}catch(n){this.Logger.zsymb(18,"ubIwA2","toggleBlock",n),HG.c(t,i?"STR_UNBLOCK_USER_TOAST_FAIL":"STR_BLOCK_USER_TOAST_FAIL")}}async toggleRemoveFriend(e,t){Ia.default.logAction(1460206);try{const s=await GG.C(e);return we.default.removeNewFriend(e),we.default.removeFriend(e).then((t=>{_e.default.send(ve.PopupActions.TOGGLE_REMOVE_FRIEND,e)})),this.dispatch({type:ve.FetchActions.FRIENDS_REMOVED,payload:e}),HG.c(t,"STR_DELETE_SUCCESS"),s}catch(s){this.Logger.zsymb(18,"mgdI21","toggleRemoveFriend",s)}}async toggleShareContact(e,t){const s=this.data.get(e),a=await Object(xG.c)([e]);Ia.default.logAction(1460205);let i="",n="";s&&s.info&&(i=s.info.avatar,n=s.info.displayName);let r={message:{action:"recommened.user",description:JSON.stringify({qrCodeUrl:a[e]}),params:e,thumb:i,title:n},msgType:Y.MSG_CONTACT,windowId:t};_e.default.send(ve.PopupActions.SHARE_MSG,r)}showImage(e,t,s=XE.l.ProfileAvatar){var a;let i=null===(a=this.data.get(e))||void 0===a?void 0:a.info;if(!i)return;const n={user:Ii.default.getProfileMeSync(),userId:e,conversation:Object(I.a)({},i),isVideo:!1,selectedId:null,isProfileImg:!0,href:t,appConfig:Object(Ce.getPVConfigs)(),source:s};ui.default.isWeb()||(n.appConfig={enable_feature_alias:Ce.default.enable_feature_alias,enable_stranger_alias:Ce.default.enable_stranger_alias}),me.a.OpenPhoto.openPhotoViewer(n)}voiceCall(e,t){const s=this.data.get(e);if(Ia.default.logAction(10643),Ia.default.logActionInfo(Ia.FeaturesInfo.BusinessAccount,1460203,[e,Ii.default.isFriend(e)?0:1]),!Kl.d.isSupport()||null==s||!s.info)return;if(Kl.d.isCalling())return void HG.b(t,void 0,le.a.trans(Kl.c.IN_CALL));const a=s.info;var i;ui.default.isWeb()||(i=e,we.default.getConversation(i)).then((t=>{let s={lastSmsLocalId:t?t.lastSmsLocalId:null,displayName:a.displayName,userId:e},i=[s.userId];Kl.d.makeCall(i,!1,!1,(e=>{this._genMessageServer&&this._genMessageServer(s,e),e.caller&&e.duration>0&&VG.b.updateLastActionTime(s.userId,this.dispatch,-1,VG.a.CALL)}))}))}jumpToConversation(e){let t=this.data.get(e);if(!t||!t.info)return;a.ModuleContainer.resolve(Q.b).openConversation(e,Q.d.fromProfileInfo(t.info));const s=Ii.default.isFriend(e);Ia.default.logActionInfo(Ia.FeaturesInfo.BusinessAccount,1460204,[e,s?1:0]),Ie.ModalManagerV2.closeAllModal()}async undoFriendRequest(e){Ia.default.logAction(146020802);try{return await ye.a.undoRequestAddFriend(e),a.ModuleContainer.resolve(If.o).dispatchEvent(new If.p(If.n.UndoSentRequestFriendEvent,null,e)),this.getUserInfo(e),!0}catch(t){t&&t.error_message&&HG.a(t.error_message)}return!1}async addFriend(e,t){const s=this.data.get(e);return!(!s||!s.info||s.info.isBlocked)&&(ye.a.isYouRequestMe(e)?(Ia.default.logAction(146020801),a.ModuleContainer.resolve(ag.b).acceptFriendRequest(e,t),we.default.getAcceptNewFriend(s)):Ia.default.logAction(1460208),!0)}async sendFriendRequest(e,t,s,a){const i=ye.a.getFriendRequestSource(e);try{await ye.a.requestAddFriend(e,s,i),this.dispatch({type:ve.ChatBoxActions.SEND_FRIEND_REQUEST,payload:e}),_e.default.send(ve.SideBarActions.SENT_FRIEND_REQUEST,e),HG.c(t,"STR_REQ_FR_SUCCESS"),we.default.setStrangerCache(e,1),UG.a.callUpdate(e,a)}catch(n){this.Logger.zsymb(18,"8LoSpS","sendFriendRequest",n),n&&n.error_message&&HG.a(t,n.error_message),we.default.setStrangerCache(e,0)}}openLink(e){bR.b.open(e)}eventHandler(e,t){switch(e){case ve.FetchActions.STATUS_BLOCKED_CHANGED:if(t){this.data.has(t)&&this._updateData(t,"info",{isBlocked:Ii.default.isBlocked(t)})}break;case ve.FetchActions.UPDATE_NAME:if(t)if(t.constructor===Object){this.data.has(t.userId)&&this.getUserInfo(t.userId)}else if(t.constructor===Array)for(const[e,s]of Object.entries(this.data)){t.includes(e)&&this.getUserInfo(e)}break;case ve.FetchActions.USERID_FETCHED:case ve.FetchActions.PROFILE_ME_FETCHED:{const e=Ii.default.getUidMe();t&&this._udapteInfoData(e,Object(I.a)(Object(I.a)({},t),{},{isBlocked:!1,isFr:!0}),!this.data.has(t.userId)),this.data.has(t.userId)&&this.getFullAvatar(t.userId,!0);break}case ve.FetchActions.FRIEND_REQUEST_UPDATE:t&&this.data.has(t.userId)&&this._updateVersion(t.userId);break;case ve.ConversationListActions.BLOCK_CONVERSATION:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{isBlocked:t.blocked});break;case ve.FriendListActions.UPDATE_EXTRA_PROFILE_CACHE:t&&t.userId&&this.data.has(t.userId)&&this.getExtraInfo(t.userId);break;case ve.GeneralActions.NETWORK_STATUS_CHANGED:break;case ve.FriendsAction.FRIENDS_CHANGE_INFO:if(t)for(const e of t)this.data.has(e.userId)&&this.getUserInfo(e.userId)}}invitationEventHandler(e){switch(e.type){case If.n.ReceiveAddFriendEvent:Array.isArray(e.payload)&&e.payload.forEach((e=>{const t=e.dataInfo.userId;e&&e.dataInfo&&(this._cachedFriendRequest[t]=e.dataInfo,this.data.has(t)&&this._updateVersion(t))}));break;case If.n.UndoAddFriendEvent:case If.n.AcceptAddFriendEvent:case If.n.RejectAddFriendEvent:case If.n.UndoSentRequestFriendEvent:this._cachedFriendRequest[e.payload]&&(delete this._cachedFriendRequest[e.payload],this.data.has(e.payload)&&this._updateVersion(e.payload))}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||BG)||BG)||BG);var qG,KG=s("786D");Object(Ai.b)(KG.a)(qG=Reflect.metadata("design:type",Function)(qG=Reflect.metadata("design:paramtypes",[])(qG=class{constructor(){this.name=KG.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._connectClose=[],this._logger=void 0,this.type=void 0,this.data=new Map,this.eventHandler=this.eventHandler.bind(this)}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(this.name,["group-controller"])),this._logger}init(e){this.didInit||(this.didInit=!0)}clearState(e){this.data.has(e)&&this.data.delete(e)}bindDispatch(e){this._dispatch=e,_e.default.subscribe(this.eventHandler)}unbind(){this._dispatch=null,this._genMessageServer=null,this._connectClose=[],this.data.clear(),_e.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"wXZQQ0","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}connectCloseModalCallback(e){this._connectClose.push(e)}_updateData(e,t,s){const a=this.data.get(e);a?this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{[t]:a&&a[t]?ui.default.deepMerge(a[t],s):s})):this.data.set(e,{[t]:s}),Object(Po.h)(KG.b,e)}_udapteInfoData(e,t){var s;const a=this.data.get(e);return null!=a&&null!==(s=a.info)&&void 0!==s&&s.avatar&&(t.avatar=a.info.avatar),this._updateData(e,"info",t)}async getGroupInfo(e){const t=async()=>{try{const t=await hn.default.getFullInfoGroupById(e,Y.SRC_GET_PROFILE.FORCE_GET);return t&&this._udapteInfoData(e,t),t}catch(t){return this.Logger.zsymb(0,"RAqXJ5","[getGroupInfo]",t),hn.default.getGroupByIdSync(e,void 0)}},s=hn.default.getGroupByIdSync(e,void 0);return this.data.has(e)?(this._udapteInfoData(e,s),s):(this._udapteInfoData(e,s),await t())}selectConversation(e){const t=this.data.get(e);if(t){Ia.default.logAction(1460204),this.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:t}),ng.a.openConversation(e);const s=J.p.getSelectConversationSource();s&&Ia.default.logAction(s)}Ie.ModalManagerV2.closeAllModal()}async addGroupAdmin(e,t,s){try{return await hn.default.addGroupAdmin(t,s),!0}catch(a){if(this.Logger.zsymb(18,"agmV03","[addGroupAdmin] error",a),!a)return;if(a.error_code){let s="";switch(a.error_code){case 161:s=le.a.str(Vf.a.get("STR_GROUP_NO_EXIST",t));break;case 166:s=le.a.str(Vf.a.get("STR_GROUP_NO_PERMISION",t));break;default:s=le.a.str(Vf.a.get("STR_ADD_ADMIN_TOAST_UNSUCCESS",t))+" ("+a.error_code+")"}HG.a(e,void 0,s)}else a.code&&"ERR_NO_NETWORK"===a.code&&HG.a(e,"STR_CONNECTION_ERROR")}return!1}async changeGroupOwner(e,t,s,a=!1){var i;let n=!1;const r=(null===(i=hn.default.getGroupByIdSync(t))||void 0===i?void 0:i.topMember)||[];for(const c of r)if(c.id===s){n=!0;break}if(!n)return void HG.b(le.a.trans(Vf.a.get("STR_NO_LONGER_MEMBER_IN_GROUP",t),GG.h(s)));let o=t;o&&o.startsWith(Y.GROUPID_PREFIX)&&(o=o.slice(1));try{return await Cl.default.changeGroupOwner(o,s),this._updateData(t,"info",{creatorId:s}),this.dispatch({type:ve.ConversationListActions.UPDATE_GROUP_OWNER,payload:{userId:t,creatorId:s}}),a&&await this.leaveGroup(e,o),!0}catch(l){return HG.a(e,Vf.a.get("STR_CHANGE_GROUP_OWNER_FAIL",t)),!1}}async leaveGroup(e,t){try{await Cl.default.leaveGroup(t),a.ModuleContainer.resolve($i.b).removeConvToList(t)}catch(s){s&&"ERR_NO_NETWORK"==s.code&&HG.a(e,"STR_CHECK_NET")}}eventHandler(e,t){switch(e){case ve.FetchActions.UPDATE_NAME:t.constructor===Object&&this.data.has(t.userId)?this.getGroupInfo(t.userId):t.constructor===Array&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case ve.FetchActions.GROUP_UPDATED:if(t){let{topMember:e=[],userId:a,isGroup:i}=t;const n=this.data.get(a);if(n&&i){var s;let t=null===(s=n.info)||void 0===s?void 0:s.topMember;(null==e?void 0:e.length)>0&&(t=e),this._updateData(a,"info",{topMember:t}),this.getGroupInfo(a)}}break;case ve.FetchActions.UPDATE_GROUP_SETTING:if(t&&t.data){let e=t.data.groupId;if(e&&(e=Y.GROUPID_PREFIX+e,this.data.has(e))){var a,i;const s=t.data.groupSetting||(null===(a=this.data.get(e))||void 0===a||null===(i=a.info)||void 0===i?void 0:i.setting);this._updateData(e,"info",{newSetting:s})}}break;case ve.GroupsAction.GROUPS_CHANGE_INFO:t&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case ve.FetchActions.DELETE_CONVERSATION:case ve.FetchActions.GROUP_LEAVE:this.data.has(t)&&this._connectClose.forEach((e=>e()));break;case ve.ConversationListActions.UPDATE_GROUP_OWNER:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{creatorId:t.creatorId})}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||qG)||qG);var $G;Object(m.j)()($G=Object(m.h)()($G=Object(Ai.b)(wO.ProfileVerificationController)($G=Reflect.metadata("design:type",Function)($G=Reflect.metadata("design:paramtypes",[])($G=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.handleProfileVerificationChange=e=>{e===uO.b.VERIFIED&&this.onFinishVerification()},this.name=wO.PROFILE_VERIFICATION_CONTROLLER,this.key=wO.PROFILE_VERIFICATION_CONTROLLER,this.data=new Map}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.profile,[this.name])),this.logger}get userId(){return J.p.getSessionUserId()}init(){}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"RW6Gsp","Get data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"M_QMjq","Get data list failed",e)}onStart(){Ii.default.subscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){Ii.default.unsubscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}signalUpdateItem(e){Object(Po.h)(this.name,e)}requestUnblockStage(e,t){t>0&&e.step.isBlocking&&setTimeout((()=>{const t=Object(I.a)({},e);t.step.isBlocking=!1,this.data.set(t.key,t),this.signalUpdateItem(t.key)}),t)}createVerificationStage(e,t){return{key:this.userId,step:{stage:t,blockingTs:Ct.default.getTimeNow()+e,isBlocking:e>0}}}async sendOAVerificationMessage(e,t){let s=this.data.get(this.userId);try{await Ii.default.pushVerificationMessage(t,e),s=this.createVerificationStage(0,"sent")}catch(i){var a;this.Logger.zsymb(18,"OoIWs2","send oa verify fail",i);const e=null==i?void 0:i.error_code,t=(null==i||null===(a=i.data)||void 0===a?void 0:a.next_action_allowed_at)||0;let n,r=0;switch(e){case uO.c.UNAVAILABLE:r=Math.max(t-Ct.default.getTimeNow(),0),n="unavailable";break;case uO.c.FAILED:r=Math.max(t-Ct.default.getTimeNow(),0),n="failure";break;default:r=Ce.default.profile.verification.send_oa_delay,n="failure"}s=this.createVerificationStage(r,n),this.requestUnblockStage(s,r)}this.data.set(this.userId,s),this.signalUpdateItem(this.userId)}onFinishVerification(){this.data.delete(this.userId)}})||$G)||$G)||$G)||$G);var ZG;s("Ppsz");Object(Ai.b)(qS.d)(ZG=Reflect.metadata("design:type",Function)(ZG=Reflect.metadata("design:paramtypes",[])(ZG=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.genId=void 0,this.name=qS.a,this.key="userId",this.data=new Map,this.genId=new De.a}init(){throw new Error("Method not implemented.")}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.reportV2,[this.name])),this.logger}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"YloVz_","Get report abuse data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"p4fVY-","Get report abuse data list failed",e)}signalUpdateItem(e){Object(Po.h)(this.name,e)}getOrCreateItem(e){let t=this.data.get(e);return t||(t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]}),t}onOpenReport(e){Ce.default.report_v2.enable&&this.Logger.zsymb(0,"1rY_5H","open report",e)}onReportDidOpen(e){if(Ce.default.report_v2.enable&&!this.data.has(e)){const t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]};this.data.set(e,t),this.signalUpdateItem(e)}}onCloseReport(e){this.data.has(e)&&(this.cleanUpItem(e),Object(Po.f)(this.name,e),this.Logger.zsymb(0,"ctgwD2","close report",e))}cleanUpItem(e){const t=this.data.get(e);t&&(t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.delete(e))}toggleAttachment(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{expandAttachment:!t.expandAttachment})),this.signalUpdateItem(e)}selectReason(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{reasonId:t})),this.signalUpdateItem(e)}onSelectedPhotos(e,t){const s=this.getOrCreateItem(e),a=t.map((({blob:e,filename:t,type:s})=>({blob:e,id:this.genId.next(),url:URL.createObjectURL(e),filename:t,type:s})));this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedPhotos:s.selectedPhotos.concat(a)})),this.signalUpdateItem(e)}onDeselectPhoto(e,t){const s=this.getOrCreateItem(e),a=[...s.selectedPhotos],i=a.findIndex((e=>e.id===t));if(i>=0){a.splice(i,1).forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedPhotos:a})),this.signalUpdateItem(e)}}clearAllAttachedPhotos(e){const t=this.getOrCreateItem(e);t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedPhotos:[]})),this.signalUpdateItem(e)}onSelectedMessages(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedMessages:t})),this.signalUpdateItem(e)}clearAllAttachedMessages(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedMessages:[]})),this.signalUpdateItem(e)}changeDescription(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{description:t})),this.signalUpdateItem(e)}})||ZG)||ZG);var QG,YG=s("7upJ");Object(a.singleton)(qS.e)(QG=Reflect.metadata("design:type",Function)(QG=Reflect.metadata("design:paramtypes",[])(QG=class{constructor(){this.logger=void 0,this.name=void 0,this.name=qS.b}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.reportV2,[this.name])),this.logger}getRelatedStatus(e){return{blocked:Ii.default.isBlocked(e),unfriended:!Ii.default.isFriend(e)}}async blockAfterReport(e){try{await Ii.default.blockFriend(e,Y.SET_BLOCK)}catch(t){throw this.Logger.zsymb(18,"gGTe1U","block after report failed",e,t),t}}async unfriendAfterReport(e){try{await Ii.default.removeFriend(e)}catch(t){throw this.Logger.zsymb(18,"bNqsNA","unfriend after report failed",e,t),t}}getReportReasonFromId(e,t){const s=YG.a.getSortedAbuseList(e);if(!Array.isArray(s))return null;const a=s.find((e=>e.id===t));return a?a[le.a.getCurrentLanguageName()]:null}getContentMessageToReport(e){const{message:t,msgType:s}=e;if("object"==typeof t)switch(s){case Y.MSG_LINK_CLIENT:case Y.MSG_CONTACT:return t.title||t.href;case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:case Y.MSG_PHOTO_GROUP:case Y.MSG_VIDEO:return t.oriUrl||t.title;case Y.MSG_VOICE:return t.href;default:return t.title}return t}async submitReport(e){const t=new FormData,s={idTo:e.userId,objId:"person.profile",reason:String(e.reasonId),content:e.description};if(e.selectedPhotos.length){const a=e.selectedPhotos.map((e=>({filename:e.filename,type:e.type})));s.imgList=JSON.stringify(a),e.selectedPhotos.forEach((({blob:e},s)=>{t.append(`img${s}`,e)}))}if(e.selectedMessages.length){const t=e.selectedMessages.map((e=>({gmi:e.msgId,msg:this.getContentMessageToReport(e)}))).filter((({msg:e})=>!!e));s.msgList=JSON.stringify(t)}t.append("params",encodeURIComponent(ui.default.encodeAES(JSON.stringify(s))));try{const s=await Cl.default.reportUserV2(t);this.Logger.zsymb(0,"UVSB6_","submit success",e.userId,s)}catch(a){throw this.Logger.zsymb(18,"v_Baan","submit failed",e.userId,a),a}}})||QG)||QG);var JG=s("BpN3"),XG=s("UJhs");function ex(e){return"object"==typeof e&&!!e&&e.hasOwnProperty("loading")&&"boolean"==typeof e.loading&&e.type in XG.c&&e.hasOwnProperty("data")&&"object"==typeof e.data&&!!e.data}const tx="SEND_INPUT_PREVIEW",sx={[tx]:{feature:Ia.FeaturesInfo.InputBoxPreview,subType:1}};var ax=function(e){return e[e.Chat=1]="Chat",e[e.Group=2]="Group",e[e.MyCloud=3]="MyCloud",e[e.OA=4]="OA",e}(ax||{});class ix{}ix.actionlogSendPreview=e=>{requestIdleCallback((()=>{try{var t;if(!e.length)return;const i=e.filter((e=>e.type===XG.c.PHOTO));if(!i.length)return;let n;const r=null==i||null===(t=i[0])||void 0===t?void 0:t.toUid;n=Object(GG.z)(r)?ax.OA:ui.default.isGroup(r)?ax.Group:Object(GG.f)()===r?ax.MyCloud:ax.Chat;const o=e.length,l=[];for(let e=0;e<i.length;e++){var s,a;const t=i[e],n={photo_position:e+1,caption_length:(null==t||null===(s=t.caption)||void 0===s?void 0:s.length)||0,is_caption_form:null!=t&&null!==(a=t.caption)&&void 0!==a&&a.length?1:0};l.push(n)}const c={total_item_in_group:o,caption_info:l,chat_type:n};ix._actionlogSendInputPreview(tx,c)}catch(i){es.dangerouslyLogConsole.error("InputPreviewActionLog.logSendPreview",i)}}),{timeout:5e3})},ix._actionlogSendInputPreview=async(e,t)=>{const s=sx[e].feature,a=sx[e].subType;Ia.default.logActionInfoV2(s,a,t)};var nx,rx=ix;Object(a.injectable)()(nx=Object(Ai.b)(JG.b)(nx=class{constructor(){this._eventEmitter=new of.a,this.totalPhotoSize=0,this.addPreviewItem=e=>{var t;Object(ua.a)(function(e){return ex(e)&&e.type!==XG.c.PLACEHOLDER}(e),"invalid item for input preview, must be InputPreviewData");const s=e,i=s.data,n=i.toUid,r=this.mayInitState(n),o=null!==(t=s.previewId)&&void 0!==t?t:i.clientId,l=r.oriItems.length>0?[...r.oriItems]:[...r.items],c=l.findIndex((e=>e.previewId===o)),d=s.data.clientId;(this.removedItems.get(n)||new Set).has(d)||(e.type===XG.c.PHOTO&&(a.ModuleContainer.resolve(Qp.b).trackTempBlob(e.data.clientId,e.data.img),this.trackPhotoSize(e)),-1!==c?l[c]=Object(I.a)(Object(I.a)(Object(I.a)({},r.items[c]),s),{},{previewId:o}):l.push(s),this.data.set(n,Object(I.a)(Object(I.a)({},r),{},{items:l,oriItems:l})),Object(Po.h)(this.name,n),this.emit("ON_ADD_INPUT_PREVIEW",{conversationId:n}))},this.getOrderedItemsForSending=e=>{const t=this.getOrderedItems(e).map((e=>e&&e.type===XG.c.GIF?Object(I.a)(Object(I.a)({},e),{},{type:XG.c.PHOTO}):e));return rx.actionlogSendPreview(t.map((e=>Object(I.a)({},e)))),t},this.removePreviewItemById=(e,t)=>{const s=this.data.get(e);if(!s)return;const a=s.items.filter((e=>e.data.clientId!==t)),i=s.oriItems.filter((e=>e.data.clientId!==t)),n=s.items.filter((e=>e.data.clientId===t));for(let r of n)this.untrackPhotoSize(r);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:a,oriItems:i})),Object(Po.h)(this.name,e)},this.trackPhotoSize=e=>{var t;e.type===XG.c.PHOTO&&(this.totalPhotoSize+=(null===(t=e.data.file)||void 0===t?void 0:t.size)||0)},this.untrackPhotoSize=e=>{var t;e.type===XG.c.PHOTO&&(this.totalPhotoSize=Math.max(0,this.totalPhotoSize-((null===(t=e.data.file)||void 0===t?void 0:t.size)||0)))},this.name=JG.a,this.data=new Map,this.removedItems=new Map,this.key="conversationId"}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter.emit(e,t)}get isOverInputPreviewMemoryLimit(){return this.totalPhotoSize>=Ce.default.file_photo_limit.maxInputPreviewMemory}canAddPreviewItem(e){if(this.isOverInputPreviewMemoryLimit)return!1;return this.totalPhotoSize+e<Ce.default.file_photo_limit.maxInputPreviewMemory}hasPreviewItems(e){const t=this.data.get(e);return!!t&&t.items.length>0}selectItem(e,t){if(!e||!t)return;const s=this.mayInitState(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedItem:t})),Object(Po.h)(this.name,e)}selectPreviousItem(e){const t=this.mayInitState(e),s=t.items,a=t.selectedItem;if(!a)return;const i=s.findIndex((e=>e.data.clientId===a.cliMsgId));if(-1===i)return;const n=Math.max(i-1,0);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:s[n]})),Object(Po.h)(this.name,e)}selectNextItem(e){const t=this.mayInitState(e),s=t.items,a=t.selectedItem;if(!a)return;const i=s.findIndex((e=>e.data.clientId===a.cliMsgId));if(-1===i)return;const n=Math.min(i+1,s.length-1);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:s[n]})),Object(Po.h)(this.name,e)}addPlaceholder(e,t){Object(ua.a)("string"==typeof e&&!!e,"conversationId must be string"),Object(ua.a)("object"==typeof t&&!(null==t||!t.clientId),"invalid item for input preview placeholder");const s=this.mayInitState(e),a={loading:!0,type:XG.c.PLACEHOLDER,previewId:t.clientId,data:{clientId:t.clientId}};this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:[...s.items,a],oriItems:[...s.oriItems,a]})),Object(Po.h)(this.name,e)}getPreviewItemsCount(e){var t,s;return null!==(t=null===(s=this.data.get(e))||void 0===s?void 0:s.items.length)&&void 0!==t?t:0}getOrderedItems(e){const t=this.data.get(e);if(!t)return[];let s=[];const a=t.oriItems.filter((e=>{const t=e.type!==XG.c.PLACEHOLDER;return t&&s.push(e.data.clientId),t})).map((e=>{var s;const a=(null===(s=t.caption[e.data.clientId])||void 0===s?void 0:s.saved)||"",i=Object(I.a)(Object(I.a)({},e.data),{},{caption:a});return Object(I.a)(Object(I.a)({},e),{},{data:i})}));s=s.sort(((e,t)=>e-t));return a.map(((e,t)=>Object(I.a)(Object(I.a)({},e.data),{},{clientId:s[t]})))}getRawOrderedItems(e){const t=this.data.get(e);return t?t.oriItems:[]}updateOrder(e,t){const s=this.mayInitState(e);Object(ua.a)(Array.isArray(t),`invalid items for input preview at ${e}`),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{oriItems:t})),Object(Po.h)(this.name,e)}removePreviewItem(e,t){const s=this.data.get(e);if(!s)return;const i=[...s.items],n=[...s.oriItems],r=i[t];if(!r)return;const o=n.indexOf(r);i.splice(t,1),-1!==o&&n.splice(o,1),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:i,oriItems:n})),r.type===XG.c.PHOTO&&(URL.revokeObjectURL(r.data.img),a.ModuleContainer.resolve(Qp.b).removeTrackTempBlob(r.data.clientId),this.untrackPhotoSize(r)),Object(Po.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}removeAllItems(e,t=!1){const s=this.data.get(e);if(!s)return;const i=this.removedItems.get(e)||new Set;if(!t)for(let n of s.items)i.add(n.data.clientId),n.type===XG.c.PHOTO&&(URL.revokeObjectURL(n.data.img),a.ModuleContainer.resolve(Qp.b).removeTrackTempBlob(n.data.clientId),this.untrackPhotoSize(n));this.removedItems.set(e,i),this.data.delete(e),Object(Po.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}saveDraft(e,t,s){const a="string"==typeof s?s.trimStart().trimEnd():"",i=this.mayInitState(e);Object(ua.a)(!!i,`invalid state when saveDraft for conversationId ${e}`),Object(ua.a)("string"==typeof a,`invalid draft for conversationId ${e}`);let n=i.caption[t]||{saved:"",draft:""};if(n.saved===a&&n.draft===a)return;n=Object(I.a)(Object(I.a)({},n),{},{draft:a});const r=Object(I.a)(Object(I.a)({},i.caption),{},{[t]:n}),o=new Set(i.unsavedChanges);n.saved!==n.draft?o.add(t):o.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{caption:r,unsavedChanges:Array.from(o)})),Object(Po.h)(this.name,e)}applyDraft(e,t){return Object(ua.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.applyDraftSingle(e,t):this.applyDraftMulti(e)}resetSelectedItem(e){if(!e)return;const t=this.mayInitState(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:null})),Object(Po.h)(this.name,e)}applyDraftSingle(e,t){const s=this.mayInitState(e);Object(ua.a)(!!s,`invalid state when addCaption for conversationId ${e}`);let a=s.caption[t];if(!a||a.saved===a.draft)return;const i=a.draft||"";a=Object(I.a)(Object(I.a)({},a),{},{saved:i});const n=Object(I.a)(Object(I.a)({},s.caption),{},{[t]:a}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Po.h)(this.name,e)}applyDraftMulti(e){const t=this.mayInitState(e);Object(ua.a)(!!t,`invalid state when addCaption for conversationId ${e}`);const s=Object(I.a)({},t.caption);Object.keys(s).forEach((e=>{const t=s[e];if(!t||t.saved===t.draft)return;const a=t.draft||"";s[e]=Object(I.a)(Object(I.a)({},t),{},{saved:a})}));const a=Object(I.a)(Object(I.a)({},t),{},{caption:s,unsavedChanges:[]});this.data.set(e,a),Object(Po.h)(this.name,e)}discardDraftedCaption(e,t){return Object(ua.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.discardDraftedCaptionSingle(e,t):this.discardDraftedCaptionMulti(e)}discardDraftedCaptionSingle(e,t){const s=this.mayInitState(e);if(!s)return;const a=s.caption[t];if(!a||!a.draft)return;const i=s.caption[t],n=Object(I.a)(Object(I.a)({},s.caption),{},{[t]:Object(I.a)(Object(I.a)({},i),{},{draft:null==i?void 0:i.saved})}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Po.h)(this.name,e)}discardDraftedCaptionMulti(e){let t=this.data.get(e);if(!t)return;const s=Object(I.a)({},t.caption);if(s)for(const a in s)s[a].draft=s[a].saved;t=Object(I.a)(Object(I.a)({},t),{},{caption:s,unsavedChanges:[]}),this.data.set(e,t),Object(Po.h)(this.name,e)}getCaption(e,t){return this.mayInitState(e).caption[t]}_listenEvents(){}mayInitState(e){let t=this.data.get(e);return t||(t={conversationId:e,items:[],oriItems:[],selectedItem:null,caption:{},unsavedChanges:[]},this.data.set(e,t)),t}init(){this._listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||nx);var ox=s("ONNR"),lx=s("1Q0E");const cx={network:{avgRequest:40,default:{hit:50},items:{file:{hit:80},"/keepalive":{hit:5}}},database:{avgRequest:300,default:{hit:100},items:{"Core.Message":{hit:500}}}};var dx=1e3;function ux(e,t){switch(t){case"byte-to-mb":return e/1024/1024;case"kb-to-mb":return e/1024;default:return}}var hx=s("fOVY"),gx=s("XnIt"),mx=s("CaBZ"),px=s("mHfx");let fx,vx;try{fx=$znode.fs,vx=$znode.path}catch($Q){}async function _x(e){return new Promise((t=>{try{fx.readdir(e,(async(s,a)=>{if(s)return t(0);let i=0;for(let t=0;t<a.length;t++){const s=a[t],n=vx.join(e,s),r=fx.statSync(n);if(Object(px.a)(r)){i+=await _x(n)}i+=r.size}t(i)}))}catch(s){t(0)}}))}var bx,Ix=new class{constructor(){this.lastFrameTime=0,this.fps=0,this.pause=!0}loop(e){if(this.pause)return;const t=e;if(0===this.lastFrameTime)return this.lastFrameTime=t,void requestAnimationFrame(this.loop.bind(this));const s=t-this.lastFrameTime;s>0&&(this.fps=Math.round(1e3/s),this.lastFrameTime=t),requestAnimationFrame(this.loop.bind(this))}start(){this.pause=!1,requestAnimationFrame(this.loop.bind(this))}stop(){this.lastFrameTime=0,this.fps=0,this.pause=!0}get value(){return this.fps}};const yx="z_m_h_",Sx="z_m_h_i___",Cx={CPU:!0,GPU:!0,RAM:!0,FPS:!0,"JS Heap":!0,"Root Render":!0,LCP:!0};Object(Ai.b)(lx.b)(bx=Object(a.injectable)()(bx=Object(a.singleton)()(bx=Reflect.metadata("design:type",Function)(bx=Reflect.metadata("design:paramtypes",[])(bx=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.isStarted=!1,this.userId=void 0,this.monitorItems=[],this.showMonitorItems=new Map,this.rootRenderInitTime=Oa.a.now(),this.rootRenderNumber=1,this.lcpMetric=void 0,this.intervalCheck=void 0,this.intervalCheckSteps=0,this.data={isShowZPCHealth:!1,monitorItemForUIs:[]},this.usageMonitor=void 0,this.name=lx.a,this.key=lx.a}initialize(e){this.isStarted||(this.isStarted=!0,function(){const e=a.ModuleContainer.resolve(mx.b);e.registerMonitorItem({expectedOrderPosition:1,title:"Database",description:"Cache & IndexedDB",getValue:async()=>{var e,t,s;let a=(null===(e=await(null===(t=navigator.storage)||void 0===t||null===(s=t.estimate)||void 0===s?void 0:s.call(t)))||void 0===e?void 0:e.usage)||0;return a=Math.round(ux(a,"byte-to-mb")||0),a},getType:e=>e>=200&&e<=500?"medium":e>500?"high":"low",getContent:e=>Object(hx.a)(e," MB"),checkSteps:10}),e.registerMonitorItem({expectedOrderPosition:2,title:"DOM",description:"DOM nodes",getValue:()=>document.getElementsByTagName("*").length||0,getType:e=>e>=3e3&&e<=6e3?"medium":e>6e3?"high":"low",getContent:e=>Object(hx.a)(e," nodes"),checkSteps:2}),!Ee.l&&e.registerMonitorItem({expectedOrderPosition:3,title:"Temp Files",description:"ZaloTemp & zTemp",getValue:async()=>{try{const e=await Object(Ni.getZaloTempDir)(),t=await _x(e),s=await Object(Ni.getzTempDir)(),a=await _x(s);return Math.round(ux(t+a,"byte-to-mb")||0)}catch(e){return 0}},getType:e=>e>=50&&e<=100?"medium":e>100?"high":"low",getContent:e=>Object(hx.a)(e," MB"),checkSteps:100}),e.registerMonitorItem({expectedOrderPosition:6,title:"Custom Domains",description:"Count custom domains usage",getValue:async()=>{const e=a.ModuleContainer.resolve(gx.a).getDomainConfig();let t=0;if(!e)return t;for(const s in e)e.hasOwnProperty(s)&&e[s].useDevDomain&&t++;return t},getType:e=>"low",getContent:e=>Object(hx.a)(e,""),checkSteps:2})}());const t=this.getStorage().getItem(yx);this.data.isShowZPCHealth="1"===t;const s=this.getStorage().getItem(Sx);if(s){s.split(",").forEach((e=>{e&&this.showMonitorItems.set(e,1)}))}this.data.isShowZPCHealth&&Object(Uc.d)()&&(Object(ox.a)((e=>{this.lcpMetric=e}),{reportAllChanges:!0}),this.userId=e,this.startHealthCheck())}destroy(){this.stopHealthCheck()}registerMonitorItem(e){const t=`${e.expectedOrderPosition||""}_${e.title.replace(" ","")}`,s=Object(I.a)(Object(I.a)({},e),{},{id:t});this.monitorItems.push(s),this.monitorItems=this.monitorItems.sort(((e,t)=>e.expectedOrderPosition&&t.expectedOrderPosition?e.expectedOrderPosition-t.expectedOrderPosition:0))}addRootRender(){this.data.isShowZPCHealth&&Object(Uc.d)()&&this.rootRenderNumber++}resetRootRender(){this.rootRenderNumber=1}startHealthCheck(){this.intervalCheck||(Ix.start(),this.getMonitorItems(this.userId),this.intervalCheck=setInterval((()=>{this.getMonitorItems(this.userId),this.intervalCheckSteps++}),dx))}stopHealthCheck(){Ix.stop(),this.rootRenderNumber=1,this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=void 0,this.intervalCheckSteps=0)}toggleZPCHealth(){this.data.isShowZPCHealth=!this.data.isShowZPCHealth,this.getStorage().setItem(yx,this.data.isShowZPCHealth?"1":"0"),this.data.isShowZPCHealth||this.stopHealthCheck(),Object(Po.h)(this.name,"")}getMonitorList(){return this.monitorItems.map((e=>({id:e.id,title:e.title,isShow:!(!this.showMonitorItems.get(e.id)&&!Cx[e.title])})))}showZPCHealthItem(e,t){if(!e)return;t?this.showMonitorItems.set(e,1):this.showMonitorItems.delete(e);let s="";this.showMonitorItems.forEach(((e,t)=>{s+=t+","})),this.getStorage().setItem(Sx,s),this.stopHealthCheck(),this.startHealthCheck()}async getMonitorItems(e){var t,s,a,i;const n=Ee.l?[]:await $zperf.getCpuInfos();let r=0,o=0,l=0;null==n||n.forEach((e=>{var t,s;const a=(null==e||null===(t=e.cpu)||void 0===t?void 0:t.percentCPUUsage)||0,i=(null==e||null===(s=e.memory)||void 0===s?void 0:s.workingSetSize)||0;"GPU"!==e.type?(r+=a,l+=i):o+=a})),r=Math.round(r),o=Math.round(o),l=Math.round(ux(l,"kb-to-mb")||0);let c=(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0;c=Math.round(ux(c,"byte-to-mb")||0);const d=Ix.value;let u=(null===(s=await(null===(a=navigator.storage)||void 0===a||null===(i=a.estimate)||void 0===i?void 0:i.call(a)))||void 0===s?void 0:s.usage)||0;u=Math.round(ux(u,"byte-to-mb")||0);const h=Math.round((Oa.a.now()-this.rootRenderInitTime)/1e3/60)||1,g=Math.round(this.rootRenderNumber/h),m=[...[{id:"0_CPU",title:"CPU",description:"CPU usage",getValue:()=>r,getType:e=>e>=20&&e<=40?"medium":e>40?"high":"low",getContent:e=>Object(hx.a)(e," %"),checkSteps:2},{id:"0_GPU",title:"GPU",description:"GPU usage",getValue:()=>o,getType:e=>e>=10&&e<=30?"medium":e>30?"high":"low",getContent:e=>Object(hx.a)(e," %"),checkSteps:2},{id:"0_FPS",title:"FPS",description:"Frame Per Second",getValue:()=>d,getType:e=>e>=20&&e<=30?"medium":e<20?"high":"low",getContent:e=>Object(hx.a)(e),checkSteps:1},{id:"0_RAM",title:"RAM",description:"RAM usage",getValue:()=>l,getType:e=>e>=500&&e<=1e3?"medium":e>1e3?"high":"low",getContent:e=>Object(hx.a)(e," MB"),checkSteps:2},{id:"0_JSHeap",title:"JS Heap",description:"JS Heap usage",getValue:()=>c,getType:e=>e>=200&&e<=300?"medium":e>300?"high":"low",getContent:e=>Object(hx.a)(e," MB"),checkSteps:2},{id:"0_RootRender",title:"Root Render",description:"Root Render in minutes",getValue:()=>g,getType:e=>e>=10&&e<=20?"medium":e>20?"high":"low",getContent:e=>Object(hx.a)(e," times / minute"),checkSteps:2},{id:"0_LCP",title:"LCP",description:"Largest Contentful Paint",getValue:()=>{var e;return Math.round(((null===(e=this.lcpMetric)||void 0===e?void 0:e.value)||0)/1e3)},getType:e=>{var t;switch(null===(t=this.lcpMetric)||void 0===t?void 0:t.rating){case"poor":return"high";case"needs-improvement":return"medium";default:return"low"}},getContent:e=>Object(hx.a)(e," s"),checkSteps:2}],...this.monitorItems],p=[];for(let b=0;b<m.length;b++){const t=m[b];let s=!1;s=!(!this.showMonitorItems.get(t.id)&&!Cx[t.title]);let a,i,n=0;var f,v,_;if(s)if(this.data.monitorItemForUIs[b]&&this.intervalCheckSteps%(t.checkSteps||1)!=0)a=this.data.monitorItemForUIs[b].type,i=this.data.monitorItemForUIs[b].content;else n=await(null===(f=t.getValue)||void 0===f?void 0:f.call(t,e))||0,a=null===(v=t.getType)||void 0===v?void 0:v.call(t,n),i=null===(_=t.getContent)||void 0===_?void 0:_.call(t,n);const r={id:t.id,title:t.title,description:t.description,type:a,content:i,isShow:s,checkTime:(t.checkSteps||1)*dx};p.push(r)}this.data.monitorItemForUIs=p,Object(Po.h)(this.name,"")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||bx)||bx)||bx)||bx);var Ex=s("zdwi");const Ox="1",Mx={windowId:Ox,name:"ZPC_HEALTH"},Tx={windowId:Ox,name:"METRICS"};var wx,Rx=s("Igfx"),Lx=s("noAy");const Dx="z_m_h_f_",Ax="z_m_h_r_",Fx="z_m_h_r_w_";Object(Ai.b)(Ex.a)(wx=Object(a.injectable)()(wx=Object(a.singleton)()(wx=function(e,t){return Object(a.inject)(Lx.b)(e,void 0,0)}(wx=Reflect.metadata("design:type",Function)(wx=Reflect.metadata("design:paramtypes",[void 0===Lx.b?Object:Lx.b])(wx=class{constructor(e){this.resourceWarning=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1,isShowRenderingDebugger:!1,isShowReactiveLogger:!1,isShowResourceWarning:!1},this.observeRendering=void 0,this.name=Ex.b,this.key=Ex.b}initialize(){if(!Object(Uc.d)())return;this.observeRendering=this.observeRendering?this.observeRendering:Object(Uc.f)(),Ie.ModalManagerV2.addModal(Object(I.a)(Object(I.a)({},Mx),{},{altWindowId:void 0})),Ie.ModalManagerV2.subscribeTriggers({windowId:Ox,name:Mx.name,trigger:e=>{}});const e=this.getStorage().getItem(Dx);var t;(this.data.isShowRenderingDebugger="1"===e,"1"===e)&&(null===(t=this.observeRendering)||void 0===t||t.observe());const s=this.getStorage().getItem(Ax);this.data.isShowReactiveLogger="1"===s,this.data.isShowReactiveLogger?Rx.a.enable():Rx.a.disable();const a=this.getStorage().getItem(Fx);this.data.isShowResourceWarning=null!==a?"1"===a:this.data.isShowResourceWarning,this.data.isShowResourceWarning?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Po.h)(this.name,"all")}destroy(){0}showZPCHealthPopup(e){Object(Uc.d)()&&(e?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},Mx),{},{windowId:Ox,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},Mx),{},{windowId:Ox})),this.data.isShow=e,Object(Po.h)(this.name,"all"))}setIsShowRenderingDebugger(e){var t,s;(this.data.isShowRenderingDebugger=e,this.getStorage().setItem(Dx,e?"1":"0"),e)?null===(t=this.observeRendering)||void 0===t||t.observe():null===(s=this.observeRendering)||void 0===s||s.disconnect();Object(Po.h)(this.name,"all")}setIsShowReactiveLogger(e){this.data.isShowReactiveLogger=e,this.getStorage().setItem(Ax,e?"1":"0"),e?Rx.a.enable():Rx.a.disable(),Object(Po.h)(this.name,"all")}setIsShowResourceWarning(e){this.data.isShowResourceWarning=e,this.getStorage().setItem(Fx,e?"1":"0"),e?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Po.h)(this.name,"all")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||wx)||wx)||wx)||wx)||wx);var kx,Nx=s("Bwur");Object(Ai.b)(Nx.b)(kx=Object(a.injectable)()(kx=Object(a.singleton)()(kx=Reflect.metadata("design:type",Function)(kx=Reflect.metadata("design:paramtypes",[])(kx=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1},this.name=Nx.a,this.key=Nx.a}initialize(){Object(Uc.d)()&&(Ie.ModalManagerV2.addModal(Object(I.a)(Object(I.a)({},Tx),{},{altWindowId:void 0})),Ie.ModalManagerV2.subscribeTriggers({windowId:Ox,name:Tx.name,trigger:e=>{}}))}destroy(){0}showMetricsPopup(e){Object(Uc.d)()&&(e?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},Tx),{},{windowId:Ox,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},Tx),{},{windowId:Ox})),this.data.isShow=e,Object(Po.h)(this.name,"all"))}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||kx)||kx)||kx)||kx);var Px=s("1UUk"),jx=s("PmZf");class Ux{constructor(e){this._queue=void 0,this._maxSize=void 0,this._queue=[],this._maxSize=null==e?void 0:e.maxSize}enqueue(e){this._maxSize&&this._queue.length>=this._maxSize&&this._queue.shift(),this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}isEmpty(){return 0===this._queue.length}get length(){return this._queue.length}clear(){this._queue=[]}toArray(){return this._queue}}var Bx,zx=s("WZ0o");const Gx="requests / second",xx=1e3;Object(Ai.b)(Lx.b)(Bx=Object(a.injectable)()(Bx=Object(a.singleton)()(Bx=function(e,t){return Object(a.inject)(Px.b)(e,void 0,0)}(Bx=Reflect.metadata("design:type",Function)(Bx=Reflect.metadata("design:paramtypes",[void 0===Px.a?Object:Px.a])(Bx=class{constructor(e){this.databaseManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={network:{totalRequestInLiveTime:0,queue:new Ux,hitCount:0,error:void 0},database:{totalRequestInLiveTime:0,queue:new Ux,hitCount:0,error:void 0}},this.warningConfigs=cx,this.isEnable=void 0,this.initTime=void 0,this.timeoutSignals={},this.enableLogEachRequest=void 0,this.hitQueue=new Ux({maxSize:20}),this.observePerformance=void 0,this.name=Lx.a,this.key=Lx.a,this.dbQueryExecListener=this.dbQueryExecListener.bind(this)}enable(){Object(Uc.d)()&&(this.isEnable||(this.isEnable=!0,this.setup()))}disable(){var e;this.isEnable=!1,null===(e=this.observePerformance)||void 0===e||e.disconnect(),this.databaseManager.removeEventListener(jx.b.QueryExec,this.dbQueryExecListener),this.resetData()}getData(){return this.data}resetNetworkError(){this.data.network.totalRequestInLiveTime=0,this.data.network.error=void 0,Object(Po.h)(this.name,"all")}resetDatabaseError(){this.data.database.totalRequestInLiveTime=0,this.data.database.error=void 0,Object(Po.h)(this.name,"all")}setWarningConfigs(e){this.warningConfigs=e}setEnableLogEachRequest(e){this.enableLogEachRequest=e}getHitQueue(){return this.hitQueue}setup(){this.initTime=Object(Uc.h)(),this.observePerformance=this.observePerformance?this.observePerformance:Object(zx.b)(["resource"],this.listenObservePerformance.bind(this)),this.observePerformance.observe(),this.databaseManager.addEventListener(jx.b.QueryExec,this.dbQueryExecListener)}listenObservePerformance(e){let t=e.filter((e=>"resource"===e.entryType)).filter((e=>"xmlhttprequest"===e.initiatorType));if(0!==t.length){this.dequeueQueue(this.data.network.queue);for(let e=0;e<t.length;e++){const s=t[e],a={url:s.name,path:Object(hx.b)(s.name),ts:Object(Uc.h)()};this.data.network.queue.enqueue(a),this.data.network.totalRequestInLiveTime++,this.enableLogEachRequest}this.slowHandleWarning("network",this.data.network,(()=>this.getWarningDetail("network",this.data.network.queue,(e=>{var t;return(null===(t=e.url)||void 0===t?void 0:t.startsWith("file://"))?"file":`${e.path}`}))))}}dbQueryExecListener(e){const t=e.data;if(!t)return;this.dequeueQueue(this.data.database.queue);const s={database:t.database,method:t.method,table:t.table,ts:Object(Uc.h)()};this.data.database.queue.enqueue(s),this.data.database.totalRequestInLiveTime++,this.enableLogEachRequest,this.slowHandleWarning("database",this.data.database,(()=>this.getWarningDetail("database",this.data.database.queue,(e=>`${e.database}.${e.table}`))))}dequeueQueue(e){const t=e.peek();if(t&&t.ts){if(!(Object(Uc.h)()-t.ts>xx))return;e.dequeue(),this.dequeueQueue(e)}}slowHandleWarning(e,t,s){this.timeoutSignals[e]||(this.timeoutSignals[e]=setTimeout((()=>{const a=s();this.handleWarning(e,t,a),this.timeoutSignals[e]=void 0}),500))}handleWarning(e,t,s){const a=this.warningConfigs[e].default,i=this.warningConfigs[e].items,n=this.warningConfigs[e].avgRequest,r=a.hit;let o,l,c;const d=s.sorted;for(let u=0;u<d.length;u++){const[e,t]=d[u],a=i[e];if(a){if(t>=a.hit){o=`HIT. ${t} ${Gx} (${e})`,l=JSON.stringify(d),c=JSON.stringify(s.meta);break}}else if(t>=r){o=`HIT. ${t} ${Gx} (${e})`,l=JSON.stringify(d),c=JSON.stringify(s.meta);break}}if(!o&&this.initTime){let e=t.totalRequestInLiveTime/((Object(Uc.h)()-this.initTime)/xx);e=Math.round(e),e>=n&&(o=`AVG. ${e} ${Gx}`)}o&&(t.hitCount++,t.error={code:400,message:o,description:l,meta:c,ts:Date.now()},this.hitQueue.enqueue(Object(I.a)(Object(I.a)({},t.error),{},{type:e})),Object(Po.h)(this.name,"all"))}getWarningDetail(e,t,s){const a={};let i="database"===e?{}:void 0;t.toArray().forEach((e=>{const t=s(e);i&&e.method&&(i[e.method]?i[e.method]++:i[e.method]=1),a[t]?a[t]++:a[t]=1}));return{sorted:Object.entries(a).sort((([,e],[,t])=>t-e)),meta:i}}resetData(){this.initTime=void 0,this.data.network.totalRequestInLiveTime=0,this.data.network.queue.clear(),this.data.network.hitCount=0,this.data.network.error=void 0,this.data.database.totalRequestInLiveTime=0,this.data.database.queue.clear(),this.data.database.hitCount=0,this.data.database.error=void 0;for(let e in this.timeoutSignals)this.timeoutSignals[e]&&clearTimeout(this.timeoutSignals[e]);Object(Po.h)(this.name,"all")}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Bx)||Bx)||Bx)||Bx)||Bx);Object(Uc.d)()&&(window.$zpcHealth||(window.$zpcHealth={}),window.$zpcHealth.resourceWarningController=a.ModuleContainer.resolve(Lx.b));const Vx={maxRetry:3};var Hx,Wx,qx,Kx,$x,Zx,Qx,Yx=s("Hk5Z"),Jx=s("Y3Ul"),Xx=s("kuNG"),eV=s("5miw");Hx=Object(a.injectable)(),Wx=Object(a.singleton)(Yx.a),tV=([e])=>e,qx=(e,t,s)=>{const a=s.value,i=new Map;s.value=async function(...e){const t=tV(e);let s=i.get(t);return s||(s=a.apply(this,e),s.finally((()=>i.delete(t))),i.set(t,s)),s}},Kx=Reflect.metadata("design:type",Function),$x=Reflect.metadata("design:paramtypes",[void 0===eV.RemoteURL?Object:eV.RemoteURL]),Hx(Zx=Wx((Qx=class{constructor(){this.responseCache_=void 0}async convert(e){if(!e||"string"!=typeof e)return Jx.a.Error({error:new Error("Invalid Remote URL!")});if("blob:"===e.slice(0,5))return Jx.a.Success({blobURL:e});this.responseCache_||(this.responseCache_=this.getCacheLazily_());if(this.responseCache_.has(e)){const t=this.responseCache_.get(e);return Jx.a.Success({blobURL:t.blobURL})}try{const t=Object(Mp.a)(fetch,{min:1e3,max:5e3,retries:3,afterRetry:async({success:e})=>{}}),s=await t(e),a=await s.blob(),i=URL.createObjectURL(a);return this.responseCache_.set(e,{remoteURL:e,blobURL:i}),Jx.a.Success({blobURL:i})}catch(t){return Jx.a.Error({error:t})}}revokeBlobUrl_(e){URL.revokeObjectURL(e)}getCacheLazily_(){return new u.default({maxSize:Object(Xx.a)().config.max_bu_cache_size,onEviction:(e,t)=>{this.revokeBlobUrl_(t.blobURL)}})}},Object(wk.a)(Qx.prototype,"convert",[qx,Kx,$x],Object.getOwnPropertyDescriptor(Qx.prototype,"convert"),Qx.prototype),Zx=Qx))||Zx);var tV;const sV=Object(a.define)("InternalEventBus");var aV;Object(a.injectable)()(aV=Object(a.singleton)(sV)(aV=class extends hs.b{})||aV);const iV=Object(a.define)("AIStickerMapper");function nV(e,t="token"){if("number"!=typeof e||Number.isNaN(e))throw Error(`${t}=${e} is invalid!`);return e}class rV{constructor(e,t,s,a,i){this.id=void 0,this.rootStickerCateId=void 0,this.url=void 0,this.width=void 0,this.height=void 0,this.id=nV(e,"id"),this.rootStickerCateId=nV(t,"rootStickerCateId"),this.url=function(e,t="token"){if(!e)throw Error(`${t}=${e} is invalid!`);return e}(s,"url"),this.width=nV(a,"width"),this.height=nV(i,"height")}equals(e){return this.id===e.id}}var oV;s("SF1S");Object(a.injectable)()(oV=Object(a.singleton)(iV)(oV=class{toAIStickerDTOFromDomain(e){return{id:e.id,url:e.url,thumb:"",type:bT.f.AI_GENERATED,intrinsicWidth:e.width,intrinsicHeight:e.height,renderedWidth:e.width,renderedHeight:e.height,animatable:!1}}toEntityFromSchema(e){return new rV(e.id,e.rootStickerCateId,e.url,e.width,e.height)}toSchemaFromEntity(e){return{id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height}}})||oV);const lV=Object(a.define)("AIStickerAPIClient");var cV;let dV=Object(a.injectable)()(cV=class{forwardAIStickerMessage(e,t,s,a,i,n){return Cl.default.apiForwardMessage(e,Y.MSG_PHOTO,t,s,a,i,n)}fetchAIStickerList(){const e={imei:Zl.a.getZaloClientID()},t=`${H.b.getStickerDomain()}/api/message/sticker/ai/list?${this.getCommonParams_()}&params=${this.encodeParams_(e)}`;return new Promise(((e,s)=>{this.makeGETRequest_(t,null,12190).then(Xr.a).then(e).catch(s)}))}makeGETRequest_(e,t,s,a,i,n,r,o,l){return Jr.default._get(e,t,s,a,i,n,r,o,l)}getCommonParams_(){return Jr.default._getCommonParams()}encodeParams_(e){return Jr.default.getEncodedParams(e)}})||cV;a.ModuleContainer.register(lV,dV);const uV=Object(a.define)("AIStickerLocalStorageDB");var hV;Object(m.f)()(hV=Object(a.injectable)()(hV=Object(a.singleton)(uV)(hV=Reflect.metadata("design:type",Function)(hV=Reflect.metadata("design:paramtypes",[])(hV=class{constructor(){this.tableName_="ai_sticker_tbl_1706849065515"}onAuthenticated(e){}async countAsync(){const e=await this.getRecords_();return e?e.length:0}async getAsync(e){var t;const s=await this.getRecords_();return s&&null!==(t=s.find((t=>t.id===e)))&&void 0!==t?t:null}async getAllAsync(){return await this.getRecords_()}async insertMultiAsync(e){var t;const s=null!==(t=await this.getRecords_())&&void 0!==t?t:[],a=[];e.forEach((e=>{const t=s.findIndex((t=>t.id===e.id));-1===t?a.push(e):s[t]=e}));const i=[...s,...a];return await this.writeRecords_(i),e}async delete(e){let t=await this.getRecords_();return!t||(t=t.filter((t=>t.id!==e)),await this.writeRecords_(t),!0)}async deleteAll(){return await this.writeRecords_([]),!0}async destroyAsync(){const e=this.getLocalStorageDB_();await e.removeItemForCurrentUserAsync(this.tableName_)}async getMultiAsync(e){throw new Error("Method not implemented yet!")}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async deleteMulti(e){throw new Error("Method not implemented yet!")}getLocalStorageDB_(){return n.default.getInstance()}async getRecords_(){const e=this.getLocalStorageDB_(),t=await e.getItemForCurrentUserAsync(this.tableName_);return t?JSON.parse(t):null}async writeRecords_(e){const t=this.getLocalStorageDB_(),s=JSON.stringify(e);await t.setItemForCurrentUserAsync(this.tableName_,s)}})||hV)||hV)||hV)||hV);const gV=Object(a.define)("AIStickerRepository");var mV;Object(a.injectable)()(mV=Object(a.singleton)(gV)(mV=function(e,t){return Object(a.inject)(uV)(e,void 0,0)}(mV=Reflect.metadata("design:type",Function)(mV=Reflect.metadata("design:paramtypes",[Object])(mV=class{constructor(e){this.aiStickerDB_=void 0,this.aiStickerDB_=e}getFakeAIStickers_(){const e=[];return e.push(new rV(1,123,"https://media-ten.z-cdn.me/oXS0nzgaaTQAAAAl/pyonium-cute.webp",498,498)),e.push(new rV(2,123,"https://media-ten.z-cdn.me/krDtrF9w1wYAAAAl/chinese-dragon-dragon.webp",498,498)),e.push(new rV(3,123,"https://media-ten.z-cdn.me/XwHQ_iIQT6MAAAAl/dragon-ball.webp",360,360)),e}async getAllAsync(){return this.getFakeAIStickers_()}async countAsync(){return this.aiStickerDB_.countAsync()}async deleteAll(){return this.aiStickerDB_.deleteAll()}async delete(e){return this.aiStickerDB_.delete(e)}async insertMultiAsync(e){const t=e.map((e=>({id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height})));return await this.aiStickerDB_.insertMultiAsync(t),e}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async getAsync(e){throw new Error("Method not implemented yet!")}async find(e){throw new Error("Method not implemented yet!")}})||mV)||mV)||mV)||mV);var pV=s("xvqP");var fV=s("VLUZ");let vV=function(e){return e.SETUP_AI_STICKER_LIST_UPDATER="SETUP_AI_STICKER_LIST_UPDATER",e.FETCH_AI_STICKER_LIST="FETCH_AI_STICKER_LIST",e.FORWARD_AI_STICKER_MESSAGE="FORWARD_AI_STICKER_MESSAGE",e}({});class _V extends hs.a{constructor(e,t){super(vV.SETUP_AI_STICKER_LIST_UPDATER),this.expiredTime=void 0,this.version=void 0,this.expiredTime=e,this.version=t}}class bV extends hs.a{constructor(e,t){super(vV.FETCH_AI_STICKER_LIST),this.onCompleted=void 0,this.onFailed=void 0,this.onCompleted=null!=e?e:()=>{},this.onFailed=null!=t?t:()=>{}}}class IV extends hs.a{constructor(e,t,s){super(vV.FORWARD_AI_STICKER_MESSAGE),this.payload=void 0,this.onCompleted=void 0,this.onFailed=void 0,this.payload=null!=e?e:{},this.onCompleted=null!=t?t:()=>{},this.onFailed=null!=s?s:()=>{}}}var yV;Object(a.injectable)()(yV=Object(m.f)()(yV=Object(a.singleton)(pV.c)(yV=function(e,t){return Object(a.inject)(lV)(e,void 0,0)}(yV=function(e,t){return Object(a.inject)(sV)(e,void 0,1)}(yV=Reflect.metadata("design:type",Function)(yV=Reflect.metadata("design:paramtypes",[Object,Object])(yV=class{constructor(e,t){this.apiClient_=void 0,this.internalEventBus_=void 0,this.apiClient_=e,this.internalEventBus_=t}onAuthenticated(e){this.internalEventBus_.addEventListener(vV.FETCH_AI_STICKER_LIST,this.handleFetchAPIStickerListEvent_.bind(this)),this.internalEventBus_.addEventListener(vV.FORWARD_AI_STICKER_MESSAGE,this.handleForwardAPIStickerMessageEvent_.bind(this))}getAIStickerList(){return new Promise(((e,t)=>{const s=t=>{e({errorCode:fV.a.SUCCESS,data:{expiredTime:t.expired_time,version:t.version,stickers:t.stickers.map((e=>({id:e.id,url:e.url,width:e.width,height:e.height,rootStickerCateId:e.cateid_root})))}})},a=t=>{e({errorCode:fV.a.FAIL,data:void 0})};this.apiClient_.fetchAIStickerList().then(s).catch((e=>{this.requestErrorHandler_(e,this.getAIStickerList).then(s).catch(a)}))}))}handleForwardAPIStickerMessageEvent_(e){const{payload:t,onCompleted:s,onFailed:a}=e,i=t.retryTimeout?{count:Ce.default.retryConfig.max_retry_count,timeout:t.retryTimeout,timestamp:Date.now(),lowPriority:t.lowPriority}:null,n=ro.a.newReq();this.apiClient_.forwardAIStickerMessage(t.toUid,t.messageContent,t.clientMsgId,i,n,t.additional).then(s).catch(a)}handleFetchAPIStickerListEvent_(e){this.getAIStickerList().then(e.onCompleted).catch(e.onFailed)}requestErrorHandler_(e,t,s=0){return new Promise(((a,i)=>{if(s>=1)return i(e);let n=-1;switch(e?e.error_code||e.code:"UNKNOWN"){case 112:n=5e3;break;case"ERR_NO_NETWORK":case"ERR_CONNECTION_TIMED_OUT":n=1e4;break;default:n=-1}if(n<0)return i(e);setTimeout((()=>{t().then(a).catch((e=>{this.requestErrorHandler_(e,t,s+1).then(a).catch(i)}))}),n)}))}})||yV)||yV)||yV)||yV)||yV)||yV);const SV="ai_sticker_list_ver_1706778251026",CV="ai_sticker_list_expt_1707057455164";class EV{constructor(){this.aiStickerListVersion_=null,this.versionExpiredTime_=null}getAIStickerListVersion(){if(null==this.aiStickerListVersion_){const t=n.default.getInstance().getItemForCurrentUser(SV);let s=bT.b;if(t)try{s=JSON.parse(t)}catch(e){}this.aiStickerListVersion_=s}return this.aiStickerListVersion_}setAIStickerListVersion(e){this.aiStickerListVersion_=e;n.default.getInstance().setItemForCurrentUser(SV,JSON.stringify(e))}getVersionExpiredTime(){if(null==this.versionExpiredTime_){const t=n.default.getInstance().getItemForCurrentUser(CV);let s=-1;if(t)try{s=JSON.parse(t)}catch(e){}this.versionExpiredTime_=s}return this.versionExpiredTime_}setVersionExpiredTime(e){this.versionExpiredTime_=e;n.default.getInstance().setItemForCurrentUser(CV,JSON.stringify(e))}}EV.NOT_AI_STICKER_LIST_VERSION=bT.b,EV.NOT_VERSION_EXPIRED_TIME=-1;var OV,MV=new EV;let TV=Object(a.injectable)()(OV=function(e,t){return Object(a.inject)(iV)(e,void 0,0)}(OV=function(e,t){return Object(a.inject)(gV)(e,void 0,1)}(OV=function(e,t){return Object(a.inject)(sV)(e,void 0,2)}(OV=Reflect.metadata("design:type",Function)(OV=Reflect.metadata("design:paramtypes",[Object,Object,Object])(OV=class{constructor(e,t,s){this.aiStickerListVersion_=void 0,this.aiStickerMapper_=void 0,this.aiStickerRepository_=void 0,this.internalEventBus_=void 0,this.aiStickerMapper_=e,this.aiStickerRepository_=t,this.internalEventBus_=s,this.aiStickerListVersion_=MV}transformFromAIStickerMessage(e){var t,s,a,i,n;const r=e.content,o=e.content.parsedParams,l=o.contentId,c=null!==(t=null!==(s=null!==(a=r.oriUrl)&&void 0!==a?a:r.hdUrl)&&void 0!==s?s:null===(i=o.webp)||void 0===i?void 0:i.url)&&void 0!==t?t:"";return{id:l,url:c,thumb:null!==(n=r.thumbUrl)&&void 0!==n?n:c,intrinsicWidth:o.width,intrinsicHeight:o.height,renderedWidth:Object(Xx.a)().config.ai_sticker_message.w,renderedHeight:Object(Xx.a)().config.ai_sticker_message.h,animatable:undefined,type:bT.f.AI_GENERATED,extra:{fromSrc:bT.a.MESSAGE}}}transformRecentAIStickerFromAISticker(e){return Object(I.a)(Object(I.a)({},e),{},{extra:{fromSrc:bT.a.RECENT}})}transformFromAIStickerMessageContent(e){throw new Error("Method does not be implemented yet!")}isValidAISticker(e){const t=!!e.id,s=!!e.url,a=e.type===bT.f.AI_GENERATED;return t&&s&&a}isValidAIStickerFromRecentStickerPanel(e){var t;return(null==e||null===(t=e.extra)||void 0===t?void 0:t.fromSrc)===bT.a.RECENT}async getAIStickerList(){let e=await this.aiStickerRepository_.getAllAsync();if((!e||0===e.length)&&this.aiStickerListVersion_.getAIStickerListVersion()===EV.NOT_AI_STICKER_LIST_VERSION){e=await this.syncAIStickerList_()?await this.aiStickerRepository_.getAllAsync():[]}return e.map((e=>this.aiStickerMapper_.toAIStickerDTOFromDomain(e)))}getAIStickerListVersion(){return this.aiStickerListVersion_.getAIStickerListVersion()}async syncAIStickerList_(){return new Promise(((e,t)=>{const s=()=>{e(!1)},a=new bV((async t=>{try{if(t.errorCode===fV.a.SUCCESS){const s=t.data;if(s.version>this.aiStickerListVersion_.getAIStickerListVersion()){const t=s.stickers.map((e=>new rV(e.id,e.rootStickerCateId,e.url,e.width,e.height)));await this.aiStickerRepository_.insertMultiAsync(t),this.aiStickerListVersion_.setAIStickerListVersion(s.version),s.expiredTime&&(this.aiStickerListVersion_.setVersionExpiredTime(s.expiredTime),this.internalEventBus_.dispatchEvent(new _V(s.expiredTime,s.version))),e(!0)}}e(!1)}catch(a){s()}}),s);this.internalEventBus_.dispatchEvent(a)}))}})||OV)||OV)||OV)||OV)||OV)||OV;function wV(e){var t;if(!e)return;let s={message:""};if("string"==typeof e.msg)s.message=e.msg;else try{const t=e.msg;s=Object(I.a)(Object(I.a)({},t),{},{message:t.title||""})}catch(i){}const a=null!==(t=e.ownerId)&&void 0!==t?t:e.fromUid;return Object(I.a)(Object(I.a)({},e),{},{attachment:eT.a.deep(e.attach),rootClientMessageID:e.cliMsgId,rootClientMessageType:e.cliMsgType,rootContent:s,rootGlobalMessageID:e.globalMsgId,rootSentTime:+e.ts,rootSenderName:Ii.default.getDName(a),rootSenderID:a,ttl:e.ttl})}function RV(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}}a.ModuleContainer.register(pV.a,TV);const LV=()=>({contentId:"",width:-1,height:-1,thumbWidth:-1,thumbHeight:-1,pStickerType:bT.c.AI_STICKER,webp:{width:-1,height:-1,url:""}});function DV(e){return e?Object(I.a)(Object(I.a)({},e),{},{contentId:e.contentId,pStickerType:e.pStickerType,webp:{width:e.webp.width,height:e.webp.height,url:e.webp.url},height:e.height,width:e.width,thumbHeight:e.thumb_height,thumbWidth:e.thumb_width}):LV()}const AV=()=>({title:"",description:"",oriUrl:"",thumbUrl:"",hdUrl:"",parsedParams:DV(null)});function FV(e){if(!e)return AV();const t=e.params;let s=DV(null);if("string"==typeof t)try{s=DV(JSON.parse(t))}catch($Q){0}else"object"==typeof t&&(s=DV(t));return Object(I.a)(Object(I.a)({},e),{},{title:e.title,description:e.description,hdUrl:e.hdUrl,oriUrl:e.oriUrl,thumbUrl:e.thumbUrl,parsedParams:s})}const kV=()=>({color:-1,size:-1,subType:-1,type:-1,parsedExt:{sSrcStr:"",sSrcType:-1}});function NV(e){if(!e)return kV();const t=e.ext;let s={sSrcStr:"",sSrcType:-1};if("string"==typeof t)try{s=JSON.parse(t)}catch($Q){0}else"object"==typeof t&&(s=t);return Object(I.a)(Object(I.a)({},e),{},{color:e.color,size:e.size,subType:e.subType,type:e.type,parsedExt:s})}function PV(e){return Object(I.a)(Object(I.a)({},function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{actionID:e.actionId,clientMessageID:e.cliMsgId,e2eeStatus:e.e2eeStatus,eventInfo:RV(e.eventInfo),extra:e.extra,fromUID:String(e.fromUid),messageID:e.msgId,platformType:e.platformType,quote:wV(e.quote),sentSource:e.src,sentTime:+e.sendDttm,serverTime:+e.serverTime,status:e.status,syncFromMobile:e.syncFromMobile,toUID:String(e.toUid),ttl:e.ttl,type:-1})}(e)),{},{content:FV(e.message),type:9999,src:e.src,msgType:e.msgType,originMsgType:"chat.photo",properties:NV(e.properties)})}var jV,UV=s("bKjh");let BV=Object(a.injectable)()(jV=function(e,t){return Object(a.inject)(sV)(e,void 0,0)}(jV=Reflect.metadata("design:type",Function)(jV=Reflect.metadata("design:paramtypes",[Object])(jV=class{constructor(e){this.internalEventBus_=void 0,this.internalEventBus_=e}isAIStickerMessageObject(e){return Object(UV.b)(e)}isAIStickerMessage(e){return Object(UV.a)(e)}isOldAIStickerMessage(e){return Object(UV.e)(e)}isNewAIStickerMessage(e){return Object(UV.d)(e)}transformFromRawMessage(e){return PV(e)}transformAIStickerMessageObjectFromAISticker(e,t){return{toId:e,sendByUrl:!0,title:"",description:"",file:{},img:t.url,oriUrl:t.url,thumbUrl:t.thumb||t.url,hdUrl:t.url,width:t.intrinsicWidth,height:t.intrinsicHeight,params:{contentId:t.id,pStickerType:bT.c.AI_STICKER,height:t.intrinsicHeight,width:t.intrinsicWidth,thumb_width:t.intrinsicWidth,thumb_height:t.intrinsicHeight,webp:{width:t.intrinsicWidth,height:t.intrinsicHeight,url:t.url}},properties:{subType:0,color:-1,size:-1,type:Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,ext:{sSrcStr:bT.d.AI,sSrcType:bT.e.AI}}}}forwardAIStickerMessage(e,t,s,a={retryTimeout:0,lowPriority:!1,fwAdditional:{}}){return new Promise(((i,n)=>{const r=s.content.parsedParams.webp.url||s.content.oriUrl;if(!r)return n();this.checkAlive_(r,{count:Ce.default.retryConfig.max_normal_request_retry_count}).then((()=>{var r,o,l,c,d,u;const h={description:"",title:"",oriUrl:s.content.oriUrl,thumbUrl:s.content.thumbUrl,normalUrl:s.content.normalUrl,hdUrl:s.content.hdUrl||s.content.normalUrl,contentId:s.content.parsedParams.contentId,thumb_width:null!==(r=s.content.parsedParams.thumbWidth)&&void 0!==r?r:s.content.parsedParams.width,thumb_height:null!==(o=s.content.parsedParams.thumbHeight)&&void 0!==o?o:s.content.parsedParams.height,webp:JSON.stringify(s.content.parsedParams.webp),width:s.content.parsedParams.width,height:s.content.parsedParams.height,properties:JSON.stringify({color:s.properties.color,size:s.properties.size,subType:s.properties.subType,type:s.properties.type,ext:JSON.stringify(s.properties.parsedExt)}),pStickerType:s.content.parsedParams.pStickerType,photoId:null!==(l=s.content.photoId)&&void 0!==l?l:1},g=s.e2eeStatus===Y.MSG_E2EE;g&&(h.isAISticker=!0);const m=new IV({toUid:e,clientMsgId:t,lowPriority:null!==(c=a.lowPriority)&&void 0!==c&&c,retryTimeout:null!==(d=a.retryTimeout)&&void 0!==d?d:0,messageContent:h,additional:null!==(u=a.fwAdditional)&&void 0!==u?u:{}},(async e=>{if(g)i(e);else{const t={msgId:e.msgId+"",thumbUrl:s.content.thumbUrl,hdUrl:s.content.hdUrl,oriUrl:s.content.oriUrl,width:s.content.parsedParams.width,height:s.content.parsedParams.height};i(t)}}),(async e=>{n(e)}));this.internalEventBus_.dispatchEvent(m)})).catch(n)}))}checkAlive_(e,t){return new Promise(((s,i)=>{ui.default.checkAlive(e).then(s).catch((n=>{if(Ce.default.retryConfig.enable_add_missing_retry&&n===mS.XMLHttpRequestErrorCode.NO_RESPONSE&&t.count){t.count=t.count-1;const n=()=>this.checkAlive_(e,t).then(s).catch(i);a.ModuleContainer.resolve(mS.ConnectionPendingController).pushToRetryQueue(n)}else i(n)}))}))}})||jV)||jV)||jV)||jV;a.ModuleContainer.register(pV.b,BV);var zV,GV=s("56jR"),xV=s("397E"),VV=s("RJlJ");Object(a.injectable)()(zV=Object(m.f)()(zV=Object(Ai.b)(xV.b)(zV=Object(a.singleton)(xV.b)(zV=function(e,t){return Object(a.inject)(pV.a)(e,void 0,0)}(zV=Reflect.metadata("design:type",Function)(zV=Reflect.metadata("design:paramtypes",[void 0===GV.IAIStickerAppService?Object:GV.IAIStickerAppService])(zV=class{constructor(e){this.aiStickerService_=void 0,this.state_={version:bT.b,aiStickers:[]},this.name=xV.a,this.key=VV.a,this.aiStickerService_=e}onAuthenticated(e){Object(Xx.a)().isEnable("AIStickerTab")&&this.aiStickerService_.getAIStickerList().then((e=>{this.state_.version=this.aiStickerService_.getAIStickerListVersion(),this.state_.aiStickers=e,Object(Po.h)(this.name,this.key)}))}getAIStickerList(){return this.state_.aiStickers}init(){}getItem(e){if(e.key===this.key)return this.state_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||zV)||zV)||zV)||zV)||zV)||zV);var HV=s("T6Qc"),WV=s("RYTL");const qV=Object(WV.b)("socket-polling"),KV=Object(WV.b)("event-bus"),$V=Object(WV.b)("z-storage"),ZV=Object(WV.b)("z-search-v3"),QV=Object(WV.b)("actionlog-service"),YV=Object(WV.b)("important-message-manager"),JV=Object(WV.b)("sync-message-controller");var XV,eH=s("KBxP");const tH=new ee.a({enable:ee.b.field().boolean(),batch_size:ee.b.field().number().min(0),enable_fetch_foreground:ee.b.field().boolean(),enable_segment_updater:ee.b.field().boolean(),enable_tracking_overflow:ee.b.field().boolean(),enable_local_msgId_attach:ee.b.field().boolean(),min_throttle:ee.b.field().number().min(100),throttle:ee.b.field().number().min(0),throttle_idle:ee.b.field().number(),group_queue_config:ee.b.field().array("string"),one_one_queue_config:ee.b.field().array("string"),interval_check_insufficient_data:ee.b.field().number().min(0),max_time_check_insufficient_data:ee.b.field().number().min(0),max_retry_batch:ee.b.field().number().min(0),retry_strategy:ee.b.field().string().oneOf(["fibo","linear"]),time_exclude:ee.b.field().array("number"),debugger:ee.b.field().schema({show_msg_src:ee.b.field().boolean(),logger:ee.b.field().schema({machine_transition:ee.b.field().boolean(),save_message:ee.b.field().boolean(),batch_request_info:ee.b.field().boolean(),interval_update_sufficient_ts:ee.b.field().boolean()}),simulator:ee.b.field().schema({overflow_db_group_offline:ee.b.field().boolean(),slow_load_message:ee.b.field().boolean()})})});let sH=Object(WV.d)()(XV=Object(WV.e)(HV.b)(XV=Reflect.metadata("design:type",Function)(XV=Reflect.metadata("design:paramtypes",[])(XV=class extends X.ZFeatureConfig{constructor(){super({default:eH.b,valiator:tH})}selector(e){return e.auto_fetch_msg_mini_cloud||{}}shouldConfigUpdate(e,t){return!new E.g.Comparer(e,t,!0).AND("enable").AND("batch_size").AND("min_throttle").AND("enable_fetch_foreground").AND("enable_segment_updater").AND("enable_tracking_overflow").AND("enable_local_msgId_attach").AND("throttle").AND("throttle_idle").AND("group_queue_config",AS.a.isEqual).AND("one_one_queue_config",AS.a.isEqual).AND("interval_check_insufficient_data").AND("max_time_check_insufficient_data").AND("max_retry_batch").AND("retry_strategy").AND("time_exclude",AS.a.isEqual).AND("debugger",AS.a.isEqual).exec()}})||XV)||XV)||XV)||XV;var aH=s("7Yx4");let iH=function(e){return e.OVERFLOW_DB_GROUP_OFFLINE="OVERFLOW_DB_GROUP_OFFLINE",e.NEXT_CURSOR="NEXT_CURSOR",e}({});var nH=s("j8Zv");let rH=function(e){return e[e.ONLY_1_1=0]="ONLY_1_1",e[e.ONLY_GROUP=1]="ONLY_GROUP",e[e.BOTH_1_1_AND_GROUP=2]="BOTH_1_1_AND_GROUP",e[e.NONE=3]="NONE",e}({});class oH extends hs.a{constructor(e){super(ym.a.SHOW_SYNC_MESSAGE_SUGGESTION),this.queueId=e}}class lH extends hs.a{constructor(){super(ym.a.AFMC_START)}}class cH extends hs.a{constructor(){super(ym.a.AFMC_FINISHED)}}class dH extends hs.a{constructor(e){super(ym.a.AFMC_START_FETCH_CONV),this.convId=e}}class uH extends hs.a{constructor(e,t){super(ym.a.AFMC_STOP_FETCH_CONV),this.convId=e,this.success=t}}var hH;let gH=Object(WV.d)()(hH=Object(Yr.e)()(hH=Object(WV.e)(HV.c)(hH=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(hH=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,1)}(hH=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,2)}(hH=function(e,t){return Object(Yr.d)(HV.n)(e,void 0,3)}(hH=function(e,t){return Object(Yr.d)(HV.h)(e,void 0,4)}(hH=function(e,t){return Object(Yr.d)(HV.k)(e,void 0,5)}(hH=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,6)}(hH=function(e,t){return Object(Yr.d)(HV.i)(e,void 0,7)}(hH=function(e,t){return Object(Yr.d)(HV.r)(e,void 0,8)}(hH=function(e,t){return Object(Yr.d)(HV.e)(e,void 0,9)}(hH=Reflect.metadata("design:type",Function)(hH=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMachine?Object:AFMC_IMachine,"undefined"==typeof AFMC_ITrackingOverflowMessage?Object:AFMC_ITrackingOverflowMessage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(hH=class extends hs.b{constructor(e,t,s,a,i,n,r,o,l,c){super(),this.logger=void 0,this.service=void 0,this.ledger=void 0,this.metrics=void 0,this.storage=void 0,this.systemTime=void 0,this.fetcherMachine=void 0,this.eventCollector=void 0,this.trackingOverflow=void 0,this.config=void 0,this.isInsufficientMessage=void 0,this.onOverflowDBGroupOffline=e=>{this.logger.zsymb(0,"Bh_C7M","DB Group offline overflow, should suggest sync message"),this.dispatchEvent(new oH(e.queueId))},this.onNextCursor=async e=>{const{currCheckpoint:t,nextCheckpoint:s}=e;t&&this.dispatchEvent(new uH(t.convId,await t.isDone())),s&&this.dispatchEvent(new dH(s.convId))},this.onConfigUpdate=e=>{!0===e.config.enable?(this.logger.zsymb(0,"51yuLb","Receive config enabled, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):(this.logger.zsymb(0,"OO8m4P","Receive config disabled, let stop machine"),this.fetcherMachine.stop(),this.unregisterMachineListener())},this.onMachineTransition=e=>{switch(e.event.type){case"START":this.onMachineStartFetch();break;case"STOP":this.onMachineStopFetch()}this.config.get("debugger.logger.machine_transition")&&this.logger.zsymb(12,"W4vri5","machine transition",JSON.stringify(e.value))},this.onMachineStop=()=>{this.logger.zsymb(0,"l4PHSE","Machine is stopped")},this.onMachineStartFetch=async()=>{this.dispatchEvent(new lH);const e=this.isInsufficientMessage=await this.service.isInsufficientMessage(),t=this.trackingOverflow.getOverflowStatus(),s=this.fetcherMachine.hasRemainConvInPrevSession();if(e){const e=await this.storage.getLastQueueIdOverflowMessage();this.dispatchEvent(new oH(null!=e?e:nH.a.SOCKET_MESSAGE_GROUP_OLD)),this.logger.zsymb(0,"1vFYgP","User messages may not be enough, should suggest sync message"),this.metrics.logAutoShowBannerSuggestion(s)}else if(this.logger.zsymb(0,"w9Tacd","Can cover overflow by fetch message from mini-cloud"),t===rH.ONLY_GROUP)this.metrics.logAutoHideBannerSuggestion();this.metrics.logStartFetch(e,t)},this.onMachineStopFetch=async()=>{const e=0===await this.ledger.size();e?(this.logger.zsymb(0,"-SNvwu","fetch done"),this.storage.saveLastFetchSuccess(this.systemTime.getTimeNow())):this.logger.zsymb(18,"nStpIZ","fetch stop"),null!==this.isInsufficientMessage&&this.metrics.logStopFetch(this.isInsufficientMessage,this.trackingOverflow.getOverflowStatus(),e),this.isInsufficientMessage=null,this.dispatchEvent(new cH)},this.onOverflowMessageQueue=async e=>!1===this.config.get("enable")?(this.logger.zsymb(0,"1b6-H0","Module is disabled, should suggest sync message"),void this.dispatchEvent(new oH(e.queueId))):!1===this.service.isQueueMessageGroup(e.queueId)?(this.logger.zsymb(0,"3h2aki","Detected overflow other queue, forward event to suggest sync message"),void this.dispatchEvent(new oH(e.queueId))):void this.logger.zsymb(0,"CqHVCq","Detected overflow queue message group, let wait done offline"),this.logger=e.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[R.ZLoggerNametags.controller]),this.config=s,this.ledger=i,this.service=a,this.metrics=n,this.storage=r,this.systemTime=t,this.fetcherMachine=o,this.eventCollector=c,this.trackingOverflow=l,this.isInsufficientMessage=null}start(){this.fetcherMachine.create(),this.registerListener(),this.config.get("enable")?(this.logger.zsymb(0,"jb8MTg","Module is enabled on startup, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"VrMIDM","Module is disabled on startup, let listen config from server")}getRemainConvIds(){return this.fetcherMachine.getRemainConvIds()}registerListener(){this.config.addEventListener("update",this.onConfigUpdate),this.ledger.addEventListener(iH.OVERFLOW_DB_GROUP_OFFLINE,this.onOverflowDBGroupOffline),this.ledger.addEventListener(iH.NEXT_CURSOR,this.onNextCursor),this.eventCollector.addEventListener(aH.a.OVERFLOW_MESSAGE_QUEUE,this.onOverflowMessageQueue)}registerMachineListener(){this.logger.zsymb(0,"8ZZx8m","register machine listener"),this.fetcherMachine.onStop(this.onMachineStop),this.fetcherMachine.onTransition(this.onMachineTransition)}unregisterMachineListener(){this.logger.zsymb(0,"NcoQhi","unregister machine listener"),this.fetcherMachine.off(this.onMachineStop),this.fetcherMachine.off(this.onMachineTransition)}})||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH)||hH,mH=function(e){return e.AUTO_FETCH_MSG_CLOUD_SETTING="auto_fetch_msg_cloud",e.SYNC_MESSAGE_SETTING="sync_cross_settings",e.IMPORT_MESSAGE_SETTING="export_import_data",e.OVERFLOW_MSG_TS="overflow_msg_ts",e.SUFFICIENT_MSG_TS="sufficient_msg_ts",e.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS="last-time-close-first-login-transfer-modal",e}({});class pH{constructor(e,t,s){this.key=void 0,this.version=void 0,this.storageAdapter=void 0,this.data=null,this.key=e,this.version=t,this.storageAdapter=s}async get(){return this.data?this.data:this.data=await this.storageAdapter.readAsync(this.key,this.version)}async save(e){this.data=e,await this.storageAdapter.writeAsync(this.key,this.version,e)}async clear(){this.data=null,await this.storageAdapter.removeAsync(this.key)}}class fH extends pH{constructor(e,t){super([e,"conv_ids"].join("_"),1,t)}async remove(e){var t;const s=(null!==(t=await this.get())&&void 0!==t?t:[]).filter((t=>t!==e));await this.save(s)}async getRemainConv(){const e=await this.get();return(null==e?void 0:e.length)||0}}class vH extends pH{constructor(e,t){super([e,"overflow"].join("_"),1,t)}}class _H extends pH{constructor(e,t){super([e,"last_fetch"].join("_"),2,t)}async getLastTsSuccess(){var e,t;return null!==(t=(null!==(e=await this.get())&&void 0!==e?e:{}).lastTsSuccess)&&void 0!==t?t:-1}async getFetchInfo(){var e;return null!==(e=await this.get())&&void 0!==e?e:{}}async saveLastTsSuccess(e){var t;const s=null!==(t=await this.get())&&void 0!==t?t:{};return this.save(Object(I.a)(Object(I.a)({},s),{},{lastTsSuccess:e}))}async saveStartFetchInfo(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.evict||(n.evict=e.evict),n.listTsStart=(null!==(a=n.listTsStart)&&void 0!==a?a:[]).concat(e.tsStart),n.tsSufficient=e.tsSufficient,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async saveConvIds(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.convIds=E.b.merge(null!==(a=null==n?void 0:n.convIds)&&void 0!==a?a:[],e);const r=Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n});await this.save(r)}async saveConvErrorIds(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{},r=null!==(a=null==n?void 0:n.convErrorIds)&&void 0!==a?a:[],o=E.b.merge(r,e);n.convErrorIds=o,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async saveTotalMessageFetched(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{},r=(null!==(a=n.totalMsgFetched)&&void 0!==a?a:0)+e;n.totalMsgFetched=r,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async removeLastStartFetchInfo(){var e;const t=null!==(e=await this.get())&&void 0!==e?e:{};return delete t.onProgressInfo,this.save(t)}async removeConvId(e){var t,s,a,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},r=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};r.convIds=(null!==(a=r.convIds)&&void 0!==a?a:[]).filter((t=>t!==e)),r.convErrorIds=(null!==(i=r.convErrorIds)&&void 0!==i?i:[]).filter((t=>t!==e));const o=Object(I.a)(Object(I.a)({},n),{},{onProgressInfo:r});await this.save(o)}async removeConvIdFetchFailed(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.convErrorIds=(null!==(a=n.convErrorIds)&&void 0!==a?a:[]).filter((t=>t!==e));const r=Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n});await this.save(r)}}var bH;let IH=Object(WV.d)()(bH=Object(Yr.e)()(bH=Object(WV.e)(HV.o)(bH=function(e,t){return Object(Yr.d)(HV.a)(e,void 0,0)}(bH=Reflect.metadata("design:type",Function)(bH=Reflect.metadata("design:paramtypes",["undefined"==typeof IAsyncStorageAdapter?Object:IAsyncStorageAdapter])(bH=class{constructor(e){this.localStorage=void 0,this.storageConvIds=void 0,this.storageOverflow=void 0,this.storageLastFetch=void 0,this.localStorage=n.default.getInstance(),this.storageConvIds=new fH(mH.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageOverflow=new vH(mH.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageLastFetch=new _H(mH.AUTO_FETCH_MSG_CLOUD_SETTING,e)}async getAllConvIds(){var e;return null!==(e=await this.storageConvIds.get())&&void 0!==e?e:[]}async getLastTsSyncMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(mH.SYNC_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastSync)&&void 0!==e?e:-1}async getLastTsCloseTransferSuggestion(){var e;const t=this.localStorage.getItemForCurrentUser(mH.SYNC_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastCloseSuggest)&&void 0!==e?e:-1}async getLastTsCloseFirstLoginTransferSuggestion(){const e=await this.localStorage.getItemForCurrentUserAsync(mH.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsImportMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(mH.IMPORT_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastTimeImportSuccess)&&void 0!==e?e:-1}async getLastTsAutoFetchMessageSuccess(){return await this.storageLastFetch.getLastTsSuccess()}async getFetchInfo(){return await this.storageLastFetch.getFetchInfo()}async getLastTsOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(mH.OVERFLOW_MSG_TS);if(e){const[t]=e.split("::");if(!isNaN(Number(t)))return Number(t)}return-1}async getLastQueueIdOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(mH.OVERFLOW_MSG_TS);if(e){const[t,s]=e.split("::");return s||null}return null}async getLastTsSufficientMessage(){const e=this.localStorage.getItemForCurrentUser(mH.SUFFICIENT_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getOverflowInfo(){return await this.storageOverflow.get()}async getRemainConv(){return await this.storageConvIds.getRemainConv()}async saveConvIds(e){await this.storageConvIds.save(e),await this.storageLastFetch.saveConvIds(e)}async saveLastFetchSuccess(e){await this.storageLastFetch.saveLastTsSuccess(e)}async saveLastOverflow(e,t){this.localStorage.setItemForCurrentUser(mH.OVERFLOW_MSG_TS,[t,e].join("::"))}async saveLastSufficientMessage(e){this.localStorage.setItemForCurrentUser(mH.SUFFICIENT_MSG_TS,String(e))}async saveOverflowInfo(e,t,s){await this.storageOverflow.save({queueId:e,lastMsgId:t,lastActionId:s})}async saveStartFetchInfo(e){await this.storageLastFetch.saveStartFetchInfo(e)}async saveConvErrorId(e){await this.storageLastFetch.saveConvErrorIds([e])}async saveTotalMessageFetched(e){await this.storageLastFetch.saveTotalMessageFetched(e)}async removeOverflowInfo(){await this.storageOverflow.clear()}async removeConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvIdFetchFailed(e)}async forceRemoveConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvId(e)}async removeStartFetchInfo(){await this.storageLastFetch.removeLastStartFetchInfo()}})||bH)||bH)||bH)||bH)||bH)||bH;var yH;let SH=Object(WV.d)()(yH=Object(WV.e)(HV.a)(yH=Reflect.metadata("design:type",Function)(yH=Reflect.metadata("design:paramtypes",[])(yH=class{constructor(){this.storage=void 0,this.storage=n.default.getInstance()}async readAsync(e,t){const s=await this.storage.getItemForCurrentUserAsync(e),[a,i]=E.g.safeParseJson(s);return a||null===i?null:i.version===t?i.value:(await this.storage.removeItemForCurrentUserAsync(e),null)}async writeAsync(e,t,s){const a=JSON.stringify({version:t,value:s});await this.storage.setItemForCurrentUserAsync(e,a)}async removeAsync(e){await this.storage.removeItemForCurrentUserAsync(e)}})||yH)||yH)||yH)||yH;var CH=s("9Gk3"),EH=s("WnuJ"),OH=s("wd/R"),MH=s.n(OH);const TH=(e,t={})=>(s,a,i)=>{const n=i.value,r=new Map,o=new u.default({maxSize:10});i.value=async function(...s){const a=e(s);let i=null;return t.cache&&(i=o.get(a)||null),i=i||r.get(a)||null,i||(i=n.apply(this,s),t.cache&&i.then((()=>{o.set(a,i)})),i.finally((()=>r.delete(a))),r.set(a,i)),i}};let wH=function(e){return e[e.SAVE_MESSAE_ERROR=0]="SAVE_MESSAE_ERROR",e[e.GET_GROUP_INFO_ERROR=1]="GET_GROUP_INFO_ERROR",e}({});class RH extends eo.a{constructor(e){super("SaveMessageError",wH.SAVE_MESSAE_ERROR,e)}}class LH extends eo.a{constructor(e,t){super("GetGroupInfoError",wH.GET_GROUP_INFO_ERROR,"An error occured during get list groups info. Error: "+JSON.stringify(t)+". GroupIds: "+e)}}var DH,AH,FH,kH,NH,PH,jH,UH,BH,zH,GH,xH,VH,HH,WH,qH,KH,$H,ZH,QH,YH,JH;let XH=(DH=Object(WV.d)(),AH=Object(Yr.e)(),FH=Object(WV.e)(HV.n),kH=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,0)},NH=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,1)},PH=function(e,t){return Object(Yr.d)(HV.j)(e,void 0,2)},jH=function(e,t){return Object(Yr.d)(HV.q)(e,void 0,3)},UH=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)},BH=function(e,t){return a.ModuleContainer.inject(Vr)(e,void 0,5)},zH=function(e,t){return a.ModuleContainer.inject(tc.b)(e,void 0,6)},GH=function(e,t){return a.ModuleContainer.inject(En.ConversationManager)(e,void 0,7)},xH=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,8)},VH=Reflect.metadata("design:type",Function),HH=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMessageProcessor?Object:AFMC_IMessageProcessor,"undefined"==typeof AFMC_ISufficientMessageController?Object:AFMC_ISufficientMessageController,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof IMessageController?Object:IMessageController,void 0===tc.b?Object:tc.b,void 0===En.ConversationManager?Object:En.ConversationManager,"undefined"==typeof ISystemTime?Object:ISystemTime]),WH=TH((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),qH=Reflect.metadata("design:type",Function),KH=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo]),$H=TH((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),ZH=Reflect.metadata("design:type",Function),QH=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo,Array]),DH(YH=AH(YH=FH(YH=kH(YH=NH(YH=PH(YH=jH(YH=UH(YH=BH(YH=zH(YH=GH(YH=xH(YH=VH(YH=HH((JH=class{constructor(e,t,s,a,i,n,r,o,l){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.groupManager=void 0,this.convManager=void 0,this.messageProcessor=void 0,this.messageController=void 0,this.sufficientMessageController=void 0,this.logger=i.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[R.ZLoggerNametags.service]),this.config=e,this.storage=t,this.systemTime=l,this.convManager=o,this.groupManager=r,this.messageProcessor=s,this.messageController=n,this.sufficientMessageController=a}getThrottle(e){return e?Math.max(this.config.get("min_throttle"),this.config.get("throttle")+this.config.get("throttle_idle")):Math.max(this.config.get("min_throttle"),this.config.get("throttle"))}allowFetchForeground(){return this.config.get("enable_fetch_foreground")}async getLocalMsgIdsFrom(e,t,s){let a=[];try{const i=Xt.default.getInstance();let n=null;if(t===Y.MessageConstants.MAX_MSG_ID)n=Y.MessageConstants.MAX_SENDDTTM;else{const s=await i.Core.Message.get(t,{partition:e});s&&(n=s.sendDttm)}n&&(a=await i.Core.Message.getAllKey({from:[e,"",""],to:[e,n,t],excludeTo:!0},{partition:e,index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:s}),a=a.filter((e=>!EH.a.isFakeId(e))),a.sort())}catch{}return a}async fetchMessages(e){const{convId:t,requestMsgId:s}=e,a=this.config.get("batch_size");let i=[];this.config.get("enable_local_msgId_attach")&&(i=await this.getLocalMsgIdsFrom(t,s,a));const n=await this.messageController.fetchMessagesCloud(t,s,a,{isOA:0,src:CH.c.AUTO_FETCH_MINI_CLOUD,localMsgIds:i});return n.groupMsgs.forEach((e=>e.setSrc(Y.MSG_SRC.AUTO_LOADER))),n}async processMessages(e,t){const[s,a]=await E.c.catchPromise(this.messageProcessor.process(e,t));return Gk(s,new RH("Save messages error "+(null==s?void 0:s.toString()))),a}checkBusyHour(){const e=this.systemTime.getTimeNow(),t=MH()(e).get("h");if(!1===this.config.get("time_exclude").includes(t))return[!1,0];const s=Math.random()*Math.max(this.config.get("throttle"),this.config.get("min_throttle")),a=MH()(e).add(1,"h").set("m",0).set("s",0).toDate().getTime();return[!0,Math.abs(a-e)+s]}checkMaxRetryBatch(e,t){if(e>=this.config.get("max_retry_batch"))return[!0,0];let s=this.getThrottle(t)+1e3*Math.random();if("fibo"===this.config.get("retry_strategy"))s+=1e3*E.f.get(e+1);return[!1,s]}async isInsufficientMessage(){const e=await this.sufficientMessageController.getLastTsSufficientMessage();return this.systemTime.getTimeNow()-e>this.config.get("max_time_check_insufficient_data")}isQueueMessageGroup(e){return this.config.get("group_queue_config").includes(e.toString())}async getGroupsHaveMessageOffline(){let e=!1,t=[];const s=await this.storage.getOverflowInfo();if(s){const a=await this.messageController.getGroupHasMessageOffline(s.queueId,s.lastMsgId,s.lastActionId);e=a.evict,t=a.listConvIds,eH.a&&this.config.get("debugger.simulator.overflow_db_group_offline")&&(e=!0)}const a=await this.storage.getAllConvIds(),i=E.b.merge(t,a),[n,r]=await E.c.catchPromise(this.groupManager.getMulti(i));Gk(n,new LH(i,n));const o=await E.b.asyncMapParallel(r,(async e=>{const s=await this.convManager.get(e.id),a=e.isAdmin()||e.isOwner(),i=!(null==s||!s.isPinned),n=!(null==s||!s.isMuted),r=e.totalMembers;let o=-1,l=-1;const c=await(null==s?void 0:s.getLastMessage());return null!=c&&c.sendDttm&&(o=Number(c.sendDttm),l=E.d.getNumberOfDays(o,this.systemTime.getTimeNow())),{convId:e.id,groupInfo:e,isNewGroupOffline:t.includes(e.id),isPinned:i,isOwnerOrAdmin:a,isMuted:n,lastActiveTime:o,totalMembers:r,lastActiveTimeInDays:l}}));return e?{listGroups:o,evict:e,queueId:s.queueId}:{listGroups:o,evict:e,queueId:null}}reloadMessageOfConv(e){this.messageController.reloadMessage(e)}},Object(wk.a)(JH.prototype,"fetchMessages",[WH,qH,KH],Object.getOwnPropertyDescriptor(JH.prototype,"fetchMessages"),JH.prototype),Object(wk.a)(JH.prototype,"processMessages",[$H,ZH,QH],Object.getOwnPropertyDescriptor(JH.prototype,"processMessages"),JH.prototype),YH=JH))||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH)||YH);var eW,tW=s("C3LF");let sW=Object(WV.d)()(eW=Object(Yr.e)()(eW=Object(WV.e)(HV.e)(eW=function(e,t){return Object(Yr.d)(KV)(e,void 0,0)}(eW=function(e,t){return Object(Yr.d)(qV)(e,void 0,1)}(eW=function(e,t){return Object(Yr.d)(JV)(e,void 0,2)}(eW=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,3)}(eW=Reflect.metadata("design:type",Function)(eW=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof SyncMessageController?Object:SyncMessageController,"undefined"==typeof BaseApplication?Object:BaseApplication])(eW=class extends hs.b{constructor(e,t,s,a){super(),this.onStartPullOffline=()=>{this.dispatchEvent(new tW.l)},this.onDonePullOffline=()=>{this.dispatchEvent(new tW.n)},this.onOverflowQueue=e=>{this.dispatchEvent(new tW.j(e.queueId))},this.onStartSyncMessage=()=>{this.dispatchEvent(new tW.m("start"))},this.onResumeSyncMessage=()=>{this.dispatchEvent(new tW.m("resume"))},this.onSyncMessageSuccess=()=>{this.dispatchEvent(new tW.o("",!0))},this.onSyncMessageFailed=()=>{this.dispatchEvent(new tW.o("",!1))},this.onApplicationBackground=()=>{this.dispatchEvent(new tW.a)},this.onApplicationForeground=()=>{this.dispatchEvent(new tW.c)},this.onApplicationExit=()=>{this.dispatchEvent(new tW.b)},this.onNetworkStatusChanged=e=>{this.dispatchEvent(new tW.i(e))},this.onLogout=()=>{this.dispatchEvent(new tW.h)},this.onServiceReady=()=>{this.dispatchEvent(new tW.k)},this.onBeforeUnload=()=>{this.dispatchEvent(new tW.d)},this.registerListener(e,t,a,s)}registerListener(e,t,s,a){var i,n,r,o,l;e.subscribe(((e,t)=>{switch(e){case ve.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG:return this.onOverflowQueue(t);case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t)}})),t.addEventListener(Jc.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(Xc.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(Xc.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(Xc.b.ON_DONE_OFFLINE,this.onDonePullOffline)})),null==a||null===(i=a.addEventListener)||void 0===i||i.call(a,Kg.e.ON_START,this.onStartSyncMessage),null==a||null===(n=a.addEventListener)||void 0===n||n.call(a,Kg.e.ON_RETRY,this.onStartSyncMessage),null==a||null===(r=a.addEventListener)||void 0===r||r.call(a,Kg.e.ON_RESUME,this.onResumeSyncMessage),null==a||null===(o=a.addEventListener)||void 0===o||o.call(a,Kg.e.ON_SUCCESS,this.onSyncMessageSuccess),null==a||null===(l=a.addEventListener)||void 0===l||l.call(a,Kg.e.ON_FAILED,this.onSyncMessageFailed),s.addEventListener(m.b.Idle,this.onApplicationBackground),s.addEventListener(m.b.Active,this.onApplicationForeground),s.addEventListener(m.b.Exit,this.onApplicationExit),s.addEventListener(m.b.ServicesReady,this.onServiceReady),s.addEventListener(m.b.BeforeUnload,this.onBeforeUnload),s.addEventListener(m.b.LogOut,this.onLogout)}onLeaveGroup(e){this.dispatchEvent(new tW.f(e))}onDeleteConv(e){this.dispatchEvent(new tW.e(e))}})||eW)||eW)||eW)||eW)||eW)||eW)||eW)||eW)||eW;var aW,iW,nW,rW,oW,lW,cW,dW,uW,hW,gW,mW,pW,fW,vW=s("Hy6w");class _W{constructor(e,t,s,i,n,r,o,l,c){var d;this.isNew=s,this.isPinned=i,this.isOwnerOrAdmin=n,this.isMuted=r,this.lastActiveTime=o,this.totalMembers=l,this.lastActiveTimeInDays=c,this.segmentController=void 0,this.hasMore=void 0,this.tsCheck=void 0,this.lastMsgId=void 0,this.id=void 0,this.convId=void 0,this.metrics=void 0,this.disabled=!1,this.convId=this.id=t,this.metrics=new bW(t),this.segmentController=e,this.hasMore=!0,this.tsCheck=a.ModuleContainer.resolve(St.b).getTimeNow(),this.lastMsgId=(null===(d=a.ModuleContainer.resolve(En.ConvInfoDataManager).getConvByIdSync(this.convId))||void 0===d?void 0:d.lastSmsLocalId)||"0"}getCursor(){return{value:()=>this.getCurrentCursorValue(),next:e=>this.update(e)}}async update(e){const t=await this.segmentController.get(this.convId),s=await this.segmentController.updateSegment(t,e);this.hasMore=this.isHasMoreMessage(e,s)}disable(){this.disabled=!0}async isDone(){return null===await this.getCurrentCursorValue()}async getCurrentCursorValue(){var e;if(!this.hasMore)return null;if(this.disabled)return null;const t=await this.segmentController.get(this.convId),s=this.getRequestMsgId(t);return null===s?null:{convId:this.convId,requestMsgId:s,lastMsgId:this.lastMsgId,lastDeleteMsgId:(null===(e=t.lastDeletedMsgID)||void 0===e?void 0:e.toString())||"0"}}getRequestMsgId(e){var t,s,a;const i=null!==(t=e.lastDeletedMsgID)&&void 0!==t?t:0,n=null!==(s=e.lastCloudVerifiedDttm)&&void 0!==s?s:0,r=null!==(a=e.cloudSegmentCheckAutoFetch)&&void 0!==a?a:[];if(parseInt(this.lastMsgId.replace(".",""))<=i)return null;if(this.tsCheck>n)return Y.MessageConstants.MAX_MSG_ID;for(let o=r.length-1;o>=0;o--){const[e,t]=r[o];if(i>=t)return null;if(i<e)return String(e)}return null}isHasMoreMessage(e,t){return!!e.hasMore&&this.getRequestMsgId(t)!==e.requestMsgId}}class bW{constructor(e){this.convId=e,this.timeTracker=new IW,this.tsStart=0,this.tsStop=0,this.isDone=!1,this.totalBatch=0,this.totalRetry=0}get metrics(){return a.ModuleContainer.resolve(HV.l).get(HV.k)}start(){this.tsStart=performance.now()}stop(e){this.tsStop=performance.now(),this.isDone=e}exportReport(){const e=this.tsStop||performance.now(),t=this.timeTracker.prepare.time,s=this.timeTracker.fetch.time,a=this.timeTracker.sync.time,i=e-this.tsStart,n=i-(t+s+a);return{convId:this.convId,meta:{isDone:this.isDone,total:this.totalBatch,retry:this.totalRetry},duration:{total:i,prepare:t,fetch:s,save:a,idle:n}}}increaseBatch(){this.totalBatch++}increaseRetry(){this.totalRetry++}submit(){const e=this.exportReport();this.metrics.submitConvReport(e)}}class IW{constructor(){this.prepare=new vW.a("AFMC_prepare"),this.fetch=new vW.a("AFMC_fetch"),this.sync=new vW.a("AFMC_sync")}}class yW extends hs.a{constructor(e){super(iH.OVERFLOW_DB_GROUP_OFFLINE),this.queueId=e}}class SW extends hs.a{constructor(e,t){super(iH.NEXT_CURSOR),this.currCheckpoint=e,this.nextCheckpoint=t}}let CW=(aW=Object(Yr.e)(),iW=Object(WV.d)(),nW=Object(WV.e)(HV.h),rW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)},oW=function(e,t){return Object(Yr.d)(HV.n)(e,void 0,1)},lW=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,2)},cW=function(e,t){return Object(Yr.d)(HV.k)(e,void 0,3)},dW=Reflect.metadata("design:type",Function),uW=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics]),hW=((e=Vx)=>(t,s,a)=>{const i=a.value,n="AsyncFunction"===i.constructor.name;a.value=n?async function(...t){let s=0;for(;;){var a;const[n,r]=await E.c.catchAsyncFn((()=>i.apply(this,t)));if(!n)return r;if(null==e||null===(a=e.onRetry)||void 0===a||a.call(e,n),++s>=e.maxRetry)throw n;e.delay&&await E.c.delay(e.delay+1e3*Math.random())}}:function(...t){let s=0;for(;;){var a;const[n,r]=E.c.catchFn((()=>i.apply(this,t)));if(!n)return r;if(null==e||null===(a=e.onRetry)||void 0===a||a.call(e,n),++s>=e.maxRetry)throw n}}})({maxRetry:3,delay:3e3}),gW=Reflect.metadata("design:type",Function),mW=Reflect.metadata("design:paramtypes",[]),aW(pW=iW(pW=nW(pW=rW(pW=oW(pW=lW(pW=cW(pW=dW(pW=uW((fW=class extends hs.b{constructor(e,t,s,a){super(),this.logger=void 0,this.service=void 0,this.storage=void 0,this.metrics=void 0,this.listCheckpoints=void 0,this.currentCursorIndex=void 0,this.logger=e.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[R.ZLoggerNametags.stateMachine]),this.service=t,this.storage=s,this.metrics=a,this.listCheckpoints=[],this.currentCursorIndex=-1}async init(){var e;const{listGroups:t,evict:s,queueId:i}=await this.service.getGroupsHaveMessageOffline();s&&this.dispatchEvent(new yW(i));const n=t.map((e=>e.convId)),r=a.ModuleContainer.resolve(po);this.listCheckpoints=t.map((e=>new _W(r,e.convId,e.isNewGroupOffline,e.isPinned,e.isOwnerOrAdmin,e.isMuted,e.lastActiveTime,e.totalMembers,e.lastActiveTimeInDays))),this.listCheckpoints.sort(E.b.Sorter.create([{key:"lastActiveTime",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.DES},{key:"isPinned",comparer:E.b.Sorter.Comparer.bool},{key:"isOwnerOrAdmin",comparer:E.b.Sorter.Comparer.bool},{key:"isMuted",comparer:E.b.Sorter.Comparer.bool,order:E.b.Sorter.Order.DES},{key:"lastActiveTimeInDays",comparer:E.b.Sorter.Comparer.number},{key:"totalMembers",comparer:E.b.Sorter.Comparer.number}])),this.currentCursorIndex=0-Number(this.listCheckpoints.length<=0),null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start(),await this.storage.saveConvIds(n),await this.storage.removeOverflowInfo(),this.logger.zsymb(0,"iLllOx","init ledger success",n),-1!==this.currentCursorIndex&&(this.metrics.submitLedgerReport(this.listCheckpoints),E.c.Macrotask.push((()=>{this.dispatchEvent(new SW(null,this.getCurrentCursorValue()))})));return{isEvict:s,isHasNewConv:this.listCheckpoints.some((e=>e.isNew))}}async getRemainCheckpoints(){return-1===this.currentCursorIndex?[]:this.listCheckpoints.slice(this.currentCursorIndex)}async size(){return await this.storage.getRemainConv()}async clear(){await Promise.all([this.storage.saveConvIds([]),this.storage.removeOverflowInfo()]),this.listCheckpoints=[]}getCursor(){return{value:async()=>this.getCurrentCursorValue(),next:async()=>this.handleNextCursor()}}async remove(e){await this.storage.forceRemoveConvId(e);const t=this.listCheckpoints.find((t=>t.id===e));return!!t&&(t.disable(),!0)}getCurrentCursorValue(){var e;return null!==(e=this.listCheckpoints[this.currentCursorIndex])&&void 0!==e?e:null}async handleNextCursor(){const e=this.getCurrentCursorValue();if(e){const t=await e.isDone();t&&await this.storage.removeConvId(e.convId),e.metrics.stop(t),e.metrics.submit()}this.currentCursorIndex++,E.c.Macrotask.push((()=>{var t;null===(t=this.getCurrentCursorValue())||void 0===t||t.metrics.start(),this.dispatchEvent(new SW(e,this.getCurrentCursorValue()))}))}},Object(wk.a)(fW.prototype,"init",[hW,gW,mW],Object.getOwnPropertyDescriptor(fW.prototype,"init"),fW.prototype),pW=fW))||pW)||pW)||pW)||pW)||pW)||pW)||pW)||pW)||pW),EW=function(e){return e.SUCCESS="success",e.FAILED="failed",e.FILLED_BY_SYNC="filled_by_sync",e}({}),OW=function(e){return e.NONE="none",e.CLOSE_APP="close_app",e}({}),MW=function(e){return e.NEW="new",e.RESUME="resume",e.RESUME_AND_NEW="resume_and_new",e}({}),TW=function(e){return e[e.AVG_EXECUTION_TIME_EACH_CONV=151050]="AVG_EXECUTION_TIME_EACH_CONV",e[e.AVG_BATCH=151051]="AVG_BATCH",e[e.AVG_BATCH_RETRY=151052]="AVG_BATCH_RETRY",e[e.AVG_CONV=151053]="AVG_CONV",e[e.AVG_NEW_CONV=151054]="AVG_NEW_CONV",e[e.ERROR_RUNNING=151055]="ERROR_RUNNING",e}({}),wW=function(e){return e.SYNC_MESSAGE="SYNC_MESSAGE",e}({}),RW=function(e){return e.PREPARE_BATCH="PREPARE_BATCH",e.FETCH_MESSAGE="FETCH_MESSAGE",e.PROCESS_MESSAGE="PROCESS_MESSAGE",e}({}),LW=function(e){return e[e.PREPARE_BATCH=0]="PREPARE_BATCH",e[e.FETCH_MESSAGE=1]="FETCH_MESSAGE",e[e.PROCESS_MESSAGE=2]="PROCESS_MESSAGE",e}({});class DW extends eo.a{constructor(e,t){super("ErrorTaskAborted",-1,`Task [type,id]=[${e},${t}] is aborted`)}}let AW=function(e){return e.ABORT="ABORT",e.PAUSE="PAUSE",e.RESUME="RESUME",e.FULFILLED="FULFILLED",e}({});class FW extends hs.b{constructor(){super(),this.id=void 0,this.type=void 0,this.promiseContainer=void 0,this.abortee=void 0,this.status=void 0,this.isPaused=void 0,this.result=void 0,this.error=void 0,this.onAbort=()=>{this.error=new DW(this.type,this.id),this.resolvePromise(),this.dispatchEvent(new hs.a(AW.ABORT))},this.status="idle",this.isPaused=!1,this.abortee=new AbortController,this.promiseContainer=new E.c.Container}exec(e){return this.status="pending",this.abortee.signal.addEventListener("abort",this.onAbort,{once:!0}),E.c.catchPromise(e()).then((([e,t])=>{this.error=e,this.result=t,this.status="fulfilled",this.isPaused||this.resolvePromise()})),this}toPromise(){return this.promiseContainer.promise}pause(){this.isPaused=!0,this.dispatchEvent(new hs.a(AW.PAUSE))}resume(){this.isPaused=!1,this.dispatchEvent(new hs.a(AW.RESUME)),this.abortee.signal.aborted||"fulfilled"===this.status&&this.resolvePromise()}abort(){this.abortee.abort()}resolvePromise(){this.error?this.promiseContainer.reject(this.error):this.promiseContainer.resolve(this.result),this.dispatchEvent(new hs.a(AW.FULFILLED)),this.abortee.signal.removeEventListener("abort",this.onAbort),this.removeAllEventListener()}}class kW extends FW{constructor(){super(),this.id=void 0,this.type="prepare",this.id=++kW.counter}}kW.counter=0;class NW extends FW{constructor(){super(),this.id=void 0,this.type="fetch",this.id=++NW.counter}}NW.counter=0;class PW extends FW{constructor(){super(),this.id=void 0,this.type="process",this.id=++PW.counter}}PW.counter=0;class jW extends FW{constructor(){super(),this.id=void 0,this.type="sleep",this.id=++jW.counter}}jW.counter=0;const UW={isBackground:!1,pausedCounter:0,error:null,totalMessageFetched:0,totalMessageSaved:0,task:null,currentStep:RW.PREPARE_BATCH,convCheckpoint:null,batchRequestInfo:null,batchResponseInfo:null,retryCounter:0};var BW;let zW=Object(WV.d)()(BW=Object(Yr.e)()(BW=Object(WV.e)(HV.i)(BW=function(e,t){return Object(Yr.d)(HV.h)(e,void 0,0)}(BW=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,1)}(BW=function(e,t){return Object(Yr.d)(HV.n)(e,void 0,2)}(BW=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,3)}(BW=function(e,t){return Object(Yr.d)(HV.k)(e,void 0,4)}(BW=function(e,t){return a.ModuleContainer.inject(HV.d)(e,void 0,5)}(BW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,6)}(BW=function(e,t){return Object(Yr.d)(qV)(e,void 0,7)}(BW=function(e,t){return Object(Yr.d)(HV.e)(e,void 0,8)}(BW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,9)}(BW=Reflect.metadata("design:type",Function)(BW=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IDevtoolMonitor?Object:AFMC_IDevtoolMonitor,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(BW=class extends Vg.a{constructor(e,t,s,a,i,n,r,o,l,c){super(),this.logger=void 0,this.config=void 0,this.ledger=void 0,this.service=void 0,this.storage=void 0,this.monitor=void 0,this.metrics=void 0,this.systemTime=void 0,this.socketPolling=void 0,this.eventCollector=void 0,this.currentSessionFetchInfo=void 0,this.pendingGetRemainConvIds=void 0,this.registerSessionFetchListener=()=>{this.logger.zsymb(0,"sJ2odb","register session fetch listener"),this.eventCollector.addEventListener(aH.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.addEventListener(aH.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.addEventListener(aH.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.unregisterSessionFetchListener=()=>{this.logger.zsymb(0,"VarcHm","unregister session fetch listener"),this.eventCollector.removeEventListener(aH.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.removeEventListener(aH.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.removeEventListener(aH.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.onEventChange=e=>{switch(e.type){case"START":this.onMachineStartFetch(),this.registerSessionFetchListener();break;case"STOP":this.unregisterSessionFetchListener(),this.onMachineStopFetch();break;case"NEXT_TO_SLEEP_TO_NEXT_HOUR":this.logger.zsymb(0,"_iKAL3","Busy hour, let sleep to next hour");break;case"TRY_MOVE_TO_NEXT_CONV":this.onFetchConvError(e.data.currConvId);break;case"PROCESS_MESSAGE_SUCCESS":this.storage.saveTotalMessageFetched(e.data.totalMessageFetched);break;case"FAILED":const t=this.interpreter.state.context,{batchRequestInfo:s,currentStep:a}=t,i=`${a}-${null==s?void 0:s.convId}-${null==s?void 0:s.requestMsgId}`;this.logger.zsymb(18,"OXD-cS",`An error ocurred during fetch message ${i}`),this.logger.zsymb(18,"pxyDgZ",e.error),this.metrics.submitErrorRunning(a,e.error)}},this.onEventChangeForDevtool=async e=>{switch(e.type){case"PREPARE_BATCH_SUCCESS":this.monitor.updateBatchRequestInfo(e.data.batchRequestInfo),this.monitor.updateRemainConv(await this.ledger.size()),this.config.get("debugger.logger.batch_request_info")&&this.logger.zsymb(12,"kaKwVO","batch request info",e.data.batchRequestInfo);break;case"PROCESS_MESSAGE_SUCCESS":var t,s;if(this.monitor.updateTotalMessageFetched(e.data.totalMessageFetched),this.config.get("debugger.logger.save_message"))this.logger.zsymb(12,"g9KqtB","save message result",null===(t=e.data.result)||void 0===t?void 0:t.batchInfo,null===(s=e.data.result)||void 0===s?void 0:s.messages.map((e=>e.msgId)));break;case"STOP":this.monitor.updateBatchRequestInfo(null),this.monitor.updateRemainConv(await this.ledger.size())}},this.onTransitionChangeForDevtool=e=>{const t=["idle","running","paused","locked"];for(const s of t)if(e.matches(s))return this.monitor.updateStatus(s)},this.onFetchConvError=async e=>{this.logger.zsymb(18,"IIT5MT","Save conv fetch failed",e),await this.storage.saveConvErrorId(e)},this.onMachineStartFetch=()=>{var e,t;this.metrics.submitStartFetchReport(null!==(e=null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.startType)&&void 0!==e?e:null)},this.onMachineStopFetch=async()=>{var e,t;await this.metrics.submitStopFetchReport((null===(e=this.currentSessionFetchInfo)||void 0===e?void 0:e.startType)||null,(null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.interuptType)||null,await this.ledger.size()),this.currentSessionFetchInfo=null},this.onStartPullDataOffline=()=>{this.pauseMachine(),this.enablePendingGetRemainConv()},this.onStopPullDataOffline=async()=>{var e,t,s,a;let[i,n]=await E.c.catchPromise(this.ledger.size());null!==(e=n)&&void 0!==e||(n=0),n>0&&this.metrics.logResumeFetchAfterInterupt();const[r,o]=await E.c.catchPromise(this.ledger.init());if(null===(t=this.pendingGetRemainConvIds)||void 0===t||t.resolve(),this.pendingGetRemainConvIds=null,r)return this.logger.zsymb(18,"fDx2Fa","An error occured during init ledger",r),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);const{isHasNewConv:l,isEvict:c}=o;if(0===await this.ledger.size())return this.logger.zsymb(0,"80zlEe","stop machine"),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);l&&this.resetMachine(),this.currentSessionFetchInfo={startType:l&&n>0?MW.RESUME_AND_NEW:l&&0===n?MW.NEW:MW.RESUME},null!==(s=this.interpreter)&&void 0!==s&&null!==(a=s.state.history)&&void 0!==a&&a.matches("running")?(this.logger.zsymb(0,"7pomE-","resume machine"),this.resumeMachine()):(this.logger.zsymb(0,"CdTAqW","start machine"),this.startMachine()),this.disablePendingGetRemainConv(),await this.storage.saveStartFetchInfo({evict:c,tsStart:this.systemTime.getTimeNow(),tsSufficient:await this.storage.getLastTsSufficientMessage()})},this.onStartTransferMessage=()=>{this.pauseMachine()},this.onStopTransferMessage=async e=>{const t=await this.ledger.size();t>0&&this.currentSessionFetchInfo&&e.isSuccess&&(this.currentSessionFetchInfo.interuptType=wW.SYNC_MESSAGE),e.isSuccess?(await this.ledger.clear(),this.stopMachine()):this.resumeMachine();t>0&&this.metrics.logStopInteruptFetch(wW.SYNC_MESSAGE,e.isSuccess)},this.onDeleteConv=async e=>{this.logger.zsymb(0,"2tNCtK",`Receive delete conversation ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLeaveGroup=async e=>{this.logger.zsymb(0,"ss9N1H",`Receive leave group ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLoadMessage=e=>{if(!this.config.get("enable_fetch_foreground"))return;this.pauseMachine();const t=this.config.get("debugger.simulator.slow_load_message");e.promiseContainer.promise.then((()=>t?E.c.delay(5e3):void 0)).finally((()=>this.resumeMachine()))},this.onApplicationBackground=()=>{this.backgroundMachine()},this.onApplicationForeground=()=>{this.foregroundMachine()},this.autoStartMachine=()=>{var e,t;null!==(e=this.socketPolling.chatHandler)&&void 0!==e&&e.isDoneOffline&&null!==(t=this.interpreter)&&void 0!==t&&t.state.matches("idle")&&(this.logger.zsymb(0,"AP_nQS","Done offline detected, auto dispatch stop pull offline"),this.onStopPullDataOffline())},this.startMachine=()=>this.send({type:"START"}),this.resetMachine=()=>this.send({type:"RESET"}),this.stopMachine=()=>this.send({type:"STOP"}),this.pauseMachine=()=>this.send({type:"PAUSED"}),this.resumeMachine=()=>this.send({type:"RESUME"}),this.foregroundMachine=()=>this.send({type:"FOREGROUND"}),this.backgroundMachine=()=>this.send({type:"BACKGROUND"}),this.enablePendingGetRemainConv=()=>{var e;null!==(e=this.pendingGetRemainConvIds)&&void 0!==e||(this.pendingGetRemainConvIds=new E.c.Container)},this.disablePendingGetRemainConv=()=>{var e;null===(e=this.pendingGetRemainConvIds)||void 0===e||e.resolve(),this.pendingGetRemainConvIds=null},this.logger=c.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[R.ZLoggerNametags.stateMachine]),this.ledger=e,this.config=t,this.service=s,this.storage=a,this.metrics=i,this.monitor=n,this.systemTime=r,this.socketPolling=o,this.eventCollector=l,this.pendingGetRemainConvIds=null,this.currentSessionFetchInfo=null}createMachine(){return e=this.ledger,t=this.service,Object(rm.a)({id:"afmc-machine-v2",initial:"idle",context:UW,states:{idle:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},running:{id:"running",type:"compound",initial:"checking",states:{checking:{invoke:{src:s=>async a=>{var i;if(null===await e.getCursor().value())return void a({type:"STOP"});const[n,r]=t.checkBusyHour();if(n)a({type:"NEXT_TO_SLEEP_TO_NEXT_HOUR",data:{time:r}});else if("sleep"!==(null===(i=s.task)||void 0===i?void 0:i.type))if(s.isBackground||t.allowFetchForeground())switch(s.currentStep){case RW.PREPARE_BATCH:return void a({type:"NEXT_TO_PREPARE_BATCH"});case RW.FETCH_MESSAGE:return void a({type:"NEXT_TO_FETCH_MESSAGE"});case RW.PROCESS_MESSAGE:return void a({type:"NEXT_TO_PROCESS_MESSAGE"});default:return void a({type:"NEXT_TO_SLEEP"})}else a({type:"NEXT_TO_SLEEP"});else a({type:"NEXT_TO_SLEEP"})}},on:{NEXT_TO_PREPARE_BATCH:{target:"#running.prepareBatch"},NEXT_TO_FETCH_MESSAGE:{target:"#running.fetchMessage"},NEXT_TO_PROCESS_MESSAGE:{target:"#running.processMessage"},NEXT_TO_SLEEP:{target:"#running.sleep"},NEXT_TO_SLEEP_TO_NEXT_HOUR:{target:"#running.sleep"},STOP:{target:"#afmc-machine-v2.idle"}}},prepareBatch:{invoke:{src:t=>async s=>{var a;if("prepare"===(null===(a=t.task)||void 0===a?void 0:a.type))t.task.resume();else{const a=t.task=new kW,n=e.getCursor(),r=await n.value(),o=r.metrics.timeTracker.prepare.getTracker();try{o.start();const e=await a.exec((async()=>{const e=await r.getCursor().value();return null===e?(await n.next(),null):(r.metrics.increaseBatch(),{convCheckpoint:r,batchRequestInfo:e})})).toPromise(),{convCheckpoint:i=null,batchRequestInfo:l=null}=e||{};t.convCheckpoint=r,t.batchRequestInfo=l,i&&l?(t.currentStep=RW.FETCH_MESSAGE,s({type:"PREPARE_BATCH_SUCCESS",data:{batchRequestInfo:l,convCheckpoint:i}})):s({type:"MOVE_TO_NEXT_CONV"})}catch(i){if(i instanceof DW)return;s({type:"FAILED",error:i})}finally{o.end()}}}},on:{PREPARE_BATCH_SUCCESS:{target:"#running.checking",actions:"clearTask"},MOVE_TO_NEXT_CONV:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},fetchMessage:{invoke:{src:e=>async s=>{var a;if("fetch"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new NW,{batchRequestInfo:n,convCheckpoint:r}=e,o=r.metrics.timeTracker.fetch.getTracker();try{o.start();const i=await a.exec((()=>t.fetchMessages(n))).toPromise();e.batchResponseInfo=i,e.currentStep=RW.PROCESS_MESSAGE,s({type:"FETCH_MESSAGE_SUCCESS",data:{batchResponseInfo:i}})}catch(i){if(i instanceof DW)return;s({type:"FAILED",error:i})}finally{o.end()}}}},on:{FETCH_MESSAGE_SUCCESS:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},processMessage:{invoke:{src:e=>async s=>{var a;if("process"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new PW,{batchRequestInfo:r,batchResponseInfo:o,convCheckpoint:l}=e,c=l.metrics.timeTracker.sync.getTracker();try{var i;c.start();const n=o.groupMsgs,d=await a.exec((async()=>{const e=await t.processMessages(r,n);return await l.getCursor().next({messages:n,requestMsgId:r.requestMsgId,lastMsgId:r.lastMsgId,checkLoadTop:!0,hasMore:o.hasMore,minMsgIdFromServer:o.minMsgId,maxMsgIdFromServer:o.maxMsgId}),e})).toPromise();e.totalMessageFetched+=n.length,e.totalMessageSaved+=(null==d||null===(i=d.messages)||void 0===i?void 0:i.length)||0,e.error=null,e.retryCounter=0,e.currentStep=RW.PREPARE_BATCH,s({type:"PROCESS_MESSAGE_SUCCESS",data:{result:d,totalMessageFetched:n.length}})}catch(n){if(n instanceof DW)return;s({type:"FAILED",error:n})}finally{c.end()}}}},on:{PROCESS_MESSAGE_SUCCESS:{target:"#running.sleep",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},sleep:{invoke:{src:(e,s)=>async a=>{var i;if("sleep"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new jW;try{let n=0;switch(s.type){case"NEXT_TO_SLEEP_TO_NEXT_HOUR":case"RETRY":n=s.data.time;break;default:n=t.getThrottle(e.isBackground)}await i.exec((()=>E.c.delay(n))).toPromise(),a({type:"WAKE_UP"})}catch(n){}}}},on:{WAKE_UP:{target:"#running.checking",actions:"clearTask"}}},checkRetry:{invoke:{src:s=>async a=>{var i;const[n,r]=t.checkMaxRetryBatch(s.retryCounter,s.isBackground);if(n){var o;await e.getCursor().next();const t=(null===(o=s.batchRequestInfo)||void 0===o?void 0:o.convId)||"";return s.error=null,s.retryCounter=0,s.currentStep=RW.PREPARE_BATCH,a({type:"TRY_MOVE_TO_NEXT_CONV",data:{currConvId:t}})}return null===(i=s.convCheckpoint)||void 0===i||i.metrics.increaseRetry(),s.retryCounter++,a({type:"RETRY",data:{time:r}})}},on:{RETRY:{target:"#running.sleep"},TRY_MOVE_TO_NEXT_CONV:{target:"#running.sleep"}}}}},paused:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},resume:{invoke:{src:e=>async t=>{e.pausedCounter?t({type:"RESUME_PAUSED"}):t({type:"RESUME_RUNNING"})}},on:{RESUME_PAUSED:{target:"#afmc-machine-v2.paused"},RESUME_RUNNING:{target:"#afmc-machine-v2.running"}}}},on:{PAUSED:{target:"#afmc-machine-v2.paused",actions:["increasePausedCounter","pauseTask","logPausedCounter"]},STOP:{target:"#afmc-machine-v2.idle",actions:["abortTask","resetAll"]},RESET:{actions:"reset"},START:{target:"#afmc-machine-v2.resume",actions:"decreasePausedCounter"},FOREGROUND:{actions:"foreground"},BACKGROUND:{actions:"background"}}},{actions:{attachError:lm.a.assign(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{error:t.error}))),abortTask:e=>{var t;return null!==(t=e.task)&&void 0!==t&&t.abort(),e.task=null},pauseTask:e=>{var t;return null===(t=e.task)||void 0===t?void 0:t.pause()},clearTask:lm.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{task:null}))),increasePausedCounter:lm.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{pausedCounter:e.pausedCounter+1}))),decreasePausedCounter:lm.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{pausedCounter:Math.max(e.pausedCounter-1,0)}))),logPausedCounter:e=>{eH.a},foreground:lm.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{isBackground:!1}))),background:lm.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{isBackground:!0}))),reset:lm.a.assign((({isBackground:e,pausedCounter:t})=>Object(I.a)(Object(I.a)({},UW),{},{isBackground:e,pausedCounter:t}))),resetAll:lm.a.assign((()=>Object(I.a)({},UW)))}});var e,t}start(){super.start(),this.registerListener(),this.autoStartMachine()}stop(){this.unregisterListener(),this.unregisterSessionFetchListener(),super.stop(),this.monitor.updateStatus("disabled")}hasRemainConvInPrevSession(){return null!==this.currentSessionFetchInfo&&this.currentSessionFetchInfo.startType!==MW.NEW}async getRemainConvIds(){var e,t;const s=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!s)return[];var a;!1===("idle"===s.value&&"STOP"===s.event.type)&&(null!==(a=this.pendingGetRemainConvIds)&&void 0!==a||(this.pendingGetRemainConvIds=new E.c.Container));await(null===(t=this.pendingGetRemainConvIds)||void 0===t?void 0:t.promise);return(await this.ledger.getRemainCheckpoints()).map((e=>e.convId))}registerListener(){var e,t,s;(this.logger.zsymb(0,"1ErxZS","register persit listener"),this.eventCollector.addEventListener(aH.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.addEventListener(aH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.addEventListener(aH.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.addEventListener(aH.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.addEventListener(aH.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.addEventListener(aH.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.onEvent(this.onEventChange),eH.a)&&(null===(t=this.interpreter)||void 0===t||t.onEvent(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.onTransition(this.onTransitionChangeForDevtool))}unregisterListener(){var e,t,s;(this.logger.zsymb(0,"ZoNxcC","unregister persit listener"),this.eventCollector.removeEventListener(aH.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.removeEventListener(aH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.removeEventListener(aH.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.removeEventListener(aH.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.removeEventListener(aH.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.removeEventListener(aH.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.off(this.onEventChange),eH.a)&&(null===(t=this.interpreter)||void 0===t||t.off(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.off(this.onTransitionChangeForDevtool))}async handleRemoveConv(e){this.pauseMachine(),await this.ledger.remove(e)?(this.logger.zsymb(0,"nR1GXu",`Disabled checkpoint ${e} success`),this.resetMachine()):this.logger.zsymb(0,"_AkyRD",`Checkpoint ${e} does not exist`),this.resumeMachine()}})||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW)||BW;var GW,xW=s("BYQe");let VW=Object(Yr.e)()(GW=Object(WV.d)()(GW=Object(WV.e)(HV.j)(GW=function(e,t){return Object(Yr.d)(HV.f)(e,void 0,0)}(GW=function(e,t){return Object(Yr.d)(HV.p)(e,void 0,1)}(GW=function(e,t){return Object(Yr.d)(HV.g)(e,void 0,2)}(GW=Reflect.metadata("design:type",Function)(GW=Reflect.metadata("design:paramtypes",["undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler])(GW=class{constructor(e,t,s){this.processor=void 0,this.processor=(new xW.Chain).pipe(e).pipe(t).pipe(s)}async process(e,t){return await this.processor.process({batchInfo:e,messages:t})}})||GW)||GW)||GW)||GW)||GW)||GW)||GW)||GW;var HW;let WW=Object(WV.d)()(HW=Object(Yr.e)()(HW=Object(WV.e)(HV.k)(HW=function(e,t){return a.ModuleContainer.inject(zs.b)(e,void 0,0)}(HW=function(e,t){return Object(Yr.d)(QV)(e,void 0,1)}(HW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,2)}(HW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,3)}(HW=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,4)}(HW=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,5)}(HW=Reflect.metadata("design:type",Function)(HW=Reflect.metadata("design:paramtypes",["undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof IActionlogService?Object:IActionlogService,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(HW=class{constructor(e,t,s,a,i,n){this.logger=void 0,this.qos=void 0,this.config=void 0,this.storage=void 0,this.actionlog=void 0,this.systemTime=void 0,this.qos=e,this.config=n,this.storage=i,this.actionlog=t,this.systemTime=a,this.logger=s.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[R.ZLoggerNametags.metricz])}logAutoHideBannerSuggestion(){this.actionlog.logAction(2460001)}logAutoShowBannerSuggestion(e){this.actionlog.logAction(e?2460003:2460002)}logStartFetch(e,t){switch(this.actionlog.logAction(2460101),t){case rH.ONLY_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460102);break;case rH.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460103)}}logStopFetch(e,t,s){if(!s)return this.actionlog.logAction(2460401);switch(this.actionlog.logAction(2460201),t){case rH.ONLY_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460202);break;case rH.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460203)}}logStopInteruptFetch(e,t){if(e===wW.SYNC_MESSAGE)this.actionlog.logAction(t?2460302:2460303)}logResumeFetchAfterInterupt(){this.actionlog.logAction(2460304)}async submitStartFetchReport(e){if(null===e)return;const t={type:e,total_days_to_fetch:E.j.countDays(await this.storage.getLastTsSufficientMessage(),this.systemTime.getTimeNow()),days_to_fetch_from_new_evict:-1};this.logger.zsymb(12,"XP4and","submit start fetch report",JSON.stringify(t)),this.actionlog.logActionInfoV2(Ia.FeaturesInfo.AutoFetchMessageCloud,2,t)}async submitStopFetchReport(e,t,s){var a,i,n,r;if(null===e)return;const o=await this.storage.getFetchInfo();if(null==o||!o.onProgressInfo)return;const l=this.systemTime.getTimeNow(),c=o.onProgressInfo.totalMsgFetched||0,d={result:t===wW.SYNC_MESSAGE?EW.FILLED_BY_SYNC:s>0?EW.FAILED:EW.SUCCESS,interupted:(()=>{switch(e){case MW.RESUME:case MW.RESUME_AND_NEW:return OW.CLOSE_APP;case MW.NEW:default:return OW.NONE}})(),filled_queue_evict:(()=>{var e;return E.j.countDays(o.onProgressInfo.tsSufficient,l)>this.config.get("max_time_check_insufficient_data")||null!==(e=o.onProgressInfo)&&void 0!==e&&e.evict?0:1})(),estimated_fetching_time:(()=>Math.ceil(c/this.config.get("batch_size"))*this.config.get("throttle")/1e3)(),total_day_with_session_fetch:E.j.countUniqDays(...null!==(a=null==o||null===(i=o.onProgressInfo)||void 0===i?void 0:i.listTsStart)&&void 0!==a?a:[]),days_from_start_to_complete:(()=>{var e,t;const s=Math.min(...null!==(e=null===(t=o.onProgressInfo)||void 0===t?void 0:t.listTsStart)&&void 0!==e?e:[-1]);return s<0?-1:E.j.countDays(s,l)})(),total_conv_fetched:(null===(n=o.onProgressInfo.convIds)||void 0===n?void 0:n.length)||0,conv_fetch_failed:(null===(r=o.onProgressInfo.convErrorIds)||void 0===r?void 0:r.length)||0,total_msg_fetched:c};this.logger.zsymb(12,"I5LNLo","submit stop fetch report",JSON.stringify(d)),this.actionlog.logActionInfoV2(Ia.FeaturesInfo.AutoFetchMessageCloud,1,d),await this.storage.removeStartFetchInfo()}submitConvReport(e){eH.a&&this.logger.zsymb(12,"P9Toi1","submit metrics for conv",e.convId,JSON.stringify(e)),this.qos.log({commandId:TW.AVG_EXECUTION_TIME_EACH_CONV,success:!0,startTime:0,duration:e.duration.total,params:[JSON.stringify(e)]}),this.qos.log({commandId:TW.AVG_BATCH,success:!0,startTime:0,duration:e.meta.total}),this.qos.log({commandId:TW.AVG_BATCH_RETRY,success:!0,startTime:0,duration:e.meta.retry})}submitLedgerReport(e){const t=e.length,s=e.filter((e=>e.isNew)).length;eH.a&&this.logger.zsymb(12,"mWpy67","submit ledger report",JSON.stringify({totalConv:t,totalNewConv:s})),this.qos.log({commandId:TW.AVG_CONV,success:!0,startTime:0,duration:t}),this.qos.log({commandId:TW.AVG_NEW_CONV,success:!0,startTime:0,duration:s})}submitErrorRunning(e,t){this.qos.log({commandId:TW.ERROR_RUNNING,success:!1,startTime:0,errorCode:LW[e],params:[e,t.name,...t.qosParams]})}})||HW)||HW)||HW)||HW)||HW)||HW)||HW)||HW)||HW)||HW)||HW;var qW;let KW=Object(WV.d)()(qW=Object(WV.e)(HV.f)(qW=class{async process(e){const{batchInfo:t,messages:s}=e,a=s.filter((e=>parseInt(e.msgId)>parseInt(t.lastDeleteMsgId)));return{batchInfo:t,messages:a}}})||qW)||qW;var $W;let ZW=Object(Yr.e)()($W=Object(WV.d)()($W=Object(WV.e)(HV.g)($W=function(e,t){return Object(Yr.d)(ZV)(e,void 0,0)}($W=Reflect.metadata("design:type",Function)($W=Reflect.metadata("design:paramtypes",["undefined"==typeof IZSearchV3?Object:IZSearchV3])($W=class{constructor(e){this.zsearchV3=e}async process(e){return this.zsearchV3.executeData(this.filterMessageSearchable(e.messages)),e}filterMessageSearchable(e){return e.filter((e=>{var t;return"chat.delete"!==e.msgType&&"chat.undo"!==e.msgType&&"chat.list.action"!==e.msgType&&"msginfo.actionlist"!==(null===(t=e.content)||void 0===t?void 0:t.action)}))}})||$W)||$W)||$W)||$W)||$W)||$W;var QW;let YW=Object(Yr.e)()(QW=Object(WV.d)()(QW=Object(WV.e)(HV.p)(QW=function(e,t){return Object(Yr.d)($V)(e,void 0,0)}(QW=function(e,t){return Object(Yr.d)(YV)(e,void 0,1)}(QW=Reflect.metadata("design:type",Function)(QW=Reflect.metadata("design:paramtypes",["undefined"==typeof IZStorage?Object:IZStorage,"undefined"==typeof IImportantMsgManager?Object:IImportantMsgManager])(QW=class{constructor(e,t){this.zstorage=e,this.importantMsgManager=t}async process(e){var t;const{batchInfo:s,messages:a}=e,[i,n]=await E.c.catchPromise(this.zstorage.addMessages(s.convId,a,void 0));Qr(i,new RH("Save messages error "+JSON.stringify(i))),this.importantMsgManager.receiveImportantMessage((null==n?void 0:n.messages)||[]);const r=(null!==(t=null==n?void 0:n.messages)&&void 0!==t?t:[]).map((e=>e.msgId));return{batchInfo:s,messages:a.filter((e=>r.includes(e.msgId)))}}})||QW)||QW)||QW)||QW)||QW)||QW)||QW;var JW;let XW=Object(Yr.e)()(JW=Object(WV.d)()(JW=Object(WV.e)(HV.m)(JW=function(e,t){return a.ModuleContainer.inject(po)(e,void 0,0)}(JW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,1)}(JW=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,2)}(JW=Reflect.metadata("design:type",Function)(JW=Reflect.metadata("design:paramtypes",["undefined"==typeof ICloudSegmentController?Object:ICloudSegmentController,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(JW=class{constructor(e,t,s){this.segmentController=e,this.systemTime=t,this.config=s,this.mapTsSplitSegmentRange={},this.tsEvictQueue=void 0,this.tsEvictQueue=this.systemTime.getTimeNow()}process(e){const[t,s]=e;return!s&&this.config.get("enable_segment_updater")&&E.c.Macrotask.push((()=>this.updateSegment(t))),e}getGroupMessages(e){return e.deliverProcessData.groupMsgs}hasEvict(e){var t,s;const a=null!==(t=null==e||null===(s=e.deliverProcessData)||void 0===s?void 0:s.queueStatus)&&void 0!==t?t:{};for(const n of this.config.get("group_queue_config")){var i;if(null!==(i=a[n])&&void 0!==i&&i.evict)return!0}return!1}classifyMessagesByConv(e){const t={};for(const a of e){var s;const e=a.isGroup?a.msgKey:a.idTo;(t[e]=null!==(s=t[e])&&void 0!==s?s:[]).push(a)}return t}async updateSegment(e){const t=this.getGroupMessages(e);if(0===t.length)return;this.hasEvict(e)&&(this.tsEvictQueue=this.systemTime.getTimeNow());const s=this.classifyMessagesByConv(t),a=[];for(const i in s){const e=s[i],t=this.getRange(e);a.push(this.update(i,t,this.getModeMerged(i)))}await Promise.all(a)}getModeMerged(e){var t;let s="merge";return(null!==(t=this.mapTsSplitSegmentRange[e])&&void 0!==t?t:0)<this.tsEvictQueue&&(s="split",this.mapTsSplitSegmentRange[e]=this.systemTime.getTimeNow()),s}getRange(e){e.sort(E.b.Sorter.create([{key:"msgId",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.ASC},{key:"ts",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.ASC}]));const t=e.filter((e=>!isNaN(Number(e.msgId)))),s=t[0],a=t[t.length-1];return[Number(s.msgId),Number(a.msgId)]}async update(e,t,s){const a=await this.segmentController.get(e),i=0===(null!==(n=a.cloudSegmentCheckAutoFetch)&&void 0!==n?n:[]).length?(s="split",null!==(o=a.cloudSegmentCheck)&&void 0!==o?o:[]):null!==(r=a.cloudSegmentCheckAutoFetch)&&void 0!==r?r:[];var n,r,o;const l=this.mergeSegment(t,i);switch(s){case"split":a.cloudSegmentCheckAutoFetch=l;break;case"merge":a.cloudSegmentCheckAutoFetch=this.connectRange(t,l)}await this.segmentController.update(a)}connectRange(e,t){const s=[];for(let a=0;a<t.length;a++){const i=t[a],n=t[a-1];if(AS.a.isEqual(e,i)&&n){const e=n[0],t=i[1];s.pop(),s.push([e,t])}else s.push(i)}return s}mergeSegment(e,t){if(!e||2!==e.length||e[0]>e[1])return t;if(0==t.length)return[e];const s=[],[a,i]=e;let n=0,r=0;for(let o=0;o<t.length;o++){const e=t[o],l=e[0],c=e[1]===parseInt(Y.MessageConstants.MAX_MSG_ID)?e[0]+1:e[1];if(r){s.push(...t.slice(o));break}a>c?(s.push([l,c]),o===t.length-1&&s.push([a,i])):(0===n&&(n=a<l?a:l),i<l?(r=i,s.push([n,r]),s.push([l,c])):i<=c&&i>=l?(r=c,s.push([n,c])):i>c&&o===t.length-1&&s.push([n,i]))}return s}})||JW)||JW)||JW)||JW)||JW)||JW)||JW)||JW;var eq;let tq=Object(WV.d)()(eq=Object(Yr.e)()(eq=Object(WV.e)(HV.q)(eq=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,0)}(eq=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,1)}(eq=function(e,t){return Object(Yr.d)(HV.e)(e,void 0,2)}(eq=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,3)}(eq=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)}(eq=Reflect.metadata("design:type",Function)(eq=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(eq=class{constructor(e,t,s,a,i){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.prevNetworkState=void 0,this.intervalUpdate=void 0,this.onApplicationExit=()=>{this.updateLastSufficientTs(),this.clearIntervalUpdate()},this.onStartPullOffline=()=>{this.clearIntervalUpdate()},this.onStopPullOffline=()=>{this.updateLastSufficientTs(),this.startIntervalUpdate()},this.logger=i.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=a,this.prevNetworkState=null,this.intervalUpdate=null,this.registerListener(s)}registerListener(e){e.addEventListener(aH.a.START_PULL_OFFLINE_DATA,this.onStartPullOffline),e.addEventListener(aH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullOffline),e.addEventListener(aH.a.APPLICATION_EXIT,this.onApplicationExit)}async updateLastSufficientTs(){const e=await this.getLastTsSufficientMessage(),t=this.systemTime.getTimeNow(),s=await this.storage.getLastTsOverflowMessage()>e?e:t;await this.storage.saveLastSufficientMessage(s),this.config.get("debugger.logger.interval_update_sufficient_ts")&&this.logger.zsymb(12,"1emSgE","Update last sufficient ts",s)}async getLastTsSufficientMessage(){const e=await Promise.all([this.storage.getLastTsSyncMessageSuccess(),this.storage.getLastTsImportMessageSuccess(),this.storage.getLastTsAutoFetchMessageSuccess(),this.storage.getLastTsCloseTransferSuggestion(),this.storage.getLastTsCloseFirstLoginTransferSuggestion(),this.storage.getLastTsSufficientMessage()]);return Math.max(...e)}startIntervalUpdate(){this.clearIntervalUpdate(),this.intervalUpdate=setInterval((()=>{this.updateLastSufficientTs()}),this.config.get("interval_check_insufficient_data"))}clearIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||eq)||eq)||eq)||eq)||eq)||eq)||eq)||eq)||eq)||eq;var sq;let aq=Object(WV.d)()(sq=Object(Yr.e)()(sq=Object(WV.e)(HV.r)(sq=function(e,t){return Object(Yr.d)(HV.b)(e,void 0,0)}(sq=function(e,t){return Object(Yr.d)(HV.o)(e,void 0,1)}(sq=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,2)}(sq=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,3)}(sq=function(e,t){return Object(Yr.d)(HV.e)(e,void 0,4)}(sq=Reflect.metadata("design:type",Function)(sq=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(sq=class{constructor(e,t,s,a,i){this.overflowQueueIds=void 0,this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.logger=a.createZLogger(R.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=s,this.overflowQueueIds=[],i.addEventListener(aH.a.OVERFLOW_MESSAGE_QUEUE,(e=>{const t=e.queueId.toString();this.overflowQueueIds.push(t),this.storage.saveLastOverflow(t,this.systemTime.getTimeNow())}))}process(e,t){if(e&&this.config.get("enable_tracking_overflow"))for(const a in e)if(this.config.get("group_queue_config").includes(a)){if(e[a].evict){var s;const e="-1",i=String((null===(s=t[a])||void 0===s?void 0:s.lastId)||1);this.saveOverflowInfo(a,e,i)}}}getOverflowStatus(){const e=!!this.overflowQueueIds.find((e=>this.config.get("group_queue_config").includes(e))),t=!!this.overflowQueueIds.find((e=>this.config.get("one_one_queue_config").includes(e)));return t||e?t&&e?rH.BOTH_1_1_AND_GROUP:t?rH.ONLY_1_1:rH.ONLY_GROUP:rH.NONE}async saveOverflowInfo(e,t,s){const a=await this.storage.getOverflowInfo();(null==a?void 0:a.queueId)!==e&&(await this.storage.saveOverflowInfo(e,t,s),this.logger.zsymb(0,"LNE53_","Overflow detected, let save info",{queueId:e,lastMsgId:t,lastActionId:s}))}})||sq)||sq)||sq)||sq)||sq)||sq)||sq)||sq)||sq)||sq;var iq,nq=s("h5Sw");Object(a.singleton)(HV.l)(iq=Object(m.j)()(iq=Object(m.g)()(iq=Object(WV.c)([sH,WW,XH,IH,CW,gH,sW,XW,YW,VW,zW,ZW,SH,KW,aq,tq,{token:$V,useFactory:()=>we.default},{token:KV,useFactory:()=>_e.default},{token:ZV,useFactory:()=>ll.a.getInstance()},{token:qV,useFactory:()=>Jc.default},{token:QV,useFactory:()=>Ia.default},{token:YV,useFactory:()=>nq.a},{token:JV,useFactory:()=>a.ModuleContainer.resolveIfExist(Gg.a)}])(iq=class{onAuthenticating(){this.get(HV.b)}onStart(){this.get(HV.c).start()}get(e){return WV.a.resolve(e)}})||iq)||iq)||iq);var rq;const oq="z_afmc_devtool_";Object(Ai.b)(HV.d)(rq=function(e,t){return Object(a.inject)(Vr)(e,void 0,0)}(rq=Reflect.metadata("design:type",Function)(rq=Reflect.metadata("design:paramtypes",["undefined"==typeof IMessageController?Object:IMessageController])(rq=class{constructor(e){var t;this.messageController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!0,status:"disabled",totalMessage:0,totalMessageFetched:0,remainConv:0,currentConv:"",currentRequestMsgId:"",totalMessageCurrentConv:0},this.promiseCountTotalMessage=null,this.promiseCountTotalMessageCurrConv=null,this.name="auto-fetch-message-cloud-devtool-monitor",this.key="auto-fetch-message-cloud-devtool-monitor",this.data.isShow=eH.a&&Boolean(Number(null!==(t=n.default.getInstance().getItem(oq))&&void 0!==t?t:"0")),this.toggleUpdateTotalMessage()}toggleDevtool(){!1!==eH.a&&(this.data.isShow=!this.data.isShow,this.data.isShow?n.default.getInstance().setItem(oq,Number(this.data.isShow).toString()):n.default.getInstance().removeItem(oq),Object(Po.h)(this.name,"all"))}updateStatus(e){!1!==eH.a&&(this.data.status=e,Object(Po.h)(this.name,"all"))}async toggleUpdateTotalMessage(){eH.a}async toggleUpdateTotalMessageCurrentConv(){if(!1===eH.a)return;this.promiseCountTotalMessageCurrConv||(this.promiseCountTotalMessageCurrConv=this.messageController.countMessages(this.data.currentConv));const e=await this.promiseCountTotalMessageCurrConv;this.promiseCountTotalMessageCurrConv=null,this.data.totalMessageCurrentConv=e,Object(Po.h)(this.name,"all")}updateTotalMessageFetched(e){!1!==eH.a&&(this.data.totalMessageFetched+=e,Object(Po.h)(this.name,"all"),this.toggleUpdateTotalMessage(),this.toggleUpdateTotalMessageCurrentConv())}updateRemainConv(e){!1!==eH.a&&(this.data.remainConv=e,Object(Po.h)(this.name,"all"))}updateBatchRequestInfo(e){!1!==eH.a&&(this.data.currentConv=(null==e?void 0:e.convId)||"",this.data.currentRequestMsgId=(null==e?void 0:e.requestMsgId)||"",e||(this.data.totalMessageCurrentConv=0),Object(Po.h)(this.name,"all"))}getItem(e,t){return Object(I.a)({},this.data)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||rq)||rq)||rq);var lq,cq=s("n43+");class dq extends hs.a{constructor(){super(cq.a.OVERFLOW_QUEUE)}}class uq extends hs.a{constructor(){super(cq.a.NO_OVERFLOW_QUEUE)}}class hq extends hs.a{constructor(){super(cq.a.E2EE_CHANGE_DEVICE)}}class gq extends hs.a{constructor(){super(cq.a.NO_E2EE_CHANGE_DEVICE)}}class mq extends hs.a{constructor(){super(cq.a.USER_OFFLINE)}}class pq extends hs.a{constructor(){super(cq.a.SOCKET_DONE_PULL_OFFLINE)}}class fq extends hs.a{constructor(e){super(cq.a.DB_CORRUPTION),this.payload=e}}Object(m.f)()(lq=Object(a.injectable)()(lq=Object(Ai.b)(am.b)(lq=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(lq=Reflect.metadata("design:type",Function)(lq=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(lq=class extends hs.b{constructor(e){super(),this.logger=void 0,this.handleDbCorruption=e=>{try{this.dispatchEvent(new fq(e))}catch($Q){this.logger.zsymb(21,"SyKuZv",["Cannot dispatch db corruption {}","yDqK1v"],$Q)}},this.handleEventBus=e=>{try{e===ve.GeneralActions.SOCKET_DONE_PULL_OFFLINE&&(this.dispatchEvent(new pq),_e.default.unsubscribe(this.handleEventBus))}catch($Q){this.logger.zsymb(21,"5Q5o4K",["Cannot dispatch SocketDonePullOfflineEvent: {}","P-Kdu9"],$Q)}},this.onNoE2EEChangeDevice=()=>{try{this.dispatchEvent(new gq),a.ModuleContainer.resolve(Wg.b).removeEventListener(bm.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice)}catch($Q){this.logger.zsymb(21,"0-yak7",["Cannot dispatch NoE2EEChangeDevice: {}","3oQdvY"],$Q)}},this.onUserOffline=()=>{this.dispatchEvent(new mq)},this.onDoneCheckOverflow=e=>{try{if(e.length>0)return void this.dispatchEvent(new dq);this.dispatchEvent(new uq),JI.default.getChatHandler().unsubcribe(Xc.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}catch($Q){this.logger.zsymb(21,"la8IjI",["Cannot dispatch OverflowQueueEvent: {}","eN1GIw"],$Q)}},this.onE2EEChangeDevice=()=>{try{this.dispatchEvent(new hq),a.ModuleContainer.resolve(Wg.b).removeEventListener(bm.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice)}catch($Q){this.logger.zsymb(21,"EiKln9",["Cannot dispatch E2EEChangeDeviceEvent: {}","c4hoKj"],$Q)}},this.logger=e.createZLogger(R.ZLoggerNametags.msgSync,[R.ZLoggerNametags.messageReadinessChecker,R.ZLoggerNametags.eventCollectorMessageReadiness])}onAuthenticated(){this.registerListener()}registerListener(){_e.default.subscribe(this.handleEventBus),a.ModuleContainer.resolve(Ya).addEventListener(hv.USER_OFFLINE,this.onUserOffline),a.ModuleContainer.resolve(Wg.b).addEventListener(bm.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice),a.ModuleContainer.resolve(Wg.b).addEventListener(bm.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice),a.ModuleContainer.resolve(Us.TDBCorruptionDetector).addEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDbCorruption),JI.default.getChatHandler().subcribe(Xc.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}})||lq)||lq)||lq)||lq)||lq);class vq extends hs.a{constructor(){super(Cm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED)}}function _q(e){const t=new Date(e),s=t.getDay(),a=0===s?6:s-1;return t.setDate(t.getDate()-a),t.setHours(0,0,0,0),t.getTime().toString()}let bq=function(e){return e.CHANGE_DEVICE="CHANGE_DEVICE",e.NO_CHANGE_DEVICE="NO_CHANGE_DEVICE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({}),Iq=function(e){return e.OVERFLOW_QUEUE="OVERFLOW_QUEUE",e.NO_OVERFLOW_QUEUE="NO_OVERFLOW_QUEUE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({});let yq=null;const Sq=1,Cq=2,Eq=4,Oq=8,Mq=16,Tq=32,wq=64;var Rq,Lq=s("JTyQ"),Dq=s("NTiX");class Aq{static getInstance(){return null===this.instance&&(this.instance=new Aq),this.instance}constructor(){this.storage=void 0,this.firstLoginChecker=void 0,this.getLastDbCorruptionTimestamp=(e=Mq|Tq|wq)=>{try{return function(){try{let e=a.ModuleContainer.resolve(Dq.b).getObject(Lq.a);if(!e)return!0;if("string"==typeof e)try{e=JSON.parse(e)}catch($Q){return!0}return!e||e[J.p.getSessionUserId()]===O.a.SQLite}catch(e){return!0}}()?Math.max(e&Tq?this.storage.dbCorruptionInfo.getLastSqliteDBCorruptionFullTimestamp():0,e&wq?this.storage.dbCorruptionInfo.getLastSqliteMessageDBCorruptionTimestamp():0):e&Mq?this.storage.dbCorruptionInfo.getLastIndexedDBCorruptionTimestamp():0}catch(t){return 0}},this.isMessageReadyWithIncludeFlags=e=>{const t=this.getLastMissingMessageEventsTimestamp(e),s=a.ModuleContainer.resolve(qg.a).value().lastSync;return 0!=s&&s>t},this.getLastMissingMessageEventsTimestamp=e=>{const t=e&Oq?this.firstLoginChecker.getFirstLoginTime(J.p.getSessionUserId()):0,s=e&Eq?this.storage.changeDeviceLog.changeDeviceTimestamp:0,a=e&Cq?this.storage.overflowQueueLog.lastMessageTimestamp:0,i=e&Sq?this.storage.overflowQueueLog.getOverflowQueueTimestamp():0,n=this.getLastDbCorruptionTimestamp(e);return Math.max(0,i,s,t,a,n)},this.storage=(yq||(yq=a.ModuleContainer.resolve(am.c)),yq),this.firstLoginChecker=a.ModuleContainer.resolve(dv.a)}}Aq.instance=null;const Fq=Object(a.define)("message-readiness-metrics");let kq=Object(a.injectable)()(Rq=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,0)}(Rq=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,1)}(Rq=function(e,t){return a.ModuleContainer.inject(dv.a)(e,void 0,2)}(Rq=Reflect.metadata("design:type",Function)(Rq=Reflect.metadata("design:paramtypes",[void 0===St.ISystemTime?Object:St.ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===dv.IFirstLoginChecker?Object:dv.IFirstLoginChecker])(Rq=class{constructor(e,t,s){this.systemTime=void 0,this.logger=void 0,this.firstLoginChecker=void 0,this.systemTime=e,this.firstLoginChecker=s,this.logger=t.createZLogger(R.ZLoggerNametags.messageReadinessChecker,[R.ZLoggerNametags.metricz])}async updateOnlineHistory(e){const t=_q(this.getTimeNow());let s=this.storage.loginHistory.getHistory(e);s.includes(t)||(s.push(t),s=s.slice(-3),await this.storage.loginHistory.saveHistory(e,s))}logLastTimeUserOffline(){return this.storage.loginHistory.setLastOfflineTimestamp(this.getTimeNow())}async logChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=bq.CHANGE_DEVICE,await this.storage.changeDeviceLog.setChangeDeviceTimestamp(this.getTimeNow()),this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow()),await this.updateOnlineHistory(Cm.b.CHANGE_DEVICE)}async logNoChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=bq.NO_CHANGE_DEVICE,this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow())}logOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=Iq.OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow()),this.storage.overflowQueueLog.setOverflowQueueTimestamp(this.getTimeNow())}logNoOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=Iq.NO_OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow())}logMessageReadinessStatus(){const e=this.getOnlineInfo(),t=this.getShowSyncConfig(),s=this.getMessageReadinessLog();this.actionLogInfoV2(Ia.FeaturesInfo.MessageReadinessStatus,1,Object(I.a)(Object(I.a)(Object(I.a)({},e),t),s))}getMessageReadinessLog(){const e=this.getMissingMessageEventInfo(),t=this.getMessageFulfillmentInfo(),s=+(e.last_missing_msg_event<t.last_success_sync_timestamp);return this.logger.zsymb(0,"RSG7Bb",(()=>[e,t,`messageReadinessStatus: ${s}`])),Object(I.a)(Object(I.a)(Object(I.a)({},e),t),{},{msg_readiness_status:s})}logGetLoginInfoTimestamp(){this.storage.loginHistory.logGetLoginInfoTimestamp(this.getTimeNow())}logApplicationReadyTimestamp(e){this.storage.loginHistory.setApplicationReadyTimestamp(e)}get storage(){return a.ModuleContainer.resolve(am.c)}get setting(){return a.ModuleContainer.resolve(qg.a)}actionLogInfoV2(e,t,s,a,i){Ia.default.logActionInfoV2(e,t,s,a,i)}getTimeNow(){return this.systemTime.getTimeNow()}checkFrequentUsageByLoginType(e){const t=this.storage.loginHistory.getHistory(e),s=_q(this.getTimeNow()-24192e5);return+t[0]>=+s&&t.length>=3}async getLastMessageTimestampWhenOverflowQueue(){const e=El.b.getLastMsgKeyFromServer();if(!e)return 0;const[t,s,a]=e.split("_");try{var i;return+(await(null===(i=zr.b.messageCache)||void 0===i?void 0:i.getMessageAsync(void 0,s,t,a))).sendDttm}catch(n){return 0}}calculateDaysSinceLastOnline(){const e=this.storage.loginHistory.lastOfflineTimestamp;if(e<=0)return 0;return Math.round((this.getTimeNow()-e)/864e5)}async saveLastMessageTimestampWhenOverflowQueue(){const e=await this.getLastMessageTimestampWhenOverflowQueue();e&&this.storage.overflowQueueLog.setLastMessageTimestamp(e)}getOnlineInfo(){return{device_imei:n.default.getInstance().getItem("z_uuid"),multi_device_user:+this.checkFrequentUsageByLoginType(Cm.b.CHANGE_DEVICE),frequently_used_device:+this.checkFrequentUsageByLoginType(Cm.b.NORMAL),changed_device_since_last_login:Number(this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===bq.CHANGE_DEVICE),days_since_last_onl:this.calculateDaysSinceLastOnline()}}getShowSyncConfig(){return{config_sync_suggestion:+!this.setting.value().dontSuggest,config_show_sync_progress:+!this.setting.value().hideProgress}}getMissingMessageEventInfo(){const e=this.firstLoginChecker.getFirstLoginTime(J.p.getSessionUserId()),t=this.storage.changeDeviceLog.changeDeviceTimestamp,s=this.storage.overflowQueueLog.lastMessageTimestamp,a=this.storage.overflowQueueLog.getOverflowQueueTimestamp(),i=Aq.getInstance().getLastDbCorruptionTimestamp();return{last_missing_msg_event:Math.max(a,t,e,i),queue_evicted_last_message_timestamp:s,queue_evicted_timestamp:a,missing_msg_event_device_changed:t,missing_msg_event_first_login:e}}getMessageFulfillmentInfo(){const e=this.setting.value().maxSeq;return{last_msg_fulfilled_timestamp:e,last_msg_sync_timestamp:e,last_msg_import_timestamp:this.storage.importExportLog.lastImportMessageTimestamp,last_success_sync_timestamp:this.setting.value().lastSync}}})||Rq)||Rq)||Rq)||Rq)||Rq)||Rq;a.ModuleContainer.registerSingleton(Fq,kq);const Nq="disable_transfer_full_when_db_corrupt",Pq={enabled:!0,[Nq]:!1},jq=new X.ObjectValidator({enabled:X.Rule.field().boolean(),[`${Nq}`]:X.Rule.field().boolean()});var Uq=new X.AdvancedRemoteConfigs("message_readiness_log",Pq,{validator:jq});const Bq="last_three_weeks_login",zq="last_three_weeks_change_device",Gq="last_msg_timestamp_when_overflow_queue",xq="timestamp_when_overflow_queue",Vq="change_device_e2ee_event_timestamp",Hq="last_time_user_offline",Wq="idb_corrupt_ts",qq="sql_db_corrupt_full_ts",Kq="sql_msg_db_corrupt_ts";class $q{constructor(e){this.adapter=e,this._changedDeviceSinceLastLogin=void 0,this._changeDeviceTimestamp=void 0,this._e2eeSessionChangedTimestamp=void 0,this._changedDeviceSinceLastLogin=bq.NOT_UPDATED_YET,this._changeDeviceTimestamp=0,this._e2eeSessionChangedTimestamp=0}async load(){this._changeDeviceTimestamp=await this.adapter.read(Vq,1)||0}get changeDeviceTimestamp(){return this._changeDeviceTimestamp}get isChangedDeviceSinceLastLogin(){return this._changedDeviceSinceLastLogin}async setChangeDeviceTimestamp(e){this._changeDeviceTimestamp=e,await this.adapter.write(Vq,1,this._changeDeviceTimestamp)}set isChangedDeviceSinceLastLogin(e){this._changedDeviceSinceLastLogin=e}setE2EESessionChangedTimestamp(e){this._e2eeSessionChangedTimestamp=e}getE2EESessionChangedTimestamp(){return this._e2eeSessionChangedTimestamp}}class Zq{constructor(){this._data=void 0,this._secureLocalStorage=void 0,this._data={},this._secureLocalStorage=n.default.getInstance()}get lastImportMessageTimestamp(){try{var e,t;return this._data=Lv(this._secureLocalStorage.getItemForCurrentUser(wl.e)),null!==(e=null===(t=this._data)||void 0===t?void 0:t.lastMessageTimestamp)&&void 0!==e?e:0}catch($Q){return 0}}}class Qq{constructor(e){this.adapter=e,this._loginHistory=void 0,this._changeDeviceHistory=void 0,this._lastOfflineTimestamp=void 0,this._getLoginInfoTimestamp=void 0,this._applicationReadyTimestamp=void 0,this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0,this._getLoginInfoTimestamp=0,this._applicationReadyTimestamp=0}async load(){try{const[e,t,s]=await Promise.all([this.adapter.read(Bq,1),this.adapter.read(zq,1),this.adapter.read(Hq,1)]);this._loginHistory=e||[],this._changeDeviceHistory=t||[],this._lastOfflineTimestamp=s||0}catch(e){this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0}}getHistory(e){switch(e){case Cm.b.NORMAL:return this._loginHistory;case Cm.b.CHANGE_DEVICE:return this._changeDeviceHistory;default:return[]}}async saveHistory(e,t){switch(e){case Cm.b.NORMAL:await this.setLoginHistory(t);break;case Cm.b.CHANGE_DEVICE:await this.setChangeDeviceHistory(t)}}logGetLoginInfoTimestamp(e){this._getLoginInfoTimestamp=e}getCurrentLoginTimestamp(){return this._getLoginInfoTimestamp}setApplicationReadyTimestamp(e){this._applicationReadyTimestamp=e}getApplicationReadyTimestamp(){return this._applicationReadyTimestamp}async setLoginHistory(e){this._loginHistory=e,await this.adapter.write(Bq,1,this._loginHistory)}async setChangeDeviceHistory(e){this._changeDeviceHistory=e,await this.adapter.write(zq,1,this._changeDeviceHistory)}get lastOfflineTimestamp(){return this._lastOfflineTimestamp}async setLastOfflineTimestamp(e){this._lastOfflineTimestamp=e,await this.adapter.write(Hq,1,this._lastOfflineTimestamp)}}class Yq{constructor(e){this.adapter=e,this._isOverflowQueueSinceLastLogin=void 0,this._lastMessageTimestamp=void 0,this._queueEvictEventArriveTimestamp=void 0,this._overflowQueueTimestamp=void 0,this._isOverflowQueueSinceLastLogin=Iq.NOT_UPDATED_YET,this._lastMessageTimestamp=0,this._queueEvictEventArriveTimestamp=0,this._overflowQueueTimestamp=0}async load(){this._lastMessageTimestamp=await this.adapter.read(Gq,1)||0,this._overflowQueueTimestamp=await this.adapter.read(xq,1)||0}get lastMessageTimestamp(){return this._lastMessageTimestamp}async setLastMessageTimestamp(e){this._lastMessageTimestamp=e,await this.adapter.write(Gq,1,this._lastMessageTimestamp)}get isOverflowQueueSinceLastLogin(){return this._isOverflowQueueSinceLastLogin}set isOverflowQueueSinceLastLogin(e){this._isOverflowQueueSinceLastLogin=e}setQueueEvictTimestamp(e){this._queueEvictEventArriveTimestamp=e}getQueueEvictTimestamp(){return this._queueEvictEventArriveTimestamp}async setOverflowQueueTimestamp(e){this._overflowQueueTimestamp=e,await this.adapter.write(xq,1,this._overflowQueueTimestamp)}getOverflowQueueTimestamp(){return this._overflowQueueTimestamp}}class Jq{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("MessageReadinessStorage already initialized");this.key="message_readiness_store"}async read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=await s.getItemForCurrentUserAsync(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}async write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void(await a.setItemForCurrentUserAsync(e,JSON.stringify({version:t,value:s})));this.remove(e)}async remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,await t.removeItemForCurrentUser(e)}}class Xq{constructor(e){this.adapter=e,this.logger=void 0,this._lastIndexedDBCorruptionTimestamp=void 0,this._lastSqliteDBCorruptionFullTimestamp=void 0,this._lastSqliteMessageDBCorruptionTimestamp=void 0,this._lastIndexedDBCorruptionTimestamp=0,this._lastSqliteDBCorruptionFullTimestamp=0,this._lastSqliteMessageDBCorruptionTimestamp=0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.msgSync,[R.ZLoggerNametags.messageReadinessChecker,"daivd"])}async load(){this._lastIndexedDBCorruptionTimestamp=this.adapter.readSharedKey(Wq,1)||0,this._lastSqliteDBCorruptionFullTimestamp=this.adapter.read(qq,1)||0,this._lastSqliteMessageDBCorruptionTimestamp=this.adapter.read(Kq,1)||0}getLastIndexedDBCorruptionTimestamp(){return this._lastIndexedDBCorruptionTimestamp}getLastSqliteDBCorruptionFullTimestamp(){return this._lastSqliteDBCorruptionFullTimestamp}getLastSqliteMessageDBCorruptionTimestamp(){return this._lastSqliteMessageDBCorruptionTimestamp}setIndexedDBCorruptionTimestamp(e){try{this._lastIndexedDBCorruptionTimestamp=e,this.adapter.writeSharedKey(Wq,1,e)}catch($Q){this.logger.zsymb(23,"1JxThb",["setIndexedDBCorruptionTimestamp error: {}","ODXcew"],$Q)}}setSqliteDBCorruptionFullTimestamp(e){try{this._lastSqliteDBCorruptionFullTimestamp=e,this.adapter.write(qq,1,e)}catch($Q){this.logger.zsymb(23,"WQdfZY",["setSqliteDBCorruptionFullTimestamp error: {}","cSWNCx"],$Q)}}setSqliteMessageDBCorruptionTimestamp(e){try{this._lastSqliteMessageDBCorruptionTimestamp=e,this.adapter.write(Kq,1,e)}catch($Q){this.logger.zsymb(23,"jkyDmx",["setSqliteMessageDBCorruptionTimestamp error: {}","z2RaKL"],$Q)}}}class eK{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("MessageReadinessStorage already initialized");this.key="message_readiness_store"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}readSharedKey(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItem(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItem(e)}return null}writeSharedKey(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItem(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}a.ModuleContainer.registerSingleton(am.c,class{constructor(){this._adapter=void 0,this._localStorageAdapter=void 0,this._loginHistoryStore=void 0,this._changeDeviceLogStore=void 0,this._overFlowQueueLogStore=void 0,this._importExportLogStore=void 0,this._dbCorruptionInfoStore=void 0,this._adapter=new Jq,this._localStorageAdapter=new eK,this._loginHistoryStore=new Qq(this._adapter),this._changeDeviceLogStore=new $q(this._adapter),this._overFlowQueueLogStore=new Yq(this._adapter),this._importExportLogStore=new Zq,this._dbCorruptionInfoStore=new Xq(this._localStorageAdapter)}async load(){this.migrate(),this._adapter.load(),this._localStorageAdapter.load(),this._dbCorruptionInfoStore.load(),await Promise.all([this._loginHistoryStore.load(),this._changeDeviceLogStore.load(),this._overFlowQueueLogStore.load()])}get loginHistory(){return this._loginHistoryStore}get changeDeviceLog(){return this._changeDeviceLogStore}get overflowQueueLog(){return this._overFlowQueueLogStore}get importExportLog(){return this._importExportLogStore}get dbCorruptionInfo(){return this._dbCorruptionInfoStore}migrate(){}});var tK,sK=s("Ilem");Object(a.injectable)()(tK=Object(m.f)()(tK=Object(m.d)()(tK=Object(Ai.b)(am.a)(tK=function(e,t){return Object(a.inject)(am.b)(e,void 0,0)}(tK=function(e,t){return Object(a.inject)(Fq)(e,void 0,1)}(tK=function(e,t){return Object(a.inject)(am.c)(e,void 0,2)}(tK=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,3)}(tK=function(e,t){return Object(a.inject)(St.b)(e,void 0,4)}(tK=Reflect.metadata("design:type",Function)(tK=Reflect.metadata("design:paramtypes",[Object,void 0===Fq?Object:Fq,Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===St.ISystemTime?Object:St.ISystemTime])(tK=class extends hs.b{constructor(e,t,s,i,n){super(),this.eventCollector=void 0,this.metrics=void 0,this.config=void 0,this.storage=void 0,this.logger=void 0,this.systemTime=void 0,this.messageReadinessService=void 0,this.isMessageReady=()=>{try{const e=this.metrics.getMessageReadinessLog();return Boolean(e.msg_readiness_status)}catch(e){return this.logger.zsymb(21,"_lSauM",["Error when call isMessageReady: {}","n0TA7z"],e),!1}},this.isMessageReadyWithIncludeFlags=e=>{try{return this.messageReadinessService.isMessageReadyWithIncludeFlags(e)}catch(t){return this.logger.zsymb(21,"cppBHv",["Error when call isMessageReadyWithIncludeFlags {}","wcGyzB"],t),!1}},this.getGetLoginInfoTimestamp=()=>this.storage.loginHistory.getCurrentLoginTimestamp(),this.getApplicationReadyTimestamp=()=>this.storage.loginHistory.getApplicationReadyTimestamp(),this.getDoneCheckOverflowTimestamp=()=>this.storage.overflowQueueLog.getQueueEvictTimestamp(),this.getE2eeSessionChangedTimestamp=()=>this.storage.changeDeviceLog.getE2EESessionChangedTimestamp(),this.isDBCorruptedThatNeedToTransferFull=()=>{try{if(this.config.key(Nq).boolean)return this.logger.zsymb(3,"pg8G0A",["Transfer full when db corrupt is disabled, skip check db corrupted","JxrJ-t"]),!1;const e=this.messageReadinessService.getLastDbCorruptionTimestamp(),t=a.ModuleContainer.resolve(qg.a).value().lastSync,s=e>=t;return this.logger.zsymb(3,"mT7Mxd",["Should transfer full due to db corruption: {},\n\t\t\t\tlastSync: {},\n\t\t\t\tlastDbCorruptTimestamp {}","81M4E0"],s,t,e),s}catch(e){return this.logger.zsymb(21,"VNaYkv",["Can not check isDBCorruptedThatNeedToTransferFull, error {}","hH8R6l"],e),!1}},this.handleDbCorruption=e=>{this.logger.zsymb(3,"JMSOoV",["daivd event corrupt {}","aJCuu0"],e.payload);try{const t=e.payload,s=t.corruptionInfo;if(t.adapterType===O.a.IDB)return void this.storage.dbCorruptionInfo.setIndexedDBCorruptionTimestamp(this.systemTime.getTimeNow());if(t.adapterType!==O.a.SQLite)return;if(s.type===sK.a.FULL)return void this.storage.dbCorruptionInfo.setSqliteDBCorruptionFullTimestamp(this.systemTime.getTimeNow());if("Core"===s.databaseCorruptInfo.database&&"Message"===s.databaseCorruptInfo.table)return void this.storage.dbCorruptionInfo.setSqliteMessageDBCorruptionTimestamp(this.systemTime.getTimeNow())}catch($Q){this.logger.zsymb(21,"eMRJCV",["Cannot dispatch db corruption {}","yDqK1v"],$Q)}},this.handleUserOffline=async()=>{try{await this.metrics.logLastTimeUserOffline()}catch(e){this.logger.zsymb(21,"YS-SxN",["Error when handleUserOffline {}","2N-p2C"],e)}},this.handleOverflowQueue=()=>{try{this.logger.zsymb(3,"vFeP1N",["overflow queue","TZ-NMB"]),this.metrics.logOverflowQueue(),this.eventCollector.removeEventListener(Cm.a.OVERFLOW_QUEUE,this.handleOverflowQueue)}catch(e){this.logger.zsymb(21,"bivJin",["Error when handleOverflowQueue {}","ltwdxT"],e)}},this.handleE2EEChangeDevice=async()=>{try{this.logger.zsymb(3,"VSEXnk",["is e2ee change device","Eex2de"]),await this.metrics.logChangeDevice(),this.eventCollector.removeEventListener(Cm.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice)}catch(e){this.logger.zsymb(21,"wS4ECf",["Error when handleE2EEChangeDevice {}","QEokJ7"],e)}},this.handleDonePullOffline=()=>{try{this.handleMessageReadinessLog(),this.eventCollector.removeEventListener(Cm.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline)}catch(e){this.logger.zsymb(21,"L5Mb0s",["Error when handleDonePullOffline {}","v5r1dc"],e)}},this.handleMessageReadinessLog=async()=>{try{if(this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===Iq.OVERFLOW_QUEUE&&await this.metrics.saveLastMessageTimestampWhenOverflowQueue(),await this.metrics.updateOnlineHistory(Cm.b.NORMAL),!this.isEnabledMessageReadinessLog())return;setTimeout((()=>this.metrics.logMessageReadinessStatus()),3e5)}catch(e){this.logger.zsymb(21,"3yTPvE",["Error when handleMessageReadinessLog {}","Fcl2PX"],e)}},this.handleNoOverflowQueue=()=>{try{this.logger.zsymb(0,"BkEooV","no overflow queue"),this.metrics.logNoOverflowQueue(),this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===bq.NO_CHANGE_DEVICE&&(this.logger.zsymb(2,"AKa-mF","NoMissingMessageEventsArrivedEvent, no overflow triggered "),this.dispatchEvent(new vq)),this.eventCollector.removeEventListener(Cm.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue)}catch(e){this.logger.zsymb(21,"Sn5iOW",["Error when handleNoOverflowQueue {}","_mSLoA"],e)}},this.handleNoE2EEChangeDevice=()=>{try{this.logger.zsymb(3,"7ESKFe",["no e2ee change device","BECHw3"]),this.metrics.logNoChangeDevice(),this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===Iq.NO_OVERFLOW_QUEUE&&(this.logger.zsymb(2,"fpbH1y","all no-missing-message-event events arrived, triggered by no-e2ee-change-device event"),this.dispatchEvent(new vq)),this.eventCollector.removeEventListener(Cm.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice)}catch(e){this.logger.zsymb(21,"1AhcZd",["Error when handleNoE2EEChangeDevice {}","wAQgWM"],e)}},this.eventCollector=e,this.metrics=t,this.config=Uq,this.storage=s,this.systemTime=n,this.messageReadinessService=Aq.getInstance(),this.logger=i.createZLogger(R.ZLoggerNametags.msgSync,[R.ZLoggerNametags.messageReadinessChecker,"daivd"]),this.registerEventListeners()}onAuthenticated(){this.storage.load(),this.metrics.logGetLoginInfoTimestamp()}onApplicationReady(){this.metrics.logApplicationReadyTimestamp(this.systemTime.getTimeNow())}isNoMissingMessageEventsArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===bq.NO_CHANGE_DEVICE;return this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===Iq.NO_OVERFLOW_QUEUE&&e}isAtLeastOneMissingMessageEventArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===bq.CHANGE_DEVICE,t=this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===Iq.OVERFLOW_QUEUE;return Boolean(e||t)}registerEventListeners(){this.eventCollector.addEventListener(Cm.a.USER_OFFLINE,this.handleUserOffline),this.eventCollector.addEventListener(Cm.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice),this.eventCollector.addEventListener(Cm.a.OVERFLOW_QUEUE,this.handleOverflowQueue),this.eventCollector.addEventListener(Cm.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue),this.eventCollector.addEventListener(Cm.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline),this.eventCollector.addEventListener(Cm.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice),this.eventCollector.addEventListener(Cm.a.DB_CORRUPTION,this.handleDbCorruption)}isEnabledMessageReadinessLog(){return this.config.key("enabled").boolean}})||tK)||tK)||tK)||tK)||tK)||tK)||tK)||tK)||tK)||tK);var aK=s("N1xz"),iK=s("CHYU");const nK={auto_restart:!0,auto_restart_conf_no_restart:!0,auto_restart_conf_usage_time:144e5,auto_restart_conf_wss_limit:"2.5GB",auto_restart_conf_mem_limit:"2.5GB",auto_restart_conf_idle_time:6e5,auto_restart_conf_idle_interval_check:[9e5,3e5],auto_restart_ext_entry:!0,auto_restart_entries:[]},rK="restart_ss";var oK;lK=oK=Reflect.metadata("design:type",Function)(oK=Reflect.metadata("design:paramtypes",[])(oK=class extends Fa.MetriczProcessLifecycle.Renderer{constructor(){super(),this.SIDEBAR_TAB_TO_PERSIST=[jo.SidebarTab.MESSAGE_TAB,jo.SidebarTab.CONTACT_TAB,jo.SidebarTab.TODO_TAB],this._logger=void 0,this.running=void 0,this.checkPreviousPersistedStateAfterRestartSilently=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(rK);if(t){this.Logger.zsymb(0,"IfiSNr",`auto-restart: detect prev app state ${t}`);const a=async()=>{e.removeItemForCurrentUser(rK)};try{const e=JSON.parse(t),{tab:s,ts:i,convId:n}=e;let r=6e4;if(Ct.default.getTimeNow()-i>r)return this.Logger.zsymb(18,"btlqDJ",`auto-restart: timeout ${r}, not persist prev app state.`),void a();if(!this.SIDEBAR_TAB_TO_PERSIST.includes(s))return this.Logger.zsymb(18,"5KO6fC",`auto-restart: invalid tab to persist: ${s}`),void a();const o=me.a.ConvListController;if(o.isPreviewLoaded())setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500);else{const e=()=>{setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500),o.removeEventListener(ai.c.LoadPreviewDone,e)};o.addEventListener(ai.c.LoadPreviewDone,e)}}catch(s){a()}}$zsub.$zapp.removeListenAfterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)},this.handleBeforeRestartSilently=()=>{const e=a.ModuleContainer.resolve(jo.SidebarController).getState(),t=e.currentTab;if(this.SIDEBAR_TAB_TO_PERSIST.includes(t)){const s={tab:e.currentTab,ts:Ct.default.getTimeNow()};t===jo.SidebarTab.MESSAGE_TAB&&e.selectedId&&(s.convId=e.selectedId),n.default.getInstance().setItemForCurrentUser(rK,JSON.stringify(s)),this.Logger.zsymb(0,"pYLGD4","auto-restart: persist state before restart {}",s)}else this.Logger.zsymb(6,"sJNReO",`auto-restart: not persist current tab ${t} before restart`)},this.useConfig(nK)}get Logger(){return this._logger||(this._logger=this.createLogger("auto-restart")),this._logger}async appReady(e){this.checkEnabledAutoRestart(e),e.auto_restart&&$zsub.$zapp.afterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)}async appReceiveConfigOnRuntime(e){this.checkEnabledAutoRestart(e)}beforeLogOut(){this.cancelCheckBeforeAppRestartSilently()}checkEnabledAutoRestart(e){if(e.auto_restart){if(this.running)return;this.running=!0,$zsub.$zapp.beforeAppRestartSilently(this.handleBeforeRestartSilently)}else this.cancelCheckBeforeAppRestartSilently()}cancelCheckBeforeAppRestartSilently(){this.running&&$zsub.$zapp.removeListenBeforeAppRestartSilently(this.handleBeforeRestartSilently)}recoverPreviousPersistedState(e,t){this.Logger.zsymb(0,"n27W9f",`auto-restart: start recover previous persisted app state. tab ${e}${t?`; convid ${t}`:""}`);const s=a.ModuleContainer.resolve(jo.SidebarController);if(s.getState().currentTab!==e&&s.changeTab(e),e===jo.SidebarTab.MESSAGE_TAB&&t){const e=a.ModuleContainer.resolve(Q.b);let s=Q.c;t===Ce.default.sendToMeId&&(s=Q.d.fromToolBoxFileTranfer()),s=Object(I.a)(Object(I.a)({},s),{},{silently:!0}),e.openConversation(t,s)}}})||oK)||oK,aK.a.process===iK.b.Render&&(null===(cK=aK.a.ProcessLifecycleController)||void 0===cK||cK.register([lK]));var lK,cK;var dK;const uK={syncSource:null,forceSyncSource:null,isSyncing:!1};Object(Ai.b)(MB.a)(dK=Reflect.metadata("design:type",Function)(dK=Reflect.metadata("design:paramtypes",[])(dK=class{constructor(){this.state=Object(I.a)({},uK),this.name="syc-zcloud-queue-ui",this.key="syc-zcloud-queue-ui"}getSyncSource(){return this.state.syncSource}getForceSyncSource(){return this.state.forceSyncSource}setSyncSource(e){this.setState((t=>{t.syncSource=e}))}setForceSyncSource(e){this.setState((t=>{t.forceSyncSource=e}))}reset(){this.setState((e=>{e.syncSource=null,e.forceSyncSource=null,e.isSyncing=!1}))}isSyncing(){return this.state.isSyncing}setSyncing(e){this.setState((t=>{t.isSyncing=e}))}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(Lg.a)(this.state,e);this.state!==t&&(this.state=t,Object(Po.h)(this.name,"current"))}})||dK)||dK);let hK=function(e){return e[e.Hidden=0]="Hidden",e[e.Success=1]="Success",e[e.Info=2]="Info",e[e.Error=3]="Error",e}({});var gK;const mK={zCloudStatus:{isPaid:!1,hasKey:!1,isMigrated:!1},banner:hK.Hidden,inProgressOffloadSize:0,isShowZCloudOffloadRedDot:!1,offloadingConv:"",error:null,offloadConvNum:0,totalOffloadConvNum:0,offloadSizeConvs:{}};Object(Ai.b)(rz.b)(gK=Reflect.metadata("design:type",Function)(gK=Reflect.metadata("design:paramtypes",[])(gK=class{constructor(){this.name=rz.a,this.key="window_id",this.state=Object(I.a)({},mK)}setItem(e,t){this.setState((s=>{s[e]=t}))}setZCloudStatus(e){this.setState((t=>{t.zCloudStatus=e}))}isZCloudStatusReady(){const{zCloudStatus:e}=this.getState();return e.isPaid&&e.hasKey}setShowZCloudOffloadRedDot(e){this.setState((t=>{t.isShowZCloudOffloadRedDot=e}))}setInProgressOffloadSize(e){this.setState((t=>{t.inProgressOffloadSize=e}))}setError(e){this.setState((t=>{t.error=e}))}setOffloadingConv(e){this.setState((t=>{t.offloadingConv=e}))}setOffloadConvNum(e){this.setState((t=>{t.offloadConvNum=e}))}setTotalOffloadConvNum(e){this.setState((t=>{t.totalOffloadConvNum=e}))}setNewEstimatedSizeConv(e,t){this.setState((s=>{s.offloadSizeConvs=Object(I.a)(Object(I.a)({},s.offloadSizeConvs),{},{[e]:t})}))}resetScanedStates(){this.setState((e=>{e.offloadConvNum=mK.offloadConvNum,e.offloadSizeConvs=mK.offloadSizeConvs}))}reset(){this.setState((e=>{e.banner=hK.Hidden,e.isShowZCloudOffloadRedDot=!1}))}getState(){return this.state}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(Lg.a)(this.state,e);this.state!==t&&(this.state=t,Object(Po.h)(this.name,"current"))}})||gK)||gK);var pK,fK=s("XNYy"),vK=s("/I0A");let _K=Object(a.injectable)()(pK=class{constructor(){this.decodeLocalImage=async e=>{const t=Date.now();try{var s;const t=Dp.b.get(e);if(t)return t.prepared;const a=Date.now();let i;if(dp.a.jxl.version===up.a.V2){const t=await Object(rp.b)(e,{quality:.9},{priority:0});Object(ua.a)(t.length>0,"JitJxlDecoderImpl:decodeLocalImage:failed");const s=t[0].data;i=new Blob([s],{type:"image/jpeg"})}else i=await Object(rp.a)(e);const n=URL.createObjectURL(i);return zconsole.zsymb(3,"VI07Ib",["decodeLocalImage:success: {} -> {}","EhhXtq"],e,n,null===(s=i)||void 0===s?void 0:s.size,Date.now()-a),Dp.b.set(e,i.size,n),ul.default.increaseSuccess(cp.a,0,Date.now()-a),ul.default.increaseSuccess(cp.c,0,Date.now()-a),n}catch($Q){if(Object(vK.a)().zsymb(21,"pVuJIY",["JitJxlDecoderImpl:decodeLocalImage:failed","RgPTTc"],$Q),ul.default.increaseFailed(cp.c,0,0,Object(cp.i)(),t),ul.default.increaseFailed(cp.a,0,0,Object(cp.k)(),t),Object(Lp.l)($Q))throw $Q;throw new Lp.a(9999,"JitJxlDecoderImpl:decodeLocalImage:failed")}}}})||pK;a.ModuleContainer.registerSingleton(fK.a,_K);const bK=Object(a.define)("JIT_MEDIA_CODEC");var IK,yK=s("zEx5");let SK=Object(a.injectable)()(IK=class{decodeLocalImage(e){return a.ModuleContainer.resolve(yK.TJitJxlDecoder).decodeLocalImage(e)}})||IK;a.ModuleContainer.registerSingleton(bK,SK);let CK=function(e){return e[e.Integrity=0]="Integrity",e[e.Strict=1]="Strict",e[e.BestEffort=2]="BestEffort",e}({});const EK={enable_feature:!0,roll_on_exceed_quota:!0,max_alive_account:5,roll_mode:CK.Integrity,roll_buffer_count:0,count_user_in_ls:!1},OK=new ee.a({enable_feature:ee.b.field().boolean(),roll_on_exceed_quota:ee.b.field().boolean(),max_alive_account:ee.b.field().number().min(1),roll_mode:ee.b.field().number().max(CK.BestEffort).min(CK.Integrity),roll_buffer_count:ee.b.field().number().min(0),count_user_in_ls:ee.b.field().boolean()});class MK extends X.ZFeatureConfig{constructor(){super({default:EK,valiator:OK})}selector(e){return e.auto_roll_ls||{}}shouldConfigUpdate(e,t){return!0}}class TK{constructor(e,t,s){this.uid=e,this.keyPath=t,this.lastAccess=s,this.setup=void 0,this.dispose=void 0,this.runner=void 0,this.setup=null,this.runner=null,this.dispose=null}get rawKeyPath(){return this.keyPath.slice(1)}get userIndex(){return this.keyPath.slice(0,1)}installSetup(e){this.setup=e}installRunner(e){this.runner=e}installDispose(e){this.dispose=e}async roll(){this.setup&&await this.setup(),this.runner&&await this.runner(),this.dispose&&await this.dispose()}}class wK extends TK{constructor(e,t,s){super(e,t,s),this.uid=e,this.keyPath=t,this.lastAccess=s,this.runner=async()=>{localStorage.removeItem(this.keyPath)}}}var RK,LK=s("Kfp5");const DK="last_check_exceed_quota",AK=["_z_sc","_cdk","_react","_cl-uc","_rs","_tracking-old-cbb","_pcl-k","_preload_cache","_list_recent_g_search_v2"],FK=152101,kK=152102;Object(m.j)()(RK=Reflect.metadata("design:type",Function)(RK=Reflect.metadata("design:paramtypes",[])(RK=class{constructor(){this.logger=void 0,this.config=void 0,this._quotaExceed=void 0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.localstorage,[R.ZLoggerNametags.lsRoller]),this.config=new MK,this._quotaExceed=null}onAuthenticated(){}onStart(){requestIdleCallback((()=>{this.qosCountAccountInLS(),this.roll()}))}async roll(){if(!this.config.get("enable_feature"))return void this.logger.zsymb(0,"2QvuZY","skip roll, feat disable!");if(!this.isExceededQuota()&&this.config.get("roll_on_exceed_quota"))return void this.logger.zsymb(0,"FGqD6b","skip roll, quota ok!");const e=this.config.get("max_alive_account"),t=this.config.get("roll_mode"),s=this.getUserAccessTimes(),a=s.slice(e);switch(this.logger.zsymb(0,"fEUwJd","start roll: ",t,s.length,a.length),t){case CK.Integrity:this.doRollMatchingKey(a),this.qosRoll(t,a.length);break;case CK.Strict:this.doRollMatchingId(a),this.qosRoll(t,a.length);break;case CK.BestEffort:{const i=this.config.get("roll_buffer_count"),n=e-i;if(this.doRollMatchingId(a),i&&s.length>=n){const t=s.slice(n,e);this.doRollMatchingKey(t)}this.qosRoll(t,s.length-n);break}default:this.logger.zsymb(0,"Kd4ljD","Skip roll, unknow mode!")}}buildRollItems(e){return e.reduce(((e,t)=>(AK.forEach((s=>{const a=`${t.index}${s}`;e.push(new wK(t.uid,a,t.accessTime))})),e)),[])}setupExecutor(e){e.forEach((e=>{"_react"==e.rawKeyPath&&e.installSetup((async()=>{Object(LK.c)(e.uid)}))}))}doRollMatchingKey(e){const t=this.buildRollItems(e);this.setupExecutor(t),this.logger.zsymb(0,"ithJBC","roll matching key: ",t.length),t.length&&Promise.all(t.map((e=>e.roll().catch((t=>{this.logger.zsymb(0,"hywClS","roll item got error: ",e.keyPath,t)})))))}doRollMatchingId(e){if(this.logger.zsymb(0,"kMb-sx","roll matching id: ",e.length),e.length){tu.a.getInstance().cleanupLocalStorageMatchConditions((t=>e.some((e=>t.startsWith(e.index)))))}}isExceededQuota(){if(null!==this._quotaExceed)return this._quotaExceed;this._quotaExceed=!1;try{n.default.getInstance().setItemForCurrentUser(DK,Date.now().toString())}catch(e){this._quotaExceed=22==(null==e?void 0:e.code)}if(!this._quotaExceed){const e=new Blob(Object.values(localStorage)).size;this._quotaExceed=e>=5e6}return this._quotaExceed}getUserAccessTimes(){const e=Object(lv.f)(),t=[];return e&&e.length&&e.forEach(((e,s)=>{t.push(this.getAccesstimeFor(e,s))})),t.sort(((e,t)=>t.accessTime-e.accessTime)),t}getAccesstimeFor(e,t){const s=localStorage.getItem(`${t}_${Y.LAST_TIME_FETCH_ME_PREFIX}`)||0,a=localStorage.getItem(`${t}_${DK}`)||0;return{uid:e,index:t.toString(),accessTime:Math.max(+s,+a)}}qosRoll(e,t){t>0?ul.default.increaseSuccess(FK,e,0,[t]):ul.default.increaseFailed(FK,e,0,-t,Date.now())}qosCountAccountInLS(){if(!this.config.get("count_user_in_ls"))return;const e=this.isExceededQuota(),t=Object(lv.f)().length;this.logger.zsymb(0,"wv97wC","total users in ls: ",e,t),e?ul.default.increaseFailed(kK,0,0,t,Date.now()):ul.default.increaseSuccess(kK,0,0,[t])}})||RK)||RK);var NK,PK=s("HMHh"),jK=s("4Rl+");Object(a.singleton)(PK.e)(NK=Reflect.metadata("design:type",Function)(NK=Reflect.metadata("design:paramtypes",[])(NK=class{constructor(){this.logger=void 0,this.pTracker=void 0,this.lastQueryId=void 0,this.lastQueryId=-1,this.pTracker=new jK.c}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.search,["search-message"])),this.logger}encodeKW(e){return ui.default.md5(e)}async handleResultSearchInChat(e,t,s){const{data:i,hasMore:n,result:r}=s,{id:o,keyword:l,filter:c}=t,d=(null==c?void 0:c.msgType)===Y.MSG_FILE,u=i[i.length-1];let h;d?(h={id:o,keyword:l,convId:e,filter:c,messages:[],files:r,hasMoreFiles:n},u&&u.ts&&(h.lastFileTs=+u.ts)):(h={id:o,keyword:l,convId:e,filter:c,files:[],messages:r,hasMoreMessages:n},u&&u.ts&&(h.lastMessageTs=+u.ts)),a.ModuleContainer.resolve(PK.d).onSearchResult(e,h)}isAllowQueryNoKeyword(e){const{filter:t,config:s}=e;return!!(t&&t.convId&&t.searchForEmpty&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit)}checkAbortQuery(e){if(e<this.lastQueryId)throw new Error(`Query ${e} was aborted`)}async querySearchDB(e){const{keyword:t,filter:s,config:a={},id:i}=e;let n=Object(I.a)(Object(I.a)({},a),{},{enableReject:!0}),r=!1;a.limit&&(n=Object(I.a)(Object(I.a)({},n),{},{limit:a.limit+1}));const o=await ll.a.getInstance().search(t,!0,s,null,n);return this.checkAbortQuery(i),o&&a.limit&&o.length>a.limit&&(r=!0,o.pop()),{data:o,hasMore:r}}async getMessagesAfterQuery(e,t){const{id:s,options:i}=t;let n=await a.ModuleContainer.resolve(PK.f).getMessages(e);this.checkAbortQuery(s);const r=n.length;return n=n.filter((e=>!i||!i.predicate||i.predicate(e))),this.Logger.zsymb(0,"8JfBB1",`get messages id: ${s} total: ${r} after predicate: ${n.length}`),n}async onQueryResponse(e,t){const{filter:s,id:a}=e;return this.checkAbortQuery(a),s&&s.convId&&await this.handleResultSearchInChat(s.convId,e,t),t}async processQuery(e){const{filter:t,id:s,config:a}=e;this.pTracker.start(jK.b.QUERY,s);let{data:i=[],hasMore:n}=await this.querySearchDB(e);this.pTracker.end(jK.b.QUERY),this.pTracker.start(jK.b.GET_MESSAGES,s);let r=await this.getMessagesAfterQuery(i,e);if(this.pTracker.end(jK.b.GET_MESSAGES),n&&a&&r.length<i.length){this.Logger.zsymb(0,"xFQS1i","continue query due to mismatch",s);const o=i[i.length-1].ts,l=[t&&t.timeRange?t.timeRange[0]:0,o],c=Object(I.a)(Object(I.a)({},e),{},{filter:Object(I.a)(Object(I.a)({},t||{}),{},{timeRange:l}),config:Object(I.a)(Object(I.a)({},a),{},{limit:i.length-r.length})}),d=await this.processQuery(c);i=i.concat(d.data),n=d.hasMore,r=r.concat(d.result)}return{data:i,hasMore:n,result:r}}async query(e){const{keyword:t,id:s}=e;if(this.lastQueryId=s,!gl.a.formatTextSearch(t)&&!this.isAllowQueryNoKeyword(e))return this.onQueryResponse(e,{data:[],hasMore:!1,result:[]});this.Logger.zsymb(0,"WQLs0K","start query with params:",Object(I.a)(Object(I.a)({},e),{},{keyword:this.encodeKW(t)}));const a=await this.processQuery(e);return this.onQueryResponse(e,a)}async queryNoKeyword(e){const{filter:t,config:s,id:i}=e;let n=!1,r=[];if(this.Logger.zsymb(0,"OofXH0","start query no kw",e),!(t&&t.convId&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit))return this.onQueryResponse(e,{data:r,hasMore:n,result:[]});const o=t.convId;let l=s;if(s&&s.limit&&(l=Object(I.a)(Object(I.a)({},s),{},{limit:s.limit+1})),t.msgType===Y.MSG_FILE){const c=a.ModuleContainer.resolve(PK.d).getLastResultFile(o);this.pTracker.start(jK.b.GET_MESSAGES,i);const d=await a.ModuleContainer.resolve(PK.f).getFilesForConversation({convId:o,config:l,filter:t,fromMsgId:null==c?void 0:c.msgId});return this.pTracker.end(jK.b.GET_MESSAGES),d.length>s.limit&&(n=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:n,result:d})}const c=a.ModuleContainer.resolve(PK.d).getLastResultMessage(o);this.pTracker.start(jK.b.GET_MESSAGES,i);const d=await a.ModuleContainer.resolve(PK.f).getMessagesForConversation({convId:o,config:l,filter:t,fromMsgId:null==c?void 0:c.msgId});return this.pTracker.end(jK.b.GET_MESSAGES),d.length>s.limit&&(n=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:n,result:d})}abortAllQueries(){ll.a.getInstance().abortSearch()}async jumpToResult(e){const{msgId:t,convId:s,dispatch:a,keyword:i}=e;let n=null;i&&(n={searchKeyWord:i}),this.Logger.zsymb(0,"Ax55sK",`jump to msgId: ${t} convId: ${s} kw: ${i?this.encodeKW(i):""}`),this.pTracker.start(jK.b.JUMP_MESSAGE,t),await ng.a.gotoMessage(t,s,a,n),this.pTracker.end(jK.b.JUMP_MESSAGE)}})||NK)||NK);var UK;Object(a.singleton)(PK.f)(UK=class{async getMessagesForConversation(e){var t,s;const{convId:a,config:i,filter:n,fromMsgId:r}=e,o=Xt.default.getInstance();return await o.Core.Message.index("userId_sendDttm_msgId").getAll({from:[a,null!==(t=n.timeRange)&&void 0!==t&&t[0]?String(n.timeRange[0]):"0","0"],to:[a,null!==(s=n.timeRange)&&void 0!==s&&s[1]?String(n.timeRange[1]):qr.b,r||qr.a],excludeFrom:!1,excludeTo:!1},{partition:a,limit:i.limit,predicate:e=>(!n.fromUid||e.fromUid===n.fromUid)&&(!!gl.a.isMsgSearchable(e)&&!Kr.d.isDeletingInConversation(e)),direction:O.c.PREV})}async getFilesForConversation(e){const{convId:t,config:s,filter:i,fromMsgId:n}=e;if(!s.limit)return[];return(await a.ModuleContainer.resolve(vU.a).getFilesFromConversation(t,s.limit,n||qr.a)).filter((e=>{if(i.fromUid&&i.fromUid!==e.fromUid)return!1;if(i.timeRange){const t=+e.sendDttm;if(i.timeRange[0]&&t<i.timeRange[0])return!1;if(i.timeRange[1]&&t>i.timeRange[1])return!1}return!0}))}deduplicateMessages(e){const t=new Set,s=[];for(const a of e){const e=a.msgId,i=`${a.cliMsgId}_${a.fromUid}_${a.toUid}`;t.has(e)||t.has(i)||(t.add(e),t.add(i),s.push(a))}return s}async getMessagesInConversation(e,t){const s=Xt.default.getInstance();let a=await s.Core.Message.getMulti(t,{partition:e});return a=a.filter((e=>!(!e||!gl.a.isMsgSearchable(e))&&!Kr.d.isDeletingInConversation(e))),a=this.deduplicateMessages(a),a}async getMessages(e){if(!e||!e.length)return[];const t=e.map((({msgId:e})=>e)),s=new Map;e.forEach((({convId:e,msgId:t})=>{const a=s.get(e)||[];a.push(t),s.set(e,a)}));const a=[];s.forEach(((e,t)=>{a.push(this.getMessagesInConversation(t,e))}));const i=(await Promise.all(a)).reduce(((e,t)=>e.concat(t)),[]),n=new Map(i.map((e=>[e.msgId,e]))),r=[];return t.forEach((e=>{const t=n.get(e);t&&r.push(t)})),r}});var BK;Object(Ai.b)(PK.d)(BK=Reflect.metadata("design:type",Function)(BK=Reflect.metadata("design:paramtypes",[])(BK=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.queryPatch=void 0,this.openingSearch=void 0,this.keepCacheItems=void 0,this.name=PK.a,this.key=PK.a,this.data=new Map,this.openingSearch=new Set,this.keepCacheItems=new Set,this.queryPatch=new Map}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(Po.h)(this.name,e)}signalRemoveItem(e){Object(Po.f)(this.name,e)}signalUpdateList(){Object(Po.i)(this.name,this.key)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"g74n1F","Get search in chat data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"zZIa1-","Get search in chat data list failed",e)}isOpeningSearch(e){return this.openingSearch.has(e)}setOpeningSearch(e,t){t?this.openingSearch.add(e):this.openingSearch.delete(e)}clearData(){this.data.size>0&&(this.data.clear(),this.signalUpdateList()),this.queryPatch.size>0&&this.queryPatch.clear()}clearDataItem(e){this.data.has(e)&&(this.data.delete(e),this.signalRemoveItem(e)),this.queryPatch.delete(e)}concatResultList(e,t){const s=new Set,a=[];for(const i of e){const e=`${i.cliMsgId}_${i.fromUid}_${i.toUid}`;s.add(i.msgId),s.add(e),a.push(i)}for(const i of t){const e=`${i.cliMsgId}_${i.fromUid}_${i.toUid}`;s.has(i.msgId)||s.has(e)||(s.add(i.msgId),s.add(e),a.push(i))}return a}isValidPatch(e){const t=this.queryPatch.get(e.convId);return!(!t||t!==e.id)}onSearchResult(e,t){if(!this.isValidPatch(t))return;let s=this.data.get(e);s&&s.id===t.id?(s=Object(I.a)(Object(I.a)({},s),{},{files:this.concatResultList(s.files,t.files),messages:this.concatResultList(s.messages,t.messages)}),void 0!==t.hasMoreFiles&&(s.hasMoreFiles=t.hasMoreFiles),void 0!==t.hasMoreMessages&&(s.hasMoreMessages=t.hasMoreMessages),void 0!==t.lastFileTs&&(s.lastFileTs=t.lastFileTs),void 0!==t.lastMessageTs&&(s.lastMessageTs=t.lastMessageTs)):s=t,this.data.set(e,s),this.signalUpdateItem(e)}getSearchResult(e){return this.data.get(e)}getLastResultMessage(e){const t=this.data.get(e);return null==t?void 0:t.messages[t.messages.length-1]}getLastResultFile(e){const t=this.data.get(e);return null==t?void 0:t.files[t.files.length-1]}getLastResultFileTs(e){const t=this.data.get(e);return null==t?void 0:t.lastFileTs}getLastResultMessageTs(e){const t=this.data.get(e);return null==t?void 0:t.lastMessageTs}onStartSearch(e,t){this.queryPatch.set(e,t)}onSelectResultItem(e,t){const s=this.data.get(e);s&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedResultItem:t})),this.signalUpdateItem(e))}})||BK)||BK);var zK;Object(Ai.b)(PK.g)(zK=Reflect.metadata("design:type",Function)(zK=Reflect.metadata("design:paramtypes",[])(zK=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.promoteCache=void 0,this.name=PK.c,this.key=PK.c,this.data=new Map,this.promoteCache=new MO.a(PK.b)}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(Po.h)(this.name,e)}signalRemoveItem(e){Object(Po.f)(this.name,e)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"86WI5V","Get search promote data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"9ReOtH","Get search promote data list failed",e)}isPromoteAt(e){const{position:t,version:s}=e,a=this.promoteCache.getItem(t);return!a||s>a}promoteAt(e){const{position:t,version:s,autoClose:a}=e;this.promoteCache.setItem(t,s),this.data.set(t,{version:s,promote:!0}),this.signalUpdateItem(t),a&&a>0&&setTimeout((()=>{this.closePromoteAt({position:t,version:s})}),a)}closePromoteAt(e){const{position:t,version:s}=e;this.isPromoteAt(e)&&this.promoteCache.setItem(t,s);const a=this.data.get(t);a&&a.promote&&(this.data.delete(t),this.signalRemoveItem(t))}})||zK)||zK);s("+bFI");ie.a.register(UM.e.Call,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var GK=s("rI+G");ie.a.register(UM.e.Contact,((e,t)=>{const{isMultiSelectOn:s,message:a}=e;if(s)return[];let i=null;if(a.message.action===Y.MessageContentAction.User){let e=Object(fe.b)(a);e&&e.phone&&(i=new GK.CopyNumberMenuItem(e.phone))}return[i].filter(Boolean)}));var xK=s("0bqf"),VK=s("aODc"),HK=s("XOIG"),WK=s("vRKI");function qK(e){if(Ee.l)return!1;if(!e)return!1;let{flag:t}=Object(Je.b)(e);return!!(t&It.d.local)}var KK=s("HyDr"),$K=s("Vi1T");function ZK(e,t){var s;e&&(null===(s=Iw.a.for(e))||void 0===s||s.collect(t))}function QK(e,t,s){const{message:a,source:i,windowId:n}=e||{},r=a.toUid;xK.b.downloadMessage(a||{},{src:xK.a.CHAT,targetId:r}),Object(ge.c)(a,ge.a.UserAction),i===KK.a.ContextMenu?(Ia.default.logAction(1063914),Object(VK.a)(10,a)):Ia.default.logAction(106380410),pl.a.addUserAction(n,"Download"),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{event:t,message:s}=e||{};Object(bU.downloadWebV2ByMsg)(t,window.document,s,!0),xK.c.log(xK.c.ACT.VIEW,{src:xK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e,t,s){const{message:a}=e||{},{manualDownloadMediaDoneHandler:i}=Object(q.c)();Object($K.a)(a,hr.c,{actions:i,entryType:oe.f.File})}(e)}ie.a.register(UM.e.File,(function(e,t){const{detail:s,isMultiSelectOn:a,message:i}=e||{};if(a||!i)return[];let n,r;return ZK(null==s?void 0:s.trackingCmdId,"FileMessage: start build ctx menu"),function(e){const{message:t}=e||{};return!!t&&!Object(m_.r)(t)&&!Object(m_.J)(t)&&Object(WK.a)(t)}({message:i})&&(n=new HK.s,n.setHandler((t=>{try{var a;null==t||t.stopPropagation(),null===(a=n.getMenu())||void 0===a||a.close();const i=n.getWindowId();QK(Object(I.a)(Object(I.a)({},e),{},{windowId:i}),null==s||s.fileData,null==s||s.fileHandler)}catch($Q){}}))),ZK(null==s?void 0:s.trackingCmdId,"FileMessage: check SaveFileToDevice done"),qK(i)&&(r=new HK.x,r.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=r.getMenu())||void 0===s||s.close(),function(e){const{message:t,source:s}=e||{};xK.b.showMessageInFolder(t,{targetId:t.toUid,src:xK.a.CHAT}),s===KK.a.ContextMenu?(Ia.default.logAction(1063913),Object(VK.a)(11,t)):Ia.default.logAction(106380409),Ia.default.logAction(107190901),Object(bw.default)(e.message)}(e)}catch($Q){}}))),ZK(null==s?void 0:s.trackingCmdId,"FileMessage: build ctx menu done"),[n,r].filter(Boolean)})),ie.a.register(UM.e.GIF,((e,t)=>{const{event:s,detail:a,isMultiSelectOn:i,message:n}=e||{};if(!s||!n||i)return[];let r,o;return[r,o].filter(Boolean)}));var YK=s("IBuc"),JK=s("P7Ey");function XK(e){for(;null!=e&&e.firstChild;)e.removeChild(e.firstChild)}var e$=function(e,t){const s=t||window,a=s.getSelection();if("string"==typeof e&&a&&"Range"===a.type&&a.rangeCount>0){const t=s.document.getElementById(e);if(t){const i=a.getRangeAt(0),n=i.commonAncestorContainer;if(t.contains(n)){if(n.nodeType===Node.ELEMENT_NODE&&"rtf-container"===(null==n?void 0:n.getAttribute("data-component")))return()=>"";const{content:e}=Object(JK.a)(s);return e||a.toString()}{const t=i.cloneContents();if(null!=t&&t.getElementById(e))return XK(t),t=>{try{const s=t||window,a=s.getSelection();if(null===a)return"";const i=a.getRangeAt(0).cloneContents();let n=i.getElementById(e);if(XK(i),null==n)return"";s.document.body.appendChild(n);const r=new Range;r.selectNodeContents(n),a.removeAllRanges(),a.addRange(r);const o=a.toString();return r.deleteContents(),a.removeAllRanges(),s.document.body.removeChild(n),n=null,o}catch($Q){return""}};XK(t)}}}};function t$(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===Y.DataAttributes.Element.EMAIL)}function s$(e){if(!e||"function"!=typeof e.getAttribute)return!1;const t=e.getAttribute("data-z-element-type");return t===Y.DataAttributes.Element.RTF_TEXT?e.classList.contains("text-is-link"):Boolean(t===Y.DataAttributes.Element.LINK)}function a$(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===Y.DataAttributes.Element.PHONE_NUMBER)}function i$(e,t){var s;e&&(null===(s=Iw.a.for(e))||void 0===s||s.collect(t))}ie.a.register(UM.e.Link,((e,t)=>{const{detail:s,event:a,isMultiSelectOn:i,message:n,source:r}=e||{};if(!a||!n||i)return[];i$(null==s?void 0:s.trackingCmdId,"LinkMessage: start build ctx menu");const o=Object(m_.Y)(n);let l=null;if(!o)if(r===KK.a.MessageFloatingMenu)l=new GK.CopyLinkMenuItem(n.message.href);else{const e=a.view,t=e$(null==s?void 0:s.linkMessageContainerId,e);if(i$(null==s?void 0:s.trackingCmdId,"LinkMessage: check selectedContent"),t)"string"==typeof t?l=new GK.CopySelectedContentMenuItem(t):"function"==typeof t&&(l=new GK.CopySelectedContentMenuItem(""),l.setHandler((()=>{const s=t(e);s?Object(YK.a)(s):e.document.execCommand("copy"),l.getMenu().close()})));else{var c;const e=a.target,t=null!==(c=a.currentTarget)&&void 0!==c?c:a._currentTarget;if(null!=t&&t.id&&(null==t?void 0:t.id)===(null==s?void 0:s.linkContentContainerId))l=new GK.CopyLinkMenuItem(n.message.href);else if(s$(e)&&e.textContent)l=new GK.CopyLinkMenuItem(n.message.href);else if(t$(e)&&e.textContent)l=new GK.CopyEmailMenuItem(e.textContent);else if(a$(e)&&e.textContent)l=new GK.CopyNumberMenuItem(e.textContent);else if(""===n.message.title||n.message.title===n.message.href)l=new GK.CopyLinkMenuItem(n.message.href);else{const e=n.message.title||n.message.href;l=new GK.CopyMessageContentMenuItem(e)}}}return i$(null==s?void 0:s.trackingCmdId,"LinkMessage: build ctx menu done"),[l].filter(Boolean)})),ie.a.register(UM.e.Location,((e,t)=>{const{isMultiSelectOn:s}=e;return[]})),ie.a.register(UM.e.OA,((e,t)=>{const{detail:s,isMultiSelectOn:a}=e;if(a)return[];const{indexOAChild:i=0}=s||{},{message:n}=e;let r={href:"",title:""};Array.isArray(n.message)&&(r=n.message[i]);let o=null;return r.href?o=new GK.CopyLinkMenuItem(r.href):r.title&&(o=new GK.CopyMessageContentMenuItem(r.title)),[o].filter(Boolean)}));var n$=s("4X16"),r$=s("RUNN");var o$=s("knYB"),l$=s("kWKb");function c$(e){const{message:t}=e,s=t.message,a={},i=s.length,n=JSON.parse(s[0].message.params);if(n.total_item_in_group===i){const e=s.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(m_.i)(e)));e.forEach((t=>{Object(ge.c)(t,ge.a.UserAction);const s=ui.default.getConversationType(t.toUid||t.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(oe.f.Photo).withConvType(oe.b[s]).withMode(oe.e.Manual).withCode(oe.d.CBVMessageAction);e.msgType==Y.MSG_VIDEO&&i.withType(oe.f.Video),a[t.msgId]=i.build()})),ue.a.getInstance().downloadWithMultiSrc("runByMultiMsg",e,{entriesCode:a,saveAs:!0}).then((t=>{e.forEach((e=>{if(e.msgId&&t[e.msgId]){const{downloadError:s,localPath:a}=t[e.msgId]||{};((e,t,s)=>{const a=Date.now();!e&&Ce.default.recent_photo.enableFeature&&ui.default.isWindows()&&Oe.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:a,name:$znode.path.basename(s),shortenPath:ui.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})})(s,e.msgId,a)}}))})).catch((e=>{}))}else{const e=s[i-1];we.default.getGroupPhoto(e.msgId,n.total_item_in_group-i,e.toUid).then((e=>{Array.prototype.push.apply(s,e);const t=s.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(m_.i)(e)));t.forEach((e=>{Object(ge.c)(e,ge.a.UserAction);const s=ui.default.getConversationType(e.toUid||e.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(oe.f.Photo).withConvType(oe.b[s]).withMode(oe.e.Manual).withCode(oe.d.CBVMessageAction);t.msgType==Y.MSG_VIDEO&&i.withType(oe.f.Video),a[e.msgId]=i.build()})),ue.a.getInstance().downloadWithMultiSrc("runByMultiMsg",t,{entriesCode:a,saveAs:!0})}))}}function d$(e){const{message:t}=e;!1!==Array.isArray(t.message)&&(ce.b.getStateNetwork()===ce.a.CONNECTED?(Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{message:t}=e;let s="";const a=t.toUid,i=t.message;s=Object($c.a)(a)?hn.default.getDName(a):Ii.default.getDName(a),s||(s="");const n=i.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(m_.i)(e)));n.forEach((e=>{Object(ge.c)(e,ge.a.UserAction)})),l$.a.downloadMultiFiles(n,s).catch((e=>{let t=le.a.str("STR_DOWNLOAD_FAILED_DETAILS");t=e&&"string"==typeof e&&e.startsWith("ERR_")?`${t}: ${e}`:`${t}: ERR_UNKNOWN`,Wo.default.createError(t)}))}(e):c$(e)):Wo.default.createError(le.a.str("STR_TOAST_CONNECTION_FAILED")))}function u$(e){const{message:t,source:s,windowId:a}=e||{},i=t.toUid;xK.b.downloadMessage(t||{},{src:xK.a.CHAT,targetId:i}),Object(ge.c)(t,ge.a.UserAction),s===KK.a.ContextMenu?(Ia.default.logAction(1063914),Object(VK.a)(10,t)):Ia.default.logAction(106380410),Ce.default.cloud_send2me.enable&&i==Ce.default.sendToMeId&&yR.b.log(yR.a.DOWNLOAD,1,t),pl.a.addUserAction(a,"Download"),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{event:t,message:s}=e||{};Object(bU.downloadWebV2ByMsg)(t,window.document,s,!0),xK.c.log(xK.c.ACT.VIEW,{src:xK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e){const{message:t}=e||{};if(Ia.default.logAction(1071908),!t.message.oriUrl)return void Wo.default.createError(le.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(q.c)();Object($K.a)(t,hr.c,{actions:s,entryType:oe.f.Video,additional:{type:tt.default.constants.DownloadType.Video}})}(e)}function h$(e){const{event:t,message:s}=e||{};Object(bU.downloadWebV2ByMsg)(t,window.document,s,!0),xK.c.log(xK.c.ACT.VIEW,{src:xK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}function g$(e){const{message:t,source:s,windowId:a}=e||{};if(t.msgType===Y.MSG_VIDEO)return void u$(e);const i=t.toUid;xK.b.downloadMessage(t||{},{src:xK.a.CHAT,targetId:i}),Object(ge.c)(t,ge.a.UserAction),s===KK.a.ContextMenu?(Ia.default.logAction(1063914),Object(VK.a)(10,t)):Ia.default.logAction(106380410),Ce.default.cloud_send2me.enable&&i==Ce.default.sendToMeId&&yR.b.log(yR.a.DOWNLOAD,1,t),pl.a.addUserAction(a,"Download");const n=[Y.MSG_PHOTO,Y.MSG_PHOTO_2].some((e=>e===t.msgType));Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l||n&&!Object(he.a)()?h$(e):function(e){const{message:t}=e||{};if(Ia.default.logAction(1071908),!t.message.oriUrl)return void Wo.default.createError(le.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(q.c)();Object($K.a)(t,hr.c,{actions:s,entryType:oe.f.Photo,additional:{type:tt.default.constants.DownloadType.Photo}})}(e)}const m$={ok:!1,messages:[]};function p$(e,t){var s;const{detail:a,event:i,isMultiSelectOn:n,message:r}=e||{};if(!i||n||!r)return[];const{captionContainerElementId:o=""}=a||{};let l;const c=null!==(s=i.currentTarget)&&void 0!==s?s:i._currentTarget;(function(e){const{message:t}=e||{};return!(!t||Ee.l)&&!Object(m_.t)(t)&&!Object(m_.l)(t)&&!Object(m_.u)(t)&&!Object(m_.n)(t)&&!Object(m_.V)(t)&&Object(r$.a)(t)})({message:r})&&(null!=c&&c.id&&(null==c?void 0:c.id)===o||(l=new GK.CopyPhotoMenuItem));let d,u,h=null;if(r.message.title){const e=i.view,t=e$(o,e);if(t)"string"==typeof t?h=new GK.CopySelectedContentMenuItem(t):"function"==typeof t&&(h=new GK.CopySelectedContentMenuItem(""),h.setHandler((()=>{const s=t(e);s?Object(YK.a)(s):e.document.execCommand("copy"),h.getMenu().close()})));else{const e=i.target;let t;s$(e)?(t=Object(o$.a)(e),h=new GK.CopyLinkMenuItem(t)):h=t$(e)&&(t=e.textContent)?new GK.CopyEmailMenuItem(t):a$(e)&&(t=e.textContent)?new GK.CopyNumberMenuItem(t):new GK.CopyMessageContentMenuItem(r.message.title)}}return function(e){const{message:t}=e||{};return!!t&&!Object(m_.r)(t)&&!Object(m_.n)(t)&&!Object(m_.J)(t)&&Object(WK.a)(t)}({message:r})&&(d=new GK.SavePhotoToDeviceMenuItem,d.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=d.getMenu())||void 0===s||s.close();const a=d.getWindowId();g$(Object(I.a)(Object(I.a)({},e),{},{windowId:a}))}catch($Q){}}))),[l,h,d,u].filter(Boolean)}function f$(e,t){const{event:s,isMultiSelectOn:a,message:i}=e||{};if(!s||a||!i)return[];let n;const r=function(e){if(!e)return m$;if(e.message.length<=0)return m$;if(!0===Boolean(Object(n$.e)(e.message)))return m$;if(!1===Object(n$.b)(e.message))return m$;const t=Object(n$.g)(e.message);return 0===t.length?m$:{ok:!0,messages:t}}(i);return!0===r.ok&&(n=new GK.SaveGroupPhotoToDeviceMenuItem(r.messages.length),n.setHandler((()=>{var t;null===(t=n.getMenu())||void 0===t||t.close();try{d$(e)}catch($Q){}}))),[n].filter(Boolean)}ie.a.register(UM.e.Photo,((e,t,...s)=>{const{event:a,message:i}=e||{};return a?i.msgType===Y.MSG_PHOTO_GROUP&&Array.isArray(i.message)?f$(e):p$(e):[]})),ie.a.register(UM.e.AISticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(UM.e.NewFSSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(UM.e.PhotoSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(UM.e.NoBorderPhotoSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(UM.e.Sticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||null==n||!n.message)return[];const r=[];return[Y.MSG_STICKER,Y.MSG_STICKER_2].includes(n.msgType)&&null!=n.message.catId&&r.push(new GK.ViewStickerSetMenuItem),r})),ie.a.register(UM.e.StickerGroup,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||null==n||!n.message)return[];const r=[],o=1===n.message.length?n.message[0]:null;if(o&&[Y.MSG_STICKER,Y.MSG_STICKER_2].includes(o.msgType)&&null!=o.message.catId){const e=new GK.ViewStickerSetMenuItem;e.getBuilder().fromMessage(o),r.push(e)}return r})),ie.a.register(UM.e.StickerSet,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(UM.e.Text,((e,t)=>{const{event:s,isMultiSelectOn:a,message:i}=e||{};if(!s||a||!i)return[];const n=(null==t?void 0:t.getAttribute("id"))||"";let r=null;const o=s.view,l=e$(n,o);if(l)"string"==typeof l?r=new GK.CopySelectedContentMenuItem(l):"function"==typeof l&&(r=new GK.CopySelectedContentMenuItem(""),r.setHandler((()=>{const e=l(o);e?Object(YK.a)(e):o.document.execCommand("copy"),r.getMenu().close()})));else{const e=s.target;let t;s$(e)?(t=Object(o$.a)(e),r=new GK.CopyLinkMenuItem(t)):t$(e)&&(t=e.textContent)?r=new GK.CopyEmailMenuItem(t):a$(e)&&(t=e.textContent)?r=new GK.CopyNumberMenuItem(e.textContent):Object(m_.E)(i)?(r=new GK.CopyMessageContentMenuItem(""),r.setHandler((()=>{var e;let t="",s=document.getElementById(Y.MSG_TEXT_CONTENT_ID_PREFIX+i.msgId);s&&(t=s.outerHTML),Object(YK.a)(null===(e=i.message)||void 0===e?void 0:e.title,t)}))):(t=i.message,r=new GK.CopyMessageContentMenuItem(t))}return[r].filter(Boolean)}));var v$=s("+ed7");class _$ extends v$.a{constructor(e){super(e)}}var b$=_$;ie.a.register(UM.e.Video,((e,t)=>{const{detail:s,event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||!n)return[];let r;r=null!=n.UIContent?n.UIContent.caption:n.message.title;let o=null;if(r){const{captionContainerElementId:e=""}=null!=s?s:{},t=a.view,i=e$(e,t);if(i)"string"==typeof i?o=new GK.CopySelectedContentMenuItem(i):"function"==typeof i&&(o=new GK.CopySelectedContentMenuItem(""),o.setHandler((()=>{const e=i(t);e?Object(YK.a)(e):t.document.execCommand("copy"),o.getMenu().close()})));else{const e=a.target;let t;s$(e)?(t=Object(o$.a)(e),o=new GK.CopyLinkMenuItem(t)):o=t$(e)&&(t=e.textContent)?new GK.CopyEmailMenuItem(t):a$(e)&&(t=e.textContent)?new GK.CopyNumberMenuItem(t):new GK.CopyMessageContentMenuItem(n.message.title)}}let l=null;return function(e){const{message:t}=e||{};return!!t&&!Object(m_.r)(t)&&!Object(m_.J)(t)&&Object(WK.a)(t)}({message:n})&&(l=new b$,l.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=l.getMenu())||void 0===s||s.close();const a=l.getWindowId();u$(Object(I.a)(Object(I.a)({},e),{},{windowId:a}))}catch($Q){}}))),[o,l].filter(Boolean)})),ie.a.register(UM.e.Voice,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var I$,y$=s("dBRD");Object(a.injectable)()(I$=Object(Ai.b)(y$.b)(I$=Reflect.metadata("design:type",Function)(I$=Reflect.metadata("design:paramtypes",[])(I$=class{constructor(){this.justAddedMessagesOfConvStateMap_=new Map,this.isDevEnv_=void 0,this.separator_="<|>",this.name=y$.a,this.type=void 0,this.key="",this.isDevEnv_=!1}addJustAddedMessage(e,t,s=!0){if(!e)return;if(!t)return;const a=Array.isArray(t)?t:[t],i={};for(let n=a.length-1;n>=0;n--){const e=a[n],t=J.p.getSessionUserId()===e.fromUid?"0":e.fromUid,s=this.buildJustAddedMessageStateKey({fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId});s&&(i[s]={fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId,src:e.src})}this.justAddedMessagesOfConvStateMap_.set(e,{convId:e,aSet:i}),s&&Object(Po.h)(this.name,this.key)}isJustAddedMessage(e){if(!e)return!1;const t=this.getConvIdFromThreeKeyMsgId(e);if(!t)return!1;const s=this.justAddedMessagesOfConvStateMap_.get(t);return!(!s||!s.aSet)&&null!=s.aSet[e]}removeJustAddedMessage(e,t=!0){if(!e)return;const s=this.getConvIdFromThreeKeyMsgId(e),a=this.justAddedMessagesOfConvStateMap_.get(s);if(!a||!a.aSet[e])return;const i=Object(I.a)({},a.aSet);delete i[e],this.justAddedMessagesOfConvStateMap_.set(s,{convId:s,aSet:i}),t&&Object(Po.h)(this.name,e)}getJustAddedMessageList(e){const t=this.getASetOfJustAddedMessage(e);return Object.values(t)}getASetOfJustAddedMessage(e){if(!e)return{};const t=this.justAddedMessagesOfConvStateMap_.get(e);return t&&t.aSet?t.aSet:{}}buildJustAddedMessageStateKey(e){return e&&null!=e.fromUid&&null!=e.toUid&&null!=e.cliMsgId?[e.fromUid,e.toUid,e.cliMsgId].join(this.separator_):""}getConvIdFromThreeKeyMsgId(e){if(!e)return"";return e.split(this.separator_)[1]}init(){}getItem(e){const t=e.key;if(t)return this.justAddedMessagesOfConvStateMap_.get(t)}getList(e){return[]}onGetItemFailure(e,t){this.isDevEnv_}onGetListFailure(e,t){this.isDevEnv_}})||I$)||I$)||I$);var S$=s("bUFI");const C$="z_chatbg_reset";var E$;Object(a.singleton)(S$.a)(E$=Object(m.j)()(E$=class{onStart(){this.switchDefaultOffBgChat()}switchDefaultOffBgChat(){const e=n.default.getInstance();if(!e.getItemForCurrentUser(C$)){this.isUseChatBackground()&&(Me.g.setUseChatBg(J.p.getSessionUserId(),!1),_e.default.send(ve.GeneralActions.CHANGE_BG_CHAT,!1)),e.setItemForCurrentUser(C$,"1")}}isUseChatBackground(){const e=J.p.getSessionUserId();return Boolean(Me.g.useChatBg(e))}})||E$);var O$=s("uPsl");class M${constructor(){this.onDeleteMessage=this.onDeleteMessage.bind(this),this.registerEvents()}dispose(){}static create(){return new M$}static getInstance(){return M$.instance||(M$.instance=M$.create()),M$.instance}registerEvents(){hi.a.instance.on("delete-message-only-me",this.onDeleteMessage)}cancelUpload(e){O$.a.emit("cancel-upload",e)}onDeleteMessage(e){if(e.type===ve.ChatBoxActions.DELETE_MESSAGE){const{payload:t}=e;if(Array.isArray(t.messages)){const e=new Set;t.messages.forEach((t=>{t&&t.cliMsgId&&("file"===t.mediaType||"image"===t.mediaType)&&e.add(t.cliMsgId)})),e.size>0&&Array.from(e).forEach((e=>{this.cancelUpload(e)}))}}}}M$.instance=void 0,M$.create();var T$=s("+pEX"),w$=s("AWVP"),R$=s("Iq7B");class L${constructor(e,t,s,a,i){this.name=void 0,this.code=void 0,this.data=void 0,this.message=void 0,this.details=void 0,this.name=e,this.code=t,this.message=s,this.details=a,this.data=i,Object(T$.a)().error(`${this.name}[${this.code}]:${this.message}`,this.details)}}class D$ extends L${constructor(e,t,s){super("HttpApiError",w$.e.HTTP_API,e,s),this.data=void 0,this.data=t}}class A${async sendSeenSubChatTab(e){try{const t=H.b.getChatDomain(),s=R$.b,a=`${t}${s}${`?${this.getCommonParams_()}`}`,i=ro.a.newReq(),n={msgInfos:JSON.stringify({seens:e}),imei:Zl.a.getZaloClientID()},r=`params=$${this.encodeParams_(n)}`,o=await Jr.default._post(a,r,{retry:0},R$.a,void 0,!1,i),l=await Object(Xr.a)(o),{status:c}=null!=l?l:{};return w$.b.Success(0==c)}catch(i){var t,s,a;const e={status:null==i?void 0:i.status,errorCode:null!==(t=null==i?void 0:i.error_code)&&void 0!==t?t:null==i?void 0:i.code,message:null!==(s=null!==(a=null==i?void 0:i.error_message)&&void 0!==a?a:null==i?void 0:i.message)&&void 0!==s?s:""};return w$.b.Failure(new D$("Cannot send seen sub chat tab.",e,e))}}getCommonParams_(){return Jr.default._getCommonParams()}encodeParams_(e){return Jr.default._encodeParams(e)}}class F$ extends L${constructor(e,t,s){super("WSSApiError",w$.e.WSS_API,e,s),this.data=void 0,this.data=t}}class k${async getLastSeenSubChatTab(e){const t={subtabs:e};try{const e=await XI.a.instance().requestAsyncV2({cmd:Xc.j.GET_LAST_SEEN_SUB_CHAT_TAB,subCmd:0,data:{data:t}});if(0!=e.error_code){const s={errorCode:e.error_code,message:e.error_message},a=Object(I.a)(Object(I.a)({},s),{},{params:JSON.stringify(t)}),i="Cannot get last seen sub chat tab.";return w$.b.Failure(new F$(i,s,a))}return w$.b.Success({clearUnreadInfo:e.data.clearUnreadInfo})}catch(n){var s,a,i;const e={errorCode:null!==(s=null==n?void 0:n.error_code)&&void 0!==s?s:null==n?void 0:n.code,message:null!==(a=null!==(i=null==n?void 0:n.error_message)&&void 0!==i?i:null==n?void 0:n.message)&&void 0!==a?a:""},r=Object(I.a)(Object(I.a)({},e),{},{params:JSON.stringify(t)}),o="Cannot get last seen sub chat tab.";return w$.b.Failure(new F$(o,e,r))}}}var N$,P$=s("1HgD"),j$=s("Ui4J");Object(a.injectable)()(N$=Object(a.singleton)(P$.a)(N$=Reflect.metadata("design:type",Function)(N$=Reflect.metadata("design:paramtypes",[])(N$=class{constructor(){this.httpApi_=void 0,this.wssApi_=void 0,this.currentSyncSeenSubtabReq_=null,this.httpApi_=new A$,this.wssApi_=new k$,JI.default.getChatHandler().subcribe(Xc.b.ON_DONE_OFFLINE,this.pullOfflineLastSeenSubChatTabIfNeeded_.bind(this))}sendSeenSubChatTab_(e,t){let s=!1;const a=null==t?void 0:t.signal;return a&&a.addEventListener("abort",(()=>s=!0)),new Promise(((t,a)=>{const i=j$.a(),n=Object(Mp.a)((async()=>{const t=await this.httpApi_.sendSeenSubChatTab(e);return"error"===t.type?Promise.reject(t.data):Promise.resolve(t.data)}),{min:i.min,max:i.max,step:i.step,retries:i.retries,shouldRetryOnError:({error:e})=>new Promise((t=>{var a;if(s)return t(!1);if(!e)return t(!1);const i=null===(a=e.data)||void 0===a?void 0:a.errorCode;if(-69===i)return t(!1);return[Y.NetWorkError.NO_NETWORK,Y.NetWorkError.TIMEOUT,Y.NetWorkError.TIMEOUT_SENT].includes(i)?t(!0):t(111!==i)}))});n().then((e=>{t(w$.b.Success(e))})).catch((e=>{t(w$.b.Failure(e))}))}))}syncSeenSubChatTab(e){const t={abortController:new AbortController,payload:{seens:e}};if(this.currentSyncSeenSubtabReq_){const s=this.currentSyncSeenSubtabReq_,a=[...s.payload.seens,...e].reduce(((e,t)=>{const s=t.sct+"_"+t.id;if(e[s]=t,e[s]){const a=e[s],i=t.msgId>a.msgId?t.msgId:a.msgId;e[s]=Object(I.a)(Object(I.a)({},t),{},{msgId:i})}else e[s]=t;return e}),Object.create(null));t.payload.seens=Object.values(a),s.abortController.abort()}this.currentSyncSeenSubtabReq_=t,this.sendSeenSubChatTab_(t.payload.seens,{signal:t.abortController.signal}).finally((()=>{this.currentSyncSeenSubtabReq_===t&&(this.currentSyncSeenSubtabReq_=null)}))}onReceiveSeenSubChatTab_(e,t=w$.a.Unknown){Object(T$.a)().info(`[${t}] Receive seen sub chat tab.`,{seens:e});const s=a.ModuleContainer.resolve(Qo.TUnreadSubChatTabStateManager),i=e.map((e=>({type:+e.idTo,msgId:e.lastMsgId})));s.onReceiveSeenSubChatTab(i)}async pullOfflineLastSeenSubChatTabIfNeeded_({msgId:e,msgKey:t}){if(Object(T$.a)().info("[PullOffline] Start sync when done offline.",{msgId:e,msgKey:t},1),Ce.default.socket.enable_ctrl_socket){const t=e||null,s=a.ModuleContainer.resolve(Qo.TUnreadSubChatTabStateManager).getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(t);if(!s.length)return;const i=s.map((e=>({sct:w$.c.SubChatTab,id:e}))),n=await this.wssApi_.getLastSeenSubChatTab(i);"success"===n.type?this.onReceiveSeenSubChatTab_(n.data.clearUnreadInfo,w$.a.Wss_PullOffline):Object(T$.a)().error("[PullOffline] Cannot get last seen sub chat tab.")}else Object(T$.a)().info("[PullOffline] Socket is not enabled. -> Skip.")}onReceiveSeenSubChatTabFromCtrl(e){this.onReceiveSeenSubChatTab_(e,w$.a.Wss_Response)}})||N$)||N$)||N$);var U$=s("TtB7"),B$=s("BjT2");const z$="s_s_m_prxk",G$="l_r_m_i";class x${constructor(){this.seenMilestoneAtSubtab_={[w$.d.ARCHIVED]:void 0,[w$.d.FOCUSED]:void 0},this.lastReceivedMsgInfoAtSubtab_={[w$.d.ARCHIVED]:void 0,[w$.d.FOCUSED]:void 0}}setNewSeenMilestone(e,t){this.seenMilestoneAtSubtab_[e]=t;const s=n.default.getInstance(),a=`${z$}::${e}`;s.setItemForCurrentUser(a,t)}getLastSeenMilestone(e){var t;let s=this.seenMilestoneAtSubtab_[e];if(null!=s)return s;const a=n.default.getInstance(),i=`${z$}::${e}`;return s=null!==(t=a.getItemForCurrentUser(i))&&void 0!==t?t:"",this.seenMilestoneAtSubtab_[e]=s,s}setNewReceivedMsgInfo(e,t){this.lastReceivedMsgInfoAtSubtab_[e]=Object(I.a)({},t);const s=n.default.getInstance(),a=`${G$}::${e}`;s.setItemForCurrentUser(a,JSON.stringify(t))}getLastReceivedMsgInfo(e){var t,s;if(null!=this.lastReceivedMsgInfoAtSubtab_[e])return this.lastReceivedMsgInfoAtSubtab_[e];const a=n.default.getInstance(),i=`${G$}::${e}`,r=null!==(t=a.getItemForCurrentUser(i))&&void 0!==t?t:"";return r?(this.lastReceivedMsgInfoAtSubtab_[e]=null!==(s=JSON.parse(r))&&void 0!==s?s:{convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e]):(this.lastReceivedMsgInfoAtSubtab_[e]={convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e])}}var V$,H$=s("7l8h");Object(Ai.b)(B$.b)(V$=function(e,t){return Object(a.inject)(H$.c)(e,void 0,0)}(V$=function(e,t){return Object(a.inject)(m.a)(e,void 0,1)}(V$=Reflect.metadata("design:type",Function)(V$=Reflect.metadata("design:paramtypes",["undefined"==typeof IUnreadSubChatTabNetworkService?Object:IUnreadSubChatTabNetworkService,"undefined"==typeof BaseApplication?Object:BaseApplication])(V$=class{constructor(e,t){this.unreadSubChatTabStateStore_=void 0,this.storage_=void 0,this.networkService_=void 0,this.key=U$.a,this.name=B$.a,this.storage_=new x$,this.networkService_=e,this.handleReceiveLatestMessage=this.handleReceiveLatestMessage.bind(this),this.handleReceiveLatestMessage_=this.handleReceiveLatestMessage_.bind(this),this.handleChangeSubtab=this.handleChangeSubtab.bind(this),this.hasUnreadSubChatTab=this.hasUnreadSubChatTab.bind(this),this.handleDisplayMessageTab=this.handleDisplayMessageTab.bind(this),this.handleHideMessageTab=this.handleHideMessageTab.bind(this),this.handleUpdateArchivedChat=this.handleUpdateArchivedChat.bind(this),this.handleMoveConvFromHiddenToArchivedChat=this.handleMoveConvFromHiddenToArchivedChat.bind(this),this.handleShowReddotsAtSubChatTab=this.handleShowReddotsAtSubChatTab.bind(this),t.addEventListener(m.b.Idle,this.handleMainApplicationInBackground_.bind(this)),t.addEventListener(m.b.Active,this.handleMainApplicationInForeground_.bind(this))}handleReceiveLatestMessage(e){e&&e.convId&&this.isRightMsgIdString_(e.msgId)?this.handleReceiveLatestMessage_(e):Object(T$.a)().error("[Event] Receive latest message - Invalid info.",{info:e},1)}handleReceiveLatestMessage_(e){const{convId:t,msgId:s}=e,a=this.getSubtabTypeOfConv(t);if(!this.isValidSubChatTabType(a))return;const i=this.getLastReceivedMsgInfo_(a);(!i.msgId||i.msgId<s)&&this.saveNewReceivedMsgInfo_(a,{convId:t,msgId:s})}getSubtabTypeOfConv(e){let t=w$.d.NONE;return Zo.a.isArchivedChat(e)?t=w$.d.ARCHIVED:un.a.isThreadHidden(e)||(t=w$.d.FOCUSED),t}handleShowReddotsAtSubChatTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);this.getAllValidSubtabs().forEach((s=>{if(t===s)return;const a=this.hasUnreadSubChatTab(s),i=e[s];if(a!==i){let e=this.getUnreadSubChatTabStateStore_()[s];e=Object(I.a)(Object(I.a)({},e),{},{hasUnread:i}),this.getUnreadSubChatTabStateStore_()[s]=e,Object(Po.h)(this.name,this.key)}}))}handleMoveConvFromHiddenToArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,w$.d.ARCHIVED)}handleUpdateArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,w$.d.ARCHIVED)}handleMoveConvToArchiveChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,w$.d.ARCHIVED)}handleMoveConvToFocusedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,w$.d.FOCUSED)}handleChangeSubtab(e,t){const s={fromSubtab:e,toSubtab:t};Object(T$.a)().info("[Event] Change subtab.",s);const a=[];if(this.isValidSubChatTabType(t)){const e=this.getLastReceivedMsgInfo_(t);if(e.msgId){let s=this.getUnreadSubChatTabStateStore_()[t];s=Object(I.a)(Object(I.a)({},s),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[t]=s,this.saveNewSeenMilestone_(t,e.msgId),Object(Po.h)(this.name,this.key),a.push({sct:w$.c.SubChatTab,msgId:e.msgId,id:t})}}if(this.isValidSubChatTabType(e)){const t=this.getLastReceivedMsgInfo_(e),s=this.getLastSeenMilestone_(e);t.msgId&&t.msgId>s&&(this.saveNewSeenMilestone_(e,t.msgId),a.push({sct:w$.c.SubChatTab,msgId:t.msgId,id:e}))}a.length&&this.networkService_.syncSeenSubChatTab(a)}handleDisplayMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(T$.a)().info("[Event] Display message tab.",{info:e,enteringSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],a=this.getLastReceivedMsgInfo_(t),i=this.getLastSeenMilestone_(t);if(a.msgId&&a.msgId>i){const e=a.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:w$.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}handleHideMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(T$.a)().info("[Event] Hide message tab.",{info:e,leavingSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],a=this.getLastReceivedMsgInfo_(t),i=this.getLastSeenMilestone_(t);if(a.msgId&&a.msgId>i){const e=a.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:w$.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,t){const s=me.a.UnreadDataManager.getUnreadByConvIdSync(e);if(!s)return;const a=s.lastProcessMsgId;if(!a)return;const i=this.getLastSeenMilestone_(t);i&&i>=a||this.saveNewSeenMilestone_(t,a)}handleMainApplicationInForeground_(){const e=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(T$.a)().info(`[Event] Main application in foreground - enteringSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),a=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>a){const a=s.msgId;this.saveNewSeenMilestone_(e,a),t.push({sct:w$.c.SubChatTab,id:e,msgId:a})}t.length&&this.networkService_.syncSeenSubChatTab(t)}handleMainApplicationInBackground_(){const e=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(T$.a)().info(`[Event] Main application in background - leavingSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),a=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>a){const a=s.msgId;this.saveNewSeenMilestone_(e,a),t.push({sct:w$.c.SubChatTab,id:e,msgId:a})}t.length&&this.networkService_.syncSeenSubChatTab(t)}onReceiveSeenSubChatTab(e){e.forEach((({type:e,msgId:t})=>{if(this.isValidSubChatTabType(e)){const s=t,a=this.getLastSeenMilestone_(e);if(s&&s>a){let t=this.getUnreadSubChatTabStateStore_()[e];t=Object(I.a)(Object(I.a)({},t),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[e]=t,this.saveNewSeenMilestone_(e,s),Object(Po.h)(this.name,this.key)}}}))}hasUnreadSubChatTab(e){var t;return!!this.isValidSubChatTabType(e)&&(null!==(t=this.getUnreadSubChatTabStateStore_()[e].hasUnread)&&void 0!==t&&t)}isValidSubChatTabType(e){return this.getAllValidSubtabs().includes(e)}convetFilterTypeToSubChatTabType(e){return e===ii.d.FOCUSED?w$.d.FOCUSED:e===ii.d.ARCHIVED?w$.d.ARCHIVED:w$.d.NONE}getAllSeenMilestones(){return this.getAllValidSubtabs().reduce(((e,t)=>(e[t]=this.getLastSeenMilestone_(t),e)),{})}getAllValidSubtabs(){return[w$.d.FOCUSED,w$.d.ARCHIVED]}getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(e){const t=[];return this.getAllValidSubtabs().forEach((s=>{(e||this.hasUnreadSubChatTab(s))&&t.push(s)})),t}getUnreadSubChatTabStateStore_(){return this.unreadSubChatTabStateStore_||(this.unreadSubChatTabStateStore_=this.getAllValidSubtabs().reduce(((e,t)=>(e[t]={type:t,hasUnread:!1},e)),{})),this.unreadSubChatTabStateStore_}isRightMsgIdString_(e){return!!e&&("string"==typeof e&&!e.includes("object"))}saveNewSeenMilestone_(e,t){this.isValidSubChatTabType(e)?this.isRightMsgIdString_(t)?this.storage_.setNewSeenMilestone(e,t):Object(T$.a)().error("[SaveNMS] Invalid newMilestone.",{newMilestone:t},1):Object(T$.a)().error("[SaveNMS] Invalid subchat tab type.",{type:e},1)}getLastSeenMilestone_(e){if(!this.isValidSubChatTabType(e))return"";let t=this.storage_.getLastSeenMilestone(e);return t&&!this.isRightMsgIdString_(t)&&(Object(T$.a)().error("[GetLSM] Get invalid milestone.",{milestone:t},1),t="",this.storage_.setNewSeenMilestone(e,t)),t}saveNewReceivedMsgInfo_(e,t){this.isValidSubChatTabType(e)?t&&t.convId&&this.isRightMsgIdString_(t.msgId)?this.storage_.setNewReceivedMsgInfo(e,t):Object(T$.a)().error("[SaveNRMI] Invalid msgId.",{info:t},1):Object(T$.a)().error("[SaveNRMI] Invalid subchat tab type.",{type:e},1)}getLastReceivedMsgInfo_(e){if(!this.isValidSubChatTabType(e))return{convId:"",msgId:""};let t=this.storage_.getLastReceivedMsgInfo(e);return t.msgId&&!this.isRightMsgIdString_(t.msgId)&&(Object(T$.a)().error("[GetLRMI] Get invalid msgId.",{lastReceivedMsgInfo:t},1),t={convId:"",msgId:""},this.storage_.setNewReceivedMsgInfo(e,t)),t}init(){}getItem(e){if(e.key===this.key)return this.unreadSubChatTabStateStore_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||V$)||V$)||V$)||V$);s("UCdJ");var W$,q$=s("qhMx"),K$=s("wKHS");Object(m.j)()(W$=Object(m.h)()(W$=Object(a.singleton)(q$.RRCConfig)(W$=Reflect.metadata("design:type",Function)(W$=Reflect.metadata("design:paramtypes",[])(W$=class{constructor(){this.isAppIdle=void 0,this.changeListeners=void 0,this.onAppIdle=()=>{this.isAppIdle=!0,this.signalConfigChange()},this.onAppActive=()=>{this.isAppIdle=!1,this.signalConfigChange()},this.isAppIdle=!1,this.changeListeners=[]}signalConfigChange(){for(const e of this.changeListeners)try{e(this.getConfig())}catch{}}onStart(){const e=a.ModuleContainer.resolve(m.a);e.addEventListener(m.b.Idle,this.onAppIdle),e.addEventListener(m.b.Active,this.onAppActive)}onDispose(){const e=a.ModuleContainer.resolve(m.a);e.removeEventListener(m.b.Idle,this.onAppIdle),e.removeEventListener(m.b.Active,this.onAppActive)}getConfig(){const e={enable:Ce.default.redundant_res_cleanup.enable,enableForZCloud:Ce.default.redundant_res_cleanup.enable_for_zcloud,forceRun:Ce.default.redundant_res_cleanup.version,deleteStatCache:Ce.default.redundant_res_cleanup.del_stat_cache,enableDelete:Ce.default.redundant_res_cleanup.enable_del,collectGeneratedJPG:Ce.default.redundant_res_cleanup.collect_gen_jpg,batchSize:Ce.default.redundant_res_cleanup.batch_size,batchDelay:Ce.default.redundant_res_cleanup.batch_delay,batchConv:Ce.default.redundant_res_cleanup.batch_conv,startDelay:Ce.default.redundant_res_cleanup.start_delay,scheduleDelay:Ce.default.redundant_res_cleanup.schedule_delay,retryDelay:Ce.default.redundant_res_cleanup.retry_delay,expiredCacheTime:Ce.default.redundant_res_cleanup.expired_cache_time};return this.isAppIdle&&(e.batchSize=Ce.default.redundant_res_cleanup.batch_size_idle,e.batchDelay=Ce.default.redundant_res_cleanup.batch_delay_idle),e}subscribeChange(e){this.changeListeners.push(e)}unsubscribeChange(e){const t=this.changeListeners.indexOf(e);t>=0&&this.changeListeners.splice(t,1)}handleServerConfig(e){const t=new ee.a({enable:ee.b.field().oneOf([0,1,!0,!1]),enable_for_zcloud:ee.b.field().oneOf([0,1,!0,!1]),version:ee.b.field().number(),del_stat_cache:ee.b.field().oneOf([0,1,!0,!1]),enable_del:ee.b.field().oneOf([0,1,!0,!1]),collect_gen_jpg:ee.b.field().oneOf([0,1,!0,!1]),batch_size:ee.b.field().number().min(1).max(1e4),batch_delay:ee.b.field().number().min(0),batch_conv:ee.b.field().number().min(1),batch_size_idle:ee.b.field().number().min(1).max(1e4),batch_delay_idle:ee.b.field().number().min(0),start_delay:ee.b.field().number().min(0),schedule_delay:ee.b.field().number().min(0),retry_delay:ee.b.field().number().min(0),expired_cache_time:ee.b.field().number().min(0)});Ce.default.redundant_res_cleanup=t.validateWithFallback(e,K$.a.redundant_res_cleanup,!0),this.signalConfigChange()}})||W$)||W$)||W$)||W$);var $$=s("vVAj"),Z$=s("q8PC"),Q$=s("Tlqd");class Y$ extends Em.b{constructor(e){super({type:"REDUNDANT_RES_CLEANUP_START",params:e})}}var J$,X$=s("yVfy");Object(a.injectable)()(J$=Object(m.j)()(J$=Object(m.h)()(J$=Object(m.f)()(J$=Object(m.d)()(J$=Object(a.singleton)(Fr.RRCController)(J$=function(e,t){return Object(a.inject)(Fr.RRCConfig)(e,void 0,0)}(J$=function(e,t){return Object(a.inject)(Gg.a)(e,void 0,1)}(J$=function(e,t){return Object(a.inject)(am.a)(e,void 0,2)}(J$=Reflect.metadata("design:type",Function)(J$=Reflect.metadata("design:paramtypes",[void 0===Fr.RRCConfig?Object:Fr.RRCConfig,void 0===Gg.a?Object:Gg.a,Object])(J$=class extends hs.b{constructor(e,t,s){super(),this.config=e,this.syncMessageController=t,this.messageReadinessController=s,this.task=void 0,this.logger=void 0,this.store=void 0,this.factors=void 0,this.requested=void 0,this.runningMode=void 0,this.handleConfigChange=e=>{if(!e.enable)return this.Logger.zsymb(0,"0eSwGo","config change to OFF -> stop cleanup"),void this.stopCleanup();this.isForceRun(e.forceRun)?this.forceRunCleanup(e.forceRun):this.task&&this.task.changeParams({config:e})},this.handleAppIdle=()=>{this.factors.set({appIdle:!0}),this.requested.has("appIdle")&&(this.requested.remove("appIdle"),this.Logger.zsymb(0,"R_Agfr","app is idle -> trigger requested item"),this.triggerAutoRun())},this.handleAppActive=()=>{this.factors.set({appIdle:!1})},this.handleMessageReadyChange=()=>{const e=this.messageReadinessController.isMessageReadyWithIncludeFlags(Mq|Tq|wq|Oq);this.factors.set({msgReady:e})},this.handleResMgmtEvents=e=>{e&&(e.payload===Cn.k.START_CALCULATE?(this.factors.set({resMgmtIdle:!1}),this.isRunning()&&(this.Logger.zsymb(0,"YcINCQ","start calc res mgmt -> pause cleanup"),this.pauseCleanup(),this.requested.add("resMgmtIdle"))):e.payload===Cn.k.FINISH_CALCULATE&&(this.factors.set({resMgmtIdle:!0}),this.requested.has("resMgmtIdle")&&(this.requested.remove("resMgmtIdle"),this.Logger.zsymb(0,"URf2O1","finish calc res mgmt -> resume cleanup"),this.triggerAutoRun())))},this.handleSyncMessageStart=()=>{this.isRunning()&&(this.Logger.zsymb(0,"xBiBcR","start sync msg -> stop cleanup"),this.stopCleanup(),this.requested.add("syncMsgIdle"))},this.handleSyncMessageFinish=()=>{this.requested.has("syncMsgIdle")&&(this.requested.remove("syncMsgIdle"),this.Logger.zsymb(0,"vmHje9","finish sync msg -> restart cleanup"),this.triggerAutoRun())},this.task=null,this.store=new Z$.a(Q$.b),this.factors=new Fr.RRCFactorsStatusRunner({appIdle:!1,msgReady:!1,resMgmtIdle:!0}),this.requested=new Fr.RRCRequestRunner({appIdle:!1,syncMsgIdle:!1,resMgmtIdle:!1,msgReady:!1}),this.runningMode=null}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.redundantResCleanup,["controller"])),this.logger}isAllowRunCleanup(){if(!this.config.getConfig().enable)return this.Logger.zsymb(0,"F-Jait","not allow <- config off"),!1;if(!this.config.getConfig().enableForZCloud&&UE.a.getInstance().isPaidUser())return this.Logger.zsymb(0,"b_NC-1","not allow <- config off for zcloud user"),!1;if(this.isRunning())return this.Logger.zsymb(0,"0YvUBc","not allow <- another is running"),!1;if(!this.factors.get("msgReady"))return this.Logger.zsymb(0,"oX9jLF","not allow <- message not ready"),!1;let e=null;try{const t=this.store.getItemForCurrentUser(Q$.a.LAST_STATUS);t&&(e=JSON.parse(t))}catch{e=null}if(!e||"number"!=typeof e.time)return!0;const t=e.success?e.time+this.config.getConfig().scheduleDelay:e.time+this.config.getConfig().retryDelay;return Ct.default.getTimeNow()>=t||(this.Logger.zsymb(0,"3vs4Jy","not allow <- not over schedule time"),!1)}getCurrentSessionId(){let e=1;try{const t=this.store.getItemForCurrentUser(Q$.a.LAST_STATUS);if(t){const{session_id:s}=JSON.parse(t);s&&!isNaN(+s)&&(e=+s+1)}}catch{e=1}return e}setLastStatus(e){this.store.setItemForCurrentUser(Q$.a.LAST_STATUS,JSON.stringify({time:Ct.default.getTimeNow(),success:e?1:0,session_id:this.getCurrentSessionId()}))}isForceRun(e){if(e>0){let t=this.store.getItemForCurrentUser(Q$.a.FORCE_RUN);return!(t&&!isNaN(+t))||e>+t}return!1}isNeedResetBeforeRunning(){return!1}isNeedSetErrorStatus(e){return!this.task||!this.task.abortController.signal.aborted&&"WorkerInterrupted"!==(null==e?void 0:e.name)}triggerAutoRun(){if(this.syncMessageController.isThisSessionSyncing())return this.requested.add("syncMsgIdle"),void this.Logger.zsymb(0,"KN-fxf","triggerAutoRun but sync msg is running -> wait finish");if(!this.factors.get("resMgmtIdle"))return this.requested.add("resMgmtIdle"),void this.Logger.zsymb(0,"zIJ4by","triggerAutoRun but calc res mgmt is running -> wait finish");if(!this.factors.get("appIdle"))return this.requested.add("appIdle"),void this.Logger.zsymb(0,"kHFQyM","triggerAutoRun but app is not idle -> wait idle");if(this.isAllowRunCleanup())this.isNeedResetBeforeRunning()&&(this.resetCleanup(),X$.b.logCleanupResetRun("interval")),this.runningMode="interval",this.runCleanup();else{const e=this.config.getConfig().forceRun;this.isForceRun(e)&&this.forceRunCleanup(e)}}onStart(){this.config.subscribeChange(this.handleConfigChange),a.ModuleContainer.resolve(m.a).addEventListener(m.b.Idle,this.handleAppIdle),a.ModuleContainer.resolve(m.a).addEventListener(m.b.Active,this.handleAppActive),this.messageReadinessController.addEventListener(Cm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleMessageReadyChange),me.a.DiskStatusManager.addEventListener(Sn.ResCalc_Calculate,this.handleResMgmtEvents),this.syncMessageController.addEventListener(Kg.e.ON_START,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Kg.e.ON_RESUME,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Kg.e.ON_RETRY,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Kg.e.ON_SUCCESS,this.handleSyncMessageFinish),this.syncMessageController.addEventListener(Kg.e.ON_FAILED,this.handleSyncMessageFinish)}onAuthenticated(e){this.store.init(e.getSession().userId)}onApplicationReady(){setTimeout((()=>{this.handleMessageReadyChange(),this.triggerAutoRun()}),this.config.getConfig().startDelay)}onDispose(){this.pauseCleanup(),this.config.unsubscribeChange(this.handleConfigChange),a.ModuleContainer.resolve(m.a).removeEventListener(m.b.Idle,this.handleAppIdle),a.ModuleContainer.resolve(m.a).removeEventListener(m.b.Active,this.handleAppActive),this.messageReadinessController.removeEventListener(Cm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleMessageReadyChange),me.a.DiskStatusManager.removeEventListener(Sn.ResCalc_Calculate,this.handleResMgmtEvents),this.syncMessageController.removeEventListener(Kg.e.ON_START,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Kg.e.ON_RESUME,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Kg.e.ON_RETRY,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Kg.e.ON_SUCCESS,this.handleSyncMessageFinish),this.syncMessageController.removeEventListener(Kg.e.ON_FAILED,this.handleSyncMessageFinish)}onCleanupStart(){this.dispatchEvent(new hs.a(Fr.RRCEvents.Start));const e=this.getCurrentSessionId();X$.a.startScanReport({sessionId:e,triggerType:"forced"===this.runningMode?"forced":"interval"}),this.Logger.zsymb(0,"0XWqEZ","cleanup start",e,this.runningMode)}onCleanupSuccess(e){const{statsBefore:t,statsDetailBefore:s,statsAfter:a,statsDetailAfter:i,statsFailure:n,statsAccessTime:r}=e,o=this.getCurrentSessionId();t&&s&&a&&i&&X$.a.completeCleanupReport({sessionId:o,duration:e.duration,interrupt:e.interupted,triggerType:"forced"===this.runningMode?"forced":"interval",statsAfter:a,statsBefore:t,statsDetailAfter:i,statsDetailBefore:s,statsFailure:n,statsAccessTime:r}),this.setLastStatus(!0),this.dispatchEvent(new Fr.RRCSuccessEvent(e)),this.task=null,this.runningMode=null,this.Logger.zsymb(0,"SgVr7y","cleanup success",o)}onCleanupFail(e){const t=this.getCurrentSessionId();this.isNeedSetErrorStatus(e)&&this.setLastStatus(!1),this.dispatchEvent(new Fr.RRCErrorEvent(e)),this.task=null,this.runningMode=null,this.Logger.zsymb(18,"N2olkA","cleanup fail",t,e),e&&"WorkerInterrupted"===e.name&&setTimeout((()=>{this.triggerAutoRun()}),this.config.getConfig().startDelay)}async forceRunCleanup(e){this.Logger.zsymb(0,"_MGABf","force run cleanup version=",e),this.stopCleanup().then((()=>{this.resetCleanup(),X$.b.logCleanupResetRun("forced")})).finally((()=>{this.store.setItemForCurrentUser(Q$.a.FORCE_RUN,String(e)),this.runningMode="forced",this.runCleanup()}))}async runCleanup(){this.task=new Y$({userId:J.p.getSessionUserId(),config:this.config.getConfig(),maxTimeScan:Ct.default.getTimeNow(),flush:!0,sessionId:this.getCurrentSessionId(),forced:"forced"===this.runningMode}),this.onCleanupStart(),this.task.addEventListenerOnce($$.c.Completed,(({result:e})=>{this.onCleanupSuccess(e)})),this.task.addEventListenerOnce($$.c.Error,(({error:e})=>{this.onCleanupFail(e)})),this.task.run()}async stopCleanup(){this.task&&(await this.task.abort(),this.dispatchEvent(new hs.a(Fr.RRCEvents.Abort)),this.task=null,this.runningMode=null)}resetCleanup(){this.task||(this.store.removeItemForCurrentUser(Q$.a.LAST_STATUS),this.store.removeItemForCurrentUser(Q$.a.PROGRESS),this.store.removeItemForCurrentUser(Q$.a.PROGRESS_LIMIT),this.store.removeItemForCurrentUser(Q$.a.STAGE),this.store.removeItemForCurrentUser(Q$.a.TRACKING_DATA))}async pauseCleanup(){this.task&&(this.task.changeParams({flush:!1}),await this.task.abort(),this.dispatchEvent(new hs.a(Fr.RRCEvents.Abort)),this.task=null,this.runningMode=null)}isRunning(){return!!this.task}})||J$)||J$)||J$)||J$)||J$)||J$)||J$)||J$)||J$)||J$);s("AHxZ");class eZ{constructor(){this.aborted=void 0,this.aborted=!0}}class tZ{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this._taskId=Object(ha.b)(8),this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const a=()=>{this._aborted=!0,s(new eZ),this._abortController.signal.removeEventListener("abort",a)};this._abortController.signal.addEventListener("abort",a),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",a),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}get taskId(){return this._taskId}set taskId(e){this._taskId=e}}function sZ(e,...t){return new tZ(e,t)}var aZ=s("W0O7"),iZ=s("SkSZ");const nZ={UNLOAD_ZPOPUP_WINDOW:"UNLOAD_ZPOPUP_WINDOW"};var rZ,oZ=s("6VRG");Object(a.injectable)()(rZ=Object(Ai.b)(ga.a)(rZ=class{constructor(){this.OPEN_TIMEOUT=1e4,this.CLOSE_TIMEOUT=1e4,this.instances=new Map,this.runningTask=new Map,this._eventEmitter=new of.a,this.open=async e=>{const t=e.windowId;Object(ua.a)(!!t,`windowId must be a valid string. Received ${t}`),Object(ua.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const s=this.getOpenTaskId(t),a=this.runningTask.get(s);if(a&&!a.fulfilled)return await a.promise;if(this.instances.has(t)){const e=this.instances.get(t);return this.focus(t),e}const i=sZ(this._create,e);i.taskId=s;const n=e.parentWindow.setTimeout((()=>{i.abort(),this.runningTask.delete(s)}),this.OPEN_TIMEOUT),r=()=>{this.runningTask.delete(s),e.parentWindow.clearTimeout(n)};this.runningTask.set(s,i);try{const e=await i.promise;return r(),e}catch(o){throw r(),o}},this.openMediaViewerWindow=async e=>{Object(ua.a)(!!e.windowId,`windowId must be a valid string. Received ${e.windowId}`),Object(ua.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const t=this.getOpenTaskId(e.windowId),s=this.runningTask.get(t);if(s&&!s.fulfilled)return zconsole.zsymb(3,"HnGwEa",["[MVR]:found opening task:lock","mY-omL"],e.windowId),await this.runningTask.get(t).promise;if(this.instances.has(e.windowId)){const t=this.instances.get(e.windowId);return this.focus(e.windowId),t}const i=a.ModuleContainer.resolve(da.c).getInfoScreenOfMouse(e.parentWindow),n={min_width_open_window:iZ.a.media_viewer.min_width_open_window,min_height_open_window:iZ.a.media_viewer.min_height_open_window,max_width_open_window:iZ.a.media_viewer.max_width_open_window,max_height_open_window:iZ.a.media_viewer.max_height_open_window},r=this._getSavedPopupSize(e.windowId);zconsole.zsymb(12,"TfOttk","[MVR]: open:init savedSize",r);const o=da.d.calculateWindowSizeByScreen(i,n,r),l=da.d.calculatePositionCenterScreen(i,o),c={w:o.w,h:o.h,x:l.x,y:l.y};zconsole.zsymb(12,"wAtQgs","[MVR]: open:init bounds",c),e.onWindowDOMContentLoaded||(e.onWindowDOMContentLoaded=()=>{var t;const s=this.getWindow(e.windowId),a=s.instance;Object(ua.a)(!!a,`zpopupWindow must be a valid object. Received ${s}`),zconsole.info("[MVR]: onWindowDOMContentLoaded",null==a||null===(t=a.document)||void 0===t?void 0:t.readyState),Object(aZ.copyStyles)(e.parentWindow.document,a.document)}),e.onWindowLoad||(e.onWindowLoad=()=>{var t;const s=this.getWindow(e.windowId),a=s.instance;Object(ua.a)(!!a,`[MVR]: zpopupWindow must be a valid object. Received ${s}`),zconsole.zsymb(12,"xCf69c","[MVR]: onWindowLoad cb"),Object(aZ.preventUserAction)(a,!0,this._exitWhenError);const i=a.document.createElement("div");i.id="popup-viewer";const n=a.document.createElement("div");n.id=s.id,i.appendChild(n),a.document.body.appendChild(i),null===(t=a.document.getElementById("app"))||void 0===t||t.remove(),this.data.set(e.windowId,{windowId:e.windowId,ready:!0}),this._signalRenderItem(this.name,e.windowId)}),e.frame||(e.frame=da.d.convertObjectToUrl({left:l.x,top:l.y,width:o.w,height:o.h,availHeight:i.availH,availWidth:i.availW},"?key=media-viewer")),e.specs||(e.specs=da.d.getWindowSpec(c)),e.windowBoundary||(e.windowBoundary=c);try{const t=await this.open(e);return Ei.a.increaseSuccess(Ei.a.duration),t}catch($Q){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowOpenFailed,Date.now(),[Ei.a.platform]),$Q}},this.getWindow=e=>this.instances.get(e)||null,this.close=async e=>{var t;this.emit(nZ.UNLOAD_ZPOPUP_WINDOW,{windowId:e});const s=this.getOpenTaskId(e);if(this.runningTask.has(s))return;const a=this.getCloseTaskId(e);if(this.runningTask.has(a))return;const i=this.instances.get(e);if(!i)return zconsole.zsymb(18,"YbXIek","[MVR]: zpopup close failed due to NO WINDOW FOUND"),Promise.resolve();this.savePopupSize(e);const n=sZ(i.close);n.taskId=a,this.runningTask.set(a,n);const r=null===(t=i.instance)||void 0===t?void 0:t.setTimeout(n.abort,this.CLOSE_TIMEOUT),o=()=>{var t;this.runningTask.delete(a),null===(t=i.instance)||void 0===t||t.clearTimeout(r),this.instances.delete(e),this.data.delete(e),this._signalRenderItem(this.name,e),zconsole.zsymb(0,"5TouBi",`[MVR]: zpopup: close finished ${e}`)};try{await n.promise,Ei.a.increaseSuccess(Ei.a.duration),o()}catch(l){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowFailed,Date.now(),[Ei.a.platform]),o(),zconsole.error("[MVR]: zpopup:close error",l),l}},this.focus=async e=>{const t=this.instances.get(e);if(!t)return Promise.resolve();try{await t.focus(),Ei.a.increaseSuccess(Ei.a.duration)}catch($Q){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowFocusFailed,Date.now(),[Ei.a.platform]),this.instances.delete(e),$Q}},this.getOpenTaskId=e=>`open-${e}`,this.getCloseTaskId=e=>`close-${e}`,this._exitWhenError=e=>{zconsole.zsymb(18,"wS8YNb",`[MVR]: zpopup:exitWhenError windowId ${e}`),Wo.default.createError(le.a.str("STR_POPUP_OPEN_ERR")),this.close(e),this.data.delete(e),this._signalRenderItem(this.name,e),Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.ExitWhenError,Date.now())},this._abortTask=async e=>{const t=this.runningTask.get(e);t?(t.abort(),this.runningTask.delete(e)):zconsole.info(`[MVR]: zpopup:abort open windowId ${e}`)},this._signalRenderItem=(...e)=>{Object(Po.h)(...e)},this._create=async e=>{if(this.instances.has(e.windowId))return this.instances.get(e.windowId);e.onWindowCreated=t=>{this.instances.set(e.windowId,t)};const t=await a.ModuleContainer.resolve(da.c).create(e);if("ERROR"===t.type)throw t;return t.data},this.savePopupSize=e=>{if(oZ.MVR_ID_LIST.some((t=>t===e))){const t=this.instances.get(e);if(!t)return;const s=t.getCurrentWindowSizes(),a=n.default.getInstance();if(a&&s)try{const{w:t,h:i}=s;Object(ua.a)("number"==typeof t&&t>0,`width must be a number. Received ${t}`),Object(ua.a)("number"==typeof i&&i>0,`height must be a number. Received ${i}`),zconsole.zsymb(15,"xt-1X0",["[MVR] savePopupSize: windowId: {}, width: {}, height: {}","G07iTb"],e,t,i);const n=this._buildPopupSizeKey(e),r=JSON.stringify({width:t,height:i});a.setItemForCurrentUser(n,r)}catch($Q){zconsole.zsymb(21,"0T9Ao-",["[MVR] error: Cannot save popup size. windowId: {}","RormOC"],e,$Q)}else zconsole.zsymb(21,"weQe4n",["[MVR] Cannot save popup size. secureLocalStorage is not found. windowId: {}","_n3YqY"],e)}},this._buildPopupSizeKey=e=>`mvr_${e}_size`,this._getSavedPopupSize=e=>{const t=n.default.getInstance();if(t)try{const s=this._buildPopupSizeKey(e),a=t.getItemForCurrentUser(s);if(a){const e=JSON.parse(a);return Object(ua.a)("object"==typeof e,"width must be a number. Received "+typeof e),Object(ua.a)("number"==typeof(null==e?void 0:e.width),`width must be a number. Received ${null==e?void 0:e.width}`),Object(ua.a)("number"==typeof(null==e?void 0:e.height),`height must be a number. Received ${null==e?void 0:e.height}`),{w:e.width,h:e.height}}}catch($Q){zconsole.zsymb(21,"NXlyN3",["[MVR] error: Cannot get popup size. windowId: {}","cZ-BBu"],e,$Q)}else zconsole.zsymb(21,"FuEkYR",["[MVR] Cannot get popup size. secureLocalStorage is not found. windowId: {}","Kbqred"],e);return null},this.name=ga.b,this.data=new Map,this.key="windowId",this.init=()=>{}}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in nZ&&this._eventEmitter.emit(e,t)}isValidPhotoViewerWindowId(e){return e===da.a.PHOTO_VIEWER_ID}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||rZ);var lZ,cZ=s("RHk6"),dZ=s("r06Z");Object(a.singleton)(cZ.BankParserController)(lZ=class{constructor(){this.logger=void 0}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(R.ZLoggerNametags.bankParser,["controller"])),this.logger}async createParserTasks(e,t){const s=new Map,a=new Map;for(const i of e){const e=t.get(i);if(!e||!e.length)continue;const n=await we.default.getMessagesByIds(i,e);for(const t in n){const e=n[t];if(dZ.a.isMessageParsable(e)&&e.message){const t=e.cliMsgId,n=Number(e.sendDttm)||Ct.default.getTimeNow(),r=dZ.a.formatMessageContent({content:{text:e.message},mentions:e.mentions});if(r){let e=s.get(r);e||(e=dZ.a.create(r),s.set(r,e));const o=a.get(r)||[];o.push({clientId:String(t),convId:i,ts:n}),a.set(r,o)}}}}return{parserMapping:s,submitInfoMapping:a}}onForwardMessages(e,t){if(!Array.isArray(e)||!dZ.a.enableBankParser())return;const s=Array.isArray(t)?t:[t],a=new Map;for(const{msgId:i,toUid:n}of s){const e=a.get(n)||[];e.push(i),a.set(n,e)}this.createParserTasks(e,a).then((({parserMapping:e,submitInfoMapping:t})=>{e.forEach(((e,s)=>{const a=t.get(s)||[];for(const{clientId:t,ts:i,convId:n}of a)e.submit(t,i,n,ui.default.isGroup(n));e.parse().exec()}))})).catch((t=>{this.Logger.zsymb(18,"18aXzT","[forward] parse bank failed",e,t)}))}});var uZ,hZ=s("cO+G"),gZ=s("ju6I");let mZ=Object(a.injectable)()(uZ=Object(m.d)()(uZ=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(uZ=function(e,t){return Object(a.inject)(ei)(e,void 0,1)}(uZ=Reflect.metadata("design:type",Function)(uZ=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ILastOnlineDetector?Object:ILastOnlineDetector])(uZ=class extends hs.b{constructor(e,t){super(),this.lastOnlineDetector=t,this.config=void 0,this.isBackOnlineEventFired=!1,this.prevNetworkStatus=null,this.prevUserActiveStatus=null,this.logger=void 0,this.config=hZ.a,this.logger=e.createZLogger(R.ZLoggerNametags.offline2Online,["back-to-online-detector"])}onApplicationReady(){this.logger.zsymb(3,"Moeq0g",["application ready","MQqOa8"]),this.dispatchEventBackToOnline("first-start-app"),this.registerListener()}registerListener(){this.logger.zsymb(3,"ovcRLR",["register listener","TuYpEH"]),_e.default.subscribe(((e,t)=>{switch(e){case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case ve.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t);case ve.WebsocketActions.CONNECTION_STATE_CHANGE:return this.onWebSocketStateChanged(null==t?void 0:t.state)}}))}onNetworkStatusChanged(e){const t=this.prevNetworkStatus;e!==t&&(this.logger.zsymb(3,"xAASsA",["network status changed, [prev, curr]=[{}, {}]","XVAFoR"],this.prevNetworkStatus,e),this.prevNetworkStatus=e,t!==ce.a.CONNECTED&&e===ce.a.CONNECTED?this.checkAndDispatchEventIfNeeded():e!==ce.a.CONNECTED&&JI.default.getSocketState()!==WebSocket.OPEN&&(this.isBackOnlineEventFired=!1))}onUserActiveChanged(e){if(!1===[fv.c.RESUME,fv.c.SLEEP].includes(e))return;const t=this.prevUserActiveStatus;e!==t&&(this.logger.zsymb(3,"jIl6sA",["user active changed, [prev, curr]=[{}, {}]","41u90H"],this.prevUserActiveStatus,e),this.prevUserActiveStatus=e,t===fv.c.SLEEP&&e===fv.c.RESUME?this.checkAndDispatchEventIfNeeded():e===fv.c.SLEEP&&(this.isBackOnlineEventFired=!1))}onWebSocketStateChanged(e){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket"))switch(e){case WebSocket.OPEN:return void this.dispatchEventBackToOnline("resume-app");case WebSocket.CLOSED:case-1:return void(this.isBackOnlineEventFired=!1)}}checkAndDispatchEventIfNeeded(){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket")){switch(Jc.default.getMsgSrcType()){case Y.MsgSources.SOCKET:this.checkWebSocketAndDispatchEventIfNeeded();break;case Y.MsgSources.POLLING:case Y.MsgSources.UNSET:default:this.checkDurationOfflineAndDispatchEventIfNeeded()}}else this.checkDurationOfflineAndDispatchEventIfNeeded()}checkWebSocketAndDispatchEventIfNeeded(){const e=JI.default.getSocketState();e!==WebSocket.OPEN?this.dispatchEventBackToOnline("resume-app"):(this.logger.zsymb(3,"7OTZfY",["not need dispatch event resume app, socket state is {}","7K_x8G"],e),this.isBackOnlineEventFired=!0)}async checkDurationOfflineAndDispatchEventIfNeeded(){const[e,t]=await Promise.all([this.lastOnlineDetector.getStartTsOnlineCurrSession(),this.lastOnlineDetector.getLastTsOnlinePrevSession()]);Math.abs(e-t)>=this.config.nestedKey("back_to_online_detector.max_offline_duration")&&this.dispatchEventBackToOnline("resume-app"),this.isBackOnlineEventFired=!0}dispatchEventBackToOnline(e){this.isBackOnlineEventFired||(this.dispatchEvent(new gZ.b(e)),this.isBackOnlineEventFired=!0)}})||uZ)||uZ)||uZ)||uZ)||uZ)||uZ;a.ModuleContainer.registerSingleton(gZ.c,mZ);let pZ=function(e){return e.ON_SUCCESS="onsuccess",e.ON_FAILED="onfailed",e.ON_INTERRUPTED="oninterrupted",e.ON_NONE="onnone",e}({});var fZ,vZ=s("tzCl");Object(a.singleton)(vZ.a)(fZ=Reflect.metadata("design:type",Function)(fZ=Reflect.metadata("design:paramtypes",[])(fZ=class{constructor(){this.refreshed_=!1;const e=null;e&&e.addEventListenerOnce(pZ.ON_SUCCESS,this.handleMigrateDriveSuccess_.bind(this))}refreshPhotoStickerLocalFieldsIfNeeded(){if(this.refreshed_)return;const e=null;if(!e)return;e.getMigrateDriveStatusForCurrentSession()===Ar.d.SUCCEED&&(this.refreshPhotoStickerLocalFields_(),this.refreshed_=!0)}handleMigrateDriveSuccess_(){this.refreshed_||(this.refreshPhotoStickerLocalFields_(),this.refreshed_=!0)}refreshPhotoStickerLocalFields_(){const e=we.default.getRecentMediaItems();if(e&&e.length){let t=!1;const s=a.ModuleContainer.resolve(p_.TAIStickerAppService),i=[];e.forEach((e=>{if(I_.a.Helper.isPhotoSticker(e)&&!s.isValidAISticker(e)){const s={localUrl:"",localPreview:"",localPng:""};i.push(Object(I.a)(Object(I.a)({},e),s)),t=!0}else i.push(e)})),t&&we.default.setRecentMediaItems(i)}}})||fZ)||fZ);var _Z,bZ=s("T9Ct");Object(m.j)()(_Z=Object(m.h)()(_Z=Object(a.singleton)(bZ.DraftKeepingManager)(_Z=class{constructor(){this.prevStateKeeper=void 0,this.draftInputKeeper=void 0,this.onRequestBackup=()=>{this.getStateKeeper().backup(),this.getDraftInputKeeper().backup()},this.onRequestRestore=()=>{this.getStateKeeper().restore(),this.getDraftInputKeeper().restore()}}onStart(){this.getStateKeeper().init(),this.getDraftInputKeeper().init(),$zresource.onBackupAppState(this.onRequestBackup),$zresource.onRestoreAppState(this.onRequestRestore)}onDispose(){$zresource.removeListenBackupAppState(this.onRequestBackup),$zresource.removeListenRestoreAppState(this.onRequestRestore)}getStateKeeper(){return this.prevStateKeeper||(this.prevStateKeeper=new bZ.PreviousStateKeeper),this.prevStateKeeper}getDraftInputKeeper(){return this.draftInputKeeper||(this.draftInputKeeper=new bZ.DraftInputKeeper),this.draftInputKeeper}})||_Z)||_Z);class IZ{constructor(){this.name=Ga.a,this.key="",this.state={shouldKeepLoadingScreen:!0},this.timer=null}startKeepLoadingIfNeeded(){this.enabled&&this.state.shouldKeepLoadingScreen&&(this.resetTimer(),this.timer=setTimeout((()=>{this.dismissLoadingScreen(),this.timer=null}),this.timeoutDuration))}async dismissLoadingScreen(){await Object(oi.c)(this.delayDuration),this.state.shouldKeepLoadingScreen=!1,Object(Po.h)(this.name,Ga.b),this.resetTimer()}resetTimer(){null!==this.timer&&clearTimeout(this.timer)}get enabled(){return!!hZ.a.nestedKey("keep_loading_during_preload.enable")}get timeoutDuration(){return hZ.a.nestedKey("keep_loading_during_preload.timeout_duration")}get delayDuration(){return hZ.a.nestedKey("keep_loading_during_preload.screen_dismiss_delay")}init(){}getItem(){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){}onGetListFailure(e,t){}}a.ModuleContainer.registerSingleton(Ga.c,IZ),a.ModuleContainer.registerSingleton(Ai.a,IZ),function(){const e=a.ModuleContainer.resolve(jo.ConvListController),t=Qa.a.getInstance();e.addEventListener(ai.c.StateChangedDueToFilterTypeChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)})),e.addEventListener(ai.c.StateChangedDueToFilterTypeSrcChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)}))}();s("69Uf"),s("Q/Ir"),s("Lp8g"),s("mneU");var yZ,SZ=s("eK4z");E.j.timeInMs("3m"),E.h.sizeInByte("110MB"),E.h.sizeInByte("100MB"),E.j.timeInMs("24h"),E.j.timeInMs("5s"),E.h.sizeInByte("200MB");const CZ={enable:!1,max_retries_create_bu:3,max_timeout_duration:E.j.timeInMs("3m"),total_msg_ratio:1636,delta_size_estimated_sqlite:E.h.sizeInByte("110MB"),force_start_migrate:!1,delta_size_storage_checking:E.h.sizeInByte("100MB"),auto_remind_modal_timeout:E.j.timeInMs("24h"),auto_dismiss_success_screen:E.j.timeInMs("5s"),migrate_version:1,max_retry_count:2,min_estimated_sqlite_size:E.h.sizeInByte("200MB"),drop_idb:!1};let EZ=Object(a.singleton)()(yZ=Reflect.metadata("design:type",Function)(yZ=Reflect.metadata("design:paramtypes",[])(yZ=class extends X.AdvancedRemoteConfigs{constructor(){super("db_migrate",CZ,{validator:new X.ObjectValidator({enable:X.Rule.field().boolean(),max_retries_create_bu:X.Rule.field().number().min(0),max_timeout_duration:X.Rule.field().number().min(0),total_msg_ratio:X.Rule.field().number().min(0),delta_size_estimated_sqlite:X.Rule.field().number().min(0),force_start_migrate:X.Rule.field().boolean(),delta_size_storage_checking:X.Rule.field().number().min(0),auto_remind_modal_timeout:X.Rule.field().number().min(0),auto_dismiss_success_screen:X.Rule.field().number().min(0),migrate_version:X.Rule.field().number().min(1),max_retry_count:X.Rule.field().number().min(1),min_estimated_sqlite_size:X.Rule.field().number().min(0),drop_idb:X.Rule.field().boolean()})})}loadConfig(e){super.loadConfig(e)}})||yZ)||yZ)||yZ;a.ModuleContainer.registerSingleton(SZ.a,EZ);var OZ=s("0W0H");a.ModuleContainer.registerSingleton(Ji.a,class{constructor(){this.logger=void 0,this.session=null,this.dbStateStorage=null;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("db-migrate",["utils"])}async getNotMigratedAccounts(){const e=await this.getStates(),t=Object(lv.f)(),s=[];for(const a of t){const t=e[a];void 0!==t?t!==O.a.IDB||s.push(a):s.push(a)}return s}authenticate(e){this.session=e}isCurrentAccountMigrated(){const e=this.getSession();return void 0!==this.getMigrateDoneState()[e.userId]}getTotalMigratedAccount(){const e=this.getMigrateDoneState();return Object.keys(e).length}async forceMarkAsDoneMigrateDB40(){const e=this.isCurrentAccountMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();if(e||t){const e=await Object(Yi.a)(),t=n.default.getInstance();return e.forEach((e=>{const s=`${`${Object(lv.d)(e)}`}_${OZ.b}`;t.removeItemPlain(s)})),await $zFeatures.migrateDB.signalDoneFullMigrate(),!0}return!1}getSession(){if(null===this.session)throw new Error("DatabaseMigrateUtils hasn't authenticated yet");return this.session}async getStates(){try{return this.dbStateStorage||(this.dbStateStorage=this.getDBStateStorage()),await this.dbStateStorage.getObjectAsync(Lq.a)}catch($Q){throw new Error("Invalid adapter type states")}}getDBStateStorage(){if(null===this.dbStateStorage){const e=this.getSession();this.dbStateStorage=a.ModuleContainer.resolve(Dq.b),this.dbStateStorage.authenticate(e)}return this.dbStateStorage}getMigrateDoneState(){const e=this.getDBStateStorage().getItem(OZ.e);let t={};if(e)try{t=JSON.parse(e)}catch($Q){this.logger.zsymb(21,"b30sLM",["Failed to parse migrate done state: {}","mVUR9Z"],Object(Kt.c)($Q))}return t}});class MZ{constructor(){this.shouldPromote=void 0,this.shouldPromote=!1}setShouldPromote(e){this.shouldPromote=e}promoteForOpenConv(e){const t={type:"open-conv",payload:{convId:e}};this.sendPromote(t)}async sendPromote(e){if(this.shouldPromote){const t={typeID:f.m,data:{type:f.x,data:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort();await i.invokeMessage(t)}}}var TZ=s("/brz"),wZ=s("YEoC");let RZ=function(e){return e[e.SQLITE_OK=0]="SQLITE_OK",e[e.SQLITE_ERROR=1]="SQLITE_ERROR",e[e.SQLITE_INTERNAL=2]="SQLITE_INTERNAL",e[e.SQLITE_PERM=3]="SQLITE_PERM",e[e.SQLITE_ABORT=4]="SQLITE_ABORT",e[e.SQLITE_BUSY=5]="SQLITE_BUSY",e[e.SQLITE_LOCKED=6]="SQLITE_LOCKED",e[e.SQLITE_NOMEM=7]="SQLITE_NOMEM",e[e.SQLITE_READONLY=8]="SQLITE_READONLY",e[e.SQLITE_INTERRUPT=9]="SQLITE_INTERRUPT",e[e.SQLITE_IOERR=10]="SQLITE_IOERR",e[e.SQLITE_CORRUPT=11]="SQLITE_CORRUPT",e[e.SQLITE_NOTFOUND=12]="SQLITE_NOTFOUND",e[e.SQLITE_FULL=13]="SQLITE_FULL",e[e.SQLITE_CANTOPEN=14]="SQLITE_CANTOPEN",e[e.SQLITE_PROTOCOL=15]="SQLITE_PROTOCOL",e[e.SQLITE_EMPTY=16]="SQLITE_EMPTY",e[e.SQLITE_SCHEMA=17]="SQLITE_SCHEMA",e[e.SQLITE_TOOBIG=18]="SQLITE_TOOBIG",e[e.SQLITE_CONSTRAINT=19]="SQLITE_CONSTRAINT",e[e.SQLITE_MISMATCH=20]="SQLITE_MISMATCH",e[e.SQLITE_MISUSE=21]="SQLITE_MISUSE",e[e.SQLITE_NOLFS=22]="SQLITE_NOLFS",e[e.SQLITE_AUTH=23]="SQLITE_AUTH",e[e.SQLITE_FORMAT=24]="SQLITE_FORMAT",e[e.SQLITE_RANGE=25]="SQLITE_RANGE",e[e.SQLITE_NOTADB=26]="SQLITE_NOTADB",e[e.SQLITE_NOTICE=27]="SQLITE_NOTICE",e[e.SQLITE_WARNING=28]="SQLITE_WARNING",e[e.SQLITE_ROW=100]="SQLITE_ROW",e[e.SQLITE_DONE=101]="SQLITE_DONE",e[e.SQLITE_BUSY_RECOVERY=261]="SQLITE_BUSY_RECOVERY",e}({});Error;let LZ,DZ=function(e){return e[e.READ=1]="READ",e[e.WRITE=2]="WRITE",e[e.INIT=3]="INIT",e}({});(()=>{const e=a.ModuleContainer.resolve(w.a);LZ=e.createZLogger(R.ZLoggerNametags.sqlDataMigration,[""])})();var AZ=LZ;let FZ,kZ,NZ;var PZ;let jZ;!function(e){e.isSQLiteError=function(e){return void 0!==e.errno},e.ignoreable=function(e){return t.has(e.errno)},e.retryable=function(e){return s.has(e.errno)},e.renewableError=function(e){return a.has(e.errno)},e.forceStop=function(e){return i.has(e.errno)};const t=new Set([RZ.SQLITE_NOTICE,RZ.SQLITE_WARNING]),s=new Set([RZ.SQLITE_BUSY,RZ.SQLITE_ERROR,RZ.SQLITE_ABORT,RZ.SQLITE_LOCKED,RZ.SQLITE_INTERRUPT,RZ.SQLITE_PROTOCOL,RZ.SQLITE_MISUSE,RZ.SQLITE_BUSY_RECOVERY]),a=new Set([RZ.SQLITE_IOERR,RZ.SQLITE_ERROR,RZ.SQLITE_CORRUPT,RZ.SQLITE_CANTOPEN,RZ.SQLITE_NOTADB]),i=new Set([RZ.SQLITE_NOMEM,RZ.SQLITE_PERM])}(FZ||(FZ={})),function(e){e.isIndexedDBError=function(e){return void 0===e.errno&&void 0!==e.code};let t=function(e){return e.NoModificationAllowedError="NoModificationAllowedError",e.DBNotFoundError="DBNotFoundError",e.NotFoundError="NotFoundError",e.NotSupportedError="NotSupportedError",e.InvalidStateError="InvalidStateError",e.SyntaxError="SyntaxError",e.InvalidModificationError="InvalidModificationError",e.AbortError="AbortError",e.QuotaExceededError="QuotaExceededError",e.TimeoutError="TimeoutError",e.DataCloneError="DataCloneError",e.EncodingError="EncodingError",e.NotReadableError="NotReadableError",e.UnknownError="UnknownError",e.ConstraintError="ConstraintError",e.DataError="DataError",e.ReadOnlyError="ReadOnlyError",e.VersionError="VersionError",e.OperationError="OperationError",e.NotAllowedError="NotAllowedError",e.OptOutError="OptOutError",e.Undefined="Undefined",e}({});e.errorsName=t;let s=function(e){return e[e.NoModificationAllowedError=7]="NoModificationAllowedError",e[e.NotFoundError=8]="NotFoundError",e[e.NotSupportedError=9]="NotSupportedError",e[e.InvalidStateError=11]="InvalidStateError",e[e.SyntaxError=12]="SyntaxError",e[e.InvalidModificationError=14]="InvalidModificationError",e[e.AbortError=20]="AbortError",e[e.QuotaExceededError=22]="QuotaExceededError",e[e.TimeoutError=23]="TimeoutError",e[e.DataCloneError=25]="DataCloneError",e}({});e.errorsCode=s,e.retryable=function(e,a){const i=[t.AbortError,t.TimeoutError,t.NotReadableError,t.OperationError].includes(e),n=[s.AbortError,s.TimeoutError].includes(a);return i||n},e.ignoreable=function(e,a){const i=[t.NotFoundError].includes(e),n=[s.NotFoundError].includes(a);return i||n},e.forceStop=function(e,a){const i=[t.QuotaExceededError].includes(e),n=[s.QuotaExceededError].includes(a);return i||n}}(kZ||(kZ={})),(PZ=NZ||(NZ={})).shouldIgnoreError=function(e,t){return e==wZ.a.IDB?kZ.ignoreable(t.name,t.code):e==wZ.a.SQLite&&FZ.ignoreable(t)},PZ.shouldRetryError=function(e,t){return e==wZ.a.IDB?kZ.retryable(t.name,t.code):e==wZ.a.SQLite&&FZ.retryable(t)},PZ.shouldForceStopError=function(e,t){return e==wZ.a.IDB?kZ.forceStop(t.name,t.code):e==wZ.a.SQLite&&FZ.forceStop(t)},(jZ||(jZ={})).parseErrorCode=function({error:e}){try{return FZ.isSQLiteError(e)||kZ.isIndexedDBError(e)?e.code:"re_"+e.name}catch($Q){return AZ.zsymb(21,"q7STJD",["Failed to parse error code: {}","qO66lq"],Object(Kt.c)($Q)),-2}};DZ.WRITE;var UZ=s("dko3");class BZ{constructor({session:e,dbConfig:t}){this.session=void 0,this.dbConfig=void 0,this.database=null,this.session=e,this.dbConfig=t}async openDB(){if(null===this.database){const e="",t=this.dbConfig.computeDatabaseName(this.session.userId,e),s=this.dbConfig.getLegacyPartition(e,this.session);this.database=await zZ.open(t,s)}return this.database}closeConnection(){this.database&&this.database.close()}async getStoreOrIndex(e,t){try{const s=await this.openDB(),a=s.transaction(e.tableName,"readonly").objectStore(e.tableName);return t&&"primary"!=t?a.index(t):a}catch(s){if((null==s?void 0:s.code)===kZ.errorsCode.NotFoundError)throw new zZ.TableDoesNotExistError(e.tableName);throw s}}async isTableExist(e){try{return await this.getStoreOrIndex(e),!0}catch(t){return!1}}async get(e,t){const s=await this.getStoreOrIndex(e);return await zZ.get(s,zZ.toIDBQuery(t))}async getAll(e,t,s){const a=await this.getStoreOrIndex(e,null==s?void 0:s.index);return await zZ.getAll(a,zZ.toIDBQuery(t),null==s?void 0:s.count)}async getMulti(e,t){const s=await this.getStoreOrIndex(e);return await zZ.getMulti(s,t)}async count(e,t){const s=await this.getStoreOrIndex(e);return await zZ.count(s,zZ.toIDBQuery(t))}async getAllKeys(e,t){const s=await this.getStoreOrIndex(e);return await zZ.getAllKeys(s,zZ.toIDBQuery(t))}}let zZ;!function(e){class t extends Error{constructor(e,t){super(t),this.code=e,this.message=t}}e.IDBError=t;e.DBDoesNotExistError=class extends t{constructor(e){super(kZ.errorsCode.NotFoundError,`Database ${e} does not exist`),this.name=kZ.errorsName.DBNotFoundError}};e.TableDoesNotExistError=class extends t{constructor(e){super(kZ.errorsCode.NotFoundError,`Table ${e} does not exist`),this.name=kZ.errorsName.NotFoundError}};e.isDatabaseExist=async e=>(await indexedDB.databases()).some((t=>t.name===e)),e.open=async(e,t)=>{if(!(await zZ.isDatabaseExist(e)))throw new zZ.DBDoesNotExistError(e);return new Promise(((s,a)=>{const i=UZ.a.open(e,t.version);i.onsuccess=()=>{s(i.result)},i.onerror=()=>{a(i.error)},i.onblocked=()=>{a(i.error)},i.onupgradeneeded=async s=>{if(null!==s.newVersion)try{const a=i.result,n=i.transaction,r=new TZ.a(e,t,a,n);await r.upgrade(s.oldVersion,s.newVersion)}catch(a){throw i.transaction.abort(),a}}}))},e.get=async(e,...t)=>{var s;return null!==(s=await zZ.promisifyRequest(e.get(...t)))&&void 0!==s?s:null},e.getAll=(e,...t)=>zZ.promisifyRequest(e.getAll(...t)),e.getMulti=(e,t)=>Promise.all(t.map((t=>zZ.get(e,t)))),e.getAllKeys=(e,...t)=>zZ.promisifyRequest(e.getAllKeys(...t)),e.count=(e,...t)=>zZ.promisifyRequest(e.count(...t)),e.promisifyRequest=e=>new Promise(((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})),e.toIDBQuery=e=>{if(e){if("string"==typeof e)return e;if("number"==typeof e)return e;if(Array.isArray(e))return e;if(e.from&&e.to)try{return IDBKeyRange.bound(zZ.firstOrArray(e.from),zZ.firstOrArray(e.to),e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(zZ.firstOrArray(e.from),e.excludeFrom):e.to?IDBKeyRange.upperBound(zZ.firstOrArray(e.to),e.excludeTo):void 0}},e.firstOrArray=e=>1===e.length?e[0]:e}(zZ||(zZ={}));var GZ=s("pAGP"),xZ=s("2xv9"),VZ=s("p2N7"),HZ=s("Q97H"),WZ=s("DwEK"),qZ=s("4lsZ"),KZ=s("ycTR"),$Z=s("oRsZ"),ZZ=s("lDvZ"),QZ=s("JeVx"),YZ=s("9bet"),JZ=s("3iCl"),XZ=s("B7VA");var eQ,tQ=new class{constructor(){this.messageLogs=[]}checkAndLog(e,t={error_code:0}){try{if(e!==XZ.g.CMD)return;if(t.identity&&t.identity.includes("Message"))return t.migrated_count&&this.messageLogs.push(t.migrated_count),void(this.messageLogs.length>=30&&this.flushLogs());this._log({migrated_count:t.migrated_count,identity:t.identity})}catch(s){}}flushLogs(){this._log({data:this.messageLogs,identity:"MsgCount"}),this.messageLogs=[]}_log(e){Ia.default.logActionInfoV2(Ia.FeaturesInfo.DBv4Migrate,1,e,[])}},sQ=s("QO5D");const aQ={percent:0,status:xc.d.UNSET,isLowDiskSpace:!1,requiredSpace:0,error:"",migratedCount:0,toMigrateCount:0,timeElapsed:0,numOfReader:1,batchSize:5e3,count:1,pausedLastSession:!1,allowReject:!1,forceReject:!1};let iQ=Object(a.injectable)()(eQ=Object(a.singleton)()(eQ=function(e,t){return Object(a.inject)(SZ.a)(e,void 0,0)}(eQ=function(e,t){return Object(a.inject)(Dq.b)(e,void 0,1)}(eQ=Reflect.metadata("design:type",Function)(eQ=Reflect.metadata("design:paramtypes",["undefined"==typeof IMigrateRemoteConfigs?Object:IMigrateRemoteConfigs,"undefined"==typeof IDatabaseStateStorage?Object:IDatabaseStateStorage])(eQ=class{constructor(e,t){this.config=e,this.databaseStateStorage=t,this.name=void 0,this.key=void 0,this.state=void 0,this.signalDone=void 0,this.session=void 0,this.startTime=void 0,this.timeoutTimer=null,this.storageCheckingTimer=null,this.promoteSubject=void 0,this.migrateResolver=void 0,this.isMigrateStarted=void 0,this.taskScheduler=new WZ.b(new qZ.a,!1),this.logger=void 0,this.didBlockApp=!1,this.stopHandleMigrateProcessDisconnected=()=>{},this.initControllerServiceContainer=null,this.initCacheTotalMsgContainer=null,this.preparedDataProfileTimers=new Map,this.storageCheckingTimerContainer=null,this.isMigrationPaused=!1,this.didSignalProcessToStartMigration=!1,this.removeListenerFullDiskFromSM=()=>{},this.cachedIsFirstTimeMigrate=null,this.cachedTotalMsgCount=-1,this.migrateLocalInfo=null,this._lastElapsedTime=null,this.timeElapsedTimer=null,this.migrateDoneState=null,this._isTrickle=null,this.reminderTimeout=null,this.migrateProgressPercent=null,this.showSuccessScreen=!1,this.handleDBCorruption=e=>{if(this.isMigrateStarted){const{tsStartCheck:t}=e;this.handleErrorDuringBigBangMigration(`Corrupt - tsStartCheck: ${t}`),this.logger.zsymb(0,"IBcErh","[status] Pause migration due to corruption"),this.handlePauseMigrate("db-corrupt")}else this.logger.zsymb(0,"9Cr-Cl","[status] corrupt in onboarding screen. Ignore")},this.requestClearInfoDBSizeCache=async()=>{const e={type:f.f,data:{}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)},this.requestPauseMigrate=async e=>{const t={type:f.v,data:{reason:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort(),n={typeID:f.m,data:t};await i.invokeMessage(n),this.isMigrationPaused=!0},this.requestResumeMigrate=async e=>{const t={type:f.A,data:{reason:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort(),n={typeID:f.m,data:t};await i.invokeMessage(n),this.isMigrationPaused=!1},this.name=xc.a,this.key="",this.state=aQ,this.session={userId:""},this.startTime=0,this.isMigrateStarted=!1;const s=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=s.createZLogger("db-migrate",["manager"]),this.migrateResolver=new E.c.Container,this.promoteSubject=new MZ,this.taskScheduler.start(),this.handleDBMigrationMessage(),this.addDBCorruptionListener()}waitMigrateRelease(){return this.isMigrateStarted?this.migrateResolver.promise:Promise.resolve()}startHandleMigrateProcessDisconnected(){const e=a.ModuleContainer.resolve(p.b),t=[];t.push(e.addEventListener(sQ.c.ChannelDisconnected,(()=>{this.logger.zsymb(6,"fB54Yn","Migrate process disconnected")}))),t.push(e.addEventListener(sQ.c.ChannelReConnected,(()=>{this.logger.zsymb(0,"EUkN9K","Migrate process re-connected -> Resume migrate"),this.signalSQLiteProcessToStartMigrate()}))),this.stopHandleMigrateProcessDisconnected=()=>t.forEach((e=>e()))}waitForDBMigrate(e,t,s){return new Promise((async i=>{try{this.updateCurrentDisplayedMigrateUI(xc.d.INIT),this.logger.zsymb(0,"lfWqWy","Sync migrate server config",t),this.config.loadConfig(t),this.logger.zsymb(0,"6PpQI0","Sync full_disk_check server config",s),en.a.updateServerConfig(s),this.session=e,this.databaseStateStorage.authenticate(e);const n=this.getIsMigrationStarted();if(!this.enableMigrate&&!n)return this.hideMigrateUI(xc.d.DISABLED),this.scheduleReminder(),this.logger.zsymb(0,"jr_94J","[status] force skip migrate due to server config",this.enableMigrate),i(!1);if(a.ModuleContainer.resolve(Us.TDBCorruptionDetector).corruptionHasOccurred())return this.hideMigrateUI(xc.d.DISABLED),this.logger.zsymb(0,"QP6FGm","[status] force skip migrate due to corruption"),i(!1);if(this.currentUserHasMigrated())return this.hideMigrateUI(xc.d.TR_SUCCESS),this.logger.zsymb(0,"rw_urE","[status] current user migrated, no need to migrate"),i(!0);if(await $zFeatures.migrateDB.isMigrateFullDone())return this.hideMigrateUI(xc.d.TR_SUCCESS),this.logger.zsymb(0,"4J0gyE","[status] all user migrated"),i(!0);const r=Object(ZZ.a)(e.userId);if(!n&&r)return this.logger.zsymb(0,"qD80md","[status] first session, silent migrate"),this.isSilentMigrate=!0,void(await this.signalRestartAppToStartMigrate());const o=this.config.nestedKey("migrate_version"),{disable_migrate:l}=await this.getMigrateLocalInfo(o);if(l)return this.hideMigrateUI(xc.d.DISABLED),this.logger.zsymb(0,"idVvm1","[status] force skip migrate due to too many retry!"),i(!1);if(!n){if(await this.needWaitCreateBackup())return this.hideMigrateUI(xc.d.WAIT_BACKUP),this.logger.zsymb(0,"_5_o56","[status] force skip migrate to wait for backup",this.enableMigrate),YZ.a.instance().onSkipDuetoNoBackup(),i(!1)}if(this.signalDone=i,$zwindow.setLoginSize(),n&&(JZ.b.getInstance().setDisableAnalyzeCorruption(!0),this.startHandleMigrateProcessDisconnected()),n&&(this.isTrickle||this.isSilentMigrate))this.isTrickle?(this.logger.zsymb(0,"ywCYvI","[status] continue trickle"),this.startMigrateAsTrickle(),this.signalDone(!0)):(this.logger.zsymb(0,"kt9plT","[status] start silent migrate"),this.startMigrateAsSilent());else if(this.didBlockApp=!0,this.initControllerService(),n){this.logger.zsymb(0,"G9IYE4","[status] continue BigBang");let e=!1,t=0;if(!this.isFirstTimeMigrate()){this.updateCurrentDisplayedMigrateUI(xc.d.GET_READY),await this.initCacheTotalMsg();try{this.logger.zsymb(0,"OMZHYq","[storage-checking] Timestamp: Start up");const s=await this.checkStorageByProgress();e=s.isLowDiskSpace,t=s.requiredSpace}catch($Q){const t=Object(Kt.c)($Q);return this.logger.zsymb(3,"i5WV8i",["[storage-checking] Failed due to error: {}","x0oC6k"],t),YZ.a.instance().onCheckDiskError(t),void this.handleErrorDuringBigBangMigration($Q)}}e?(this.logger.zsymb(0,"z5lFOE","[status] show storage checking screen"),this.updateCurrentDisplayedMigrateUI(xc.d.STORAGE_CHECK,{isLowDiskSpace:e,requiredSpace:t})):this.startMigrateAsBigBang()}else this.logger.zsymb(0,"470KoT","[status] start migration for the 1st time"),this.logger.zsymb(0,"1KiCG7","[status] show onboarding"),await this.initCacheTotalMsg(),this.updateCurrentDisplayedMigrateUI(xc.d.ONBOARDING,{pausedLastSession:this.migratePausedLastSession()})}catch($Q){const t=Object(Kt.c)($Q);this.logger.zsymb(21,"sD2s1P",["Unexpected err: {}","4gexgx"],t),YZ.a.instance().onUnexpectedError(t)}}))}async initControllerService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.initControllerServiceContainer=new E.c.Container,this.startProfileSlowPrepareData(XZ.f.SUB_CMD.CONTROL_SERVICE);try{const e=performance.now();await this.signalSQLiteProcessToInitState();const t=performance.now();this.logger.zsymb(3,"gNFnaL",["[prepare][success] 'initState' cost: {}","feLL-O"],t-e)}catch($Q){const t=Object(Kt.c)($Q);YZ.a.instance().onSlowPreparedData(XZ.f.SUB_CMD.CONTROL_SERVICE,XZ.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"OXvYB0",["[prepare][failed] 'initState': {}","Kt7eiu"],t)}this.stopProfileSlowPrepareData(XZ.f.SUB_CMD.CONTROL_SERVICE),this.initControllerServiceContainer.resolve()}async initCacheTotalMsg(){if(null!==this.initCacheTotalMsgContainer)return this.initCacheTotalMsgContainer.promise;this.initCacheTotalMsgContainer=new E.c.Container,this.startProfileSlowPrepareData(XZ.f.SUB_CMD.TOTAL_MSG);try{const e=performance.now();await this.getTotalMsgCount(!1);const t=performance.now();this.logger.zsymb(3,"6t6MnB",["[prepare][success] 'totalMsg' cost: {}","JRYk5d"],t-e)}catch($Q){const t=Object(Kt.c)($Q);YZ.a.instance().onSlowPreparedData(XZ.f.SUB_CMD.TOTAL_MSG,XZ.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"tluSys",["[prepare][failed] 'totalMsg': {}","P9gEfC"],t)}this.stopProfileSlowPrepareData(XZ.f.SUB_CMD.TOTAL_MSG),this.initCacheTotalMsgContainer.resolve()}startProfileSlowPrepareData(e){let t=this.preparedDataProfileTimers.get(e);void 0===t&&(t=[setTimeout((()=>{YZ.a.instance().onSlowPreparedData(e,XZ.f.ERR_CODE["10s"])}),1e4),setTimeout((()=>{YZ.a.instance().onSlowPreparedData(e,XZ.f.ERR_CODE["20s"])}),2e4),setTimeout((()=>{YZ.a.instance().onSlowPreparedData(e,XZ.f.ERR_CODE["30s"])}),3e4)],this.preparedDataProfileTimers.set(e,t))}stopProfileSlowPrepareData(e){const t=this.preparedDataProfileTimers.get(e);t&&(t.forEach((e=>clearTimeout(e))),this.preparedDataProfileTimers.delete(e))}waitUntilFinishInitService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.logger.zsymb(18,"04AkLR","Service hasn't been init yet")}cleanupInternalState(){n.default.getInstance().removeItemForCurrentUser(OZ.f),this.databaseStateStorage.removeItemForCurrentUser(OZ.d),this.databaseStateStorage.removeItemForCurrentUser(OZ.c)}async cleanupData(){const e=this.currentUserHasMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();(e||t)&&this.config.nestedKey("drop_idb")&&(QZ.a.instance().unlock(),QZ.a.instance().deleteOldDB(this.session))}updateCurrentDisplayedMigrateUI(e,t){this.updateState(Object(I.a)({status:e},t||{}))}hideMigrateUI(e){this.updateState({status:e}),$zapp.setMainWindowResizable(!0)}startStorageCheckingTimer(){null===this.storageCheckingTimer&&(this.storageCheckingTimer=setTimeout((async()=>{this.taskScheduler.run({execute:async()=>{this.storageCheckingTimer=null,this.logger.zsymb(0,"g7tpQH","[storage-checking] Timestamp: During BigBang migration");let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch($Q){this.logger.zsymb(21,"kYzvT0",["Failed to get migrate disk info by progress due to error: {}","4bRdUe"],Object(Kt.c)($Q))}const{isLowDiskSpace:t,requiredSpace:s}=e||{isLowDiskSpace:!1,requiredSpace:0};if(t)return await this.handlePauseMigrate("low-disk"),this.logger.zsymb(0,"07GqVi","[status] Pause migration due to low disk (storage checking interval)"),this.stopBigBangMigrationTimers(),this.logger.zsymb(0,"duYUxZ","[status] show storage checking screen"),this.storageCheckingTimerContainer=new E.c.Container,this.updateCurrentDisplayedMigrateUI(xc.d.STORAGE_CHECK,{isLowDiskSpace:t,requiredSpace:s}),this.storageCheckingTimerContainer.promise;this.startStorageCheckingTimer()}})}),5e3))}stopStorageCheckingTimer(){null!==this.storageCheckingTimer&&(clearTimeout(this.storageCheckingTimer),this.storageCheckingTimer=null)}async getCurrentMigrateProgress(){if(null===this.migrateProgressPercent){const{migratedCount:e,toMigrateCount:t}=await this.calculateCurrentMigrateProgress();if(-1===e||-1===t)throw new Error("Failed to get current migrate progress");const s=e/t;this.migrateProgressPercent=s}return this.migrateProgressPercent}async signalGetCurrentMigrateProgress(){const e={type:f.q,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};return await s.invokeMessage(i)}async calculateCurrentMigrateProgress(){return this.logger.zsymb(0,"dZ4GJU","Get current progress from migrate controller"),this.signalGetCurrentMigrateProgress()}async getEstimatedSQLiteSize(e){const t=this.config.nestedKey("total_msg_ratio"),s=this.config.nestedKey("delta_size_estimated_sqlite"),a=this.config.nestedKey("min_estimated_sqlite_size");return Math.max(t*e+s,a)}async getMigrateDiskInfoByProgress(e){const t=Ki.a.analyzeMainDisk();if(!t)throw new Error("Failed to get disk info");const{total:s,free:a}=t,{secondAlmostFullThreshold:i}=this.getAlmostFullStorageThreshold(s),n=await this.getTotalMsgCount(e),r=await this.getEstimatedSQLiteSize(n),o=await this.getCurrentMigrateProgress(),l=r*(1-o),c=this.config.nestedKey("delta_size_storage_checking");let d=0;d=a>i?l+i+c:l+i;const u=E.h.bytesToMB(a),h=E.h.bytesToMB(d),g=Math.ceil(u)<Math.ceil(h);return g?this.logger.zsymb(3,"NA0i5t",["[storage-checking][progress] FAILED   - Required: {} - Actual: {} - Progress: {}","XRTgJg"],Object(VZ.a)(d),Object(VZ.a)(a),o.toFixed(3)):this.logger.zsymb(3,"tb2gtb",["[storage-checking][progress] PASSED   - Required: {} - Actual: {} - Progress: {}","qYdst0"],Object(VZ.a)(d),Object(VZ.a)(a),o.toFixed(3)),{isLowDiskSpace:g,requiredSpace:d}}async handleResumeMigrate(e){this.didSignalProcessToStartMigration?(null!==this.storageCheckingTimerContainer&&(this.storageCheckingTimerContainer.resolve(),this.storageCheckingTimerContainer=null),this.logger.zsymb(0,"SJLBgU","[status] resume"),this.startBigBangMigrationTimers(),this.startHandleMigrateProcessDisconnected(),await this.requestResumeMigrate(e),this.logger.zsymb(0,"-csXxo","[status] show in-progress screen"),this.updateCurrentDisplayedMigrateUI(xc.d.BB_IN_PROGRESS)):this.startMigrateAsBigBang()}async handlePauseMigrate(e){this.stopBigBangMigrationTimers(),this.stopHandleMigrateProcessDisconnected(),await this.requestPauseMigrate(e)}async checkStorageByProgress(){let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch($Q){throw this.logger.zsymb(21,"jsI3AQ",["Failed to get migrate disk info by progress due to error: {}","4bRdUe"],Object(Kt.c)($Q)),$Q}return e}async startMigrateAsSilent(){this.updateCurrentDisplayedMigrateUI(xc.d.INIT,{pausedLastSession:this.migratePausedLastSession()}),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async startMigrateAsTrickle(){this.hideMigrateUI(xc.d.TR_IN_PROGRESS),this.listenFullDiskFromSM(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async getRejectConfig(){let e=!1,t=!1;try{const s=this.config.nestedKey("migrate_version"),a=this.config.nestedKey("max_retry_count"),i=await this.getMigrateLocalInfo(s),{current_retry_count:n}=i;e=n>0,t=n>=a}catch($Q){const t=Object(Kt.c)($Q);this.logger.zsymb(21,"tVKaru",["Failed to get reject config: {}","2dsaMu"],t)}return{allowReject:e,forceReject:t}}async startMigrateAsBigBang(){const{allowReject:e,forceReject:t}=await this.getRejectConfig();let s=0;if(!this.isFirstTimeMigrate())try{const e=Math.min(100*await this.getCurrentMigrateProgress(),100);s=this.getMigratePercent(e).percent}catch($Q){this.logger.zsymb(21,"Sl9Cbi",["Failed to get current migrate progress: {}","mFFi0N"],Object(Kt.c)($Q))}this.logger.zsymb(3,"H-rmgy",["[status] show in-progress screen","c4-J5i"]),await this.waitUntilFinishInitService(),this.updateCurrentDisplayedMigrateUI(xc.d.BB_IN_PROGRESS,{pausedLastSession:this.migratePausedLastSession(),allowReject:e,forceReject:t,percent:this.formatPercent(s)}),this.startBigBangMigrationTimers(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}listenFullDiskFromSM(){const e=async e=>{var t;const s=null==e||null===(t=e.payload)||void 0===t?void 0:t.level;if(s)switch(s){case Cn.e.FULL:this.isMigrationPaused||(this.logger.zsymb(0,"wzqHMU","[status] Pause migration due to full disk (SM signal)"),this.stopHandleMigrateProcessDisconnected(),this.requestPauseMigrate("full-disk"));break;case Cn.e.RICH_SPACE:case Cn.e.ALMOST_FULL_1:case Cn.e.ALMOST_FULL_2:this.isMigrationPaused&&(this.logger.zsymb(3,"prKd0r",["[status] Resume migration (SM signal: {})","YUH5QG"],s),this.startHandleMigrateProcessDisconnected(),this.requestResumeMigrate("sm-signal"))}};me.a.DiskStatusManager.addEventListener(Sn.ResDisk_CurrentLevel,e),this.removeListenerFullDiskFromSM=()=>me.a.DiskStatusManager.removeEventListener(Sn.ResDisk_CurrentLevel,e)}getAlmostFullStorageThreshold(e){let{firstAlmostFullThreshold:t,secondAlmostFullThreshold:s}=en.a.getServerConfigThreshold();let a=-1,i=-1;if(en.a.lowCapacityDevice){a=t*e,i=s*e}else a=E.h.sizeInByte(`${t}GB`),i=E.h.sizeInByte(`${s}GB`);return{firstAlmostFullThreshold:a,secondAlmostFullThreshold:i}}async handleStartMigrate(){this.skipCheckStorageWhenStartupOnce(),await this.signalRestartAppToStartMigrate()}skipCheckStorageWhenStartupOnce(){n.default.getInstance().setItemForCurrentUser(OZ.a,"1")}isFirstTimeMigrate(){if(null!==this.cachedIsFirstTimeMigrate)return this.cachedIsFirstTimeMigrate;const e=n.default.getInstance(),t=null!==e.getItemForCurrentUser(OZ.a);return t&&e.removeItemForCurrentUser(OZ.a),this.cachedIsFirstTimeMigrate=t,this.cachedIsFirstTimeMigrate}async handleRetryMigrate(){this.logger.zsymb(0,"v4XniA","[retry] start");try{await this.increaseRetryCount(),await this.signalRestartAppToRetryMigrate(),this.logger.zsymb(0,"dhc6xD","[retry] done ")}catch($Q){throw this.logger.zsymb(21,"DEmvjO",["[retry] fail : {}","2cVxwO"],Object(Kt.c)($Q)),$Q}}async handleRejectMigrate(){this.logger.zsymb(18,"hsknO7","[reject] start");try{this.resetState(),YZ.a.instance().onUserRejectDuetoError(),await this.disableMigrateAfterTooManyRetry(),await this.signalRestartAppToRejectMigrate(),this.logger.zsymb(18,"V2RzDR","[reject] done ")}catch($Q){throw this.logger.zsymb(21,"rfiEmX",["[reject] fail : {}","fy8FS8"],Object(Kt.c)($Q)),$Q}}async getTotalMsgCount(e=!0){const t=async()=>{const e=$Z.a.baseConfig.name,t=Object(KZ.a)(e,wZ.a.IDB),s=new BZ({session:this.session,dbConfig:t});try{return await s.count($Z.a.schema.Message)}catch($Q){if(kZ.ignoreable($Q.name,$Q.code))return 0;throw $Q}finally{s.closeConnection()}};return-1!==this.cachedTotalMsgCount&&e||(this.cachedTotalMsgCount=await t()),this.cachedTotalMsgCount}async increaseRetryCount(){const e=this.config.nestedKey("migrate_version"),{current_retry_count:t}=await this.getMigrateLocalInfo(e);await this.updateMigrateLocalInfo(e,{current_retry_count:t+1})}async disableMigrateAfterTooManyRetry(){const e=this.config.nestedKey("migrate_version");await this.updateMigrateLocalInfo(e,{disable_migrate:!0})}async getMigrateLocalInfo(e){return null===this.migrateLocalInfo&&(this.migrateLocalInfo=await $zFeatures.migrateDB.getMigrateLocalInfo(e,this.session.userId)),this.migrateLocalInfo}async updateMigrateLocalInfo(e,t){null!==this.migrateLocalInfo&&(this.migrateLocalInfo=Object(I.a)(Object(I.a)({},this.migrateLocalInfo),t)),await $zFeatures.migrateDB.updateMigrateLocalInfo(e,this.session.userId,t)}resetState(){n.default.getInstance().removeItemForCurrentUser(OZ.f)}promoteMigrateByOpenConv(e){this.promoteSubject.promoteForOpenConv(e)}async signalRestartAppToStartMigrate(){YZ.a.instance().onStartMigrate(),this.setAdaperTypeForDAL(wZ.a.SQLite),HZ.a.closeDB((()=>{$zFeatures.migrateDB.signalRestartAppToMigrate()}),{idbTimeout:0})}async signalRestartAppToRejectMigrate(){await this.signalSQLiteProcessToResetProgress(),await $zFeatures.migrateDB.signalRestartAppToMigrate()}async signalSQLiteProcessToResetProgress(){const e={type:f.z,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}async signalRestartAppToRetryMigrate(){$zFeatures.migrateDB.signalRestartAppToMigrate()}releaseBlockingAppLogic(){this.signalDone(!0)}setAdaperTypeForDAL(e){const t=this.databaseStateStorage.getObject(Lq.a)||{},s=Object(I.a)(Object(I.a)({},t),{},{shared:e,[this.session.userId]:e});this.databaseStateStorage.setObject(Lq.a,s)}get enableMigrate(){return this.config.nestedKey("enable")}get maxBURetries(){return this.config.nestedKey("max_retries_create_bu")}get timeoutDuration(){return this.config.nestedKey("max_timeout_duration")}get lastElapsedTime(){if(null===this._lastElapsedTime){const e=n.default.getInstance();this._lastElapsedTime=e.getIntForCurrentUser(OZ.f,{defaultInt:0})}return this._lastElapsedTime}resetLastElapsedTimeCached(){this._lastElapsedTime=null}getCurrentElapsedTime(){return 0===this.startTime?this.lastElapsedTime:Date.now()-this.startTime+this.lastElapsedTime}recordTimeElapsed(){const e=this.getCurrentElapsedTime();n.default.getInstance().setItemForCurrentUser(OZ.f,e.toString())}startRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer),this.startTime=Date.now(),this.resetLastElapsedTimeCached(),this.timeElapsedTimer=setInterval((()=>{this.recordTimeElapsed()}),1e3)}stopRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer)}getMigrateDoneState(){if(null===this.migrateDoneState){const e=this.databaseStateStorage.getItem(OZ.e);if(e)try{this.migrateDoneState=JSON.parse(e)}catch($Q){this.logger.zsymb(21,"mgyeJB",["Failed to parse migrate done state: {}","mVUR9Z"],Object(Kt.c)($Q))}else this.migrateDoneState={}}return this.migrateDoneState}updateMigrateDoneState(e){this.migrateDoneState=Object(I.a)(Object(I.a)({},this.migrateDoneState),e);const t=JSON.stringify(this.migrateDoneState);this.databaseStateStorage.setItem(OZ.e,t)}currentUserHasMigrated(){const e=this.getMigrateDoneState();return Boolean(e&&e[this.session.userId])}async currentUserHasMigratedInAnyPhase(){const e=this.currentUserHasMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();return e||t}async allUserHasMigrated(){const e=await Object(Yi.a)(),t=this.getMigrateDoneState();return Boolean(t&&Object.keys(t).length==e.length)}migratePausedLastSession(){if(this.currentUserHasMigrated())return!1;return!!n.default.getInstance().getItemForCurrentUser(OZ.f)}async needWaitCreateBackup(){const e=await $zFeatures.migrateDB.checkNeedWaitBackup(this.maxBURetries);return this.logger.zsymb(0,"tzdg2X","needWaitCreateBackup",this.maxBURetries,e),e}startTimeoutPoint(){if(null!==this.timeoutTimer)return;const e=Math.max(this.timeoutDuration-this.lastElapsedTime,0);this.timeoutTimer=setTimeout((()=>{this.taskScheduler.run({execute:()=>{this.timeoutTimer=null,this.stopBigBangMigrationTimers(),this.isTrickle=!0,this.logger.zsymb(0,"65_2FB","[status] done big bang migration due to timeout"),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.listenFullDiskFromSM(),this.removeDBCorruptionListener(),this.taskScheduler.stop()}})}),e)}get isTrickle(){return null===this._isTrickle&&(this.currentUserHasMigrated()?this._isTrickle=!0:this._isTrickle=!!this.databaseStateStorage.getIntForCurrentUser(OZ.d,{defaultInt:0})),this._isTrickle}set isTrickle(e){this._isTrickle!==e&&(this._isTrickle=e,0==e?this.databaseStateStorage.removeItemForCurrentUser(OZ.d):this.databaseStateStorage.setItemForCurrentUser(OZ.d,"1"))}startBigBangMigrationTimers(){this.startTimeoutPoint(),this.startStorageCheckingTimer(),this.startRecordingTimeElapsed()}stopBigBangMigrationTimers(){this.stopTimeoutPoint(),this.stopStorageCheckingTimer(),this.recordTimeElapsed(),this.stopRecordingTimeElapsed()}set isSilentMigrate(e){e?this.databaseStateStorage.setItemForCurrentUser(OZ.c,"1"):this.databaseStateStorage.removeItemForCurrentUser(OZ.c)}get isSilentMigrate(){return!!this.databaseStateStorage.getIntForCurrentUser(OZ.c,{defaultInt:0})}stopTimeoutPoint(){null!==this.timeoutTimer&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async skipMigrate(){this.logger.zsymb(0,"8ztJVb","[skip]"),this.logger.zsymb(0,"-iA9np","[status] hide migrate ui due to skip"),this.hideMigrateUI(xc.d.SKIP),this.removeDBCorruptionListener(),this.signalDone(!1);try{await this.requestClearInfoDBSizeCache(),this.logger.zsymb(3,"VzpW-F",["[status] clear info db size cache success","KD_YT4"])}catch(e){this.logger.zsymb(21,"FAhDYq",["[status] an error occured due to clear info db size cache. {}","m7wjUa"],Object(Kt.c)(e))}}scheduleReminder(){if(null===this.reminderTimeout){const e=this.config.nestedKey("auto_remind_modal_timeout");this.updateState({isLowDiskSpace:!1,requiredSpace:0}),this.logger.zsymb(0,"y6mKHo","[reminder] init -  timeout: {}ms",e),this.reminderTimeout=setTimeout((async()=>{this.reminderTimeout=null,this.logger.zsymb(0,"hOp_LR","[reminder] expired"),this.enableMigrate?this.handleShowOnboardingModal():this.scheduleReminder()}),e)}}handleShowOnboardingModal(){this.logger.zsymb(0,"gLXdoj","[modal] show"),Ie.ModalManagerV2.openModal({windowId:hr.c,name:Y.ModalIdentitiesDefine.DATA_MIGRATION,params:!0})}markDoneMigrate(){$zFeatures.migrateDB.signalDoneFullMigrate(),this.promoteSubject.setShouldPromote(!1)}async markDoneMigrateForCurrentUser(){const e=a.ModuleContainer.resolve(GZ.a);await e.setAdapterTypeOfUserScopedDatabases(this.session.userId,wZ.a.SQLite),await e.setAdapterTypeOfSharedDatabases(wZ.a.SQLite),this.updateMigrateDoneState({[this.session.userId]:Date.now()}),this.databaseStateStorage.removeItemForCurrentUser(OZ.d)}async signalSQLiteProcessToInitState(){const e={type:f.r,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}async signalSQLiteProcessToStartMigrate(){this.isMigrateStarted=!0;const e={type:f.G,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}formatPercent(e){return e.toFixed(0)}async onMigrationProgress(e){const{data:t}=e,{error:s,migratedCount:i,toMigrateCount:n}=t;if(this.isTrickle||this.isSilentMigrate){if(s){this.migrateResolver.resolve(),JZ.b.getInstance().setDisableAnalyzeCorruption(!1);a.ModuleContainer.resolve(Us.TDBCorruptionDetector).forceCheckDBCorruptionFor(wZ.a.IDB)}}else{const e=-1!==i?Math.min(100,100*i/n):100;this.migrateProgressPercent=i/n;const{percent:t,timeElapsed:a}=this.getMigratePercent(e);0,100===t&&this.logger.zsymb(3,"s27-E5",["progress 100 - migrateProgress: {} - timeoutProgress: {}","6Qb-uM"],e,Math.min(100*a/this.timeoutDuration,100));const r={timeElapsed:a};s?this.handleErrorDuringBigBangMigration(s.message||s):this.updateState(Object(I.a)({percent:this.formatPercent(t)},r))}}getMigratePercent(e){const t=this.getCurrentElapsedTime(),s=Math.min(100*t/this.timeoutDuration,100);return{percent:Math.max(e,s),timeElapsed:t}}handleErrorDuringBigBangMigration(e){this.isTrickle||this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers();const t=Object(Kt.c)(e);this.logger.zsymb(3,"fGM989",["[status] show error screen - error: {}","6Ip6T1"],t),this.updateCurrentDisplayedMigrateUI(xc.d.BB_FAILED,{error:t});return new Promise((()=>{}))}})}showBigBangSuccessScreen(){this.showSuccessScreen||(this.showSuccessScreen=!0,this.logger.zsymb(0,"dgtn1P","[status] show success screen"),this.updateCurrentDisplayedMigrateUI(xc.d.BB_SUCCESS,{timeElapsed:this.getCurrentElapsedTime()}))}disposeMigrationUI(e){const t=()=>{this.logger.zsymb(0,"EminYE","[status] hide migrate ui due to release blocking ui"),this.hideMigrateUI(xc.d.TR_IN_PROGRESS),this.releaseBlockingAppLogic()};if(e){const e=this.config.nestedKey("auto_dismiss_success_screen");setTimeout(t,e)}else t()}async updateMigrateStateAsFinished(e){this.logger.zsymb(0,"AITRIB","[status] finish migrate"),await this.markDoneMigrateForCurrentUser(),await this.allUserHasMigrated()&&this.markDoneMigrate(),this.migrateResolver.resolve(),JZ.b.getInstance().setDisableAnalyzeCorruption(!1)}async handleDBMigrationMessage(){const e=a.ModuleContainer.resolve(p.b),t=await e.getPort(),s=async e=>{const{data:a}=e,{typeID:i}=a;if(i===f.m){const{data:e}=a,{type:i}=e;switch(i){case f.B:this.onMigrationProgress(e);break;case f.o:{const{data:a}=e;await this.updateMigrateStateAsFinished(a),this.removeListenerFullDiskFromSM(),this.isTrickle||(this.isSilentMigrate?(this.isSilentMigrate=!1,this.disposeMigrationUI(!1)):(this.logger.zsymb(0,"SQ8rIE","[status] done big bang migration due to finish migration"),this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers(),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.taskScheduler.stop()}}))),this.cleanupData(),this.cleanupInternalState(),this.stopHandleMigrateProcessDisconnected(),t.removeEventListener("message",s),this.removeDBCorruptionListener(),tQ.flushLogs();break}case f.y:{const{data:t}=e,{success:s,cmd:a,subCmd:i,duration:n,payload:r}=t;YZ.a.instance().submitQos(s,a,i,n,r),tQ.checkAndLog(a,r);break}}}};t.addEventListener("message",s)}addDBCorruptionListener(){a.ModuleContainer.resolve(Us.TDBCorruptionDetector).addEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}removeDBCorruptionListener(){a.ModuleContainer.resolve(Us.TDBCorruptionDetector).removeEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}getIsMigrationStarted(){const e=Object(xZ.a)();let t=e;try{t=this.databaseStateStorage.getObject(Lq.a)||e}catch($Q){this.logger.zsymb(18,"SA01Sx","parse adapter type state error",Object(Kt.c)($Q))}return t[this.session.userId]===wZ.a.SQLite}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}updateState(e){this.state=Object(I.a)(Object(I.a)({},this.state),e),Object(Po.h)(this.name,xc.c)}})||eQ)||eQ)||eQ)||eQ)||eQ)||eQ;"render"==__ZaBUNDLENAME__&&(a.ModuleContainer.registerSingleton(xc.b,iQ),a.ModuleContainer.registerSingleton(Ai.a,iQ));s("uiYo");var nQ,rQ=s("f4Qu"),oQ=s("Dprd"),lQ=s("XSmZ");Object(m.e)()(nQ=Object(As.e)()(nQ=Object(a.singleton)(rQ.a)(nQ=Reflect.metadata("design:type",Function)(nQ=Reflect.metadata("design:paramtypes",[])(nQ=class{constructor(){this.logger=void 0,this.confirmQuitApp=()=>{this.logger.zsymb(3,"7_JaQm",["confirm app quit","o-n3RV"]);const e=this.getConfirmInfo();if(e){const t=()=>{this.logger.zsymb(3,"mwYn2B",["abort app quit","wwOQcn"]),$zapp.cancelQuitApp()};this.showConfirm(e.confirmTitle,this.doQuitApp,t)}else this.doQuitApp()},this.doQuitApp=()=>{this.logger.zsymb(3,"uE2KFm",["do quit app","eF7Wcw"]),dd.a.getInstance().storeItems(),fv.b.deactiveApp(),a.ModuleContainer.resolve(WI.a).onUserLogOff().then((e=>{HZ.a.clearSessionBeforeQuit(),HZ.a.closeDB($zapp.requestQuitAppImmediately)}))},this.onAppBeforeQuit=()=>{this.logger.zsymb(3,"TijqaB",["onAppBeforeQuit","mZ6Drd"]),$zFileManager.requestFlushZLog(),Me.g.getAvailableUpdate()&&Me.g.setAvailableUpdate(null)};const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("app-quit-flow",["main-window"])}onApplicationStart(e){this.logger.zsymb(3,"jt_x9q",["onApplicationStart","Z6oLcs"]),$zsub.$zapp.onConfirmAppQuit(this.confirmQuitApp),$zsub.$zapp.beforeAppQuit(this.onAppBeforeQuit)}onDispose(){this.logger.zsymb(3,"L56fkm",["onDispose","Y5i3B4"]),$zsub.$zapp.removeListenConfirmAppQuit(this.confirmQuitApp),$zsub.$zapp.removeListenBeforeAppQuit(this.onAppBeforeQuit)}requestQuitApp(){this.logger.zsymb(3,"h370SI",["request quit app","L-2kUY"]),$zwindow.quit()}getConfirmInfo(){let e=+$l.b.isUploading();!e&&oQ.default&&oQ.default.isDownloading()&&(e=2);let t=!1,s="";const a=lQ.default.isStarted;if(e>0&&a){const a=1===e?le.a.str("STR_CONFIRM_QUIT_UPLOAD_TEXT"):le.a.str("STR_CONFIRM_QUIT_DOWNLOAD_TEXT");s=`${le.a.str("STR_CONFIRM_QUIT_EXPORT_IMPORT_1")} ${a} ${le.a.str("STR_CONFIRM_QUIT_DOWNLOAD_SECOND")}`,t=!0}else if(a)s=`${le.a.str("STR_CONFIRM_QUIT_EXPORT_IMPORT")}`,t=!0;else if(e>0){const a=1===e?le.a.str("STR_CONFIRM_QUIT_UPLOAD_TEXT"):le.a.str("STR_CONFIRM_QUIT_DOWNLOAD_TEXT");s=`${le.a.str("STR_CONFIRM_QUIT_DOWNLOAD_FIRST")} ${a} ${le.a.str("STR_CONFIRM_QUIT_DOWNLOAD_SECOND")}`,t=!0}return t?{confirmTitle:s}:null}showConfirm(e,t,s){qo.ConfirmManagerV2.openConfirm({windowId:hr.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:e,okText:le.a.str("STR_TITLE_PROFILE_EXIT"),cancelText:le.a.str("STR_CONFIRM_NO"),onOk:t,onCancel:s}})}requestRelaunch(){this.logger.zsymb(3,"bsC-nF",["just relaunch app","HSIL53"]),$zapp.requestRelaunch()}})||nQ)||nQ)||nQ)||nQ);const cQ=Object(a.define)("db-encrypt-remote-configs");var dQ,uQ=s("8zvx"),hQ=s("FKEL");E.j.timeInMs("1s"),E.j.timeInMs("100ms");const gQ={enable:!1,start_after:E.j.timeInMs("12s"),gap:E.j.timeInMs("200ms"),max_retry:3};Object(a.singleton)(cQ)(dQ=Reflect.metadata("design:type",Function)(dQ=Reflect.metadata("design:paramtypes",[])(dQ=class extends uQ.a{constructor(){super("db_encrypt",gQ,{validator:new hQ.a({enable:ee.b.field().boolean(),start_after:ee.b.field().number().min(0),gap:ee.b.field().number().min(10),max_retry:ee.b.field().number().max(10)})})}loadConfig(e){super.loadConfig(e)}})||dQ)||dQ);const mQ=Object(a.define)("database-encryption");var pQ=s("Brnv"),fQ=function(e){return e.NotStart="NotStart",e.Running="Running",e.Paused="Paused",e.Stopped="Stopped",e.Finished="Finished",e}(fQ||{});class vQ{constructor(){this.status=void 0,this.status=fQ.NotStart}canStart(){return this.status==fQ.NotStart||this.status==fQ.Paused}canPause(){return this.status==fQ.Running}start(){this.status=fQ.Running}pause(){this.status=fQ.Paused}stop(){this.status=fQ.Stopped}finish(){this.status=fQ.Finished}toString(){return this.status}}class _Q{constructor(e){this.taskInput=e}async run(){const e=a.ModuleContainer.resolve(p.b);return(await e.getPort()).invokeMessage(this.taskInput)}async onOnce(e){const t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i=async t=>{const{data:a}=t,{typeID:n}=a;if(n===this.taskInput.typeID){const{data:t}=a;t.type===this.taskInput.data.type&&(e(t.data),s.removeEventListener("message",i))}};s.addEventListener("message",i)}}class bQ extends _Q{constructor(e){super({typeID:f.l,data:{type:f.H,data:e}})}}class IQ extends _Q{constructor(e={}){super({typeID:f.l,data:{type:f.w,data:e}})}}class yQ extends _Q{constructor(e={}){super({typeID:f.l,data:{type:f.t,data:e}})}}class SQ extends _Q{constructor(e={}){super({typeID:f.l,data:{type:f.d,data:e}})}}const CQ=152080,EQ=0,OQ=152081,MQ=0;class TQ{onEncryptionStart(){ul.default.increaseSuccess(CQ,EQ,0)}onEncryptionFinish(e){const t=e.stats;e.success?ul.default.increaseSuccess(OQ,MQ,0,[JSON.stringify(t)]):ul.default.increaseFailed(OQ,MQ,0,t.failure/5,0,[JSON.stringify(t)])}onStartEncryptFail(e){ul.default.increaseFailed(CQ,EQ,0,null==e?void 0:e.code,0,[JSON.stringify(null==e?void 0:e.message)])}}var wQ=s("PObO"),RQ=s("UPII");let LQ=function(e){return e.NotStarted="notStarted",e.Running="running",e.Finished="finished",e}({});class DQ{constructor(){this.capturing=!1,this.handleCaptureStatusChanged=(e,t)=>{this.capturing=t}}start(){$zsub.$zscreencap.onChangeStatus(this.handleCaptureStatusChanged)}dispose(){$zsub.$zscreencap.removeListenChangeStatus(this.handleCaptureStatusChanged)}isCalling(){return Kl.d.isCalling()}isCapturing(){return this.capturing}isTransferring(){return a.ModuleContainer.resolve(Gg.a).isThisSessionSyncing()}isImportExporting(){return lQ.default.isStarted}isAppBusy(){return this.isCalling()||this.isCapturing()||this.isTransferring()||this.isImportExporting()}}var AQ;Object(m.f)()(AQ=Object(m.j)()(AQ=Object(m.h)()(AQ=Object(a.injectable)()(AQ=Object(a.singleton)(mQ)(AQ=function(e,t){return Object(a.inject)(cQ)(e,void 0,0)}(AQ=function(e,t){return Object(a.inject)(pQ.b)(e,void 0,1)}(AQ=Reflect.metadata("design:type",Function)(AQ=Reflect.metadata("design:paramtypes",[void 0===cQ?Object:cQ,void 0===pQ.IDatabaseStateStorage?Object:pQ.IDatabaseStateStorage])(AQ=class{constructor(e,t){this.config=e,this.databaseStorage=t,this.status=void 0,this.session=void 0,this.startTimmer=void 0,this.scheduler=void 0,this.handleEventQueue=void 0,this.listenEncryptTask=void 0,this.helper=void 0,this.logger=void 0,this.canTriggerEncrypt=async()=>{if(!this.config.nestedKey("enable"))return this.logger.zsymb(0,"QC45DW","[Trigger encrypt] - Disable by config"),Promise.resolve(!1);if(this.startTimmer)return this.logger.zsymb(0,"Hye-ml","[Trigger encrypt] - timmer is running"),Promise.resolve(!1);if(!this.status.canStart())return this.logger.zsymb(0,"qmthDa","[Trigger encrypt] - Invalid status:",this.status.toString()),Promise.resolve(!1);if(null==this.session)return this.logger.zsymb(0,"3mqcco","[Trigger encrypt] - not authen yet"),Promise.resolve(!1);const e=a.ModuleContainer.resolve(xc.b).currentUserHasMigratedInAnyPhase();return await e?Promise.resolve(!0):(this.logger.zsymb(0,"FmkcHA","[Trigger encrypt] - Need wait done migrate to SQLite"),Promise.resolve(!1))},this.handleAppVisiblityChange=(e,t)=>{this.handleEventQueue.pushTask((async()=>{this.logger.zsymb(0,"SRpQYM","Visiblity changed:",t.state),"visible"==t.state&&(this.removeStartTimer(),await this.pause()),"hidden"==t.state&&(this.helper.isCapturing()||this.helper.isCalling()?this.logger.zsymb(0,"h-3oaG","app is capturing or calling"):(await this.start(),this.listenEncryptResult()))}))},this.status=new vQ,this.session=null,this.startTimmer=null,this.scheduler=new RQ.b,this.handleEventQueue=new RQ.b,this.listenEncryptTask=null,this.helper=new DQ;const s=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=s.createZLogger("db-encryption",["manager"])}onAuthenticated(e){this.session=e.getSession(),this.databaseStorage.authenticate(e.getSession())}onStart(){this.helper.start(),this.setupEvents(),this.checkMigrateAbnormaly()}onDispose(){this.clearEvents()}checkMigrateAbnormaly(){this.handleEventQueue.pushTask((async()=>{if(await(new SQ).run()!==LQ.Running)return;this.logger.zsymb(18,"s2QLMs","The encryption is running in DB process"),this.status.start();"hidden"==await $zapp.getAppVisibilityStatus()?(this.logger.zsymb(0,"LL9Wj2","App still hidden, recover"),this.listenEncryptResult()):(this.logger.zsymb(0,"PZzLHP","App visible, pause"),this.pause())}))}setupEvents(){$zsub.$zapp.onAppVisibilityChanged(this.handleAppVisiblityChange)}clearEvents(){this.logger.zsymb(18,"QFMtKi","clear all event listeners"),$zsub.$zapp.removeListenAppVisibilityChanged(this.handleAppVisiblityChange),this.listenEncryptTask=null,this.helper.dispose()}async start(){const e=this.scheduler.pushTask(this.canTriggerEncrypt);if(!(await e))return!1;const t=this.config.nestedKey("start_after");return this.logger.zsymb(0,"5SzX9K","schedule to check start",t),this.startTimmer=setTimeout((async()=>{this.startTimmer=null,this.helper.isAppBusy()&&this.logger.zsymb(0,"et-hxc","[Timer expires] - app is busy, skip"),this.doStart()}),t),!0}pause(){return new Promise((e=>this.status.canPause()?(this.doPause(),e(!0)):(this.logger.zsymb(0,"UX2s0S","Current status:",this.status.toString()),e(!1))))}async doStart(){this.logger.zsymb(0,"P0XeVw","Check start - currStatus:",this.status.toString()),this.status.start();const e=await a.ModuleContainer.resolve(wQ.a).getUserScopeKey(),t=await a.ModuleContainer.resolve(wQ.a).getSharedKey();return new bQ({enable:this.config.nestedKey("enable"),gap:this.config.nestedKey("gap"),maxRetry:this.config.nestedKey("max_retry"),cipher:{userKey:e,sharedKey:t}}).run().then((e=>(e?(this.logger.zsymb(0,"WTufPd","Started encrypt databases."),(new TQ).onEncryptionStart()):(this.logger.zsymb(0,"GmNnkb","Task is not running."),this.status.stop(),this.clearEvents()),e))).catch((e=>(this.logger.zsymb(0,"sVkPSf","Fail to start.",null==e?void 0:e.message),this.status.stop(),this.clearEvents(),(new TQ).onStartEncryptFail(e),!1)))}doPause(){this.logger.zsymb(0,"JavZMP","doPause - currStatus:",this.status.toString()),this.status.pause();return(new IQ).run()}listenEncryptResult(){this.listenEncryptTask||(this.listenEncryptTask=new yQ,this.listenEncryptTask.onOnce((e=>{const t=Object(uv.f)(e);this.logger.zsymb(0,"jAcjzG","Done encrypt All DB",t),this.clearEvents(),this.status.stop(),(new TQ).onEncryptionFinish(e)})))}removeStartTimer(){this.startTimmer&&(clearTimeout(this.startTimmer),this.startTimmer=null,this.logger.zsymb(0,"a_k0yK","remove start timmer"))}})||AQ)||AQ)||AQ)||AQ)||AQ)||AQ)||AQ)||AQ);var FQ;s("pQlW");Object(As.b)()(FQ=Object(a.singleton)()(FQ=Reflect.metadata("design:type",Function)(FQ=Reflect.metadata("design:paramtypes",[])(FQ=class{constructor(){}onApplicationStart(e){$zapp.notifyAppStarted()}})||FQ)||FQ)||FQ);var kQ,NQ=s("vyAj");let PQ=Object(a.injectable)()(kQ=Object(m.h)()(kQ=Object(m.j)()(kQ=Object(a.singleton)()(kQ=Reflect.metadata("design:type",Function)(kQ=Reflect.metadata("design:paramtypes",[])(kQ=class{constructor(){}onStart(){NQ.b.on(NQ.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}onDispose(){NQ.b.off(NQ.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}handleReceiveConfig(e){return!!this.isValidConfig(e.payload)&&(this.handleUpdateConfig(e.payload),!0)}isValidConfig(e){return!!e&&("object"==typeof e&&(!!e.hasOwnProperty("data")&&(!!e.data.hasOwnProperty("actions")&&(!!Array.isArray(e.data.actions)&&(!!e.data.actions.length&&this.isValidActions(e.data.actions))))))}isValidActions(e){let t=!0;for(const s of e)s.act!==UQ.ACT&&(t=!1),s.act_type!==UQ.ACT_TYPE&&(t=!1),this.isValidJsonObjConf(s.data)||(t=!1);return t}isValidJsonObjConf(e){if(!e)return!1;try{let t=JSON.parse(e);return"object"==typeof t&&!Array.isArray(t)}catch($Q){return!1}}getObjConfFromAction(e){try{return JSON.parse(e.data)}catch($Q){return null}}handleUpdateConfig(e){e.data.actions.forEach((e=>{const t=this.getObjConfFromAction(e);t&&jO.a.updateConfigBySocket(t)}))}parsePathToObject(e,t){let s=e.split("?.").join("."),a=[],i="",n=!1,r=!1;for(let c=0;c<s.length;c++){let e=s[c];"["===e?(i&&a.push(i),i="",n=!0,r=!1):"]"===e?(n=!1,r?a.push(i):a.push(parseInt(i,10)),i=""):"'"===e||'"'===e?r=!0:"."!==e||n?i+=e:(i&&a.push(i),i="")}i&&a.push(i);let o="number"==typeof a[0]?[]:{},l=o;for(let c=0;c<a.length;c++){let e=a[c],s=a[c+1];c===a.length-1?l[e]=t:"number"==typeof s?(l[e]=l[e]||[],l=l[e]):(l[e]=l[e]||{},l=l[e])}return o}})||kQ)||kQ)||kQ)||kQ)||kQ)||kQ;const jQ=Object(a.define)("server-info-socket-token");a.ModuleContainer.registerSingleton(jQ,PQ);const UQ={ACT:"server_info",ACT_TYPE:"update_config"};class BQ extends hs.b{start(){}}var zQ,GQ=BQ;Object(m.j)()(zQ=Object(a.singleton)(pc)(zQ=class extends GQ{conversationWillClose(e,t){super.dispatchEvent(new _c(e,t))}conversationDidClose(e,t){super.dispatchEvent(new bc(e,t))}conversationWillOpen(e,t){super.dispatchEvent(new Sc(e,t))}conversationDidOpen(e,t){super.dispatchEvent(new Cc(e,t))}conversationWillDelete(e,t){super.dispatchEvent(new Ic(e,t))}conversationDidDelete(e,t){super.dispatchEvent(new yc(e,t))}onStart(){this.start()}start(){const e=Object.keys(Lc);e.length>0&&e.forEach((e=>{const t=Lc[e];this.addEventListener(e,(e=>{t.targets.forEach((s=>{try{var i,n;null===(i=(n=a.ModuleContainer.resolveToken(s))[t.callback])||void 0===i||i.call(n,e)}catch(r){}}))}))})),super.start()}})||zQ);var xQ=s("GFHO");s("zlHd");function VQ(){const e=Va.a.resolveAll(Wa.a);for(const t of e)t.init()}(function(e){const t=new xQ.a(e);if(t.remoteConfigs.key("enable").boolean)VQ();else{const e=()=>{t.remoteConfigs.key("enable").boolean&&(VQ(),t.remoteConfigs.remove(e))};t.remoteConfigs.add(e)}})({platform:"pc"});var HQ,WQ=s("VHyX"),qQ=s("05Vw");const KQ=Object(a.define)("cloud-init");Object(m.d)()(HQ=Object(m.f)()(HQ=Object(m.h)()(HQ=Object(a.singleton)(KQ)(HQ=class{onApplicationReady(e){Object(WQ.d)("onApplicationReady"),qQ.a.getInstance().clean()}onAuthenticated(e){Object(WQ.d)("onAuthenticated")}onDispose(){Object(WQ.d)("onDispose"),qQ.a.getInstance().clean()}})||HQ)||HQ)||HQ)},"5Ew1":function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var a=s("VTBJ"),i=s("jDHv"),n=s("iZzu"),r=s("WQAo"),o=s("igA5"),l=s("Mgpg"),c=s("h0S/");const d="draft_prev_s";class u{constructor(){this.logger=void 0,this.isInit=void 0,this.data=void 0}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(l.ZLoggerFactory).createZLogger(c.ZLoggerNametags.updater,["previous-state-keeper"])),this.logger}updateData(e,t){const s={currentTab:e};t&&(s.convId=t),this.data=s,o.default.getInstance().setItemForCurrentUser(d,JSON.stringify(s))}init(){this.isInit=!0;const e=o.default.getInstance().getItemForCurrentUser(d);if(e){try{this.data=JSON.parse(e)}catch{this.data=null}o.default.getInstance().removeItemForCurrentUser(d)}}backup(){const e=i.ModuleContainer.resolve(n.SidebarController),t=e.getCurrMainConvId(),s=e.getState().currentTab;this.updateData(s,t),this.Logger.zsymb(0,"-mrL2A","done backup",s,t)}async restore(){if(this.isInit||this.init(),this.data){const{currentTab:e,convId:t}=this.data,s=i.ModuleContainer.resolve(n.SidebarController);s.getState().currentTab!==e&&s.changeTab(e),e===n.SidebarTab.MESSAGE_TAB&&t&&await i.ModuleContainer.resolve(r.b).openConversation(t,Object(a.a)(Object(a.a)({},r.c),{},{silently:!0,byPassPIN:!0})),this.Logger.zsymb(0,"cwyzeO","done restore",e,t)}else this.Logger.zsymb(18,"vq0pUa","call restore but no data")}}},AHxZ:function(e,t,s){0},"E/H5":function(e,t,s){"use strict";var a=s("w+Cq");s.o(a,"DraftInputKeeper")&&s.d(t,"DraftInputKeeper",(function(){return a.DraftInputKeeper})),s.o(a,"PreviousStateKeeper")&&s.d(t,"PreviousStateKeeper",(function(){return a.PreviousStateKeeper}));var i=s("5Ew1");s.d(t,"PreviousStateKeeper",(function(){return i.a}));var n=s("H+4v");s.d(t,"DraftInputKeeper",(function(){return n.a}))},FCbV:function(e,t){},"H+4v":function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var a=s("VTBJ"),i=s("QVpS"),n=s("igA5"),r=s("jDHv"),o=s("yzMR"),l=s("U+ds"),c=s("bUXd"),d=s("Ydol"),u=s("97kL"),h=s("3xbP"),g=s("Mgpg"),m=s("h0S/");const p="draft_input";class f{constructor(){this.data=void 0,this.isInit=void 0,this.logger=void 0}get Logger(){return this.logger||(this.logger=r.ModuleContainer.resolve(g.ZLoggerFactory).createZLogger(m.ZLoggerNametags.updater,["draft-input-keeper"])),this.logger}shouldSaveDraftItem(e){var t,s,a;return!!e&&((!e.files||!e.files.length)&&!!(e.quote||null!==(t=e.mentions)&&void 0!==t&&t.length||null!==(s=e.contact)&&void 0!==s&&s.previewProfile||null!==(a=e.states)&&void 0!==a&&a.text))}isValidDraftItem(e){return!(!e||"object"!=typeof e||!e.hasOwnProperty("draftTime"))}updateData(e,t,s){this.data||(this.data={draftTimeMap:{},savedLastState:{}}),this.data.draftTimeMap[e]=s,this.data.savedLastState[e]=t}init(){this.isInit=!0;const e=n.default.getInstance().getItemForCurrentUser(p);if(e){try{const t=JSON.parse(e);t&&"object"==typeof t&&Object.keys(t).forEach((e=>{if(this.isValidDraftItem(t[e])){const s=t[e].draftTime;delete t[e].draftTime,this.updateData(e,t[e],s)}}))}catch(t){this.Logger.zsymb(18,"J5KMDh","parse cache error",t)}n.default.getInstance().removeItemForCurrentUser(p)}}backup(){d.default.emit(u.ChatInputAction.SAVE_DRAFT);const{savedLastState:e,draftTimeMap:t}=i.b,s={};let r=!1;Object.keys(e).forEach((i=>{this.shouldSaveDraftItem(e[i])&&(s[i]=Object(a.a)(Object(a.a)({},e[i]),{},{draftTime:t[i]||c.default.getTimeNow()}),r||(r=!0))})),r&&(n.default.getInstance().setItemForCurrentUser(p,JSON.stringify(s)),this.Logger.zsymb(0,"CSTwTl","done backup",t))}async restore(){if(this.isInit||this.init(),this.data){const e=this.data.draftTimeMap,t=this.data.savedLastState;Object.keys(t).forEach((s=>{var n,c;i.b.savedLastState[s]=t[s],i.b.draftTimeMap[s]=e[s],null!==(n=t[s].states)&&void 0!==n&&null!==(c=n.styles)&&void 0!==c&&c.length&&r.ModuleContainer.resolve(l.j).setChatInputType(h.c,s,{name:l.k.RTF,info:{mode:l.o.MINI,inputType:l.k.RTF}},!0),r.ModuleContainer.resolve(o.PreviewDataManager).onChangeDraft(s,Object(a.a)(Object(a.a)({},Object(i.a)(t[s],{},s)),{},{draftTime:e[s]}))})),this.data=null,this.Logger.zsymb(0,"ymo671","done restore")}}}},"ILT/":function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var a,i,n=s("VTBJ"),r=s("igA5"),o=s("ezRR"),l=s("E/Lo"),c=s("QDKs"),d=s("UHN6"),u=s("dKg8"),h=s("jx7S");let g=Object(o.c)()(a=Reflect.metadata("design:type",Function)(a=Reflect.metadata("design:paramtypes",[])((i=class e extends o.b{constructor(){super(),this.name="",this.state=void 0,this.microTaskQueue=[],this.taskQueue=[],this.runTaskQueue=[],this.currentTask=void 0,this.backupData={},this.tookBackupKeys={},this.timer=void 0,this.timerCount=0,this.tempTaskId=void 0,this.storage=void 0,this.state="running"===this.appStatus?"running":"created"}create(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_CREATED`),s.state="created"}}running(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_RUNNING`),s.state="running",s.prepare()}}stop(){for(const t in e.instances){const s=e.instances[t];Object(l.d)()&&c.a.info(d.c,`ID: ${s.id} - TASK_MANAGER_STOP`),s.state="stop",s.clearTimer()}}setup(t){if(!t)throw new Error("TaskManager name is required.");return this.name=t,e.instances[this.getNameAsKey()]?e.instances[this.getNameAsKey()]:(e.instances[this.getNameAsKey()]=this,this.storage=r.default.getInstance(),"running"===this.state&&this.prepare(),this)}createTask(e,t){if(!this.name)throw new Error("TaskManager is not setup.");return new u.a(e,this,t)}addTask(e){var t;Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - ADD_TASK`,Object(h.a)(e),e.backupData||""),"high"===(null===(t=e.options)||void 0===t?void 0:t.priority)?this.microTaskQueue.push(e):this.taskQueue.push(e),this.restoreBackup(e)}runTask(e){"running"!==this.state||this.currentTask?e&&this.addBackup(e):(this.currentTask=this.findNextTask(),this.currentTask?(Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - RUN_TASK`,Object(h.a)(this.currentTask),this.currentTask.backupData,`runTaskQueue: ${this.runTaskQueue.length} - microTaskQueue: ${this.microTaskQueue.length} - taskQueue: ${this.taskQueue.length}`),this.addBackup(this.currentTask),this.currentTask.run(),this.tempTaskId=this.currentTask.id):Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - NO_TASK_TO_RUN`))}doneTask(e,t=!1,s){var a,i,n;if(Object(l.d)()){const a=s?` - Reason: ${s}`:"";c.a.info(d.c,`ID: ${this.id} - DONE_TASK`,`isForce: ${t} - Task ${Object(h.a)(e)}${a}`,this.currentTask?`Current task ${Object(h.a)(this.currentTask)}`:"")}(null===(a=this.currentTask)||void 0===a?void 0:a.id)===e.id?(null!==(i=e.options)&&void 0!==i&&null!==(n=i.backup)&&void 0!==n&&n.key&&this.removeBackup(e),this.currentTask=void 0,this.tempTaskId=void 0):t&&this.findAndRemoveTask(e);this.runTask()}async prepare(){try{var e;const t=await(null===(e=this.storage)||void 0===e?void 0:e.getItemForCurrentUserAsync(this.getBackupKey()));t&&(this.backupData=JSON.parse(t))}catch(t){}finally{this.runBackup(),this.runTask(),this.runTimer()}}restoreBackup(e){var t,s;if("running"!==this.state)return;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;!a||Object(l.e)(this.backupData[a])||this.tookBackupKeys[a]?e.restore():(Object(l.d)()&&c.a.info(d.c,`ID: ${this.id} - GET_BACKUP_DATA_FROM_DB`,Object(h.a)(e)),e.restore(this.backupData[a]),this.resetBackup(e),this.tookBackupKeys[a]=!0)}addBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;var i;a&&e.backupData&&(this.backupData[a]=Object(n.a)(Object(n.a)({},this.backupData[a]||{}),{},{[e.id]:e.backupData}),null===(i=this.storage)||void 0===i||i.setItemForCurrentUserAsync(this.getBackupKey(),JSON.stringify(this.backupData)))}removeBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;var i,n;a&&(null===(i=this.backupData[a])||void 0===i||delete i[e.id],null===(n=this.storage)||void 0===n||n.setItemForCurrentUserAsync(this.getBackupKey(),JSON.stringify(this.backupData)))}runBackup(){for(const e in this.backupData){const t=this.runTaskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}))||this.microTaskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}))||this.taskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}));t&&this.restoreBackup(t)}}resetBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;var i;a&&(delete this.backupData[a],null===(i=this.storage)||void 0===i||i.setItemForCurrentUserAsync(this.getBackupKey(),JSON.stringify(this.backupData)))}getBackupKey(){return`${d.a}_${this.getNameAsKey()}`}getNameAsKey(){return this.name.replace(/ /gi,"_")}findNextTask(){let e=[];if(e=Object(h.b)(this.microTaskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),e=Object(h.b)(this.taskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),this.runTaskQueue.length>0)return this.runTaskQueue.shift()}findAndRemoveTask(e){this.microTaskQueue=this.microTaskQueue.filter((t=>t.id!==e.id)),this.taskQueue=this.taskQueue.filter((t=>t.id!==e.id)),this.runTaskQueue=this.runTaskQueue.filter((t=>t.id!==e.id))}runTimer(){this.timer||(this.timer=setInterval((()=>{var e;(this.timerCount++,d.b/d.e===this.timerCount)&&(null!==(e=this.currentTask)&&void 0!==e&&e.id&&this.currentTask.id===this.tempTaskId&&c.a.warn(d.c,`ID: ${this.id} - TASK_TIMER Task (${Object(h.a)(this.currentTask)}) is running too long.`))}),d.e))}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=void 0,this.timerCount=0)}},i.instances={},a=i))||a)||a)||a},KGrx:function(e,t,s){"use strict";var a=s("ILT/");s.d(t,"TaskManager",(function(){return a.a}));s("dKg8"),s("qU4b")},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(...e){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]),Array.prototype.push.apply(this,e)})},Pswx:function(e,t,s){"use strict";s("1JlB");var a=s("DvQV");s.d(t,"a",(function(){return a.a})),s.d(t,"b",(function(){return a.b})),s.d(t,"c",(function(){return a.c})),s.d(t,"d",(function(){return a.d})),s.d(t,"e",(function(){return a.e})),s.d(t,"f",(function(){return a.f})),s.d(t,"g",(function(){return a.g})),s.d(t,"h",(function(){return a.h})),s.d(t,"i",(function(){return a.i})),s.d(t,"j",(function(){return a.j})),s.d(t,"k",(function(){return a.k})),s.d(t,"l",(function(){return a.l})),s.d(t,"m",(function(){return a.m})),s.d(t,"n",(function(){return a.n})),s.d(t,"o",(function(){return a.o})),s.d(t,"p",(function(){return a.p})),s.d(t,"q",(function(){return a.q})),s.d(t,"r",(function(){return a.r})),s.d(t,"s",(function(){return a.s})),s.d(t,"t",(function(){return a.t})),s.d(t,"u",(function(){return a.u})),s.d(t,"v",(function(){return a.v})),s.d(t,"w",(function(){return a.w})),s.d(t,"x",(function(){return a.x})),s.d(t,"y",(function(){return a.y})),s.d(t,"z",(function(){return a.z})),s.d(t,"A",(function(){return a.A})),s.d(t,"B",(function(){return a.B})),s.d(t,"C",(function(){return a.C})),s.d(t,"D",(function(){return a.D})),s.d(t,"E",(function(){return a.E})),s.d(t,"F",(function(){return a.F})),s.d(t,"G",(function(){return a.G})),s.d(t,"H",(function(){return a.H})),s.d(t,"I",(function(){return a.I})),s.d(t,"J",(function(){return a.J})),s.d(t,"K",(function(){return a.K})),s.d(t,"L",(function(){return a.L})),s.d(t,"M",(function(){return a.M})),s.d(t,"N",(function(){return a.N})),s.d(t,"O",(function(){return a.O})),s.d(t,"P",(function(){return a.P})),s.d(t,"Q",(function(){return a.Q})),s.d(t,"R",(function(){return a.R})),s.d(t,"S",(function(){return a.S})),s.d(t,"T",(function(){return a.T})),s.d(t,"U",(function(){return a.U})),s.d(t,"V",(function(){return a.V})),s.d(t,"W",(function(){return a.W})),s.d(t,"X",(function(){return a.X})),s.d(t,"Y",(function(){return a.Y}))},QDKs:function(e,t,s){"use strict";var a=s("VTBJ");const i="@LOGGER",n=Object(a.a)(Object(a.a)({},console),{},{info:(e,...t)=>{const s=`%c${i}::INFO`;zconsole.info(s,"font-weight: bold; color: #35611b; background-color: #dcffc6; padding: 2px 5px; border-radius: 5px;",e,...t)},warn:(e,...t)=>{const s=`%c${i}::WARN`;zconsole.warn(s,"font-weight: bold; color: #de6800; background-color: #ffdbbc; padding: 2px 5px; border-radius: 5px;",e,...t)},error:(e,...t)=>{const s=`%c${i}::ERROR`;zconsole.error(s,"font-weight: bold; color: #e11c1c; background-color: #ffc9c9; margin-left: 5px; padding: 2px 5px; border-radius: 5px;",e,...t)},zlog:zconsole});t.a=n},SF1S:function(e,t){},T9Ct:function(e,t,s){"use strict";var a=s("nVrC");s.d(t,"DraftKeepingManager",(function(){return a.a}));var i=s("E/H5");s.o(i,"DraftInputKeeper")&&s.d(t,"DraftInputKeeper",(function(){return i.DraftInputKeeper})),s.o(i,"PreviousStateKeeper")&&s.d(t,"PreviousStateKeeper",(function(){return i.PreviousStateKeeper}))},UHN6:function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return i})),s.d(t,"e",(function(){return n})),s.d(t,"b",(function(){return r})),s.d(t,"d",(function(){return o}));const a="[@TASK_MANAGEMENT]",i="t_m_t_q__",n=1e4,r=2e4,o=2e4},WOja:function(e,t){},dKg8:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var a=s("E/Lo"),i=s("QDKs"),n=s("UHN6"),r=s("jx7S");class o{constructor(e,t,s){this._options=void 0,this._name=void 0,this._id=void 0,this._taskManager=void 0,this._state=void 0,this._retry=0,this._waitForRetry=1e3,this._retryCheatingCount=0,this._backupData=void 0,this._timeout=n.d,this._timer=void 0,this._restore=void 0,this._executor=void 0,this._error=void 0,this._options=s,this._name=e,this._id=Object(a.g)(),this._taskManager=t,this._state="created",this._retry=(null==s?void 0:s.retry)||this._retry,this._waitForRetry=(null==s?void 0:s.waitForRetry)||this._waitForRetry,this._timeout=(null==s?void 0:s.timeout)||this._timeout,this._taskManager.addTask(this),this._createTimer(!0)}get options(){return this._options}get name(){return this._name}get id(){return this._id}get state(){return this._state}get backupData(){return this._backupData}onRestore(e){this._restore=e}onError(e){this._error=e}execute(e,t){"ended"===this.state&&(this._state="created",this._taskManager.addTask(this)),this._clearTimer(),this._state="ready",this._backupData=t,this._executor=()=>{setTimeout(e,10)},this._taskManager.runTask(this)}close(e=!1,t){this._clearTimer(),this._state="ended",this._taskManager.doneTask(this,e,t)}destroy(){}restore(e){var t;null===(t=this._restore)||void 0===t||t.call(this,e)}async run(){try{if("created"===this.state||"running"===this.state)return;if(!this._executor)throw new Error("Task executor is not defined.");this._createTimer(),this._state="running";window.$taskCheatingFailCount;0,await this._executor()}catch(t){var e;if(this._retry>0)return Object(a.d)()&&i.a.info(n.c,"TASK_RETRY",this._retry,Object(r.a)(this),t),this._retry--,void Object(a.i)(this._waitForRetry).then((()=>{this._state="ready",this.run()}));Object(a.d)()&&i.a.error(n.c,"TASK_ERROR",Object(r.a)(this),t),null===(e=this._error)||void 0===e||e.call(this,t),this.close()}}_createTimer(e=!1){this._clearTimer(),this._timer=setTimeout((()=>{this.close(!0),this._timer=void 0,Object(a.d)()&&i.a.warn(n.c,`Task (Name: ${this.name} - ID: ${this.id}) is timeout.${e?" Task is not defined executor.":""}`)}),this._timeout)}_clearTimer(){this._timer&&clearTimeout(this._timer),this._timer=void 0}}},i2tm:function(e,t,s){"use strict";s.r(t);var a=s("3rNm");s.d(t,"cast",(function(){return a.a}));var i=s("kaMP");s.d(t,"gather",(function(){return i.a}));var n=s("3hph");s.d(t,"stridedSlice",(function(){return n.a}));var r=s("kRdc");s.d(t,"add",(function(){return r.a}));var o=s("zvA9");s.d(t,"greater",(function(){return o.a}));var l=s("SHv8");s.d(t,"matMul",(function(){return l.a}));var c=s("AV8V");s.d(t,"scalar",(function(){return c.a}));var d=s("parS");s.d(t,"mul",(function(){return d.a}));var u=s("/7N0");s.d(t,"sigmoid",(function(){return u.a}));var h=s("QYQ3");s.d(t,"squaredDifference",(function(){return h.a}));var g=s("oAkI");s.d(t,"sub",(function(){return g.a}));var m=s("Ei6o");s.d(t,"mean",(function(){return m.a}));var p=s("2ugP");s.d(t,"expandDims",(function(){return p.a}));var f=s("k7Jv");s.d(t,"square",(function(){return f.a}));var v=s("4FMF");s.d(t,"sum",(function(){return v.a}));var _=s("Z5Ez");s.d(t,"where",(function(){return _.a}));var b=s("Fjpt");s.d(t,"sqrt",(function(){return b.a}));var I=s("CfTU");s.d(t,"maximum",(function(){return I.a}));var y=s("x3y4");s.d(t,"div",(function(){return y.a}))},jx7S:function(e,t,s){"use strict";function a(e){const t=[];for(let s=0;s<e.length;s++){const a=e[s];"ready"===a.state&&(t.push(a),e.splice(s,1),s--)}return t}function i(e){return`Name: ${e.name} - ID: ${e.id}`}s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return i}))},nVrC:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var a=s("jDHv");const i=Object(a.define)("draft-keeping-manager")},oSk7:function(e,t,s){"use strict";class a{constructor(e){this.stream=void 0,this.stream=e}pipe(e){return this.stream=a.transformStream(this.stream,e),this}getStream(){return this.stream}static transformStream(e,t,s){try{return e.pipeThrough(new TransformStream(t))}catch(a){const s=e.getReader();return new ReadableStream({start(e){var s;const a={desiredSize:null,enqueue(t){e.enqueue(t)},error(e){},terminate(){}};return null===(s=t.start)||void 0===s?void 0:s.call(t,a)},async pull(e){let a=!1;const i={desiredSize:null,enqueue(t){a=!0,t&&e.enqueue(t)},error(e){},terminate(){}};for(;!a;){var n;const a=await s.read();var r;if(a.done)return await(null===(r=t.flush)||void 0===r?void 0:r.call(t,i)),e.close();await(null===(n=t.transform)||void 0===n?void 0:n.call(t,a.value,i))}}})}}static createReadbleStreamFromArrayBuffer(e,t=2**20){const s=Math.ceil(e.byteLength/t);return new ReadableStream({start(a){for(let i=0;i<=s;i++)a.enqueue(new Uint8Array(e,i*t,t));a.close()}})}}t.a=a},qU4b:function(e,t){},taJj:function(e,t,s){"use strict";t.a=class{constructor(e){this.chunkSize=void 0,this.partialChunk=void 0,this.offset=void 0,this.chunkSize=e,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let s=0;if(this.offset>0){const a=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,a),this.offset),this.offset+=a,s+=a,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;s<e.byteLength;){const a=e.byteLength-s;if(a>=this.chunkSize){const a=e.slice(s,s+this.chunkSize);s+=this.chunkSize,this.send(a,t)}else{const t=e.slice(s,s+a);s+=t.byteLength,this.partialChunk.set(t),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}}},uAZB:function(e,t){globalThis.voiceMessageE2EERaw={actionId:"4724577257152",msgId:"4724598698821",zglobalMsgId:"4724598698821",cliMsgId:"1695617353668",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f2-voice-aac-dl.zdn.vn/278747013645988928/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR/YTOg4sY1G/1zvynosJP+gvj",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/278747013645988928\\/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR\\/YTOg4sY1G\\/1zvynosJP+gvj","duration":3000}',type:""},sendDttm:"1695617381952",serverTime:1695617382529,fromUid:"0",toUid:"g8293820567948517115",dName:"L V Gia Khang",localDttm:1695617152380,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:6,at:0,cmd:-1,originMsgType:"chat.voice",e2eeStatus:3e3,platformType:0,src:5,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,mediaAction:null,isSelected:!1},globalThis.voiceMessageRaw={actionId:"6424901573796",msgId:"4728547151178",zglobalMsgId:"4728547151178",cliMsgId:"1695718894432",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f1-voice-talk.zdn.vn/1199765638478242634/edd3d72884836edd3792.amr",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/1199765638478242634\\/edd3d72884836edd3792.aac","duration":3000}',type:""},sendDttm:"1695718897605",serverTime:"1695718897605",fromUid:"0",toUid:"g4243069577519568569",dName:"L V Gia Khang",localDttm:1695718898102,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:3,at:0,cmd:521,originMsgType:"chat.voice",subState:-1,e2eeStatus:-1,platformType:0,src:10,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,isSelected:!1},globalThis.runSound=e=>{const t=new Audio;return t.src=e,t.play(),t}},uGvo:function(e,t){},"w+Cq":function(e,t){}}]);
//# sourceMappingURL=../sourcemaps/lazy/main-startup.97862e6971f29f920ce9.js.map