__SCRIPT_TYPE__="renderer",function(e){function t(t){for(var r,a,o=t[0],c=t[1],h=t[2],d=0,u=[];d<o.length;d++)a=o[d],Object.prototype.hasOwnProperty.call(i,a)&&i[a]&&u.push(i[a][0]),i[a]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);for(l&&l(t);u.length;)u.shift()();return n.push.apply(n,h||[]),s()}function s(){for(var e,t=0;t<n.length;t++){for(var s=n[t],r=!0,o=1;o<s.length;o++){var c=s[o];0!==i[c]&&(r=!1)}r&&(n.splice(t--,1),e=a(a.s=s[0]))}return e}var r={},i={34:0},n=[];function a(t){if(r[t])return r[t].exports;var s=r[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.e=function(e){var t=[],s=i[e];if(0!==s)if(s)t.push(s[2]);else{var r=new Promise((function(t,r){s=i[e]=[t,r]}));t.push(s[2]=r);var n,o=document.createElement("script");o.charset="utf-8",o.timeout=120,a.nc&&o.setAttribute("nonce",a.nc),o.src=function(e){return a.p+"lazy/"+({20:"countries",23:"lang-en",24:"lang-vi"}[e]||e)+"."+{11:"66b7d44e09b89ceb914f",16:"b059e8e67d4f70b417ca",17:"9d701b4c854bb4f5b8aa",18:"e0afbb4078b25b8ac47e",20:"026a147a1a2122acc02b",23:"be796c0285a10281f335",24:"118d28f9973608001cd8",39:"9fc5fa42bd15478415c0",40:"3687be8eed15745f6ddf",41:"ead9e951e11238b0cafa",43:"2b0be3112d3d3c834a87",44:"16ed62bf0521ea58bb22",45:"ffffe2ea9f74ab2cd230",46:"db53dd3af166fd92513a",47:"a435da559f6f437a7f86",48:"7d1345ca4d35097b5c1e",49:"21b0cc0461881f30b2db",50:"e02a14b402a3132d4fe3",51:"6728405c9946d04c7ea5",52:"6538548bd0261a73711c",53:"05a4fd96fffab3d3700e",54:"fe81f8925cfe0dd8bb47",55:"d992a30845ef6ce35a38"}[e]+".js"}(e);var c=new Error;n=function(t){o.onerror=o.onload=null,clearTimeout(h);var s=i[e];if(0!==s){if(s){var r=t&&("load"===t.type?"missing":t.type),n=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+r+": "+n+")",c.name="ChunkLoadError",c.type=r,c.request=n,s[1](c)}i[e]=void 0}};var h=setTimeout((function(){n({type:"timeout",target:o})}),12e4);o.onerror=o.onload=n,document.head.appendChild(o)}return Promise.all(t)},a.m=e,a.c=r,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(s,r,function(t){return e[t]}.bind(null,r));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a.oe=function(e){throw e};var o=this.webpackJsonp=this.webpackJsonp||[],c=o.push.bind(o);o.push=t,o=o.slice();for(var h=0;h<o.length;h++)t(o[h]);var l=c;n.push([12,0,4,5,10,9,15,1,2,3,8,7,6,14]),s()}({12:function(e,t,s){e.exports=s("CdmT")},"39pz":function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("jDHv");const i=Object(r.define)("resource-scanner-executor")},"8s2m":function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return n}));var r=s("jDHv");let i;!function(e){e.DefaultInsertOptions={partition:void 0};let t=function(e){return e.Message="message",e.Res="res",e.Ref="ref",e}({});e.TableName=t;let s=function(e){return e.Core="Core",e.Res="Res",e.Ref="Ref",e}({});e.DBName=s;let r=function(e){return e.Message="Core/message",e.Res="Res/res",e.Ref="Res/ref",e}({});e.TablePath=r}(i||(i={}));const n=Object(r.define)("transfer-msg-database")},CdmT:function(e,t,s){"use strict";s.r(t);s("iGh7"),s("TlRV"),s("dUtG"),s("v5OU"),s("jmmm"),s("GSxB"),s("xDXR"),s("EmOc"),s("ezdo"),s("KdAX"),s("mzek"),s("aBYf"),s("zm+Q"),s("WSI5"),s("v/rv"),s("nAZb"),s("c0KM"),s("zheM"),s("CXIs"),s("cZjg");var r=s("YrRS");Object(r.b)();s("33YB"),s("LyOm"),s("lNuO");var i=s("T0aS"),n=s("jDHv");class a extends i.b{constructor(){super(),$zsub.$zsessionManager.onReceiveSession(((e,t)=>{this.setSession(t)}))}}n.ModuleContainer.registerSingleton(i.a,a);s("0rWR"),s("Lq8m"),s("nUpV"),s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN"),s("BP4/"),s("cF85"),s("7g9m"),s("oqw1");var o,c=s("8/YW"),h=s("PmZf"),l=s("tHMN"),d=s("jIg3"),u=s("8eps"),g=s("fsN4"),m=s("Mgpg"),p=s("PObO");let f=Object(c.h)()(o=n.ModuleContainer.injectable()(o=function(e,t){return n.ModuleContainer.inject(l.b)(e,void 0,0)}(o=function(e,t){return n.ModuleContainer.inject(m.ZLoggerFactory)(e,void 0,1)}(o=Reflect.metadata("design:type",Function)(o=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(o=class extends d.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.removeListeners=()=>{},this.logger=t.createZLogger("db",["client"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.engine.addEventListener(h.b.UnexpectedError,e)),t.push(this.engine.addEventListener(h.b.QueryExec,e)),t.push(this.engine.addEventListener(h.b.QueryError,e)),t.push(this.engine.addEventListener(h.b.SuccessOpenDB,e)),t.push(this.engine.addEventListener(h.b.LongOpenDB,e)),t.push(this.engine.addEventListener(h.b.TimeConsumingQuery,e)),t.push(this.engine.addEventListener(h.b.ConnectionClosedAbnormally,e)),t.push(this.engine.addEventListener(h.b.SchemaMigratedAbnormally,e)),t.push(this.engine.addEventListener(h.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}install(){$zsub.$zdb.onReceiveSession(((e,t)=>{this.authenticate(t)})),$zdb.notifyDbConnected(__ZaBUNDLENAME__),$zsub.$zdb.onRequestCloseDbs((async(e,t,s)=>{this.logger.zsymb(0,"DVW0Mv","closing databases"),await this.closeDBs(t,s),this.logger.zsymb(0,"amwIjs","closed databases"),$zdb.notifyFinishCloseDb(__ZaBUNDLENAME__)})),this.logger.zsymb(0,"-3kYF_","installed")}areYouOk(){return!0}authenticate(e){if(e){this.session=e,this.dispatchEvent(new h.g(e)),this.engine.authenticate(e),this.logger.zsymb(0,"cz3ZcG",(()=>["authenticated",`id: ${e.userId}`]));n.ModuleContainer.resolve(p.a).authenticate(e)}}async closeDBs(e,t){const s=g.default.getInstance(),r=this.logger;let i=[];if(e){if(e.length){let a=[...e];r.zsymb(3,"7mXmKm",["Start closing dbs: {}","uSvK1Y"],e),r.zsymb(3,"_OUNDb",["Wait for dbs to be closed: {}","gvDxHO"],a),i=e.map((async e=>{let i=s[e];if(void 0===i){const t=n.ModuleContainer.resolve(u.a).getValue().Meta;if(t.databaseName!==e)return void r.zsymb(21,"4IOITm",["Can't close invalid db: {}","zl5srS"],e);i=t}await i.closeThisDatabase(t),a=a.filter((t=>t!==e)),0===a.length?r.zsymb(0,"UJjeUI","Done closing dbs"):r.zsymb(3,"v_mEcj",["Wait for dbs to be closed: {}","gvDxHO"],a)}))}}else i=[s.closeAllDatabases(t)];await Promise.all(i)}checkShouldMigrate(){throw new Error("Medthod not implement")}migrateData(e,t){throw new Error("Medthod not implement")}})||o)||o)||o)||o)||o)||o;n.ModuleContainer.registerSingleton(d.b,f);s("6Pbj"),s("EicM"),s("m+NF"),s("pQlW");var b,I=s("UGJm"),S=s("Y58e"),M=s("hI9i"),y=s("q1tI"),v=s.n(y),w=s("/MKj"),E=s("ClHk");function _(){const{data:e}=Object(M.m)(E.a,"all");return 0===e.length?v.a.createElement("div",null,"No Tasks"):v.a.createElement("table",null,v.a.createElement("thead",null,v.a.createElement("tr",null,v.a.createElement("th",null,"ID"),v.a.createElement("th",null,"Type"),v.a.createElement("th",null,"Status"),v.a.createElement("th",null,"Process"),v.a.createElement("th",null))),v.a.createElement("tbody",null,e.map((e=>v.a.createElement(T,{key:e,id:e})))))}function T(e){const t=Object(M.l)(E.a,e.id);return t?v.a.createElement("tr",null,v.a.createElement("td",null,t.id),v.a.createElement("td",null,t.type),v.a.createElement("td",null,t.status),v.a.createElement("td",null,t.progress),v.a.createElement("td",null,new Date(t.startTime).toLocaleString())):null}function D(){return v.a.createElement(w.a,{store:M.b,context:M.a},v.a.createElement(_,null))}Object(n.injectable)()(b=Object(n.singleton)(c.a)(b=function(e,t){return Object(n.inject)(S.a)(e,void 0,0)}(b=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,1)}(b=Reflect.metadata("design:type",Function)(b=Reflect.metadata("design:paramtypes",[void 0===S.a?Object:S.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(b=class extends I.a{constructor(e,t){super("zalo",e,t,{component:D,container:document.getElementById("app")})}})||b)||b)||b)||b)||b);s("KszJ"),s("Hbak"),s("dhzt"),s("O6t0");var C=s("3jnX"),R=s("qUG6"),O=s("19h1"),k=s("R5gT"),N=s("4prX"),L=s("KP/S");class A extends C.b{constructor(e){super({type:"REQUEST_NOISE_ID",params:e})}}class F extends C.b{constructor(){super({type:"REQUEST_ALL_NOISE_ID",params:{}})}}var U=s("Hy6w"),z=s("h0S/");var G,j=new class{constructor(){this._writeMsgs=new U.a("writeMsgs"),this._writeFileRes=new U.a("writeFileRes"),this._writeMedia=new U.a("writeMedia"),this._convertVersion=new U.a("convertVersion"),this._readSQL=new U.a("readSQL"),this._denoiseId=new U.a("denoiseId"),this._normalMsg=new U.a("normalMsg"),this._countMsg=new U.a("countMsg"),this._indexSearch=new U.a("indexSearch"),this._mediaRes=new U.a("mediaRes"),this._filterExists=new U.a("filterExists"),this._total=new U.a("totalRestoreMsg"),this.logger=void 0,this.writeMsgs=void 0,this.convertVersion=void 0,this.readSQL=void 0,this.denoiseId=void 0,this.writeFileRes=void 0,this.writeMedia=void 0,this.normalMsg=void 0,this.countMsg=void 0,this.indexSearch=void 0,this.mediaRes=void 0,this.filterExists=void 0,this.total=void 0,this.trackHolder=void 0,this.tracker=void 0,this.writeMsgs=this._writeMsgs.getTracker(),this.convertVersion=this._convertVersion.getTracker(),this.readSQL=this._readSQL.getTracker(),this.denoiseId=this._denoiseId.getTracker(),this.writeFileRes=this._writeFileRes.getTracker(),this.writeMedia=this._writeMedia.getTracker(),this.normalMsg=this._normalMsg.getTracker(),this.countMsg=this._countMsg.getTracker(),this.indexSearch=this._indexSearch.getTracker(),this.total=this._total.getTracker(),this.mediaRes=this._mediaRes.getTracker(),this.filterExists=this._filterExists.getTracker(),this.trackHolder=[this._writeMsgs,this._convertVersion,this._readSQL,this._denoiseId,this._writeFileRes,this._writeMedia,this._mediaRes,this._normalMsg,this._countMsg,this._indexSearch,this._filterExists,this._total],this.tracker=[this.writeMsgs,this.convertVersion,this.readSQL,this.denoiseId,this.writeFileRes,this.writeMedia,this.mediaRes,this.normalMsg,this.countMsg,this.indexSearch,this.filterExists,this.total],this.lock();const e=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=e.createZLogger(z.ZLoggerNametags.msgSync,[z.ZLoggerNametags.syncMetrics])}lock(){this.trackHolder.forEach((e=>e.lock()))}unlock(){this.trackHolder.forEach((e=>e.unlock()))}reset(){this.tracker.forEach((e=>e.reset()))}print(){let e=0;this.trackHolder.forEach((t=>{"totalRestoreMsg"!==t.label&&(e+=t.time)})),this.logger.zsymb(0,"yL-YMS","ph7 total, track, untrack: ",this._total.time,e,this._total.time-e),this.trackHolder.forEach((e=>{this.logger.zsymb(0,"PQy1BI",`ph7 ${e.info}`)}))}getSnapShot(){const e={};return this.trackHolder.forEach((t=>{e[t.label]=t.time})),e}};let P=Object(n.singleton)()(G=Object(n.injectable)()(G=class{constructor(){this.userId="",this.cache=new Map}async init(e){this.userId!==e&&(this.userId=e,this.cache=new Map,await this.tryToFetchCachedNoiseId())}async tryToFetchCachedNoiseId(){try{const e=new F,t=await e.run();t.length>0&&(this.cache=new Map(t))}catch(e){}}get(e){if(e)return this.cache.get(e.toString())}async import(e){return j.denoiseId.start(),this._getNoiseId(e.uids||[],e.gids||[]).then((e=>(j.denoiseId.end(),e)))}async _getNoiseId(e,t){const s=e.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e)),r=t.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e));if(s.length!==e.length||r.length!==t.length){const i=e.length-s.length+t.length-r.length;N.default.increaseFailed(L.f.REQ_NOISE_ID,1,i,L.d.INVALID_NOISE_ID,Date.now())}await this._requestNoiseId(s,r)}_requestNoiseId(e,t){return new Promise(((s,r)=>{setTimeout((()=>{r("_requestNoiseId timeout")}),1e4);new A({uids:e,gids:t}).run().then((e=>{e.forEach((([e,t])=>{this.cache.set(e,t)})),s(!0)})).catch(r)}))}})||G)||G;var x=s("1pet"),Q=s("z0WU"),q=s("/Bne"),B=s("1qqm"),$=s("8s2m");let Z=new B.b(B.a);var V=s("fqRP"),W=s("s2Ee"),Y=s("PoHQ"),K=s("bUXd"),H=s("EYv5"),J=s("v6qY");const X={shouldUseNewMediaDBConfig:1};function ee(){return X.shouldUseNewMediaDBConfig}function te(e){X.shouldUseNewMediaDBConfig=e}var se,re=s("NDmK"),ie=s("igA5"),ne=s("/YHU");let ae=Object(n.injectable)()(se=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,0)}(se=function(e,t){return Object(n.inject)(V.a)(e,void 0,1)}(se=Reflect.metadata("design:type",Function)(se=Reflect.metadata("design:paramtypes",[void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory,void 0===V.a?Object:V.a])(se=class{constructor(e,t){this.readyToInsertMsgsQueue=[],this.idStore=void 0,this.coreDB=null,this.resDB=null,this.ttl=void 0,this.logger=void 0,this.checkSum=new Set,this.checkSum2=new Set,this.waitForNoiseId=[],this.noiseIdQueue=[],this.waitForGlobalId=[],this.lastInsertedMsgId=Date.now(),this.uid="",this.idStore=n.ModuleContainer.resolveToken(P),this.logger=e.createZLogger("sync-message",["msg-cross-importer"]),this.ttl=t}async open(e,t){await this.close(),this.uid=e,Y.p.setSessionUserId(e),n.ModuleContainer.resolve(d.b).authenticate({userId:e,UIN:t}),this.checkSum=new Set,this.checkSum2=new Set;const s=g.default.getInstance();this.coreDB=s.Core,this.resDB=s.Res,this.waitForGlobalId=[]}close(){this.coreDB&&(this.coreDB=null),this.resDB&&(this.resDB=null)}queueNewMessages(e){let t=this.verifyCrossMsg(e);this.readyToInsertMsgsQueue=this.readyToInsertMsgsQueue.concat(t.readyToInsert),this.waitForNoiseId=this.waitForNoiseId.concat(t.waitForNoiseId),this.noiseIdQueue=this.noiseIdQueue.concat(t.idsToGetNoise)}resetLastGlobalMsgId(){this.lastInsertedMsgId=Date.now()}async processImportQueue(e){if((e||this.shouldProcessMsgsInWaitForNoiseQueue())&&await this.processWaitForNoiseIdQueue(),(e&&0===this.readyToInsertMsgsQueue.length||this.waitForGlobalId.length>99)&&this.waitForGlobalId.length>0){const e=[];this.processWaitForGlobalIdQueue(e),e.length>0&&(this.queueNewMessages(e),await this.processWaitForNoiseIdQueue())}if(this.readyToInsertMsgsQueue.length){const e=this.readyToInsertMsgsQueue.splice(0,2e3);let s=Math.min(...e.map((e=>e.sequenseId)));s=Math.max(s,this.waitForGlobalId.length?this.waitForGlobalId[0].sequenseId:0,this.waitForNoiseId.length?this.waitForNoiseId[0].sequenseId:0);try{const t=[];this.crossMsgsToNormalMsgs(e,t);return{inserted:(await this.insertToDb(t)).success,minSeqId:s,queued:e,validMsgCount:t.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}catch(t){this.logger.zsymb(18,"TN7laU",(()=>["processImportQueue error",{error:t}]))}return{inserted:[],minSeqId:s,queued:e,validMsgCount:e.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}return{inserted:[],minSeqId:-1,queued:[],validMsgCount:0,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}printChecksum(){this.logger.zsymb(12,"93eHRW",(()=>["size",{waitNoise:this.waitForNoiseId,waitGlobal:this.waitForGlobalId,ready:this.readyToInsertMsgsQueue}])),this.checkSum.size>0?this.logger.zsymb(18,"70-n5i",(()=>["checkSum.size > 0",{miss:this.checkSum.values()}])):this.logger.zsymb(3,"Q-nvpw",["checkSum.size == 0","0oy9G3"])}processWaitForGlobalIdQueue(e){const t=this.waitForGlobalId;this.waitForGlobalId=[],this.lastInsertedMsgId=t[0].cliMsgId;for(let s=t.length-1;s>=0;s--){const r=t[s];r.globalMsgId=`${this.lastInsertedMsgId}_${s.toString().padStart(3,"0")}`,e.push(r)}}async insertMsgs(e){e=e.filter((e=>!!e.globalMsgId));let t=this.verifyCrossMsg(e).idsToGetNoise;t.length&&await this.idStore.import({uids:t});let s=[];return this.crossMsgsToNormalMsgs(e,s),this.insertToDb(s)}async processWaitForNoiseIdQueue(){if(0===this.noiseIdQueue.length)return;const e=this.noiseIdQueue,t=this.waitForNoiseId;this.waitForNoiseId=[],this.noiseIdQueue=[],await this.idStore.import({uids:e}),this.readyToInsertMsgsQueue.push(...t)}shouldProcessMsgsInWaitForNoiseQueue(){return this.noiseIdQueue.length>=1e3||this.waitForNoiseId.length>150}crossMsgsToNormalMsgs(e,t){j.normalMsg.start();for(let r=0;r<e.length;r++){const i=e[r];try{if("number"==typeof i.globalMsgId&&i.globalMsgId>0&&(this.lastInsertedMsgId=i.globalMsgId,this.waitForGlobalId.length>0)){const e=this.waitForGlobalId;this.waitForGlobalId=[];for(let s=e.length-1;s>=0;s--){const r=e[s];r.globalMsgId=`${i.globalMsgId}_${s.toString().padStart(3,"0")}`,this.crossMsgToNormalMsg(r,t)}}this.crossMsgToNormalMsg(i,t)}catch(s){}}j.normalMsg.end()}crossMsgToNormalMsg(e,t){if(!e.globalMsgId)return void this.waitForGlobalId.push(e);const s=e.parsedType||Q.default.normalizeMessageType(e.type);if(s===x.MSG_UNKNOWN)return void 0;let r=e.parsedIdTo||this.idStore.get(e.ownerId),i=e.parsedUidFrom||e.fromId==e.userId?"0":this.idStore.get(e.fromId);if(!i||!r)return void 0;let n=e.msg,a=e.attachData;switch(a.mentions&&Array.isArray(a.mentions)&&a.mentions.forEach((e=>{e.uid="-1"===e.uid?"-1":this.idStore.get(e.uid)})),a.quote&&(a.quote.ownerId=this.idStore.get(a.quote.ownerId)),s){case x.MSG_TEXT:a&&a.attach&&a.attach.action&&"rtf"==a.attach.action&&(a.attach.title||(a.attach.title=e.msg),n=a.attach);break;case x.MSG_PHOTO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_STICKER:n=a.attach||{};break;case x.MSG_GIF:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_VOICE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.params=l(n.params),n.thumb=l(n.thumb),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_VIDEO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.type=l(n.type);break;case x.MSG_LOCATION:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.href=l(n.href),n.thumb=l(n.thumb),n.type=l(n.type);break;case x.MSG_DOODLE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.title=l(n.title);break;case x.MSG_CONTACT:n=a.attach||{},n.description=l(n.description),n.thumb=l(n.thumb);const t=n.action;"recommened.user"!==t&&"recommened.vip"!==t||(n.params=this.idStore.get(n.params));break;case x.MSG_FILE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.type=l(n.type);break;case x.MSG_UNDO:n="";break;case x.MSG_OA:case x.MSG_ECARD:case x.MSG_POLL:n=a.attach;break;case x.MSG_ZINSTANT_OLD:case x.MSG_ZINSTANT:if(!a.attach||!a.attach.params||-1==a.attach.params.indexOf("pcItem"))return void this.logger.zsymb(0,"KC_pfY","Skip invalid zinstant",null==e?void 0:e.globalMsgId);n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action,""),n.description=l(n.description,""),n.title=l(n.title,""),n.href=l(n.href,""),n.thumb=l(n.thumb,""),n.params=l(n.params),delete n.childNumber}let o=null;if("chat.undo"==e.type&&e.attach)try{if(a.attach&&a.attach.params){let t=JSON.parse(a.attach.params).custom_message;if(t){t=JSON.parse(t);const s=t.highLightsV2;s.length&&(o=s[0]&&s[0].uid,o=this.idStore.get(o),o=o==this.uid?"0":o,e.type="chat.delete.everyone")}}}catch(d){this.logger.zsymb(18,"pKMbbT",(()=>["parseParams error:",{error:d}]))}const c={msgId:e.globalMsgId,cliMsgId:e.cliMsgId,msgType:e.type,status:"0"==i?x.MSG_DELIVERED:x.MSG_READ,notify:"1",mentions:a.mentions,quote:a.quote,content:n,ts:e.ts.toString(),uidFrom:i,dName:e.fromName,propertyExt:a.property,ttl:e.ttl};a.reference&&(c.reference=a.reference);const h=q.a.transformMessageFromServer(c,r);function l(e,t=""){return e instanceof Object&&Object.keys(e).length?t:e||t}h.localDttm=Date.now(),h.src=x.MSG_SRC.SYNC_MOBILE_DB,h.sequenceId=e.sequenseId,h.uidSenderDel=o,h.msgType!==x.MSG_UNKNOWN?t.push(h):this.logger.zsymb(0,"Zjbz-w",(()=>["skip message: unknown type",{id:h.cliMsgId,type:e.type}]))}verifyCrossMsg(e){const t=[],s=[],r=new Set;for(let o=0;o<e.length;o++){var i,n;const c=e[o];if(!c)continue;let h=!1;const l=e=>{e&&"-1"!==(e=e.toString())&&(this.idStore.get(e)||(h||(h=!0,t.push(c)),r.add(e)))};if(l(c.ownerId),l(c.fromId),!c.attachData){let e={};if(c.attach)try{e=JSON.parse(c.attach)}catch(a){}c.attachData=e}const d=c.attachData,u=null===(i=d.attach)||void 0===i?void 0:i.action;"recommened.user"!==u&&"recommened.vip"!==u||null===(n=d.attach)||void 0===n||!n.params||l(d.attach.params),d.mentions&&Array.isArray(d.mentions)&&d.mentions.forEach((e=>{l(e.uid)})),d.quote&&l(d.quote.ownerId),h||s.push(c)}return{waitForNoiseId:t,readyToInsert:s,idsToGetNoise:Array.from(r)}}async insertToDb(e){e=await this._filterDeletedMessages(e);const t=await this._insertMessage(e);return j.mediaRes.start(),await Promise.all([this._insertMedia(t.success),this._insertFilesToResDB(t.success)]),j.mediaRes.end(),await this._insertTTL(t.success),this._sendMediaMsgToMain(t.success),t}_insertMedia(e){j.writeMedia.start();const t=`${J.c.TRANSFER_MOBILE}${J.d.FROM_MSG}`;return n.ModuleContainer.resolve(H.a).addMediasWhenTransferMessage(e,t,ee()).then((e=>(j.writeMedia.end(),e)))}_insertFilesToResDB(e){j.writeFileRes.start();const t=e.reduce(((e,t)=>(t.msgType===x.MSG_FILE&&e.push({msgId:t.msgId,userId:t.toUid,message:t.message,sendDttm:t.sendDttm,fromUid:t.fromUid,type:"file",cliMsgId:t.cliMsgId}),e)),[]);return(async(e,t)=>{try{let s=[],r=[];for(let e of t){const{res:t,ref:i,error:n}=Z.toDb(e);n||(s.push(t),r.push(i))}s.length>0&&await e.Res.insertMulti(s),r.length>0&&await e.Ref.insertMulti(r)}catch{}})(this.resDB,t).then((e=>(j.writeFileRes.end(),e)))}async _insertTTL(e){const t=e.filter((e=>e.ttl&&e.ttl>0)),s=W.b.createFromUid(this.uid).deriveTTLItems(t);if(t.length<=0)return;const r=await this.ttl.putMsgs(s);r.ok?this.logger.zsymb(3,"68Qusa",["ttl insert success","lonOM7"]):(this.logger.zsymb(21,"Cy0SMQ",["ttl insert fail","_h3xwg"]),this.logger.zsymb(3,"iB1dP5",["ttl invalid {}, error {}","uA6R-h"],r.error.invalidItems.length,r.error.errorItems.length))}async _insertMessage(e){j.writeMsgs.start();const t=new Map;e.forEach((e=>{t.has(e.toUid)?t.get(e.toUid).push(e):t.set(e.toUid,[e])}));const s=[];return t.forEach(((e,t)=>{s.push(this.coreDB.Message.insertMulti(e,{replace:!1,partition:t}))})),Promise.all(s).then((e=>(j.writeMsgs.end(),e.reduce(((e,t)=>(e.success.push(...t.success),e.fail.push(...t.fail),e)),{success:[],fail:[]}))))}async _filterExistsMessages(e){if(!e||!e.length)return[];const t={};e.forEach((({msgId:e,toUid:s})=>{void 0===t[s]&&(t[s]=[]),t[s].push(e)}));const s=Object.entries(t).map((([e,t])=>this.coreDB.Message.getMultiIfExists(t,{partition:e}))),r=await Promise.all(s).then((e=>e.flat())),i=new Set(r.map((e=>e&&e.msgId)));return e.filter((e=>!i.has(e.msgId)))}_sendMediaMsgToMain(e){if(!Q.default.isWeb()){const t=ie.default.getInstance().getItem(x.KEY_CONFIG_TRANSFER_AUTODL),{validDays:s}=t&&Object(ne.a)(t),r=24*(s||re.default.auto_download_media_transfered.validDays)*60*60*1e3,i=e.filter((e=>this._isMediaMsg(e)&&!this._isAIStickerMessage(e)&&!this._isPhotoStickerMessage(e)&&this._isValidTime(e,r)));Array.isArray(i)&&i.length>0&&$zFeatures.transfer.notifyReceiveMediaMsgs(i)}}_isMediaMsg(e){var t;const s=e.msgType;if(s===x.MSG_CONTACT&&"recommened.link"===(null===(t=e.message)||void 0===t?void 0:t.action))return!0;return[x.MSG_PHOTO,x.MSG_PHOTO_2,x.MSG_DOODLE,x.MSG_FILE,x.MSG_VOICE,x.MSG_VIDEO].includes(s)}_isAIStickerMessage(e){return!1}_isPhotoStickerMessage(e){return!1}_isValidTime(e,t){const s=+e.sendDttm;return!(K.default.getTimeNow()-s>=t)}async _filterDeletedMessages(e){let t={},s=[];for(let n=0;n<e.length;n++){const r=e[n];r.msgType==x.MSG_UNDO?s.push(r):(t[r.toUid]||(t[r.toUid]=[]),t[r.toUid].push(r))}await this._sendUndo(s);let r=Object.keys(t);const i=[];for(let n=0;n<r.length;n++){const e=r[n];i.push(...t[e])}return i}async _sendUndo(e){}})||se)||se)||se)||se)||se;class oe{constructor(e){this.noiseIdStore=void 0,this.importer=void 0,this.session=null,this.logger=void 0,this._searchIndexQueue=null,this.noiseIdStore=n.ModuleContainer.resolveToken(P),this.importer=n.ModuleContainer.resolveToken(ae);const t=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=t.createZLogger("msg-sync",["importer",e])}async restoreConversations(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreConversations.bind(this,e);return this.usingDatabase(t,s,r)}async restoreMessages(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreMessages.bind(this,e);return this.usingDatabase(t,s,r)}async usingDatabase(e,t,s){let r,i;await this.noiseIdStore.init(e),await this.open(e,t);try{r=await s()}catch(n){i=n}if(await this.close(),i)throw i;return r}async open(e,t){await this.importer.close(),this.session={userId:e,UIN:t},await this.importer.open(e,t)}async close(){await this.importer.close()}indexSearch(e,t){if(t.queueIndexSearch)return this.searchIndexQueue.queueIdxs(e);return k.a.getInstance().executeMessageDbData(e)}get searchIndexQueue(){var e,t,s,r;this._searchIndexQueue||(null!==(e=this.session)&&void 0!==e&&e.userId&&null!==(t=this.session)&&void 0!==t&&t.UIN&&n.ModuleContainer.resolve(d.b).authenticate({userId:null===(s=this.session)||void 0===s?void 0:s.userId,UIN:null===(r=this.session)||void 0===r?void 0:r.UIN}),this._searchIndexQueue=new O.a);return this._searchIndexQueue}}class ce extends oe{constructor(){super("format-0"),this._backup=null,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=n.ModuleContainer.resolve(m.ZLoggerFactory).createZLogger("sync-msg",["import-format1"])),this._Logger}async doRestoreConversations(e){const{params:t,abort:s}=e,r=await this.getBackup(t.backupPath),i=await r.getAllConversations(),n=await r.getRespondedConversations(),a=new Set(n.map((e=>e.ownerId))),o=[],c=[];if(i.forEach((e=>{1===e.ownerType?o.push(e.ownerId):c.push(e.ownerId)})),await this.noiseIdStore.import({gids:o,uids:c}),s.aborted)throw new Error("aborted");const h=await r.getLastMsgForEachConversations();if(s.aborted)throw new Error("aborted");let l=await this.importer.insertMsgs(h);const d={},u=[],g=[];return i.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,r={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:a.has(e.ownerId),backupPath:""};u.push(r),d[t]=r}else g.push(e.ownerId)})),l.success.forEach((e=>{d[e.toUid]&&(d[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{d[e.toUid]&&(d[e.toUid].lastMessage=e)})),u}async doRestoreMessages(e){const{params:t,checkpoint:s,abort:r,report:i}=e;if(!s||0!==s.format)throw new Error("invalid checkpoint");const n=new Map(t.conversations.filter((e=>!e.hasPreviewMsg)).map((e=>[e.noiseId,void 0]))),a=t.conversations.filter((e=>e.shouldIgnore)).map((e=>e.plainId));let o=s.currentSeq,c=s.maxSeq,h=s.minSeq,l=s.syncedConversations,d=0,u=s.syncedMessages||0;const g=await this.getBackup(t.backupPath),m=await g.countMessageFrom(h,a);let p=await g.countMessageFrom(o,a),f=m,b=!1;for(;;){if(r.aborted)return{trackInfo:{}};let e=await g.getMessages(o,h,a,100);if(0===e.length)f=0;else{e[0].sequenseId>c&&(c=e[0].sequenseId);for(let t=e.length-1;t>=0;t--){const s=e[t].sequenseId;if(s<o){o=s;break}}this.importer.queueNewMessages(e),f-=e.length}let s=await this.importer.processImportQueue(b);if(0===s.queued.length){if(s.hasMore){b=!0;continue}}else b=!1;if(0===s.queued.length&&0===f){(0===h||h>o)&&(h=o);return i(100,{format:0,minSeq:h,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}),{trackInfo:{}}}let I=new Map;for(let t=0;t<s.inserted.length;t++){const e=s.inserted[t];if(n.has(e.toUid)){const t=n.get(e.toUid);(!t||t<e.sequenceId)&&(I.set(e.toUid,e),n.set(e.toUid,e.sequenceId))}}if(I.size>0){u+=I.size;const e=new R.a(Array.from(I.values()));await e.run()}p+=s.validMsgCount;const S=p/m,M=Math.round(95*S);M!==d&&(d=M,s.minSeqId>0&&(this.Logger.zsymb(3,"8h0mO9",["checkpoint: {} {}/{} ({}%)","r6LXjE"],s.minSeqId,p,m,M),i(M,{format:0,minSeq:h,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}))),await this.indexSearch(s.inserted,{queueIndexSearch:t.meta.queueIndexSearch}),await new Promise((e=>setTimeout(e,50)))}}async close(){return this._backup&&await this._backup.close(),super.close()}async getBackup(e){return this._backup||(this._backup=new he(e),await this._backup.open()),this._backup}}class he{constructor(e){this._db=void 0,this._db=$zsqlite.createConnection(e,{OPEN_CREATE:!0,OPEN_READWRITE:!0})}close(){return this._db.close()}async open(){await this._db.open(),await this._db.runQuery(de),await this._db.runQuery(ue)}async getLastMsgForEachConversations(){return this._db.getAllStatementResult(ge)}async getAllConversations(){return(await this._db.getAllQuery(fe)).filter((e=>/^\d+$/.test(e.ownerId)))}async getRespondedConversations(){return this._db.getAllQuery(be)}async getMessages(e,t,s,r){return this._db.getAllStatementResult(me,[e,t,s.join(","),r])}async countMessageFrom(e,t){const s=await this._db.getStatementResult(pe,[e,t.join(",")]);return s?s.count:0}}const le='type != "chat.webcontent" AND type != "chat.livelocation" AND type != "chat.video.live.msg"',de='CREATE INDEX IF NOT EXISTS "sequenseId" ON "chats" ("sequenseId" DESC)',ue='CREATE INDEX IF NOT EXISTS "ts" ON "chats" ("ts" DESC)',ge=`SELECT chats.* FROM chats INNER JOIN (SELECT ownerId, MAX(ts) as maxTs from chats WHERE ${le} GROUP BY ownerId) AS latest ON chats.ts = latest.maxTs ORDER BY chats.ts DESC`,me=`SELECT * FROM chats WHERE sequenseId < (?) AND sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${le} ORDER BY sequenseId DESC LIMIT (?)`,pe=`SELECT count(*) as count FROM chats WHERE sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${le} ORDER BY sequenseId DESC`,fe="SELECT ownerId, ownerType, ts  FROM threads",be="SELECT DISTINCT ownerId from chats WHERE userId = fromId";class Ie extends C.b{constructor(e){super({type:"RELOAD_MESSAGE",params:e})}}class Se extends C.b{constructor(e){super({type:"RELOAD_MEDIA",params:e})}}class Me{constructor(){this._searchIndexQueue=null,this.session=null}static instance(){return this._instance||(this._instance=new this),this._instance}init(e){this.session=e}indexSearch(e,t){if(t.queueIndexSearch)return this.searchIndexQueue.queueIdxs(e);return k.a.getInstance().executeMessageDbData(e)}get searchIndexQueue(){var e,t,s,r;this._searchIndexQueue||(null!==(e=this.session)&&void 0!==e&&e.userId&&null!==(t=this.session)&&void 0!==t&&t.UIN&&n.ModuleContainer.resolve(d.b).authenticate({userId:null===(s=this.session)||void 0===s?void 0:s.userId,UIN:null===(r=this.session)||void 0===r?void 0:r.UIN}),this._searchIndexQueue=new O.a);return this._searchIndexQueue}}Me._instance=void 0;class ye{constructor(){this.readyToInsertMsgsQueue=[],this.idStore=void 0,this.ttl=void 0,this.logger=void 0,this.database=void 0,this.checkSum=new Set,this.checkSum2=new Set,this.waitForNoiseId=[],this.noiseIdQueue=[],this.waitForGlobalId=[],this.lastInsertedMsgId=Date.now(),this.uid="";const e=n.ModuleContainer.resolve(m.ZLoggerFactory);this.idStore=n.ModuleContainer.resolveToken(P),this.logger=e.createZLogger("sync-message",["msg-cross-importer"]),this.ttl=n.ModuleContainer.resolve(V.a),this.database=null}async open(e,t){await this.close(),this.uid=e,Y.p.setSessionUserId(e),this.checkSum=new Set,this.checkSum2=new Set,n.ModuleContainer.resolve(d.b).authenticate({userId:e,UIN:t}),this.database=n.ModuleContainer.resolve($.b),this.database.authenticate({userId:e,UIN:t}),this.waitForGlobalId=[]}close(){n.ModuleContainer.resolve($.b).close()}queueNewMessages(e){let t=this.verifyCrossMsg(e);this.readyToInsertMsgsQueue=this.readyToInsertMsgsQueue.concat(t.readyToInsert),this.waitForNoiseId=this.waitForNoiseId.concat(t.waitForNoiseId),this.noiseIdQueue=this.noiseIdQueue.concat(t.idsToGetNoise)}resetLastGlobalMsgId(){this.lastInsertedMsgId=Date.now()}async processImportQueue(e){if((e||this.shouldProcessMsgsInWaitForNoiseQueue())&&await this.processWaitForNoiseIdQueue(),(e&&0===this.readyToInsertMsgsQueue.length||this.waitForGlobalId.length>99)&&this.waitForGlobalId.length>0){const e=[];this.processWaitForGlobalIdQueue(e),e.length>0&&(this.queueNewMessages(e),await this.processWaitForNoiseIdQueue())}if(this.readyToInsertMsgsQueue.length){const e=this.readyToInsertMsgsQueue.splice(0,2e3);let s=Math.min(...e.map((e=>e.sequenseId)));s=Math.max(s,this.waitForGlobalId.length?this.waitForGlobalId[0].sequenseId:0,this.waitForNoiseId.length?this.waitForNoiseId[0].sequenseId:0);try{const t=[];this.crossMsgsToNormalMsgs(e,t);return{inserted:(await this.insertToDb(t)).success,minSeqId:s,queued:e,validMsgCount:t.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}catch(t){this.logger.zsymb(18,"7CNlUa",(()=>["processImportQueue error",{error:t}]))}return{inserted:[],minSeqId:s,queued:e,validMsgCount:e.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}return{inserted:[],minSeqId:-1,queued:[],validMsgCount:0,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}printChecksum(){this.logger.zsymb(12,"8EUAtU",(()=>["size",{waitNoise:this.waitForNoiseId,waitGlobal:this.waitForGlobalId,ready:this.readyToInsertMsgsQueue}])),this.checkSum.size>0?this.logger.zsymb(18,"cCk1wM",(()=>["checkSum.size > 0",{miss:this.checkSum.values()}])):this.logger.zsymb(3,"s2q-tC",["checkSum.size == 0","0oy9G3"])}processWaitForGlobalIdQueue(e){const t=this.waitForGlobalId;this.waitForGlobalId=[],this.lastInsertedMsgId=t[0].cliMsgId;for(let s=t.length-1;s>=0;s--){const r=t[s];r.globalMsgId=`${this.lastInsertedMsgId}_${s.toString().padStart(3,"0")}`,e.push(r)}}async insertMsgs(e){e=e.filter((e=>!!e.globalMsgId));let t=this.verifyCrossMsg(e).idsToGetNoise;t.length&&await this.idStore.import({uids:t});let s=[];return this.crossMsgsToNormalMsgs(e,s),this.insertToDb(s)}async processWaitForNoiseIdQueue(){if(0===this.noiseIdQueue.length)return;const e=this.noiseIdQueue,t=this.waitForNoiseId;this.waitForNoiseId=[],this.noiseIdQueue=[],await this.idStore.import({uids:e}),this.readyToInsertMsgsQueue.push(...t)}shouldProcessMsgsInWaitForNoiseQueue(){return this.noiseIdQueue.length>=1e3||this.waitForNoiseId.length>150}crossMsgsToNormalMsgs(e,t){j.normalMsg.start();for(let r=0;r<e.length;r++){const i=e[r];try{if("number"==typeof i.globalMsgId&&i.globalMsgId>0&&(this.lastInsertedMsgId=i.globalMsgId,this.waitForGlobalId.length>0)){const e=this.waitForGlobalId;this.waitForGlobalId=[];for(let s=e.length-1;s>=0;s--){const r=e[s];r.globalMsgId=`${i.globalMsgId}_${s.toString().padStart(3,"0")}`,this.crossMsgToNormalMsg(r,t)}}this.crossMsgToNormalMsg(i,t)}catch(s){}}j.normalMsg.end()}crossMsgToNormalMsg(e,t){if(!e.globalMsgId)return void this.waitForGlobalId.push(e);const s=e.parsedType||Q.default.normalizeMessageType(e.type);if(s===x.MSG_UNKNOWN)return void 0;let r=e.parsedIdTo||this.idStore.get(e.ownerId),i=e.parsedUidFrom||e.fromId==e.userId?"0":this.idStore.get(e.fromId);if(!i||!r)return void 0;let n=e.msg,a=e.attachData;switch(a.mentions&&Array.isArray(a.mentions)&&a.mentions.forEach((e=>{e.uid="-1"===e.uid?"-1":this.idStore.get(e.uid)})),a.quote&&(a.quote.ownerId=this.idStore.get(a.quote.ownerId)),s){case x.MSG_TEXT:a&&a.attach&&a.attach.action&&"rtf"==a.attach.action&&(a.attach.title||(a.attach.title=e.msg),n=a.attach);break;case x.MSG_PHOTO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_STICKER:n=a.attach||{};break;case x.MSG_GIF:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_VOICE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.params=l(n.params),n.thumb=l(n.thumb),n.title=l(n.title),n.type=l(n.type);break;case x.MSG_VIDEO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.type=l(n.type);break;case x.MSG_LOCATION:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.href=l(n.href),n.thumb=l(n.thumb),n.type=l(n.type);break;case x.MSG_DOODLE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.title=l(n.title);break;case x.MSG_CONTACT:n=a.attach||{},n.description=l(n.description),n.thumb=l(n.thumb);const t=n.action;"recommened.user"!==t&&"recommened.vip"!==t||(n.params=this.idStore.get(n.params));break;case x.MSG_FILE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.type=l(n.type);break;case x.MSG_UNDO:n="";break;case x.MSG_OA:case x.MSG_ECARD:case x.MSG_POLL:n=a.attach;break;case x.MSG_ZINSTANT_OLD:case x.MSG_ZINSTANT:if(!a.attach||!a.attach.params||-1==a.attach.params.indexOf("pcItem"))return void this.logger.zsymb(0,"NR82vV","Skip invalid zinstant",null==e?void 0:e.globalMsgId);n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action,""),n.description=l(n.description,""),n.title=l(n.title,""),n.href=l(n.href,""),n.thumb=l(n.thumb,""),n.params=l(n.params),delete n.childNumber}let o=null;if("chat.undo"==e.type&&e.attach)try{if(a.attach&&a.attach.params){let t=JSON.parse(a.attach.params).custom_message;if(t){t=JSON.parse(t);const s=t.highLightsV2;s.length&&(o=s[0]&&s[0].uid,o=this.idStore.get(o),o=o==this.uid?"0":o,e.type="chat.delete.everyone")}}}catch(d){this.logger.zsymb(18,"y9Dd9J",(()=>["parseParams error:",{error:d}]))}const c={msgId:e.globalMsgId,zglobalMsgId:-1,cliMsgId:e.cliMsgId,msgType:e.type,status:"0"==i?x.MSG_DELIVERED:x.MSG_READ,notify:"1",mentions:a.mentions,quote:a.quote,content:n,ts:e.ts.toString(),uidFrom:i,dName:e.fromName,propertyExt:a.property,ttl:e.ttl};a.reference&&(c.reference=a.reference);const h=q.a.transformMessageFromServer(c,r);function l(e,t=""){return e instanceof Object&&Object.keys(e).length?t:e||t}h.localDttm=Date.now(),h.src=x.MSG_SRC.SYNC_MOBILE_DB,h.sequenceId=e.sequenseId,h.uidSenderDel=o,h.msgType!==x.MSG_UNKNOWN?t.push(h):this.logger.zsymb(0,"_YViBt",(()=>["skip message: unknown type",{id:h.cliMsgId,type:e.type}]))}verifyCrossMsg(e){const t=[],s=[],r=new Set;for(let o=0;o<e.length;o++){var i,n;const c=e[o];if(!c)continue;let h=!1;const l=e=>{e&&"-1"!==(e=e.toString())&&(this.idStore.get(e)||(h||(h=!0,t.push(c)),r.add(e)))};if(l(c.ownerId),l(c.fromId),!c.attachData){let e={};if(c.attach)try{e=JSON.parse(c.attach)}catch(a){}c.attachData=e}const d=c.attachData,u=null===(i=d.attach)||void 0===i?void 0:i.action;"recommened.user"!==u&&"recommened.vip"!==u||null===(n=d.attach)||void 0===n||!n.params||l(d.attach.params),d.mentions&&Array.isArray(d.mentions)&&d.mentions.forEach((e=>{l(e.uid)})),d.quote&&l(d.quote.ownerId),h||s.push(c)}return{waitForNoiseId:t,readyToInsert:s,idsToGetNoise:Array.from(r)}}async insertToDb(e){e=await this._filterDeletedMessages(e);const t=await this._insertMessage(e);return j.mediaRes.start(),await Promise.all([this._insertMedia(t.success),this._insertFilesToResDB(t.success)]),j.mediaRes.end(),await this._insertTTL(t.success),this._sendMediaMsgToMain(t.success),t}_insertMedia(e){j.writeMedia.start();const t=`${J.c.TRANSFER_MOBILE}${J.d.FROM_MSG}`;return n.ModuleContainer.resolve(H.a).addMediasWhenTransferMessage(e,t,ee()).then((e=>(j.writeMedia.end(),e)))}_insertFilesToResDB(e){j.writeFileRes.start();const t=e.reduce(((e,t)=>(t.msgType===x.MSG_FILE&&e.push({msgId:t.msgId,userId:t.toUid,message:t.message,sendDttm:t.sendDttm,fromUid:t.fromUid,type:"file",cliMsgId:t.cliMsgId}),e)),[]);return(async(e,t)=>{try{let s=[],r=[];for(let e of t){const{res:t,ref:i,error:n}=Z.toDb(e);n||(s.push(t),r.push(i))}if(s.length>0){const t=e.table($.a.TablePath.Res);await t.insertMulti(s)}if(r.length>0){const t=e.table($.a.TablePath.Ref);await t.insertMulti(r)}}catch{}})(this.database,t).then((e=>(j.writeFileRes.end(),e)))}async _insertTTL(e){const t=e.filter((e=>e.ttl&&e.ttl>0)),s=W.b.createFromUid(this.uid).deriveTTLItems(t);if(t.length<=0)return;const r=await this.ttl.putMsgs(s);r.ok?this.logger.zsymb(3,"pXDL9G",["ttl insert success","lonOM7"]):(this.logger.zsymb(21,"exVd3b",["ttl insert fail","_h3xwg"]),this.logger.zsymb(3,"Yqzxdn",["ttl invalid {}, error {}","uA6R-h"],r.error.invalidItems.length,r.error.errorItems.length))}async _insertMessage(e){j.writeMsgs.start();const t=new Map;e.forEach((e=>{t.has(e.toUid)?t.get(e.toUid).push(e):t.set(e.toUid,[e])}));const s=[],r=this.database.table($.a.TablePath.Message);return t.forEach(((e,t)=>{s.push(r.insertMulti(e,{partition:t}))})),Promise.all(s).then((e=>(j.writeMsgs.end(),e.reduce(((e,t)=>(e.success.push(...t.success),e.fail.push(...t.fail),e)),{success:[],fail:[]})))).catch((e=>{throw this.logger.zsymb(18,"B3DN_A","insert msg err",e),e}))}_sendMediaMsgToMain(e){if(!Q.default.isWeb()){const t=ie.default.getInstance().getItem(x.KEY_CONFIG_TRANSFER_AUTODL),{validDays:s}=t&&Object(ne.a)(t),r=24*(s||re.default.auto_download_media_transfered.validDays)*60*60*1e3,i=e.filter((e=>this._isMediaMsg(e)&&!this._isAIStickerMessage(e)&&!this._isPhotoStickerMessage(e)&&this._isValidTime(e,r)));Array.isArray(i)&&i.length>0&&$zFeatures.transfer.notifyReceiveMediaMsgs(i)}}_isMediaMsg(e){var t;const s=e.msgType;if(s===x.MSG_CONTACT&&"recommened.link"===(null===(t=e.message)||void 0===t?void 0:t.action))return!0;return[x.MSG_PHOTO,x.MSG_PHOTO_2,x.MSG_DOODLE,x.MSG_FILE,x.MSG_VOICE,x.MSG_VIDEO].includes(s)}_isAIStickerMessage(e){return!1}_isPhotoStickerMessage(e){return!1}_isValidTime(e,t){const s=+e.sendDttm;return!(K.default.getTimeNow()-s>=t)}async _filterDeletedMessages(e){let t={},s=[];for(let n=0;n<e.length;n++){const r=e[n];r.msgType==x.MSG_UNDO?s.push(r):(t[r.toUid]||(t[r.toUid]=[]),t[r.toUid].push(r))}await this._sendUndo(s);let r=Object.keys(t);const i=[];for(let n=0;n<r.length;n++){const e=r[n];i.push(...t[e])}return i}async _sendUndo(e){}}class ve{constructor(e,t,s,r,i){this.session=e,this.backup=t,this.conv=s,this.lastTimetemp=r,this.abort=i,this.logger=void 0,this.msgInserted=void 0;const a=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=a.createZLogger("msg-sync",["importerv2","format-2"]),this.msgInserted=!1,this.lastTimetemp||(this.lastTimetemp=Number.MAX_SAFE_INTEGER)}async execute(e,t){this.logger.zsymb(0,"38-D0r",`restoring ${this.conv.plainId}, ${this.conv.noiseId}`);try{await this.doRestoreMessages(e,t)}catch(s){this.logger.zsymb(18,"t6jP1S",(()=>[`restore error: ${this.conv.plainId}`,{error:s.message||s}]))}this.msgInserted&&this.reloadConversation(),this.logger.zsymb(0,"-Hsikg",`done restoring ${this.msgInserted} ${this.conv.noiseId}`)}async doRestoreMessages(e,t){const s={ownerId:this.conv.plainId,ownerType:this.conv.isGroup?1:0},r=new ye,i=await this.backup.getBackupOfConversation(s);if(!i)return void this.logger.zsymb(0,"9Gndtp","backup not found, skip",s.ownerId);const n=await i.getFirstMessageTimeStamp();r.open(this.session.userId,this.session.UIN);let a=0,o=!1,c=0,h=!this.conv.hasPreviewMsg;j.countMsg.start();let l=await i.countMessages(this.lastTimetemp);for(j.countMsg.end(),r.resetLastGlobalMsgId();;){if(this.abort.aborted)return;if(l>0){let e=await(null==i?void 0:i.getMessages(this.lastTimetemp,c,2e3,s.ownerId));if(0===e.length)l=0;else{c=e[e.length-1].cliMsgId,(0===a||e[0].ts>a)&&(a=e[0].ts);for(let t=e.length-1;t>=0;t--){const s=e[t].ts;if(s<this.lastTimetemp){this.lastTimetemp=s;break}}r.queueNewMessages(e),l-=e.length}}let d=await r.processImportQueue(o);if(0===d.queued.length){if(d.hasMore){o=!0;continue}}else o=!1;if(this.msgInserted=this.msgInserted||d.inserted.length>0,0===d.queued.length&&l<=0)return r.close(),void i.close();h&&d.inserted.length>0&&(h=!1,this.reloadPreview(d)),j.indexSearch.start(),await Me.instance().indexSearch(d.inserted,{queueIndexSearch:e}),j.indexSearch.end(),t(d.validMsgCount,d.inserted.length,this.lastTimetemp,n,a),await new Promise((e=>setTimeout(e,10)))}}reloadConversation(){new Ie({convId:this.conv.noiseId,fromTs:0,toTs:0}).run(),new Se({convId:this.conv.noiseId}).run()}reloadPreview(e){let t=e.inserted[0];for(let s=1;s<e.inserted.length;s++){const r=e.inserted[s];r.sendDttm>t.sendDttm&&(t=r)}new R.a([t]).run()}}class we{constructor(e){this.noiseIdStore=void 0,this.importer=void 0,this.session=null,this.logger=void 0,this.noiseIdStore=n.ModuleContainer.resolveToken(P),this.importer=n.ModuleContainer.resolveToken(ye);const t=n.ModuleContainer.resolve(m.ZLoggerFactory);this.logger=t.createZLogger("msg-sync",["importer",e])}async restoreConversations(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreConversations.bind(this,e);return Me.instance().init(this.session),this.usingDatabase(t,s,r)}async restoreMessages(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreMessages.bind(this,e);return Me.instance().init(this.session),this.usingDatabase(t,s,r)}async usingDatabase(e,t,s){let r,i;await this.noiseIdStore.init(e),await this.open(e,t);try{r=await s()}catch(n){i=n}if(await this.close(),i)throw i;return r}async open(e,t){await this.importer.close(),this.session={userId:e,UIN:t},await this.importer.open(e,t)}async close(){await this.importer.close()}}let Ee=function(e){return e[e.Text=0]="Text",e[e.Doodle=2]="Doodle",e[e.Photo=3]="Photo",e[e.Photo_V2=4]="Photo_V2",e[e.Voice=6]="Voice",e[e.Sticker=10]="Sticker",e[e.Contact=12]="Contact",e[e.OA=15]="OA",e[e.Location=18]="Location",e[e.Video=19]="Video",e[e.ECard=21]="ECard",e[e.File=22]="File",e[e.Gift=23]="Gift",e[e.Webcontent=24]="Webcontent",e[e.VideoLive=25]="VideoLive",e[e.PhotoV2=31]="PhotoV2",e[e.ChatDelete=33]="ChatDelete",e[e.Undo=36]="Undo",e}({});const _e={0:"webchat",2:"chat.doodle",3:"chat.photo",4:"chat.photo",6:"chat.voice",10:"chat.sticker",12:"chat.recommended",15:"chat.list.action",18:"chat.location.new",19:"chat.video.msg",20:"webchat",22:"share.file",23:"chat.gif",24:"chat.webcontent",25:"chat.video.live.msg",26:"group.poll",31:"chat.photo",33:"chat.delete",36:"chat.undo"};var Te=s("nhJq");const De=$znode.nativelibs.dbUtils(),Ce=$znode.path;class Re{constructor(e){this.noiseUserId=void 0,this._db=void 0,this.plainUserId=void 0,this.logger=void 0,this.noiseId=void 0,this._db=$zsqlite.createConnection(e.path,{OPEN_CREATE:!0,OPEN_READWRITE:!0}),this.logger=e.logger,this.noiseUserId=e.noiseUserId,this.plainUserId=e.plainUserId,this.noiseId=e.noiseId}close(){return this._db.close()}open(){return this._db.open()}doWithLog(e,t,...s){return t(...s).catch((t=>{throw this.logger.zsymb(18,"uvSmcX",`backup: ${e}`,...s,t),t}))}async getFirstMessageTimeStamp(){const e=await this.doWithLog("getFirstMessageTimeStamp",this._db.getAllQuery,Ne);return 0===e.length?0:e[0].TimeStamp}async countMessages(e){const t=[e],s=await this.doWithLog("countMessages",this._db.getStatementResult,Ae,t);return s?s.count:0}async getMessages(e,t,s,r){const i=[e,t,s];j.readSQL.start();const n=await this.doWithLog("getMessages",this._db.getAllStatementResult,Le,i);j.readSQL.end();const a=[];return j.convertVersion.start(),n.forEach((e=>{const t=this.convertCrossV2ToCrossV1(e);t&&a.push(t)})),j.convertVersion.end(),this.logger.zsymb(0,"QFeDIe",`getMessages: ${r}, old:${n.length}, new:${a.length}`),a}async hasResponsedByUser(e){const t=await this.doWithLog("hasResponsedByUser",this._db.getQuery,Fe(e));return!!t&&t.count>0}convertCrossV2ToCrossV1(e){const t=_e[e.MsgType];if(!t)return null;const s=De.parseBinNet(e.BinNet)||{};if(s.result>0)return this.logger.zsymb(21,"-Q-g2r",["ParseBinNetFail","sOuA3W"],{message:s.error_message,result:s.result,innerError:s.inner_error}),null;const r=s.data;return r.attachs&&r.attachs.length>0&&r.attachs[0]&&(e.MsgType===Ee.OA?r.attach=r.attachs:(r.attach=r.attachs[0],e.MsgType!==Ee.Sticker&&r.attach&&delete r.attach.catId)),{fromId:e.SenderId.toString(),fromName:"",attach:"{}",attachData:r,globalMsgId:e.GlbMsgId,cliMsgId:e.CliMsgId,msg:e.MsgContent,ownerId:this.noiseId,ownerType:0,sequenseId:e.TimeStamp,ts:e.TimeStamp,ttl:e.TTL,type:t,userId:this.plainUserId}}}class Oe{constructor(e,t,s,r){this.path=e,this.plainUserId=t,this.noiseUserId=s,this.logger=r,this._responsedByMe=new Set}async open(){}async close(){}async getAllConversations(){const e=[],t=await Te.c(this.path);for(const s of t)if(s.endsWith(".db")){const t="g"===s[0]?1:0,r=t?6:0,i=s.length-3,n=s.substring(r,i);e.push({ownerId:n,ownerType:t})}return e}async getMetaDataConversations(e){const t={},s=Date.now();for(const i of e){const e=await this.getBackupOfConversation(i);if(e)try{const r=await e.getMessages(s,0,1,i.ownerId),n=await e.countMessages(s);if(r.length>0){t[i.ownerId]={msg:r[0],numOfMsg:n};await e.hasResponsedByUser(this.plainUserId)&&this._responsedByMe.add(i.ownerId)}}catch(r){if(this.logger.zsymb(18,"MS_QdA",`read conv failure: ${r.message}`),11!=r.errno&&!r.message.includes("SQLITE_CORRUPT"))throw r}finally{e.close()}}return t}getRespondedByMeSet(){return this._responsedByMe}async getBackupOfConversation(e){return this._getNewBackupOfConversation(e)}async _getNewBackupOfConversation(e){const t=e.ownerId,s=1===e.ownerType?`group_${t}`:t,r=Ce.join(this.path,`${s}.db`),i=new Re({path:r,noiseId:t,noiseUserId:this.noiseUserId,plainUserId:this.plainUserId,logger:this.logger});return await i.open(),i}}const ke=[20,21,25,26,29,32,34,35,45,51,52].map((e=>`MsgType != ${e}`)).join(" AND "),Ne="SELECT TimeStamp FROM ChatContent ORDER BY TimeStamp ASC LIMIT 1",Le=`SELECT * FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND CliMsgId NOT NULL AND CliMsgId != (?) AND ${ke} ORDER BY TimeStamp DESC LIMIT (?)`,Ae=`SELECT count(*) as count FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND cliMsgId NOT NULL AND ${ke}`,Fe=e=>`SELECT count(*) as count FROM ChatContent WHERE SenderId = ${e} AND MsgStatus > 0 AND ${ke}`;var Ue=s("cfFl");class ze extends we{constructor(){super("format-1"),this._backup=null}async doRestoreConversations(e){Me.instance().searchIndexQueue.pause();const{params:t,abort:s}=e,r=await this._getBackup(t.backupPath,t.plainUserId,t.noiseUserId);let i=await r.getAllConversations();const n=[],a=[];if(i.forEach((e=>{1===e.ownerType?n.push(e.ownerId):a.push(e.ownerId)})),await this.noiseIdStore.import({gids:n,uids:a}),s.aborted)throw new Error("aborted");const o=await r.getMetaDataConversations(i),c=r.getRespondedByMeSet();if(s.aborted)throw new Error("aborted");i=i.filter((e=>o[e.ownerId]&&o[e.ownerId].numOfMsg>0));const h=i.map((e=>o[e.ownerId].msg)),l=await this.importer.insertMsgs(h),d={},u=[],g=[];return i.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,r={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:c.has(e.ownerId)};u.push(r),d[t]=r}else g.push(e.ownerId)})),l.success.forEach((e=>{d[e.toUid]&&(d[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{d[e.toUid]&&(d[e.toUid].lastMessage=e)})),await Me.instance().indexSearch(l.success,{queueIndexSearch:t.meta.queueIndexSearch}),u}doRestoreMessages(e){return Me.instance().searchIndexQueue.pause(),j.reset(),j.unlock(),j.total.start(),new Promise((async t=>{const{params:s,checkpoint:r,abort:i,report:n}=e,a=new Set;if(!r||1!==r.format)throw new Error("invalid checkpoint");let o=s.conversations.filter((e=>!e.shouldIgnore)),c=s.meta.viewingConversation;const h=()=>{if(c){const t=(e=c,o.find((t=>t.noiseId===e)));if(this.logger.zsymb(0,"lnJ9Xg",`getViewingConversation ${c} ${JSON.stringify(t)}`),t)return t}var e;return null};let l=r.priorities;function d(){if(l.length>0){const e=h();let t;if(e&&!a.has(e.plainId))c=null,t=e;else{const e=l.find((e=>!a.has(e)));t=o.find((t=>t.plainId===e))}return t}return o[0]}e.onParamsChange((e=>{e&&e.meta&&e.meta.viewingConversation&&(this.logger.zsymb(0,"iVQyDX",`viewing conversation changed to ${e.meta.viewingConversation}`),c=e.meta.viewingConversation)}));const u=()=>Math.floor(r.syncedMessages/s.meta.numberOfMessages*95),g=await this._getBackup(s.backupPath,s.plainUserId,s.noiseUserId);let m;const p=()=>{r.syncedConversations=s.meta.numberOfConversations,n(100,r),j.total.end(),j.print(),a.clear(),t({trackInfo:j.getSnapShot()})},f=()=>{if(l.length>o.length){this.logger.zsymb(0,"XFnS3i","detect invalid priority conv "+(o.length-l.length));const e=new Set(o.map((e=>e.plainId))),t=[];for(let s=0;s<l.length;s++)e.has(l[s])&&t.push(l[s]);l=t,r.priorities=t}},b=()=>{if(l.length<=0||i.aborted)return void this.logger.zsymb(0,"cEX8O1","done restore: ",l.length,i.aborted);const e=d();e?(a.add(e.plainId),m.push(e)):f()};m=Object(Ue.queue)((async e=>{r.syncingConversation=e.noiseId,n(u(),r);const t=new ve(this.session,g,e,r.currentSeq[e.plainId],i);var a;await t.execute(s.meta.queueIndexSearch,((t,s,i,a,o)=>{r.syncedMessages+=t,r.importedMessages+=s,r.currentSeq[e.plainId]=i,0===r.maxSeq?r.maxSeq=o:r.maxSeq=Math.max(r.maxSeq,o),0===r.minSeq?r.minSeq=a:r.minSeq=Math.min(r.minSeq,a),n(u(),r)})),delete r.currentSeq[e.plainId],t.msgInserted&&(r.updatedConversation++,n(u(),r)),a=e,l=l.filter((e=>e!==a.plainId)),r.priorities=l.filter((e=>e!==a.plainId)),o=o.filter((e=>e.noiseId!==a.noiseId)),b()}),5),f(),d()?m.drain=p:p();for(let e=0;e<=5;e++)b()}))}async close(){return this._backup&&await this._backup.close(),super.close()}async _getBackup(e,t,s){return this._backup||(this._backup=new Oe(e,t,s,this.logger),await this._backup.open()),this._backup}}function Ge(e){try{if(0===e)return new ce;if(1===e)return new ze}catch(t){throw t}throw new Error(`Unsupported format: ${e}`)}var je;Object(c.j)()(je=Object(n.injectable)()(je=class extends C.a{getType(){return"RESTORE_CONVERSATIONS"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));const t=Ge(e.params.format);return te(e.params.shouldUseNewMediaDBFlowConfig),t.restoreConversations(e)}})||je);var Pe;Object(c.j)()(Pe=Object(n.injectable)()(Pe=class extends C.a{getType(){return"RESTORE_MESSAGES"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));const t=Ge(e.params.format);return te(e.params.shouldUseNewMediaDBFlowConfig),t.restoreMessages(e)}})||Pe);var xe;const Qe=$znode.nativelibs.dbUtils();Object(c.j)()(xe=Object(n.injectable)()(xe=class extends C.a{getType(){return"DECRYPT_BACKUP"}async execute(e){return e.abort.aborted?Promise.reject(new Error("Aborted")):this._decyptBackup(e)}async _decyptBackup(e){const{params:t,report:s}=e;return await Object(Te.b)(t.outputPath),0===t.format?this._decryptBackupFormat0(t.inputPath,t.outputPath,t.privateKey):this._decryptBackupFormat1(t.inputPath,t.outputPath,t.privateKey,t.numberOfConversationsCount,s)}async _decryptBackupFormat0(e,t,s){const{result:r,err_message:i}=Qe.decompressAndDecryptDb(e,t,s);return 0===r?t:Promise.reject({error:r,message:i})}async _decryptBackupFormat1(e,t,s,r,i){t=await Object(Te.a)(t);let n=0;const{result:a,inner_error:o,error_message:c}=Qe.decompressAndDecryptDb_V2(e,t,s.toUpperCase(),(()=>{n++;const e=Math.floor(Math.round(n/r*100));i(e)}));return 0===a?t:Promise.reject({error:a,inner_error:o,message:c})}})||xe);var qe=s("Jz/+"),Be=s("d/or"),$e=s("YEoC");n.ModuleContainer.resolve(i.a).addEventListener(qe.a.SessionChange,(async({session:e})=>{if(null===e)return;const t=n.ModuleContainer.resolve(Be.a);await t.getAdapterTypeOfUserScopedDatabases(e.userId)==$e.a.IDB?s.e(47).then(s.bind(null,"AYQT")):s.e(48).then(s.bind(null,"PKoC"))}));s("Ceyj");var Ze=s("VTBJ"),Ve=s("pAGP"),We=s("wH4e"),Ye=s("QiE6");class Ke{constructor(){this._listeners={}}addEventListener(e,t){var s;const r=null!==(s=this._listeners[e])&&void 0!==s?s:[];return r.push(t),this._listeners[e]=r,this}removeEventListener(e,t){var s;this._listeners[e]=null!==(s=this._listeners[e])&&void 0!==s?s:[];const r=this._listeners[e].indexOf(t);return-1===r||this._listeners[e].splice(r,1),this}async dispatchEvent(e,t,s=!1){var r;const i=null!==(r=this._listeners[e])&&void 0!==r?r:[];if(i.length)if(s)for(const n of i)await n(t);else await Promise.all(i.map((e=>e(t))))}}var He=s("KkZn"),Je=s("y4y9"),Xe=s("q1L6"),et=s("dm9D"),tt=s("Xb5w"),st=s("vBob"),rt=s("Q8nW"),it=s("ZChn");s("mHfx"),s("g2tJ");class nt{constructor(e){this.data=void 0,this.typeId=void 0,this.data=new Map,this.typeId=e}addItem(e,t){this.data.set(e,{path:e,id:t})}removeItem(e){this.data.delete(e)}getItems(){return Array.from(this.data.values())}getItem(e){return this.data.get(e)}hasItem(e){return this.data.has(e)}get size(){return this.data.size}clear(){this.data.clear()}getTypeId(){return this.typeId}}var at=s("IpzU");const ot="renderer"===__SCRIPT_TYPE__?$znode.path:s("ipWf");class ct{constructor(){this.paths=void 0,this.isInititalized=void 0,this.paths={},this.isInititalized=!1}static getInstance(){return this.instance||(this.instance=new ct),this.instance}async init(e){this.paths.zaloDownloadsDir=await at.getUserZaloDownloadsDir(e),this.isInititalized=!0}getUserZaloDownloadsDir(){return this.paths.zaloDownloadsDir}getZaloDownloadsVideoDir(e){return e.startsWith(x.GROUPID_PREFIX)?ot.join(this.paths.zaloDownloadsDir,"video","group",ot.sep):ot.join(this.paths.zaloDownloadsDir,"video",ot.sep)}getZaloDownloadsVoiceDir(e){return e.startsWith(x.GROUPID_PREFIX)?ot.join(this.paths.zaloDownloadsDir,"voice","group",ot.sep):ot.join(this.paths.zaloDownloadsDir,"voice",ot.sep)}getZaloDownloadsRichThumbDir(e){return e.startsWith(x.GROUPID_PREFIX)?ot.join(this.paths.zaloDownloadsDir,"richThumb","group",ot.sep):ot.join(this.paths.zaloDownloadsDir,"richThumb",ot.sep)}getZaloDownloadsPictureDir(e){let t=e;return t.startsWith(x.GROUPID_PREFIX)&&(t=t.slice(1)+"_group"),ot.join(this.paths.zaloDownloadsDir,"picture",t,ot.sep)}getZaloDownloadsFileDir(e){let t="";return e.startsWith(x.GROUPID_PREFIX)&&(t="group"),ot.join(this.paths.zaloDownloadsDir,"file",t,ot.sep)}getZaloDownloadsFileNoiseDir(e){let t="";return e.startsWith(x.GROUPID_PREFIX)&&(t="group"),ot.join(this.paths.zaloDownloadsDir,"fileNoise",t,ot.sep)}getZaloDownloadsFileThumbDir(){return ot.join(this.paths.zaloDownloadsDir,"fileThumb",ot.sep)}getZaloDownloadsZInstantDir(){return ot.join(this.paths.zaloDownloadsDir,"zinstant",ot.sep)}}ct.instance=void 0;var ht=ct,lt=s("AqnK"),dt=s("QmNg");var ut,gt=class extends Ke{constructor(e){super(),this.convId=void 0,this.userId=void 0,this.types=void 0,this.data=void 0,this.status=void 0,this.getResourcePaths=async(e,t,s)=>{const r=[],i=ht.getInstance();switch(e){case x.MSG_VOICE:{const e=i.getZaloDownloadsVoiceDir(this.convId);r.push(...t.map((t=>[$znode.path.join(e,t.msgId),t.msgId])));break}case x.MSG_VIDEO:{const e=i.getZaloDownloadsVideoDir(this.convId);r.push(...t.map((t=>[$znode.path.join(e,t.msgId),t.msgId])));break}case x.MSG_CONTACT:{const e=i.getZaloDownloadsRichThumbDir(this.convId);t.forEach((t=>{if(Object(et.s)(t)&&t.message.thumb){const s=t.message.thumb;r.push([$znode.path.join(e,`z${t.msgId}_${Object(He.d)(s)}${Object(He.b)(s)||".jpg"}`),t.msgId],[$znode.path.join(e,`z_${Object(He.d)(s)}${Object(He.b)(s)||".jpg"}`),t.msgId])}}));break}case x.MSG_PHOTO:{const e=i.getZaloDownloadsPictureDir(this.convId);for(const n of t){let t=!1;if(n.message){const a=[n.message.oriUrl,n.message.hdUrl,n.message.normalUrl,n.message.thumbUrl];for(const o of a)if(o){const a=$znode.path.join(e,`z${n.msgId}_${Object(He.e)(o)}`);if(r.push([a,n.msgId]),!t&&rt.j(a)&&(t=!0),s.includeImageGen){r.push([$znode.path.join(e,`z${n.msgId}_${Object(He.e)(o,".jpg")}`),n.msgId]);for(let e of Object.values(lt.n)){const t=i.getUserZaloDownloadsDir(),s=await dt.b.ZaloDownload_Photo(t,this.convId,Object(dt.d)({cliMsgId:n.cliMsgId,fromUid:n.fromUid,toUid:this.convId}),e);r.push([s,n.msgId])}}}}!n.localPath||t&&!s.includeImageGen||r.push([n.localPath,n.msgId])}break}case x.MSG_FILE:{const e=i.getZaloDownloadsFileDir(this.convId),s=i.getZaloDownloadsFileNoiseDir(this.convId),n=i.getZaloDownloadsVideoDir(this.convId);t.forEach((t=>{const i=function(e){let t="";if(!e)return t;if(e.params)try{const s=JSON.parse(e.params);s&&s.checksum&&(t=s.checksum)}catch(s){t=""}return t}(t.message),a=function(e){var t;const s=e.localPath;let r=s?Object(He.b)(s):Je.fHelper.getMime(e);if(r)return r;if(null!==(t=e.message)&&void 0!==t&&t.params)try{const t=JSON.parse(e.message.params);t&&t.fileExt&&(r=t.fileExt)}catch{r=""}return r}(t);r.push([$znode.path.join(e,i),t.msgId]),r.push([$znode.path.join(s,i),t.msgId]),Xe.a.getGenType(a)&&r.push([Je.fHelper.getPhotoThumbCache(t,i),t.msgId]),(t.subType===x.MSG_SUBTYPE_MEDIA_VIDEO||a in st.a.VideoType)&&r.push([$znode.path.join(n,t.msgId),t.msgId])}));break}case x.MSG_ZINSTANT:case x.MSG_ZINSTANT_OLD:{const e=i.getZaloDownloadsZInstantDir();t.forEach((t=>{const s=tt.a.getFileNameFromUrl(tt.a.getUrl(t));s&&r.push([$znode.path.join(e,s),t.msgId])}));break}}if(t.forEach((({localPath:t,msgId:s})=>{t&&e!==x.MSG_PHOTO&&r.push([t,s])})),r.length>0){const t=this.data.get(e)||new nt(e);r.forEach((([e,s])=>t.addItem(e,s))),this.data.set(e,t)}},this.convId=e.convId,this.userId=e.userId,this.types=e.msgTypes,this.data=new Map,this.status=new Map}async onScanSuccess(e){this.status.set(e,"done"),this.types.every((e=>"done"===this.status.get(e)))&&await this.dispatchEvent("success",{data:this.data,key:this.convId})}async onScanProgress(e,t,s){await this.dispatchEvent("progress",{type:e,key:this.convId,data:this.data.get(e),metadata:{fromDttm:t,toDttm:s}})}async onScanError(e){this.status.set(e,"failed"),await this.dispatchEvent("error",{data:e,key:this.convId})}async scanMessages(e,t,s){return new Promise(((r,i)=>{const n=g.default.getInstance(),[a,o]=t,{getConfig:c,abort:h,partitioning:l}=s,d={limit:c().batchSize,partition:this.convId,aborted:()=>!(!h||!h.aborted)};(l?n.Core.Message.index("msgType_sendDttm").getAll({from:[e,String(a)],to:[e,String(o)],excludeTo:!0,excludeFrom:!1},d):n.Core.Message.index("userId_msgType_sendDttm").getAll({from:[this.convId,e,String(a)],to:[this.convId,e,String(o)],excludeTo:!0,excludeFrom:!1},d)).then((t=>{if(t.length>0){const n=Number(t[t.length-1].sendDttm);this.getResourcePaths(e,t,c()),this.onScanProgress(e,a,n).then((()=>{setTimeout((()=>{h&&h.aborted?i("aborted"):this.scanMessages(e,[n+1,o],s).then(r,i)}),c().batchDelay)})).catch(i)}else this.onScanSuccess(e).then(r,i)})).catch((t=>{it.a.getInstance().zsymb(18,"D70QCW",`fail scan for msgType=${e} convId=${this.convId}`,t),this.onScanError(e),i(t)}))}))}async run(e){const{getConfig:t,getRange:s,abort:r,partitioning:i}=e,n=ht.getInstance();n.isInititalized||await n.init(this.userId);const a=[];for(const o of this.types)"running"!==this.status.get(o)&&(this.status.set(o,"running"),a.push(this.scanMessages(o,s?s(this.convId,o):[0,Date.now()],{getConfig:t,abort:r,partitioning:i})));await Promise.all(a)}flush(){this.data.clear(),this.status.clear()}get key(){return this.convId}};Object(n.singleton)(Ye.ResourceScannerExecutor)(ut=Reflect.metadata("design:type",Function)(ut=Reflect.metadata("design:paramtypes",[])(ut=class extends Ke{constructor(){super(),this.scanners=void 0,this.currentChunkIndex=void 0,this.chunks=void 0,this.scanners=new Map,this.currentChunkIndex=-1,this.chunks=[]}getScanner(e,t){let s=this.scanners.get(t);return s||(s=new gt({convId:t,userId:e,msgTypes:Ye.RESOURCE_LINKED_MSG_TYPES}),this.scanners.set(t,s)),s}executeChunk(e){return new Promise(((t,s)=>{if(this.currentChunkIndex<0||this.currentChunkIndex>=this.chunks.length)return t();const r=this.chunks[this.currentChunkIndex],i=performance.now();Promise.all(r.map((t=>this.getScanner(e.userId,t).run({getConfig:e.getConfig,getRange:e.getRange,abort:e.abort,partitioning:e.partitioning})))).then((()=>{this.dispatchEvent("batching",{duration:performance.now()-i,convIds:r}),this.currentChunkIndex+=1,this.executeChunk(e).then(t,s)})).catch((e=>{this.dispatchEvent("batching",{duration:performance.now()-i,convIds:r,error:e}),Ye.ResourceScannerLog.getInstance().zsymb(18,"2qHZjX","execute fail at chunk",this.currentChunkIndex,r,e),s(e)}))}))}init(e,t){t.forEach((t=>this.getScanner(e,t)))}async run(e){const{convIds:t,getConfig:s,userId:r}=e;this.chunks=function(e,t){const s=[];for(let r=0;r<e.length;r+=t)s.push(e.slice(r,r+t));return s}(t,s().batchConv),this.currentChunkIndex=0;let i=e.partitioning;if(!i){i=await n.ModuleContainer.resolve(Ve.a).getAdapterTypeOfUserScopedDatabases(r)===We.a.SQLite}await this.executeChunk(Object(Ze.a)(Object(Ze.a)({},e),{},{partitioning:i}))}})||ut)||ut);var mt,pt=class{constructor(){this.startTs=void 0,this.lastTrackTs=void 0,this.startTs=-1,this.lastTrackTs=-1}start(){this.startTs=performance.now(),this.lastTrackTs=this.startTs,it.a.getInstance().zsymb(0,"8dOEn-","#start scan")}track(e,...t){const s=performance.now(),r=s-this.lastTrackTs;this.lastTrackTs=s,it.a.getInstance().zsymb(0,"LPSz6i",`#track ${e} duration=${r}`,...t)}end(e,...t){const s=performance.now()-this.startTs;e?it.a.getInstance().zsymb(0,"_vR0_W","#end scan status=success",`duration=${s}`,...t):it.a.getInstance().zsymb(18,"2UJah8","#end scan status=fail",`duration=${s}`,...t)}cancel(){const e=performance.now()-this.startTs;it.a.getInstance().zsymb(6,"DRCESY","#cancel scan",`duration=${e}`)}};Object(n.injectable)()(mt=Object(n.singleton)(Ye.ResourceScannerManager)(mt=function(e,t){return Object(n.inject)(Ye.ResourceScannerExecutor)(e,void 0,0)}(mt=Reflect.metadata("design:type",Function)(mt=Reflect.metadata("design:paramtypes",[void 0===Ye.ResourceScannerExecutor?Object:Ye.ResourceScannerExecutor])(mt=class extends Ke{constructor(e){super(),this.executor=e,this.tracking=void 0,this.onConversationScanning=async e=>{await this.dispatchEvent("progress",e)},this.onConversationScanned=async e=>{const{key:t,data:s}=e;await this.dispatchEvent("success-item",[t,s])},this.onConversationsScanned=async e=>{await this.dispatchEvent("batching",e)},this.tracking=new pt}async getAllConversations(){const e=g.default.getInstance();return(await e.Core.Conversation.getAll()).map((({userId:e})=>e)).filter(Boolean)}async run(e){const{abort:t,convIds:s,getConfig:r,getRange:i,userId:n}=e,a=new Map;try{this.tracking.start();let e=s;e||(e=await this.getAllConversations(),this.tracking.track("get conversations",e.length)),this.executor.init(n,e),this.executor.scanners.forEach((e=>{e.addEventListener("progress",this.onConversationScanning),e.addEventListener("success",this.onConversationScanned)})),this.executor.addEventListener("batching",this.onConversationsScanned),await this.executor.run({convIds:e,getConfig:r,getRange:i,abort:t,userId:n}),this.executor.scanners.forEach(((e,t)=>{a.set(t,e.data)})),await this.dispatchEvent("success",a),this.tracking.end(!0)}catch(o){throw this.dispatchEvent("error",o),this.tracking.end(!1,o),o}finally{this.executor.scanners.forEach((e=>{e.removeEventListener("progress",this.onConversationScanning),e.removeEventListener("success",this.onConversationScanned)})),this.executor.removeEventListener("batching",this.onConversationsScanned)}return a}flush(){this.executor.scanners.forEach((e=>{e.flush()}))}})||mt)||mt)||mt)||mt);var ft;Object(c.j)()(ft=Object(n.injectable)()(ft=class extends C.a{getType(){return"RESOURCE_USAGE_SCANNER_SCAN"}async execute(e){const{params:t,abort:s,report:r}=e,{convIds:i,userId:a}=t;let o=t.flush;e.onParamsChange((({flush:e})=>{"boolean"==typeof e&&(o=e)}));const c=n.ModuleContainer.resolve(Ye.ResourceScannerManager),h=await c.run({userId:a,convIds:i,abort:s,getConfig:()=>e.params.config}).finally((()=>{o&&c.flush()}));return r(100),h}})||ft);var bt=s("Ff2n"),It=s("hGrR"),St=s("q8PC");const Mt=["duration","interupted"];var yt;Object(n.singleton)(It.ResourceCleanupStateStorage)(yt=Reflect.metadata("design:type",Function)(yt=Reflect.metadata("design:paramtypes",[])(yt=class extends St.a{constructor(){super(It.RRCStorageName),this.progress=void 0,this.stage=void 0,this.progressLimit=void 0,this.trackingData=void 0,this.progress={},this.stage=It.ResourceCleanupStage.IDLE,this.progressLimit=null,this.trackingData=null}getLocalAsObject(e,t){const s=this.getItemForCurrentUser(e);let r=null;if(null!==s)try{r=JSON.parse(s),"object"!=typeof r&&(r=null)}catch{r=null}return r||t}getLocalAsNumber(e,t=null){const s=this.getItemForCurrentUser(e);if(s){const e=+s;if(!isNaN(e))return e}return t}init(e){super.init(e);const t=this.getLocalAsNumber(It.RRCStorageKeys.STAGE);null!==t&&t in It.ResourceCleanupStage&&(this.stage=t),this.progress=this.getLocalAsObject(It.RRCStorageKeys.PROGRESS,{});const s=this.getLocalAsNumber(It.RRCStorageKeys.PROGRESS_LIMIT);s&&(this.progressLimit=s),this.trackingData=this.getLocalAsObject(It.RRCStorageKeys.TRACKING_DATA)}setStage(e){this.stage=e,this.setItemForCurrentUser(It.RRCStorageKeys.STAGE,String(e))}getStage(){return this.stage}setProgress(e,t,s){this.progress[e]||(this.progress[e]={}),this.progress[e][t]=s,this.setItemForCurrentUser(It.RRCStorageKeys.PROGRESS,JSON.stringify(this.progress))}clearProgress(e){delete this.progress[e],this.setItemForCurrentUser(It.RRCStorageKeys.PROGRESS,JSON.stringify(this.progress))}clearAllProgress(){this.progress={},this.removeItemForCurrentUser(It.RRCStorageKeys.PROGRESS)}getProgress(e){return this.progress[e]}getProgressKeys(){return Object.keys(this.progress)}setProgressKeys(e){this.progress=Object.fromEntries(e.map((e=>[e,{}]))),this.setItemForCurrentUser(It.RRCStorageKeys.PROGRESS,JSON.stringify(this.progress))}setProgressLimit(e){this.progressLimit=e,this.setItemForCurrentUser(It.RRCStorageKeys.PROGRESS_LIMIT,String(e))}getProgressLimit(){return this.progressLimit}clearProgressLimit(){this.progressLimit=null,this.removeItemForCurrentUser(It.RRCStorageKeys.PROGRESS_LIMIT)}setTrackingData(e){const{duration:t,interupted:s}=e,r=Object(bt.a)(e,Mt);this.trackingData||(this.trackingData={startTs:Date.now(),duration:{},interupted:{}}),t&&Object.assign(this.trackingData.duration,t),s&&Object.assign(this.trackingData.interupted,s),Object.assign(this.trackingData,r),this.setItemForCurrentUser(It.RRCStorageKeys.TRACKING_DATA,JSON.stringify(this.trackingData))}getTrackingData(){return this.trackingData}clearTrackingData(){this.trackingData=null,this.removeItemForCurrentUser(It.RRCStorageKeys.TRACKING_DATA)}})||yt)||yt);var vt=s("ut+A");function wt(e,t){return async(...s)=>{const r=performance.now();try{const i=await e(...s);return t(performance.now()-r,!0),i}catch(i){throw t(performance.now()-r,!1),i}}}class Et{constructor(){this.taskQueue=void 0,this.isExecuting=void 0,this.taskQueue=[],this.isExecuting=!1}dequeueTask(){if(!this.isExecuting){const e=this.taskQueue.shift();e&&(this.isExecuting=!0,e().finally((()=>{this.isExecuting=!1,this.dequeueTask()})))}}exec(e,...t){return new Promise(((s,r)=>{this.taskQueue.push((()=>e(t).then(s,r))),this.dequeueTask()}))}}var _t,Tt=s("yVfy"),Dt=s("7+QW"),Ct=s("Fdeg"),Rt=s("ZsEe"),Ot=s("jB3n");class kt{constructor(e,t=1){this.progress=void 0,this.prevProgress=void 0,this.config=void 0,this.emitter=void 0,this.thresholdToSignal=void 0,this.progress=0,this.prevProgress=0,this.config=e,this.emitter=new Ot.a,this.thresholdToSignal=t}signal(){this.progress-this.prevProgress>=this.thresholdToSignal&&(this.prevProgress=this.progress,this.emitter.emit("change",Math.round(this.progress)))}reset(){this.progress=0,this.prevProgress=0,this.signal()}onDoneStage(e){this.progress=Math.min(100,this.progress+this.config[e]),this.signal()}onUpdateStage(e,t){this.progress=Math.min(100,this.progress+this.config[e]*t),this.signal()}subscribeChange(e){this.emitter.on("change",e)}unsubscribeChange(e){this.emitter.off("change",e)}removeAllSubscribers(){this.emitter.removeAllListeners("change")}}class Nt{constructor(){this.reporter=void 0,this.convCount=void 0,this.doneConvCount=void 0,this.convCount=0,this.doneConvCount=0,this.reporter=new kt({takeSnapshot:10,scanMessages:70,deleteResources:20})}reset(){this.convCount=0,this.doneConvCount=0,this.reporter.reset()}onDoneTakeSnapshot(){this.reporter.onDoneStage("takeSnapshot")}onDoneGetConvList(e){this.convCount=e}onDoneDeleteResources(){this.reporter.onDoneStage("deleteResources")}onDoneConvItems(e){this.doneConvCount+=e,this.convCount&&this.reporter.onUpdateStage("scanMessages",e/this.convCount)}onDoneScanMessages(){this.reporter.onDoneStage("scanMessages")}subscribeChange(e){this.reporter.subscribeChange(e)}unscribeChange(e){this.reporter.unsubscribeChange(e)}removeAllSubscribers(){this.reporter.removeAllSubscribers()}}Object(n.injectable)()(_t=Object(n.singleton)(vt.ResourceCleanupManager)(_t=function(e,t){return Object(n.inject)(It.ResourceCleanupStateStorage)(e,void 0,0)}(_t=Reflect.metadata("design:type",Function)(_t=Reflect.metadata("design:paramtypes",[void 0===It.ResourceCleanupStateStorage?Object:It.ResourceCleanupStateStorage])(_t=class{constructor(e){this.stateStorage=e,this.logger=void 0,this.taskID=void 0,this.markerExecutor=void 0,this.config=void 0,this.progressReporter=void 0,this.getScanMessagesRangeForConv=(e,t)=>{const s=this.stateStorage.getProgress(e),r=this.stateStorage.getProgressLimit();if(s&&s[t]&&r){const e=s[t]+1;return[e,Math.max(r,e)]}return[0,Date.now()]},this.onScanFromMessagesProgress=async e=>{const{key:t,data:s,metadata:r,type:i}=e,n=[];s&&s.getItems().forEach((e=>{n.push({filePath:e.path,id:e.id})}));try{if(n.length>0){const e=ht.getInstance().getUserZaloDownloadsDir();await this.markerExecutor.exec((()=>$zFeatures.zwalker.updateFileStats(e,n)))}this.stateStorage.setProgress(t,i,r.toDttm)}catch(a){throw this.Logger.zsymb(18,"T2QIgF","updateFileStats fail",t,a),a}},this.onScanFromMessagesDoneItem=async e=>{const[t]=e;this.stateStorage.clearProgress(t)},this.onScanFromMessagesDoneBatching=async e=>{let{duration:t,convIds:s}=e;const r=this.stateStorage.getTrackingData();r&&(t+=r.duration[It.ResourceCleanupStage.SCAN_MESSAGES]||0),this.stateStorage.setTrackingData({duration:{[It.ResourceCleanupStage.SCAN_MESSAGES]:t}}),this.progressReporter.onDoneConvItems(s.length)},this.taskID=new Rt.a(0),this.markerExecutor=new Et,this.progressReporter=new Nt}get Logger(){return this.logger||(this.logger=n.ModuleContainer.resolve(m.ZLoggerFactory).createZLogger(z.ZLoggerNametags.redundantResCleanup,["cleanup-manager"])),this.logger}getTrackingFolderPaths(e){return Object.keys(Dt.a).map((t=>$znode.path.join(e,t)))}getIgnoreFolderPaths(e){return[$znode.path.join(e,"Cache","**"),$znode.path.join(e,"zcloud","**"),"**"+Ct.b]}async takeResourceSnapshot(){this.stateStorage.setStage(It.ResourceCleanupStage.TAKE_SNAPSHOT);const e=ht.getInstance().getUserZaloDownloadsDir();return await $zFeatures.zwalker.collectDirectoryStats(e,this.getTrackingFolderPaths(e))}scanFromMessages(e){return this.stateStorage.setStage(It.ResourceCleanupStage.SCAN_MESSAGES),new Promise(((t,s)=>{const r=n.ModuleContainer.resolve(Ye.ResourceScannerManager);r.addEventListener("progress",this.onScanFromMessagesProgress),r.addEventListener("success-item",this.onScanFromMessagesDoneItem),r.addEventListener("batching",this.onScanFromMessagesDoneBatching),r.run(e).then(t).catch(s).finally((()=>{r.removeEventListener("progress",this.onScanFromMessagesProgress),r.removeEventListener("success-item",this.onScanFromMessagesDoneItem),r.removeEventListener("batching",this.onScanFromMessagesDoneBatching)}))}))}async deleteResources(e){this.stateStorage.setStage(It.ResourceCleanupStage.DELETE_RESOURCES);const t=ht.getInstance().getUserZaloDownloadsDir();return await $zFeatures.zwalker.deleteUnmarkedFiles(t,this.getIgnoreFolderPaths(t),this.getTrackingFolderPaths(t),e)}async calculateStatsAfterScanning(){const e=ht.getInstance().getUserZaloDownloadsDir(),t=this.stateStorage.getTrackingData();if(t&&t.statsBefore&&t.statsDetailBefore){const s=t.statsBefore,r=t.statsDetailBefore,i=[259200,604800,1209600],n=await $zFeatures.zwalker.statUnmarkedFiles(e,this.getIgnoreFolderPaths(e),this.getTrackingFolderPaths(e),i),a=Object.fromEntries(Object.entries(n.trackingFolderData).map((([e,{size:t,file_number:s}])=>{const i=$znode.path.basename(e);return[i,{size:r[i].size-t,count:r[i].count-s}]}))),o=i.map((e=>n.trackingATime&&n.trackingATime[e]?{count:n.trackingATime[e].file_number,size:n.trackingATime[e].size}:{count:0,size:0}));this.stateStorage.setTrackingData({statsAfter:{count:s.count-n.fileNumber,size:s.size-n.size},statsDetailAfter:a,statsAccessTime:o}),this.Logger.zsymb(0,"hbdaTD",`stats unmarked files=${n.fileNumber} size=${n.size}`,o,a)}}async getAllConversations(){const e=g.default.getInstance();return(await e.Core.Conversation.getAll()).map((({userId:e})=>e)).filter(Boolean)}checkInterrupted(e){const t=this.stateStorage.getTrackingData();if(t){const s=(t.interupted[e]||0)+1;this.stateStorage.setTrackingData({interupted:{[e]:s}}),this.Logger.zsymb(0,"UwAlFb","check interrupted:",s),s&&Tt.b.logCleanupInterrupted(e,t.duration[e])}}async run(e){const{userId:t,abort:s,config:r,maxTimeScan:i=Date.now()}=e;this.config=r,this.progressReporter.reset(),this.stateStorage.isInitialized()||this.stateStorage.init(t),await ht.getInstance().init(t);const n=this.taskID.next();let a=this.stateStorage.getStage(),o=this.stateStorage.getProgressLimit();if(this.Logger.zsymb(0,"Lvgtcc","run task",n,a,o),this.checkInterrupted(a),o?o<i-this.config.expiredCacheTime&&(this.Logger.zsymb(0,"Iz9D9R","cache expired -> start from IDLE"),this.flush(),this.stateStorage.setProgressLimit(i),a=It.ResourceCleanupStage.IDLE):this.stateStorage.setProgressLimit(i),a<=It.ResourceCleanupStage.TAKE_SNAPSHOT){this.Logger.zsymb(0,"sy5S8A","start #1 take snapshot",n);const e=await wt(this.takeResourceSnapshot.bind(this),((e,t)=>{this.Logger.zsymb(0,"1mAf8r","done #1 take snapshot",n,e),this.stateStorage.setTrackingData({duration:{[It.ResourceCleanupStage.TAKE_SNAPSHOT]:e}}),Tt.b.logCleanupPerf(It.ResourceCleanupStage.TAKE_SNAPSHOT,e,t)}))(),t=Object.fromEntries(Object.entries(e.trackingFolderData).map((([e,{size:t,file_number:s}])=>[$znode.path.basename(e),{size:t,count:s}])));this.stateStorage.setTrackingData({statsBefore:{size:e.size,count:e.fileNumber},statsDetailBefore:t}),Tt.c.logSnapshotSuccessDetail(e.size,t),this.Logger.zsymb(0,"Efqgha",`stats before files=${e.fileNumber} size=${e.size} detail=${JSON.stringify(t)}`)}if(this.progressReporter.onDoneTakeSnapshot(),a<=It.ResourceCleanupStage.SCAN_MESSAGES){this.Logger.zsymb(0,"ehQd6Z","start #2 scan messages",n);let e=this.stateStorage.getProgressKeys();e.length||(e=await this.getAllConversations(),this.stateStorage.setProgressKeys(e)),this.progressReporter.onDoneGetConvList(e.length),this.Logger.zsymb(0,"iWbUZl","total conv:",e.length),await wt(this.scanFromMessages.bind(this,{abort:s,getConfig:()=>{const e=this.config||r;return{batchConv:e.batchConv,batchDelay:e.batchDelay,batchSize:e.batchSize,includeImageGen:!!e.collectGeneratedJPG}},getRange:this.getScanMessagesRangeForConv,convIds:e,userId:t}),((e,t)=>{this.Logger.zsymb(0,"gYLxbD","done #2 scan messages",n,e),Tt.b.logCleanupPerf(It.ResourceCleanupStage.SCAN_MESSAGES,e,t)}))()}if(this.progressReporter.onDoneScanMessages(),a<=It.ResourceCleanupStage.DELETE_RESOURCES&&r.enableDelete){this.Logger.zsymb(0,"ViZwz1","start #3 delete resources",n);const e=await wt(this.deleteResources.bind(this,!!r.deleteStatCache),((e,t)=>{this.Logger.zsymb(0,"g3ZJDi","done #3 delete resources",n,e),this.stateStorage.setTrackingData({duration:{[It.ResourceCleanupStage.DELETE_RESOURCES]:e}}),Tt.b.logCleanupPerf(It.ResourceCleanupStage.DELETE_RESOURCES,e,t)}))(),t=Object.fromEntries(Object.entries(e.trackingFolderData).map((([e,{size:t,file_number:s}])=>[$znode.path.basename(e),{size:t,count:s}])));this.stateStorage.setTrackingData({statsAfter:{size:e.size,count:e.fileNumber},statsDetailAfter:t,statsFailure:{size:e.failedSize,count:e.failedFileNumber}}),this.Logger.zsymb(0,"wu6HIc",`stats after files=${e.fileNumber} size=${e.size} detail=${JSON.stringify(t)}`)}else await this.calculateStatsAfterScanning();return this.progressReporter.onDoneDeleteResources(),this.stateStorage.getTrackingData()||{duration:{},interupted:{},startTs:0}}flush(){n.ModuleContainer.resolve(Ye.ResourceScannerManager).flush(),this.stateStorage.isInitialized()&&(this.stateStorage.setStage(It.ResourceCleanupStage.IDLE),this.stateStorage.clearAllProgress(),this.stateStorage.clearProgressLimit(),this.stateStorage.clearTrackingData()),this.progressReporter.removeAllSubscribers()}subscribeProgress(e){this.progressReporter.subscribeChange(e)}unsubscribeProgress(e){this.progressReporter.unscribeChange(e)}setConfig(e){this.Logger.zsymb(0,"KhAOHF","setConfig",e),this.config=e}})||_t)||_t)||_t)||_t);var Lt,At=s("Uzj0");Object(c.j)()(Lt=Object(n.injectable)()(Lt=class extends C.a{constructor(...e){super(...e),this.logger=void 0}getType(){return"REDUNDANT_RES_CLEANUP_START"}get Logger(){return this.logger||(this.logger=n.ModuleContainer.resolve(m.ZLoggerFactory).createZLogger(z.ZLoggerNametags.redundantResCleanup,["worker-task"])),this.logger}onExecuteSuccess(){const e=n.ModuleContainer.resolve(It.ResourceCleanupStateStorage).getTrackingData();if(e){const{statsBefore:t,statsAfter:s,statsDetailAfter:r,statsDetailBefore:i,duration:n}=e;t&&s&&r&&i&&(Tt.b.logCleanupSuccess(Math.max(t.size-s.size,0),At.b.sum(Object.values(n))),Tt.b.logCleanupSuccessDetail(s.size,r))}}onExecuteFail(){const e=n.ModuleContainer.resolve(It.ResourceCleanupStateStorage),t=e.getTrackingData(),s=e.getStage();Tt.b.logCleanupFail(s,t?At.b.sum(Object.values(t.duration)):0)}async execute(e){const{params:t,abort:s,report:r}=e,{config:i,userId:a,maxTimeScan:o,sessionId:c,forced:h}=t;let l=t.flush;const d=n.ModuleContainer.resolve(vt.ResourceCleanupManager),u=e=>{e%5==0&&this.Logger.zsymb(0,"dQv6Ji","run progress",e),r(e)};e.onParamsChange((({config:e,flush:t})=>{"boolean"==typeof t&&(l=t),"object"==typeof e&&n.ModuleContainer.resolve(vt.ResourceCleanupManager).setConfig(e)}));try{d.subscribeProgress(u);const e=await d.run({config:i,userId:a,maxTimeScan:o,abort:s,sessionId:c,forced:h});return this.onExecuteSuccess(),e}catch(g){throw this.onExecuteFail(),g}finally{l&&d.flush(),d.unsubscribeProgress(u)}}})||Lt);s("69Uf"),s("Q/Ir"),s("rBRb");var Ft,Ut=s("jbAT"),zt=s("zLd2"),Gt=s("5txd");Object(n.injectable)()(Ft=Object(n.singleton)(zt.c)(Ft=function(e,t){return Object(n.inject)(Ut.b)(e,void 0,0)}(Ft=function(e,t){return Object(n.inject)(m.ZLoggerFactory)(e,void 0,1)}(Ft=Reflect.metadata("design:type",Function)(Ft=Reflect.metadata("design:paramtypes",[void 0===Ut.a?Object:Ut.a,void 0===m.ZLoggerFactory?Object:m.ZLoggerFactory])(Ft=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,this._logger=t.createZLogger(zt.b,["manage-utils-media-in-ui"]),this._log=Object(Gt.b)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}})||Ft)||Ft)||Ft)||Ft)||Ft);s("37f1");var jt,Pt=s("X2RP"),xt=s("ggcH"),Qt=s("rvru"),qt=s("rkiK"),Bt=s("Mk04"),$t=s("DOOx"),Zt=s("Yggq"),Vt=s("HWGt");(new(Object(c.h)()(jt=class extends Vt.a{constructor(...e){super(...e),this.dbQos=null,this.signalOutOfMem=Object(Bt.a)((()=>{Y.p.triggerEvent(Y.o,[{type:$t.b.OUT_OF_MEM,src:$t.a.DB}])})),this.signalInvalidVersion=Object(Bt.a)((()=>{$zdb.notifyOpenDBFailed(!0,"VersionError")})),this.signalMissingStore=Object(Bt.a)((()=>{$zdb.notifyOpenDBFailed(!0,"zkey-miss-object-store")})),this.signalExceedingLimitInReopeningDBConnection=Object(Bt.a)((()=>{$zdb.notifyOpenDBFailed(!1)})),this.signalDBClosedAbnormally=Object(Bt.a)((()=>{n.ModuleContainer.resolve(xt.TDBCorruptionDetector).forceCheckDBCorruption()}))}getDBQos(){return null===this.dbQos&&(this.dbQos=n.ModuleContainer.resolve(Qt.a)),this.dbQos}handleQueryError(e){this.getDBQos().sendDBErrorQos(e)}handleOutOfMemError(e){this.signalOutOfMem()}handleInvalidVersionError(){this.signalInvalidVersion()}handleMissingStoreError(e){const{database:t,missingTables:s,adapterType:r}=e;this.signalMissingStore();this.getDBQos().sendMissingTableQos(t,s)}handleExceedingLimitInReopeningDBConnection(e){this.signalExceedingLimitInReopeningDBConnection()}handleQueryExec(e){const{database:t,table:s,method:r,transaction:i,startTime:n,getEndTime:a}=e;Zt.a.has(t)||a().then((e=>{const a={method:r,database:t,table:s,transaction:i};qt.default.recordInfo(qt.MetricName.query_resolution_time,{startAt:n,endAt:e,info:a})})).catch((e=>{}))}handleSuccessOpenDB(e){const{startTime:t,endTime:s,fullname:r}=e;this.getDBQos().sendSuccessOpenDBDurationQos(r,t,s-t),qt.default.recordInfo(qt.MetricName.db_ready,{startAt:t,endAt:s,info:{dbName:r}})}handleConnectionClosedAbnormally(){this.signalDBClosedAbnormally()}handleSchemaMigratedAbnormally(){}handleLongOpenDB(e){const{startTime:t,endTime:s,fullname:r}=e;this.getDBQos().sendLongOpenRequestQos(r,t,s-t)}handleTimeConsumingQuery(e,t){this.getDBQos().sendTimeConsumingQueryQos(e,t)}handleWarning(e){const t=this.getDBQos();if(e.type===Pt.b.FAILED_MULTI)t.sendFailedMultiErrorQos(e)}onDispose(){this.dispose()}})||jt)).start(),n.ModuleContainer.resolve(i.a).addEventListener(qe.a.SessionChange,(async({session:e})=>{const t=ie.default.getInstance();null!==e?t.init(e.userId,e.UIN):t.resetSession()}));s("uiYo")},O6t0:function(e,t,s){"use strict";(function(e){var t=s("c8uc"),r=s("AsUd");e&&e.env;const i=12;let n=0;function a(){return new Promise(((e,s)=>{let r=t.a.isLoadedLib();r&&r.ok?(c("load lib success!!"),$zdb.sendResponse({act:i}),$zdb.updateAvailableSqliteState(!0),o(!0,91002,0,0,3==n?0:3,Date.now()),e(r)):n>0?(n--,c("load lib fail go retry "+n+" "+(r?r.error:" _resp = null")),o(!1,91002,0,0,2,Date.now()),setTimeout((()=>{a()}),15e3)):(c("load lib fail "+(r?r.error:" _resp = null")),$zdb.updateAvailableSqliteState(!1),o(!1,91002,0,0,1,Date.now()),s(r))}))}function o(e,t,s=0,r,i,n){$zlogger.crossQosLog({success:e,commandId:t,subCommandId:s,duration:r,errorCode:i,startTime:n})}function c(e){$zlogger.sendLog("info","shared-worker: "+e)}!function(){try{const e={increaseSuccess:(e,t,s,r=[],i={})=>{$zlogger.crossQosLog({success:!0,commandId:e,subCommandId:t,duration:s,params:r,options:i})},increaseFailed:(e,t,s,r,i,n=[],a={})=>{$zlogger.crossQosLog({success:!1,commandId:e,subCommandId:t,duration:s,errorCode:r,startTime:i,params:n,options:a})}},{MetriczDriver:t}=s("rkiK");t.registerQosControl(e)}catch(e){}}(),$zsub.$zdb.processRequest(((e,s)=>{!function(e){e&&(e.constructor===Array?e.forEach((e=>{t.a.receiverEvent(e)})):t.a.receiverEvent(e))}(s)})),$zapp.onPing((()=>Date.now())),$zlogger.onReceiveViewerkey(((e,t)=>{r.j("viewer_key",t)})),document.addEventListener("load",(()=>{a()})),c("[pid][shared-worker]"+e.pid),$zapp.registerProcess("dbtask",e.pid)}).call(this,s("8oxB"))},QiE6:function(e,t,s){"use strict";var r=s("vyMb");s.d(t,"ResourceScannerManager",(function(){return r.a}));var i=s("cMnt");s.d(t,"RESOURCE_LINKED_MSG_TYPES",(function(){return i.a}));var n=s("jWYK");s.o(n,"ResourceScannerExecutor")&&s.d(t,"ResourceScannerExecutor",(function(){return n.ResourceScannerExecutor})),s.o(n,"ResourceScannerLog")&&s.d(t,"ResourceScannerLog",(function(){return n.ResourceScannerLog}));var a=s("ZChn");s.d(t,"ResourceScannerLog",(function(){return a.a}));var o=s("39pz");s.d(t,"ResourceScannerExecutor",(function(){return o.a}))},ZChn:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var r=s("jDHv"),i=s("h0S/"),n=s("Mgpg");class a{constructor(){}static getInstance(){return this.instance||(this.instance=r.ModuleContainer.resolve(n.ZLoggerFactory).createZLogger(i.ZLoggerNametags.resourceUsageScanner,["scan"])),this.instance}}a.instance=void 0},aEZA:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("jDHv");const i=Object(r.define)("resource-cleanup-manager")},c8uc:function(e,t,s){"use strict";(function(e){var r=s("VTBJ"),i=s("ES/k"),n=s("4prX"),a=s("AtyM"),o=s("Mgpg"),c=s("jDHv"),h=s("z0WU");e&&e.env;let l=$zsqlite;const d=s("wBhU"),u=c.ModuleContainer.resolve(o.ZLoggerFactory).createZLogger("dbtask",["manager"]),g={QUERY:1,ADD_DATA:2,PRE_DATA:3,INIT:4,GET_INDEX:5,ABORTED_SEARCH:6,MIGRATE:7,DEL_OLDDATA:8,DELETE_ALL:9,PRE_TAGGING:10,INIT_TAGGING:11,PROCESS_READY:12,QUERY_GLOBAL_MSG:13,CLOSE_DB:14,DELETE_DATA:15,PURE_QUERY:18,QUERY_GLOBAL_MSG_V3:19,COUNT_TOTAL:20,QUERY_GLOBAL_MSG_V4:21,QUERY_V2:22,DELETE_DATA_MULTI:23},m={[g.QUERY]:function(e,t,s,n){return new Promise(((a,o)=>{let c;R(e,n),c=t?()=>A(s,n):()=>!1;let h=i.a.formatTextSearch(e);if(h=h.trim(),!h){let e=n.filter;if(!e||!0!==e.searchForEmpty)return o("text is null")}let d=h.split(" ");if((n=n||{}).progress){let e,t=!0,i=0,h=n.configs&&n.configs.limit?n.configs.limit:P,g=n.configs&&void 0!==n.configs.offset?n.configs.offset:0,m=n.configs?Object(r.a)({},n.configs):{},p=[];const f=()=>{clearTimeout(e),e=null,a(p)},b=(a,g)=>{if(c&&c())return o("aborted");l.query(d,n.filter,Object(r.a)(Object(r.a)({},m),{},{limit:g,offset:a}),c).then((r=>{if(c&&c())return o("aborted");h-=g,r&&r.constructor==Array?(p.push.apply(p,r),r.length>=g&&h>0?(t?(t=!1,i=p.length,N(p,s)):e||(e=setTimeout((()=>{e=null,i<p.length&&(i=p.length,N(p,s))}),2e3)),b(a+r.length,Math.min(100,h))):f()):f()})).catch((e=>{R("_doQuery",e),u.zsymb(18,"Q51XxM","_query fail",s,e),f()}))};b(g,Math.min(100,h))}else n.configs&&n.configs.limit||(n.configs=n.configs?n.configs:{},n.configs.limit=P,n.configs.offset=n.configs.offset||0),a(l.query(d,n.filter,n.configs,c))}))},[g.ADD_DATA]:function(e){return Promise.reject("not impl")},[g.INIT]:function(e){return new Promise(((t,s)=>{if(R(e),l.isLoadedLib(),!e.userId||!e.UIN)return s("invalid init data "+e.userId+" "+e.UIN);if(G){if(G.userId!=e.userId||G.UIN!=e.UIN)return L("open new db last"+e.userId),G={userId:e.userId,UIN:e.UIN},L("new Session!!"),p.length>0&&(L("promote last task priority"),p.forEach((e=>{e.priority=T}))),p.unshift({act:g.CLOSE_DB,taskId:f.next(),isAbort:!1,additions:null,priority:T,isMicro:!0}),p.unshift({act:g.INIT,data:e,taskId:f.next(),isAbort:!1,additions:null,priority:T,isMicro:!0}),t();if(!j){L("open new db now!!!"+e.userId),j={userId:e.userId,UIN:e.UIN};const s=Date.now(),r=a.a.now();return t(l.openDb(e.userId,e.UIN).catch((t=>{throw d&&e.onSentry&&d.withScope((function(e){e.setTag("db-error","open"),e.setLevel("error"),d.captureException(t)})),n.default.increaseFailed(91002,0,a.a.now()-r,4,s),t.errno&&n.default.increaseFailed(91002,0,a.a.now()-r,1e4*t.errno+4,s),t})))}return L("reopen the same with last"+e.userId),t()}G={userId:e.userId,UIN:e.UIN},L("open db first time now!!!"+e.userId),j={userId:e.userId,UIN:e.UIN},t(l.openDb(e.userId,e.UIN,e.onSentry))}))},[g.PRE_DATA]:function(e,t=!1,s,n,a){return R(e),new Promise(((t,o)=>{if(!e||0==e.length)return t();if(e.length>y){let t=e.slice(y,e.length);F({act:g.PRE_DATA,data:t,taskId:f.next(),isAbort:!1,additions:n,priority:a}),e=e.slice(0,y)}let c=[];e.forEach((e=>{if(!e||e.constructor!==Object)return;let t=i.a.getTextFromMessage(e.content);t&&c.push(Object(r.a)(Object(r.a)({},e),{},{content:t}))}));const h=!1;Date.now();c.length?l.writev2(c).then((()=>{t()})).catch((e=>{u.zsymb(18,"dvAZi8","predata fail",s,e),o(e)})):t()}))},[g.GET_INDEX]:function(e){return Promise.reject("not impl")},[g.MIGRATE]:function(e){return Promise.reject("not impl")},[g.DEL_OLDDATA]:function(){return Promise.reject("not impl")},[g.DELETE_ALL]:function(){return Promise.reject("not impl")},[g.QUERY_GLOBAL_MSG]:function(e,t,s,r){return new Promise(((n,a)=>{let o;o=t?()=>A(s,r):()=>!1;let c=i.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");if(r||(r={}),r.progress){let e=0;const t=[10,20,50],i=(e,t)=>({data:e,page:t}),h=(c,d,u,g=30)=>{if(o())a("aborted");else if(u>=d.length)n(i(null,e));else{const m=Math.min(u+g,d.length);l.queryGlobalMessageV2(c,d.slice(u,m),r.configs,o).then((r=>{r?(N(i(r,e),s),e>=1?setTimeout((()=>{h(c,d,u+g,t[Math.min(++e,t.length-1)])}),100):h(c,d,u+g,t[Math.min(++e,t.length-1)])):n(i(null,e))})).catch((e=>{a(e)}))}};(()=>{l.getConversationMatch(c,o).then((s=>{if(s&&s.length>0){s.sort(((e,t)=>t.ts-e.ts));let e=[];s.forEach((t=>{e.push(t.convId)})),e.length>0&&h(c,e,0,t[0])}else n(i(null,e))})).catch((e=>{a(e)}))})()}else n(l.queryGlobalMessageV2(c,r.listConvs,r.configs,o))}))},[g.CLOSE_DB]:function(){return new Promise(((e,t)=>{j?(L("go close db "+j.userId),e(l.closeDb(j.userId,j.UIN))):t("close what?? curr: "+JSON.stringify(j)),j=null}))},[g.DELETE_DATA]:function(e){return l.deleteRow(e.msgId)},[g.DELETE_DATA_MULTI]:function(e,t,s,r,i){let n=Array.isArray(e)?e:[e];if(n.length>y){let e=n.slice(y,n.length);F({act:g.DELETE_DATA_MULTI,data:e,taskId:f.next(),isAbort:!1,callback:!1,priority:i}),n=n.slice(0,y)}const a=n.map((e=>e.msgId));return l.deleteRows(a)},[g.PURE_QUERY]:function(e){return new Promise(((t,s)=>{l.pureQuery(e).then((r=>{u.zsymb(0,"A-rg6o","pure query done",e,r),r?t(r):s(null)})).catch((t=>{u.zsymb(18,"1Jl6iK","pure query fail",e,t),s(t)}))}))},[g.QUERY_GLOBAL_MSG_V3]:function(e,t,s,r){return new Promise(((n,a)=>{let o;o=t?()=>A(s,r):()=>!1;let c=i.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");const h=(e,t)=>({data:e,page:t});C(`_queryGlobalMessageV3, kw: ${O(e)}`);let d=r.configs.filter;l.queryGlobalMessageV3(c,o,d,C).then((t=>{C(`_queryGlobalMessageV3 SUCCESS, kw: ${O(e)}, total res: ${t?t.length:"empty"}`),t?(N(h(t,0),s),n(h(t,0))):n(h(null,0))})).catch((e=>{C("_queryGlobalMessageV3 Error",JSON.stringify(e)),a(e)}))}))},[g.COUNT_TOTAL]:function(){return new Promise(((e,t)=>{l.countTotal().then((s=>{s?e(s):t(null)})).catch((e=>{u.zsymb(18,"YBBjwj","count total fail",e),t(e)}))}))},[g.QUERY_GLOBAL_MSG_V4]:function(e,t,s,r){return new Promise(((n,a)=>{let o;o=t?()=>A(s,r):()=>!1;let c=i.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");const h=(e,t)=>({data:e,page:t});C(`_queryGlobalMessageV3, kw: ${O(e)}`);let d=r.configs.filter;l.queryGlobalMessageV4(c,o,d,C).then((t=>{C(`_queryGlobalMessageV3 SUCCESS, kw: ${O(e)}, total res: ${t?t.length:"empty"}`),t?(N(h(t,0),s),n(h(t,0))):n(h(null,0))})).catch((e=>{C("_queryGlobalMessageV3 Error",JSON.stringify(e)),a(e)}))}))},[g.QUERY_V2]:function(e,t,s,n){return new Promise(((a,o)=>{let c;R(e,n),c=t?()=>A(s,n):()=>!1;let h=i.a.formatTextSearch(e);if(h=h.trim(),!h){let e=n.filter;if(!e||!0!==e.searchForEmpty)return o("text is null")}let d=h.split(" ");if((n=n||{}).progress){let e,t=!0,i=0,h=n.configs&&n.configs.limit?n.configs.limit:P,u=n.configs&&void 0!==n.configs.offset?n.configs.offset:0,g=n.configs?Object(r.a)({},n.configs):{},m=[];const p=()=>{clearTimeout(e),e=null,a(m)},f=(a,u)=>{if(c&&c())return o("aborted");l.queryV2(d,n.filter,Object(r.a)(Object(r.a)({},g),{},{limit:u,offset:a}),c).then((r=>{if(c&&c())return o("aborted");h-=u,r&&r.constructor==Array?(m.push.apply(m,r),r.length>=u&&h>0?(t?(t=!1,i=m.length,N(m,s)):e||(e=setTimeout((()=>{e=null,i<m.length&&(i=m.length,N(m,s))}),2e3)),f(a+r.length,Math.min(100,h))):p()):p()})).catch((e=>{R("_doQuery",e),p()}))};f(u,Math.min(100,h))}else n.configs&&n.configs.limit||(n.configs=n.configs?n.configs:{},n.configs.limit=P,n.configs.offset=n.configs.offset||0),a(l.queryV2(d,n.filter,n.configs,c))}))}};let p=[];const f=new class{constructor(){this.value=1}next(){return this.value++,this.value}};let b=new Map;const I=1,S=2;let M=2;const y=300;let v=null;const w="FLAG_SLEEP_TOO_LONG",E=6e4,_=6e4,T=100,D=!0;function C(...e){D&&u.zsymb(0,"-SIC39","[search]",...e)}function R(){}const O=e=>h.default.md5(e);var k=e=>{$zdb.sendResponse(e)};function N(e,t){k({progress:!0,taskId:t,data:e})}function L(e){k({logErr:!0,data:e})}function A(e,t){return t&&t.filter?e!=b.get("with-filter"):e!=b.get("_")}function F(e){let t=!1;[g.QUERY,g.QUERY_GLOBAL_MSG,g.QUERY_GLOBAL_MSG_V3,g.QUERY_GLOBAL_MSG_V4,g.QUERY_V2].indexOf(e.act)>=0&&(e.additions&&e.additions.filter?b.set("with-filter",e.taskId):b.set("_",e.taskId));for(let i=0;i<p.length;++i)if(s=p[i],r=e,s.priority>=r.priority){p.splice(i,0,e),t=!0;break}var s,r;t||p.push(e),function(){if(M==I)return;M=I,z()}()}function U(e,t,s){try{e.callback&&k({success:s,data:t,taskId:e.taskId}),s||L(" err "+e.act+" "+t)}catch(r){L(" _afterAction "+e.act+": "+r)}z()}function z(){if(0==p.length)return M=S,v&&clearTimeout(v),void(v=setTimeout((()=>{L(w),v=null}),E));v&&(clearTimeout(v),v=null);let e=p.pop();if(!e||"object"!=typeof e)return L("ev is not Object"),void z();let t=m&&e.act&&m.hasOwnProperty(e.act)?m[e.act]:null;if("function"==typeof t){let r=!1,i=setTimeout((()=>{i=null,r=!0,L("timeout event "+e.act),U(e,"timeout!!",!1)}),_);const n=()=>(i&&(clearTimeout(i),i=null),r);try{t(e.data,e.isAbort,e.taskId,e.additions,e.priority).then((t=>{n()||U(e,t,!0)})).catch((t=>{n()||U(e,t,!1)}))}catch(s){U(e,s,!1)}}else U(e,"not support this function "+e.act,!1)}let G,j;const P=1e4;t.a={receiverEvent:function(e){switch(u.zsymb(0,"YuFcRo","receiver ",e.act),e.act){case g.ABORTED_SEARCH:b=new Map,p=p.filter((e=>e.act!=g.QUERY&&e.act!=g.QUERY_V2));break;case g.DELETE_ALL:p=[],F(e);break;default:F(e)}},isLoadedLib:()=>l.isLoadedLib()}}).call(this,s("8oxB"))},cMnt:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("1pet");const i=[r.MSG_PHOTO,r.MSG_VOICE,r.MSG_VIDEO,r.MSG_FILE,r.MSG_CONTACT,r.MSG_ZINSTANT,r.MSG_ZINSTANT_OLD]},hGrR:function(e,t,s){"use strict";var r=s("v0D5");s.d(t,"ResourceCleanupStateStorage",(function(){return r.a}));var i=s("Tlqd");s.d(t,"RRCStorageKeys",(function(){return i.a})),s.d(t,"RRCStorageName",(function(){return i.b})),s.d(t,"ResourceCleanupStage",(function(){return i.c}));s("rwwj")},jWYK:function(e,t){},qMb5:function(e,t){},rwwj:function(e,t){},"ut+A":function(e,t,s){"use strict";var r=s("aEZA");s.d(t,"ResourceCleanupManager",(function(){return r.a}));s("qMb5")},v0D5:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("jDHv");const i=Object(r.define)("resource-cleanup-state-storage")},vyMb:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s("jDHv");const i=Object(r.define)("resource-scanner-manager")}});
//# sourceMappingURL=sourcemaps/shared-worker.910c5bc7f132e0c12726.js.map